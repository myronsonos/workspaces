
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>syssw.ampctl_driver &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for syssw.ampctl_driver</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">WorkflowTestFixture</span><span class="p">,</span> <span class="n">combinatorial</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.suite</span> <span class="k">import</span> <span class="n">WorkflowTestSuite</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">sonos.client.zone_player</span> <span class="k">import</span> <span class="n">HIGH_POWER_DEVICES</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="ne">TimeoutError</span>
<span class="kn">from</span> <span class="nn">sonos.log_inspector.blackbox</span> <span class="k">import</span> <span class="n">BlackboxLogInspector</span>
<span class="kn">from</span> <span class="nn">sonos.simple_upgrade</span> <span class="k">import</span> <span class="n">ConditionalUpgradeTestFixture</span>


<span class="n">state_properties</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;power&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;mute&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;hipower&quot;</span><span class="p">:</span> <span class="s2">&quot;off&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;fsm_idle&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;power&quot;</span><span class="p">:</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;mute&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;hipower&quot;</span><span class="p">:</span> <span class="s2">&quot;off&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;power&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;mute&quot;</span><span class="p">:</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;hipower&quot;</span><span class="p">:</span> <span class="s2">&quot;off&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;power&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;mute&quot;</span><span class="p">:</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;hipower&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;power&quot;</span><span class="p">:</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;mute&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;hipower&quot;</span><span class="p">:</span> <span class="s2">&quot;off&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;fsm_error&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;power&quot;</span><span class="p">:</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;mute&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;hipower&quot;</span><span class="p">:</span> <span class="s2">&quot;off&quot;</span><span class="p">}}</span>


<div class="viewcode-block" id="AmpctlDriver"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver">[docs]</a><span class="k">class</span> <span class="nc">AmpctlDriver</span><span class="p">(</span><span class="n">WorkflowTestFixture</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test fixture that tests the functionality of the ampctl driver by testing</span>
<span class="sd">    that the imx6 device successfully ends in the correct state after turning</span>
<span class="sd">    off/on the amp-power, mute, hipower, and calling fault/error/spur.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="AmpctlDriver.setUpFixture"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up the fixture by initiating the states each device will</span>
<span class="sd">        test and generates only imx6 devices. The device will begin at</span>
<span class="sd">        the power_stable state, test all the control points, and</span>
<span class="sd">        continue testing the rest of the states as the starting state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devices_in_test</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="o">.</span><span class="n">generate_unique_imx6_devices</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">can_override_amp_interface</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">devices_in_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span></div>

<div class="viewcode-block" id="AmpctlDriver.tearDownFixture"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the ampctl settings and sets them back to their default</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices_in_test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s1">&#39;clear-override&#39;</span><span class="p">,),</span>
                                      <span class="s1">&#39;Ampctl settings should be &#39;</span>
                                      <span class="s1">&#39;back to their default values&#39;</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">clear_dmesg</span><span class="p">()</span></div>

<div class="viewcode-block" id="AmpctlDriver.test_amp_off"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.test_amp_off">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s1">&#39;devices_in_test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_amp_off</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turns off the amp-power. Checks if the state it changed to is correct.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test_amp_off&quot;</span><span class="p">)</span>
        <span class="n">inspector</span> <span class="o">=</span> <span class="n">BlackboxLogInspector</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="n">state_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_run_high&quot;</span> <span class="ow">and</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HIGH_POWER_DEVICES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ZP is not a high-power device, so skip state fsm_run_high&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Change the state to the state in steady_states</span>
                <span class="n">curstate</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Changing states from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> in test_amp_off&quot;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>

                <span class="c1"># Turn off the amp</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s1">&#39;amp-power&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for state to be idle in test_amp_off&quot;</span><span class="p">)</span>
                        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;fsm_idle&quot;</span> <span class="o">==</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                        <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timeout while waiting for &#39;</span>
                                        <span class="s1">&#39;current state to leave &#39;</span>
                                        <span class="s1">&#39;fsm_powering_low in test_amp_off&#39;</span><span class="p">,</span>
                                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">:</span>
                    <span class="c1"># Check the state did change to idle</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">):</span>
                    <span class="c1"># It remains in the same state</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
                    <span class="c1"># Don&#39;t let it go to fault/error for the next loop</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>
        <span class="c1"># Clears bb_log</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">clear_blackbox_log</span><span class="p">()</span></div>

<div class="viewcode-block" id="AmpctlDriver.test_amp_on"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.test_amp_on">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s1">&#39;devices_in_test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_amp_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turns on the amp-power. Checks if the state it changed to is correct.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test_amp_on&quot;</span><span class="p">)</span>
        <span class="n">inspector</span> <span class="o">=</span> <span class="n">BlackboxLogInspector</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="n">state_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_run_high&quot;</span> <span class="ow">and</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HIGH_POWER_DEVICES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ZP is not a high-power device, so skip state fsm_run_high&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Change the state to the state in steady_states</span>
                <span class="n">curstate</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Changing states from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> in test_amp_off&quot;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>

                <span class="c1"># Turn on amp</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s1">&#39;amp-power&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">):</span>
                    <span class="c1"># power_stable-&gt; power_stable</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">:</span>
                    <span class="c1"># idle-&gt; power_stable</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">:</span>
                    <span class="c1"># run_lowm run_high, fault go back to themselves</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">:</span>
                    <span class="c1"># error -&gt; get the new state after amp=on, that should be tested</span>
                    <span class="k">if</span> <span class="n">curstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">curstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
        <span class="c1"># Clears bb_log</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">clear_blackbox_log</span><span class="p">()</span></div>

<div class="viewcode-block" id="AmpctlDriver.test_mute_off"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.test_mute_off">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s1">&#39;devices_in_test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_mute_off</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turns off the mute. Checks if the state it changed to is correct.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test_mute_off&quot;</span><span class="p">)</span>
        <span class="n">inspector</span> <span class="o">=</span> <span class="n">BlackboxLogInspector</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="n">state_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_run_high&quot;</span> <span class="ow">and</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HIGH_POWER_DEVICES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ZP is not a high-power device, so skip state fsm_run_high&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">curstate</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span>
                <span class="c1"># Change the state to the state in steady_states</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Changing states from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>

                <span class="c1"># Turn off mute</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s1">&#39;mute&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">):</span>
                    <span class="c1"># run_low-&gt; run_low</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">:</span>
                    <span class="c1"># run_high -&gt; run_high, stays</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">:</span>
                    <span class="c1"># fault -&gt; get the new state after mute=off, that</span>
                    <span class="c1"># should be tested</span>
                    <span class="k">if</span> <span class="n">curstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">,</span>
                                              <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">curstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_idle&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">,</span>
                                              <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">:</span>
                    <span class="c1"># error -&gt; run_high, stays in error</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
        <span class="c1"># Clears bb_log</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">clear_blackbox_log</span><span class="p">()</span></div>

<div class="viewcode-block" id="AmpctlDriver.test_mute_on"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.test_mute_on">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s1">&#39;devices_in_test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_mute_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turns on the mute. Checks if the state it changed to is correct.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test_mute_on&quot;</span><span class="p">)</span>
        <span class="n">inspector</span> <span class="o">=</span> <span class="n">BlackboxLogInspector</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="n">state_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_run_high&quot;</span> <span class="ow">and</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HIGH_POWER_DEVICES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ZP is not a high-power device, so skip state fsm_run_high&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Change the state to the state in steady_states</span>
                <span class="n">curstate</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Changing states from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>

                <span class="c1"># Turn mute on</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s1">&#39;mute&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">:</span>
                    <span class="c1"># power_stable, idle, run_low-&gt; run_low</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_run_low&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">):</span>
                    <span class="c1"># power_stable, idle, run_low-&gt; run_low</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for state to be power_stable&quot;</span><span class="p">)</span>
                        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;fsm_power_stable&quot;</span> <span class="o">==</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                        <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timeout while waiting for &#39;</span>
                                        <span class="s1">&#39;current state to leave &#39;</span>
                                        <span class="s1">&#39;fsm_powering_low state in test_mute_on&#39;</span><span class="p">,</span>
                                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
        <span class="c1"># Clears bb_log</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">clear_blackbox_log</span><span class="p">()</span></div>

<div class="viewcode-block" id="AmpctlDriver.test_hipower_off"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.test_hipower_off">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s1">&#39;devices_in_test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_hipower_off</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turns off the hipower. Checks if the state it changed to is correct.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test_hipower_off&quot;</span><span class="p">)</span>
        <span class="n">inspector</span> <span class="o">=</span> <span class="n">BlackboxLogInspector</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HIGH_POWER_DEVICES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;ZP is not a high power device. Do not perform test_hipower_off.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="n">state_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Change the state to the state in steady_states</span>
                <span class="n">curstate</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Changing states from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>

                <span class="c1"># Turn Hipower off</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s1">&#39;hipower&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">),</span>
                                          <span class="s1">&#39;Setting hipower to off&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_run_low&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">):</span>
                    <span class="c1"># run_low, run_high -&gt; run_low</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">:</span>
                    <span class="c1"># run_low, run_high -&gt; run_low</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
            <span class="c1"># Clears bb_log</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">clear_blackbox_log</span><span class="p">()</span></div>

<div class="viewcode-block" id="AmpctlDriver.test_hipower_on"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.test_hipower_on">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s1">&#39;devices_in_test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_hipower_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turns on the hipower. Checks if the state it changed to is correct.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test_hipower_on&quot;</span><span class="p">)</span>
        <span class="n">inspector</span> <span class="o">=</span> <span class="n">BlackboxLogInspector</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HIGH_POWER_DEVICES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;ZP is not a high power device. Do not perform test_hipower_on.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="n">state_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Change the state to the state in steady_states</span>
                <span class="n">curstate</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Changing states from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>
                <span class="c1"># Turn Hipower on</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s1">&#39;hipower&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
            <span class="c1"># Clears bb_log</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">clear_blackbox_log</span><span class="p">()</span></div>

<div class="viewcode-block" id="AmpctlDriver.test_amp_fault"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.test_amp_fault">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s1">&#39;devices_in_test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_amp_fault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Causes a fault. Checks if the state it changed to is correct.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test_amp_fault&quot;</span><span class="p">)</span>
        <span class="n">inspector</span> <span class="o">=</span> <span class="n">BlackboxLogInspector</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="n">state_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_run_high&quot;</span> <span class="ow">and</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HIGH_POWER_DEVICES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ZP is not a high-power device, so skip state fsm_run_high&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Change the state to the state in steady_states</span>
                <span class="n">curstate</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Changing states from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>
                <span class="c1"># Call echo</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;echo fault &gt; /proc/driver/ampctl&quot;</span><span class="p">)</span>
                <span class="c1"># Check first that after fault the state changed to fault</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">)</span>
                <span class="c1"># Turn mute off to get out of fault state, so that it can be</span>
                <span class="c1"># changed to the next state</span>
                <span class="k">if</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s2">&quot;mute&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">)</span>
                    <span class="c1"># Check state that device has to be in depending on the</span>
                    <span class="c1"># state before the fault happened</span>
                    <span class="k">if</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">):</span>
                        <span class="c1"># Powerstable -&gt; run_low</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_idle&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">):</span>
                        <span class="c1"># Only for Beacon/Bootleg/Chaplin</span>
                        <span class="c1"># idle -&gt; fault -&gt; run_low</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">is_royale</span><span class="p">()</span> <span class="ow">or</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_bootleg</span><span class="p">()</span> <span class="ow">or</span>
                                <span class="n">zp</span><span class="o">.</span><span class="n">is_chaplin</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Run_high -&gt; run_high, idle -&gt; idle</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
        <span class="c1"># Clears bb_log</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">clear_blackbox_log</span><span class="p">()</span></div>

<div class="viewcode-block" id="AmpctlDriver.test_error"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.test_error">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s1">&#39;devices_in_test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Causes an error. Checks if the state it changed to is correct.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test_error&quot;</span><span class="p">)</span>
        <span class="n">inspector</span> <span class="o">=</span> <span class="n">BlackboxLogInspector</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="n">state_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_run_high&quot;</span> <span class="ow">and</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HIGH_POWER_DEVICES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ZP is not a high-power device, so skip state fsm_run_high&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Change the state to the state in steady_states</span>
                <span class="n">curstate</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Changing states from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>

                <span class="c1"># Make current marker the end of the bb_log before calling fault</span>
                <span class="n">inspector</span><span class="o">.</span><span class="n">mark_last_log_entry</span><span class="p">()</span>

                <span class="c1"># Call error</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;echo error &gt; /proc/driver/ampctl&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">)</span>
                <span class="c1"># Check that the state went to error after echoing error</span>
                <span class="k">if</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If not error or fault then you have to check if the</span>
                    <span class="c1"># state it returns to after getting out of the error</span>
                    <span class="c1"># state is correct depending on the state the device</span>
                    <span class="c1"># had before going into error state</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting amp-power to turn on &quot;</span>
                                         <span class="s2">&quot;while trying to get out of error &quot;</span>
                                         <span class="s2">&quot;state&quot;</span><span class="p">)</span>
                        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span> <span class="o">==</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s2">&quot;amp-power&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">),</span>
                                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                        <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timeout while waiting for &#39;</span>
                                        <span class="s1">&#39;the amp-power to turn on to get &#39;</span>
                                        <span class="s1">&#39;out of error&#39;</span><span class="p">,</span>
                                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="c1"># error -&gt; get the new state after amp=on, that should be tested</span>
                    <span class="k">if</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
        <span class="c1"># Clears bb_log</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">clear_blackbox_log</span><span class="p">()</span></div>

<div class="viewcode-block" id="AmpctlDriver.test_spur"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.test_spur">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s1">&#39;devices_in_test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_spur</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Causes a spurious amp fault. Checks if the state it changed to is correct.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test_spur&quot;</span><span class="p">)</span>
        <span class="n">inspector</span> <span class="o">=</span> <span class="n">BlackboxLogInspector</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="n">state_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">newstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_run_high&quot;</span> <span class="ow">and</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HIGH_POWER_DEVICES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ZP is not a high-power device, so skip state fsm_run_high&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Change the state to the state in steady_states</span>
                <span class="n">curstate</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Changing states from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>
                <span class="c1"># Make current marker the end of the bb_log before calling fault</span>
                <span class="n">inspector</span><span class="o">.</span><span class="n">mark_last_log_entry</span><span class="p">()</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;echo spur &gt; /proc/driver/ampctl&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_spur</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">newstate</span><span class="p">,</span> <span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">)</span>
        <span class="c1"># Clears bb_log</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">clear_blackbox_log</span><span class="p">()</span></div>

<div class="viewcode-block" id="AmpctlDriver.check"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">expected_curstate</span><span class="p">,</span> <span class="n">check_blackbox</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inspector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the current state has all the expected_curstate properties:</span>
<span class="sd">            -  state, amp-power, mute</span>
<span class="sd">            if encore of solbase check if:</span>
<span class="sd">            -  hipower</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal .SonosZoneComponent</span>

<span class="sd">        :param expected_curstate: The expected current state of the device</span>
<span class="sd">        :type expected_curstate :obj `str`</span>

<span class="sd">        :param check_blackbox: Flag is True when it is necessary to check the bb_log</span>
<span class="sd">                            It is on only when changing states to fault/error</span>
<span class="sd">        :type check_blackbox: :obj &#39;int&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">power</span> <span class="o">=</span> <span class="n">state_properties</span><span class="p">[</span><span class="n">expected_curstate</span><span class="p">][</span><span class="s2">&quot;power&quot;</span><span class="p">]</span>
        <span class="n">mute</span> <span class="o">=</span> <span class="n">state_properties</span><span class="p">[</span><span class="n">expected_curstate</span><span class="p">][</span><span class="s2">&quot;mute&quot;</span><span class="p">]</span>
        <span class="n">hipower</span> <span class="o">=</span> <span class="n">state_properties</span><span class="p">[</span><span class="n">expected_curstate</span><span class="p">][</span><span class="s2">&quot;hipower&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">expected_curstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_properties_entries</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">expected_curstate</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">mute</span><span class="p">,</span> <span class="n">hipower</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">expected_curstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_properties_entries</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">expected_curstate</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">mute</span><span class="p">,</span> <span class="n">hipower</span><span class="p">)</span>
            <span class="c1"># Only if necessary (sometimes nothing is printed out,</span>
            <span class="c1"># so don&#39;t check it), check the bb_log</span>
            <span class="k">if</span> <span class="n">check_blackbox</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_bb_log</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">expected_curstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;The device is in an invalid state in check: </span><span class="si">{}</span><span class="s2">&quot;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expected_curstate</span><span class="p">))</span></div>

<div class="viewcode-block" id="AmpctlDriver.check_properties_entries"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.check_properties_entries">[docs]</a>    <span class="k">def</span> <span class="nf">check_properties_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">mute</span><span class="p">,</span> <span class="n">hipower</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the current state has the correct properties.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>

<span class="sd">        :param curstate: The state the device is in</span>
<span class="sd">        :type curstate: :obj &#39;str&#39;</span>

<span class="sd">        :param changestate: The state the device will be set to</span>
<span class="sd">        :type changestate: :obj &#39;str&#39;</span>

<span class="sd">        :param power: Setting for amp-power (on, off)</span>
<span class="sd">        :type power: :obj &#39;str&#39;</span>

<span class="sd">        :param mute: Setting for mute (on, off)</span>
<span class="sd">        :type mute: :obj &#39;str&#39;</span>

<span class="sd">        :param hipower: Setting for hipower (on, off)</span>
<span class="sd">        :type hipower: :obj &#39;str&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check current_state</span>
        <span class="k">if</span> <span class="n">curstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_idle&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">):</span>
            <span class="c1"># amp needs to be off</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">power</span> <span class="o">==</span> <span class="n">power</span><span class="p">,</span>
                                <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timed out before amp could turn off while &#39;</span>
                                <span class="s1">&#39;being in </span><span class="si">{}</span><span class="s1"> state&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curstate</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                                       <span class="s2">&quot;Amp-power should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">power</span><span class="p">))</span>
        <span class="c1"># check mute</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">mute</span> <span class="o">==</span> <span class="n">mute</span><span class="p">,</span>
                            <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timed out before mute turned </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mute</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1"># check hipower if zp is a hi power device</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">in</span> <span class="n">HIGH_POWER_DEVICES</span><span class="p">:</span>
            <span class="c1"># When hipower =off and it&#39;s runlow it goes though powering low</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">high_power</span> <span class="o">==</span> <span class="n">hipower</span><span class="p">,</span>
                                <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timed out before hipower turned </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hipower</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">curstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">:</span>
            <span class="c1"># amp needs to be off</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">curstate</span> <span class="o">==</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                                <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timed out before state could get out of &#39;</span>
                                <span class="s1">&#39;powering low and change to run_low&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">curstate</span><span class="p">,</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                                       <span class="s2">&quot;State should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curstate</span><span class="p">))</span></div>

<div class="viewcode-block" id="AmpctlDriver.check_spur"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.check_spur">[docs]</a>    <span class="k">def</span> <span class="nf">check_spur</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the lines of blackbox are correct after spur fault is caused</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>

<span class="sd">        :param curstate: The current state of the device</span>
<span class="sd">        :type curstate :obj `str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;{--} &lt;AMPCTL, INFO&gt; Proc file simulating spurious amp fault.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">inspector</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
                                  <span class="s1">&#39;Should print out </span><span class="si">{}</span><span class="s1"> for message&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="c1"># recheck that everything is still the same</span>
        <span class="n">power</span> <span class="o">=</span> <span class="n">state_properties</span><span class="p">[</span><span class="n">curstate</span><span class="p">][</span><span class="s2">&quot;power&quot;</span><span class="p">]</span>
        <span class="n">mute</span> <span class="o">=</span> <span class="n">state_properties</span><span class="p">[</span><span class="n">curstate</span><span class="p">][</span><span class="s2">&quot;mute&quot;</span><span class="p">]</span>
        <span class="n">hipower</span> <span class="o">=</span> <span class="n">state_properties</span><span class="p">[</span><span class="n">curstate</span><span class="p">][</span><span class="s2">&quot;hipower&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">curstate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fsm_power_stable&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_low&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_run_high&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_idle&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_properties_entries</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">mute</span><span class="p">,</span> <span class="n">hipower</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;The device is in an invalid state in check_spur: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curstate</span><span class="p">))</span></div>

<div class="viewcode-block" id="AmpctlDriver.change_state"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.change_state">[docs]</a>    <span class="k">def</span> <span class="nf">change_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">changestate</span><span class="p">,</span> <span class="n">inspector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the state to the changestate by changing the power, mute,</span>
<span class="sd">        and hipower.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>

<span class="sd">        :param curstate: The state the device is in</span>
<span class="sd">        :type curstate: :obj &#39;str&#39;</span>

<span class="sd">        :param changestate: The state the device will be set to</span>
<span class="sd">        :type changestate: :obj &#39;str&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">power</span> <span class="o">=</span> <span class="n">state_properties</span><span class="p">[</span><span class="n">changestate</span><span class="p">][</span><span class="s2">&quot;power&quot;</span><span class="p">]</span>
        <span class="n">mute</span> <span class="o">=</span> <span class="n">state_properties</span><span class="p">[</span><span class="n">changestate</span><span class="p">][</span><span class="s2">&quot;mute&quot;</span><span class="p">]</span>
        <span class="n">hipower</span> <span class="o">=</span> <span class="n">state_properties</span><span class="p">[</span><span class="n">changestate</span><span class="p">][</span><span class="s2">&quot;hipower&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">curstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting mute to turn off while trying to &quot;</span>
                                 <span class="s2">&quot;get out of fault state&quot;</span><span class="p">)</span>
                <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span> <span class="o">==</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s2">&quot;mute&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">),</span>
                                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timeout while waiting for the mute &#39;</span>
                                <span class="s1">&#39;to turn off to get out of fault&#39;</span><span class="p">,</span>
                                <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">curstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting amp-power to turn on while &quot;</span>
                                 <span class="s2">&quot;trying to get out of error state&quot;</span><span class="p">)</span>
                <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span> <span class="o">==</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s2">&quot;amp-power&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">),</span>
                                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timeout while waiting for the &#39;</span>
                                <span class="s1">&#39;amp-power to turn on to get out of fault&#39;</span><span class="p">,</span>
                                <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">changestate</span> <span class="o">==</span> <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">:</span>
            <span class="c1"># Make current marker the end of the bb_log before calling fault</span>
            <span class="n">inspector</span><span class="o">.</span><span class="n">mark_last_log_entry</span><span class="p">()</span>
            <span class="c1"># To change to fault you have to echo fault</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;echo fault &gt; /proc/driver/ampctl&quot;</span><span class="p">)</span>
            <span class="c1"># Check first that after fault the state changed to fault,</span>
            <span class="c1"># check bb_log</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">changestate</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">changestate</span> <span class="o">==</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">:</span>
            <span class="c1"># Make current marker the end of the bb_log before calling fault</span>
            <span class="n">inspector</span><span class="o">.</span><span class="n">mark_last_log_entry</span><span class="p">()</span>
            <span class="c1"># To change to error you have to echo error</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;echo error &gt; /proc/driver/ampctl&quot;</span><span class="p">)</span>
            <span class="c1"># Check first that after error the state changed to error</span>
            <span class="c1"># check_bb_log</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">changestate</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inspector</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check the amp-power is correct</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for amp-power to be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">power</span><span class="p">))</span>
                <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span> <span class="o">==</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s2">&quot;amp-power&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">),</span>
                                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timeout while waiting for &#39;</span>
                                <span class="s1">&#39;amp-power to change to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">power</span><span class="p">),</span>
                                <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="c1"># Check the mute is correct</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for mute to be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mute</span><span class="p">))</span>
                <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span> <span class="o">==</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s2">&quot;mute&quot;</span><span class="p">,</span> <span class="n">mute</span><span class="p">),</span>
                                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timeout while waiting for &#39;</span>
                                <span class="s1">&#39;mute to change to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mute</span><span class="p">),</span>
                                <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="c1"># Only check the hipower if the device is a hipower</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">in</span> <span class="n">HIGH_POWER_DEVICES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ampctl</span><span class="p">(</span><span class="s2">&quot;hipower&quot;</span><span class="p">,</span> <span class="n">hipower</span><span class="p">),</span>
                                          <span class="s2">&quot;Hipower should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hipower</span><span class="p">))</span>

            <span class="c1"># Check the state is correct until now, all settings should be set</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for state to be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">changestate</span><span class="p">))</span>
                <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">changestate</span> <span class="o">==</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ampctl</span><span class="p">()</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timeout while waiting for current &#39;</span>
                                <span class="s1">&#39;state to change to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">changestate</span><span class="p">),</span>
                                <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="AmpctlDriver.check_bb_log"><a class="viewcode-back" href="../../syssw.html#syssw.ampctl_driver.AmpctlDriver.check_bb_log">[docs]</a>    <span class="k">def</span> <span class="nf">check_bb_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">curstate</span><span class="p">,</span> <span class="n">inspector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls the function that checks if the lines of the blackbox log are</span>
<span class="sd">        correct depending on whether it&#39;s a fault or error.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>

<span class="sd">        :param curstate: The current state of the device</span>
<span class="sd">        :type curstate :obj `str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bb_log_messages</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fault_0_message&quot;</span><span class="p">:</span> <span class="s2">&quot;{--} &lt;AMPCTL, INFO&gt; Proc &quot;</span>
                           <span class="s2">&quot;file simulating amp fault.&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;fault_1_sol_message&quot;</span><span class="p">:</span> <span class="s2">&quot;{--} &lt;AMPCTL, ERR&gt; Fault &quot;</span>
                           <span class="s2">&quot;detected on fault line: Amp #1 Fault.&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;fault_1_message&quot;</span><span class="p">:</span> <span class="s2">&quot;{--} &lt;AMPCTL, ERR&gt; Fault &quot;</span>
                           <span class="s2">&quot;detected on fault line: Amp fault.&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;fault_2_message&quot;</span><span class="p">:</span> <span class="s2">&quot;{--} &lt;AMPCTL, ERR&gt; Fault &quot;</span>
                           <span class="s2">&quot;detected. Muting.&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;fault_3_message&quot;</span><span class="p">:</span> <span class="s2">&quot;{-S} &lt;AMPCTL, ERR&gt; Muted. &quot;</span>
                           <span class="s2">&quot;Cycle mute to reset fault state.&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;error_0_message&quot;</span><span class="p">:</span> <span class="s2">&quot;{--} &lt;AMPCTL, INFO&gt; Proc &quot;</span>
                           <span class="s2">&quot;file simulating HW error.&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;error_1_message&quot;</span><span class="p">:</span> <span class="sa">ur</span><span class="s1">&#39;.*An error has occurred controlling the amp hardware. Recovery attempt.*&#39;</span><span class="p">,</span>
                           <span class="s2">&quot;error_2_message&quot;</span><span class="p">:</span> <span class="sa">ur</span><span class="s1">&#39;.*Currently waiting in the error state.*&#39;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">curstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_amp_fault&quot;</span><span class="p">:</span>
            <span class="c1"># Should have a marker and then go on from there</span>
            <span class="c1"># Line 0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span>
                                      <span class="n">inspector</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;fault_0_message&quot;</span><span class="p">]),</span>
                                      <span class="s1">&#39;Should print out </span><span class="si">{}</span><span class="s1"> for message&#39;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;fault_0_message&quot;</span><span class="p">]))</span>
            <span class="c1"># Line 1</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_solbase</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">inspector</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;fault_1_sol_message&quot;</span><span class="p">]),</span>
                                          <span class="s1">&#39;Should print out </span><span class="si">{}</span><span class="s1"> for message&#39;</span>
                                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;fault_1_sol_message&quot;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">inspector</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;fault_1_message&quot;</span><span class="p">]),</span>
                                          <span class="s1">&#39;Should print out </span><span class="si">{}</span><span class="s1"> for message&#39;</span>
                                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;fault_1_message&quot;</span><span class="p">]))</span>
            <span class="c1"># Line 2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">inspector</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;fault_2_message&quot;</span><span class="p">]),</span>
                                      <span class="s1">&#39;Should print out </span><span class="si">{}</span><span class="s1"> for message&#39;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;fault_2_message&quot;</span><span class="p">]))</span>
            <span class="c1"># Line 3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">inspector</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;fault_3_message&quot;</span><span class="p">]),</span>
                                      <span class="s1">&#39;Should print out </span><span class="si">{}</span><span class="s1"> for message&#39;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;fault_3_message&quot;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">curstate</span> <span class="o">==</span> <span class="s2">&quot;fsm_error&quot;</span><span class="p">:</span>
            <span class="c1"># Line 0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">inspector</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;error_0_message&quot;</span><span class="p">]),</span>
                                      <span class="s1">&#39;Should print out </span><span class="si">{}</span><span class="s1"> for message&#39;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;error_0_message&quot;</span><span class="p">]))</span>
            <span class="c1"># Line 1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">inspector</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;error_1_message&quot;</span><span class="p">]),</span>
                                      <span class="s1">&#39;Should print out </span><span class="si">{}</span><span class="s1"> for message&#39;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;error_1_message&quot;</span><span class="p">]))</span>
            <span class="c1"># Line 2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">inspector</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;error_2_message&quot;</span><span class="p">]),</span>
                                      <span class="s1">&#39;Should print out </span><span class="si">{}</span><span class="s1"> for message&#39;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bb_log_messages</span><span class="p">[</span><span class="s2">&quot;error_2_message&quot;</span><span class="p">]))</span></div></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">WorkflowTestSuite</span><span class="p">(</span><span class="s1">&#39;AmpctlDriver&#39;</span><span class="p">)</span>
    <span class="n">suite</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">ConditionalUpgradeTestFixture</span><span class="p">(),</span> <span class="n">AmpctlDriver</span><span class="p">()])</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>