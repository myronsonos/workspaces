
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>syssw.audioctl_event_queue &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for syssw.audioctl_event_queue</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">WorkflowTestFixture</span><span class="p">,</span> <span class="n">combinatorial</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.suite</span> <span class="k">import</span> <span class="n">WorkflowTestSuite</span>
<span class="kn">from</span> <span class="nn">sonos.client.cli.tools.event_test_utility</span> <span class="k">import</span> <span class="p">(</span><span class="n">EventTestUtility</span><span class="p">,</span>
                                                       <span class="n">Event</span><span class="p">,</span> <span class="n">ETOption</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sonos.client.zone_player</span> <span class="k">import</span> <span class="n">CAP_TOUCH_DEVICES</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span> <span class="k">as</span> <span class="n">sl</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">randint</span>
<span class="kn">from</span> <span class="nn">thread_processing</span> <span class="k">import</span> <span class="n">run_concurrent_processes</span>

<span class="kn">from</span> <span class="nn">event_sequence</span> <span class="k">import</span> <span class="n">VALID_ACTIONS</span><span class="p">,</span> <span class="n">EventSequence</span><span class="p">,</span> <span class="n">Evt</span>
<span class="kn">from</span> <span class="nn">sonos.simple_upgrade</span> <span class="k">import</span> <span class="n">ConditionalUpgradeTestFixture</span>


<div class="viewcode-block" id="sleep"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.sleep">[docs]</a><span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;sleeping for </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>
    <span class="n">sl</span><span class="p">(</span><span class="n">time</span><span class="p">)</span></div>

<span class="n">ORIENTATION_CHANGE_WAIT_TIME</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">OVERFLOW_EVENTS</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">RECOVERY_EVENTS</span> <span class="o">=</span> <span class="mi">10</span>


<div class="viewcode-block" id="AudioctlEventQueue"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.AudioctlEventQueue">[docs]</a><span class="k">class</span> <span class="nc">AudioctlEventQueue</span><span class="p">(</span><span class="n">WorkflowTestFixture</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This test verifies that the event queue is functioning as expected</span>
<span class="sd">    and also doesn&#39;t break when abused in various ways.</span>

<span class="sd">    Additionally, this test pokes at every proc file that generates events</span>
<span class="sd">    as appropriate per platform and verifies that the output of those procs</span>
<span class="sd">    is as expected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># maxDiff controls the largest diff printed in a unittest (and</span>
    <span class="c1"># therefore WorkflowTestFixture) assert or verify.  See</span>
    <span class="c1"># https://docs.python.org/2/library/unittest.html for details.</span>
    <span class="c1"># The diffs of state lists are useless at the default setting</span>
    <span class="n">maxDiff</span> <span class="o">=</span> <span class="mi">2500</span>  <span class="c1"># Allow larger diff displays (default is 640)</span>

    <span class="n">abuses</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;match_anacapa&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
              <span class="s2">&quot;write_tests&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">NoArg</span><span class="o">.</span><span class="n">write_tests</span><span class="p">,</span> <span class="kc">None</span><span class="p">)],</span>
              <span class="s2">&quot;read_block&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">NoArg</span><span class="o">.</span><span class="n">read_block</span><span class="p">,</span> <span class="kc">None</span><span class="p">)],</span>
              <span class="s2">&quot;trash&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">Arg</span><span class="o">.</span><span class="n">trash</span><span class="p">,</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">))],</span>
              <span class="s2">&quot;extreme_trash&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">Arg</span><span class="o">.</span><span class="n">trash</span><span class="p">,</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)),</span>
                                <span class="p">(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">NoArg</span><span class="o">.</span><span class="n">extreme_trash</span><span class="p">,</span> <span class="kc">None</span><span class="p">)],</span>
              <span class="s2">&quot;sequencing&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">Arg</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span> <span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">))],</span>
              <span class="s2">&quot;seq_and_trash&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">Arg</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span> <span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
                                <span class="p">(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">Arg</span><span class="o">.</span><span class="n">trash</span><span class="p">,</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)),</span>
                                <span class="p">(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">NoArg</span><span class="o">.</span><span class="n">extreme_trash</span><span class="p">,</span> <span class="kc">None</span><span class="p">)],</span>
              <span class="s2">&quot;seq_and_read_block&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">Arg</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
                                     <span class="p">(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">NoArg</span><span class="o">.</span><span class="n">read_block</span><span class="p">,</span> <span class="kc">None</span><span class="p">)],</span>
              <span class="s2">&quot;all_abuses&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">Arg</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
                             <span class="p">(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">NoArg</span><span class="o">.</span><span class="n">intelligent_delay</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                             <span class="p">(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">NoArg</span><span class="o">.</span><span class="n">read_block</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                             <span class="p">(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">Arg</span><span class="o">.</span><span class="n">trash</span><span class="p">,</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)),</span>
                             <span class="p">(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">NoArg</span><span class="o">.</span><span class="n">extreme_trash</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                             <span class="p">(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">NoArg</span><span class="o">.</span><span class="n">write_tests</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
              <span class="p">}</span>

<div class="viewcode-block" id="AudioctlEventQueue.setUpFixture"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.AudioctlEventQueue.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Install the event-test.c binary on every device and keep track of</span>
<span class="sd">        the EventTestUtility handler objects associated with each zoneplayer</span>

<span class="sd">        Also, generate a list of only the players that this should be run on</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devices_in_test</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_numbers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utility_dictionary</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># create a list of unique players in the testbed</span>
        <span class="c1"># and skip the controllers and bridges</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="o">.</span><span class="n">generate_testbed_unique_devices</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_controller</span><span class="p">()</span> <span class="ow">or</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_bridge</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="c1"># install the utility</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">devices_in_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">utility_dictionary</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span> <span class="o">=</span> <span class="n">EventTestUtility</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
            <span class="c1"># amp power must start off on all devices</span>
            <span class="c1"># for events to be generated as expected</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">amp_power_off</span><span class="p">()</span>
            <span class="c1"># devices must start horizontally</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_encore</span><span class="p">()</span> <span class="ow">or</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_play3</span><span class="p">():</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_device_orientation</span><span class="p">(</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="n">ORIENTATION_CHANGE_WAIT_TIME</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_limelight</span><span class="p">():</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_device_orientation</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="n">ORIENTATION_CHANGE_WAIT_TIME</span><span class="p">)</span>
            <span class="c1"># kill anacapad</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">stop_anacapa</span><span class="p">()</span></div>

<div class="viewcode-block" id="AudioctlEventQueue.tearDownFixture"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.AudioctlEventQueue.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the utility from all devices and restart anacapa</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices_in_test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">utility_dictionary</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">()</span></div>

<div class="viewcode-block" id="AudioctlEventQueue.test_events_successively"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.AudioctlEventQueue.test_events_successively">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s2">&quot;generate_devices_in_test&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_events_successively</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        No abuses to the event queue. Simply touch every proc that</span>
<span class="sd">        generates and event for the architecture and make sure that the</span>
<span class="sd">        output generated from the event queue matches the input, even when</span>
<span class="sd">        used in succession with other procs.</span>

<span class="sd">        :param zp: The zoneplayer to run the test on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create a utility instance and a random sequence of events</span>
        <span class="n">utility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility_dictionary</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span>
        <span class="n">test_seq</span> <span class="o">=</span> <span class="n">EventSequence</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_random_event_sequence</span><span class="p">(</span><span class="n">zp</span><span class="p">):</span>
            <span class="n">test_seq</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>

        <span class="n">utility</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>  <span class="c1"># run the event-test binary</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># give the utility time to start up</span>
        <span class="n">test_seq</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>  <span class="c1"># execute the sequence of proc actions on the device</span>
        <span class="n">utility</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>  <span class="c1"># stop the utility and get the log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_log_against_sequence</span><span class="p">(</span><span class="n">utility</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">test_seq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;End of test on </span><span class="si">{}</span><span class="s2"> with sequence </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">test_seq</span><span class="p">))</span></div>

<div class="viewcode-block" id="AudioctlEventQueue.test_individual_events"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.AudioctlEventQueue.test_individual_events">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s2">&quot;generate_events_for_each_device&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_individual_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        similar to test_event_procs, except instead of sequencing the events,</span>
<span class="sd">        this tests each event individually and verifies at every step. Useful</span>
<span class="sd">        for testing to see if a single action is fundamentally broken.</span>

<span class="sd">        :param zp: The zoneplayer to associate with this sequence</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param action: The action we&#39;re executing on the zoneplayer</span>
<span class="sd">        :type action: :obj:`EventSequence.actions`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">utility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility_dictionary</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span>
        <span class="n">test_seq</span> <span class="o">=</span> <span class="n">EventSequence</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Testing event </span><span class="si">{}</span><span class="s2"> on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">zp</span><span class="p">))</span>
        <span class="n">test_seq</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="n">utility</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># give the utility time to start up</span>
        <span class="n">test_seq</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">utility</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_log_against_sequence</span><span class="p">(</span><span class="n">utility</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">test_seq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done! </span><span class="si">{}</span><span class="s2"> was run on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">zp</span><span class="p">))</span></div>

<div class="viewcode-block" id="AudioctlEventQueue.test_queue_overflow"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.AudioctlEventQueue.test_queue_overflow">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s2">&quot;generate_devices_in_test&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_queue_overflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure that after overflowing a queue, it still behaves okay</span>
<span class="sd">        and will still pass events after the overflow occurence</span>

<span class="sd">        Overflow queue by passing button_playpause/join</span>
<span class="sd">        press events as fast as possible until dmesg reports an</span>
<span class="sd">        overflow, then pass in button_playpause/join hold events.</span>
<span class="sd">        If button_playpause/join hold events are found after dmesg</span>
<span class="sd">        reports overflow, the queue successfully recovered.</span>

<span class="sd">        Criteria for passing: Overrun found in dmesg and button_playpause/join</span>
<span class="sd">                              repeated found in queue</span>
<span class="sd">        Worth noting, but not necessary to pass: Overrun found in queue</span>

<span class="sd">        Note: the actual events are irrelevant. Because button presses are</span>
<span class="sd">        the only thing that perform consistently amongst platforms, they are</span>
<span class="sd">        used.</span>

<span class="sd">        :param zp: The zoneplayer to associate with this sequence</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">utility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility_dictionary</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span>

        <span class="c1"># this configuration makes the utility delay to overflow the queue</span>
        <span class="n">overflow_config</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">Arg</span><span class="o">.</span><span class="n">delay</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="p">(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">Arg</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                           <span class="p">(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">NoArg</span><span class="o">.</span><span class="n">intelligent_delay</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                           <span class="p">(</span><span class="n">ETOption</span><span class="o">.</span><span class="n">NoArg</span><span class="o">.</span><span class="n">non_blocking</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>

        <span class="c1"># to overflow the queue</span>
        <span class="n">overflow_seq</span> <span class="o">=</span> <span class="n">EventSequence</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">run_as_fast_as_possible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># to check that the queue is still working</span>
        <span class="n">recovered_seq</span> <span class="o">=</span> <span class="n">EventSequence</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>

        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">clear_dmesg</span><span class="p">()</span>  <span class="c1"># we&#39;ll be using this to check for an overflow</span>

        <span class="c1"># flood event queue with join button presses</span>
        <span class="c1"># (play/pause and vol up for devices without join button)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">OVERFLOW_EVENTS</span><span class="p">):</span>
            <span class="n">overflow_seq</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">EventSequence</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">press_button_join</span><span class="p">)</span>

        <span class="c1"># add button holds to make sure the queue still works afterwards</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">RECOVERY_EVENTS</span><span class="p">):</span>
            <span class="n">recovered_seq</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">EventSequence</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">hold_button_join</span><span class="p">)</span>

        <span class="c1"># overflow the queue</span>
        <span class="n">utility</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">overflow_config</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># allow the utility to get to the 5 second delay</span>
        <span class="n">overflow_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">found_overrun_in_dmesg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="n">overflow_attempts</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">found_overrun_in_dmesg</span><span class="p">:</span>
            <span class="n">overflow_seq</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="n">overflow_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># check through dmesg for an overflow message</span>
            <span class="n">dmesg</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">find_all_in_dmesg</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="s2">&quot;event dropped, button queue full&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmesg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">found_overrun_in_dmesg</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Overrun found in dmesg. &quot;</span>
                    <span class="s2">&quot;Running recover button sequence.&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="n">recovered_seq</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>  <span class="c1"># see that the queue can recover</span>

        <span class="c1"># you need to give the utility time to read through all the events</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># we threw at it, since it has a hardcoded delay</span>
        <span class="n">utility</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="c1"># the first criteria for a pass is that dmesg reported an overrun</span>
        <span class="c1"># This, however, does not apply to SH4 devices</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_sh4</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">found_overrun_in_dmesg</span><span class="p">,</span>
                                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> dmesg must report an overrun&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>

        <span class="c1"># verify the presence of a EVTINFO_QUEUE_OVERRUN and a</span>
        <span class="n">found_overrun_in_queue</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># presence of queue overrun event</span>
        <span class="c1"># presence of button_playpause or button_join pressed,</span>
        <span class="c1"># released after overrun event</span>
        <span class="n">queue_recovered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">log</span>

        <span class="c1"># go through the log and look for button_playpause or button_join</span>
        <span class="c1"># to indicate queue recovered</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">log</span><span class="p">:</span>
            <span class="c1"># see if the overrun event got to the queue (not necessary to pass)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Event</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">found_overrun_in_queue</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">Evt</span><span class="o">.</span><span class="n">Source</span><span class="o">.</span><span class="n">NO_SOURCE</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">info</span> <span class="o">==</span> <span class="n">Evt</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">QUEUE_OVERRUN</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">found_overrun_in_queue</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found overrun: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
            <span class="c1"># see if the queue recovered (necessary to pass)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Event</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">queue_recovered</span><span class="p">:</span>
                <span class="c1"># devices with play/pause button</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">Evt</span><span class="o">.</span><span class="n">Source</span><span class="o">.</span><span class="n">BUTTON_PLAYPAUSE</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">info</span> <span class="o">==</span> <span class="n">Evt</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">REPEATED</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">queue_recovered</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># devices with join button</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">Evt</span><span class="o">.</span><span class="n">Source</span><span class="o">.</span><span class="n">BUTTON_JOIN</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">info</span> <span class="o">==</span> <span class="n">Evt</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">REPEATED</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">queue_recovered</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># if we&#39;ve seen that we recovered and found the overrun, theres</span>
            <span class="c1"># no reason to waste more time checking the rest of the entries</span>
            <span class="k">if</span> <span class="n">queue_recovered</span> <span class="ow">and</span> <span class="n">found_overrun_in_queue</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Done going through the log: verify that the queue recovered</span>
        <span class="n">status_message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Queue Recovered: </span><span class="si">{}</span><span class="s2">, &quot;</span>
                          <span class="s2">&quot;Overrun in Queue (optional): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="n">queue_recovered</span><span class="p">,</span> <span class="n">found_overrun_in_queue</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">queue_recovered</span><span class="p">,</span> <span class="n">status_message</span><span class="p">)</span></div>

<div class="viewcode-block" id="AudioctlEventQueue.test_queue_abuse_combinations"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.AudioctlEventQueue.test_queue_abuse_combinations">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s2">&quot;generate_testbed_unique_devices_and_abuse_keys&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_queue_abuse_combinations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">abuse_scenario_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure that even while using a queue in a ridiculous manner,</span>
<span class="sd">        events still make it in and out in order and unaffected.</span>

<span class="sd">        Note: the actual events are irrelevant. Because button events are</span>
<span class="sd">        the only thing that perform consistently amongst platforms, they are</span>
<span class="sd">        used.</span>

<span class="sd">        :param zp: The zoneplayer to associate with this sequence</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param str abuse_scenario_key: One of the dictionary keys from</span>
<span class="sd">                AudioctlEventQueue.abuses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">utility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility_dictionary</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">EventSequence</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">run_as_fast_as_possible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">command_line_param_list</span> <span class="o">=</span> <span class="n">AudioctlEventQueue</span><span class="o">.</span><span class="n">abuses</span><span class="p">[</span><span class="n">abuse_scenario_key</span><span class="p">]</span>

        <span class="c1"># on everything but sub, press all the buttons as fast as possible</span>
        <span class="c1"># unfortunately on sub, there&#39;s only 1 button, so for diversity</span>
        <span class="c1"># of events, we&#39;ll use press_button_playpause and</span>
        <span class="c1"># hold_button_playpause, but that will, by necessity,</span>
        <span class="c1"># make us not be able to run that test as fast</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_cap_touch</span><span class="p">():</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">EventSequence</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">touch_capzone_a</span><span class="p">,</span>
                      <span class="n">EventSequence</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">touch_capzone_b</span><span class="p">,</span>
                      <span class="n">EventSequence</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">touch_capzone_c</span><span class="p">,</span>
                      <span class="n">EventSequence</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">press_button_join</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_sub</span><span class="p">():</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">EventSequence</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">press_button_join</span><span class="p">,</span>
                      <span class="n">EventSequence</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">hold_button_join</span><span class="p">]</span>
            <span class="c1"># we need delays for button holds</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">run_as_fast_as_possible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">EventSequence</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">press_button_vol_dn</span><span class="p">,</span>
                      <span class="n">EventSequence</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">press_button_vol_up</span><span class="p">,</span>
                      <span class="n">EventSequence</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">press_button_playpause</span><span class="p">]</span>

        <span class="c1"># 20-30 actions (generates at least 40 events in the queue)</span>
        <span class="c1"># is plenty to make sure things still work</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">events</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
        <span class="n">utility</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command_line_param_list</span><span class="p">)</span>
        <span class="n">sequence</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># give the utility time to wrap up reads</span>
        <span class="n">utility</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="c1"># we&#39;re done running stuff on the device. verify that the log</span>
        <span class="c1"># matches the expected log from the event sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_log_against_sequence</span><span class="p">(</span><span class="n">utility</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Done with abuse &#39;</span><span class="si">{}</span><span class="s2">&#39; on zp </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">abuse_scenario_key</span><span class="p">,</span> <span class="n">zp</span><span class="p">))</span></div>

<div class="viewcode-block" id="AudioctlEventQueue.generate_devices_in_test"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.AudioctlEventQueue.generate_devices_in_test">[docs]</a>    <span class="k">def</span> <span class="nf">generate_devices_in_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator which yields the zoneplayers as set up in setUpFixture.</span>
<span class="sd">        They will be unique playback devices, all with event-test.c installed</span>

<span class="sd">        :return: a zone player that was setup in setUpFixture</span>
<span class="sd">        :rtype: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices_in_test</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">zp</span></div>

<div class="viewcode-block" id="AudioctlEventQueue.generate_testbed_unique_devices_and_abuse_keys"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.AudioctlEventQueue.generate_testbed_unique_devices_and_abuse_keys">[docs]</a>    <span class="k">def</span> <span class="nf">generate_testbed_unique_devices_and_abuse_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator which yields a combo of every unique device mixed</span>
<span class="sd">        with every combination of &#39;abuses&#39; to the event queue</span>

<span class="sd">        :return: a zone player</span>
<span class="sd">        :rtype: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :return: an event queue abuse scenario key to AudioctlEventQueue.abuses</span>
<span class="sd">        :rtype: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices_in_test</span><span class="p">:</span>
            <span class="c1"># great, we found a unique model,</span>
            <span class="c1"># now yield the unique abuse combo + model</span>
            <span class="k">for</span> <span class="n">abuse_name</span> <span class="ow">in</span> <span class="n">AudioctlEventQueue</span><span class="o">.</span><span class="n">abuses</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">zp</span><span class="p">,</span> <span class="n">abuse_name</span></div>

<div class="viewcode-block" id="AudioctlEventQueue.generate_events_for_each_device"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.AudioctlEventQueue.generate_events_for_each_device">[docs]</a>    <span class="k">def</span> <span class="nf">generate_events_for_each_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator which yields one of each appropriate event</span>
<span class="sd">        for each of the devices_in_test (list created in setUpFixture)</span>

<span class="sd">        :return: a playback device in the testbed</span>
<span class="sd">        :rtype: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :return: a single action that is valid for the returned zp</span>
<span class="sd">        :rtype: :class:`EventSequence.actions`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices_in_test</span><span class="p">:</span>
            <span class="c1"># yield each valid event for the model</span>
            <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_random_event_sequence</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">repetition</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">zp</span><span class="p">,</span> <span class="n">evt</span></div>

<div class="viewcode-block" id="AudioctlEventQueue.create_random_event_sequence"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.AudioctlEventQueue.create_random_event_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">create_random_event_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">repetition</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a sequence that contains default 1 of each</span>
<span class="sd">        valid proc action for the zone player and shuffle that list</span>

<span class="sd">        :param zp: the zoneplayer to get a random event sequence for</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param repetition: the repetition of each EventSequence.actions</span>
<span class="sd">        :type repetition: int</span>

<span class="sd">        :return: a list of EventSequence.actions valid for the type of zp</span>
<span class="sd">                 passed in and repeated exactly `repetition` times (though</span>
<span class="sd">                 not necessarily repeated in a row. The list is shuffled).</span>

<span class="sd">        :rtype: :obj:`list` of :class:`EventSequence.action`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get the valid events we can test from the dictionary</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">VALID_ACTIONS</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">]</span>
        <span class="c1"># repeat all actions &#39;repetition&#39; times</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">actions</span> <span class="o">*</span> <span class="n">repetition</span>
        <span class="c1"># shuffle the actions to make a random sequence</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">actions</span></div>

<div class="viewcode-block" id="AudioctlEventQueue.verify_log_against_sequence"><a class="viewcode-back" href="../../syssw.html#syssw.audioctl_event_queue.AudioctlEventQueue.verify_log_against_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">verify_log_against_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pass in utility.log and EventSequence object</span>
<span class="sd">        this will compare the expected (EventSequence) vs the actual (Log)</span>

<span class="sd">        This will fail the test if the verification doesn&#39;t pass</span>

<span class="sd">        :param log: the log grabbed from the utility after running</span>
<span class="sd">                    (for example, EventTestUtility.log)</span>
<span class="sd">        :type log: :obj:`list` of :obj:`Occurence`</span>

<span class="sd">        :param actions: the actions that were run on the device for comparison</span>
<span class="sd">        :type actions: :obj:`EventSequence`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">expected_sources</span> <span class="o">=</span> <span class="n">actions</span><span class="o">.</span><span class="n">expected_sources</span>
        <span class="n">expected_infos</span> <span class="o">=</span> <span class="n">actions</span><span class="o">.</span><span class="n">expected_infos</span>

        <span class="n">actual_sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">actual_infos</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># build up the sequence of info and sequence of sources</span>
        <span class="k">for</span> <span class="n">occ</span> <span class="ow">in</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">occ</span><span class="p">,</span> <span class="n">Event</span><span class="p">):</span>
                <span class="n">actual_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">occ</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                <span class="n">actual_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">occ</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expected_infos</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_sources</span><span class="p">))</span>

        <span class="c1"># remove duplicated EVTINFO_REPEATED elements</span>
        <span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># iterate through, removing duplicate EVTINFO_REPEATED elements</span>
        <span class="c1"># until you reach the last item.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Modifying list to remove duplicates </span><span class="se">\n</span><span class="s2"> BEFORE: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">actual_infos</span><span class="p">))</span>

        <span class="c1"># iterate through to the next to last item</span>
        <span class="k">while</span> <span class="n">current_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_sources</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">current_info</span> <span class="o">=</span> <span class="n">actual_infos</span><span class="p">[</span><span class="n">current_index</span><span class="p">]</span>
            <span class="n">next_info</span> <span class="o">=</span> <span class="n">actual_infos</span><span class="p">[</span><span class="n">current_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">current_info</span> <span class="o">==</span> <span class="n">Evt</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">REPEATED</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> \
                    <span class="n">next_info</span> <span class="o">==</span> <span class="n">Evt</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">REPEATED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">del</span><span class="p">(</span><span class="n">actual_sources</span><span class="p">[</span><span class="n">current_index</span><span class="p">])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">actual_infos</span><span class="p">[</span><span class="n">current_index</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Modified list with no duplicates </span><span class="se">\n</span><span class="s2"> AFTER: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">actual_infos</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Expected Infos: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expected_infos</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Actual Infos: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">actual_infos</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Expected Sources: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expected_sources</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Actual Sources: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">actual_sources</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span>
            <span class="n">expected_sources</span><span class="p">,</span> <span class="n">actual_sources</span><span class="p">,</span>
            <span class="s2">&quot;Expected Sources: </span><span class="si">{}</span><span class="se">\n</span><span class="s2"> Actual Sources: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">expected_sources</span><span class="p">,</span> <span class="n">actual_sources</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span>
            <span class="n">expected_infos</span><span class="p">,</span> <span class="n">actual_infos</span><span class="p">,</span>
            <span class="s2">&quot;Expected Infos: </span><span class="si">{}</span><span class="se">\n</span><span class="s2"> Actual Infos: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">expected_infos</span><span class="p">,</span> <span class="n">actual_infos</span><span class="p">))</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">WorkflowTestSuite</span><span class="p">(</span><span class="n">AudioctlEventQueue</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">suite</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">ConditionalUpgradeTestFixture</span><span class="p">(),</span> <span class="n">AudioctlEventQueue</span><span class="p">()])</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>