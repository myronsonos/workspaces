
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pytest_automation.player.conftest &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pytest_automation.player.conftest</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Player root conftest.py file</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">upnp.api.queue.helpers</span> <span class="k">import</span> <span class="n">QueueServiceHelpers</span><span class="p">,</span> <span class="n">md_helper</span>
<span class="kn">from</span> <span class="nn">upnp.functional.reporting.usage_metrics</span> <span class="k">import</span> <span class="n">UsageMetrics</span>
<span class="kn">from</span> <span class="nn">sonos.client.zone_player</span> <span class="k">import</span> <span class="n">TRUEPLAY_INCAPABLE_MODELS</span><span class="p">,</span> \
    <span class="n">SELF_TRUEPLAY_CAPABLE_MODELS</span><span class="p">,</span> <span class="n">TRUEPLAY_CAPABLE_MODELS</span>
<span class="kn">import</span> <span class="nn">pytest_automation.player.cloud_services.helpers.mock_lechmere_helpers</span> <span class="k">as</span> <span class="nn">lechmere_helpers</span>
<span class="kn">import</span> <span class="nn">track_source.http_track_source</span>
<span class="kn">from</span> <span class="nn">audio_playback.mplayer_playback</span> <span class="k">import</span> <span class="n">MplayerAc3Playback</span>
<span class="kn">from</span> <span class="nn">sonos.client.alarms</span> <span class="k">import</span> <span class="n">AlarmManager</span>
<span class="kn">from</span> <span class="nn">sonos.client.internal</span> <span class="k">import</span> <span class="n">SonosZoneComponent</span>
<span class="kn">from</span> <span class="nn">sonos.client.sonos_datetime</span> <span class="k">import</span> <span class="n">DateTimeManager</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">UPnPError</span>
<span class="kn">from</span> <span class="nn">sonos.log_inspector.anacapa_trace</span> <span class="k">import</span> <span class="n">AnacapaTraceLogInspector</span>
<span class="kn">from</span> <span class="nn">sonos.log_inspector.bluetooth_manager</span> <span class="k">import</span> <span class="n">BluetoothManagerLogInspector</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">sonos.websrv</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">WebServer</span><span class="p">,</span>
    <span class="n">get_random_web_port_to_use</span><span class="p">,</span>
    <span class="n">DEFAULT_TRACK_SOURCE_LOCATION</span><span class="p">,</span>
    <span class="n">DynamicPOSTHandler</span><span class="p">,</span> <span class="n">LocalShareServer</span><span class="p">,</span>
    <span class="n">MockPlayerDiagnosticsServer</span><span class="p">,</span>
    <span class="n">MockPlayerEventReportServer</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">upnp.api.queue.helpers</span> <span class="k">import</span> <span class="n">QueueServiceHelpers</span><span class="p">,</span> <span class="n">md_helper</span>
<span class="kn">from</span> <span class="nn">upnp.functional.reporting.usage_metrics</span> <span class="k">import</span> <span class="n">UsageMetrics</span>
<span class="kn">from</span> <span class="nn">webserver.base_muse_fixture</span> <span class="k">import</span> <span class="p">(</span><span class="n">BaseMuseFixture</span><span class="p">,</span> <span class="n">MuseClientFixtureMixin</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">audio_playback.mplayer_playback</span> <span class="k">import</span> <span class="n">MplayerAc3Playback</span>
<span class="kn">from</span> <span class="nn">sonos.client.zp_logger</span> <span class="k">import</span> <span class="n">ZpLogger</span>
<span class="kn">from</span> <span class="nn">webserver.helpers.mock_player_cloud_services_control</span> <span class="k">import</span> <span class="n">MockPlayerCloudServicesControl</span>
<span class="kn">from</span> <span class="nn">sonos.log_inspector.bluetooth_manager</span> <span class="k">import</span> <span class="n">BluetoothManagerLogInspector</span>
<span class="kn">from</span> <span class="nn">webserver.helpers.muse_api_helpers</span> <span class="k">import</span> <span class="n">PlayerSettingsHelper</span>
<span class="kn">from</span> <span class="nn">sftp.sonosSFTP</span> <span class="k">import</span> <span class="n">SonosAutomationSFTP</span>
<span class="kn">from</span> <span class="nn">webserver.helpers.node_smapi_control</span> <span class="k">import</span> <span class="n">NodeSmapiControl</span>
<span class="kn">from</span> <span class="nn">sonos.client.zp_logger</span> <span class="k">import</span> <span class="n">Logs</span>


<span class="n">queue_helpers</span> <span class="o">=</span> <span class="n">QueueServiceHelpers</span><span class="p">()</span>
<span class="n">DEFAULT_HT_AUTOSTOP_THRESHOLD_SECS</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">CPU_TRACKS_SHARE_KEY</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>
<span class="n">TEST_FILES_DATA_DIR</span> <span class="o">=</span> <span class="s1">&#39;/srv/samba/Automation/SPDIF/functional/playback&#39;</span>
<span class="n">SPDIF_TESTSIG_FILES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">TEST_FILES_DATA_DIR</span><span class="p">,</span>
        <span class="s1">&#39;6ch_L_857_R_997_C_1567_Lfe_197_Ls_2017_Rs_2111_44kHz.ac3&#39;</span>
    <span class="p">),</span> <span class="p">{</span>
         <span class="s1">&#39;StreamInfo&#39;</span><span class="p">:</span> <span class="s1">&#39;Dolby Digital 5.1&#39;</span><span class="p">,</span>
         <span class="s1">&#39;NumChannels&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
         <span class="s1">&#39;SampleRate&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="mi">44100</span><span class="p">),</span>
         <span class="s1">&#39;Duration&#39;</span><span class="p">:</span> <span class="mi">10</span>
     <span class="p">})</span>
<span class="p">]</span>
<span class="n">DEFAULT_NUMBER_OF_GROUP_MEMBERS</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">DEFAULT_PLAYBACK_DURATION_PER_SOURCE_SECONDS</span> <span class="o">=</span> <span class="mi">30</span>


<div class="viewcode-block" id="LocalContentUsingWebServer"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.LocalContentUsingWebServer">[docs]</a><span class="k">class</span> <span class="nc">LocalContentUsingWebServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches NAS CPU files for local playback, spins a WEB server</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NAS_CPU_TRACKS_PATH</span> <span class="o">=</span> <span class="s1">&#39;/Automation/cpu/MaggieFarm/&#39;</span>
    <span class="n">CPU_TRACKS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;MaggieFarm.flac&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MaggieFarm.ogg&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MaggieFarm.wav&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MaggieFarm.aiff&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MaggieFarm.mp3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MaggieFarm.wma&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MaggieFarm_AAC.mp4&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MaggieFarm_HEAAC.mp4&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MaggieFarm_ALAC.m4a&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetches NAS CPU files for local playback, spins a WEB server</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_audio_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span> <span class="o">=</span> <span class="n">WebServer</span><span class="p">(</span><span class="n">start_reactor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">get_random_web_port_to_use</span><span class="p">(),</span>
                          <span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

<div class="viewcode-block" id="LocalContentUsingWebServer.fetch_audio_files"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.LocalContentUsingWebServer.fetch_audio_files">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_audio_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">remote_path</span><span class="o">=</span><span class="n">NAS_CPU_TRACKS_PATH</span><span class="p">,</span>
                          <span class="n">files</span><span class="o">=</span><span class="n">CPU_TRACKS</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves test files from NAS</span>
<span class="sd">        :param str remote_path: NAS directory</span>
<span class="sd">        :param list files: Files for retrieve</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">SonosAutomationSFTP</span><span class="p">()</span> <span class="k">as</span> <span class="n">sftp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">test_file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">sftp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_path</span> <span class="o">+</span> <span class="n">test_file</span><span class="p">,</span> <span class="n">test_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">audio_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="LocalContentUsingWebServer.get_track_uris"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.LocalContentUsingWebServer.get_track_uris">[docs]</a>    <span class="k">def</span> <span class="nf">get_track_uris</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of URIs for the local tracks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;http://</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">host</span><span class="p">(),</span> <span class="n">audio_file</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">audio_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_files</span><span class="p">]</span></div>

<div class="viewcode-block" id="LocalContentUsingWebServer.cleanup"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.LocalContentUsingWebServer.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop WEB server, remove local tracks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">audio_file</span><span class="p">)</span> <span class="k">for</span> <span class="n">audio_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_files</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="source_local_content_from_webserver"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.source_local_content_from_webserver">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">source_local_content_from_webserver</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up a local WEB server which serves tracks on all supported</span>
<span class="sd">    framers. Yields a :class:`LocalContentUsingWebServer`</span>
<span class="sd">    :return: An object handling local WEB server</span>
<span class="sd">    :rtype: :class:`LocalContentUsingWebServer`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">webserver</span> <span class="o">=</span> <span class="n">LocalContentUsingWebServer</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">webserver</span>
    <span class="n">webserver</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>


<div class="viewcode-block" id="ungroup_players"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ungroup_players">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">ungroup_players</span><span class="p">(</span><span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If player is in a group ungroup it</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">yield</span>
    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s1">&#39;AVTransport&#39;</span><span class="p">):</span>
            <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing </span><span class="si">{}</span><span class="s2"> from any group&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">))</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">leave_group</span><span class="p">()</span></div>


<div class="viewcode-block" id="pytest_addoption"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.pytest_addoption">[docs]</a><span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pytest hook to add custom command line options.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--ht_autostop_threshold&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_HT_AUTOSTOP_THRESHOLD_SECS</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Duration (in seconds) to use when overriding the default HT &quot;</span>
             <span class="s2">&quot;autostop threshold&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s1">&#39;--number_group_members_to_test&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_NUMBER_OF_GROUP_MEMBERS</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of group members to test with&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--iterations&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;iterations&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of test iterations&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--playback_duration_per_source_seconds&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_PLAYBACK_DURATION_PER_SOURCE_SECONDS</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Duration (in seconds) to play back each source for the test&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--apply_trueplay&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;apply_trueplay&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;add to apply trueplay during test&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="playback_duration"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.playback_duration">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">playback_duration</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return playback duration specified from command line or default.</span>

<span class="sd">    :return: float number of seconds to playback a toslink file</span>
<span class="sd">    :rtype: :obj:`float`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">yield</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">playback_duration_per_source_seconds</span></div>


<div class="viewcode-block" id="apply_ht_autostop"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.apply_ht_autostop">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">apply_ht_autostop</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="n">ht_master_capable_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Override the HT autostop threshold for all</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.ht_master_capable_device`</span>
<span class="sd">    in this testbed. After all tests that depend on this fixture have run, the</span>
<span class="sd">    override will be reverted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ht_master_capable_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ht_autostop_threshold</span><span class="p">(</span>
        <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;ht_autostop_threshold&quot;</span><span class="p">))</span>
    <span class="n">ht_master_capable_device</span><span class="o">.</span><span class="n">wait_for_upnp_alive</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">ht_master_capable_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_ht_autostop_threshold</span><span class="p">()</span>
    <span class="n">ht_master_capable_device</span><span class="o">.</span><span class="n">wait_for_upnp_alive</span><span class="p">()</span></div>


<div class="viewcode-block" id="datetime_manager"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.datetime_manager">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">datetime_manager</span><span class="p">(</span><span class="n">hhid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an instance of the</span>
<span class="sd">    :class:`~sonos.client.sonos_datetime.DateTimeManager`</span>
<span class="sd">    using the :func:`~pytest_automation.conftest.hhid`.</span>

<span class="sd">    :return: a DateTimeManager instance</span>
<span class="sd">    :rtype: :class:`~sonos.client.sonos_datetime.DateTimeManager`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">DateTimeManager</span><span class="p">(</span><span class="n">hhid</span><span class="p">)</span></div>


<div class="viewcode-block" id="alarm_master"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.alarm_master">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">alarm_master</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the testbed device designated as the &#39;alarm master&#39;</span>
<span class="sd">    (device with the lowest serial number).</span>

<span class="sd">    :return: a SonosZoneComponent alarm master</span>
<span class="sd">    :rtype: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pytest</span><span class="o">.</span><span class="n">subnet</span><span class="o">.</span><span class="n">get_alarm_master</span><span class="p">()</span></div>


<div class="viewcode-block" id="alarm_manager"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.alarm_manager">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">alarm_manager</span><span class="p">(</span><span class="n">hhid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an instance of :class:`~sonos.client.alarms.AlarmManager`</span>
<span class="sd">    using the :func:`~pytest_automation.conftest.hhid`.</span>

<span class="sd">    :return: an AlarmManager instance</span>
<span class="sd">    :rtype: :class:`~sonos.client.alarms.AlarmManager`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">AlarmManager</span><span class="p">(</span><span class="n">hhid</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_all_alarms"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.remove_all_alarms">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">remove_all_alarms</span><span class="p">(</span><span class="n">alarm_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes all alarms from this testbed with the</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.alarm_manager`</span>
<span class="sd">    after the test has finished.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">yield</span>
    <span class="n">alarm_manager</span><span class="o">.</span><span class="n">delete_all_alarms</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">alarm_manager</span><span class="o">.</span><span class="n">num_alarms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Expect all alarms to be deleted&quot;</span></div>


<div class="viewcode-block" id="default_alarm"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.default_alarm">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">default_alarm</span><span class="p">(</span><span class="n">alarm_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an alarm with default values (as defined in</span>
<span class="sd">    hh/flashobj/ac_wrapper.cxx::SwfObjAlarm) with the</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.alarm_manager`.</span>

<span class="sd">    :return: the default alarm</span>
<span class="sd">    :rtype: :class:`~sonos.client.alarms.Alarms`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alarm</span> <span class="o">=</span> <span class="n">alarm_manager</span><span class="o">.</span><span class="n">create_default_alarm</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">alarm</span>
    <span class="n">alarm_manager</span><span class="o">.</span><span class="n">delete_all_alarms</span><span class="p">()</span></div>


<div class="viewcode-block" id="diag_receiver"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.diag_receiver">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">diag_receiver</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves event text to &#39;raw_event_data.txt&#39; in local directory.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Before this fixture is used, appropriate overrides should be set</span>
<span class="sd">        first on player.</span>

<span class="sd">    :return: a MockPlayerDiagnosticsServer</span>
<span class="sd">    :rtype: :class:`~sonos.websrv.MockPlayerDiagnosticsServer`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting up local diag receiver&quot;</span><span class="p">)</span>
    <span class="n">diag_receiver_obj</span> <span class="o">=</span> <span class="n">MockPlayerDiagnosticsServer</span><span class="p">()</span>
    <span class="n">diag_receiver_obj</span><span class="o">.</span><span class="n">start_diag_report_server</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">diag_receiver_obj</span>
    <span class="n">diag_receiver_obj</span><span class="o">.</span><span class="n">stop_player_report_server</span><span class="p">()</span></div>


<div class="viewcode-block" id="event_report_receiver"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.event_report_receiver">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">event_report_receiver</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves event text to &#39;raw_event_data.txt&#39; in local directory.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Before this fixture is used, appropriate overrides should be set</span>
<span class="sd">        first on player.</span>

<span class="sd">    :return: a MockPlayerEventReportServer</span>
<span class="sd">    :rtype: :class:`~sonos.websrv.MockPlayerEventReportServer`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting up local event report receiver&quot;</span><span class="p">)</span>
    <span class="n">event_report_receiver_obj</span> <span class="o">=</span> <span class="n">MockPlayerEventReportServer</span><span class="p">()</span>
    <span class="n">event_report_receiver_obj</span><span class="o">.</span><span class="n">start_event_report_server</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">event_report_receiver_obj</span>
    <span class="n">event_report_receiver_obj</span><span class="o">.</span><span class="n">stop_player_report_server</span><span class="p">()</span></div>


<div class="viewcode-block" id="add_cpu_tracks_share"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.add_cpu_tracks_share">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_cpu_tracks_share</span><span class="p">(</span><span class="n">all_devices</span><span class="p">,</span> <span class="n">testbed_config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add cpu share to a device in</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_devices` using</span>
<span class="sd">    share path and credentials from</span>
<span class="sd">    :func:`~pytest_automation.conftest.testbed_config`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a_share_device</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_devices</span>
                      <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;ContentDirectory&quot;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">exec_env</span> <span class="o">=</span> <span class="n">testbed_config</span>
    <span class="p">(</span><span class="n">test_share</span><span class="p">,</span> <span class="n">test_share_credentials</span><span class="p">)</span> <span class="o">=</span> <span class="n">exec_env</span><span class="o">.</span><span class="n">get_share_by_key</span><span class="p">(</span>
        <span class="n">CPU_TRACKS_SHARE_KEY</span><span class="p">)</span>
    <span class="n">a_share_device</span><span class="o">.</span><span class="n">ContentDirectory</span><span class="o">.</span><span class="n">add_share</span><span class="p">(</span><span class="n">test_share</span><span class="p">,</span>
                                              <span class="o">*</span><span class="n">test_share_credentials</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="n">a_share_device</span><span class="o">.</span><span class="n">ContentDirectory</span><span class="o">.</span><span class="n">remove_all_shares</span><span class="p">()</span></div>


<div class="viewcode-block" id="http_mp3_server"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.http_mp3_server">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">http_mp3_server</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup the http mp3 server.</span>
<span class="sd">    :return: Enqueued URIs with Metadata</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">webserver</span> <span class="o">=</span> <span class="n">track_source</span><span class="o">.</span><span class="n">http_track_source</span><span class="o">.</span><span class="n">HTTPTrackSource</span><span class="p">(</span><span class="n">DEFAULT_TRACK_SOURCE_LOCATION</span><span class="p">)</span>
    <span class="n">webserver</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
    <span class="n">track_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">track_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">webserver</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">track_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">webserver</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">track_list_md</span> <span class="o">=</span> <span class="n">queue_helpers</span><span class="o">.</span><span class="n">create_didl_lite_md</span><span class="p">(</span><span class="n">track_list</span><span class="p">)</span>
    <span class="n">enqueued_uris_and_metadata</span> <span class="o">=</span> <span class="n">queue_helpers</span><span class="o">.</span><span class="n">create_uri_and_metadata_xml</span><span class="p">(</span><span class="n">track_list</span><span class="p">,</span> <span class="n">track_list_md</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">enqueued_uris_and_metadata</span>

    <span class="n">webserver</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>


<div class="viewcode-block" id="http_mp3_server_separate_tracks"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.http_mp3_server_separate_tracks">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">http_mp3_server_separate_tracks</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the http mp3 server</span>
<span class="sd">    :return: dict of uri and metadata for each track</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">webserver</span> <span class="o">=</span> <span class="n">track_source</span><span class="o">.</span><span class="n">http_track_source</span><span class="o">.</span><span class="n">HTTPTrackSource</span><span class="p">(</span><span class="n">DEFAULT_TRACK_SOURCE_LOCATION</span><span class="p">)</span>
    <span class="n">webserver</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
    <span class="n">track_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">webserver</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;uri&quot;</span><span class="p">:</span> <span class="n">track</span><span class="o">.</span><span class="n">media_url</span><span class="p">})</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">md_helper</span><span class="o">.</span><span class="n">generate_didl_lite</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">track</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                                          <span class="n">svc_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">acct_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">upnp_class</span><span class="o">=</span><span class="s2">&quot;object.item.audioItem.musicTrack&quot;</span><span class="p">,</span>
                                          <span class="n">artist</span><span class="o">=</span><span class="n">track</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span>
                                          <span class="n">album</span><span class="o">=</span><span class="n">track</span><span class="o">.</span><span class="n">album</span><span class="p">,</span>
                                          <span class="n">aa_uri</span><span class="o">=</span><span class="n">track</span><span class="o">.</span><span class="n">artwork_url</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">md</span><span class="p">})</span>
        <span class="n">track_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">track_list</span>

    <span class="n">webserver</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>


<span class="c1">#######################################</span>
<span class="c1"># Setting up tracks on player fixtures#</span>
<span class="c1">#######################################</span>


<div class="viewcode-block" id="device_to_queue"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.device_to_queue">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">device_to_queue</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the base device selector for the queued_device fixture. In order to</span>
<span class="sd">    modify the device(s) used by queued_device in your own test, override</span>
<span class="sd">    this fixture with the appropriate fixture parameter.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        # Override queued device selection</span>
<span class="sd">        @pytest.fixture(scope=&quot;module&quot;)</span>
<span class="sd">        def device_to_queue(&lt;&lt;your selection fixture&gt;&gt;):</span>
<span class="sd">            return &lt;&lt;your selection fixture&gt;&gt;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This fixture is expected to be overridden in test classes or other conftest.py files</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="queued_device"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.queued_device">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">queued_device</span><span class="p">(</span><span class="n">device_to_queue</span><span class="p">,</span> <span class="n">webserver_track_url_builder</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This fixture represents a</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.device_to_queue` with a queued</span>
<span class="sd">    track-list from the</span>
<span class="sd">    :func:`~pytest_automation.conftest.webserver_track_url_builder` ready to</span>
<span class="sd">    play. This fixture yields the device object and a list of track names that</span>
<span class="sd">    are currently in the queue. This fixture expects a request parameter with</span>
<span class="sd">    audio files that can be made available through the webserver fixture.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        pytest.mark.parametrize(&quot;queued_device&quot;, [&quot;track1file&quot;, &quot;track2file&quot;, &quot;track3file&quot;, ...], indirect=True)</span>
<span class="sd">        def test_different_queues(queued_device, track_uris):</span>
<span class="sd">            zp, queued_tracks = queued_device</span>
<span class="sd">            # Do stuff with player, make assertions, etc...</span>

<span class="sd">    .. note::</span>

<span class="sd">        This fixture may be called directly (as shown above), but will often be called in the context of</span>
<span class="sd">        the `queued_playing_device` fixture, which begins playback. In that case, you will probably only</span>
<span class="sd">        need to parametrize the fixture without explicitly calling it.</span>

<span class="sd">    :return: a SonosZoneComponent</span>
<span class="sd">    :rtype: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_cleanup_queue</span><span class="p">(</span><span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear avt and queue, remove bonded config if it exists</span>
<span class="sd">        :param zp: SonosZoneComponent</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning Up Queue on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">))</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">()</span>

    <span class="n">zp</span> <span class="o">=</span> <span class="n">device_to_queue</span>

    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting up device </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
    <span class="n">_cleanup_queue</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
    <span class="n">track_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">webserver_track_url_builder</span><span class="p">(</span><span class="n">track_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">track_name</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span><span class="p">]</span>
    <span class="c1"># Skip condition -- if either track is 6ch ogg on an S3 device</span>
    <span class="c1"># See SWPBL-53267</span>
    <span class="n">trk_fragment</span> <span class="o">=</span> <span class="s2">&quot;6ch_voices_44100Hz&quot;</span>
    <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_s3</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">trk_fragment</span> <span class="ow">in</span> <span class="n">track_uri</span> <span class="k">for</span> <span class="n">track_uri</span> <span class="ow">in</span> <span class="n">track_urls</span><span class="p">):</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Disabling playback of 6ch ogg track until due to SWPBL-53267&quot;</span><span class="p">)</span>

    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Queuing up tracks: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">track_urls</span><span class="p">))</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">()</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">add_to_queue</span><span class="p">(</span><span class="n">track_urls</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">zp</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>
    <span class="n">_cleanup_queue</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span></div>


<div class="viewcode-block" id="queued_playing_device"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.queued_playing_device">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">queued_playing_device</span><span class="p">(</span><span class="n">queued_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This fixture yields the :func:`~pytest_automation.player.conftest.queued_device`,</span>
<span class="sd">    track names and start time for a playing device with tracks queued up and playing.</span>
<span class="sd">    This fixture does not take any additional arguments, as those are passed onto the</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.queued_devices` fixture.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        @pytest.fixture(scope=&quot;module&quot;)</span>
<span class="sd">        def device_to_queue(unique_platform_playback_device):</span>
<span class="sd">            return unique_platform_playback_device</span>

<span class="sd">        @pytest.mark.parametrize(`queued_device`, [(&quot;trackA.ogg&quot;, &quot;trackB.ogg&quot;),</span>
<span class="sd">                (&quot;track1.ogg&quot;, &quot;track2.ogg&quot;), ...], indirect=True, scope=&quot;module&quot;)</span>
<span class="sd">        class SetOfTests:</span>
<span class="sd">            def test_device_start(queued_playing_device):</span>
<span class="sd">                zp, tracks = queued_playing_device[0:2]</span>
<span class="sd">                pass</span>

<span class="sd">            def test_device_start(queued_playing_device):</span>
<span class="sd">                zp, tracks, start_time = queued_playing_device</span>
<span class="sd">                # assertions about player, tracks, elapsed time...</span>

<span class="sd">     .. warning::</span>

<span class="sd">         This fixture is a &quot;running&quot; fixture, once kicked off, it is executing the play operation.</span>
<span class="sd">         There is no guarantee of state between test cases operating within this fixture. For example,</span>
<span class="sd">         if one test case waits for a track to complete, then the next test case cannot depend on that</span>
<span class="sd">         same track still playing.</span>

<span class="sd">    :return: a SonosZoneComponent</span>
<span class="sd">    :rtype: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span><span class="p">,</span> <span class="n">track_list</span> <span class="o">=</span> <span class="n">queued_device</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beginning playback on &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
    <span class="c1"># Store original play mode</span>
    <span class="n">pm</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetTransportSettings</span><span class="p">()[</span><span class="s1">&#39;PlayMode&#39;</span><span class="p">]</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetPlayMode</span><span class="p">(</span><span class="s2">&quot;NORMAL&quot;</span><span class="p">)</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">queued_device</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Stop_and_wait</span><span class="p">()</span>
    <span class="c1"># Restore original setting</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetPlayMode</span><span class="p">(</span><span class="n">pm</span><span class="p">)</span></div>


<span class="c1">########################</span>
<span class="c1"># Muse related fixtures#</span>
<span class="c1">########################</span>

<div class="viewcode-block" id="muse_playback_metadata"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.muse_playback_metadata">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">muse_playback_metadata</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Definition of playback Metadata fixed variables based on Muse API specs.</span>

<span class="sd">    :return: a muse_playback_metadata instance</span>
<span class="sd">    :rtype: :obj:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;explicit&quot;</span><span class="p">:</span> <span class="s2">&quot;TAG_EXPLICIT&quot;</span><span class="p">}}</span></div>


<div class="viewcode-block" id="check_backtraces"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.check_backtraces">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_backtraces</span><span class="p">(</span><span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks :func:`~pytest_automation.pytest_sonos_device_selection.all_devices`</span>
<span class="sd">    for any backtraces, and if found prints them and exits the entire suite.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">ZpLogger</span><span class="o">.</span><span class="n">print_backtraces</span><span class="p">(</span><span class="n">all_devices</span><span class="p">,</span> <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="p">),</span> <span class="s2">&quot;Backtraces found! Ending test&quot;</span></div>


<span class="c1">###############################################################################</span>
<span class="c1"># TODO: refactor all of these reporting, UMH fixtures with SWPBL-102435</span>
<span class="n">UMTRACKING</span> <span class="o">=</span> <span class="s2">&quot;UMTracking&quot;</span>
<span class="n">EVENTMETRICS_URL_OVERRIDE_NAME</span> <span class="o">=</span> <span class="s2">&quot;O_EVENTMETRICS_URL&quot;</span>
<span class="n">REPORTING_INTERVAL_MSG</span> <span class="o">=</span> <span class="s2">&quot;&lt;usagemetrics,0&gt; Initializing reporting interval to (?:\d+)&quot;</span>


<div class="viewcode-block" id="a_umh_configured_to_a_server"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.a_umh_configured_to_a_server">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_umh_configured_to_a_server</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a usage metrics handler that&#39;s configured to a webserver.</span>

<span class="sd">    :return: usage metrics configured to the webserver</span>
<span class="sd">    :rtype: :obj:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">umh</span> <span class="o">=</span> <span class="n">UsageMetrics</span><span class="p">()</span>
    <span class="n">umh</span><span class="o">.</span><span class="n">set_hard_or_soft_error</span><span class="p">(</span><span class="n">hard</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">websrv</span> <span class="o">=</span> <span class="n">LocalShareServer</span><span class="p">(</span><span class="n">start_reactor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">websrv</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
        <span class="n">handlers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="n">DynamicPOSTHandler</span><span class="p">(</span><span class="n">umh</span><span class="o">.</span><span class="n">metrics_event_handler</span><span class="p">)})</span>
    <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;umh&#39;</span><span class="p">:</span> <span class="n">umh</span><span class="p">,</span> <span class="s1">&#39;websrv&#39;</span><span class="p">:</span> <span class="n">websrv</span><span class="p">}</span>
    <span class="c1"># teardown server</span>
    <span class="n">websrv</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>


<div class="viewcode-block" id="set_up_reporting_zp_and_umh"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.set_up_reporting_zp_and_umh">[docs]</a><span class="k">def</span> <span class="nf">set_up_reporting_zp_and_umh</span><span class="p">(</span><span class="n">umh</span><span class="p">,</span> <span class="n">websrv</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Common set up method for fixtures that yield a UsageMetricsHandler and a</span>
<span class="sd">    Zone Player.</span>
<span class="sd">    :param umh: a UsageMetricsHandler object</span>
<span class="sd">    :param websrv: a webserver to be configured as the reporting endpoint</span>
<span class="sd">    for the ZP</span>
<span class="sd">    :param zp: Sonos Zone Component</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># save initial umtracking value</span>
    <span class="n">umtracking_val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">umtracking_val</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">UMTRACKING</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UPnPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;UPnP error retrieving </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">UMTRACKING</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

    <span class="c1"># set overrides</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">flush_usage_metrics_events</span><span class="p">()</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">SetString</span><span class="p">(</span><span class="n">UMTRACKING</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Report&#39;</span><span class="p">)</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">{}</span><span class="s2">/metrics&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">websrv</span><span class="o">.</span><span class="n">host</span><span class="p">())</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">SetString</span><span class="p">(</span>
        <span class="n">EVENTMETRICS_URL_OVERRIDE_NAME</span><span class="p">,</span>
        <span class="n">url</span><span class="p">)</span>

    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;set url to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>

    <span class="n">umh</span><span class="o">.</span><span class="n">metrics_event_clear</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">umh</span><span class="o">.</span><span class="n">save_ip</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">ip</span>

    <span class="k">return</span> <span class="n">umtracking_val</span></div>


<div class="viewcode-block" id="tear_down_reporting_zp"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.tear_down_reporting_zp">[docs]</a><span class="k">def</span> <span class="nf">tear_down_reporting_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">umtracking_val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Common tear down method for fixtures that yield a UsageMetricsHandler</span>
<span class="sd">    and a Zone Player</span>
<span class="sd">    :param zp: Sonos Zone Component</span>
<span class="sd">    :param str umtracking_val: initial value of</span>
<span class="sd">    zp.SystemProperties.GetString() for UMTRACKING constant</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># remove overrides on ZP</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">EVENTMETRICS_URL_OVERRIDE_NAME</span><span class="p">)</span>

    <span class="c1"># stop the UDP logger so that it doesn&#39;t spam anything else to our counters</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log</span><span class="p">()</span>

    <span class="c1"># reset umtracking_val</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">umtracking_val</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing </span><span class="si">{}</span><span class="s2"> variable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">UMTRACKING</span><span class="p">))</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">UMTRACKING</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restoring </span><span class="si">{}</span><span class="s2"> variable to &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">UMTRACKING</span><span class="p">,</span> <span class="n">umtracking_val</span><span class="p">))</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">SetString</span><span class="p">(</span><span class="n">UMTRACKING</span><span class="p">,</span>
                                      <span class="n">umtracking_val</span><span class="p">)</span>

    <span class="c1"># bounce anacapa on the ht master capable device to set in the changes</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">()</span></div>


<div class="viewcode-block" id="wait_for_reporting_subsystem"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.wait_for_reporting_subsystem">[docs]</a><span class="k">def</span> <span class="nf">wait_for_reporting_subsystem</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param zp: the zone player for which we want to wait to begin its</span>
<span class="sd">    reporting interval</span>
<span class="sd">    :param timeout: the number of seconds to wait for the zp to begin its</span>
<span class="sd">    reporting interval</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inspector</span> <span class="o">=</span> <span class="n">AnacapaTraceLogInspector</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
    <span class="n">inspector</span><span class="o">.</span><span class="n">mark_last_log_entry</span><span class="p">()</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">inspector</span><span class="o">.</span><span class="n">wait_for_next</span><span class="p">(</span><span class="n">REPORTING_INTERVAL_MSG</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="a_reporting_ht_master_and_umh"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.a_reporting_ht_master_and_umh">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_reporting_ht_master_and_umh</span><span class="p">(</span><span class="n">ht_master_capable_device</span><span class="p">,</span>
                                  <span class="n">a_umh_configured_to_a_server</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup a :func:`~pytest_automation.pytest_sonos_device_selection.ht_master_capable_device`</span>
<span class="sd">    for event reporting to a local server and a UsageMetrics handler using</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.a_umh_configured_to_a_server`</span>
<span class="sd">    which has already been configured to interface with the local server.</span>

<span class="sd">    :return: the usage metrics configured on the webserver</span>
<span class="sd">    :rtype: :obj:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span> <span class="o">=</span> <span class="n">ht_master_capable_device</span>
    <span class="n">umh</span> <span class="o">=</span> <span class="n">a_umh_configured_to_a_server</span><span class="p">[</span><span class="s1">&#39;umh&#39;</span><span class="p">]</span>
    <span class="n">websrv</span> <span class="o">=</span> <span class="n">a_umh_configured_to_a_server</span><span class="p">[</span><span class="s1">&#39;websrv&#39;</span><span class="p">]</span>
    <span class="n">umtracking_val</span> <span class="o">=</span> <span class="n">set_up_reporting_zp_and_umh</span><span class="p">(</span><span class="n">umh</span><span class="p">,</span> <span class="n">websrv</span><span class="p">,</span> <span class="n">zp</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">wait_for_reporting_subsystem</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;zp&#39;</span><span class="p">:</span> <span class="n">zp</span><span class="p">,</span> <span class="s1">&#39;umh&#39;</span><span class="p">:</span> <span class="n">umh</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed waiting for reporting subsystem on zp: &quot;</span>
                           <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
    <span class="n">tear_down_reporting_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">umtracking_val</span><span class="p">)</span></div>


<div class="viewcode-block" id="a_reporting_hdmi_zp_and_umh"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.a_reporting_hdmi_zp_and_umh">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_reporting_hdmi_zp_and_umh</span><span class="p">(</span><span class="n">hdmi_capable_devices</span><span class="p">,</span>
                                <span class="n">a_umh_configured_to_a_server</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup a :func:`~pytest_automation.player.conftest.hdmi_capable_devices`</span>
<span class="sd">    for event reporting to a local server and a UsageMetrics handler which has</span>
<span class="sd">    already been configured to interface with the</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.a_umh_configured_to_a_server`.</span>

<span class="sd">    :return: the usage metrics configured on the webserver</span>
<span class="sd">    :rtype: :obj:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span> <span class="o">=</span> <span class="n">hdmi_capable_devices</span>
    <span class="n">umh</span> <span class="o">=</span> <span class="n">a_umh_configured_to_a_server</span><span class="p">[</span><span class="s1">&#39;umh&#39;</span><span class="p">]</span>
    <span class="n">websrv</span> <span class="o">=</span> <span class="n">a_umh_configured_to_a_server</span><span class="p">[</span><span class="s1">&#39;websrv&#39;</span><span class="p">]</span>
    <span class="n">umtracking_val</span> <span class="o">=</span> <span class="n">set_up_reporting_zp_and_umh</span><span class="p">(</span><span class="n">umh</span><span class="p">,</span> <span class="n">websrv</span><span class="p">,</span> <span class="n">zp</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">wait_for_reporting_subsystem</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;zp&#39;</span><span class="p">:</span> <span class="n">zp</span><span class="p">,</span> <span class="s1">&#39;umh&#39;</span><span class="p">:</span> <span class="n">umh</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed waiting for reporting subsystem on zp: &quot;</span>
                           <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
    <span class="n">tear_down_reporting_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">umtracking_val</span><span class="p">)</span></div>


<div class="viewcode-block" id="stereo_pair_system_setUp"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.stereo_pair_system_setUp">[docs]</a><span class="k">def</span> <span class="nf">stereo_pair_system_setUp</span><span class="p">(</span><span class="n">stereo_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to setup stereo pair system</span>

<span class="sd">    :param stereo_devices: tuple of (non-paired) devices</span>
<span class="sd">    :return: tuple of left and right ZP, stereo paired</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">stereo_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">stereo_devices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuring Stereo Paired System&quot;</span><span class="p">)</span>
    <span class="n">left</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">add_stereo_pair</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span></div>


<div class="viewcode-block" id="stereo_pair_system_tearDown"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.stereo_pair_system_tearDown">[docs]</a><span class="k">def</span> <span class="nf">stereo_pair_system_tearDown</span><span class="p">(</span><span class="n">stereo_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to tear down stereo pair system</span>

<span class="sd">    :param stereo_devices: tuple of left and right ZP, stereo paired</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">stereo_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deconfiguring Stereo Paired System&quot;</span><span class="p">)</span>
    <span class="n">left</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span></div>


<div class="viewcode-block" id="a_stereo_pair_system_with_ledctl"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.a_stereo_pair_system_with_ledctl">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_stereo_pair_system_with_ledctl</span><span class="p">(</span><span class="n">a_stereo_pairable_ledctl_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bond a stereo pair and yield it for a test. Unbond after test</span>

<span class="sd">    :param list a_stereo_pairable_ledctl_device: single [left, right]</span>
<span class="sd">        stereo pairable devices with ledctl drivers</span>
<span class="sd">    :return: [left, right]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">stereo_pair_system_setUp</span><span class="p">(</span><span class="n">a_stereo_pairable_ledctl_device</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">]</span>
    <span class="n">stereo_pair_system_tearDown</span><span class="p">(</span><span class="n">a_stereo_pairable_ledctl_device</span><span class="p">)</span></div>


<div class="viewcode-block" id="stereo_pair_system"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.stereo_pair_system">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stereo_pair_system</span><span class="p">(</span><span class="n">stereo_pairable_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bond a stereo pair using a</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.stereo_pairable_device`</span>
<span class="sd">    and yield it for a test. Unbond after test.</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents (left, right)</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">stereo_pair_system_setUp</span><span class="p">(</span><span class="n">stereo_pairable_device</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">]</span>
    <span class="n">stereo_pair_system_tearDown</span><span class="p">(</span><span class="n">stereo_pairable_device</span><span class="p">)</span></div>


<div class="viewcode-block" id="a_stereo_pair_system"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.a_stereo_pair_system">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_stereo_pair_system</span><span class="p">(</span><span class="n">a_stereo_pairable_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bond a stereo pair using a</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.a_stereo_pairable_devices`</span>
<span class="sd">    and yield it for a test. Unbond after test.</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents (left, right)</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">stereo_pair_system_setUp</span><span class="p">(</span><span class="n">a_stereo_pairable_devices</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">]</span>
    <span class="n">stereo_pair_system_tearDown</span><span class="p">(</span><span class="n">a_stereo_pairable_devices</span><span class="p">)</span></div>


<div class="viewcode-block" id="stereo_pair_system_function_scope"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.stereo_pair_system_function_scope">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stereo_pair_system_function_scope</span><span class="p">(</span><span class="n">stereo_pairable_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bond a stereo pair using a</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.stereo_pairable_device` and yield</span>
<span class="sd">    it for a test. Unbond after test.</span>

<span class="sd">    .. note::</span>

<span class="sd">        (scope = function) because otherwise teardown (after yield) won&#39;t occur</span>
<span class="sd">        until class / module / session scope expires, leaving devices in a</span>
<span class="sd">        bonded state.</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents (left, right)</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">stereo_pair_system_setUp</span><span class="p">(</span><span class="n">stereo_pairable_device</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">]</span>
    <span class="n">stereo_pair_system_tearDown</span><span class="p">(</span><span class="n">stereo_pairable_device</span><span class="p">)</span></div>


<div class="viewcode-block" id="ht_31_system_setUp"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_31_system_setUp">[docs]</a><span class="k">def</span> <span class="nf">ht_31_system_setUp</span><span class="p">(</span><span class="n">ht_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to create 3.1 HT bonded system</span>

<span class="sd">    :param ht_devices: tuple of (unbonded) ZPs</span>
<span class="sd">    :return: tuple of (bonded) ZPs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">ht_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">ht_devices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuring 3.1 HT System&quot;</span><span class="p">)</span>
    <span class="n">master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">create_31_config</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">master</span><span class="p">,</span> <span class="n">sub</span></div>


<div class="viewcode-block" id="ht_31_system_tearDown"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_31_system_tearDown">[docs]</a><span class="k">def</span> <span class="nf">ht_31_system_tearDown</span><span class="p">(</span><span class="n">ht_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to tear down a 3.1 HT bonded system</span>

<span class="sd">    :param ht_devices: tuple of (bonded) ZPs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">ht_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deconfiguring 3.1 HT System&quot;</span><span class="p">)</span>
    <span class="n">master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span></div>


<div class="viewcode-block" id="ht_31_system"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_31_system">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ht_31_system</span><span class="p">(</span><span class="n">ht_31_config_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a bonded 3.1 configuration of zone players from</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.ht_31_config_system`.</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span><span class="p">,</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">ht_31_system_setUp</span><span class="p">(</span><span class="n">ht_31_config_devices</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">master</span><span class="p">,</span> <span class="n">sub</span><span class="p">]</span>
    <span class="n">ht_31_system_tearDown</span><span class="p">(</span><span class="n">ht_31_config_devices</span><span class="p">)</span></div>


<div class="viewcode-block" id="any_ht_31_system"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.any_ht_31_system">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">any_ht_31_system</span><span class="p">(</span><span class="n">all_ht_31_config_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Any HT 3.1 configuration (for when you only need to test 1 HT master)</span>
<span class="sd">    from :func:`~pytest_automation.pytest_sonos_device_selection.all_ht_31_config_devices`.</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span><span class="p">,</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">ht_31_system_setUp</span><span class="p">(</span><span class="n">all_ht_31_config_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">master</span><span class="p">,</span> <span class="n">sub</span><span class="p">]</span>
    <span class="n">ht_31_system_tearDown</span><span class="p">(</span><span class="n">all_ht_31_config_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="ht_50_system_with_any_master"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_50_system_with_any_master">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ht_50_system_with_any_master</span><span class="p">(</span>
        <span class="n">ht_50_config_devices_with_same_ht_master</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a bonded 5.0 configuration of zone players from</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.ht_50_config_devices_with_same_ht_master`.</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">ht_50_config_devices_with_same_ht_master</span>
    <span class="n">master</span><span class="p">,</span> <span class="n">sat0</span><span class="p">,</span> <span class="n">sat1</span> <span class="o">=</span> <span class="n">ht_50_system_setUp</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">master</span><span class="p">,</span> <span class="n">sat0</span><span class="p">,</span> <span class="n">sat1</span><span class="p">]</span>
    <span class="n">ht_50_system_tearDown</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="ht_31_system_function_scope"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_31_system_function_scope">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ht_31_system_function_scope</span><span class="p">(</span><span class="n">ht_31_config_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a bonded 3.1 configuration of zone players from</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.ht_31_config_devices`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        (scope = function) because otherwise teardown (after yield) won&#39;t occur</span>
<span class="sd">        until class / module / session scope expires, leaving devices in a</span>
<span class="sd">        bonded state).</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span><span class="p">,</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">ht_31_system_setUp</span><span class="p">(</span><span class="n">ht_31_config_devices</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">master</span><span class="p">,</span> <span class="n">sub</span><span class="p">]</span>
    <span class="n">ht_31_system_tearDown</span><span class="p">(</span><span class="n">ht_31_config_devices</span><span class="p">)</span></div>


<div class="viewcode-block" id="ht_50_system_setUp"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_50_system_setUp">[docs]</a><span class="k">def</span> <span class="nf">ht_50_system_setUp</span><span class="p">(</span><span class="n">ht_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to configure a bonded 5.0 HT system</span>

<span class="sd">    :param ht_devices: tuple of (unbonded) ZPs</span>
<span class="sd">    :return: tuple of (bonded) ZPs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">ht_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sat0</span> <span class="o">=</span> <span class="n">ht_devices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sat1</span> <span class="o">=</span> <span class="n">ht_devices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuring 5.0 HT System&quot;</span><span class="p">)</span>
    <span class="n">master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">create_50_config</span><span class="p">(</span><span class="n">sat0</span><span class="p">,</span> <span class="n">sat1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">master</span><span class="p">,</span> <span class="n">sat0</span><span class="p">,</span> <span class="n">sat1</span></div>


<div class="viewcode-block" id="ht_50_system_tearDown"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_50_system_tearDown">[docs]</a><span class="k">def</span> <span class="nf">ht_50_system_tearDown</span><span class="p">(</span><span class="n">ht_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to tear down a bonded 5.0 HT system</span>

<span class="sd">    :param ht_devices: tuple of (bonded) ZPs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">ht_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deconfiguring 5.0 HT System&quot;</span><span class="p">)</span>
    <span class="n">master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span></div>


<div class="viewcode-block" id="ht_50_system"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_50_system">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ht_50_system</span><span class="p">(</span><span class="n">ht_50_config_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a bonded 5.0 configuration of zone players from</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.ht_50_config_devices`.</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span><span class="p">,</span> <span class="n">sat0</span><span class="p">,</span> <span class="n">sat1</span> <span class="o">=</span> <span class="n">ht_50_system_setUp</span><span class="p">(</span><span class="n">ht_50_config_devices</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">master</span><span class="p">,</span> <span class="n">sat0</span><span class="p">,</span> <span class="n">sat1</span><span class="p">]</span>
    <span class="n">ht_50_system_tearDown</span><span class="p">(</span><span class="n">ht_50_config_devices</span><span class="p">)</span></div>


<div class="viewcode-block" id="a_ht_50_system"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.a_ht_50_system">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_ht_50_system</span><span class="p">(</span><span class="n">a_ht_50_config_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a bonded 5.0 configuration of zone players from</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.a_ht_50_config_devices`.</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span><span class="p">,</span> <span class="n">sat0</span><span class="p">,</span> <span class="n">sat1</span> <span class="o">=</span> <span class="n">ht_50_system_setUp</span><span class="p">(</span><span class="n">a_ht_50_config_devices</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">master</span><span class="p">,</span> <span class="n">sat0</span><span class="p">,</span> <span class="n">sat1</span><span class="p">]</span>
    <span class="n">ht_50_system_tearDown</span><span class="p">(</span><span class="n">a_ht_50_config_devices</span><span class="p">)</span></div>


<div class="viewcode-block" id="a_ht_50_system_with_ledctl_driver"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.a_ht_50_system_with_ledctl_driver">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_ht_50_system_with_ledctl_driver</span><span class="p">(</span>
        <span class="n">a_ht_50_config_devices_with_ledctl_driver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a 5.0 configuration of zone players, already bonded, where each</span>
<span class="sd">    player has a ledctl driver</span>

<span class="sd">    the un-bonded zone components necessary for making a 5.0 configuration</span>
<span class="sd">    :return: list of Sonos Zone Components [master, LR, RR]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span><span class="p">,</span> <span class="n">sat0</span><span class="p">,</span> <span class="n">sat1</span> <span class="o">=</span> <span class="n">ht_50_system_setUp</span><span class="p">(</span>
        <span class="n">a_ht_50_config_devices_with_ledctl_driver</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">master</span><span class="p">,</span> <span class="n">sat0</span><span class="p">,</span> <span class="n">sat1</span><span class="p">]</span>
    <span class="n">ht_50_system_tearDown</span><span class="p">(</span><span class="n">a_ht_50_config_devices_with_ledctl_driver</span><span class="p">)</span></div>


<div class="viewcode-block" id="ht_50_system_function_scope"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_50_system_function_scope">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ht_50_system_function_scope</span><span class="p">(</span><span class="n">ht_50_config_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a bonded 5.0 configuration of zone players from</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.ht_50_config_devices`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        (scope = function) because otherwise teardown (after yield) won&#39;t occur</span>
<span class="sd">        until class / module / session scope expires, leaving devices in a</span>
<span class="sd">        bonded state).</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span><span class="p">,</span> <span class="n">sat0</span><span class="p">,</span> <span class="n">sat1</span> <span class="o">=</span> <span class="n">ht_50_system_setUp</span><span class="p">(</span><span class="n">ht_50_config_devices</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">master</span><span class="p">,</span> <span class="n">sat0</span><span class="p">,</span> <span class="n">sat1</span><span class="p">]</span>
    <span class="n">ht_50_system_tearDown</span><span class="p">(</span><span class="n">ht_50_config_devices</span><span class="p">)</span></div>


<div class="viewcode-block" id="ht_51_system_setUp"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_51_system_setUp">[docs]</a><span class="k">def</span> <span class="nf">ht_51_system_setUp</span><span class="p">(</span><span class="n">ht_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to configure a bonded 5.1 HT system</span>

<span class="sd">    :param ht_devices: tuple of (unbonded) ZPs</span>
<span class="sd">    :return: tuple of (bonded) ZPs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">ht_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">ht_devices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">ht_devices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">ht_devices</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuring 5.1 HT System&quot;</span><span class="p">)</span>
    <span class="n">master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">create_51_config</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">master</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">rs</span></div>


<div class="viewcode-block" id="ht_51_system_tearDown"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_51_system_tearDown">[docs]</a><span class="k">def</span> <span class="nf">ht_51_system_tearDown</span><span class="p">(</span><span class="n">ht_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to tear down a bonded 5.1 HT system</span>

<span class="sd">    :param ht_devices: tuple of (bonded) ZPs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">ht_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deconfiguring 5.1 HT System&quot;</span><span class="p">)</span>
    <span class="n">master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span></div>


<div class="viewcode-block" id="ht_51_system"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_51_system">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ht_51_system</span><span class="p">(</span><span class="n">ht_51_config_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a bonded 5.1 configuration of zone players from</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.ht_51_config_devices`.</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">ht_51_system_setUp</span><span class="p">(</span><span class="n">ht_51_config_devices</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">master</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">rs</span><span class="p">]</span>
    <span class="n">ht_51_system_tearDown</span><span class="p">(</span><span class="n">ht_51_config_devices</span><span class="p">)</span></div>


<div class="viewcode-block" id="ht_51_system_function_scope"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ht_51_system_function_scope">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ht_51_system_function_scope</span><span class="p">(</span><span class="n">ht_51_config_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a bonded 5.1 configuration of zone players from</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.ht_51_config_devices`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        (scope = function) because otherwise teardown (after yield) won&#39;t occur</span>
<span class="sd">        until class / module / session scope expires, leaving devices in a</span>
<span class="sd">        bonded state)</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">master</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">ht_51_system_setUp</span><span class="p">(</span><span class="n">ht_51_config_devices</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">master</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">rs</span><span class="p">]</span>
    <span class="n">ht_51_system_tearDown</span><span class="p">(</span><span class="n">ht_51_config_devices</span><span class="p">)</span></div>


<div class="viewcode-block" id="amp_no_speakers_and_bonded_sub_setUp"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.amp_no_speakers_and_bonded_sub_setUp">[docs]</a><span class="k">def</span> <span class="nf">amp_no_speakers_and_bonded_sub_setUp</span><span class="p">(</span><span class="n">amp_device</span><span class="p">,</span> <span class="n">sub_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to set up an amp device (no built-in speaker) with a</span>
<span class="sd">    bonded sub</span>

<span class="sd">    :param amp_device: Amp ZP</span>
<span class="sd">    :param sub_device: Sub ZP</span>
<span class="sd">    :return: tuple of (bonded) amp and sub ZPs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span> <span class="o">=</span> <span class="n">amp_device</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">sub_device</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuring Amp and Sub System&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">ht_master_capable</span><span class="p">:</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">create_31_config</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">add_bonded_sub_to_this_device</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">zp</span><span class="p">,</span> <span class="n">sub</span></div>


<div class="viewcode-block" id="amp_no_speakers_and_bonded_sub_tearDown"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.amp_no_speakers_and_bonded_sub_tearDown">[docs]</a><span class="k">def</span> <span class="nf">amp_no_speakers_and_bonded_sub_tearDown</span><span class="p">(</span><span class="n">amp_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to tear down an amp device (no built-in speaker) with a</span>
<span class="sd">    bonded sub</span>
<span class="sd">    :param amp_device: Amp ZP</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deconfiguring Amp and Sub System&quot;</span><span class="p">)</span>
    <span class="n">amp_device</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span></div>


<div class="viewcode-block" id="amp_no_speakers_and_bonded_sub"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.amp_no_speakers_and_bonded_sub">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">amp_no_speakers_and_bonded_sub</span><span class="p">(</span><span class="n">unique_amp_no_speakers_device</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a bonded</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.unique_amp_no_speakers_device`</span>
<span class="sd">    with a :func:`~pytest_automation.pytest_sonos_device_selection.sub`.</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span><span class="p">,</span> <span class="n">sub_device</span> <span class="o">=</span> <span class="n">amp_no_speakers_and_bonded_sub_setUp</span><span class="p">(</span>
        <span class="n">unique_amp_no_speakers_device</span><span class="p">,</span> <span class="n">sub</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">zp</span><span class="p">,</span> <span class="n">sub_device</span><span class="p">]</span>
    <span class="n">amp_no_speakers_and_bonded_sub_tearDown</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span></div>


<div class="viewcode-block" id="amp_no_speakers_and_bonded_sub_function_scope"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.amp_no_speakers_and_bonded_sub_function_scope">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">amp_no_speakers_and_bonded_sub_function_scope</span><span class="p">(</span>
        <span class="n">unique_amp_no_speakers_device</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a bonded</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.unique_amp_no_speakers_device`</span>
<span class="sd">    with a :func:`~pytest_automation.pytest_sonos_device_selection.sub`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        (scope = function) because otherwise teardown (after yield) won&#39;t occur</span>
<span class="sd">        until class / module / session scope expires, leaving devices in a</span>
<span class="sd">        bonded state).</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span><span class="p">,</span> <span class="n">sub_device</span> <span class="o">=</span> <span class="n">amp_no_speakers_and_bonded_sub_setUp</span><span class="p">(</span>
        <span class="n">unique_amp_no_speakers_device</span><span class="p">,</span> <span class="n">sub</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">zp</span><span class="p">,</span> <span class="n">sub_device</span><span class="p">]</span>
    <span class="n">amp_no_speakers_and_bonded_sub_tearDown</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span></div>


<div class="viewcode-block" id="bonded_sub_system_setUp"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.bonded_sub_system_setUp">[docs]</a><span class="k">def</span> <span class="nf">bonded_sub_system_setUp</span><span class="p">(</span><span class="n">devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to set up a bonded ZP/sub config</span>

<span class="sd">    :param devices: tuple of (unbonded) player and sub ZP</span>
<span class="sd">    :return: tuple of (bonded) player and sub ZP</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span> <span class="o">=</span> <span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">devices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuring Bonded Sub System&quot;</span><span class="p">)</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">add_bonded_sub_to_this_device</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">zp</span><span class="p">,</span> <span class="n">sub</span></div>


<div class="viewcode-block" id="bonded_sub_system_tearDown"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.bonded_sub_system_tearDown">[docs]</a><span class="k">def</span> <span class="nf">bonded_sub_system_tearDown</span><span class="p">(</span><span class="n">devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to tear down a bonded ZP/sub config</span>
<span class="sd">    :param devices: tuple of (bonded) player and sub ZP</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span> <span class="o">=</span> <span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deconfiguring Bonded Sub System&quot;</span><span class="p">)</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span></div>


<div class="viewcode-block" id="bonded_sub_system"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.bonded_sub_system">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bonded_sub_system</span><span class="p">(</span><span class="n">bonded_sub_config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a standalone player and a sub already bonded to it</span>
<span class="sd">    using :func:`~pytest_automation.player.conftest.bonded_sub_config`.</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span><span class="p">,</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">bonded_sub_system_setUp</span><span class="p">(</span><span class="n">bonded_sub_config</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">zp</span><span class="p">,</span> <span class="n">sub</span><span class="p">]</span>
    <span class="n">bonded_sub_system_tearDown</span><span class="p">(</span><span class="n">bonded_sub_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="bonded_sub_system_function_scope"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.bonded_sub_system_function_scope">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bonded_sub_system_function_scope</span><span class="p">(</span><span class="n">bonded_sub_config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a standalone player and a sub already bonded to it</span>
<span class="sd">    using :func:`~pytest_automation.player.conftest.bonded_sub_config`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        (scope = function) because otherwise teardown (after yield) won&#39;t occur</span>
<span class="sd">        until class / module / session scope expires, leaving devices in a</span>
<span class="sd">        bonded state).</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span><span class="p">,</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">bonded_sub_system_setUp</span><span class="p">(</span><span class="n">bonded_sub_config</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">zp</span><span class="p">,</span> <span class="n">sub</span><span class="p">]</span>
    <span class="n">bonded_sub_system_tearDown</span><span class="p">(</span><span class="n">bonded_sub_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="any_bonded_sub_system"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.any_bonded_sub_system">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">any_bonded_sub_system</span><span class="p">(</span><span class="n">all_bonded_sub_configs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Any bonded sub system (for when you only need to test 1 primary)</span>
<span class="sd">    from :func:`~pytest_automation.pytest_sonos_device_selection.all_bonded_sub_configs`.</span>

<span class="sd">    :return: a list of the bonded SonosZoneComponents</span>
<span class="sd">    :rtype: :obj:`list` of :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">primary</span><span class="p">,</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">bonded_sub_system_setUp</span><span class="p">(</span><span class="n">all_bonded_sub_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">yield</span> <span class="p">[</span><span class="n">primary</span><span class="p">,</span> <span class="n">sub</span><span class="p">]</span>
    <span class="n">bonded_sub_system_tearDown</span><span class="p">(</span><span class="n">all_bonded_sub_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="a_ht_master_device_autoplay_enabled"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.a_ht_master_device_autoplay_enabled">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_ht_master_device_autoplay_enabled</span><span class="p">(</span><span class="n">ht_master_capable_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield each type of</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.ht_master_capable_device`</span>
<span class="sd">    on the testbed with SPDIF input enabled (autoplay enabled).</span>
<span class="sd">    On teardown, set autoplay off.</span>

<span class="sd">    :return: the HT master SonosZoneComponent</span>
<span class="sd">    :rtype: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ht_master</span> <span class="o">=</span> <span class="n">ht_master_capable_device</span>
    <span class="n">ht_master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">SetAutoplayRoomUUID</span><span class="p">(</span><span class="n">ht_master</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">)</span>
    <span class="n">check_spdif_input_signal</span><span class="p">(</span><span class="n">ht_master</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">ht_master</span>
    <span class="n">ht_master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">SetAutoplayRoomUUID</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="a_ht_master_device_with_sub_autoplay_enabled"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.a_ht_master_device_with_sub_autoplay_enabled">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_ht_master_device_with_sub_autoplay_enabled</span><span class="p">(</span><span class="n">ht_31_system_function_scope</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield each type of</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.ht_31_system_function_scope` on</span>
<span class="sd">    the testbed with SPDIF input enabled (autoplay enabled).</span>
<span class="sd">    On teardown, set autoplay off.</span>

<span class="sd">    :return: SonosZoneComponents</span>
<span class="sd">    :rtype: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">ht_master</span><span class="p">,</span> <span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="n">ht_31_system_function_scope</span>
    <span class="n">ht_master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">SetAutoplayRoomUUID</span><span class="p">(</span><span class="n">ht_master</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">)</span>
    <span class="n">check_spdif_input_signal</span><span class="p">(</span><span class="n">ht_master</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">ht_master</span><span class="p">,</span> <span class="n">sub</span>
    <span class="n">ht_master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">SetAutoplayRoomUUID</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="a_ht_master_device_with_sats_and_sub_autoplay_enabled"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.a_ht_master_device_with_sats_and_sub_autoplay_enabled">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_ht_master_device_with_sats_and_sub_autoplay_enabled</span><span class="p">(</span>
        <span class="n">ht_51_system_function_scope</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield each type of</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.ht_51_system_function_scope` on</span>
<span class="sd">    the testbed with SPDIF input enabled (autoplay enabled).</span>
<span class="sd">    On teardown, set autoplay off.</span>

<span class="sd">    :return: SonosZoneComponents</span>
<span class="sd">    :rtype: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">ht_master</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">rs</span><span class="p">]</span> <span class="o">=</span> <span class="n">ht_51_system_function_scope</span>
    <span class="n">ht_master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">SetAutoplayRoomUUID</span><span class="p">(</span><span class="n">ht_master</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">)</span>
    <span class="n">check_spdif_input_signal</span><span class="p">(</span><span class="n">ht_master</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">ht_master</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">rs</span>
    <span class="n">ht_master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">SetAutoplayRoomUUID</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_spdif_input_signal"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.check_spdif_input_signal">[docs]</a><span class="k">def</span> <span class="nf">check_spdif_input_signal</span><span class="p">(</span><span class="n">zp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method for &#39;a_ht_master_device_*_spdif_enabled&#39; fixtures:</span>
<span class="sd">    Asserts that the testrunner is providing a valid SPDIF input</span>

<span class="sd">    :param zp: ZP</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wait_poll_frequency</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">wait_timeout</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="k">for</span> <span class="n">test_signal</span> <span class="ow">in</span> <span class="n">SPDIF_TESTSIG_FILES</span><span class="p">:</span>
        <span class="n">strTestInputFileURL</span><span class="p">,</span> <span class="n">dictTrackInfo</span> <span class="o">=</span> <span class="n">test_signal</span>
        <span class="k">with</span> <span class="n">MplayerAc3Playback</span><span class="p">(</span><span class="n">strTestInputFileURL</span><span class="p">,</span> <span class="s1">&#39;hwac3&#39;</span> <span class="k">if</span> <span class="n">dictTrackInfo</span><span class="p">[</span>
            <span class="s1">&#39;StreamInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Dolby Digital&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;pcm&#39;</span><span class="p">):</span>
            <span class="n">wait_until_true</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_toslink_stream_type</span><span class="p">()</span> <span class="o">==</span>
                         <span class="n">dictTrackInfo</span><span class="p">[</span><span class="s1">&#39;StreamInfo&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span>
                                <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_toslink_sample_rate</span><span class="p">()</span> <span class="o">==</span>
                                <span class="n">dictTrackInfo</span><span class="p">[</span><span class="s1">&#39;SampleRate&#39;</span><span class="p">]),</span>
                <span class="n">iteration_delay</span><span class="o">=</span><span class="n">wait_poll_frequency</span><span class="p">,</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">wait_timeout</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Error while playing back test SPDIF signal: &#39;</span>
                        <span class="s1">&#39;Expected SPDIF Stream Type: </span><span class="si">{}</span><span class="s1"> with Sample &#39;</span>
                        <span class="s1">&#39;Rate: </span><span class="si">{}</span><span class="s1">, Actual SPDIF Stream Type: </span><span class="si">{}</span><span class="s1"> with &#39;</span>
                        <span class="s1">&#39;Sample Rate: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>
                        <span class="nb">format</span><span class="p">(</span><span class="n">dictTrackInfo</span><span class="p">[</span><span class="s1">&#39;StreamInfo&#39;</span><span class="p">],</span>
                               <span class="n">dictTrackInfo</span><span class="p">[</span><span class="s1">&#39;SampleRate&#39;</span><span class="p">],</span>
                               <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_toslink_stream_type</span><span class="p">(),</span>
                               <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_toslink_sample_rate</span><span class="p">())</span>
                        <span class="p">)</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="pytest_runtest_call"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.pytest_runtest_call">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tryfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_runtest_call</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pytest hook to allow delineating test cases in anacapa</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">delineate_tests_in_anacapa</span><span class="p">:</span>
        <span class="n">test_name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="mi">127</span>  <span class="c1"># Max line length supported by anacapa</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">funcargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">SonosZoneComponent</span><span class="p">:</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>  <span class="c1"># If there is a list check it for players</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">is</span> <span class="n">SonosZoneComponent</span><span class="p">:</span>
                        <span class="n">devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">devices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="n">start_message</span> <span class="o">=</span> <span class="s2">&quot;Start test: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_message</span><span class="p">),</span> <span class="n">max_length</span><span class="p">):</span>
                <span class="n">device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">post_diagmsg</span><span class="p">(</span><span class="n">start_message</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">max_length</span><span class="p">])</span>
        <span class="k">yield</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="n">end_message</span> <span class="o">=</span> <span class="s2">&quot;Stop test: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_message</span><span class="p">),</span> <span class="n">max_length</span><span class="p">):</span>
                <span class="n">device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">post_diagmsg</span><span class="p">(</span><span class="n">end_message</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">max_length</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span></div>


<div class="viewcode-block" id="pytest_runtest_makereport"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.pytest_runtest_makereport">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">tryfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_runtest_makereport</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Using hook to collects diag when failure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">collect_testbed_diag</span><span class="p">(</span><span class="n">zps</span><span class="p">,</span> <span class="n">testname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save a household diag to disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Collecting diags for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zps</span><span class="p">))</span>
        <span class="n">output_filename</span> <span class="o">=</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span>
                <span class="s2">&quot;testbed-diag-</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">.xml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">testname</span><span class="p">,</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="n">pytest</span><span class="o">.</span><span class="n">subnet</span><span class="o">.</span><span class="n">wait_for_devices_with_these_serials</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                                                              <span class="n">x</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">,</span>
                                                              <span class="n">zps</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">hhid</span><span class="p">:</span>
                    <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">save_household_diag</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to save household diag &quot;</span>
                                      <span class="s2">&quot;from </span><span class="si">{}</span><span class="s2">, trying next device.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
                <span class="k">continue</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to save a household diag from devices &quot;</span>
                              <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zps</span><span class="p">))</span>
    <span class="n">outcome</span> <span class="o">=</span> <span class="k">yield</span>
    <span class="n">rep</span> <span class="o">=</span> <span class="n">outcome</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rep</span><span class="o">.</span><span class="n">failed</span> <span class="ow">and</span> <span class="s1">&#39;all_devices&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">funcargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">save_diag_on_error</span><span class="p">:</span>
            <span class="n">collect_testbed_diag</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">funcargs</span><span class="p">[</span><span class="s1">&#39;all_devices&#39;</span><span class="p">],</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="player_in_forced_bluetooth_mode_setUp"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.player_in_forced_bluetooth_mode_setUp">[docs]</a><span class="k">def</span> <span class="nf">player_in_forced_bluetooth_mode_setUp</span><span class="p">(</span><span class="n">zp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up a player into forced BT mode - enabling Bluetooth while wired.</span>

<span class="sd">    :param zp: zone player to allow BT while wired on.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># we must be wired for this configuration</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_in_sonosnet_mode</span><span class="p">():</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">wire</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">wait_for_sonosnet_mode</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">bt_mgr</span><span class="o">.</span><span class="n">is_bt_attach_btc_running</span><span class="p">():</span>
        <span class="n">bmli</span> <span class="o">=</span> <span class="n">BluetoothManagerLogInspector</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">clear_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Enabling Bluetooth mode while wired on player: &quot;</span>
                           <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_enable_bt_while_wired</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">wait_for_bluetooth_mode</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">bmli</span><span class="p">)</span></div>


<div class="viewcode-block" id="player_in_forced_bluetooth_mode_tearDown"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.player_in_forced_bluetooth_mode_tearDown">[docs]</a><span class="k">def</span> <span class="nf">player_in_forced_bluetooth_mode_tearDown</span><span class="p">(</span><span class="n">zp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tear down player that was allowing Bluetooth while wired</span>

<span class="sd">    :param zp: zone player to clean up</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_enable_bt_while_wired</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">wait_until_true</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">bt_mgr</span><span class="o">.</span><span class="n">is_bt_attach_btc_running</span><span class="p">(),</span>
        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for BT Classic to disengage&quot;</span><span class="p">)</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">wait_for_upnp_alive</span><span class="p">()</span></div>


<div class="viewcode-block" id="a_player_in_forced_bluetooth_mode"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.a_player_in_forced_bluetooth_mode">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_player_in_forced_bluetooth_mode</span><span class="p">(</span><span class="n">a_bt_capable_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This fixture yields a Bluetooth capable player forced into Bluetooth</span>
<span class="sd">    mode. The player is &quot;forced&quot; into Bluetooth mode so that we can still</span>
<span class="sd">    have network access to it over the wired connection. This enables us to</span>
<span class="sd">    take audiotaps while playing Bluetooth audio and also to run the test</span>
<span class="sd">    without access to a serial server or managed switch or AP.</span>

<span class="sd">    :param a_bt_capable_device: any random Bluetooth capable player</span>
<span class="sd">    :return: any random Bluetooth capable player already in Bluetooth mode</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span> <span class="o">=</span> <span class="n">a_bt_capable_device</span>
    <span class="n">player_in_forced_bluetooth_mode_setUp</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">zp</span>
    <span class="n">player_in_forced_bluetooth_mode_tearDown</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span></div>


<div class="viewcode-block" id="player_in_forced_bluetooth_mode"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.player_in_forced_bluetooth_mode">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">player_in_forced_bluetooth_mode</span><span class="p">(</span><span class="n">bt_capable_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This fixture yields a Bluetooth capable player forced into Bluetooth</span>
<span class="sd">    mode. The player is &quot;forced&quot; into Bluetooth mode so that we can still</span>
<span class="sd">    have network access to it over the wired connection. This enables us to</span>
<span class="sd">    take audiotaps while playing Bluetooth audio and also to run the test</span>
<span class="sd">    without access to a serial server or managed switch or AP.</span>

<span class="sd">    :param bt_capable_device: each Bluetooth capable player</span>
<span class="sd">    :return: each Bluetooth capable player already in Bluetooth mode</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span> <span class="o">=</span> <span class="n">bt_capable_device</span>
    <span class="n">player_in_forced_bluetooth_mode_setUp</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">zp</span>
    <span class="n">player_in_forced_bluetooth_mode_tearDown</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span></div>


<div class="viewcode-block" id="wait_for_bluetooth_mode"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.wait_for_bluetooth_mode">[docs]</a><span class="k">def</span> <span class="nf">wait_for_bluetooth_mode</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">bmli</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wait for the given zone player to show</span>

<span class="sd">    :param zp: zone player to wait to transition to bt mode</span>
<span class="sd">    :param bmli: `BluetoothManagerLogInspector` object that&#39;s already</span>
<span class="sd">        cleared the log for the zp passed in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for player to come up in Bluetooth mode&quot;</span><span class="p">)</span>
    <span class="n">anacapa_connect_msg</span> <span class="o">=</span> <span class="s1">&#39;\[BTC\] Received hello message from Anacapa&#39;</span>
    <span class="n">bt_ready_msg</span> <span class="o">=</span> <span class="s1">&#39;\[BTC\] BT Classic ready \([0-9]* attempts\)&#39;</span>

    <span class="n">pytest</span><span class="o">.</span><span class="n">wait_for_assert</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">bmli</span><span class="o">.</span><span class="n">go_to_last_occurrence</span><span class="p">(</span><span class="n">anacapa_connect_msg</span><span class="p">),</span>
        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Waiting to see message </span><span class="si">{}</span><span class="s2"> in log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">anacapa_connect_msg</span><span class="p">))</span>

    <span class="n">pytest</span><span class="o">.</span><span class="n">wait_for_assert</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">bmli</span><span class="o">.</span><span class="n">go_to_last_occurrence</span><span class="p">(</span><span class="n">bt_ready_msg</span><span class="p">),</span>
        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Waiting to see message </span><span class="si">{}</span><span class="s2"> in log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bt_ready_msg</span><span class="p">))</span>

    <span class="n">pytest</span><span class="o">.</span><span class="n">wait_for_assert</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">bt_mgr</span><span class="o">.</span><span class="n">is_bt_attach_btc_running</span><span class="p">(),</span>
        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Waiting for BTC Attach to come up. ps: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;ps&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="apply_dual_mono_mode"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.apply_dual_mono_mode">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">apply_dual_mono_mode</span><span class="p">(</span><span class="n">dual_mono_mode_capable_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enable mono mode on.</span>

<span class="sd">    Requires OAUTH_USER, OUATH_PW and MITC_ENVIRONMENT environment to be set.</span>
<span class="sd">    If MITC_ENVIRONMENT is not set, it assumes &#39;test&#39;.</span>

<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection</span>
<span class="sd">    .all_dual_mono_mode_capable_devices`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ps_dut</span> <span class="o">=</span> <span class="n">PlayerSettingsHelper</span><span class="p">(</span><span class="n">dual_mono_mode_capable_device</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ps_dut</span><span class="o">.</span><span class="n">set_dual_mono_mode</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">dual_mono_mode_capable_device</span>
    <span class="k">assert</span> <span class="n">ps_dut</span><span class="o">.</span><span class="n">set_dual_mono_mode</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="apply_trueplay_to_players"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.apply_trueplay_to_players">[docs]</a><span class="k">def</span> <span class="nf">apply_trueplay_to_players</span><span class="p">(</span><span class="n">zps</span><span class="p">,</span> <span class="n">admin_oauth_token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply Trueplay to all given players</span>

<span class="sd">    :param zps: zone players to apply Trueplay to</span>
<span class="sd">    :param admin_oauth_token: needs to be a token of HH_CONFIG_ADMIN type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">in</span> <span class="n">SELF_TRUEPLAY_CAPABLE_MODELS</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">muse_rest</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setSelfTruePlay</span><span class="p">(</span><span class="n">admin_oauth_token</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">in</span> <span class="n">TRUEPLAY_CAPABLE_MODELS</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">apply_trueplay_to_player</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="remove_trueplay_from_players"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.remove_trueplay_from_players">[docs]</a><span class="k">def</span> <span class="nf">remove_trueplay_from_players</span><span class="p">(</span><span class="n">zps</span><span class="p">,</span> <span class="n">admin_oauth_token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove Trueplay from all given players</span>

<span class="sd">    :param zps: zone players to apply Trueplay to</span>
<span class="sd">    :param admin_oauth_token: needs to be a token of HH_CONFIG_ADMIN type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">in</span> <span class="n">SELF_TRUEPLAY_CAPABLE_MODELS</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">muse_rest</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setSelfTruePlay</span><span class="p">(</span><span class="n">admin_oauth_token</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">in</span> <span class="n">TRUEPLAY_CAPABLE_MODELS</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">remove_trueplay</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="conditionally_trueplay_all_players_for_session"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.conditionally_trueplay_all_players_for_session">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">conditionally_trueplay_all_players_for_session</span><span class="p">(</span>
        <span class="n">all_devices</span><span class="p">,</span> <span class="n">conditionally_remove_trueplay_from_players_for_session</span><span class="p">,</span>
        <span class="n">hh_config_admin_oauth_token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixture to load the trueplay coefficients onto all capable players prior</span>
<span class="sd">    to any tests. This executes at the start of the test session and will</span>
<span class="sd">    cleanup at the end.</span>

<span class="sd">    NOTE: &quot;--apply_trueplay&quot; must be included in the pytest arguments in</span>
<span class="sd">        order for this fixture to actually engage.</span>
<span class="sd">    NOTE: this will be undone if any bonding follows this fixture&#39;s setup.</span>

<span class="sd">    :param list all_devices: list of all players on the test bed</span>
<span class="sd">    :param conditionally_remove_trueplay_from_players_for_session: fixture to</span>
<span class="sd">        remove all trueplay coefficients at the end of the test session</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pytest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;apply_trueplay&quot;</span><span class="p">):</span>
        <span class="n">apply_trueplay_to_players</span><span class="p">(</span><span class="n">all_devices</span><span class="p">,</span> <span class="n">hh_config_admin_oauth_token</span><span class="p">)</span>
    <span class="k">yield</span></div>


<div class="viewcode-block" id="conditionally_trueplay_all_players_for_function"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.conditionally_trueplay_all_players_for_function">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">conditionally_trueplay_all_players_for_function</span><span class="p">(</span>
        <span class="n">all_devices</span><span class="p">,</span> <span class="n">conditionally_remove_trueplay_from_players_for_function</span><span class="p">,</span>
        <span class="n">hh_config_admin_oauth_token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixture to load the trueplay coefficients onto all capable players prior</span>
<span class="sd">    to any tests. This executes at the start of each test function.</span>

<span class="sd">    NOTE: this will NOT clean up after itself. It&#39;s recommended to use the</span>
<span class="sd">    remove_trueplay_from_players fixture, which is session scoped,</span>
<span class="sd">    in conjunction with this so that it&#39;s assured that the trueplay files</span>
<span class="sd">    are removed at the end of the test. The reasoning is that it requires</span>
<span class="sd">    an anacapa bounce on each player, which is time consuming.</span>

<span class="sd">    NOTE: &quot;--apply_trueplay&quot; must be included in the pytest arguments in</span>
<span class="sd">        order for this fixture to actually engage.</span>
<span class="sd">    NOTE: this will be undone if any bonding follows this fixture&#39;s setup.</span>

<span class="sd">    :param list all_devices: list of all players on the test bed</span>
<span class="sd">    :param conditionally_remove_trueplay_from_players_for_function: fixture to</span>
<span class="sd">        remove all trueplay coefficients at the end of the test session</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pytest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;apply_trueplay&quot;</span><span class="p">):</span>
        <span class="n">apply_trueplay_to_players</span><span class="p">(</span><span class="n">all_devices</span><span class="p">,</span> <span class="n">hh_config_admin_oauth_token</span><span class="p">)</span>
    <span class="k">yield</span></div>


<div class="viewcode-block" id="conditionally_remove_trueplay_from_players_for_session"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.conditionally_remove_trueplay_from_players_for_session">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">conditionally_remove_trueplay_from_players_for_session</span><span class="p">(</span>
        <span class="n">all_devices</span><span class="p">,</span> <span class="n">hh_config_admin_oauth_token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixture to remove the trueplay coefficients from all capable players</span>
<span class="sd">    after all tests.</span>

<span class="sd">    :param list all_devices: list of all players on the test bed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">yield</span>
    <span class="k">if</span> <span class="n">pytest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;apply_trueplay&quot;</span><span class="p">):</span>
        <span class="n">remove_trueplay_from_players</span><span class="p">(</span><span class="n">all_devices</span><span class="p">,</span> <span class="n">hh_config_admin_oauth_token</span><span class="p">)</span></div>


<div class="viewcode-block" id="conditionally_remove_trueplay_from_players_for_function"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.conditionally_remove_trueplay_from_players_for_function">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">conditionally_remove_trueplay_from_players_for_function</span><span class="p">(</span>
        <span class="n">all_devices</span><span class="p">,</span> <span class="n">hh_config_admin_oauth_token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixture to remove the trueplay coefficients from all capable players</span>
<span class="sd">    after a test.</span>

<span class="sd">    :param list all_devices: list of all players on the test bed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">yield</span>
    <span class="k">if</span> <span class="n">pytest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;apply_trueplay&quot;</span><span class="p">):</span>
        <span class="n">remove_trueplay_from_players</span><span class="p">(</span><span class="n">all_devices</span><span class="p">,</span> <span class="n">hh_config_admin_oauth_token</span><span class="p">)</span></div>


<span class="c1"># -----------------------------</span>
<span class="c1"># |PnP-Player created fixtures|</span>
<span class="c1"># -----------------------------</span>

<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">pytest_automation.player.common</span> <span class="k">as</span> <span class="nn">player_common</span>
<span class="kn">from</span> <span class="nn">webserver.helpers.cloud_queue_control</span> <span class="k">import</span> <span class="n">CloudQueueControl</span>
<span class="kn">from</span> <span class="nn">sonos.client.zp_logger</span> <span class="k">import</span> <span class="n">ZpLogger</span>
<span class="kn">from</span> <span class="nn">sonos.client.muse_platform_api.generated.muse_events</span> <span class="k">import</span> \
    <span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">MuseSuccessEvent</span><span class="p">,</span> \
    <span class="n">PlayerVolumeEvent</span><span class="p">,</span> <span class="n">GroupsEvent</span>
<span class="kn">from</span> <span class="nn">sonos.client.muse_platform_api.websocket_manager</span> <span class="k">import</span> <span class="n">ws_manager</span>
<span class="kn">from</span> <span class="nn">sonos.client.muse_platform_api.device_manager</span> <span class="k">import</span> <span class="n">device_manager</span>
<span class="kn">from</span> <span class="nn">sonos.cloud.oauth_server</span> <span class="k">import</span> <span class="n">Scopes</span>
<span class="kn">from</span> <span class="nn">sonos.client.muse_platform_api.muse_event_enums</span> <span class="k">import</span> <span class="n">PlaybackState</span>
<span class="kn">from</span> <span class="nn">sonos.client.zone_player</span> <span class="k">import</span> <span class="n">PLAYBACK_DEVICES</span>


<div class="viewcode-block" id="hh_config_oauth_token"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.hh_config_oauth_token">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hh_config_oauth_token</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a hh_config scoped oauth token</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">player_common</span><span class="o">.</span><span class="n">get_scoped_oauth_token</span><span class="p">(</span><span class="n">Scopes</span><span class="o">.</span><span class="n">AS_HH_CONFIG</span><span class="p">)</span></div>


<div class="viewcode-block" id="hh_config_admin_oauth_token"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.hh_config_admin_oauth_token">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hh_config_admin_oauth_token</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a hh_config_admin scoped oauth token</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">player_common</span><span class="o">.</span><span class="n">get_scoped_oauth_token</span><span class="p">(</span><span class="n">Scopes</span><span class="o">.</span><span class="n">AS_HH_CONFIG_ADMIN</span><span class="p">)</span></div>


<div class="viewcode-block" id="mock_cq_control"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.mock_cq_control">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mock_cq_control</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Init the CloudQueueControl class</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">CloudQueueControl</span><span class="p">()</span></div>


<div class="viewcode-block" id="dut_manager"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.dut_manager">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dut_manager</span><span class="p">(</span><span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Init the device_manager class with all_devices from the device_selection plugin</span>
<span class="sd">    and perform some cleanup</span>
<span class="sd">    :param all_devices:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">device_manager</span><span class="p">(</span><span class="n">all_devices</span><span class="p">)</span>

    <span class="n">manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">manager</span>

    <span class="n">manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span></div>


<div class="viewcode-block" id="websocket_manager"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.websocket_manager">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">websocket_manager</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Init the ws_manager class and perform some cleanup</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ws_manager</span><span class="p">()</span>

    <span class="n">manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">manager</span>

    <span class="n">manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_module_dut"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.get_module_dut">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_module_dut</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">dut_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Module-scoped device selection fixture.</span>
<span class="sd">    If a module attribute &quot;MODULE_DEVICE_FILTER&quot; is found in the requesting test file, it will use that for a</span>
<span class="sd">    filter. Otherwise, it will just randomly select a device.</span>
<span class="sd">    :param request:</span>
<span class="sd">    :param dut_manager:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;MODULE_DEVICE_FILTER&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">get_primary_dut</span><span class="p">(</span><span class="n">device_filter</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">MODULE_DEVICE_FILTER</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">get_primary_dut</span><span class="p">(</span><span class="n">device_filter</span><span class="o">=</span><span class="n">PLAYBACK_DEVICES</span><span class="p">,</span> <span class="n">fail_on_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="module_dut"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.module_dut">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">module_dut</span><span class="p">(</span><span class="n">get_module_dut</span><span class="p">,</span> <span class="n">reset_dut_and_ws_managers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides a module scoped dut, but cleans test devices up after each function via reset_dut_and_ws_managers</span>

<span class="sd">    :param get_module_dut:</span>
<span class="sd">    :param reset_dut_and_ws_managers:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_module_dut</span></div>


<div class="viewcode-block" id="get_class_dut"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.get_class_dut">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_class_dut</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">dut_manager</span><span class="p">,</span> <span class="n">websocket_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class-scoped device selection fixture. This fixture is intended for use cases where a constant config (bonding,</span>
<span class="sd">    grouping, etc) is needed.</span>

<span class="sd">    If an indirect parameter is given, it will use that for a filter. Otherwise, it will just randomly select a device.</span>
<span class="sd">    :param request:</span>
<span class="sd">    :param dut_manager:</span>
<span class="sd">    :param websocket_manager:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># To optionally supply a device filter, add these lines above the CLASS definition</span>
    <span class="c1"># @pytest.mark.usefixtures(&quot;class_dut&quot;)</span>
    <span class="c1"># @pytest.mark.parametrize(&quot;class_dut&quot;, [PLAYBACK_DEVICES], indirect=True, scope=&quot;class&quot;)</span>
    <span class="c1"># class TestMyThing(object):</span>
    <span class="c1">#     def test_thing(self, class_dut):</span>
    <span class="c1">#         ...</span>
    <span class="n">device_filter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">PLAYBACK_DEVICES</span>

    <span class="c1"># Get the DUT that was just used</span>
    <span class="n">zp</span> <span class="o">=</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span>

    <span class="c1"># Reset both managers</span>
    <span class="n">websocket_manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span>
    <span class="n">dut_manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">get_primary_dut</span><span class="p">(</span><span class="n">device_filter</span><span class="o">=</span><span class="n">device_filter</span><span class="p">)</span>

    <span class="c1"># Reset both managers again as cleanup</span>
    <span class="n">websocket_manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span>
    <span class="n">dut_manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">zp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span> <span class="o">=</span> <span class="n">zp</span>
        <span class="n">dut_manager</span><span class="o">.</span><span class="n">test_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span><span class="p">]</span></div>


<div class="viewcode-block" id="class_dut"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.class_dut">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">class_dut</span><span class="p">(</span><span class="n">dut_manager</span><span class="p">,</span> <span class="n">get_class_dut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides a class scoped dut. This fixture is intended for use cases where a constant config (bonding, grouping, etc)</span>
<span class="sd">    is needed. For that reason IT DOES NOT cleanup the test devices after every test, and it is highly</span>
<span class="sd">    discouraged to use `function_dut` and `module_dut` in the same class as `class_dut`</span>

<span class="sd">    :param get_class_dut:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># To optionally supply a device filter, add these lines above the CLASS definition</span>
    <span class="c1"># @pytest.mark.usefixtures(&quot;get_class_dut&quot;)</span>
    <span class="c1"># @pytest.mark.parametrize(&quot;get_class_dut&quot;, [PLAYBACK_DEVICES], indirect=True, scope=&quot;class&quot;)</span>
    <span class="c1"># class TestMyThing(object):</span>
    <span class="c1">#     def test_thing(self, class_dut):</span>
    <span class="c1">#         ...</span>

    <span class="c1"># Cleanup state but not grouping/bonding</span>
    <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp_cleanup_all_test_devices</span><span class="p">(</span><span class="n">unbond</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ungroup</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">get_class_dut</span>

    <span class="c1"># Cleanup state but not grouping/bonding</span>
    <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp_cleanup_all_test_devices</span><span class="p">(</span><span class="n">unbond</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ungroup</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="init_mpsc"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.init_mpsc">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">init_mpsc</span><span class="p">(</span><span class="n">all_playback_devices</span><span class="p">,</span> <span class="n">dut_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overview of this module-scoped fixture setup/teardown:</span>
<span class="sd">    1. Module setup, initialize the mock services server, yield the object to downstream fixtures</span>
<span class="sd">    2. Module teardown, cleanup overrides on each player that has overrides, shutdown the mock server</span>
<span class="sd">    Module-scoped due to fear that leaving the server/overrides active across an entire session</span>
<span class="sd">    could lead to unexpected test issues. We&#39;ll lose some time re-init if multiple modules across a</span>
<span class="sd">    session all use the mock services server but this way is safer.</span>
<span class="sd">    :param all_playback_devices:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">MockPlayerCloudServicesControl</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">mpsc</span>

    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">test_devices</span><span class="p">:</span>
        <span class="n">lechmere_helpers</span><span class="o">.</span><span class="n">cleanup_player_overrides</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>

    <span class="n">mpsc</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>


<div class="viewcode-block" id="mock_hh_config_admin_oauth_token"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.mock_hh_config_admin_oauth_token">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mock_hh_config_admin_oauth_token</span><span class="p">(</span><span class="n">a_playback_device</span><span class="p">,</span> <span class="n">init_mpsc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a hh_config_admin token from the mock player services server.</span>
<span class="sd">    ZPs that use the mock services server can&#39;t validate tokens from the real cloud services,</span>
<span class="sd">    only ones generated from the mock.</span>
<span class="sd">    :param init_mpsc:</span>
<span class="sd">    :param a_playback_device:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">a_playback_device</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">customer_id</span>
    <span class="k">return</span> <span class="n">init_mpsc</span><span class="o">.</span><span class="n">create_user_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">Scopes</span><span class="o">.</span><span class="n">AS_HH_CONFIG_ADMIN</span><span class="o">.</span><span class="n">string</span><span class="p">)</span></div>


<div class="viewcode-block" id="mock_player_services_control"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.mock_player_services_control">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mock_player_services_control</span><span class="p">(</span><span class="n">init_mpsc</span><span class="p">,</span> <span class="n">dut_manager</span><span class="p">,</span> <span class="n">config_properties</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start mock lechmere control on the</span>
<span class="sd">    :func:`~pytest_automation.player.conftest.device_selection`,</span>
<span class="sd">    with parameterized config_properties.</span>

<span class="sd">    :return: a MockPlayerCloudServicesControl instance</span>
<span class="sd">    :rtype:</span>
<span class="sd">        :class:`~webserver.helpers.mock_player_cloud_services_control.MockPlayerCloudServicesControl`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lechmere_helpers</span><span class="o">.</span><span class="n">startup_and_connect_lechmere</span><span class="p">(</span><span class="n">init_mpsc</span><span class="p">,</span>
                                                  <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">config_properties</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">init_mpsc</span></div>


<div class="viewcode-block" id="function_dut"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.function_dut">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">function_dut</span><span class="p">(</span><span class="n">dut_manager</span><span class="p">,</span> <span class="n">device_filter</span><span class="p">,</span> <span class="n">reset_dut_and_ws_managers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function-scoped device selection fixture.</span>
<span class="sd">    Use this one if your test cases need a specific ZP dut,</span>
<span class="sd">     defined by the device_filter param passed in by the test case</span>
<span class="sd">    :param dut_manager:</span>
<span class="sd">    :param device_filter:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">get_primary_dut</span><span class="p">(</span><span class="n">device_filter</span><span class="o">=</span><span class="n">device_filter</span><span class="p">,</span> <span class="n">fail_on_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="ws_client"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.ws_client">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ws_client</span><span class="p">(</span><span class="n">dut_manager</span><span class="p">,</span> <span class="n">websocket_manager</span><span class="p">,</span> <span class="n">cleanup_websocket_connections</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make ws connection to test case DUT</span>
<span class="sd">    :param dut_manager:</span>
<span class="sd">    :param websocket_manager:</span>
<span class="sd">    :param cleanup_websocket_connections:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make a ws connection to dut_manager.zp, which is the test case&#39;s dut</span>
    <span class="k">return</span> <span class="n">websocket_manager</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span></div>


<div class="viewcode-block" id="cleanup_websocket_connections"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.cleanup_websocket_connections">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cleanup_websocket_connections</span><span class="p">(</span><span class="n">dut_manager</span><span class="p">,</span> <span class="n">websocket_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Close all ws connections associated with all zps in dut_manager.test_devices</span>
<span class="sd">    :param dut_manager:</span>
<span class="sd">    :param websocket_manager:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">websocket_manager</span><span class="o">.</span><span class="n">disconnect_all_for_all_zps</span><span class="p">()</span>

    <span class="k">yield</span>

    <span class="n">websocket_manager</span><span class="o">.</span><span class="n">disconnect_all_for_all_zps</span><span class="p">()</span></div>


<div class="viewcode-block" id="mock_cq_server"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.mock_cq_server">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mock_cq_server</span><span class="p">(</span><span class="n">mock_cq_control</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start/stop the mock cq server</span>
<span class="sd">    :param mock_cq_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Start the mock cq server</span>
    <span class="n">cq</span> <span class="o">=</span> <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="n">mock_cq_control</span><span class="o">.</span><span class="n">host_port</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">mock_cq_control</span>

    <span class="c1"># Close/cleanup the mock cq server</span>
    <span class="c1"># Increment the next cq server port for /timePlayed reporting purposes</span>
    <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">host_port</span> <span class="o">=</span> <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">host_port</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">(</span><span class="n">cq</span><span class="p">)</span>
    <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">delete_all_logs</span><span class="p">()</span></div>


<div class="viewcode-block" id="mock_cq_server_with_library"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.mock_cq_server_with_library">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mock_cq_server_with_library</span><span class="p">(</span><span class="n">mock_cq_control</span><span class="p">,</span> <span class="n">library_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start/stop the mock cq server</span>
<span class="sd">    :param mock_cq_control:</span>
<span class="sd">    :param library_path:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Start the mock cq server</span>
    <span class="n">cq</span> <span class="o">=</span> <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="n">mock_cq_control</span><span class="o">.</span><span class="n">host_port</span><span class="p">,</span> <span class="n">library_path</span><span class="o">=</span><span class="n">library_path</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">mock_cq_control</span>

    <span class="c1"># Close/cleanup the mock cq server</span>
    <span class="c1"># Increment the next cq server port for /timePlayed reporting purposes</span>
    <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">host_port</span> <span class="o">=</span> <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">host_port</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">(</span><span class="n">cq</span><span class="p">)</span>
    <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">delete_all_logs</span><span class="p">()</span></div>


<div class="viewcode-block" id="mock_cq_server_module"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.mock_cq_server_module">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mock_cq_server_module</span><span class="p">(</span><span class="n">mock_cq_control</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start/stop the mock cq server at the module-scope level</span>
<span class="sd">    :param mock_cq_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Start the mock cq server</span>
    <span class="n">cq</span> <span class="o">=</span> <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="n">mock_cq_control</span><span class="o">.</span><span class="n">host_port</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">mock_cq_control</span>

    <span class="c1"># Close/cleanup the mock cq server</span>
    <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">(</span><span class="n">cq</span><span class="p">)</span>
    <span class="n">mock_cq_control</span><span class="o">.</span><span class="n">delete_all_logs</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_muse_session"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.create_muse_session">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_muse_session</span><span class="p">(</span><span class="n">ws_client</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a muse session via the ws_connection</span>
<span class="sd">    :param ws_client:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ws_client</span><span class="o">.</span><span class="n">playbackSession</span><span class="o">.</span><span class="n">createSession</span><span class="p">(</span><span class="n">appId</span><span class="o">=</span><span class="s2">&quot;APP_ID&quot;</span><span class="p">,</span> <span class="n">appContext</span><span class="o">=</span><span class="s2">&quot;APP_CONTEXT&quot;</span><span class="p">)</span>
    <span class="n">ws_client</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;sessionState&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SESSION_STATE_CONNECTED&quot;</span><span class="p">,</span>
                           <span class="n">eventType</span><span class="o">=</span><span class="n">SessionStatusEvent</span><span class="p">)</span>

    <span class="c1"># Subscribe to the playback namespace to get async playback events from zp</span>
    <span class="n">ws_client</span><span class="o">.</span><span class="n">playback</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>
    <span class="n">ws_client</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;playbackState&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">eventType</span><span class="o">=</span><span class="n">PlaybackStatusEvent</span><span class="p">)</span></div>


<div class="viewcode-block" id="reset_dut_and_ws_managers"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.reset_dut_and_ws_managers">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reset_dut_and_ws_managers</span><span class="p">(</span><span class="n">dut_manager</span><span class="p">,</span> <span class="n">websocket_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reset dut and websocket managers. Keep whatever is currently in dut_manager.zp</span>
<span class="sd">    so that downstream fixtures/test cases will have a dut to use</span>
<span class="sd">    :param dut_manager:</span>
<span class="sd">    :param websocket_manager:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the DUT that was just used</span>
    <span class="n">zp</span> <span class="o">=</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span>

    <span class="c1"># Reset both managers</span>
    <span class="n">websocket_manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span>
    <span class="n">dut_manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span>

    <span class="c1"># Set the DUT back to the last one that was used so that the next test case has a DUT set</span>
    <span class="k">if</span> <span class="n">zp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span> <span class="o">=</span> <span class="n">zp</span>
        <span class="n">dut_manager</span><span class="o">.</span><span class="n">test_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span><span class="p">]</span>

    <span class="k">yield</span>

    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">test_devices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">loggers</span><span class="p">:</span>
            <span class="n">dut_manager</span><span class="o">.</span><span class="n">loggers</span><span class="p">[</span><span class="n">device</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;PRIMARY&quot;</span> <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span> <span class="k">else</span> <span class="s2">&quot;SECONDARY&quot;</span>

    <span class="c1"># Reset both managers again as cleanup</span>
    <span class="n">websocket_manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span>
    <span class="n">dut_manager</span><span class="o">.</span><span class="n">reset_manager</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">zp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span> <span class="o">=</span> <span class="n">zp</span>
        <span class="n">dut_manager</span><span class="o">.</span><span class="n">test_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span><span class="p">]</span></div>


<div class="viewcode-block" id="set_initial_volume"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.set_initial_volume">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_initial_volume</span><span class="p">(</span><span class="n">ws_client</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subscribe to player volume, unmute and set volume to 10 using the</span>
<span class="sd">    :param ws_client:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ws_client</span><span class="o">.</span><span class="n">playerVolume</span><span class="o">.</span><span class="n">setVolume</span><span class="p">(</span><span class="n">volume</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">muted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ws_client</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;setVolume&quot;</span><span class="p">,</span>
                           <span class="n">eventType</span><span class="o">=</span><span class="n">MuseSuccessEvent</span><span class="p">)</span>

    <span class="n">ws_client</span><span class="o">.</span><span class="n">playerVolume</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>
    <span class="n">ws_client</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;muted&quot;</span><span class="p">],</span>
                           <span class="n">eventType</span><span class="o">=</span><span class="n">PlayerVolumeEvent</span><span class="p">)</span>

    <span class="k">yield</span>

    <span class="n">ws_client</span><span class="o">.</span><span class="n">playerVolume</span><span class="o">.</span><span class="n">setVolume</span><span class="p">(</span><span class="n">volume</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">muted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ws_client</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;setVolume&quot;</span><span class="p">,</span>
                           <span class="n">eventType</span><span class="o">=</span><span class="n">MuseSuccessEvent</span><span class="p">)</span></div>


<div class="viewcode-block" id="mock_smapi_server_control"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.mock_smapi_server_control">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mock_smapi_server_control</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Init the NodeSmapiControl class</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mssc</span> <span class="o">=</span> <span class="n">NodeSmapiControl</span><span class="p">()</span>
    <span class="n">mssc</span><span class="o">.</span><span class="n">sid_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">254</span><span class="p">)</span>
    <span class="n">mssc</span><span class="o">.</span><span class="n">sid_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">mssc</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mssc</span><span class="o">.</span><span class="n">smapi_port</span> <span class="o">=</span> <span class="mi">3200</span>
    <span class="n">mssc</span><span class="o">.</span><span class="n">SMAPI_SERVER_CAPS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;logging&#39;</span><span class="p">,</span> <span class="s1">&#39;playbackLogging&#39;</span><span class="p">,</span> <span class="s1">&#39;extendedMD&#39;</span><span class="p">,</span> <span class="s1">&#39;userInfo&#39;</span><span class="p">,</span> <span class="s1">&#39;manifest&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mssc</span></div>


<div class="viewcode-block" id="mock_smapi_server_manager"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.mock_smapi_server_manager">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mock_smapi_server_manager</span><span class="p">(</span><span class="n">mock_smapi_server_control</span><span class="p">,</span> <span class="n">mock_cq_server</span><span class="p">,</span> <span class="n">extra_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup the mock smapi node server</span>
<span class="sd">    :param: mock_smapi_server_control</span>
<span class="sd">    :param: mock_cq_server</span>
<span class="sd">    :param: extra_path</span>
<span class="sd">    :return: a mock SMAPI node server</span>
<span class="sd">    :rtype: :class:`~webserver.helpers.node_smapi_control.NodeSmapiControl`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Start the mock smapi node server</span>
    <span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">sid_range</span><span class="p">[</span><span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">sid_count</span><span class="p">]</span>
    <span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">smapi</span> <span class="o">=</span> <span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">start_node_smapi_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                                                        <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                                                        <span class="n">extra_path</span><span class="o">=</span><span class="n">extra_path</span><span class="p">,</span>
                                                                                        <span class="n">server_port</span><span class="o">=</span><span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">smapi_port</span><span class="p">,</span>
                                                                                        <span class="n">server_internal_id</span><span class="o">=</span><span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">get_account_type</span><span class="p">(</span>
                                                                                            <span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                                                                                        <span class="n">server_sid</span><span class="o">=</span><span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span>
                                                                                        <span class="n">cqport</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                                            <span class="n">mock_cq_server</span><span class="o">.</span><span class="n">host_ip</span><span class="p">,</span>
                                                                                            <span class="n">mock_cq_server</span><span class="o">.</span><span class="n">host_port</span><span class="p">))</span>

    <span class="k">yield</span> <span class="n">mock_smapi_server_control</span>

    <span class="c1"># Increment the smapi sid/port so that each test case uses a different value then the previous case</span>
    <span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">smapi_port</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Shutdown the server</span>
    <span class="k">if</span> <span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">smapi</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">stop_node_smapi_server</span><span class="p">(</span><span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">smapi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">sid_range</span><span class="p">):</span>
        <span class="n">mock_smapi_server_control</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="smapi_account_setup"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.smapi_account_setup">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">smapi_account_setup</span><span class="p">(</span><span class="n">dut_manager</span><span class="p">,</span> <span class="n">mock_smapi_server_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the smapi service and account to the ZP</span>
<span class="sd">    :param: dut_manager</span>
<span class="sd">    :param: mock_smapi_server_manager</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Add the account</span>
    <span class="k">assert</span> <span class="n">mock_smapi_server_manager</span><span class="o">.</span><span class="n">smapi_account_setup</span><span class="p">(</span><span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">mock_smapi_server_manager</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span>
                                                         <span class="n">caps</span><span class="o">=</span><span class="n">mock_smapi_server_manager</span><span class="o">.</span><span class="n">SMAPI_SERVER_CAPS</span><span class="p">),</span> <span class="s2">&quot;Successfully added SMAPI account?&quot;</span>

    <span class="k">yield</span>

    <span class="c1"># Cleanup the account</span>
    <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">remove_all_service_accounts</span><span class="p">()</span></div>


<div class="viewcode-block" id="subscribe_groups"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.subscribe_groups">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">subscribe_groups</span><span class="p">(</span><span class="n">ws_client</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subscribe to the groups namespace and consume the initial event</span>
<span class="sd">    :param ws_client:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ws_client</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>
    <span class="n">ws_client</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">(</span><span class="n">eventType</span><span class="o">=</span><span class="n">GroupsEvent</span><span class="p">)</span></div>


<div class="viewcode-block" id="groups_in_hh"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.groups_in_hh">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">groups_in_hh</span><span class="p">(</span><span class="n">ws_client</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the number of groups in the household of the zp</span>
<span class="sd">    :param ws_client:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ws_client</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">getGroups</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">ws_client</span><span class="o">.</span><span class="n">waitForEvent</span><span class="p">(</span><span class="n">eventType</span><span class="o">=</span><span class="n">GroupsEvent</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_player_logs"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.print_player_logs">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">print_player_logs</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">dut_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    On failure, prints and cleans up logs for all players used in the test. Also checks for backtraces on the bed</span>
<span class="sd">    :param request:</span>
<span class="sd">    :param dut_manager:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># User can add to the defaults by specifying a module attribute:</span>
    <span class="c1">#    ADDITIONAL_LOGS = [ Logs.Airplay, etc ... ]</span>
    <span class="n">logs_to_print</span> <span class="o">=</span> <span class="p">[</span><span class="n">Logs</span><span class="o">.</span><span class="n">ANACAPA</span><span class="p">,</span> <span class="n">Logs</span><span class="o">.</span><span class="n">PERF</span><span class="p">,</span> <span class="n">Logs</span><span class="o">.</span><span class="n">BACKTRACE</span><span class="p">]</span>  <span class="c1"># Print these by default</span>

    <span class="c1"># Module scopes will not start on their own since they are only called once</span>
    <span class="k">if</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">test_devices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">test_devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">loggers</span><span class="p">:</span>
                <span class="n">dut_manager</span><span class="o">.</span><span class="n">loggers</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span><span class="o">.</span><span class="n">init_all</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dut_manager</span><span class="o">.</span><span class="n">add_logging</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>

    <span class="k">yield</span>

    <span class="c1"># Check if use specified more logs to print</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;ADDITIONAL_LOGS&quot;</span><span class="p">):</span>
        <span class="n">logs_to_print</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">ADDITIONAL_LOGS</span><span class="p">)</span>
        <span class="n">logs_to_print</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">logs_to_print</span><span class="p">))</span>  <span class="c1"># Filter dupes</span>

    <span class="n">backtraces</span> <span class="o">=</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">check_backtraces</span><span class="p">()</span>
    <span class="n">watchdogs</span> <span class="o">=</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">check_watchdogs</span><span class="p">()</span>
    <span class="n">test_failed</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">rep_setup</span><span class="o">.</span><span class="n">failed</span> <span class="ow">or</span>
                   <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;rep_call&quot;</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">rep_call</span><span class="o">.</span><span class="n">failed</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">test_failed</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">backtraces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dut_manager</span><span class="o">.</span><span class="n">print_logs</span><span class="p">(</span><span class="n">logs_to_print</span><span class="o">=</span><span class="n">logs_to_print</span><span class="p">,</span> <span class="n">cleanup_after_print</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">backtraces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">backtraces</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Backtraces found on test devices:</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">dut_manager</span><span class="o">.</span><span class="n">disconnect_testbed</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">watchdogs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">watchdogs</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Watchdogs found on test devices:</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">dut_manager</span><span class="o">.</span><span class="n">disconnect_testbed</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="lower_all_zp_volume"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.lower_all_zp_volume">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lower_all_zp_volume</span><span class="p">(</span><span class="n">all_playback_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Alternative to &quot;disable_speaker_audio&quot;. Lower all ZP volumes to 10.</span>
<span class="sd">    Often times, its helpful to hear something from your players while testing.</span>
<span class="sd">    :param all_playback_devices:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_playback_devices</span><span class="p">:</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">muse_rest</span><span class="o">.</span><span class="n">playerVolume</span><span class="o">.</span><span class="n">setVolume</span><span class="p">(</span><span class="n">volume</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">yield</span>

    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_playback_devices</span><span class="p">:</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">muse_rest</span><span class="o">.</span><span class="n">playerVolume</span><span class="o">.</span><span class="n">setVolume</span><span class="p">(</span><span class="n">volume</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_and_group_zps"><a class="viewcode-back" href="../../../pytest_automation.player.html#pytest_automation.player.conftest.get_and_group_zps">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_and_group_zps</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">get_class_dut</span><span class="p">,</span> <span class="n">dut_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Groups n number of additional zps to the dut under test, using the class_dut to prevent ungrouping between tests</span>
<span class="sd">    :param request:</span>
<span class="sd">    :param get_class_dut:</span>
<span class="sd">    :param dut_manager:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># To override number of zps to add, add this to the top of your class definition:</span>
    <span class="c1"># @pytest.mark.parametrize(&quot;get_and_group_zps&quot;, [2], indirect=True, scope=&quot;class&quot;)</span>
    <span class="c1"># class TestMyStuff(object):</span>
    <span class="c1">#     ...</span>
    <span class="n">num_new_zps</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">group_members</span> <span class="o">=</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">get_more_devices</span><span class="p">(</span><span class="n">num_new_zps</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_new_zps</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">group_members</span> <span class="o">=</span> <span class="n">group_members</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">yield</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">group_members</span></div>

    <span class="c1"># Cleanup handled by `get_class_dut`</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>