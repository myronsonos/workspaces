
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pytest_automation.player.cloud_services.test_pull_accounts &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pytest_automation.player.cloud_services.test_pull_accounts</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">dateutil</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="k">import</span> <span class="n">UUID</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">from</span> <span class="nn">pytest_automation.player.cloud_services.helpers.account_objects</span> <span class="k">import</span> \
    <span class="n">Accounts</span><span class="p">,</span> <span class="n">EmptyAccounts</span>
<span class="kn">from</span> <span class="nn">sleep</span> <span class="k">import</span> <span class="n">guaranteed_sleep</span>
<span class="kn">import</span> <span class="nn">pytest_automation.player.cloud_services.helpers.mock_lechmere_helpers</span> <span class="k">as</span> <span class="nn">helpers</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>


<span class="n">MAS_PUSH</span> <span class="o">=</span> <span class="s1">&#39;Music account replication push&#39;</span>
<span class="n">MAS_PULL</span> <span class="o">=</span> <span class="s1">&#39;Music account replication pull&#39;</span>

<span class="n">MODULE_DEVICE_FILTER</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">zp</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_designated_account_replication_player</span><span class="p">()</span>


<div class="viewcode-block" id="reset_accounts"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.reset_accounts">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;dut_manager&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reset_accounts</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">dut_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :param dut_manager:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># remove accounts</span>
    <span class="n">EmptyAccounts</span><span class="p">(</span><span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span><span class="o">.</span><span class="n">write_accounts_file</span><span class="p">()</span>
    
    <span class="c1"># bounce anacapa to sync the file</span>
    <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">()</span> 
    <span class="n">wait_until_true</span><span class="p">(</span><span class="n">predicate</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_rest</span><span class="o">.</span><span class="n">getGroupId</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for &lt;</span><span class="si">{}</span><span class="s2">&gt; to get a groupId&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">))</span>
    
    <span class="n">mpsc</span><span class="o">.</span><span class="n">delete_service_accounts</span><span class="p">(</span><span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
    <span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s1">&#39;accountsmgr&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">EmptyAccounts</span><span class="p">(</span><span class="n">dut_manager</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span><span class="o">.</span><span class="n">version</span></div>


<div class="viewcode-block" id="test_add_account_on_service"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_add_account_on_service">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_add_account_on_service</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># set account type</span>
    <span class="n">account_type</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;AddAccountOnService&#39;</span><span class="p">)</span>

    <span class="c1"># Create account XML</span>
    <span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">23</span><span class="p">)])</span>
    <span class="n">account_xml</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;Accounts&gt;</span>
<span class="s2">                        &lt;Account Type=&quot;</span><span class="si">{}</span><span class="s2">&quot; SerialNum=&quot;1&quot; Flags=&quot;0&quot; VClockHousehold=&quot;</span><span class="si">{}</span><span class="s2">:2000&quot;&gt;</span>
<span class="s2">                                &lt;UN&gt;X_#Svc</span><span class="si">{}</span><span class="s2">-0-Token&lt;/UN&gt;</span>
<span class="s2">                                &lt;NN&gt;automation&lt;/NN&gt;</span>
<span class="s2">                                &lt;MD&gt;1&lt;/MD&gt;</span>
<span class="s2">                                &lt;OADevID&gt;Sonos_kkmYpyiBx3bg1rRNRxS3sx0vMM&lt;/OADevID&gt;</span>
<span class="s2">                                &lt;Hash&gt;TestHash&lt;/Hash&gt;</span>
<span class="s2">                                &lt;Token&gt;</span><span class="si">{}</span><span class="s2">&lt;/Token&gt;</span>
<span class="s2">                                &lt;Key&gt;RefreshToken&lt;/Key&gt;</span>
<span class="s2">                        &lt;/Account&gt;</span>
<span class="s2">                    &lt;/Accounts&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>

    <span class="c1"># Add account on service</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mpsc</span><span class="o">.</span><span class="n">push_music_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">account_xml</span><span class="p">)</span>
    <span class="n">accounts_response</span> <span class="o">=</span> <span class="n">_get_accounts_from_xml</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="c1"># Verify service response</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on service &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                              <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:2000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">),</span>  <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                     <span class="kc">True</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="n">_wait_for_pull</span><span class="p">(</span><span class="n">mpsc</span><span class="p">)</span>

    <span class="c1"># Grab accounts.xml from player and verify</span>
    <span class="n">accounts_player</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                         <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:2000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">),</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                     <span class="kc">True</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_account_replication_no_key"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_account_replication_no_key">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_account_replication_no_key</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SWPBL-111302: Player rejects account records without refresh tokens</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># set account type</span>
    <span class="n">account_type</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="s1">&#39;ReplicationNoKey&#39;</span><span class="p">)</span>

    <span class="c1"># Create account XML</span>
    <span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">23</span><span class="p">)])</span>
    <span class="n">account_xml</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;Accounts&gt;</span>
<span class="s2">                        &lt;Account Type=&quot;</span><span class="si">{}</span><span class="s2">&quot; SerialNum=&quot;1&quot; Flags=&quot;0&quot; VClockHousehold=&quot;</span><span class="si">{}</span><span class="s2">:2000&quot;&gt;</span>
<span class="s2">                                &lt;UN&gt;X_#Svc</span><span class="si">{}</span><span class="s2">-0-Token&lt;/UN&gt;</span>
<span class="s2">                                &lt;NN&gt;automation&lt;/NN&gt;</span>
<span class="s2">                                &lt;MD&gt;1&lt;/MD&gt;</span>
<span class="s2">                                &lt;OADevID&gt;Sonos_kkmYpyiBx3bg1rRNRxS3sx0vMM&lt;/OADevID&gt;</span>
<span class="s2">                                &lt;Hash&gt;TestHash&lt;/Hash&gt;</span>
<span class="s2">                                &lt;Token&gt;</span><span class="si">{}</span><span class="s2">&lt;/Token&gt;</span>
<span class="s2">                        &lt;/Account&gt;</span>
<span class="s2">                    &lt;/Accounts&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>

    <span class="c1"># Add account on service</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mpsc</span><span class="o">.</span><span class="n">push_music_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">account_xml</span><span class="p">)</span>
    <span class="n">accounts_response</span> <span class="o">=</span> <span class="n">_get_accounts_from_xml</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="c1"># Verify service response</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on service &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                              <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:2000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">),</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                     <span class="kc">True</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="n">_wait_for_pull</span><span class="p">(</span><span class="n">mpsc</span><span class="p">)</span>

    <span class="c1"># Grab accounts.xml from player and verify</span>
    <span class="n">accounts_player</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                         <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:2000&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">),</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                     <span class="kc">True</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_modify_account_at_service_no_conflict"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_modify_account_at_service_no_conflict">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_modify_account_at_service_no_conflict</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># set account type</span>
    <span class="n">account_type</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;ModifyAccountNoConflict&#39;</span><span class="p">)</span>

    <span class="c1"># Add account on player</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="s1">&#39;accessToken&#39;</span><span class="p">,</span> <span class="s1">&#39;Key&#39;</span><span class="p">)</span>
    <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create account XML to modify</span>
    <span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">23</span><span class="p">)])</span>
    <span class="n">original_accounts</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">account_xml</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;Accounts&gt;</span>
<span class="s2">                        &lt;Account Type=&quot;</span><span class="si">{}</span><span class="s2">&quot; SerialNum=&quot;</span><span class="si">{}</span><span class="s2">&quot; Id=&quot;</span><span class="si">{}</span><span class="s2">&quot; Flags=&quot;0&quot; VClockHousehold=&quot;</span><span class="si">{}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                            &lt;UN&gt;X_#Svc</span><span class="si">{}</span><span class="s2">-b9e2-Token&lt;/UN&gt;</span>
<span class="s2">                            &lt;NN&gt;automation&lt;/NN&gt;</span>
<span class="s2">                            &lt;MD&gt;1&lt;/MD&gt;</span>
<span class="s2">                            &lt;OADevID&gt;Sonos_kkmYpyiBx3bg1rRNRxS3sx0vMM&lt;/OADevID&gt;</span>
<span class="s2">                            &lt;Hash&gt;TestHash&lt;/Hash&gt;</span>
<span class="s2">                            &lt;Token&gt;</span><span class="si">{}</span><span class="s2">&lt;/Token&gt;</span>
<span class="s2">                            &lt;Key&gt;RefreshToken&lt;/Key&gt;</span>
<span class="s2">                        &lt;/Account&gt;</span>
<span class="s2">                     &lt;/Accounts&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                           <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>

    <span class="c1"># Modify account at cloud service</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mpsc</span><span class="o">.</span><span class="n">push_music_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">account_xml</span><span class="p">)</span>
    <span class="n">accounts_response</span> <span class="o">=</span> <span class="n">_get_accounts_from_xml</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="c1"># Verify service response</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on service &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                              <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household</span><span class="p">),</span>
                     <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="n">_wait_for_pull</span><span class="p">(</span><span class="n">mpsc</span><span class="p">)</span>

    <span class="c1"># Grab accounts.xml from player and verify</span>
    <span class="n">accounts_player</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                         <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household</span><span class="p">),</span>
                     <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_delete_account_on_service"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_delete_account_on_service">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_delete_account_on_service</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># set account type</span>
    <span class="n">account_type</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="s1">&#39;DeleteAccountOnService&#39;</span><span class="p">)</span>

    <span class="c1"># Add account on player</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="s1">&#39;accessToken&#39;</span><span class="p">,</span> <span class="s1">&#39;deleteKey&#39;</span><span class="p">)</span>
    <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create account XML to delete</span>
    <span class="n">original_accounts</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">account_xml</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;Accounts&gt;</span>
<span class="s2">                        &lt;Account Type=&quot;</span><span class="si">{}</span><span class="s2">&quot; Deleted=&quot;1&quot; SerialNum=&quot;</span><span class="si">{}</span><span class="s2">&quot; Id=&quot;</span><span class="si">{}</span><span class="s2">&quot; Flags=&quot;0&quot; VClockHousehold=&quot;</span><span class="si">{}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                        &lt;UN&gt;</span><span class="si">{}</span><span class="s2">&lt;/UN&gt;</span>
<span class="s2">                        &lt;/Account&gt;</span>
<span class="s2">                    &lt;/Accounts&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                          <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household</span><span class="p">,</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

    <span class="c1"># Delete account at cloud service</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mpsc</span><span class="o">.</span><span class="n">push_music_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">account_xml</span><span class="p">)</span>
    <span class="n">accounts_response</span> <span class="o">=</span> <span class="n">_get_accounts_from_xml</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="c1"># Verify service response</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Expected one count to be deleted on service&quot;</span>
    <span class="n">_wait_for_pull</span><span class="p">(</span><span class="n">mpsc</span><span class="p">)</span>

    <span class="c1"># Grab accounts.xml from player and verify</span>
    <span class="n">accounts_player</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> \
        <span class="s2">&quot;Expected no accounts on ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                           <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">))</span></div>


<div class="viewcode-block" id="test_modify_account_at_service_with_conflict_player_wins"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_modify_account_at_service_with_conflict_player_wins">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_modify_account_at_service_with_conflict_player_wins</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span>
                                                             <span class="n">module_dut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># set account type</span>
    <span class="n">account_type</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span>
                                                  <span class="s1">&#39;ModifyAccountOnServiceWithConflictPlayerWins&#39;</span><span class="p">)</span>

    <span class="c1"># Add account on player</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">23</span><span class="p">)])</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="n">access_token</span><span class="p">,</span> <span class="s1">&#39;Key&#39;</span><span class="p">)</span>
    <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create a copy of the account with an older household vector clock</span>
    <span class="c1"># to create a conflict on the pull request</span>
    <span class="n">original_accounts</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">decremented_version</span> <span class="o">=</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household_version</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">accounts_xml</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;Accounts&gt;</span>
<span class="s2">                        &lt;Account Type=&quot;</span><span class="si">{}</span><span class="s2">&quot; SerialNum=&quot;</span><span class="si">{}</span><span class="s2">&quot; Id=&quot;</span><span class="si">{}</span><span class="s2">&quot; Flags=&quot;0&quot; VClockHousehold=&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                            &lt;UN&gt;X_#Svc</span><span class="si">{}</span><span class="s2">-0-Token&lt;/UN&gt;</span>
<span class="s2">                            &lt;NN&gt;automation&lt;/NN&gt;</span>
<span class="s2">                            &lt;MD&gt;1&lt;/MD&gt;</span>
<span class="s2">                            &lt;OADevID&gt;Sonos_kkmYpyiBx3bg1rRNRxS3sx0vMM&lt;/OADevID&gt;</span>
<span class="s2">                            &lt;Hash&gt;TestHash&lt;/Hash&gt;</span>
<span class="s2">                            &lt;Token&gt;ConflictToken&lt;/Token&gt;</span>
<span class="s2">                            &lt;Key&gt;RefreshToken&lt;/Key&gt;</span>
<span class="s2">                        &lt;/Account&gt;</span>
<span class="s2">                    &lt;/Accounts&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                          <span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">decremented_version</span><span class="p">,</span> <span class="n">account_type</span><span class="p">)</span>

    <span class="c1"># Push accounts.xml to cloud and verify</span>
    <span class="n">guaranteed_sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># allow the cloud vector clock, assigned by the mock service, time to advance</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mpsc</span><span class="o">.</span><span class="n">push_music_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">accounts_xml</span><span class="p">)</span>
    <span class="n">accounts_response</span> <span class="o">=</span> <span class="n">_get_accounts_from_xml</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on service &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                              <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">decremented_version</span><span class="p">),</span>
                     <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="s2">&quot;ConflictToken&quot;</span><span class="p">)</span>

    <span class="c1"># Wait for the player to pull the change, then grab accounts.xml from player and verify.</span>
    <span class="c1"># Player will have resolved the conflict and bumped the household clock version by two.</span>
    <span class="n">_wait_for_pull</span><span class="p">(</span><span class="n">mpsc</span><span class="p">)</span>
    <span class="n">incremented_version</span> <span class="o">=</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household_version</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">accounts_player</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                         <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">incremented_version</span><span class="p">),</span>
                     <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="n">access_token</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
        <span class="n">accounts_player</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_cloud</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_cloud</span><span class="p">),</span> \
        <span class="s2">&quot;Expected cloud vector clock to be later: </span><span class="si">{}</span><span class="s2"> vs </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_cloud</span><span class="p">,</span>
                                                                   <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_cloud</span><span class="p">)</span>

    <span class="c1"># Verify accounts on service after the player has pushed the resolved conflict</span>
    <span class="c1"># https://jira.sonos.com/browse/SWPBL-105901</span>
    <span class="n">mpsc</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
    <span class="n">accounts_service</span> <span class="o">=</span> <span class="n">_get_pushed_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># waits for push</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_service</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on service &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                              <span class="nb">len</span><span class="p">(</span><span class="n">accounts_service</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_service</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">incremented_version</span><span class="p">),</span>
                     <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="n">access_token</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_service</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                         <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">accounts_service</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household_version</span> <span class="o">&gt;</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household_version</span><span class="p">,</span> \
        <span class="s2">&quot;Expected player accounts preserved&quot;</span>
    <span class="k">assert</span> <span class="n">accounts_service</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span> <span class="o">==</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> \
        <span class="s2">&quot;Player serial number incorrect&quot;</span>
    <span class="k">assert</span> <span class="n">accounts_service</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="n">access_token</span><span class="p">,</span> \
        <span class="s2">&quot;Player token incorrect&quot;</span></div>


<div class="viewcode-block" id="test_full_sync"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_full_sync">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_full_sync</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># set account types</span>
    <span class="n">account_type_dl</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="s1">&#39;FullSyncDL&#39;</span><span class="p">,</span> <span class="n">auth_type</span><span class="o">=</span><span class="s1">&#39;DeviceLink&#39;</span><span class="p">)</span>
    <span class="n">account_type_uid</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="s1">&#39;FullSyncUID&#39;</span><span class="p">,</span> <span class="n">auth_type</span><span class="o">=</span><span class="s1">&#39;UserId&#39;</span><span class="p">)</span>

    <span class="c1"># SWPBL-119457: add non-oauth account and confirm that the player still</span>
    <span class="c1">#               has it after the full-sync pull</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddAccountX</span><span class="p">(</span><span class="n">account_type_uid</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>
    <span class="n">original_accounts</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vclock_household_username</span> <span class="o">=</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household</span>

    <span class="c1"># Add account on player</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type_dl</span><span class="p">,</span> <span class="s1">&#39;firstToken&#39;</span><span class="p">,</span> <span class="s1">&#39;Key&#39;</span><span class="p">)</span>
    <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create account XML</span>
    <span class="n">original_accounts</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">incremented_version</span> <span class="o">=</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household_version</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">vclock_household_oauth</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">incremented_version</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">23</span><span class="p">)])</span>
    <span class="n">account_xml</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;Accounts&gt;</span>
<span class="s2">                        &lt;Account Type=&quot;</span><span class="si">{}</span><span class="s2">&quot; SerialNum=&quot;2&quot; Flags=&quot;0&quot; VClockHousehold=&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                            &lt;UN&gt;X_#Svc</span><span class="si">{}</span><span class="s2">-b9e2-Token&lt;/UN&gt;</span>
<span class="s2">                            &lt;NN&gt;automation&lt;/NN&gt;</span>
<span class="s2">                            &lt;MD&gt;1&lt;/MD&gt;</span>
<span class="s2">                            &lt;OADevID&gt;Sonos_kkmYpyiBx3bg1rRNRxS3sx0vMM&lt;/OADevID&gt;</span>
<span class="s2">                            &lt;Hash&gt;TestHash&lt;/Hash&gt;</span>
<span class="s2">                            &lt;Token&gt;</span><span class="si">{}</span><span class="s2">&lt;/Token&gt;</span>
<span class="s2">                            &lt;Key&gt;RefreshToken&lt;/Key&gt;</span>
<span class="s2">                        &lt;/Account&gt;</span>
<span class="s2">                    &lt;/Accounts&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account_type_dl</span><span class="p">,</span><span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">incremented_version</span><span class="p">,</span>
                                          <span class="n">account_type_dl</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>

    <span class="c1"># Push accounts.xml to cloud</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mpsc</span><span class="o">.</span><span class="n">push_music_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">account_xml</span><span class="p">,</span> <span class="n">fullSync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">accounts_response</span> <span class="o">=</span> <span class="n">_get_accounts_from_xml</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="c1"># Verify service response</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>\
        <span class="s2">&quot;Expected 1 account on service &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                              <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vclock_household_oauth</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">account_type_dl</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="n">_wait_for_pull</span><span class="p">(</span><span class="n">mpsc</span><span class="p">)</span>

    <span class="c1"># Grab accounts.xml from player and verify</span>
    <span class="n">accounts_player</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 2 account on ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                         <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">))</span>
    <span class="c1"># Verify the username/password account is untouched</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vclock_household_username</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">account_type_uid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># no token</span>

    <span class="c1"># Verify that the OAuth account has been updated with the cloud changes</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vclock_household_oauth</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">account_type_dl</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_push_full_sync"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_push_full_sync">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_push_full_sync</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># set account type</span>
    <span class="n">account_type_i</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="s1">&#39;PushFullSyncI&#39;</span><span class="p">)</span>
    <span class="n">account_type_ii</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="s1">&#39;PushFullSyncII&#39;</span><span class="p">)</span>
    <span class="n">account_type_iii</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="s1">&#39;PushFullSyncIII&#39;</span><span class="p">)</span>

    <span class="c1"># Add accounts on player</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type_i</span><span class="p">,</span> <span class="s1">&#39;333Token&#39;</span><span class="p">,</span> <span class="s1">&#39;333Key&#39;</span><span class="p">)</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type_ii</span><span class="p">,</span> <span class="s1">&#39;666Token&#39;</span><span class="p">,</span> <span class="s1">&#39;666Key&#39;</span><span class="p">)</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type_iii</span><span class="p">,</span> <span class="s1">&#39;999Token&#39;</span><span class="p">,</span> <span class="s1">&#39;999Key&#39;</span><span class="p">)</span>

    <span class="c1"># Verify accounts on the service</span>
    <span class="n">accounts_service</span> <span class="o">=</span> <span class="n">_get_pushed_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_service</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 3 accounts got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accounts_service</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_service</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type_i</span><span class="p">,</span> <span class="s1">&#39;333Token&#39;</span><span class="p">)</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_service</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type_ii</span><span class="p">,</span> <span class="s1">&#39;666Token&#39;</span><span class="p">)</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_service</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type_iii</span><span class="p">,</span> <span class="s1">&#39;999Token&#39;</span><span class="p">)</span>

    <span class="c1"># Remove accounts from the service and verify</span>
    <span class="n">mpsc</span><span class="o">.</span><span class="n">delete_service_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
    <span class="n">accounts_service_pre</span> <span class="o">=</span> <span class="n">_get_pushed_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_service_pre</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 0 accounts got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accounts_service_pre</span><span class="p">))</span>

    <span class="c1"># Trigger a push and full sync to the cloud</span>
    <span class="n">mpsc</span><span class="o">.</span><span class="n">sync_music_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="s1">&#39;push&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Verify accounts on the service</span>
    <span class="n">accounts_service_post</span> <span class="o">=</span> <span class="n">_get_pushed_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_service_post</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 3 accounts got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accounts_service_post</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_service_post</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type_i</span><span class="p">,</span> <span class="s1">&#39;333Token&#39;</span><span class="p">)</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_service_post</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type_ii</span><span class="p">,</span> <span class="s1">&#39;666Token&#39;</span><span class="p">)</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_service_post</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type_iii</span><span class="p">,</span> <span class="s1">&#39;999Token&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_pull_before_push"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_pull_before_push">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties, full_sync&#39;</span><span class="p">,</span>
                         <span class="p">[({</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="kc">False</span><span class="p">),</span>
                          <span class="p">({</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="kc">True</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_pull_before_push</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">,</span> <span class="n">full_sync</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SWPBL-118325 - The player adds an account. Before it has pushed the new account, it receives a pull</span>
<span class="sd">    request. After the pull request the player pushes the new account. fullSync=False</span>
<span class="sd">    SWPBL-119457 - Account replication: pull with full-sync loses non-oauth accounts. fullSync=True</span>
<span class="sd">    Any account that has not been pushed, whether username-password or OAuth accounts, were getting blown away by the full sync pull</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :param full_sync:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># set account type</span>
    <span class="n">account_type_i</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="s1">&#39;PullBeforePush1&#39;</span><span class="p">)</span>
    <span class="n">account_type_ii</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="s1">&#39;PullBeforePush2&#39;</span><span class="p">)</span>

    <span class="c1"># Add account on player</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type_i</span><span class="p">,</span> <span class="s1">&#39;accessToken1&#39;</span><span class="p">,</span> <span class="s1">&#39;Key1&#39;</span><span class="p">)</span>
    <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create account XML to modify</span>
    <span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">23</span><span class="p">)])</span>
    <span class="n">original_accounts</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">account_xml</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;Accounts&gt;</span>
<span class="s2">                        &lt;Account Type=&quot;</span><span class="si">{}</span><span class="s2">&quot; SerialNum=&quot;</span><span class="si">{}</span><span class="s2">&quot; Id=&quot;</span><span class="si">{}</span><span class="s2">&quot; Flags=&quot;0&quot; VClockHousehold=&quot;</span><span class="si">{}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                            &lt;UN&gt;X_#Svc</span><span class="si">{}</span><span class="s2">-b9e2-Token&lt;/UN&gt;</span>
<span class="s2">                            &lt;NN&gt;automation&lt;/NN&gt;</span>
<span class="s2">                            &lt;MD&gt;1&lt;/MD&gt;</span>
<span class="s2">                            &lt;OADevID&gt;Sonos_kkmYpyiBx3bg1rRNRxS3sx0vMM&lt;/OADevID&gt;</span>
<span class="s2">                            &lt;Hash&gt;TestHash&lt;/Hash&gt;</span>
<span class="s2">                            &lt;Token&gt;</span><span class="si">{}</span><span class="s2">&lt;/Token&gt;</span>
<span class="s2">                            &lt;Key&gt;RefreshToken&lt;/Key&gt;</span>
<span class="s2">                        &lt;/Account&gt;</span>
<span class="s2">                     &lt;/Accounts&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account_type_i</span><span class="p">,</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                           <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household</span><span class="p">,</span> <span class="n">account_type_i</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>

    <span class="c1"># Configure account service to refuse push requests</span>
    <span class="n">mpsc</span><span class="o">.</span><span class="n">configure_account_service</span><span class="p">(</span><span class="n">push_response_code</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

    <span class="c1"># Add second account on player</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type_ii</span><span class="p">,</span> <span class="s1">&#39;accessToken2&#39;</span><span class="p">,</span> <span class="s1">&#39;Key2&#39;</span><span class="p">)</span>

    <span class="c1"># Modify account at cloud service</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mpsc</span><span class="o">.</span><span class="n">push_music_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">account_xml</span><span class="p">,</span>
                                                                <span class="n">fullSync</span><span class="o">=</span><span class="n">full_sync</span><span class="p">)</span>
    <span class="n">accounts_response</span> <span class="o">=</span> <span class="n">_get_accounts_from_xml</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="c1"># Verify service response</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on service &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                              <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household</span><span class="p">),</span>
                     <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type_i</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="n">_wait_for_pull</span><span class="p">(</span><span class="n">mpsc</span><span class="p">)</span>

    <span class="c1"># Re-enable push requests and wait for the push</span>
    <span class="n">mpsc</span><span class="o">.</span><span class="n">configure_account_service</span><span class="p">(</span><span class="n">push_response_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">mpsc</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
    <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Grab accounts.xml from player and verify</span>
    <span class="n">accounts_player</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 2 accounts on ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                          <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type_ii</span><span class="p">,</span> <span class="s1">&#39;accessToken2&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_retry"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_retry">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_retry</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Set error state</span>
    <span class="n">mpsc</span><span class="o">.</span><span class="n">configure_account_service</span><span class="p">(</span><span class="n">push_response_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">pull_response_code</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># set account type</span>
        <span class="n">account_type</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="s1">&#39;Retry&#39;</span><span class="p">)</span>

        <span class="c1"># Add account on player</span>
        <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="s1">&#39;firstToken&#39;</span><span class="p">,</span> <span class="s1">&#39;Key&#39;</span><span class="p">)</span>

        <span class="c1"># Wait for push reschedule</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">mpsc</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/accounts&quot;</span> <span class="ow">and</span>
                                                        <span class="n">l</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PUSH_FAILED&quot;</span><span class="p">),</span>
                                          <span class="n">timeout</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="c1"># Should only see two in the time frame</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> \
            <span class="s2">&quot;Unexpected number of pushes got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Unset the error states</span>
        <span class="n">mpsc</span><span class="o">.</span><span class="n">configure_account_service</span><span class="p">(</span><span class="n">push_response_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">pull_response_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_corrupt_accounts_from_cloud"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_corrupt_accounts_from_cloud">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_corrupt_accounts_from_cloud</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># set account type</span>
    <span class="n">account_type</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="s1">&#39;CorruptAccounts&#39;</span><span class="p">)</span>

    <span class="c1"># Add account on player</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="s1">&#39;firstToken&#39;</span><span class="p">,</span> <span class="s1">&#39;Key&#39;</span><span class="p">)</span>
    <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create account XML with missing UN field and edits</span>
    <span class="n">original_accounts</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">incremented_version</span> <span class="o">=</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household_version</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">23</span><span class="p">)])</span>
    <span class="n">account_xml</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;Accounts&gt;</span>
<span class="s2">                        &lt;Account Type=&quot;</span><span class="si">{}</span><span class="s2">&quot; SerialNum=&quot;1&quot; Flags=&quot;0&quot; VClockHousehold=&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                            &lt;NN&gt;automation&lt;/NN&gt;</span>
<span class="s2">                            &lt;MD&gt;1&lt;/MD&gt;</span>
<span class="s2">                            &lt;OADevID&gt;Sonos_kkmYpyiBx3bg1rRNRxS3sx0vMM&lt;/OADevID&gt;</span>
<span class="s2">                            &lt;Hash&gt;TestHash&lt;/Hash&gt;</span>
<span class="s2">                            &lt;Token&gt;</span><span class="si">{}</span><span class="s2">&lt;/Token&gt;</span>
<span class="s2">                            &lt;Key&gt;RefreshToken&lt;/Key&gt;</span>
<span class="s2">                        &lt;/Account&gt;</span>
<span class="s2">                    &lt;/Accounts&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">incremented_version</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>

    <span class="c1"># Push accounts.xml to cloud</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mpsc</span><span class="o">.</span><span class="n">push_music_accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">account_xml</span><span class="p">)</span>
    <span class="n">accounts_response</span> <span class="o">=</span> <span class="n">_get_accounts_from_xml</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="c1"># Verify service response</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on service &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                              <span class="nb">len</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_response</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span>
                                                           <span class="n">incremented_version</span><span class="p">),</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">account_type</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="n">_wait_for_pull</span><span class="p">(</span><span class="n">mpsc</span><span class="p">)</span>

    <span class="c1"># Grab accounts.xml from player and verify</span>
    <span class="n">accounts_player</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                         <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household</span><span class="p">,</span>
                     <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="s1">&#39;firstToken&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_corrupt_accounts_from_player"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_corrupt_accounts_from_player">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_corrupt_accounts_from_player</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SWPBL-120462</span>
<span class="sd">    Regression: corrupted music accounts fail to replicate to MAS</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># set account type</span>
    <span class="n">account_type</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="s1">&#39;CorruptAccounts&#39;</span><span class="p">)</span>

    <span class="c1"># Add account on player</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="s1">&#39;firstToken&#39;</span><span class="p">,</span> <span class="s1">&#39;Key&#39;</span><span class="p">)</span>
    <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create account XML with missing ID</span>
    <span class="n">original_accounts</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">account_xml</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;Accounts LastUpdateDevice=&quot;</span><span class="si">{}</span><span class="s2">&quot; Version=&quot;</span><span class="si">{}</span><span class="s2">&quot; NextSerialNum=&quot;</span><span class="si">{}</span><span class="s2">&quot; SchemaVersion=&quot;1&quot;</span>
<span class="s2">                                                        VClockHousehold=&quot;</span><span class="si">{}</span><span class="s2">&quot; VClockCloud=&quot;</span><span class="si">{}</span><span class="s2">&quot; MuseHouseholdID=&quot;</span><span class="si">{}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                        &lt;Account Type=&quot;</span><span class="si">{}</span><span class="s2">&quot; SerialNum=&quot;</span><span class="si">{}</span><span class="s2">&quot; Flags=&quot;</span><span class="si">{}</span><span class="s2">&quot; VClockHousehold=&quot;</span><span class="si">{}</span><span class="s2">&quot; VClockCloud=&quot;</span><span class="si">{}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                            &lt;UN&gt;</span><span class="si">{}</span><span class="s2">&lt;/UN&gt;</span>
<span class="s2">                            &lt;NN&gt;CorruptAccounts&lt;/NN&gt;</span>
<span class="s2">                            &lt;MD&gt;1&lt;/MD&gt;</span>
<span class="s2">                            &lt;OADevID&gt;</span><span class="si">{}</span><span class="s2">&lt;/OADevID&gt;</span>
<span class="s2">                            &lt;Token&gt;firstToken&lt;/Token&gt;</span>
<span class="s2">                            &lt;Key&gt;Key&lt;/Key&gt;</span>
<span class="s2">                        &lt;/Account&gt;</span>
<span class="s2">                     &lt;/Accounts&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">original_accounts</span><span class="o">.</span><span class="n">last_update_device</span><span class="p">,</span> <span class="n">original_accounts</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                                           <span class="n">original_accounts</span><span class="o">.</span><span class="n">next_serial_num</span><span class="p">,</span> <span class="n">original_accounts</span><span class="o">.</span><span class="n">vclock_household</span><span class="p">,</span>
                                           <span class="n">original_accounts</span><span class="o">.</span><span class="n">vclock_cloud</span><span class="p">,</span> <span class="n">module_dut</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span>
                                           <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span>
                                           <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household</span><span class="p">,</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_cloud</span><span class="p">,</span>
                                           <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">oauth_device_id</span><span class="p">)</span>

    <span class="c1"># Push accounts.xml to player</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">write_accounts_file</span><span class="p">(</span><span class="n">account_xml</span><span class="p">)</span>

    <span class="c1"># Reboot player which will schedule a push</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">()</span>

    <span class="c1"># Now wait for the push</span>
    <span class="n">mock_player_services_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
    <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mock_player_services_control</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Grab accounts.xml from player and verify</span>
    <span class="n">accounts_player</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                         <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">))</span>
    <span class="n">_verify_accounts</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_household</span><span class="p">,</span>
                     <span class="n">original_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_num</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">account_type</span><span class="p">,</span> <span class="s1">&#39;firstToken&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_service_change"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_service_change">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_service_change</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SWPBL-120449 - Accounts fail to replicate when a SMAPI service changes from UserId to DeviceLink</span>

<span class="sd">    Verifies that a MAS account change from UserId --&gt; DeviceLink(OAuth) results in ONE push to the cloud</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># set account type(UserId)</span>
    <span class="n">account_type_uid</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="s1">&#39;ServiceChange&#39;</span><span class="p">,</span>
                                                      <span class="n">auth_type</span><span class="o">=</span><span class="s1">&#39;UserId&#39;</span><span class="p">)</span>

    <span class="c1"># Add UserId account</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddAccountX</span><span class="p">(</span><span class="n">account_type_uid</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>

    <span class="c1"># Update the music service catalog to DeviceLink(OAUTH)</span>
    <span class="n">account_type_dl</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="s1">&#39;ServiceChange&#39;</span><span class="p">,</span>
                                                     <span class="n">auth_type</span><span class="o">=</span><span class="s1">&#39;DeviceLink&#39;</span><span class="p">)</span>

    <span class="c1"># Trigger a push request</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_zone_job</span><span class="p">(</span><span class="n">MAS_PUSH</span><span class="p">)</span>

    <span class="c1"># Verify we see only ONE push to the cloud</span>
    <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_empty_token"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_empty_token">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_empty_token</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">,</span> <span class="n">reset_accounts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SWPBL-123792 - Player has account replication conflict due to empty tokens</span>

<span class="sd">    Verifies that a DeviceLink account with an empty token can be successfully pushed to the cloud and not</span>
<span class="sd">    rejected by the player</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :param reset_accounts:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>
    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># Create account XML with missing token</span>
    <span class="n">account_xml</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;Accounts LastUpdateDevice=&quot;</span><span class="si">{}</span><span class="s2">&quot; Version=&quot;</span><span class="si">{}</span><span class="s2">&quot; NextSerialNum=&quot;2&quot; SchemaVersion=&quot;1&quot; MuseHouseholdID=&quot;</span><span class="si">{}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                        &lt;Account Type=&quot;62727&quot; SerialNum=&quot;1&quot; Flags=&quot;2&quot; VClockHousehold=&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                            &lt;UN&gt;X_#Svc62727-8cc9-Token&lt;/UN&gt;</span>
<span class="s2">                            &lt;NN&gt;EmptyToken&lt;/NN&gt;</span>
<span class="s2">                            &lt;MD&gt;1&lt;/MD&gt;</span>
<span class="s2">                            &lt;OADevID&gt;Sonos_mGCR4mQ6OSDQnXtTrg2CLJsGUU_8cc9&lt;/OADevID&gt;</span>
<span class="s2">                        &lt;/Account&gt;</span>
<span class="s2">                     &lt;/Accounts&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">reset_accounts</span><span class="p">,</span>
                                           <span class="n">module_dut</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">module_dut</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">reset_accounts</span><span class="p">)</span>

    <span class="c1"># Push accounts.xml to player</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">write_accounts_file</span><span class="p">(</span><span class="n">account_xml</span><span class="p">)</span>

    <span class="c1"># Reboot player which will schedule a push</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">()</span>

    <span class="c1"># Now wait for the push</span>
    <span class="n">mock_player_services_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
    <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mock_player_services_control</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Grab accounts.xml from player and verify</span>
    <span class="n">accounts_player</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
        <span class="s2">&quot;Expected 1 account on ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts_player</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">accounts_player</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vclock_cloud</span><span class="p">,</span> <span class="s1">&#39;VClockCloud was not set on account&#39;</span></div>


<div class="viewcode-block" id="test_sync_after_hhid_change"><a class="viewcode-back" href="../../../../pytest_automation.player.cloud_services.html#pytest_automation.player.cloud_services.test_pull_accounts.test_sync_after_hhid_change">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">nightly</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;module_dut&#39;</span><span class="p">,</span> <span class="s1">&#39;mock_player_services_control&#39;</span><span class="p">,</span> <span class="s1">&#39;reset_accounts&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;config_properties&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;enableMusicAccountReplication&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}])</span>
<span class="k">def</span> <span class="nf">test_sync_after_hhid_change</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">,</span> <span class="n">config_properties</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SWPBL-105879: Account pull request retains cloud vector clock on location change</span>

<span class="sd">    This test case verifies that after changing hhid on a player, the cloud vector clock is not reset</span>
<span class="sd">    :param mock_player_services_control:</span>
<span class="sd">    :param module_dut:</span>
<span class="sd">    :param config_properties:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig_hhid</span> <span class="o">=</span> <span class="n">module_dut</span><span class="o">.</span><span class="n">muse_rest</span><span class="o">.</span><span class="n">_hhid</span>
    <span class="n">new_hhid</span> <span class="o">=</span> <span class="n">_generate_random_hhid</span><span class="p">()</span>
    <span class="n">mpsc</span> <span class="o">=</span> <span class="n">mock_player_services_control</span>

    <span class="c1"># Configure account service</span>
    <span class="n">_configure_account_service</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">)</span>

    <span class="c1"># set account type</span>
    <span class="n">account_type</span> <span class="o">=</span> <span class="n">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span> <span class="s1">&#39;SyncAfterHhidChange&#39;</span><span class="p">)</span>

    <span class="c1"># Add account on player</span>
    <span class="n">module_dut</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">AddOAuthAccountX</span><span class="p">(</span><span class="n">account_type</span><span class="p">,</span> <span class="s1">&#39;firstToken&#39;</span><span class="p">,</span> <span class="s1">&#39;Key&#39;</span><span class="p">)</span>
    <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">mpsc</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">original_accounts</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Change hhid on player</span>
    <span class="n">mpsc</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">new_hhid</span><span class="p">)</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">mpsc</span><span class="o">.</span><span class="n">get_zp_registered</span><span class="p">(</span><span class="n">module_dut</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;museHouseholdId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_hhid</span><span class="p">,</span>
                    <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Player registered with new Muse Household Id [</span><span class="si">{}</span><span class="s1">]?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_hhid</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Shut down lechmere so cloud vector clock doesn&#39;t get overwritten</span>
        <span class="n">mpsc</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

        <span class="c1"># Trigger a pull request on the player so it will see the updated hhid</span>
        <span class="n">module_dut</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_zone_job</span><span class="p">(</span><span class="n">MAS_PULL</span><span class="p">)</span>

        <span class="c1"># Get the final accounts and check that it matches the original (not overwritten)</span>
        <span class="n">updated_accounts</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">module_dut</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_accounts_file</span><span class="p">(),</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">updated_accounts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
            <span class="s2">&quot;Expected 1 account on ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; got &lt;</span><span class="si">{}</span><span class="s2">&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span>
                                                             <span class="nb">len</span><span class="p">(</span><span class="n">updated_accounts</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">updated_accounts</span><span class="o">.</span><span class="n">vclock_cloud</span> <span class="o">==</span> <span class="n">original_accounts</span><span class="o">.</span><span class="n">vclock_cloud</span><span class="p">,</span> \
            <span class="s2">&quot;Expected VClockCloud: </span><span class="si">{}</span><span class="s2"> Actual: </span><span class="si">{}</span><span class="s2">&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">original_accounts</span><span class="o">.</span><span class="n">vclock_cloud</span><span class="p">,</span>
                                                          <span class="n">updated_accounts</span><span class="o">.</span><span class="n">vclock_cloud</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Restart the mock services server</span>
        <span class="c1"># I believe this is the proper recovery sequence but to be on the safe side, that&#39;s why this</span>
        <span class="c1"># test case is last in the file</span>
        <span class="n">mpsc</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">helpers</span><span class="o">.</span><span class="n">startup_and_connect_lechmere</span><span class="p">(</span><span class="n">mpsc</span><span class="p">,</span> <span class="n">module_dut</span><span class="p">,</span>
                                             <span class="n">config_properties</span><span class="p">)</span>

        <span class="c1"># Restore hhid</span>
        <span class="n">mpsc</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">module_dut</span><span class="p">,</span> <span class="n">orig_hhid</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">mpsc</span><span class="o">.</span><span class="n">get_zp_registered</span><span class="p">(</span><span class="n">module_dut</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;museHouseholdId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">orig_hhid</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Player registered with new Muse Household Id [</span><span class="si">{}</span><span class="s1">]?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orig_hhid</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_configure_account_service</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    :param mock_player_services_control: </span>
<span class="sd">    :param zp: </span>
<span class="sd">    :return: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_player_services_control</span><span class="o">.</span><span class="n">configure_account_service</span><span class="p">(</span><span class="n">enable_pull_notifications</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mock_player_services_control</span><span class="o">.</span><span class="n">configure_account_service</span><span class="p">(</span><span class="n">target_player_serial</span><span class="o">=</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_wait_for_pull</span><span class="p">(</span><span class="n">mock_player_services_control</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    :param mock_player_services_control: </span>
<span class="sd">    :return: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">mock_player_services_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/accounts&quot;</span> <span class="ow">and</span>
                                                                            <span class="n">l</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PULL&quot;</span><span class="p">),</span> 
                                                              <span class="n">history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;No pull for music service detected&quot;</span>


<span class="k">def</span> <span class="nf">_wait_for_push</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">clear_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clear_accounts</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    :param zp: </span>
<span class="sd">    :param mock_player_services_control: </span>
<span class="sd">    :param clear_logs: </span>
<span class="sd">    :param clear_accounts: </span>
<span class="sd">    :return: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">mock_player_services_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/accounts&quot;</span> <span class="ow">and</span>
                                                                            <span class="n">l</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PUSH&quot;</span><span class="p">),</span>
                                                              <span class="n">history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;No push for music service detected&quot;</span>
    
    <span class="k">if</span> <span class="n">clear_logs</span><span class="p">:</span>
        <span class="n">mock_player_services_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">clear_accounts</span><span class="p">:</span>
        <span class="n">mock_player_services_control</span><span class="o">.</span><span class="n">delete_service_accounts</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_pushed_accounts</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">mock_player_services_control</span><span class="p">,</span> <span class="n">wait_for_push</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    :param zp: </span>
<span class="sd">    :param mock_player_services_control: </span>
<span class="sd">    :param wait_for_push: </span>
<span class="sd">    :return: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">wait_for_push</span><span class="p">:</span>
        <span class="n">_wait_for_push</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">mock_player_services_control</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">guaranteed_sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mock_player_services_control</span><span class="o">.</span><span class="n">get_service_accounts</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_get_accounts_from_xml</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_accounts_from_xml</span><span class="p">(</span><span class="n">xml_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    :param xml_response: </span>
<span class="sd">    :return: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Contents of accounts.xml: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xml_response</span><span class="p">))</span>
    <span class="n">accounts</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml_response</span><span class="p">)</span>
    <span class="n">accounts</span><span class="o">.</span><span class="n">attrib</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;LastUpdateDevice&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;NextSerialNum&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;SchemaVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;VClockHousehold&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;VClockCloud&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;MuseHouseholdID&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
    <span class="n">parsed_service_accounts</span> <span class="o">=</span> <span class="n">Accounts</span><span class="p">(</span><span class="n">accounts</span><span class="p">,</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parsed_service_accounts</span><span class="p">,</span> 
                  <span class="nb">cmp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">cmp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">serial_num</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">serial_num</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">_verify_accounts</span><span class="p">(</span><span class="n">accounts</span><span class="p">,</span> <span class="n">vclock_household</span><span class="p">,</span> <span class="n">serial_number</span><span class="p">,</span> <span class="n">validate_id</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    :param accounts: </span>
<span class="sd">    :param vclock_household: </span>
<span class="sd">    :param serial_number: </span>
<span class="sd">    :param validate_id: </span>
<span class="sd">    :param type: </span>
<span class="sd">    :param token: </span>
<span class="sd">    :return: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">vclock_household</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">accounts</span><span class="o">.</span><span class="n">vclock_household</span> <span class="o">==</span> <span class="n">vclock_household</span><span class="p">,</span> \
            <span class="s2">&quot;VClockHousehold incorrect. Expected: </span><span class="si">{}</span><span class="s2"> Received: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">vclock_household</span><span class="p">,</span> <span class="n">accounts</span><span class="o">.</span><span class="n">vclock_household</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">serial_number</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">accounts</span><span class="o">.</span><span class="n">serial_num</span> <span class="o">==</span> <span class="n">serial_number</span><span class="p">,</span> \
            <span class="s2">&quot;Serial number incorrect. Expected: </span><span class="si">{}</span><span class="s2"> Received: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">serial_number</span><span class="p">,</span> <span class="n">accounts</span><span class="o">.</span><span class="n">serial_num</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate_id</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">_is_valid_uuid</span><span class="p">(</span><span class="n">accounts</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> \
            <span class="s2">&quot;ID was not a valid UUID4 Received: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">accounts</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">accounts</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="nb">type</span><span class="p">,</span> \
        <span class="s2">&quot;Type incorrect. Expected: </span><span class="si">{}</span><span class="s2"> Received: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">accounts</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">accounts</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="n">token</span><span class="p">,</span> \
        <span class="s2">&quot;Token incorrect. Expected: </span><span class="si">{}</span><span class="s2"> Received: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">accounts</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_generate_random_hhid</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    :return: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">alphanumeric_string</span><span class="p">(</span><span class="n">chars</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">chars</span><span class="p">))</span>

    <span class="k">return</span> <span class="s2">&quot;Sonos_</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alphanumeric_string</span><span class="p">(</span><span class="mi">26</span><span class="p">),</span> <span class="n">alphanumeric_string</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_add_custom_service_descriptor</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">auth_type</span><span class="o">=</span><span class="s1">&#39;DeviceLink&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add custom service to the player</span>
<span class="sd">    :param zp: </span>
<span class="sd">    :param sid: </span>
<span class="sd">    :param name: </span>
<span class="sd">    :param auth_type: </span>
<span class="sd">    :return: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_customsd</span><span class="p">(</span><span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">auth_type</span><span class="o">=</span><span class="n">auth_type</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="s2">&quot;http://foo.com&quot;</span><span class="p">,</span> 
                         <span class="n">secure_uri</span><span class="o">=</span><span class="s1">&#39;http://foo.com&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">zp</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">build_svcid_from_msid</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_valid_uuid</span><span class="p">(</span><span class="n">uuid_to_verify</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    :param uuid_to_verify: </span>
<span class="sd">    :return: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">uuid_obj</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="n">uuid_to_verify</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid_obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">uuid_to_verify</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>