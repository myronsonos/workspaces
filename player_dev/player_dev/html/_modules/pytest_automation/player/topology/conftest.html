
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pytest_automation.player.topology.conftest &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pytest_automation.player.topology.conftest</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">xml.etree</span> <span class="k">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">ET</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">sonos.subnet</span> <span class="k">import</span> <span class="n">Devices</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="n">UPnPError</span><span class="p">,</span> <span class="ne">TimeoutError</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">sonos.client.zone_player</span> <span class="k">import</span> <span class="p">(</span><span class="n">UPNP_ERROR_800_DEVICE_RESPONSIVE</span><span class="p">,</span>
                                      <span class="n">PORTABLE_DEVICES</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sonos.client.media_player</span> <span class="k">import</span> <span class="p">(</span><span class="n">MediaPlayer</span><span class="p">,</span> <span class="n">SHARE</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">common</span> <span class="k">import</span> <span class="n">SET_EXPIRATION_TIMEOUT</span>
<span class="kn">from</span> <span class="nn">sleep</span> <span class="k">import</span> <span class="n">guaranteed_sleep</span>
<span class="kn">from</span> <span class="nn">wifi.access_point.access_point_manager</span> <span class="k">import</span> <span class="n">NetworkManager</span>

<span class="n">UPDATE_URL</span> <span class="o">=</span> <span class="s2">&quot;http://builds.sonos.com/</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">/RELEASEALL/^</span><span class="si">{}</span><span class="s2">&quot;</span>
<span class="n">ANACAPA_CONF_DIR</span> <span class="o">=</span> <span class="s2">&quot;/jffs/conf&quot;</span>
<span class="n">SWGEN_QUAR</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">SWGEN_DEFAULT</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">SWGEN_THRESHOLD_VERSION</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.0-00000&quot;</span>
<span class="n">KEY</span> <span class="o">=</span> <span class="s1">&#39;Foo&#39;</span>
<span class="n">VALUE</span> <span class="o">=</span> <span class="s1">&#39;Bar&#39;</span>
<span class="n">RAW_DIAG_FILE</span> <span class="o">=</span> <span class="s1">&#39;raw_diag.txt&#39;</span>
<span class="n">REVIEW_URL</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">{}</span><span class="s1">:1400/support/review&#39;</span>
<span class="n">AGGRESSIVE_ADVERTISE_TIME</span><span class="o">=</span><span class="mi">120</span>

<div class="viewcode-block" id="skip_if_no_powered_managed_portable_devices"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.skip_if_no_powered_managed_portable_devices">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">skip_if_no_powered_managed_portable_devices</span><span class="p">(</span>
         <span class="n">all_unique_power_managed_portable_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixture to allow skipping a test if it needs a managed power portable</span>
<span class="sd">    device but the testbed doesn&#39;t have it. Depends on</span>
<span class="sd">    :func:`pytest_automation.conftest.</span>
<span class="sd">    all_unique_power_managed_portable_devices`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_unique_power_managed_portable_devices</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;No powered managed portable devices. Skipping test&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="wait_for_testbed_on_active_list"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.wait_for_testbed_on_active_list">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">wait_for_testbed_on_active_list</span><span class="p">(</span><span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wait until</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_devices`</span>
<span class="sd">    in testbed has all devices in its topology.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uuid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span><span class="p">:</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">uuid_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
                                <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_active_zp_uuids</span><span class="p">()),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">yield</span></div>


<div class="viewcode-block" id="vanish_device_gracefully"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.vanish_device_gracefully">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vanish_device_gracefully</span><span class="p">(</span><span class="n">unique_platform_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.unique_platform_devices`</span>
<span class="sd">    that is brought down gracefully (device sends bye bye when going down).</span>
<span class="sd">    Yield uuid of the device brought down.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vd_uuid</span> <span class="o">=</span> <span class="n">unique_platform_devices</span><span class="o">.</span><span class="n">raw_udn</span>
    <span class="n">unique_platform_devices</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">stop_anacapa_nicely</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">vd_uuid</span>
    <span class="n">unique_platform_devices</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">()</span>
    <span class="n">unique_platform_devices</span><span class="o">.</span><span class="n">wait_for_upnp_alive</span><span class="p">()</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">unique_platform_devices</span><span class="o">.</span><span class="n">is_device_valid</span><span class="p">())</span></div>


<div class="viewcode-block" id="vanish_device_ungracefully"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.vanish_device_ungracefully">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vanish_device_ungracefully</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">a_device</span><span class="p">,</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get :func:`~pytest_automation.pytest_sonos_device_selection.a_device` that</span>
<span class="sd">    will be brought down ungracefully (no bye bye from device when going down)</span>
<span class="sd">    simulating anacapa crash or power yanked. Yields uuid of</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_fenway_or_newer_devices`</span>
<span class="sd">    brought down ungracefully.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># skip test on release build since theu do not have test point support</span>
    <span class="k">if</span> <span class="n">a_device</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">is_release_version</span><span class="p">():</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;No testpoint support skipping test&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_anacapa</span><span class="p">():</span>
        <span class="n">a_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">()</span>
        <span class="n">a_device</span><span class="o">.</span><span class="n">wait_for_upnp_alive</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">a_device</span><span class="o">.</span><span class="n">is_device_valid</span><span class="p">())</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">start_anacapa</span><span class="p">)</span>
    <span class="n">active_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_fenway_or_newer_devices</span>
                      <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="o">!=</span> <span class="n">a_device</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">]</span>
    <span class="n">vd_uuid</span> <span class="o">=</span> <span class="n">a_device</span><span class="o">.</span><span class="n">raw_udn</span>
    <span class="n">a_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">stop_anacapa</span><span class="p">()</span>
    <span class="c1"># run testpoint on all fenway or newer devices</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">expire_active_device</span><span class="p">(</span><span class="n">vd_uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">active_devices</span><span class="p">])</span>
    <span class="k">yield</span> <span class="n">vd_uuid</span><span class="p">,</span> <span class="n">active_devices</span></div>


<div class="viewcode-block" id="vanished_device_and_device_with_set_expiration_timeout"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.vanished_device_and_device_with_set_expiration_timeout">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vanished_device_and_device_with_set_expiration_timeout</span><span class="p">(</span>
        <span class="n">a_device</span><span class="p">,</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get :func:`~pytest_automation.pytest_sonos_device_selection.a_device` that</span>
<span class="sd">    will be brought down ungracefully (no bye bye from device when going down)</span>
<span class="sd">    simulating anacapa crash or power yanked. Yields uuid of</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.a_device brought</span>
<span class="sd">    down ungracefully and an active device yielded by</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_fenway_or_newer_devices`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">active_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_fenway_or_newer_devices</span>
                      <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="o">!=</span> <span class="n">a_device</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">active_devices</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Need atleast 1 or more greater than 32MB memory devices&quot;</span><span class="p">)</span>
    <span class="n">active_device</span> <span class="o">=</span> <span class="n">active_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">active_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_forced_upnp_expiration_timeout</span><span class="p">(</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">SET_EXPIRATION_TIMEOUT</span><span class="p">)</span>
    <span class="n">active_device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s1">&#39;topology&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">vd_uuid</span> <span class="o">=</span> <span class="n">a_device</span><span class="o">.</span><span class="n">raw_udn</span>
    <span class="n">wait_until_true</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">vd_uuid</span> <span class="ow">in</span> <span class="n">active_device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_active_zp_uuids</span><span class="p">(),</span>
        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">a_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">stop_anacapa</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">vd_uuid</span><span class="p">,</span> <span class="n">active_device</span>
    <span class="n">a_device</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">active_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">remove_file</span><span class="p">(</span><span class="n">ANACAPA_CONF_DIR</span><span class="p">)</span>
    <span class="n">active_device</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">()</span></div>


<div class="viewcode-block" id="vanish_multiple_devices"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.vanish_multiple_devices">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vanish_multiple_devices</span><span class="p">(</span><span class="n">all_devices</span><span class="p">,</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get 3 devices from</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_devices` and</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_fenway_or_newer_devices`.</span>
<span class="sd">    First of which is the local device. Shutdown second device ungracefully and</span>
<span class="sd">    third device gracefully in that order. Shutdown all non test devices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_fenway_or_newer_devices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Need atleast 3 or more greater than 32MB memory devices&quot;</span><span class="p">)</span>
    <span class="n">local_device</span> <span class="o">=</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ungraceful_shutdown_device</span> <span class="o">=</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">graceful_shutdown_device</span> <span class="o">=</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">non_test_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="ow">not</span>
                        <span class="ow">in</span> <span class="p">[</span><span class="n">local_device</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span>
                            <span class="n">ungraceful_shutdown_device</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span>
                            <span class="n">graceful_shutdown_device</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">]]</span>
    <span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">stop_anacapa_nicely</span><span class="p">()</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">non_test_devices</span><span class="p">]</span>
    <span class="n">local_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_forced_upnp_expiration_timeout</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">local_device</span><span class="p">,</span> <span class="n">ungraceful_shutdown_device</span><span class="p">,</span> <span class="n">graceful_shutdown_device</span>
    <span class="n">local_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">remove_file</span><span class="p">(</span><span class="n">ANACAPA_CONF_DIR</span><span class="p">)</span>
    <span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">()</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span><span class="p">]</span>
    <span class="p">[</span><span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">zp</span><span class="o">.</span><span class="n">is_device_valid</span><span class="p">())</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span><span class="p">]</span></div>


<div class="viewcode-block" id="vanished_and_active_device_pair"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.vanished_and_active_device_pair">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vanished_and_active_device_pair</span><span class="p">(</span><span class="n">all_fenway_or_newer_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a pair of devices brought down (vanish) and an active player in HH</span>
<span class="sd">    from :func:`~pytest_automation.pytest_sonos_device_selection.all_fenway_or_newer_devices`.</span>
<span class="sd">    Yields instance of vanished and active devices.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Vanished list is not supported on &lt;=32MB players.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_fenway_or_newer_devices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Need atleast 2 or more greater than 32MB memory devices&quot;</span><span class="p">)</span>
    <span class="n">vanished_device</span> <span class="o">=</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">active_device</span> <span class="o">=</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">vanished_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">stop_anacapa_nicely</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">vanished_device</span><span class="p">,</span> <span class="n">active_device</span>
    <span class="c1"># in some cases, the vanished device may be brought back up as part of</span>
    <span class="c1"># test procedure.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vanished_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_anacapa_running</span><span class="p">():</span>
        <span class="n">vanished_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">()</span>
        <span class="n">vanished_device</span><span class="o">.</span><span class="n">wait_for_upnp_alive</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">vanished_device</span><span class="o">.</span><span class="n">is_device_valid</span><span class="p">())</span></div>


<div class="viewcode-block" id="updating_and_active_device"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.updating_and_active_device">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">updating_and_active_device</span><span class="p">(</span><span class="n">all_fenway_or_newer_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a pair if updating device and an active device in HH</span>
<span class="sd">    from :func:`~pytest_automation.pytest_sonos_device_selection.all_fenway_or_newer_devices`.</span>
<span class="sd">    Yields instance of updating device uuid and active device.</span>

<span class="sd">    :raise: UPNP_ERROR_402_INVALID_ARGUMENTS</span>
<span class="sd">    :raise: UPNP_ERROR_803_NEVER_REGISTERED</span>

<span class="sd">    .. note::</span>

<span class="sd">        Vanished list is not supported on &lt;=32MB players.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_fenway_or_newer_devices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Need atleast 2 or more greater than 32MB memory devices&quot;</span><span class="p">)</span>
    <span class="n">updating_device</span> <span class="o">=</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">active_device</span> <span class="o">=</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">vd_uuid</span> <span class="o">=</span> <span class="n">updating_device</span><span class="o">.</span><span class="n">raw_udn</span>
    <span class="c1"># get build information from build properties to get update params.</span>
    <span class="n">build_date_obj</span> <span class="o">=</span> <span class="n">updating_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_build_properties</span><span class="p">()</span><span class="o">.</span><span class="n">date</span>
    <span class="n">build_date</span> <span class="o">=</span> <span class="n">build_date_obj</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">branch_name</span> <span class="o">=</span> <span class="n">updating_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_branch_from_build_properties</span><span class="p">()</span>
    <span class="n">build_version</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">updating_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_build_properties</span><span class="p">()</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">UPDATE_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">build_date</span><span class="p">,</span> <span class="n">branch_name</span><span class="p">,</span> <span class="n">build_version</span><span class="p">)</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting update on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">updating_device</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">updating_device</span><span class="o">.</span><span class="n">ZoneGroupTopology</span><span class="o">.</span><span class="n">BeginSoftwareUpdate</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UPnPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UPnPError</span><span class="p">(</span><span class="s2">&quot;UPnP Error </span><span class="si">{}</span><span class="s2"> while updating&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for SSDP bye bye from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                           <span class="n">updating_device</span><span class="p">))</span>
        <span class="n">updating_device</span><span class="o">.</span><span class="n">wait_for_upnp_byebye</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">vd_uuid</span><span class="p">,</span> <span class="n">active_device</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Update failed on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">updating_device</span><span class="p">))</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">updating_device</span><span class="o">.</span><span class="n">is_device_valid</span><span class="p">(),</span>
                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span>
                    <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="unresponsive_device_with_check"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.unresponsive_device_with_check">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unresponsive_device_with_check</span><span class="p">(</span><span class="n">unique_platform_devices</span><span class="p">,</span> <span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.unique_platform_devices`</span>
<span class="sd">    uuid on which a &#39;ReportUnresponsiveDevice&#39; UPnP action is called with param</span>
<span class="sd">    &#39;VerifyThenRemoveSystemwide&#39;. Yields uuid of that device from</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_devices`.</span>
<span class="sd">    :raise: UPNP_ERROR_800_DEVICE_RESPONSIVE</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vd_uuid</span> <span class="o">=</span> <span class="n">unique_platform_devices</span><span class="o">.</span><span class="n">raw_udn</span>
    <span class="c1"># get a device from where UPnP action will be called.</span>
    <span class="n">zp</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span> <span class="k">if</span> <span class="n">zp</span> <span class="o">!=</span> <span class="n">unique_platform_devices</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">ZoneGroupTopology</span><span class="o">.</span><span class="n">ReportUnresponsiveDevice</span><span class="p">(</span>
            <span class="n">vd_uuid</span><span class="p">,</span>
            <span class="s1">&#39;VerifyThenRemoveSystemwide&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UPnPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># we expect upnp error here since the device is there in topology</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">upnp_error</span> <span class="o">==</span> <span class="n">UPNP_ERROR_800_DEVICE_RESPONSIVE</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">vd_uuid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="unresponsive_device_without_check"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.unresponsive_device_without_check">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unresponsive_device_without_check</span><span class="p">(</span><span class="n">a_fenway_or_newer_device</span><span class="p">,</span> <span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a :func:`~pytest_automation.pytest_sonos_device_selection.fenway_or_newer_device`</span>
<span class="sd">    uuid  on which a &#39;ReportUnresponsiveDevice&#39; UPnP action is called with</span>
<span class="sd">    param &#39;Remove&#39; and caller device. Yields uuid of that device from</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_devices`.</span>
<span class="sd">    :raise: UPNP_ERROR_402_INVALID_ARGUMENTS</span>
<span class="sd">    :raise: UPNP_ERROR_800_DEVICE_RESPONSIVE</span>

<span class="sd">    .. note::</span>

<span class="sd">        Vanished list is not supported on &lt;=32MB players.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get any device other than &#39;a_fenway_or_newer_device&#39;</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="o">!=</span>
               <span class="n">a_fenway_or_newer_device</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">):</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Need at least 2 devices in testbed&quot;</span><span class="p">)</span>
    <span class="n">vanished_device</span> <span class="o">=</span> <span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">vanished_device_uuid</span> <span class="o">=</span> <span class="n">vanished_device</span><span class="o">.</span><span class="n">raw_udn</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">a_fenway_or_newer_device</span><span class="o">.</span><span class="n">ZoneGroupTopology</span><span class="o">.</span><span class="n">ReportUnresponsiveDevice</span><span class="p">(</span>
            <span class="n">vanished_device_uuid</span><span class="p">,</span>
            <span class="s1">&#39;Remove&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UPnPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># we don&#39;t expect upnp error</span>
        <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">vanished_device_uuid</span><span class="p">,</span> <span class="n">a_fenway_or_newer_device</span>
    <span class="n">vanished_device</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">()</span>
    <span class="n">guaranteed_sleep</span><span class="p">(</span><span class="n">AGGRESSIVE_ADVERTISE_TIME</span><span class="p">)</span></div>


<div class="viewcode-block" id="suspended_portable_device_uuid"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.suspended_portable_device_uuid">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">suspended_portable_device_uuid</span><span class="p">(</span><span class="n">a_unique_power_managed_portable_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a power managed device which is yielded in suspended state</span>
<span class="sd">    :func:`pytest_automation.pytest_sonos_device_selection</span>
<span class="sd">        .a_unique_power_managed_portable_device`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pow_man_port_dev</span> <span class="o">=</span> <span class="n">a_unique_power_managed_portable_device</span>
    <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">off</span><span class="p">()</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">is_discharging</span><span class="p">(),</span>
                    <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">spoof_suspend</span><span class="p">()</span>
    <span class="n">wait_until_true</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">raw_udn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Devices</span><span class="p">()</span><span class="o">.</span><span class="n">allDevices</span><span class="p">,</span>
        <span class="n">start_delay</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Device suspended&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">raw_udn</span>
    <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">is_charging</span><span class="p">(),</span>
                    <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">wait_until_true</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">does_status_page_exist</span><span class="p">(),</span>
        <span class="n">start_delay</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span></div>


<div class="viewcode-block" id="gc_and_portable_gm_pair"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.gc_and_portable_gm_pair">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">gc_and_portable_gm_pair</span><span class="p">(</span><span class="n">a_unique_power_managed_portable_device</span><span class="p">,</span>
                            <span class="n">all_fenway_or_newer_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a pair of GC and a GM that is a power managed portable device</span>
<span class="sd">    :func:`pytest_automation.pytest_sonos_device_selection</span>
<span class="sd">        .a_unique_power_managed_portable_device`</span>
<span class="sd">    :func:`pytest_automation.pytest_sonos_device_selection</span>
<span class="sd">        .all_fenway_or_newer_devices`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_fenway_or_newer_devices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Need atleast 2 devices for this test&quot;</span><span class="p">)</span>

    <span class="n">gc</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_fenway_or_newer_devices</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span> <span class="o">!=</span>
          <span class="n">a_unique_power_managed_portable_device</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">yield</span> <span class="n">gc</span><span class="p">,</span> <span class="n">a_unique_power_managed_portable_device</span></div>


<div class="viewcode-block" id="suspended_portable_gm_and_gc_pair"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.suspended_portable_gm_and_gc_pair">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">suspended_portable_gm_and_gc_pair</span><span class="p">(</span><span class="n">gc_and_portable_gm_pair</span><span class="p">,</span> <span class="n">ap</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a pair of GC and GM. . The GC is setup to play from share. GM is</span>
<span class="sd">    portable and in suspended state.</span>
<span class="sd">    :param gc_and_portable_gm_pair: Fixture that yields gc and portable gm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gc</span><span class="p">,</span> <span class="n">portable_device</span> <span class="o">=</span> <span class="n">gc_and_portable_gm_pair</span>

    <span class="c1"># The portable needs to be connected to Wifi in order to recieve the WoW event</span>
    <span class="n">ntw_manager</span> <span class="o">=</span> <span class="n">NetworkManager</span><span class="p">(</span><span class="n">portable_device</span><span class="p">,</span> <span class="n">ap</span><span class="p">)</span>
    <span class="n">ntw_manager</span><span class="o">.</span><span class="n">setup_player_in_wifi_mode</span><span class="p">()</span>

    <span class="n">portable_device</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
    <span class="n">gc_mp</span> <span class="o">=</span> <span class="n">MediaPlayer</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">SHARE</span><span class="p">)</span>
    <span class="n">gc_mp</span><span class="o">.</span><span class="n">setup_for_playback</span><span class="p">()</span>
    <span class="n">suspend_portable_device</span><span class="p">(</span><span class="n">portable_device</span><span class="p">)</span>
    <span class="n">guaranteed_sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">(</span><span class="n">portable_device</span><span class="p">,</span> <span class="n">gc_mp</span><span class="p">,</span> <span class="n">gc</span><span class="p">)</span>
    <span class="n">bring_up_suspended_player</span><span class="p">(</span><span class="n">portable_device</span><span class="p">)</span>
    <span class="n">portable_device</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">leave_group</span><span class="p">()</span>
    <span class="n">ntw_manager</span><span class="o">.</span><span class="n">return_player_to_wired_mode</span><span class="p">()</span>
    <span class="n">gc_mp</span><span class="o">.</span><span class="n">stop_playback_and_tear_down</span><span class="p">()</span></div>


<div class="viewcode-block" id="a_portable_power_managed_device_stereo_pair"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.a_portable_power_managed_device_stereo_pair">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_portable_power_managed_device_stereo_pair</span><span class="p">(</span><span class="n">all_stereo_pairable_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a portable device stereo pair.</span>
<span class="sd">    :param all_stereo_pairable_devices: Fixture that yields all stereo</span>
<span class="sd">        pairable devices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">portable_power_managed_device_stereo_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">all_stereo_pairable_devices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">in</span> <span class="n">PORTABLE_DEVICES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">power</span> <span class="ow">and</span> <span class="n">right</span><span class="o">.</span><span class="n">power</span><span class="p">:</span>
                <span class="n">portable_power_managed_device_stereo_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">portable_power_managed_device_stereo_pairs</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Need at least 1 stereo pairable, power managed portable &quot;</span>
                    <span class="s2">&quot;devices set&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">portable_power_managed_device_stereo_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="suspended_right_in_portable_stereo_pair"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.suspended_right_in_portable_stereo_pair">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">suspended_right_in_portable_stereo_pair</span><span class="p">(</span>
                                   <span class="n">a_portable_power_managed_device_stereo_pair</span><span class="p">,</span> <span class="n">ap</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields a stereo pair whose right member is in suspended state. The left</span>
<span class="sd">    member is setup for playback from share.</span>
<span class="sd">    :param a_portable_power_managed_device_stereo_pair: Fixture that yields a</span>
<span class="sd">    stereo pair whose members are portable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">a_portable_power_managed_device_stereo_pair</span>

    <span class="c1"># Enable WiFi on both portables</span>
    <span class="n">left_ntw_manager</span> <span class="o">=</span> <span class="n">NetworkManager</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">ap</span><span class="p">)</span>
    <span class="n">right_ntw_manager</span> <span class="o">=</span> <span class="n">NetworkManager</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">ap</span><span class="p">)</span>
    <span class="n">left_ntw_manager</span><span class="o">.</span><span class="n">setup_player_in_wifi_mode</span><span class="p">()</span>
    <span class="n">right_ntw_manager</span><span class="o">.</span><span class="n">setup_player_in_wifi_mode</span><span class="p">()</span>

    <span class="n">left</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">add_stereo_pair</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
    <span class="n">left_mp</span> <span class="o">=</span> <span class="n">MediaPlayer</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">SHARE</span><span class="p">)</span>
    <span class="n">left_mp</span><span class="o">.</span><span class="n">setup_for_playback</span><span class="p">()</span>
    <span class="n">suspend_portable_device</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
    <span class="n">guaranteed_sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">left_mp</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
    <span class="n">bring_up_suspended_player</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
    <span class="n">left</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">remove_stereo_pair</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
    <span class="n">left_ntw_manager</span><span class="o">.</span><span class="n">return_player_to_wired_mode</span><span class="p">()</span>
    <span class="n">right_ntw_manager</span><span class="o">.</span><span class="n">return_player_to_wired_mode</span><span class="p">()</span>
    <span class="n">left_mp</span><span class="o">.</span><span class="n">stop_playback_and_tear_down</span><span class="p">()</span></div>


<div class="viewcode-block" id="powered_off_portable_device_uuid"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.powered_off_portable_device_uuid">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">powered_off_portable_device_uuid</span><span class="p">(</span><span class="n">a_unique_power_managed_portable_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a power managed device which is yielded in suspended state</span>
<span class="sd">    :func:`pytest_automation.pytest_sonos_device_selection</span>
<span class="sd">        .a_unique_power_managed_portable_device`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pow_man_port_dev</span> <span class="o">=</span> <span class="n">a_unique_power_managed_portable_device</span>
    <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">off</span><span class="p">()</span>
    <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">spoof_poweroff</span><span class="p">()</span>
    <span class="n">wait_until_true</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">raw_udn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Devices</span><span class="p">()</span><span class="o">.</span><span class="n">allDevices</span><span class="p">,</span>
        <span class="n">start_delay</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Device Powered off&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">raw_udn</span>
    <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>
    <span class="n">wait_until_true</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">pow_man_port_dev</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">does_status_page_exist</span><span class="p">(),</span>
        <span class="n">start_delay</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span></div>


<div class="viewcode-block" id="spoof_swgen"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.spoof_swgen">[docs]</a><span class="k">def</span> <span class="nf">spoof_swgen</span><span class="p">(</span><span class="n">zp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spoof swgen on zone player</span>
<span class="sd">    :param zp: Sonos Zone Component</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">threshold_version</span> <span class="o">=</span> <span class="n">SWGEN_THRESHOLD_VERSION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">major</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_spoofed_sw_gen_num</span><span class="p">(</span><span class="n">SWGEN_QUAR</span><span class="p">,</span> <span class="n">threshold_version</span><span class="p">)</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">set_spoofed_firmware_version_and_wait</span><span class="p">(</span><span class="n">threshold_version</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">sw_generation</span><span class="p">)</span> <span class="o">==</span> <span class="n">SWGEN_QUAR</span></div>


<div class="viewcode-block" id="remove_spoofing_swgen"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.remove_spoofing_swgen">[docs]</a><span class="k">def</span> <span class="nf">remove_spoofing_swgen</span><span class="p">(</span><span class="n">zp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rmoved swgen spooginf</span>
<span class="sd">    :param zp: Sonos Zone Component</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">set_spoofed_firmware_version_and_wait</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">clear_spoofed_sw_gen_num</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">sw_generation</span><span class="p">)</span> <span class="o">==</span> <span class="n">SWGEN_DEFAULT</span></div>


<div class="viewcode-block" id="quarantined_device"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.quarantined_device">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">quarantined_device</span><span class="p">(</span><span class="n">unique_platform_devices</span><span class="p">,</span> <span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields a</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.unique_platform_devices`</span>
<span class="sd">    quarantined device from</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_devices` by</span>
<span class="sd">    spoofing its swgen.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spoof_swgen</span><span class="p">(</span><span class="n">unique_platform_devices</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">unique_platform_devices</span>
    <span class="n">remove_spoofing_swgen</span><span class="p">(</span><span class="n">unique_platform_devices</span><span class="p">)</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span>
        <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">ZoneGroupTopology</span><span class="o">.</span><span class="n">get_quarantined_device_uuids</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>
             <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span><span class="p">]),</span>
                    <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>


<div class="viewcode-block" id="a_quarantined_device"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.a_quarantined_device">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_quarantined_device</span><span class="p">(</span><span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields a random quarantined device from</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_devices` by</span>
<span class="sd">    spoofing its swgen.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a_device</span> <span class="o">=</span> <span class="n">all_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spoof_swgen</span><span class="p">(</span><span class="n">a_device</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">a_device</span>
    <span class="n">remove_spoofing_swgen</span><span class="p">(</span><span class="n">a_device</span><span class="p">)</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span>
        <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">ZoneGroupTopology</span><span class="o">.</span><span class="n">get_quarantined_device_uuids</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>
             <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span><span class="p">]),</span>
                    <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>


<div class="viewcode-block" id="a_vanished_device"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.a_vanished_device">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_vanished_device</span><span class="p">(</span><span class="n">a_device</span><span class="p">,</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields a device from</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_fenway_or_newer_devices`</span>
<span class="sd">    and not</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.a_device`</span>
<span class="sd">    whose anacapad is stopped gracefully.</span>

<span class="sd">    ..note::</span>

<span class="sd">        Vanish list is supported only on fenway or newer devices.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vanish_device</span> <span class="o">=</span> <span class="n">a_device</span>
    <span class="n">vanish_device</span><span class="o">.</span><span class="n">stop_anacapa</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">vanish_device</span><span class="o">.</span><span class="n">raw_udn</span> <span class="ow">in</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_vanished_zp_uuids</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_fenway_or_newer_devices</span>
                <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="o">!=</span> <span class="n">vanish_device</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">])</span>
    <span class="k">yield</span> <span class="n">vanish_device</span>
    <span class="n">vanish_device</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">vanish_device</span><span class="o">.</span><span class="n">raw_udn</span> <span class="ow">in</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_vanished_zp_uuids</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_fenway_or_newer_devices</span>
                    <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="o">!=</span> <span class="n">vanish_device</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">])</span></div>


<div class="viewcode-block" id="vanished_to_quarantined_device"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.vanished_to_quarantined_device">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vanished_to_quarantined_device</span><span class="p">(</span><span class="n">a_vanished_device</span><span class="p">,</span> <span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields a quarantined device from</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_devices`</span>
<span class="sd">    by spoofing its swgen which was previously using the</span>
<span class="sd">    :func:`~pytest_automation.player.topology.conftest.a_vanished_device`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">major_version</span> <span class="o">=</span> <span class="n">a_vanished_device</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">major</span>
    <span class="n">threshold_version</span> <span class="o">=</span> <span class="n">SWGEN_THRESHOLD_VERSION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">major_version</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">a_vanished_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_spoofed_sw_gen_num</span><span class="p">(</span><span class="n">SWGEN_QUAR</span><span class="p">,</span> <span class="n">threshold_version</span><span class="p">)</span>
    <span class="n">a_vanished_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_spoofed_version</span><span class="p">(</span><span class="n">threshold_version</span><span class="p">)</span>
    <span class="n">a_vanished_device</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">a_vanished_device</span><span class="o">.</span><span class="n">sw_generation</span><span class="p">)</span> <span class="o">==</span> <span class="n">SWGEN_QUAR</span>
    <span class="k">yield</span> <span class="n">a_vanished_device</span>
    <span class="n">remove_spoofing_swgen</span><span class="p">(</span><span class="n">a_vanished_device</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">ZoneGroupTopology</span><span class="o">.</span><span class="n">get_quarantined_device_uuids</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>
                 <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span><span class="p">]))</span></div>


<div class="viewcode-block" id="quarantined_and_vanished_device"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.quarantined_and_vanished_device">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">quarantined_and_vanished_device</span><span class="p">(</span><span class="n">a_quarantined_device</span><span class="p">,</span> <span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spoofs firmware version on</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.a_quarantined_device`</span>
<span class="sd">    such that its SwGen is overridden.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a_quarantined_device</span><span class="o">.</span><span class="n">stop_anacapa</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">a_quarantined_device</span>
    <span class="n">a_quarantined_device</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">()</span></div>


<div class="viewcode-block" id="quarantined_playback_device"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.quarantined_playback_device">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">quarantined_playback_device</span><span class="p">(</span><span class="n">a_playback_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.a_playback_device`</span>
<span class="sd">    that will be quarantined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spoof_swgen</span><span class="p">(</span><span class="n">a_playback_device</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">a_playback_device</span>
    <span class="n">remove_spoofing_swgen</span><span class="p">(</span><span class="n">a_playback_device</span><span class="p">)</span></div>


<div class="viewcode-block" id="quarantined_and_normal_device_pair"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.quarantined_and_normal_device_pair">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">quarantined_and_normal_device_pair</span><span class="p">(</span><span class="n">quarantined_playback_device</span><span class="p">,</span>
                                       <span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields</span>
<span class="sd">    :func:`~pytest_automation.player.topology.</span>
<span class="sd">        conftest.quarantined_playback_device`</span>
<span class="sd">    and a normal device from</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_devices`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normal_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span>
                      <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="o">!=</span> <span class="n">quarantined_playback_device</span><span class="o">.</span><span class="n">raw_udn</span> <span class="ow">and</span>
                         <span class="n">zp</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">normal_devices</span><span class="p">):</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Not enough playback devices&quot;</span><span class="p">)</span>
    <span class="n">normal_device</span> <span class="o">=</span> <span class="n">normal_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">yield</span> <span class="n">quarantined_playback_device</span><span class="p">,</span> <span class="n">normal_device</span></div>


<div class="viewcode-block" id="a_playing_device"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.a_playing_device">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_playing_device</span><span class="p">(</span><span class="n">a_playback_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.a_playback_device`</span>
<span class="sd">    with playback.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">playing_device</span> <span class="o">=</span> <span class="n">MediaPlayer</span><span class="p">(</span><span class="n">a_playback_device</span><span class="p">,</span> <span class="n">SHARE</span><span class="p">)</span>
    <span class="n">playing_device</span><span class="o">.</span><span class="n">setup_and_start_playback</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">a_playback_device</span>
    <span class="n">playing_device</span><span class="o">.</span><span class="n">stop_playback_and_tear_down</span><span class="p">()</span></div>


<div class="viewcode-block" id="quarantined_and_playing_device_pair"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.quarantined_and_playing_device_pair">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">quarantined_and_playing_device_pair</span><span class="p">(</span><span class="n">a_playing_device</span><span class="p">,</span> <span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields</span>
<span class="sd">    :func:`~pytest_automation.player.topology.conftest.a_playing_device`</span>
<span class="sd">    and a quarantined device from</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.all_devices`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normal_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span>
                      <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="o">!=</span> <span class="n">a_playing_device</span><span class="o">.</span><span class="n">raw_udn</span> <span class="ow">and</span>
                         <span class="n">zp</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">normal_devices</span><span class="p">):</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Not enough playback devices&quot;</span><span class="p">)</span>
    <span class="n">quar_device</span> <span class="o">=</span> <span class="n">normal_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spoof_swgen</span><span class="p">(</span><span class="n">quar_device</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">quar_device</span><span class="p">,</span> <span class="n">a_playing_device</span>
    <span class="n">remove_spoofing_swgen</span><span class="p">(</span><span class="n">quar_device</span><span class="p">)</span></div>


<div class="viewcode-block" id="quarantined_device_with_settings"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.quarantined_device_with_settings">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">quarantined_device_with_settings</span><span class="p">(</span><span class="n">a_quarantined_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.a_quarantined_device`</span>
<span class="sd">    with SetString UPnP action performed on it along with key and value pair.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">a_quarantined_device</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">SetString</span><span class="p">(</span><span class="n">KEY</span><span class="p">,</span> <span class="n">VALUE</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">assert</span> <span class="n">a_quarantined_device</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">KEY</span><span class="p">)</span> <span class="o">==</span> <span class="n">VALUE</span>
    <span class="k">yield</span> <span class="n">a_quarantined_device</span><span class="p">,</span> <span class="n">KEY</span><span class="p">,</span> <span class="n">VALUE</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">a_quarantined_device</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">KEY</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">a_quarantined_device</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">KEY</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UPnPError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Expect string to be removed&quot;</span></div>


<div class="viewcode-block" id="diagnostics_with_quarantined_device_info"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.diagnostics_with_quarantined_device_info">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">diagnostics_with_quarantined_device_info</span><span class="p">(</span><span class="n">a_quarantined_device</span><span class="p">,</span>
                                             <span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields</span>
<span class="sd">    :func:`~pytest_automation.pytest_sonos_device_selection.a_quarantined_device`</span>
<span class="sd">    and diagnostics xml element</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diag_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_devices</span> <span class="k">if</span>
                   <span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span> <span class="o">!=</span> <span class="n">a_quarantined_device</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">diag_devices</span><span class="p">):</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Need at least two devices for this test&quot;</span><span class="p">)</span>
    <span class="n">diag_device</span> <span class="o">=</span> <span class="n">diag_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">REVIEW_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diag_device</span><span class="o">.</span><span class="n">ip</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="c1"># encode in utf-8 so that diag can be written to a file.</span>
    <span class="n">raw_diag</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">RAW_DIAG_FILE</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_diag</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">RAW_DIAG_FILE</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">root</span><span class="p">,</span> <span class="n">a_quarantined_device</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">RAW_DIAG_FILE</span><span class="p">)</span></div>


<div class="viewcode-block" id="suspend_portable_device"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.suspend_portable_device">[docs]</a><span class="k">def</span> <span class="nf">suspend_portable_device</span><span class="p">(</span><span class="n">device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Suspends the given portable device</span>
<span class="sd">    :param :class:`sonos.client.internal.SonosZoneComponent` device: Device</span>
<span class="sd">    to be suspended.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">off</span><span class="p">()</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">is_discharging</span><span class="p">(),</span>
                    <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">spoof_suspend</span><span class="p">()</span>
    <span class="n">wait_until_true</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">device</span><span class="o">.</span><span class="n">raw_udn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Devices</span><span class="p">()</span><span class="o">.</span><span class="n">allDevices</span><span class="p">,</span>
            <span class="n">start_delay</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Device suspended: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">device</span><span class="p">))</span></div>


<div class="viewcode-block" id="bring_up_suspended_player"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.conftest.bring_up_suspended_player">[docs]</a><span class="k">def</span> <span class="nf">bring_up_suspended_player</span><span class="p">(</span><span class="n">device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Brings up a suspended device.</span>
<span class="sd">    :param :class:`sonos.client.internal.SonosZoneComponent` device: Device</span>
<span class="sd">    to be brought up from suspended state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">is_charging</span><span class="p">(),</span>
                    <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">wait_until_true</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">does_status_page_exist</span><span class="p">(),</span>
        <span class="n">start_delay</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>