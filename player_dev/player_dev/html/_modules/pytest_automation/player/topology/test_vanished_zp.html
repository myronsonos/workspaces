
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pytest_automation.player.topology.test_vanished_zp &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pytest_automation.player.topology.test_vanished_zp</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">common</span> <span class="k">import</span> <span class="n">SET_EXPIRATION_TIMEOUT</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="ne">TimeoutError</span>

<span class="n">EXPIRY_DELTA_VALUE</span> <span class="o">=</span> <span class="mi">90</span>
<span class="n">pytestmark</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;wait_for_testbed_on_active_list&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="test_vanishing_zp_graceful_anacapa_shutdown"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.test_vanished_zp.test_vanishing_zp_graceful_anacapa_shutdown">[docs]</a><span class="k">def</span> <span class="nf">test_vanishing_zp_graceful_anacapa_shutdown</span><span class="p">(</span><span class="n">vanish_device_gracefully</span><span class="p">,</span>
                                                <span class="n">all_fenway_or_newer_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify when a zp goes down gracefully, its UUID is added to vanished list</span>
<span class="sd">    and removed from active list in topology</span>
<span class="sd">    Steps:</span>
<span class="sd">    1. Shutdown anacapa on a device gracefully (vanished zp).</span>
<span class="sd">    2. Access topology status page on all active zps in HH and get list of</span>
<span class="sd">    active and vanished devices.</span>
<span class="sd">    3. Assert vanished zp is part of vanished list devices in topology</span>
<span class="sd">    4. Assert vanished zp is NOT part of active list of devices in topology</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vanished_master_list</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">active_master_list</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="o">==</span> <span class="n">vanish_device_gracefully</span><span class="p">:</span>
            <span class="n">vanished_master_list</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_vanished_zp_uuids</span><span class="p">()</span>
            <span class="n">active_master_list</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_active_zp_uuids</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">vanish_device_gracefully</span> <span class="ow">in</span> <span class="n">vanished_master_list</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="k">for</span>
                <span class="n">uuid</span> <span class="ow">in</span> <span class="n">vanished_master_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">vanish_device_gracefully</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">active_master_list</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="k">for</span>
                <span class="n">uuid</span> <span class="ow">in</span> <span class="n">active_master_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="n">active_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_fenway_or_newer_devices</span>
                      <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="o">!=</span> <span class="n">vanish_device_gracefully</span><span class="p">]</span>
    <span class="n">verify_vanished_reason</span><span class="p">(</span><span class="n">vanish_device_gracefully</span><span class="p">,</span>
                           <span class="n">active_devices</span><span class="p">,</span>
                           <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_vanishing_zp_ungraceful_anacapa_shutdown"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.test_vanished_zp.test_vanishing_zp_ungraceful_anacapa_shutdown">[docs]</a><span class="k">def</span> <span class="nf">test_vanishing_zp_ungraceful_anacapa_shutdown</span><span class="p">(</span><span class="n">vanish_device_ungracefully</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify when a zp goes down ungracefully, its UUID is added to vanished list</span>
<span class="sd">    and removed from active list in topology</span>
<span class="sd">    :param vanish_device_ungracefully: Fixture that returns uuid of device</span>
<span class="sd">    that is brought down and list of all active/fenway or newer devices.</span>
<span class="sd">    Steps:</span>
<span class="sd">    1. Shutdown anacapa on a device ungracefully (vanished zp).</span>
<span class="sd">    1a. Run expireactiveplayer testpoint on all active players</span>
<span class="sd">    2. Access topology status page on all active zps in HH and get list of</span>
<span class="sd">    active and vanished devices.</span>
<span class="sd">    3. Assert vanished zp is part of vanished list devices in topology</span>
<span class="sd">    4. Assert vanished zp is NOT part of active list of devices in topology</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vanished_device_uuid</span><span class="p">,</span> <span class="n">active_devices</span> <span class="o">=</span> <span class="n">vanish_device_ungracefully</span>
    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">active_devices</span><span class="p">:</span>
        <span class="n">wait_for_uuid_in_vanished_list</span><span class="p">(</span><span class="n">vanished_device_uuid</span><span class="p">,</span> <span class="n">zp</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">vanished_device_uuid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_active_zp_uuids</span><span class="p">()</span>
    <span class="n">verify_vanished_reason</span><span class="p">(</span><span class="n">vanished_device_uuid</span><span class="p">,</span>
                           <span class="n">active_devices</span><span class="p">,</span>
                           <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;zp expired&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_vanishing_send_ReportDeviceUnrespoinsive_with_check"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.test_vanished_zp.test_vanishing_send_ReportDeviceUnrespoinsive_with_check">[docs]</a><span class="k">def</span> <span class="nf">test_vanishing_send_ReportDeviceUnrespoinsive_with_check</span><span class="p">(</span>
        <span class="n">unresponsive_device_with_check</span><span class="p">,</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify when making a UPnP call &#39;ReportDeviceUnrespoinsive&#39; with param</span>
<span class="sd">    &quot;CheckandRemoveSystemWide&quot; on a target device that is present in topology</span>
<span class="sd">    does not add the device to vanished list.</span>
<span class="sd">    Steps:</span>
<span class="sd">    1. Pick a device that does the UPnP call and a device on which the</span>
<span class="sd">    action is called.</span>
<span class="sd">    2. Make UPnP Call. Expect 800 UPnP Error if target device is present in</span>
<span class="sd">    topology.</span>
<span class="sd">    3. Assert vanished list is empty.</span>
<span class="sd">    4. Assert &#39;unresponsive&#39; device is present in active device list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vanished_master_list</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">active_master_list</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_fenway_or_newer_devices</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="o">==</span> <span class="n">unresponsive_device_with_check</span><span class="p">:</span>
            <span class="n">vanished_master_list</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_vanished_zp_uuids</span><span class="p">()</span>
            <span class="n">active_master_list</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_active_zp_uuids</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">vanished_master_list</span><span class="p">[</span><span class="n">uuid</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span>
                <span class="n">uuid</span> <span class="ow">in</span> <span class="n">vanished_master_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">unresponsive_device_with_check</span> <span class="ow">in</span> <span class="n">active_master_list</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="k">for</span>
                <span class="n">uuid</span> <span class="ow">in</span> <span class="n">active_master_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span></div>


<div class="viewcode-block" id="test_vanishing_send_ReportDeviceUnrespoinsive_without_check"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.test_vanished_zp.test_vanishing_send_ReportDeviceUnrespoinsive_without_check">[docs]</a><span class="k">def</span> <span class="nf">test_vanishing_send_ReportDeviceUnrespoinsive_without_check</span><span class="p">(</span>
        <span class="n">unresponsive_device_without_check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify when making a UPnP call &#39;ReportDeviceUnrespoinsive&#39; with param</span>
<span class="sd">    &quot;Remove&quot; on a target device that is present in topology, the target</span>
<span class="sd">    device is removed from active list in topology and moved to vanished list.</span>
<span class="sd">    Steps:</span>
<span class="sd">    1. Pick a device that does the UPnP call and a target device on which the</span>
<span class="sd">    action is called.</span>
<span class="sd">    2. Make UPnP Call.</span>
<span class="sd">    3. Assert vanished list has the target device.</span>
<span class="sd">    4. Assert target &#39;unresponsive&#39; device is not present in active device list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vanished_device_uuid</span><span class="p">,</span> <span class="n">unique_platform_device</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">unresponsive_device_without_check</span><span class="p">)</span>
    <span class="n">active_uuids</span> <span class="o">=</span> <span class="n">unique_platform_device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_active_zp_uuids</span><span class="p">()</span>
    <span class="n">wait_for_uuid_in_vanished_list</span><span class="p">(</span><span class="n">vanished_device_uuid</span><span class="p">,</span>
                                   <span class="n">unique_platform_device</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">vanished_device_uuid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">active_uuids</span></div>


<div class="viewcode-block" id="test_vanishing_zp_clear"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.test_vanished_zp.test_vanishing_zp_clear">[docs]</a><span class="k">def</span> <span class="nf">test_vanishing_zp_clear</span><span class="p">(</span><span class="n">vanished_and_active_device_pair</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify a device is removed from vanished list on timer expiry.</span>
<span class="sd">    Note: the expiry time for a device in vanish list is 72 hours. For</span>
<span class="sd">    purpose of automation, the timer is set to &#39;EXPIRY_DELTA_VALUE&#39; using a</span>
<span class="sd">    testpoint after which &#39;expiry&#39; job is triggered which removed the device</span>
<span class="sd">    from vanish.</span>
<span class="sd">    Steps:</span>
<span class="sd">    1. Get a pair of active and vanished device</span>
<span class="sd">    2. Assert vanished device is in vanished list in topology.</span>
<span class="sd">    3. Hit testpoint with EXPIRY_DELTA_VALUE on active device with uuid of</span>
<span class="sd">    vanished device</span>
<span class="sd">    4. Verify vanished device uuid is removed from vanished list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vanished_device</span><span class="p">,</span> <span class="n">active_device</span> <span class="o">=</span> <span class="n">vanished_and_active_device_pair</span>
    <span class="k">if</span> <span class="n">active_device</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">is_release_version</span><span class="p">():</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;No testpoint support skipping test&quot;</span><span class="p">)</span>
    <span class="n">vanish_device_uuid</span> <span class="o">=</span> <span class="n">vanished_device</span><span class="o">.</span><span class="n">raw_udn</span>
    <span class="k">assert</span> <span class="n">vanish_device_uuid</span> <span class="ow">in</span> <span class="n">active_device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_vanished_zp_uuids</span><span class="p">(),</span> <span class="p">(</span>
        <span class="s2">&quot;Expect </span><span class="si">{}</span><span class="s2"> to be in vanished list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vanished_device</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">active_device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">fire_expiry_timed_job</span><span class="p">(</span><span class="n">vanished_device</span><span class="p">,</span>
                                                    <span class="n">EXPIRY_DELTA_VALUE</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;Device Expiry time job fired &quot;</span><span class="p">)</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">vanish_device_uuid</span> <span class="ow">not</span> <span class="ow">in</span>
                            <span class="n">active_device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_vanished_zp_uuids</span><span class="p">(),</span>
                    <span class="n">start_delay</span><span class="o">=</span><span class="n">EXPIRY_DELTA_VALUE</span><span class="p">,</span>
                    <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> in vanished list after expiry time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">vanish_device_uuid</span><span class="p">))</span></div>


<div class="viewcode-block" id="test_vanish_zp_reappearance"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.test_vanished_zp.test_vanish_zp_reappearance">[docs]</a><span class="k">def</span> <span class="nf">test_vanish_zp_reappearance</span><span class="p">(</span><span class="n">vanished_and_active_device_pair</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify when a device in vanished state reappears, the device is removed</span>
<span class="sd">    from vanished list and put into active list in topology.</span>
<span class="sd">    Steps:</span>
<span class="sd">    1. Get a pair of active and vanished device</span>
<span class="sd">    2. Assert vanished device is in vanished list in topology.</span>
<span class="sd">    3. Bring up vanished device and wait for all services</span>
<span class="sd">    4. Assert vanished device is removed from vanished list</span>
<span class="sd">    5. Assert vanished device is added to active list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vanished_device</span><span class="p">,</span> <span class="n">active_device</span> <span class="o">=</span> <span class="n">vanished_and_active_device_pair</span>
    <span class="n">vanish_device_uuid</span> <span class="o">=</span> <span class="n">vanished_device</span><span class="o">.</span><span class="n">raw_udn</span>
    <span class="k">assert</span> <span class="n">vanish_device_uuid</span> <span class="ow">in</span> <span class="n">active_device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_vanished_zp_uuids</span><span class="p">()</span>
    <span class="n">vanished_device</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">()</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">vanished_device</span><span class="o">.</span><span class="n">is_device_valid</span><span class="p">())</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">vanish_device_uuid</span> <span class="ow">not</span> <span class="ow">in</span>
                            <span class="n">active_device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_vanished_zp_uuids</span><span class="p">(),</span>
                    <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Expect </span><span class="si">{}</span><span class="s2"> not in vanished list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">vanished_device</span><span class="p">))</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">vanish_device_uuid</span> <span class="ow">in</span>
                        <span class="n">active_device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_active_zp_uuids</span><span class="p">(),</span>
                    <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Expect </span><span class="si">{}</span><span class="s2"> in active device list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">vanished_device</span><span class="p">))</span></div>


<div class="viewcode-block" id="test_vanish_zp_on_update"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.test_vanished_zp.test_vanish_zp_on_update">[docs]</a><span class="k">def</span> <span class="nf">test_vanish_zp_on_update</span><span class="p">(</span><span class="n">updating_and_active_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify when a device vanishes due to upgrade, the device is added to</span>
<span class="sd">    vanished list with correct &#39;reasonforvanish&#39; value.</span>
<span class="sd">    Steps:</span>
<span class="sd">    1. Perform upgrade on a device and wait for upnp bye bye</span>
<span class="sd">    2. Assert the vanished device uuid exist in vanished list.</span>
<span class="sd">    3. Assert the &#39;reasonforvanish&#39; is &#39;upgrade&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vanish_device_uuid</span><span class="p">,</span> <span class="n">active_device</span> <span class="o">=</span> <span class="n">updating_and_active_device</span>
    <span class="n">wait_for_uuid_in_vanished_list</span><span class="p">(</span><span class="n">vanish_device_uuid</span><span class="p">,</span> <span class="n">active_device</span><span class="p">)</span>
    <span class="n">verify_vanished_reason</span><span class="p">(</span><span class="n">vanish_device_uuid</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">active_device</span><span class="p">],</span>
                           <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;upgrade&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="test_vanish_zp_portable_on_suspend"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.test_vanished_zp.test_vanish_zp_portable_on_suspend">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;skip_if_no_powered_managed_portable_devices&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_vanish_zp_portable_on_suspend</span><span class="p">(</span><span class="n">suspended_portable_device_uuid</span><span class="p">,</span>
                                       <span class="n">all_fenway_or_newer_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify when a portable device suspends, it is added as vanished device on</span>
<span class="sd">    active devices in HH with correct reason</span>
<span class="sd">    :param vanished_portable_device:</span>
<span class="sd">    Steps:</span>
<span class="sd">    1. Suspend a portable device</span>
<span class="sd">    2. Access topology status page on all active zps in HH and get list of</span>
<span class="sd">    active and vanished devices.</span>
<span class="sd">    3. Assert vanished portable zp is part of vanished list devices in topology</span>
<span class="sd">    4. Assert reason for vanish is &#39;sleeping&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">active_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_fenway_or_newer_devices</span>
                      <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="o">!=</span> <span class="n">suspended_portable_device_uuid</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">active_devices</span><span class="p">:</span>
        <span class="n">wait_for_uuid_in_vanished_list</span><span class="p">(</span><span class="n">suspended_portable_device_uuid</span><span class="p">,</span> <span class="n">zp</span><span class="p">)</span>
    <span class="n">verify_vanished_reason</span><span class="p">(</span><span class="n">suspended_portable_device_uuid</span><span class="p">,</span>
                           <span class="n">active_devices</span><span class="p">,</span>
                           <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;sleeping&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_zone_aging_on_expiration"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.test_vanished_zp.test_zone_aging_on_expiration">[docs]</a><span class="k">def</span> <span class="nf">test_zone_aging_on_expiration</span><span class="p">(</span>
                    <span class="n">vanished_device_and_device_with_set_expiration_timeout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify when a zp goes down ungracefully, an active device ages out the</span>
<span class="sd">    vanished device and moves it from its active list to vanished list in its</span>
<span class="sd">    topology upon expiration timeout.</span>
<span class="sd">    :param vanished_device_and_device_with_set_expiration_timeout: Fixture that</span>
<span class="sd">    returns uuid of device and an active device on which expiration</span>
<span class="sd">    timeout is set.</span>
<span class="sd">    Steps:</span>
<span class="sd">    1. Set eexpiration timeout on a device.</span>
<span class="sd">    2. Shutdown anacapa on a device ungracefully (vanished zp).</span>
<span class="sd">    3. Assert vanished zp uuid is part of vanished list devices in topology</span>
<span class="sd">    of the active player after expiration timeout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vanish_device_uuid</span><span class="p">,</span> <span class="n">active_device</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">vanished_device_and_device_with_set_expiration_timeout</span><span class="p">)</span>
    <span class="n">wait_for_uuid_in_vanished_list</span><span class="p">(</span><span class="n">vanish_device_uuid</span><span class="p">,</span> <span class="n">active_device</span><span class="p">,</span>
                                   <span class="n">start_delay</span><span class="o">=</span><span class="n">SET_EXPIRATION_TIMEOUT</span><span class="o">+</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">verify_vanished_reason</span><span class="p">(</span><span class="n">vanish_device_uuid</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">active_device</span><span class="p">],</span>
                           <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;zp expired&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="test_vanish_zp_portable_on_poweroff"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.test_vanished_zp.test_vanish_zp_portable_on_poweroff">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;skip_if_no_powered_managed_portable_devices&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_vanish_zp_portable_on_poweroff</span><span class="p">(</span><span class="n">powered_off_portable_device_uuid</span><span class="p">,</span>
                                        <span class="n">all_fenway_or_newer_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify when a portable device is powered off, it is added as vanished</span>
<span class="sd">    device on active devices in HH with correct reason</span>
<span class="sd">    :param powered_off_portable_device_uuid: Fixture that yield uuid of</span>
<span class="sd">    device that is powered off</span>
<span class="sd">    :param all_fenway_or_newer_devices: Fixture that yields a list of all</span>
<span class="sd">    fenway or newer sonos zone components</span>
<span class="sd">    Steps:</span>
<span class="sd">    1. Power off a portable device</span>
<span class="sd">    2. Access topology status page on all active zps in HH and get list of</span>
<span class="sd">    active and vanished devices.</span>
<span class="sd">    3. Assert vanished portable zp is part of vanished list devices in topology</span>
<span class="sd">    4. Assert reason for vanish is &#39;powered off&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">active_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_fenway_or_newer_devices</span>
                      <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="o">!=</span> <span class="n">powered_off_portable_device_uuid</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">active_devices</span><span class="p">:</span>
        <span class="n">wait_for_uuid_in_vanished_list</span><span class="p">(</span><span class="n">powered_off_portable_device_uuid</span><span class="p">,</span> <span class="n">zp</span><span class="p">)</span>
    <span class="n">verify_vanished_reason</span><span class="p">(</span><span class="n">powered_off_portable_device_uuid</span><span class="p">,</span>
                           <span class="n">active_devices</span><span class="p">,</span>
                           <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;powered off&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="verify_vanished_reason"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.test_vanished_zp.verify_vanished_reason">[docs]</a><span class="k">def</span> <span class="nf">verify_vanished_reason</span><span class="p">(</span><span class="n">vanished_device_uuid</span><span class="p">,</span>
                           <span class="n">active_devices</span><span class="p">,</span>
                           <span class="n">reason</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify the reason for vanish is reported correctly on active devices</span>
<span class="sd">    :param str vanished_device_uuid: UUID of Device that has vanished</span>
<span class="sd">    :param active_devices: All active devices in HH that are vanish list</span>
<span class="sd">    capable (&gt; 32MB players, fenway or newer players)</span>
<span class="sd">    :param str reason: Expected reason for vanish</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">active_devices</span><span class="p">:</span>
        <span class="n">vanished_devices_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_vanished_zps_attribs_from_topology</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">vanished_device</span> <span class="ow">in</span> <span class="n">vanished_devices_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vanished_device</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">vanished_device_uuid</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">vanished_device</span><span class="p">[</span><span class="s1">&#39;reasonforvanish&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">reason</span></div>


<div class="viewcode-block" id="wait_for_uuid_in_vanished_list"><a class="viewcode-back" href="../../../../pytest_automation.player.topology.html#pytest_automation.player.topology.test_vanished_zp.wait_for_uuid_in_vanished_list">[docs]</a><span class="k">def</span> <span class="nf">wait_for_uuid_in_vanished_list</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">active_device</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span>
                                   <span class="n">start_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wait for uuid to appear in active device&#39;s vanished list in topology.</span>
<span class="sd">    Collect diag on failure and raise TimeoutError exception.</span>
<span class="sd">    :param str uuid: UUID of vanished device</span>
<span class="sd">    :param active_device: Active Sonos zone component</span>
<span class="sd">    :param int timeout: Timeout after which exception is raised.</span>
<span class="sd">    :param int start_delay: Start delay after which timeout out clock starts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying </span><span class="si">{}</span><span class="s2"> appears in vanished list of </span><span class="si">{}</span><span class="s2"> topology&quot;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">active_device</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">uuid</span> <span class="ow">in</span>
                                <span class="n">active_device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_vanished_zp_uuids</span><span class="p">(),</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="n">start_delay</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> did not appear in vanished list of </span><span class="si">{}</span><span class="s2"> topology&quot;</span>
                            <span class="s2">&quot; DIAG ID: </span><span class="si">{}</span><span class="s2">&quot;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">active_device</span><span class="p">,</span>
                                    <span class="n">active_device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">submit_direct_diag</span><span class="p">()))</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot; Vanished device uuid did not appear in vanished &quot;</span>
                           <span class="s2">&quot;list of active device topology&quot;</span><span class="p">)</span></div>


</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>