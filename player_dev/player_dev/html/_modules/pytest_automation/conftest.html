
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pytest_automation.conftest &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pytest_automation.conftest</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Root conftest.py file for Sonos automation.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">py.path</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">build_server</span> <span class="k">import</span> <span class="n">SonosBuildServerUtil</span>
<span class="kn">from</span> <span class="nn">host_upds</span> <span class="k">import</span> <span class="n">HostUpds</span>
<span class="kn">from</span> <span class="nn">testbed_config_parser</span> <span class="k">import</span> <span class="n">TestbedConfigurationParser</span>
<span class="kn">from</span> <span class="nn">sonos_version</span> <span class="k">import</span> <span class="n">Version</span><span class="p">,</span> <span class="n">BranchBasedVersion</span>
<span class="kn">from</span> <span class="nn">sonos.client.zone_player</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">LINE_IN_COMPRESSION_TYPES</span><span class="p">,</span> <span class="n">ZONEPLAYER_UPDATE_REBOOT_TIMEOUT_SEC</span><span class="p">,</span>
    <span class="n">ZONEPLAYER_UPDATE_DISCOVER_TIMEOUT_SEC</span><span class="p">,</span> <span class="n">VALGRIND_PLATFORMS</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">thread_processing</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">run_concurrent_zone_player_processes</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sonos.client.internal</span> <span class="k">import</span> <span class="n">SonosZoneComponent</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="ne">TimeoutError</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">audio_playback.mplayer_playback</span> <span class="k">import</span> <span class="p">(</span><span class="n">MplayerAc3Playback</span><span class="p">,</span>
                                             <span class="n">MplayerMp3LineOutPlayback</span><span class="p">,</span>
                                             <span class="n">MplayerLineOutPlayback</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">testbed.testrunner_properties</span> <span class="k">import</span> <span class="n">get_build_number</span>
<span class="kn">from</span> <span class="nn">sonos.client.sonos_async_device_updater</span> <span class="k">import</span> <span class="n">SonosAsyncMultiDeviceUpdater</span>
<span class="kn">from</span> <span class="nn">sonos.client.downloadmanager</span> <span class="k">import</span> <span class="n">DownloadManager</span>
<span class="kn">import</span> <span class="nn">netifaces</span>
<span class="kn">from</span> <span class="nn">valgrind_utils.valgrind_base</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ValgrindZoneWrapper</span><span class="p">,</span>
    <span class="n">ValgrindZoneAnacapaWrapper</span><span class="p">,</span>
    <span class="n">ANACAPA_CMD_SYNTAX</span><span class="p">,</span>
    <span class="n">VALGRIND_DURATION_SEC</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">valgrind_utils.valgrind_listener</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ValgrindListener</span><span class="p">,</span>
    <span class="n">VALGRIND_SONOS_LISTENER_PATH</span><span class="p">,</span>
    <span class="n">VALGRIND_RESULTS_FILE</span><span class="p">,</span>
    <span class="n">VALGRIND_LISTENER_PORT</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sonos.websrv</span> <span class="k">import</span> <span class="n">WebServer</span>
<span class="kn">from</span> <span class="nn">sonos.update.upm</span> <span class="k">import</span> <span class="n">UpdateManifestInfo</span>
<span class="kn">from</span> <span class="nn">text_parsing.type_conversion</span> <span class="k">import</span> <span class="n">str_to_bool</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">wifi.access_point.open_wrt_access_point</span> <span class="k">import</span> <span class="n">OpenWrtAccessPoint</span>


<span class="n">VALGRIND_DELAY_TEST_SEC</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">DEFAULT_HTAUDIO_TEST_PLAYBACK_FILE</span> <span class="o">=</span> \
    <span class="s2">&quot;/srv/samba/Automation/cpu/CrashIntoMe.ac3&quot;</span>
<span class="n">UPDATE_MARK_EXPR</span> <span class="o">=</span> <span class="s2">&quot; or updater&quot;</span>
<span class="n">UPDATE_KEYWORD_EXPR</span> <span class="o">=</span> <span class="s2">&quot; or test_update&quot;</span>
<span class="n">UPDATE_MODULE</span> <span class="o">=</span> <span class="s2">&quot;update/test_update.py&quot;</span>
<span class="n">DATETIME_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%H_%M_%S&quot;</span>
<span class="n">UDP_LOG_FILE_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_anacapa.txt&quot;</span>

<div class="viewcode-block" id="flatten_lists"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.flatten_lists">[docs]</a><span class="k">def</span> <span class="nf">flatten_lists</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given these args (which could themselves be iterables or scalars),</span>
<span class="sd">    generate a new iterable consisting of all elements.</span>

<span class="sd">    Example:</span>
<span class="sd">     args = [&quot;string&quot;, [1, 2, 3]]</span>
<span class="sd">     returns =&gt; [&quot;string&quot;, 1, 2, 3]</span>

<span class="sd">    :returns: Iterable consisting of all elements.</span>
<span class="sd">    :rtype: :class:`itertools.chain`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
        <span class="p">[</span><span class="n">arg</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">))</span>
         <span class="k">else</span> <span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]))</span></div>


<div class="viewcode-block" id="ParseDesiredConfig"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.ParseDesiredConfig">[docs]</a><span class="k">class</span> <span class="nc">ParseDesiredConfig</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If there is a metaconfig parameter present to indicate what configuration</span>
<span class="sd">    of device(s) to run the tests on, this function will parse the string</span>
<span class="sd">    config sent in</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
        <span class="n">testbed_configs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">assert</span> <span class="n">values</span><span class="p">,</span> <span class="s2">&quot;No metaconfig parameters found&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">testbed_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TestbedConfigurationParser</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">testbed_configs</span><span class="p">)</span></div>


<div class="viewcode-block" id="SanitizeUrl"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.SanitizeUrl">[docs]</a><span class="k">class</span> <span class="nc">SanitizeUrl</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a trailing slash to the end of the update_url if it doesn&#39;t have one</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span></div>


<div class="viewcode-block" id="pytest_namespace"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.pytest_namespace">[docs]</a><span class="k">def</span> <span class="nf">pytest_namespace</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hook to add attributes to Pytest session namespace.</span>

<span class="sd">    :returns: Map of attribute names to values.</span>
<span class="sd">    :rtype: :obj:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(),</span>
        <span class="s2">&quot;operation_fixture_names&quot;</span><span class="p">:</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">operation_fixture_names</span><span class="p">,</span>
        <span class="s2">&quot;capture_anacapa_logs&quot;</span><span class="p">:</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span>
            <span class="s2">&quot;capture_anacapa_logs&quot;</span><span class="p">),</span>
        <span class="s2">&quot;override_diag_levels&quot;</span><span class="p">:</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span>
            <span class="s2">&quot;override_diag_levels&quot;</span><span class="p">),</span>
        <span class="s2">&quot;wait_for_assert&quot;</span><span class="p">:</span> <span class="n">wait_for_assert</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="pytest_collection_modifyitems"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.pytest_collection_modifyitems">[docs]</a><span class="k">def</span> <span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If the user requested a testbed update, perform a manual collection of</span>
<span class="sd">    update testcases and insert them at the front of the list of collected</span>
<span class="sd">    testcases.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_showfixtures</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s2">&quot;showfixtures&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">getplugin</span><span class="p">(</span><span class="s2">&quot;funcmanage&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">fixtures</span> <span class="ow">in</span> <span class="n">manager</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">fixture</span> <span class="ow">in</span> <span class="n">fixtures</span><span class="p">:</span>
                    <span class="n">fixture</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
    <span class="n">_showfixtures</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;update&quot;</span><span class="p">):</span>
        <span class="n">update_module</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">rootdir</span><span class="o">.</span><span class="n">strpath</span><span class="p">,</span> <span class="n">UPDATE_MODULE</span><span class="p">))</span>
        <span class="n">test_module</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">ihook</span><span class="o">.</span><span class="n">pytest_collect_file</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">update_module</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">session</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">test_module</span><span class="o">.</span><span class="n">collect</span><span class="p">():</span>
            <span class="n">items</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_to_result_log"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.write_to_result_log">[docs]</a><span class="k">def</span> <span class="nf">write_to_result_log</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">logging_plugin</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">getplugin</span><span class="p">(</span><span class="s1">&#39;logging-plugin&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logging_plugin</span><span class="o">.</span><span class="n">log_file_handler</span><span class="p">:</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">LogRecord</span><span class="p">(</span><span class="s1">&#39;pytest&#39;</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">logging_plugin</span><span class="o">.</span><span class="n">log_file_handler</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">record</span><span class="p">)</span></div>


<div class="viewcode-block" id="pytest_runtest_setup"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.pytest_runtest_setup">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tryfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_runtest_setup</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="n">write_to_result_log</span><span class="p">(</span><span class="s2">&quot;Start Setup - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">))</span>
    <span class="k">yield</span>
    <span class="n">write_to_result_log</span><span class="p">(</span><span class="s2">&quot;Stop Setup - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">))</span></div>


<div class="viewcode-block" id="pytest_runtest_call"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.pytest_runtest_call">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tryfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_runtest_call</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="n">write_to_result_log</span><span class="p">(</span><span class="s2">&quot;Start Test - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">))</span>
    <span class="k">yield</span>
    <span class="n">write_to_result_log</span><span class="p">(</span><span class="s2">&quot;End Test - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">))</span></div>


<div class="viewcode-block" id="pytest_runtest_teardown"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.pytest_runtest_teardown">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tryfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_runtest_teardown</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">nextitem</span><span class="p">):</span>
    <span class="n">write_to_result_log</span><span class="p">(</span><span class="s2">&quot;Start Teardown - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">))</span>
    <span class="k">yield</span>
    <span class="n">write_to_result_log</span><span class="p">(</span><span class="s2">&quot;End Teardown - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">))</span></div>


<div class="viewcode-block" id="pytest_terminal_summary"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.pytest_terminal_summary">[docs]</a><span class="k">def</span> <span class="nf">pytest_terminal_summary</span><span class="p">(</span><span class="n">terminalreporter</span><span class="p">):</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">terminalreporter</span>
    <span class="k">if</span> <span class="n">pytest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s2">&quot;showfixtures&quot;</span><span class="p">):</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="s2">&quot;Find more information on our Pytest Fixtures here:&quot;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="s2">&quot;https://docs.sonos.com/automation_pydoc/pytest_automation.html&quot;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="s2">&quot;Or use the --verbose option (-v or -vv) for more details&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="pytest_configure"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.pytest_configure">[docs]</a><span class="k">def</span> <span class="nf">pytest_configure</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If we&#39;re performing a testbed update, check if we&#39;re discovering tests</span>
<span class="sd">    by either mark or keyword - if so, make sure we update them to include the</span>
<span class="sd">    appropriate updater mark/keyword.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;update&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">markexpr</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">markexpr</span> <span class="o">+=</span> <span class="n">UPDATE_MARK_EXPR</span>
        <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">keyword</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">keyword</span> <span class="o">+=</span> <span class="n">UPDATE_KEYWORD_EXPR</span></div>


<div class="viewcode-block" id="pytest_generate_tests"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.pytest_generate_tests">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">tryfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_generate_tests</span><span class="p">(</span><span class="n">metafunc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When running tests with &#39;--metaconfig&#39; and &#39;--metaresource&#39;, parameterize</span>
<span class="sd">    the values passed in on the cmdline</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">metafunc</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;metaconfig&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">and</span> <span class="s2">&quot;metaconfig&quot;</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">):</span>
        <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
            <span class="s1">&#39;metaconfig_params&#39;</span><span class="p">,</span>
            <span class="n">metafunc</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">metaconfig</span><span class="p">,</span>
            <span class="n">indirect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">config</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">metaconfig</span><span class="p">],</span>
            <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="pytest_addoption"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.pytest_addoption">[docs]</a><span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add cmdline arguments</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--metaconfig&quot;</span><span class="p">,</span>
                     <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                     <span class="n">action</span><span class="o">=</span><span class="n">ParseDesiredConfig</span><span class="p">,</span>
                     <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Specify bonded/HT configurations (with optional orientation</span>
<span class="s2">            specification) to parametrize the &#39;metaconfig&#39; fixture with.</span>
<span class="s2">            &#39;metaconfig&#39; will build the specified configuration when the</span>
<span class="s2">            testcase(s) execute.</span>

<span class="s2">            Supported configurations:</span>
<span class="s2">             &#39;standalone-all&#39; (all playback models)</span>
<span class="s2">             &#39;standalone-&lt;model&gt;&#39; (any playback model)</span>
<span class="s2">             &#39;5.1-&lt;model&gt;-&lt;model&gt;&#39; (S9, S11, S14)-(S6, S3, S1, S12, ZP120)</span>
<span class="s2">             &#39;5.0-&lt;model&gt;-&lt;model&gt;&#39; (S9, S11, S14)-(S6, S3, S1, S12, ZP120)</span>
<span class="s2">             &#39;3.1-&lt;model&gt;&#39; (S9, S11, S14)</span>
<span class="s2">             &#39;stereo-&lt;model&gt;&#39; (S3, S1, S5, S6, S12)</span>
<span class="s2">             &#39;stereo-sub-&lt;model&gt;&#39; (S3, S1, S5, S6, S12)</span>
<span class="s2">             &#39;sub-&lt;model&gt;&#39; (any bondable model)</span>

<span class="s2">            An optional orientation specification can also be specified:</span>
<span class="s2">             &#39;5.1-S9-S1-T&#39; (sets PLAYBAR in &#39;Table&#39; orientation)</span>
<span class="s2">             &#39;5.1-S9-S3-THH&#39; (sets PLAYBAR in &#39;Table&#39; orientation,</span>
<span class="s2">                              and both PLAY:3 satellites in Horizontal</span>
<span class="s2">                              orientation)</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">build_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getgroup</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Build options:&quot;</span><span class="p">)</span>
    <span class="n">build_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--update_version&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Version of target firmware.&quot;</span><span class="p">)</span>
    <span class="n">build_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--update_url&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="n">SanitizeUrl</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;URL pointing to target firmware.&quot;</span><span class="p">)</span>
    <span class="n">build_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--update_branch&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Branch name of target firmware.&quot;</span><span class="p">)</span>
    <span class="n">build_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--host_upds&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Download and host update files from this testrunner.&quot;</span><span class="p">)</span>
    <span class="n">updater_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getgroup</span><span class="p">(</span><span class="s2">&quot;updater&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Updater options:&quot;</span><span class="p">)</span>
    <span class="n">updater_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--update&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Unconditionally update the testbed to firmware specified &quot;</span>
             <span class="s2">&quot;by &#39;--update_url&#39; and &#39;--update_version&#39; parameters.&quot;</span><span class="p">)</span>
    <span class="n">updater_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--conditional_update&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Skip update if testbed already running target firmware.&quot;</span><span class="p">)</span>
    <span class="n">updater_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--update_reboot_timeout&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">ZONEPLAYER_UPDATE_REBOOT_TIMEOUT_SEC</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of sceonds to wait for a device to finish rebooting &quot;</span>
             <span class="s2">&quot;after a firmware update.&quot;</span><span class="p">)</span>
    <span class="n">updater_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--update_detect_timeout&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">ZONEPLAYER_UPDATE_DISCOVER_TIMEOUT_SEC</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of seconds to wait for the UPnP control point to &quot;</span>
             <span class="s2">&quot;discover devices after a firmware update completes.&quot;</span><span class="p">)</span>
    <span class="n">updater_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--update_from_manifest&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use the .upm file found at the &#39;update_url&#39;&quot;</span><span class="p">)</span>
    <span class="n">terminal_reporter_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getgroup</span><span class="p">(</span><span class="s2">&quot;terminal reporting&quot;</span><span class="p">)</span>
    <span class="n">terminal_reporter_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--junit-logging&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;junit_logging&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable writing of captured log messages to JUnit report.&quot;</span><span class="p">)</span>
    <span class="n">test_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getgroup</span><span class="p">(</span>
        <span class="s2">&quot;playback_options&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Playback options:&quot;</span><span class="p">)</span>
    <span class="n">test_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--htaudio_test_playback_file&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_HTAUDIO_TEST_PLAYBACK_FILE</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to file to be use for testrunner HT audio playback.&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add command line arguments to support the valgrind automation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valgrind_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getgroup</span><span class="p">(</span><span class="s2">&quot;valgrind_options&quot;</span><span class="p">,</span>
                                     <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Valgrind options:&quot;</span><span class="p">)</span>
    <span class="n">valgrind_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--valgrind_results&quot;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;XML file to write valgrind results&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="n">VALGRIND_RESULTS_FILE</span><span class="p">)</span>
    <span class="n">valgrind_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--valgrind_listener_port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Valgrind listener port&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="n">VALGRIND_LISTENER_PORT</span><span class="p">)</span>
    <span class="n">valgrind_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--valgrind_listener_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Sonos valgrind listener path&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="n">VALGRIND_SONOS_LISTENER_PATH</span><span class="p">)</span>
    <span class="n">valgrind_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--valgrind_duration&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Valgrind duration in seconds&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="n">VALGRIND_DURATION_SEC</span><span class="p">)</span>
    <span class="n">valgrind_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--valgrind_exec_cmd&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Command to execute under valgrind&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="n">ANACAPA_CMD_SYNTAX</span><span class="p">)</span>
    <span class="n">valgrind_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--valgrind_user_suppressions&quot;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;User supplied valgrind suppressions file&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">valgrind_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--valgrind_test_delay&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Sleep in seconds after valgrind starts&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="n">VALGRIND_DELAY_TEST_SEC</span><span class="p">)</span>
    <span class="n">valgrind_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--valgrind_platforms&quot;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Platforms valgrind should run&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="n">VALGRIND_PLATFORMS</span><span class="p">,</span>
                             <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                             <span class="n">choices</span><span class="o">=</span><span class="n">VALGRIND_PLATFORMS</span><span class="p">)</span>
    <span class="n">webserver_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getgroup</span><span class="p">(</span><span class="s2">&quot;webserver_options&quot;</span><span class="p">,</span>
                                      <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Options related to sonos.websrv&quot;</span><span class="p">)</span>
    <span class="n">webserver_group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--webserver_port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span>
                              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Port that WebServer should use by default.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="pytest_runtest_makereport"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.pytest_runtest_makereport">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">tryfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_runtest_makereport</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From https://docs.pytest.org/en/latest/example/simple.html#making-test-result-information-available-in-fixtures</span>

<span class="sd">    This hook allows easier access to pytest results via the standard `request` object. See above pytest documentation</span>
<span class="sd">    for example usage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># execute all other hooks to obtain the report object</span>
    <span class="n">outcome</span> <span class="o">=</span> <span class="k">yield</span>
    <span class="n">rep</span> <span class="o">=</span> <span class="n">outcome</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>

    <span class="c1"># set a report attribute for each phase of a call, which can</span>
    <span class="c1"># be &quot;setup&quot;, &quot;call&quot;, &quot;teardown&quot;</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;rep_&quot;</span> <span class="o">+</span> <span class="n">rep</span><span class="o">.</span><span class="n">when</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>

    <span class="c1"># clear captured stdout/stderr before it&#39;s added to the junit report</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;junit_logging&quot;</span><span class="p">):</span>
        <span class="n">rep</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="p">()</span></div>


<span class="c1"># Prevent repeated test failure messages in log files</span>
<span class="n">_ALREADY_LOGGED_LIST</span> <span class="o">=</span> <span class="p">[]</span>


<div class="viewcode-block" id="pytest_runtest_logreport"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.pytest_runtest_logreport">[docs]</a><span class="k">def</span> <span class="nf">pytest_runtest_logreport</span><span class="p">(</span><span class="n">report</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a test setup/call/teardown report relating to</span>
<span class="sd">    the respective phase of executing a test.</span>

<span class="sd">    This implementation includes fail and skip information in the debug log,</span>
<span class="sd">    similar to what already appears in the console output.</span>

<span class="sd">    :param report: a :py:class:`_pytest.runner.TestReport` object that</span>
<span class="sd">    describes the results of the current test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="o">.</span><span class="n">passed</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pytest&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">nodeid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_ALREADY_LOGGED_LIST</span><span class="p">:</span>
            <span class="n">_ALREADY_LOGGED_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">nodeid</span><span class="p">)</span>
            <span class="n">_log_test_failed</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">report</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_log_test_failed</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logs data related to a test failure when a test fails.</span>
<span class="sd">    Specifically, failure location and text</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">when_text</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">when</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="s1">&#39;teardown&#39;</span><span class="p">,</span> <span class="s1">&#39; during teardown&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="s1">&#39;setup&#39;</span><span class="p">,</span> <span class="s1">&#39; during setup&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Test </span><span class="si">{2}{0}</span><span class="s1">: </span><span class="si">{1[0]}</span><span class="s1">:</span><span class="si">{1[1]}</span><span class="s1"> (</span><span class="si">{1[2]}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">when_text</span><span class="p">,</span>
        <span class="n">report</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
        <span class="n">report</span><span class="o">.</span><span class="n">outcome</span><span class="p">)</span>
    <span class="c1"># XFail?</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="s1">&#39;wasxfail&#39;</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">report</span><span class="o">.</span><span class="n">wasxfail</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">longrepr</span><span class="p">,</span> <span class="s1">&#39;reprcrash&#39;</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">longrepr</span><span class="o">.</span><span class="n">reprcrash</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">longreprtext</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">longrepr</span><span class="p">,</span> <span class="s1">&#39;errorstring&#39;</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">longrepr</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                                        <span class="n">report</span><span class="o">.</span><span class="n">longrepr</span><span class="o">.</span><span class="n">firstlineno</span><span class="p">,</span>
                                        <span class="n">report</span><span class="o">.</span><span class="n">longrepr</span><span class="o">.</span><span class="n">errorstring</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{0[0]}</span><span class="s1">:</span><span class="si">{0[1]}</span><span class="se">\n</span><span class="si">{0[2]}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">longrepr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">skipped</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>


<div class="viewcode-block" id="test_name"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.test_name">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_name</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: The name of the current testcase.</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">name</span>
    <span class="k">return</span> <span class="n">name</span></div>


<div class="viewcode-block" id="metaconfig_params"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.metaconfig_params">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">metaconfig_params</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Special fixture which takes configurations specified with the</span>
<span class="sd">    &#39;--metaconfig&#39; param at the start of this Pytest session, and yields back</span>
<span class="sd">    one configuration at a time.</span>

<span class="sd">    This fixture is exclusively used to parametrize the &#39;metaconfig&#39; fixture.</span>

<span class="sd">    :return: User metaconfig parameters.</span>
<span class="sd">    :rtype: :obj: `str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">yield</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span></div>


<div class="viewcode-block" id="metaconfig"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.metaconfig">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">metaconfig</span><span class="p">(</span><span class="n">metaconfig_params</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameterized fixture which builds each configuration specified by user</span>
<span class="sd">    specified &#39;metaconfig_params&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">metaconfig_params</span><span class="o">.</span><span class="n">config</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating testbed config &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>

    <span class="n">devices</span> <span class="o">=</span> <span class="n">metaconfig_params</span><span class="o">.</span><span class="n">get_testbed_devices_config</span><span class="p">(</span><span class="n">pytest</span><span class="o">.</span><span class="n">device_selection</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">devices</span><span class="p">:</span>
        <span class="c1"># If devices is None, we have a Standalone device that doesn&#39;t</span>
        <span class="c1"># have or need a config.  Just get the list of devices</span>
        <span class="n">devices</span> <span class="o">=</span> <span class="n">metaconfig_params</span><span class="o">.</span><span class="n">get_testbed_devices_list</span><span class="p">(</span><span class="n">pytest</span><span class="o">.</span><span class="n">device_selection</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="c1"># Note that this can return either a Bonded or HT config object OR a list</span>
    <span class="c1"># of standalone devices</span>
    <span class="k">yield</span> <span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">devices</span><span class="p">)</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up config: &lt;</span><span class="si">{}</span><span class="s2">&gt;(devices&lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">devices</span><span class="p">))</span>

    <span class="c1"># We have a config object that needs to be unconfigured</span>
    <span class="k">if</span> <span class="n">devices</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">devices</span><span class="o">.</span><span class="n">unconfigure</span><span class="p">()</span></div>


<div class="viewcode-block" id="metaconfig_dut_ids"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.metaconfig_dut_ids">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">metaconfig_dut_ids</span><span class="p">(</span><span class="n">metaconfig_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a mapping of &#39;metaconfig_devices&#39; in-use by the current metaconfig</span>
<span class="sd">    configuration to a string describing what role in the configuration that</span>
<span class="sd">    the device plays.</span>

<span class="sd">    Description string syntax: &lt;model&gt;-&lt;audio channel&gt;</span>

<span class="sd">    Example DUT IDs:</span>
<span class="sd">     - S9-LF,RF</span>
<span class="sd">     - S5-LF,LF</span>
<span class="sd">     - Sub-SW,SW</span>
<span class="sd">     - ZP120-LR,RR</span>

<span class="sd">    :return: DUT identifiers for the current &#39;metaconfig_devices&#39;</span>
<span class="sd">    :rtype: :obj:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dut_ids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">metaconfig_devices</span><span class="p">:</span>
        <span class="n">dut_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">device</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">,</span> <span class="n">device</span><span class="o">.</span><span class="n">get_channel</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;LF,RF&quot;</span><span class="p">)</span>
        <span class="n">dut_ids</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span> <span class="o">=</span> <span class="n">dut_id</span>
    <span class="k">return</span> <span class="n">dut_ids</span></div>


<div class="viewcode-block" id="metaconfig_playback_devices"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.metaconfig_playback_devices">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">metaconfig_playback_devices</span><span class="p">(</span><span class="n">metaconfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of playback devices from the current configuration built</span>
<span class="sd">    through &#39;metaconfig&#39;. This fixture excludes playback devices that are</span>
<span class="sd">    satellites or secondary bonded devices (except in standalone configs).</span>

<span class="sd">    For example, if the current metaconfig configuration is &quot;5.1-S9-S1&quot;, only</span>
<span class="sd">    the S9 would be returned by this method.</span>

<span class="sd">    :return: Devices capable of playback in current &#39;metaconfig&#39;.</span>
<span class="sd">    :rtype: :class:`~sonos.client.internal.SonosZoneComponent` or :obj:`list`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_name</span> <span class="o">=</span> <span class="n">metaconfig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">metaconfig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;standalone&quot;</span> <span class="ow">in</span> <span class="n">config_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">devices</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if we&#39;re in any bonded configuration, we have to extract the list of</span>
        <span class="c1"># devices from the bonded config</span>
        <span class="k">return</span> <span class="n">devices</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span></div>


<div class="viewcode-block" id="metaconfig_devices"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.metaconfig_devices">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">metaconfig_devices</span><span class="p">(</span><span class="n">metaconfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: List of devices in-use by the current &#39;metaconfig&#39; configuration.</span>
<span class="sd">    :rtype: :obj:`list`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">metaconfig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">devices</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">devices</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We have a bonded or HT config.  Need to extract the devices</span>
        <span class="k">return</span> <span class="n">devices</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span></div>


<div class="viewcode-block" id="metaconfig_config_name"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.metaconfig_config_name">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">metaconfig_config_name</span><span class="p">(</span><span class="n">metaconfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the name of the current &#39;metaconfig&#39; configuration.</span>

<span class="sd">    Ex:</span>
<span class="sd">     - &quot;5.1-S9-S1&quot;</span>
<span class="sd">     - &quot;standalone-S9&quot;</span>
<span class="sd">     - &quot;stereo-sub-S5&quot;</span>

<span class="sd">    :return: Name of current &#39;metaconfig&#39; configuration.</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">metaconfig</span>
    <span class="k">yield</span> <span class="n">config_name</span></div>


<div class="viewcode-block" id="generic_testbed_cleanup"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.generic_testbed_cleanup">[docs]</a><span class="k">def</span> <span class="nf">generic_testbed_cleanup</span><span class="p">(</span><span class="n">devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    General use finalizer to cleanup bonded and home theater configurations,</span>
<span class="sd">    and make sure the service wrappers on our SonosZoneComponent objects are</span>
<span class="sd">    valid.</span>

<span class="sd">    :param list devices: list of `sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span> <span class="k">if</span> <span class="n">d</span><span class="p">]</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">update_service_wrappers</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span> <span class="k">if</span> <span class="n">d</span><span class="p">]</span></div>


<div class="viewcode-block" id="line_in_compression_types"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.line_in_compression_types">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">line_in_compression_types</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: All possible line-in compression types.</span>
<span class="sd">    :rtype: :obj:`list`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">LINE_IN_COMPRESSION_TYPES</span></div>


<div class="viewcode-block" id="line_in_compression_type"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.line_in_compression_type">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">LINE_IN_COMPRESSION_TYPES</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">line_in_compression_type</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: Parameterized fixture which yields a value from all</span>
<span class="sd">        &#39;line_in_compression_types&#39;</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">yield</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span></div>


<div class="viewcode-block" id="cycle_line_in_compression_type"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.cycle_line_in_compression_type">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cycle_line_in_compression_type</span><span class="p">(</span>
        <span class="n">line_in_compression_type</span><span class="p">,</span> <span class="n">a_playback_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cycle through each &#39;line_in_compression_type&#39; and apply it to the testbed</span>
<span class="sd">        (using &#39;a_playback_device&#39; to set/unset the setting).</span>

<span class="sd">    Unset the testbed compression type in teardown.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">a_playback_device</span>
    <span class="n">starting_type</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="s2">&quot;R_AudioInEncodeType&quot;</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">SetString</span><span class="p">(</span>
        <span class="s2">&quot;R_AudioInEncodeType&quot;</span><span class="p">,</span> <span class="n">line_in_compression_type</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="n">d</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">SetString</span><span class="p">(</span><span class="s2">&quot;R_AudioInEncodeType&quot;</span><span class="p">,</span> <span class="n">starting_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="a_line_in_capable_device"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.a_line_in_capable_device">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_line_in_capable_device</span><span class="p">(</span><span class="n">all_unique_line_in_capable_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: a single line-in capable device from pool of</span>
<span class="sd">        &#39;all_unique_line_in_capable_devices&#39; which has an active line-in</span>
<span class="sd">        connection.</span>
<span class="sd">    :rtype: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    :raises IndexError: if no line-in capable and connected devices are found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_unique_line_in_capable_devices</span> <span class="k">if</span>
            <span class="n">d</span><span class="o">.</span><span class="n">AudioIn</span><span class="o">.</span><span class="n">LineInConnected</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="play_line_in_on_all_devices"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.play_line_in_on_all_devices">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">play_line_in_on_all_devices</span><span class="p">(</span><span class="n">all_playback_devices</span><span class="p">,</span> <span class="n">a_line_in_capable_device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Begin line-in playback from all capable devices on this testbed.</span>

<span class="sd">    This method scoped fixture will clear the playstate of all line-in capable</span>
<span class="sd">    devices after the testcase has completed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_line_in</span><span class="p">(</span><span class="n">a_line_in_capable_device</span><span class="p">)</span>
     <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_playback_devices</span><span class="p">]</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_playback_devices</span><span class="p">]</span>
    <span class="k">yield</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_playback_devices</span><span class="p">]</span></div>


<div class="viewcode-block" id="grouped_pair"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.grouped_pair">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">grouped_pair</span><span class="p">(</span><span class="n">gc_gm_pair</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parametrized fixture which returns a pair of grouped devices for each</span>
<span class="sd">        &#39;gc_gm_pair&#39; possible on this testbed.</span>

<span class="sd">    Ungroup pair in teardown.</span>

<span class="sd">    :return: A pair of grouped devices.</span>
<span class="sd">    :rtype: :obj:`tuple`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gc</span><span class="p">,</span> <span class="n">gm</span> <span class="o">=</span> <span class="n">gc_gm_pair</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">link_zones</span><span class="p">(</span><span class="n">gm</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">gm</span><span class="p">)</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">gc</span><span class="p">]</span> <span class="o">+</span> <span class="n">gm</span><span class="p">]</span></div>


<div class="viewcode-block" id="a_grouped_pair"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.a_grouped_pair">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">a_grouped_pair</span><span class="p">(</span><span class="n">a_gc_gm_pair</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixture which returns a single pair of grouped devices.</span>

<span class="sd">    Ungroup pair in teardown.</span>

<span class="sd">    :return: A pair of grouped devices.</span>
<span class="sd">    :rtype: :obj:`tuple`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gc</span><span class="p">,</span> <span class="n">gm</span> <span class="o">=</span> <span class="n">a_gc_gm_pair</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">link_zones</span><span class="p">(</span><span class="n">gm</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">gm</span><span class="p">)</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">gc</span><span class="p">]</span> <span class="o">+</span> <span class="n">gm</span><span class="p">]</span></div>


<div class="viewcode-block" id="a_non_portable_grouped_pair"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.a_non_portable_grouped_pair">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">a_non_portable_grouped_pair</span><span class="p">(</span><span class="n">a_non_portable_gc_gm_pair</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixture which returns a single pair of grouped</span>
<span class="sd">    non portbale devices.</span>
<span class="sd">    Ungroup pair in teardown.</span>
<span class="sd">    :return: A tuple of GC and a list of GMs of type</span>
<span class="sd">    :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    :rtype: :obj:`tuple`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gc</span><span class="p">,</span> <span class="n">gm</span> <span class="o">=</span> <span class="n">a_non_portable_gc_gm_pair</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">link_zones</span><span class="p">(</span><span class="n">gm</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">gm</span><span class="p">)</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">gc</span><span class="p">]</span> <span class="o">+</span> <span class="n">gm</span><span class="p">]</span></div>


<div class="viewcode-block" id="testbed_config"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.testbed_config">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">testbed_config</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: The testbed configuration used by this automation testbed.</span>
<span class="sd">    :rtype: :class:`~sonos.environment.WorkflowExecutionConfiguration`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pytest</span><span class="o">.</span><span class="n">testbed_config</span></div>


<div class="viewcode-block" id="hhid"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.hhid">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hhid</span><span class="p">(</span><span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: The Household ID used by devices specified in the testbed config.</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    :raises AssertionError: Not all testbed devices share the same HHID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hhid</span> <span class="o">=</span> <span class="n">all_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hhid</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">hhid</span> <span class="o">==</span> <span class="n">hhid</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_devices</span><span class="p">]),</span> <span class="p">(</span>
        <span class="s2">&quot;Expect all devices to share the same HHID!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hhid</span></div>


<div class="viewcode-block" id="update_base_url"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.update_base_url">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_base_url</span><span class="p">(</span><span class="n">update_url</span><span class="p">,</span> <span class="n">version_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a URL which Sonos devices can use to update to target firmware.</span>

<span class="sd">    :return: A new URL composed of the &#39;update_url&#39; and &#39;version_number&#39;.</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">update_url</span> <span class="ow">and</span> <span class="n">version_number</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;Missing expected update URL and/or version number&quot;</span><span class="p">)</span>
    <span class="n">update_url</span> <span class="o">=</span> <span class="n">update_url</span> <span class="o">+</span> <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="n">version_number</span><span class="o">.</span><span class="n">stripped_version</span>
    <span class="k">return</span> <span class="n">update_url</span></div>


<div class="viewcode-block" id="update_url"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.update_url">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_url</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">host_upds_url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: URL which update files are accessible from. Overridden by</span>
<span class="sd">        &#39;host_upds_url&#39;, if specified.</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">update_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">update_url</span>

    <span class="k">return</span> <span class="n">host_upds_url</span> <span class="ow">or</span> <span class="n">update_url</span></div>


<div class="viewcode-block" id="host_upds_url"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.host_upds_url">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">host_upds_url</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download the files from a custom URL and host them locally rather than</span>
<span class="sd">    downloading from builds.sonos.com</span>

<span class="sd">    In teardown, any temporary files are cleaned up.</span>

<span class="sd">    :return: URL pointing to re-hosted firmware.</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">should_host_upds</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">host_upds</span>
    <span class="n">version_string</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">update_version</span>
    <span class="n">update_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">update_url</span>
    <span class="n">host_url</span> <span class="o">=</span> <span class="n">update_url</span>
    <span class="n">host_upds_helper</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">should_host_upds</span><span class="p">:</span>
        <span class="n">version_num</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="n">version_string</span><span class="p">)</span>
        <span class="n">host_upds_helper</span> <span class="o">=</span> <span class="n">HostUpds</span><span class="p">(</span><span class="n">update_url</span><span class="p">,</span> <span class="n">version_num</span><span class="p">)</span>
        <span class="n">host_url</span> <span class="o">=</span> <span class="n">host_upds_helper</span><span class="o">.</span><span class="n">host_update_files</span><span class="p">()</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hosting UPDs locally at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host_url</span><span class="p">))</span>

    <span class="k">yield</span> <span class="n">host_url</span>

    <span class="k">if</span> <span class="n">host_upds_helper</span><span class="p">:</span>
        <span class="n">host_upds_helper</span><span class="o">.</span><span class="n">cleanup_tmp_upds</span><span class="p">()</span></div>


<div class="viewcode-block" id="version_number"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.version_number">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">version_number</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">update_url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Version number of target firmware.</span>

<span class="sd">    If no version number is provided, use the &#39;update_url&#39; value (if available)</span>
<span class="sd">    to find the version number.</span>

<span class="sd">    :return: Version number of firmware.</span>
<span class="sd">    :rtype: :class:`~sonos_version.Version`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">version_string</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;update_version&quot;</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">update_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">version_string</span><span class="p">:</span>
        <span class="n">version_string</span> <span class="o">=</span> <span class="n">SonosBuildServerUtil</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">update_url</span><span class="p">)</span><span class="o">.</span><span class="n">version</span>
    <span class="k">if</span> <span class="n">version_string</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="n">version_string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">version</span></div>


<div class="viewcode-block" id="branch"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.branch">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">branch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">update_url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Name of target firmware branch.</span>

<span class="sd">    If no name is provided, use the &#39;update_url&#39; value (if available) to find</span>
<span class="sd">    the branch name.</span>

<span class="sd">    :return: Name of target firmware branch.</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">update_branch</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;update_branch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">update_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">update_branch</span><span class="p">:</span>
        <span class="n">update_branch</span> <span class="o">=</span> <span class="n">SonosBuildServerUtil</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">update_url</span><span class="p">)</span><span class="o">.</span><span class="n">branch</span>
    <span class="k">return</span> <span class="n">update_branch</span></div>


<div class="viewcode-block" id="branch_parent"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.branch_parent">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">branch_parent</span><span class="p">(</span><span class="n">branch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Name of the current branch&#39;s parent</span>
<span class="sd">    :param branch:current branch</span>
<span class="sd">    :return: name of branch parent</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">branch</span> <span class="o">==</span> <span class="s1">&#39;trunk&#39;</span> <span class="ow">or</span> <span class="n">branch</span> <span class="o">==</span> <span class="s1">&#39;mainline&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">branch</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="s1">&#39;p4 filelog -m1 //depot/branches/</span><span class="si">{}</span><span class="s1">/all/totem |grep from&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">branch</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">p_string</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;trunk&#39;</span> <span class="ow">in</span> <span class="n">p_string</span><span class="p">:</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="s1">&#39;trunk&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;branches\/(.+?)\/all&#39;</span><span class="p">,</span> <span class="n">p_string</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;branch parent not found&quot;</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="s1">&#39;trunk&#39;</span>
    <span class="k">return</span> <span class="n">parent</span></div>

<div class="viewcode-block" id="update_manifest"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.update_manifest">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_manifest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">update_url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the Update Manifest for the specified &#39;update_base_url&#39;.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This fixture requires the &#39;--update_from_manifest&#39; argument.</span>

<span class="sd">    :return: Update Manifest for the specified update URL, or None</span>
<span class="sd">    :rtype: :obj:`~sonos.update.upm.UpdateManifestInfo` or :obj:`None`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">UpdateManifestInfo</span><span class="o">.</span><span class="n">from_online_update</span><span class="p">(</span><span class="n">update_url</span><span class="p">)</span> <span class="k">if</span>
            <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;update_from_manifest&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="firmware_updater"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.firmware_updater">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">firmware_updater</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">update_base_url</span><span class="p">,</span> <span class="n">update_manifest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an updater function, which updates devices to the firmware found</span>
<span class="sd">    at &#39;update_base_url&#39; or &#39;update_manifest&#39;.</span>

<span class="sd">    :return: Function which can update Sonos devices to target firmware.</span>
<span class="sd">    :rtype: :obj:`function`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reboot_timeout</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;update_reboot_timeout&quot;</span><span class="p">)</span>
    <span class="n">detect_timeout</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;update_detect_timeout&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span>
               <span class="n">update_base_url</span><span class="o">=</span><span class="n">update_base_url</span><span class="p">,</span>
               <span class="n">update_upm</span><span class="o">=</span><span class="n">update_manifest</span><span class="p">,</span>
               <span class="n">reboot_timeout</span><span class="o">=</span><span class="n">reboot_timeout</span><span class="p">,</span>
               <span class="n">detect_timeout</span><span class="o">=</span><span class="n">detect_timeout</span><span class="p">):</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating devices to firmware at &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">update_base_url</span><span class="p">))</span>
        <span class="n">device_serials</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">serialNumber</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">]</span>
        <span class="n">parallel_updater</span> <span class="o">=</span> <span class="n">SonosAsyncMultiDeviceUpdater</span><span class="p">(</span>
            <span class="n">reboot_timeout_seconds</span><span class="o">=</span><span class="n">reboot_timeout</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">parallel_updater</span><span class="o">.</span><span class="n">updateMultipleDevices</span><span class="p">(</span>
                <span class="n">devices</span><span class="p">,</span> <span class="n">update_manifest</span> <span class="ow">or</span> <span class="n">update_base_url</span><span class="p">)</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">subnet</span><span class="o">.</span><span class="n">wait_for_devices_with_these_serials</span><span class="p">(</span>
            <span class="n">device_serials</span><span class="p">,</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">detect_timeout</span><span class="p">)</span>
        <span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">reset_saved_properties</span><span class="p">()</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">result_data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">result_data</span>
            <span class="k">assert</span> <span class="n">success</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Failed to update &lt;</span><span class="si">{}</span><span class="s2">&gt; (errcode=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">update</span></div>


<div class="viewcode-block" id="version_verifier"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.version_verifier">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">version_verifier</span><span class="p">(</span><span class="n">version_number</span><span class="p">,</span> <span class="n">update_manifest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: Object which can verify firmware version of Sonos devices.</span>
<span class="sd">    :rtype: :obj:`callable`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_verify_firmware_update</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">version_number</span><span class="o">=</span><span class="n">version_number</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">version_number</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No --update_version specified&quot;</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update_manifest</span><span class="p">:</span>
                <span class="n">version_number</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">update_manifest</span><span class="o">.</span><span class="n">get_zone_update_info</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">stripped_version</span> <span class="o">==</span>
                    <span class="n">version_number</span><span class="o">.</span><span class="n">stripped_version</span><span class="p">),</span> <span class="p">(</span>
                <span class="s2">&quot;Unexpected version found on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">version_number</span><span class="p">,</span> <span class="n">BranchBasedVersion</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">BranchBasedVersion</span><span class="p">)):</span>
                <span class="k">assert</span> <span class="n">d</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">branch</span> <span class="o">==</span> <span class="n">version_number</span><span class="o">.</span><span class="n">branch</span><span class="p">,</span> <span class="p">(</span>
                    <span class="s2">&quot;Unexpected branch found on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">_verify_firmware_update</span></div>


<div class="viewcode-block" id="boot_section_verifier"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.boot_section_verifier">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">boot_section_verifier</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: Object which can verify device boot sections.</span>
<span class="sd">    :rtype: :obj:`callable`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_verify_boot_section</span><span class="p">(</span><span class="n">devices</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_zb100</span><span class="p">():</span>
                <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;skipping ZB100 boot section check&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">upgrade_boot_section</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_bootsect_from_upgrade_log</span><span class="p">()</span>
            <span class="n">current_boot_section</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_boot_section</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">upgrade_boot_section</span> <span class="o">==</span> <span class="n">current_boot_section</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">&gt; booted from unexpected boot section&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">_verify_boot_section</span></div>


<div class="viewcode-block" id="updated_devices"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.updated_devices">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">updated_devices</span><span class="p">(</span><span class="n">firmware_updater</span><span class="p">,</span> <span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update all devices in the testbed to user specified firmware.</span>

<span class="sd">    :return: &#39;all_devices&#39; in testbed updated to user specified target</span>
<span class="sd">        firmware through &#39;firmware_updater&#39;.</span>
<span class="sd">    :rtype: :obj:`list`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">firmware_updater</span><span class="p">(</span><span class="n">all_devices</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Caught exception performing testbed update&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_devices</span></div>


<div class="viewcode-block" id="disable_wireless"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.disable_wireless">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">disable_wireless</span><span class="p">(</span><span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Disable wireless on &#39;all_devices&#39; in this testbed.</span>
<span class="sd">    Restore wireless in fixture teardown.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;disabling wireless on testbed&quot;</span><span class="p">)</span>
    <span class="n">run_concurrent_zone_player_processes</span><span class="p">(</span>
        <span class="n">SonosZoneComponent</span><span class="o">.</span><span class="n">wifi_disable</span><span class="p">,</span> <span class="n">all_devices</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_devices</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">d</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">is_wireless_enabled</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Expect wireless to be disabled on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="k">yield</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enabling wireless on testbed&quot;</span><span class="p">)</span>
    <span class="n">run_concurrent_zone_player_processes</span><span class="p">(</span>
        <span class="n">SonosZoneComponent</span><span class="o">.</span><span class="n">wifi_enable</span><span class="p">,</span> <span class="n">all_devices</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_devices</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">d</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">is_wireless_enabled</span><span class="p">()</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Expect wireless to be enabled on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span></div>


<div class="viewcode-block" id="disable_speaker_audio"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.disable_speaker_audio">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">disable_speaker_audio</span><span class="p">(</span><span class="n">all_device_which_can_override_amps_interface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Disable speaker audio on all_device_which_can_override_amps_interface by</span>
<span class="sd">    muting the amp/dac, on device that does not support mute function this</span>
<span class="sd">    fixture turns off the amp/dac. Includes Neptune.</span>
<span class="sd">    Restore the speaker amps on fixture teardown and clear amp override</span>

<span class="sd">    add `export ENABLE_SPEAKER_AUDIO=True` to your env to bypass</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Give the local tester an easy way to not disable audio while not having to</span>
    <span class="c1"># remove this fixture from wherever its called</span>
    <span class="n">enable_speaker_audio</span> <span class="o">=</span> <span class="n">str_to_bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ENABLE_SPEAKER_AUDIO&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">enable_speaker_audio</span><span class="p">:</span>
        <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">disable_speaker_audio</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> \
            <span class="n">all_device_which_can_override_amps_interface</span><span class="p">]</span>

        <span class="k">yield</span>

        <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">enable_speaker_audio</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> \
            <span class="n">all_device_which_can_override_amps_interface</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span></div>


<div class="viewcode-block" id="disable_audio_output"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.disable_audio_output">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">disable_audio_output</span><span class="p">(</span><span class="n">all_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Disable speaker audio on all_devices by adding a persistent file to the</span>
<span class="sd">    players that disables audio by writing pure zeros to the output.</span>
<span class="sd">    Restore the speaker audio on fixture teardown.</span>
<span class="sd">    NOTE: This fixture is different from `disable_speaker_audio` in that it</span>
<span class="sd">    does not turn the amps off on the player - it forces the final output to</span>
<span class="sd">    the speakers to be zeros.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">disable_audio_output</span><span class="p">(</span><span class="n">persistently_disable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span>
        <span class="n">all_devices</span><span class="p">]</span>
    <span class="k">yield</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">enable_audio_output</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_devices</span><span class="p">]</span></div>


<div class="viewcode-block" id="disable_autoplay"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.disable_autoplay">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">disable_autoplay</span><span class="p">(</span><span class="n">all_playback_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Disable Autoplay for both TV and line-in on &#39;all_playback_devices&#39; where</span>
<span class="sd">    relevant.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;disabling Autoplay on testbed devices&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">all_playback_devices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">ht_master_capable</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">SetAutoplayRoomUUID</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;TV&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">has_line_in</span><span class="p">():</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">SetAutoplayRoomUUID</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;RCA&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="unlock_testbed"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.unlock_testbed">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unlock_testbed</span><span class="p">(</span><span class="n">all_playback_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add &#39;/tmp/device_unlocked_flag&#39; to each device in &#39;all_playback_devices&#39;.</span>
<span class="sd">    Bounce anacapad on &#39;all_playback_devices&#39; after adding this file. When</span>
<span class="sd">    teardown is performed, remove &#39;/tmp/device_unlocked_flag&#39; and bounce</span>
<span class="sd">    anacapad on &#39;all_playback_devices&#39;.</span>

<span class="sd">    .. note::</span>

<span class="sd">        &#39;/tmp/device_unlocked_flag&#39; must be present on the device for some</span>
<span class="sd">        test features to be enabled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;unlocking testbed devices&quot;</span><span class="p">)</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;touch /tmp/device_unlocked_flag&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
     <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_playback_devices</span><span class="p">]</span>
    <span class="n">run_concurrent_zone_player_processes</span><span class="p">(</span>
        <span class="n">SonosZoneComponent</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">,</span> <span class="n">all_playback_devices</span><span class="p">)</span></div>
    <span class="c1"># [d.cli.command(&quot;rm /tmp/device_unlocked_flag&quot;, timeout=5)</span>
    <span class="c1">#        for d in all_playback_devices]</span>
    <span class="c1"># run_concurrent_zone_player_processes(</span>
    <span class="c1">#    SonosZoneComponent.bounce_anacapa_and_wait, all_playback_devices)</span>


<div class="viewcode-block" id="clear_playstate"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.clear_playstate">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">clear_playstate</span><span class="p">(</span><span class="n">all_playback_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clear the play state of &#39;all_playback_devices&#39; in this testbed before and</span>
<span class="sd">    after a testcase executes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Clearing play state on </span><span class="si">{}</span><span class="s2"> testbed devices&quot;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_playback_devices</span><span class="p">)))</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_playback_devices</span>
     <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;AVTransport&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">is_satellite</span><span class="p">()</span> <span class="ow">and</span>
     <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">is_secondary_bonded_zone</span><span class="p">()]</span>
    <span class="k">yield</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_playback_devices</span>
     <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;AVTransport&quot;</span><span class="p">)</span> <span class="ow">and</span>
     <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">is_satellite</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">is_secondary_bonded_zone</span><span class="p">()]</span></div>


<div class="viewcode-block" id="toslink_source"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.toslink_source">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">toslink_source</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a fixture that serves toslink.</span>

<span class="sd">    Expects the track name and the codec.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mplayer</span> <span class="o">=</span> <span class="n">MplayerAc3Playback</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="o">.</span><span class="n">param</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">mplayer</span>
    <span class="n">mplayer</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>  <span class="c1"># Explicit quit to kill the subprocess...</span></div>


<div class="viewcode-block" id="line_in_source"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.line_in_source">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">line_in_source</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields an mplayer instance capable of line in playback.</span>
<span class="sd">    Expect line in track name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mplayer</span> <span class="o">=</span> <span class="n">MplayerLineOutPlayback</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="o">.</span><span class="n">param</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">mplayer</span>
    <span class="n">mplayer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">mplayer</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span></div>


<div class="viewcode-block" id="mp3_line_in_source"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.mp3_line_in_source">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mp3_line_in_source</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields an mplayer instance capable of line in playback.</span>
<span class="sd">    Expect line in track name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mplayer</span> <span class="o">=</span> <span class="n">MplayerMp3LineOutPlayback</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">param</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">mplayer</span>
    <span class="n">mplayer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">mplayer</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span></div>


<div class="viewcode-block" id="play_htaudio_source"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.play_htaudio_source">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">play_htaudio_source</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new :class:`~audio_playback.mplayer_playback.MplayerAc3Playback`</span>
<span class="sd">    object to play a user specified home theater test track from the</span>
<span class="sd">    testrunner.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">htaudio_playback_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span>
        <span class="s2">&quot;htaudio_test_playback_file&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">MplayerAc3Playback</span><span class="p">(</span><span class="n">htaudio_playback_file</span><span class="p">):</span>
        <span class="k">yield</span></div>


<div class="viewcode-block" id="autoplay_htaudio_on_ht_masters"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.autoplay_htaudio_on_ht_masters">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">autoplay_htaudio_on_ht_masters</span><span class="p">(</span><span class="n">play_htaudio_source</span><span class="p">,</span>
                                   <span class="n">all_ht_master_capable_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start &#39;play_htaudio_source&#39; playback on this testrunner, and initiate</span>
<span class="sd">    playback on &#39;all_ht_master_capable_devices&#39;.</span>

<span class="sd">    On teardown, clear the playstate on &#39;all_ht_master_capable_devices&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">autoplay_uuids</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">[(</span><span class="n">d</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">GetAutoplayRoomUUID</span><span class="p">())</span>
         <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_ht_master_capable_devices</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">ht_master</span> <span class="ow">in</span> <span class="n">all_ht_master_capable_devices</span><span class="p">:</span>
        <span class="n">ht_master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">SetAutoplayRoomUUID</span><span class="p">(</span><span class="n">ht_master</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">ht_master</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for toslink playback to start&quot;</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="p">[</span><span class="n">master</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
     <span class="k">for</span> <span class="n">master</span> <span class="ow">in</span> <span class="n">all_ht_master_capable_devices</span><span class="p">]</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">SetAutoplayRoomUUID</span><span class="p">(</span><span class="n">autoplay_uuids</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">])</span>
     <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_ht_master_capable_devices</span><span class="p">]</span></div>


<div class="viewcode-block" id="save_volume"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.save_volume">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_volume</span><span class="p">(</span><span class="n">all_playback_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the starting volume for &#39;all_playback_devices&#39;.</span>

<span class="sd">    Restore starting volume for &#39;all_playback_devices&#39; in teardown.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">starting_volumes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">[(</span><span class="n">d</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetVolume</span><span class="p">())</span>
         <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_playback_devices</span><span class="p">])</span>
    <span class="k">yield</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_playback_devices</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="n">starting_volumes</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">])</span></div>


<div class="viewcode-block" id="zero_volume"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.zero_volume">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">zero_volume</span><span class="p">(</span><span class="n">save_volume</span><span class="p">,</span> <span class="n">all_playback_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set &#39;all_playback_devices&#39; to volume 0 for this session.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Volume will be restored to initial value in teardown.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_playback_devices</span><span class="p">]</span>
    <span class="k">yield</span></div>


<div class="viewcode-block" id="jenkins_build_number"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.jenkins_build_number">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">jenkins_build_number</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the current build number, if running from Jenkins.</span>

<span class="sd">    :return: Build number of this job</span>
<span class="sd">    :rtype: :obj:`str` or :obj:`None`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_build_number</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="playmode_repeat_all"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.playmode_repeat_all">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">playmode_repeat_all</span><span class="p">(</span><span class="n">all_playback_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the playmode of &#39;all_playback_devices&#39; to REPEAT_ALL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetPlayMode</span><span class="p">(</span><span class="s2">&quot;REPEAT_ALL&quot;</span><span class="p">)</span>
     <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">all_playback_devices</span>
     <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="s2">&quot;AVTransport&quot;</span><span class="p">)</span> <span class="ow">and</span>
     <span class="ow">not</span> <span class="n">device</span><span class="o">.</span><span class="n">is_satellite</span><span class="p">()</span> <span class="ow">and</span>
     <span class="ow">not</span> <span class="n">device</span><span class="o">.</span><span class="n">is_secondary_bonded_zone</span><span class="p">()]</span>
    <span class="k">yield</span></div>


<div class="viewcode-block" id="valgrind_test_delay"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.valgrind_test_delay">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">valgrind_test_delay</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the number of seconds to sleep after valgrind starts.</span>
<span class="sd">    :return: The time in seconds to sleep after starting valgrind</span>
<span class="sd">    This ensures that anacapa has initialized completely.</span>
<span class="sd">    :rtype: :obj:`int`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">test_delay</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">valgrind_test_delay</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">valgrind_duration</span>
    <span class="k">assert</span> <span class="n">test_delay</span> <span class="o">&lt;</span> <span class="n">duration</span><span class="p">,</span> <span class="s2">&quot;Expect test delay &lt; duration&quot;</span>
    <span class="k">return</span> <span class="n">test_delay</span></div>


<div class="viewcode-block" id="valgrind_user_suppressions"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.valgrind_user_suppressions">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">valgrind_user_suppressions</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: The user supplied suppressions file name</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">valgrind_user_suppressions</span></div>


<div class="viewcode-block" id="valgrind_exec_cmd"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.valgrind_exec_cmd">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">valgrind_exec_cmd</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: The command to execute under valgrind</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">valgrind_exec_cmd</span></div>


<div class="viewcode-block" id="valgrind_duration"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.valgrind_duration">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">valgrind_duration</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: The maximum time in seconds to run valgrind</span>
<span class="sd">    :rtype: :obj:`int`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">valgrind_duration</span></div>


<div class="viewcode-block" id="valgrind_listener_port"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.valgrind_listener_port">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">valgrind_listener_port</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: The TCP port number the valgrind-listener</span>
<span class="sd">    listens from reporting valgrinds</span>
<span class="sd">    :rtype: :obj:`int`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">valgrind_listener_port</span></div>


<div class="viewcode-block" id="valgrind_listener_path"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.valgrind_listener_path">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">valgrind_listener_path</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: The valgrind-listener path</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">valgrind_listener_path</span></div>


<div class="viewcode-block" id="valgrind_listener"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.valgrind_listener">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">valgrind_listener</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                      <span class="n">valgrind_listener_port</span><span class="p">,</span>
                      <span class="n">download_and_extract_archive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spawns the valgrind listener process on local system and yields</span>
<span class="sd">    the `valgrind_utils.valgrind_listener.ValgrindListener` object, using</span>
<span class="sd">    the :func:`valgrind_listener_port` and the Valgrind listener binaries</span>
<span class="sd">    extracted from :func:`download_and_extract_archive`.</span>

<span class="sd">    Note: The Valgrind binary is specified using the :func:`sqatools_spec`</span>
<span class="sd">    fixture, overridden in the Valgrind-specific directories.</span>

<span class="sd">    :return: The valgrind listener object</span>
<span class="sd">    :rtype: :obj:`valgrind_utils.valgrind_listener.ValgrindListener`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valgrind_listener_path</span> <span class="o">=</span> <span class="n">download_and_extract_archive</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">results_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">valgrind_results</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="n">ValgrindListener</span><span class="p">(</span><span class="n">valgrind_listener_port</span><span class="o">=</span><span class="n">valgrind_listener_port</span><span class="p">,</span>
                                <span class="n">valgrind_listener_exec_path</span><span class="o">=</span><span class="n">valgrind_listener_path</span><span class="p">,</span>
                                <span class="n">stdout</span><span class="o">=</span><span class="n">results_fh</span><span class="p">,</span>
                                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">listener</span>

    <span class="k">def</span> <span class="nf">wait_on_valgrind_listener</span><span class="p">(</span><span class="n">seconds_to_wait</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allow valgrind-listener process to terminate gracefully</span>
<span class="sd">        :param int seconds_to_wait: Seconds to wait for</span>
<span class="sd">        valgrind-listener to exit.</span>
<span class="sd">        :return: Popen returncode</span>
<span class="sd">        :rtype: :obj:`subprocess.Popen.poll`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expiration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">seconds_to_wait</span>
        <span class="c1"># Prevent listener waiting forever when testing with</span>
        <span class="c1"># all non-valgrind supported UPDs</span>
        <span class="k">while</span> <span class="n">expiration</span> <span class="o">&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">listener</span><span class="o">.</span><span class="n">poll</span><span class="p">(),</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Valgrind-listener is running&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">listener</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wait_on_valgrind_listener</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sending termination signal to valgrind-listener&quot;</span><span class="p">)</span>
        <span class="n">listener</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Valgrind listener exit status&quot;</span>
    <span class="n">results_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
    <span class="c1"># valgrind_listener_path will be removed by</span>
    <span class="c1"># download_and_extract_file tear down</span>


<div class="viewcode-block" id="valgrind_instances"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.valgrind_instances">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">valgrind_instances</span><span class="p">(</span><span class="n">valgrind_listener</span><span class="p">,</span>
                       <span class="n">valgrind_listener_port</span><span class="p">,</span>
                       <span class="n">valgrind_duration</span><span class="p">,</span>
                       <span class="n">valgrind_exec_cmd</span><span class="p">,</span>
                       <span class="n">valgrind_user_suppressions</span><span class="p">,</span>
                       <span class="n">all_filtered_platform_valgrind_capable_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiate valgrind jobs based on valgrind capable devices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">iface_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">iface_name</span> <span class="k">for</span> <span class="n">iface_name</span> <span class="ow">in</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">interfaces</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">iface_name</span> <span class="o">!=</span> <span class="s1">&#39;lo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">listener_ip</span> <span class="o">=</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="n">iface_name</span><span class="p">)[</span><span class="n">netifaces</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span>
    <span class="c1"># Check if we&#39;re executing a non anacapad command</span>
    <span class="k">if</span> <span class="s1">&#39;anacapad&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valgrind_exec_cmd</span><span class="p">:</span>
        <span class="n">valgrinds</span> <span class="o">=</span> <span class="p">[</span><span class="n">ValgrindZoneWrapper</span><span class="p">(</span><span class="n">zone</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                                         <span class="n">listener_ip</span><span class="p">,</span>
                                         <span class="n">valgrind_exec_cmd</span><span class="p">,</span>
                                         <span class="n">suppressions</span><span class="o">=</span><span class="n">valgrind_user_suppressions</span><span class="p">,</span>
                                         <span class="n">listener_port</span><span class="o">=</span><span class="n">valgrind_listener_port</span><span class="p">,</span>
                                         <span class="n">duration</span><span class="o">=</span><span class="n">valgrind_duration</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">all_filtered_platform_valgrind_capable_devices</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valgrinds</span> <span class="o">=</span> <span class="p">[</span><span class="n">ValgrindZoneAnacapaWrapper</span><span class="p">(</span><span class="n">zone</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                                                <span class="n">listener_ip</span><span class="p">,</span>
                                                <span class="n">valgrind_exec_cmd</span><span class="p">,</span>
                                                <span class="n">suppressions</span><span class="o">=</span><span class="n">valgrind_user_suppressions</span><span class="p">,</span>
                                                <span class="n">listener_port</span><span class="o">=</span><span class="n">valgrind_listener_port</span><span class="p">,</span>
                                                <span class="n">duration</span><span class="o">=</span><span class="n">valgrind_duration</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">all_filtered_platform_valgrind_capable_devices</span><span class="p">]</span>
    <span class="k">yield</span> <span class="n">valgrinds</span></div>


<div class="viewcode-block" id="valgrind_create"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.valgrind_create">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">valgrind_create</span><span class="p">(</span><span class="n">valgrind_instances</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Installs valgrind and dependent files on target platform.</span>
<span class="sd">    Yields the valgrind objects.</span>
<span class="sd">    Removes valgrind and dependent files from target platform.</span>
<span class="sd">    :return: Yields a list of valgrind objects</span>
<span class="sd">    :rtype: :obj:`valgrind_utils.valgrind_base.ValgrindZoneWrapper`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valgrinds</span> <span class="o">=</span> <span class="n">valgrind_instances</span>
    <span class="p">[</span><span class="n">valgrind</span><span class="o">.</span><span class="n">install</span><span class="p">()</span> <span class="k">for</span> <span class="n">valgrind</span> <span class="ow">in</span> <span class="n">valgrinds</span><span class="p">]</span>
    <span class="k">yield</span> <span class="n">valgrinds</span>
    <span class="p">[</span><span class="n">valgrind</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span> <span class="k">for</span> <span class="n">valgrind</span> <span class="ow">in</span> <span class="n">valgrinds</span><span class="p">]</span></div>


<div class="viewcode-block" id="valgrind_run"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.valgrind_run">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">valgrind_run</span><span class="p">(</span><span class="n">valgrind_test_delay</span><span class="p">,</span> <span class="n">valgrind_create</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Starts a valgrind run on valgrind capable devices.</span>

<span class="sd">    :return: Yields a list of valgrind objects</span>
<span class="sd">    :rtype: :obj:`valgrind_utils.valgrind_base.ValgrindZoneWrapper`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valgrinds</span> <span class="o">=</span> <span class="n">valgrind_create</span>
    <span class="p">[</span><span class="n">valgrind</span><span class="o">.</span><span class="n">run</span><span class="p">()</span> <span class="k">for</span> <span class="n">valgrind</span> <span class="ow">in</span> <span class="n">valgrinds</span><span class="p">]</span>
    <span class="c1"># If we&#39;re running anacapa, we need to let valgrind</span>
    <span class="c1"># run for a few minutes to let anacapa initialize</span>
    <span class="n">delay_expiration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">valgrind_test_delay</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valgrinds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ValgrindZoneAnacapaWrapper</span><span class="p">):</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Sleeping </span><span class="si">{}</span><span class="s2"> to let anacapa initialize&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">valgrind_test_delay</span><span class="p">))</span>
        <span class="c1"># Wait until delay_expiration time unless all valgrind</span>
        <span class="c1"># have terminated prematurely</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">any</span><span class="p">([</span><span class="n">valgrind</span><span class="o">.</span><span class="n">alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">valgrind</span> <span class="ow">in</span> <span class="n">valgrinds</span><span class="p">])</span> <span class="ow">and</span>
               <span class="n">delay_expiration</span> <span class="o">&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">valgrinds</span>
    <span class="p">[</span><span class="n">valgrind</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span> <span class="k">for</span> <span class="n">valgrind</span> <span class="ow">in</span> <span class="n">valgrinds</span><span class="p">]</span></div>


<div class="viewcode-block" id="operation_kwargs"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.operation_kwargs">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">operation_kwargs</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return keyword arguments used by operations applied to the current</span>
<span class="sd">    testcase.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This fixture should only be used by other fixtures which implement</span>
<span class="sd">        testbed operations.</span>

<span class="sd">    :returns: Map of testbed operation keyword arguments to values.</span>
<span class="sd">    :rtype: :obj:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If &#39;usefixtures&#39; isn&#39;t used, then by definition there are no</span>
    <span class="c1"># kwargs.</span>
    <span class="k">if</span> <span class="s1">&#39;usefixtures&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s2">&quot;usefixtures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">kwargs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="operation_devices"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.operation_devices">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">operation_devices</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">operation_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return devices specified by testbed operation fixtures that are used by</span>
<span class="sd">    the current testcase.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This fixture should only be used by other fixtures which implement</span>
<span class="sd">        testbed operations.</span>

<span class="sd">    :returns: Map of testbed operations names to devices.</span>
<span class="sd">    :rtype: :obj:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_operation_fixture_names</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="n">fixtures</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">operation_fixture_names</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s2">&quot;operation_fixture_names&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">operation_kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_fixture_names&quot;</span><span class="p">):</span>
                <span class="n">basename</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_fixture_names&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fixtures</span><span class="p">[</span><span class="n">basename</span><span class="p">]</span> <span class="o">=</span> <span class="n">flatten_lists</span><span class="p">(</span><span class="n">operation_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">operation_fixture_names</span><span class="p">:</span>
            <span class="n">fixtures</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flatten_lists</span><span class="p">(</span><span class="n">operation_fixture_names</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fixtures</span>

    <span class="n">devices</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">operation_fixtures</span> <span class="o">=</span> <span class="n">get_operation_fixture_names</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fixtures</span> <span class="ow">in</span> <span class="n">operation_fixtures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">devices</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">flatten_lists</span><span class="p">(</span>
            <span class="o">*</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">getfixturevalue</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span> <span class="k">for</span> <span class="n">fixture</span> <span class="ow">in</span> <span class="n">fixtures</span><span class="p">])</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Found devices for testbed operations: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">devices</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">devices</span></div>


<div class="viewcode-block" id="default_operation_devices"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.default_operation_devices">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">default_operation_devices</span><span class="p">(</span><span class="n">operation_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specifies devices which a testbed operation fixture should use by default.</span>


<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Specify default testbed operation devices for module.</span>

<span class="sd">        pytestmark = pytest.mark.operation_devices(&quot;playback_device&quot;)</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Specifying default testbed operation devices for testcase</span>
<span class="sd">            or class.</span>

<span class="sd">        @pytest.operation_devices(&quot;playback_device&quot;)</span>

<span class="sd">    :return: List of testbed devices.</span>
<span class="sd">    :rtype: :obj:`list`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">operation_devices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="capture_anacapa_devices"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.capture_anacapa_devices">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">capture_anacapa_devices</span><span class="p">(</span><span class="n">operation_devices</span><span class="p">,</span> <span class="n">default_operation_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return testbed devices that the *capture_anacapa_logs* fixture should use,</span>
<span class="sd">    or *default_operation_devices*</span>

<span class="sd">    Devices returned by this fixture</span>

<span class="sd">        * &quot;capture_anacapa_fixture_names&quot;: Names of one (or more) Pytest</span>
<span class="sd">            fixtures which return testbed devices that should be used by the</span>
<span class="sd">            *capture_anacapa_logs* fixture.</span>

<span class="sd">    If no fixture names were specified, use devices specified by the</span>
<span class="sd">    *default_operation_devices* fixture.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        Fixtures specified by &quot;capture_anacapa_fixture_names&quot; must be used by</span>
<span class="sd">        the current testcase, or must be session scoped and returning an</span>
<span class="sd">        already cached value.</span>

<span class="sd">    :returns: Devices for *capture_anacapa_logs* to use.</span>
<span class="sd">    :rtype: :obj:`list`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="p">(</span><span class="n">operation_devices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capture_anacapa&quot;</span><span class="p">)</span>
               <span class="ow">or</span> <span class="n">default_operation_devices</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">devices</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;No devices were specified. Use &#39;capture_anacapa_fixture_names&#39; &quot;</span>
        <span class="s2">&quot;to specify 1 (or more) fixtures which return testbed devices.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">devices</span></div>


<div class="viewcode-block" id="capture_anacapa_watch_strings"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.capture_anacapa_watch_strings">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">capture_anacapa_watch_strings</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">operation_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return list of strings which should be monitored for in captured</span>
<span class="sd">    anacapa.trace logs.</span>

<span class="sd">    This fixture responds to the following keyword arguments:</span>

<span class="sd">        * watch_for_strings: A list of 1 (or more) strings to scan</span>
<span class="sd">            anacapa.trace messages for.</span>

<span class="sd">    :return: Strings to watch incoming anacapa.trace messages for.</span>
<span class="sd">    :rtype: :obj:`list`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">watch_strings</span> <span class="o">=</span> <span class="n">operation_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;watch_for_strings&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">return</span> <span class="n">watch_strings</span></div>


<div class="viewcode-block" id="write_anacapa_logs"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.write_anacapa_logs">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">write_anacapa_logs</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">operation_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Whether or not to save the UDP log messages to a file persistently</span>
<span class="sd">    across reboots or anacapa restart</span>

<span class="sd">    :return: True if &quot;log_persistently&quot; set to True in kwargs</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">should_write</span> <span class="o">=</span> <span class="n">operation_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;should_write&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">should_write</span></div>


<div class="viewcode-block" id="diag_levels"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.diag_levels">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">diag_levels</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">operation_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns settings to configure diag levels configured by the</span>
<span class="sd">    *override_diag_levels* fixture.</span>

<span class="sd">    This fixture responds to the following keyword arguments:</span>

<span class="sd">        * &#39;diag_levels&#39;: 1 (or more) diagnostic levels to modify. Diag levels</span>
<span class="sd">        are specified as a :obj:`tuple` with 2 elements:</span>
<span class="sd">             * a :obj:`str` identifying the diagnostic module name</span>
<span class="sd">             * a :obj:`int` to specify the desired level.</span>
<span class="sd">        Examples:</span>
<span class="sd">             * [(&#39;htap&#39;, 3)]</span>
<span class="sd">             * [(&#39;default&#39;, 5), (&#39;htap&#39;, 1)]</span>

<span class="sd">    :return: Diagnostic levels for *override_diag_levels* to use.</span>
<span class="sd">    :rtype: :obj:`list`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diag_levels</span> <span class="o">=</span> <span class="n">operation_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;diag_levels&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">diag_levels</span><span class="p">,</span> <span class="s2">&quot;No diag levels specified.&quot;</span>
    <span class="k">return</span> <span class="n">diag_levels</span></div>


<div class="viewcode-block" id="diag_level_devices"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.diag_level_devices">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">diag_level_devices</span><span class="p">(</span><span class="n">operation_devices</span><span class="p">,</span> <span class="n">default_operation_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return testbed devices that the *override_diag_levels* fixture should use,</span>
<span class="sd">    or *default_operation_devices*</span>

<span class="sd">    This fixture responds to the following keyword arguments:</span>

<span class="sd">        * &quot;diag_level_fixture_names&quot;: Names of one (or more) Pytest fixtures</span>
<span class="sd">            which return testbed devices that should be used by the</span>
<span class="sd">            *override_diag_levels* fixture.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        Fixtures specified by &quot;diag_level_fixture_names&quot; must be used by the</span>
<span class="sd">        current testcase, or must be session scoped and returning an already</span>
<span class="sd">        cached value.</span>

<span class="sd">    :returns: Devices for *override_diag_levels* to use.</span>
<span class="sd">    :rtype: :obj:`list`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">operation_devices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;diag_level&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">default_operation_devices</span>
    <span class="k">assert</span> <span class="n">devices</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;No devices were specified. Use &#39;diag_level_fixture_names&#39; &quot;</span>
        <span class="s2">&quot;to specify 1 (or more) fixtures which return testbed devices.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">devices</span></div>


<div class="viewcode-block" id="capture_anacapa_logs"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.capture_anacapa_logs">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">capture_anacapa_logs</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">capture_anacapa_devices</span><span class="p">,</span> <span class="n">capture_anacapa_watch_strings</span><span class="p">,</span>
        <span class="n">write_anacapa_logs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Capture anacapa.trace logs from *capture_anacapa_devices*. Optionally scan</span>
<span class="sd">    incoming messages for strings specified by *capture_anacapa_watch_strings*.</span>

<span class="sd">    Devices are restored to a normal state after the testcase completes.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        Changes made by this fixture will be reverted if testbed devices are</span>
<span class="sd">        restarted/bounced unless write_anacapa_logs is set to True, in which</span>
<span class="sd">        case, we&#39;ll still be able to watch the strings once the player</span>
<span class="sd">        begins sending us logs again after reboot/bounce.</span>

<span class="sd">    .. note::</span>

<span class="sd">        The following keyword arguments can be used to control the behavior</span>
<span class="sd">        of this fixture (when used on testcases, classes, or modules).</span>

<span class="sd">            * &quot;capture_anacapa_fixture_names&quot;</span>
<span class="sd">            * &quot;watch_for_strings&quot;</span>
<span class="sd">            * &quot;write_anacapa_logs&quot;</span>

<span class="sd">        Refer to *capture_anacapa_devices*, *capture_anacapa_watch_strings*,</span>
<span class="sd">        and *write_anacapa_logs* fixtures for more details.</span>

<span class="sd">    .. note::</span>

<span class="sd">        To access captured anacapa.trace messages for a device, use</span>
<span class="sd">        :meth:`~sonos.services.diag.Diag.get_udp_log`.</span>

<span class="sd">        To check if a :obj:`str` being watched for has been detected in</span>
<span class="sd">        incoming anacapa.trace logs, use</span>
<span class="sd">        :meth:`~sonos.services.diag.Diag.has_search_results`.</span>

<span class="sd">        To get the number of times a :obj:`str` being watched for has been</span>
<span class="sd">        detected in incoming anacapa.trace logs, use</span>
<span class="sd">        :meth:`~sonos.services.diag.Diag.get_search_results`.</span>

<span class="sd">    This fixture can be used either as a testcase/class.</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Using &#39;capture_anacapa_logs&#39; decorator on test case/class</span>

<span class="sd">        @pytest.capture_anacapa_logs(</span>
<span class="sd">            capture_anacapa_fixture_names=&quot;playback_device&quot;,</span>
<span class="sd">            watch_for_strings=[&quot;large sync error&quot;, &quot;small_sync_error&quot;],</span>
<span class="sd">            should_write=True)</span>

<span class="sd">    This fixture can be applied to all testcases in a module.</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Using &#39;capture_anacapa_logs&#39; on all testcases in module</span>

<span class="sd">        pytestmark = [</span>
<span class="sd">            pytest.capture_anacapa_logs(</span>
<span class="sd">                capture_anacapa_fixture_names=[&quot;playback_device&quot;, &quot;bridge&quot;],</span>
<span class="sd">                watch_for_strings=[&quot;large_sync_error&quot;, &quot;small_sync_error&quot;],</span>
<span class="sd">                should_write=True)]</span>

<span class="sd">    This fixture can be used as a positional argument (like a normal Pytest</span>
<span class="sd">    fixture). This is especially useful in cases where test(s) use fixtures</span>
<span class="sd">    that restart testbed devices, and undo any testbed logging changes that</span>
<span class="sd">    may have been applied.</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Using &#39;capture_anacapa_logs&#39; as a positional fixture</span>

<span class="sd">        @pytest.fixture</span>
<span class="sd">        def capture_anacapa_watch_strings():</span>
<span class="sd">            return [&quot;large sync error&quot;, &quot;small sync error&quot;]</span>

<span class="sd">        @pytest.fixture</span>
<span class="sd">        def capture_anacapa_devices(request):</span>
<span class="sd">            return request.getfixturevalue(&quot;all_devices&quot;)</span>

<span class="sd">        def expensive_fixture():</span>
<span class="sd">            ... &lt;perform expensive setup that bounces testbed devices&gt;</span>

<span class="sd">        def test_something(</span>
<span class="sd">            all_devices, expensive_fixture, capture_anacapa_logs):</span>
<span class="sd">            ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_test_case_name</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_filename_for_device</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">get_arch</span><span class="p">(),</span>
                                        <span class="n">get_test_case_name</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">setup_persistent_udp_logging</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">d</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log_to_file</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">get_filename_for_device</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
            <span class="n">persist_across_anacapa_restart</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">teardown_persistent_udp_logging</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">d</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_udp_logging_ip_and_port_on_start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">log_testcase_on_device</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">post_diagmsg</span><span class="p">(</span><span class="s2">&quot;Pytest: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()))]</span>

    <span class="k">if</span> <span class="n">write_anacapa_logs</span><span class="p">:</span>
        <span class="p">[</span><span class="n">setup_persistent_udp_logging</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">capture_anacapa_devices</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">capture_anacapa_devices</span><span class="p">]</span>

    <span class="p">[</span><span class="n">log_testcase_on_device</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">capture_anacapa_devices</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">watch_str</span> <span class="ow">in</span> <span class="n">capture_anacapa_watch_strings</span><span class="p">:</span>
        <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">watch_udp_log_for_string</span><span class="p">(</span><span class="n">watch_str</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">capture_anacapa_devices</span><span class="p">]</span>
    <span class="k">yield</span>
    <span class="p">[</span><span class="n">log_testcase_on_device</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">capture_anacapa_devices</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">write_anacapa_logs</span><span class="p">:</span>
        <span class="p">[</span><span class="n">teardown_persistent_udp_logging</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">capture_anacapa_devices</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">capture_anacapa_devices</span><span class="p">]</span></div>


<div class="viewcode-block" id="override_diag_levels"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.override_diag_levels">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">override_diag_levels</span><span class="p">(</span><span class="n">diag_level_devices</span><span class="p">,</span> <span class="n">diag_levels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Operation fixture to override anacapa.trace diagnostic levels on</span>
<span class="sd">    *diag_level_devices* with settings returned by *diag_levels*.</span>

<span class="sd">    Diag levels are restored to a default state after use.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        Changes made by this fixture will be reverted if testbed devices are</span>
<span class="sd">        restarted/bounced.</span>

<span class="sd">    .. note::</span>

<span class="sd">        The following keyword arguments can be used to control the behavior</span>
<span class="sd">        of this fixture (when used on testcases, classes, or modules).</span>

<span class="sd">            * &quot;diag_level_fixture_names&quot;</span>
<span class="sd">            * &quot;diag_levels&quot;</span>

<span class="sd">        Refer to *diag_level_devices* and *diag_levels* fixtures for more</span>
<span class="sd">        details.</span>

<span class="sd">    This fixture can be used either as a testcase/class.</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Using &#39;override_diag_levels&#39; decorator on test case/class</span>

<span class="sd">        @pytest.override_diag_levels(</span>
<span class="sd">            diag_level_fixture_names=&quot;playback_device&quot;,</span>
<span class="sd">            diag_levels=[(&quot;default&quot;, 3)])</span>

<span class="sd">    This fixture can be applied to all testcases in a module.</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Using &#39;override_diag_levels&#39; on all testcases in module</span>

<span class="sd">        pytestmark = [</span>
<span class="sd">            pytest.override_diag_levels(</span>
<span class="sd">                diag_level_fixture_names=[&quot;playback_device&quot;, &quot;bridge&quot;],</span>
<span class="sd">                diag_levels=[(&quot;default&quot;, 3), (&quot;upnp&quot;, 10)])]</span>

<span class="sd">    This fixture can be used as a positional argument (like a normal Pytest</span>
<span class="sd">    fixture). This is especially useful in cases where test(s) use fixtures</span>
<span class="sd">    that restart testbed devices, and undo any testbed logging changes that</span>
<span class="sd">    may have been applied.</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Using &#39;override_diag_levels&#39; as a positional fixture</span>

<span class="sd">        @pytest.fixture</span>
<span class="sd">        def diag_levels():</span>
<span class="sd">            return [(&quot;default&quot;, 5), (&quot;htap&quot;, 10)]</span>

<span class="sd">        @pytest.fixture</span>
<span class="sd">        def diag_level_devices(request):</span>
<span class="sd">            return request.getfixturevalue(&quot;all_devices&quot;)</span>

<span class="sd">        def expensive_fixture():</span>
<span class="sd">            ... &lt;perform expensive setup that bounces testbed devices&gt;</span>

<span class="sd">        def test_something(</span>
<span class="sd">            all_devices, expensive_fixture, override_diag_levels):</span>
<span class="sd">            ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">diag_level_devices</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">diag_levels</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">diag_level_devices</span><span class="p">]</span></div>


<div class="viewcode-block" id="write_udp_on_failure"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.write_udp_on_failure">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">write_udp_on_failure</span><span class="p">(</span><span class="n">diag_level_devices</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the captured anacapa logs for the current device to the local server. It will be of the form</span>
<span class="sd">    &lt;&lt;test-id&gt;&gt;_&lt;&lt;datetime&gt;&gt;_anacapa.trace</span>
<span class="sd">    :param diag_level_devices: Device selection fixture returns a list with a single element</span>
<span class="sd">    :param request: The request object, contains test context including name and results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make sure the test runs first</span>
    <span class="k">yield</span>

    <span class="n">zp</span> <span class="o">=</span> <span class="n">diag_level_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">current_reporter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">getplugin</span><span class="p">(</span><span class="s2">&quot;terminalreporter&quot;</span><span class="p">)</span>
    <span class="n">test_stats</span> <span class="o">=</span> <span class="n">current_reporter</span><span class="o">.</span><span class="n">stats</span>
    <span class="k">if</span> <span class="s1">&#39;failed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">test_stats</span><span class="p">:</span>
        <span class="c1"># No failures, move along</span>
        <span class="k">return</span>
    <span class="c1"># Did the current test fail (function-scope fixture, check reporter results for this test.</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">tst</span> <span class="k">for</span> <span class="n">tst</span> <span class="ow">in</span> <span class="n">current_reporter</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">tst</span><span class="o">.</span><span class="n">nodeid</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">nodeid</span><span class="p">):</span>
        <span class="n">date_time_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">DATETIME_FORMAT</span><span class="p">)</span>
        <span class="n">trace_log</span> <span class="o">=</span> <span class="n">UDP_LOG_FILE_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                               <span class="n">date_time_str</span><span class="p">)</span>
        <span class="n">keepcharacters</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">trace_log</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trace_log</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">keepcharacters</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">write_udp_log_to_file</span><span class="p">(</span><span class="n">trace_log</span><span class="p">)</span></div>


<div class="viewcode-block" id="current_test_dir"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.current_test_dir">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">current_test_dir</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :returns: The directory of the currently executing testcase.</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span></div>


<div class="viewcode-block" id="webserver_path"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.webserver_path">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">webserver_path</span><span class="p">(</span><span class="n">current_test_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Path used when starting a :class:`~sonos.websrv.WebServer`.</span>

<span class="sd">    The default behavior is to use the directory of the currently executing</span>
<span class="sd">    testcase.</span>

<span class="sd">    Override this fixture to change the path used.</span>

<span class="sd">    :returns: Path for :class:`~sonos.websrv.WebServer` to share.</span>
<span class="sd">    :rtype: :obj:`str`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">current_test_dir</span></div>


<div class="viewcode-block" id="webserver_port"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.webserver_port">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">webserver_port</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the port to use for the local file webserver. This can be overridden in your local</span>
<span class="sd">    test file if you need to use a custom port for a specific test.</span>
<span class="sd">    :return: The port number to use with the local Web Server</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;webserver_port&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="webserver"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.webserver">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">webserver</span><span class="p">(</span><span class="n">webserver_path</span><span class="p">,</span> <span class="n">webserver_port</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new :class:`~sonos.websrv.WebServer` instance, sharing the path</span>
<span class="sd">    returned by *webserver_path*.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">WebServer</span><span class="p">(</span><span class="n">start_reactor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">webserver_port</span><span class="p">,</span> <span class="n">webserver_path</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">ws</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>


<div class="viewcode-block" id="webserver_track_url_builder"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.webserver_track_url_builder">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">webserver_track_url_builder</span><span class="p">(</span><span class="n">webserver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This fixture converts a track-name to a URL playable on the Player</span>
<span class="sd">    Usage:</span>
<span class="sd">        def some_test(track_url, track_names):</span>
<span class="sd">            # Assuming track_names is just the list of file names</span>
<span class="sd">            track_urls = [track_url(track_name) for track_name in track_names]</span>
<span class="sd">    :param webserver: The webserver fixture running on the local machine</span>
<span class="sd">    :return: The initial fixture returns a function, and that function returns the URL for the provided track</span>
<span class="sd">    name on the local web server</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">build_url</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">webserver</span><span class="o">.</span><span class="n">secure</span><span class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="s1">&#39;https://&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">webserver</span><span class="o">.</span><span class="n">host</span><span class="p">(),</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">build_url</span></div>


<div class="viewcode-block" id="hdmi_cec_base"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.hdmi_cec_base">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hdmi_cec_base</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The HDMI CEC testbeds have pulse eight adapters that are connected to the</span>
<span class="sd">    testrunner to send CEC commands on the HDMI line via USB. In order to use</span>
<span class="sd">    the tool, the libcec dependency needs to be installed. Since we only use</span>
<span class="sd">    2 - 3 testbeds for HDMI CEC testing, not all of them can import this libcec</span>
<span class="sd">    dependency. This is meant to allow skipping the import.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pytest</span><span class="o">.</span><span class="n">importorskip</span><span class="p">(</span><span class="s2">&quot;hdmi.cec_base&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="hdmi_adapter"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.hdmi_adapter">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hdmi_adapter</span><span class="p">(</span><span class="n">hdmi_cec_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield an ARCDevice object, configured with the test runner&#39;s Arduino</span>
<span class="sd">    EDID emulator and p8 adapter.</span>

<span class="sd">    :return: ARCDevice object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arduino_port</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">testbed_config</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;testbed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span>
        <span class="s1">&#39;arduino_port&#39;</span>
    <span class="p">]</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="n">hdmi_cec_base</span><span class="o">.</span><span class="n">ARCDevice</span><span class="p">(</span>
        <span class="n">arduino_port</span><span class="o">=</span><span class="n">arduino_port</span><span class="p">,</span>
        <span class="n">edid</span><span class="o">=</span><span class="n">hdmi_cec_base</span><span class="o">.</span><span class="n">ARCDevice</span><span class="o">.</span><span class="n">DEFAULT_EDID</span><span class="p">)</span>

    <span class="n">adapter</span><span class="o">.</span><span class="n">arduino</span><span class="o">.</span><span class="n">load_edid_from_file</span><span class="p">(</span><span class="n">hdmi_cec_base</span><span class="o">.</span><span class="n">ARCDevice</span><span class="o">.</span><span class="n">DEFAULT_EDID</span><span class="p">)</span>
    <span class="n">adapter</span><span class="o">.</span><span class="n">toggle_hpd</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">adapter</span>
    <span class="n">adapter</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">adapter</span><span class="o">.</span><span class="n">arduino</span><span class="o">.</span><span class="n">teardown_serial_connection</span><span class="p">()</span>
    <span class="n">adapter</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span></div>


<div class="viewcode-block" id="hdmi_adapter_clean"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.hdmi_adapter_clean">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hdmi_adapter_clean</span><span class="p">(</span><span class="n">hdmi_adapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    On top of the session scoped setup and teardown of hdmi_adapter(), this</span>
<span class="sd">    fixture has a teardown for each individual CEC test such as clearing</span>
<span class="sd">    callbacks. This fixture will run for most of the HDMI CEC tests.</span>
<span class="sd">    Note: Be careful about changes made to this fixture because it will</span>
<span class="sd">          affect compliance. If using any generic_cb from the Pulse8Base</span>
<span class="sd">          object in pulse8_base.py, make sure to clear callbacks between tests.</span>

<span class="sd">    :return: ARCDevice object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="n">hdmi_adapter</span>

    <span class="c1"># No setup</span>
    <span class="k">yield</span> <span class="n">adapter</span>
    <span class="n">adapter</span><span class="o">.</span><span class="n">clear_generic_cbs</span><span class="p">()</span></div>


<div class="viewcode-block" id="wait_for_assert"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.wait_for_assert">[docs]</a><span class="k">def</span> <span class="nf">wait_for_assert</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">retry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">info_threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># type: (object, object, object, object, object, object, object, object) -&gt; object</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A polling assertion -- will continue attempting the predicate until</span>
<span class="sd">    either the condition is met (assertion passes), or the time expires.</span>

<span class="sd">    :param predicate: argument-less method which evaluates the wait condition and returns</span>
<span class="sd">        a boolean</span>
<span class="sd">    :type predicate: lambda that returns a boolean value</span>
<span class="sd">    :param float iteration_delay: number of seconds to sleep between each call</span>
<span class="sd">        to the predicate</span>
<span class="sd">    :param int timeout_seconds: number of seconds to wait for predicate to</span>
<span class="sd">        return True.</span>
<span class="sd">    :param retry: optional function to be called on each iteration</span>
<span class="sd">    :type retry: lambda or None</span>
<span class="sd">    :param info_threshold: Amount of time that must pass before the elapsed time is logged</span>
<span class="sd">    (i.e., limit for determining whether the wait time is significant)</span>
<span class="sd">    :param msg: Message to write upon failure of the assertion</span>
<span class="sd">    :param float start_delay: Hard sleep before evaluating predicate. It will</span>
<span class="sd">    still use timeout_seconds thereafter to evaluate predicate.</span>
<span class="sd">    :return: Time elapsed for the assertion to succeed in seconds</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    :raises: AssertionError exception if the condition is not met in the specified time</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">wait_until_true</span><span class="p">(</span>
            <span class="n">predicate</span><span class="p">,</span>
            <span class="n">iteration_delay</span><span class="p">,</span>
            <span class="n">timeout_seconds</span><span class="p">,</span>
            <span class="n">retry</span><span class="p">,</span>
            <span class="n">info_threshold</span><span class="p">,</span>
            <span class="n">msg</span><span class="p">,</span>
            <span class="n">start_delay</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">te</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2"> after </span><span class="si">{}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">te</span><span class="p">),</span> <span class="n">timeout_seconds</span><span class="p">)</span></div>


<div class="viewcode-block" id="ap"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.ap">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ap</span><span class="p">(</span><span class="n">testbed_config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;LEDE or OpenWRT wireless access point interface</span>

<span class="sd">    .. note::</span>

<span class="sd">        This fixture requires an access point to be configured in your testbed</span>
<span class="sd">        configuration.</span>

<span class="sd">    :returns: A Wi-Fi ap handle which implements the AccessPoint interface</span>
<span class="sd">    :rtype: Generator for :class:`AccessPoint`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ap_config</span> <span class="o">=</span> <span class="n">testbed_config</span><span class="o">.</span><span class="n">testbed</span><span class="o">.</span><span class="n">access_point</span>
    <span class="n">wifi_ap</span> <span class="o">=</span> <span class="n">OpenWrtAccessPoint</span><span class="p">(</span>
        <span class="n">openwrt_handle</span><span class="o">=</span><span class="n">ap_config</span><span class="p">,</span>
        <span class="n">testbed_config</span><span class="o">=</span><span class="n">testbed_config</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">wifi_ap</span></div>


<div class="viewcode-block" id="bluetooth_adapter_base"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.bluetooth_adapter_base">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bluetooth_adapter_base</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Bluetooth testbeds have special module dependencies. In order to use</span>
<span class="sd">    the tool, these dependencies need to be installed. Since we only use</span>
<span class="sd">    a few testbeds for Bluetooth testing, not all of them can import this</span>
<span class="sd">    dependency. This is meant to allow skipping the import.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pytest</span><span class="o">.</span><span class="n">importorskip</span><span class="p">(</span><span class="s2">&quot;bluetooth.adapter&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="bluetooth_adapter"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.bluetooth_adapter">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bluetooth_adapter</span><span class="p">(</span><span class="n">bluetooth_adapter_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixture to yield a BluetoothAdapter object with the Bluetooth</span>
<span class="sd">    radio already turned on. Turns off radio at end of test.</span>

<span class="sd">    :return: BluetoothAdapter object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bta</span> <span class="o">=</span> <span class="n">bluetooth_adapter_base</span><span class="o">.</span><span class="n">BluetoothAdapter</span><span class="p">()</span>
    <span class="n">bta</span><span class="o">.</span><span class="n">turn_radio_on</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">bta</span>
    <span class="n">bta</span><span class="o">.</span><span class="n">stop_playback</span><span class="p">()</span>
    <span class="n">bta</span><span class="o">.</span><span class="n">turn_radio_off</span><span class="p">()</span></div>


<div class="viewcode-block" id="sqatools_spec"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.sqatools_spec">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqatools_spec</span><span class="p">(</span><span class="n">update_url</span><span class="p">,</span> <span class="n">version_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base fixture that returns params needed to download and extract an</span>
<span class="sd">    archive from sqa tool tar file.</span>
<span class="sd">    Note: This fixture should be overridden to add the following information:</span>
<span class="sd">        &#39;archive_files&#39;: a dictionary with the format</span>
<span class="sd">            key: path to the resource within the archive</span>
<span class="sd">            value: relative or absolute path for the extracted file (relative</span>
<span class="sd">                to the current working directory)</span>
<span class="sd">        &#39;platform&#39;: a :obj:`str` or :obj:`list` of platform names for the entire</span>
<span class="sd">            set of platform archives to search for the files indicated in</span>
<span class="sd">            &#39;archive_files&#39;. The</span>
<span class="sd">            :class:`~sonos.client.downloadmanager.DownloadManager` class will</span>
<span class="sd">            download the archive file for each platform specified, searching for</span>
<span class="sd">            the files in each downloaded archive.</span>

<span class="sd">    The :class:`~sonos.client.downloadmanager.DownloadManager` uses a broad</span>
<span class="sd">    search process, searching all named platforms archives for the list</span>
<span class="sd">    of selected files. You don&#39;t have to specify which platform-archive hosts</span>
<span class="sd">    which platform-specific tool or file; the class will check them all.</span>

<span class="sd">    This specific implementation of the fixture provides the</span>
<span class="sd">    :func:`update_url` and :func:`version_number` values that are used by the</span>
<span class="sd">    framework, and can serve as a &quot;base&quot; fixture for the overrides (see example</span>
<span class="sd">    below).</span>

<span class="sd">    Note: In the example below, the &quot;platform&quot; value may be either a single</span>
<span class="sd">    string, &#39;dhuez&#39;, or a list of strings, like [&#39;dhuez&#39;, &#39;i386&#39;]</span>

<span class="sd">    example:</span>
<span class="sd">    BATTERY_TEST_PATH = &quot;battery-test&quot;</span>
<span class="sd">    BATTERY_TEST_ARCHIVE = {</span>
<span class="sd">    &quot;syslib/tools/hal-battery-test/dhuez-release/battery-test&quot;:</span>
<span class="sd">    BATTERY_TEST_PATH}</span>

<span class="sd">    @pytest.fixture(scope=&quot;session&quot;)</span>
<span class="sd">    def sqatools_spec(sqatools_spec):</span>
<span class="sd">        sqatools_spec.update(</span>
<span class="sd">           sqatools_spec.update(</span>
<span class="sd">                {&quot;archive_files&quot;: BATTERY_TEST_ARCHIVE,</span>
<span class="sd">                &quot;platform&quot;: &quot;dhuez&quot;})</span>
<span class="sd">        return sqatools_spec</span>
<span class="sd">    :param update_url: Fixture that yields update url</span>
<span class="sd">    :param version_number: Fixture that yields firmware version</span>
<span class="sd">    :return sqatools_spec</span>
<span class="sd">    :rtype: :obj:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;build_url&#39;</span><span class="p">:</span> <span class="n">update_url</span><span class="p">,</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">version_number</span><span class="p">}</span></div>


<div class="viewcode-block" id="download_and_extract_archive"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.download_and_extract_archive">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">download_and_extract_archive</span><span class="p">(</span><span class="n">sqatools_spec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic fixture to download and extract files from an archive. Yields</span>
<span class="sd">    paths of the extracted files. Also see documentation for fixture</span>
<span class="sd">    :func:`sqatools_spec`. This fixture is useful for files that will not</span>
<span class="sd">    be copied to the device. For files that are expected to be copied to the</span>
<span class="sd">    device, use the :func:`download_extract_and_host_archive` fixture.</span>

<span class="sd">    :return: :obj:`list` that contains the local path for each file extracted</span>
<span class="sd">    from the archive file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="s1">&#39;archive_files&#39;</span> <span class="ow">in</span> <span class="n">sqatools_spec</span>
    <span class="n">DownloadManager</span><span class="o">.</span><span class="n">get_files_from_sqatools</span><span class="p">(</span><span class="o">**</span><span class="n">sqatools_spec</span><span class="p">)</span>
    <span class="c1"># Collect the stored location of each extracted file</span>
    <span class="n">archive_paths</span> <span class="o">=</span> <span class="n">sqatools_spec</span><span class="p">[</span><span class="s1">&#39;archive_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">archive_paths</span>
    <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">archive_path</span> <span class="ow">in</span> <span class="n">archive_paths</span><span class="p">]</span></div>


<div class="viewcode-block" id="download_extract_and_host_archive"><a class="viewcode-back" href="../../pytest_automation.html#pytest_automation.conftest.download_extract_and_host_archive">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">download_extract_and_host_archive</span><span class="p">(</span><span class="n">download_and_extract_archive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This fixture spins up a web server to host files extracted by the</span>
<span class="sd">    :func:`download_and_extract_archive` fixture and are in the current working</span>
<span class="sd">    directory. Files that have been downloaded to absolute locations will not</span>
<span class="sd">    be hosted nor returned by this fixture, although the download operation</span>
<span class="sd">    will still have occurred. If you need access to these files, you should</span>
<span class="sd">    use :func:`download_and_extract_archive`.</span>

<span class="sd">    :return: :obj:`dict` that contains each URL of the hosted files with the</span>
<span class="sd">    local path of the downloaded file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">archive_paths</span> <span class="o">=</span> <span class="n">download_and_extract_archive</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">WebServer</span><span class="p">(</span><span class="n">start_reactor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">9000</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
    <span class="c1"># We don&#39;t want to pass files that have absolute locations,</span>
    <span class="c1"># since they are not hosted by the local WebServer (we use the</span>
    <span class="c1"># current directory for the Web Server).</span>
    <span class="n">all_files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;http://</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">host</span><span class="p">(),</span> <span class="n">tool_path</span><span class="p">):</span> <span class="n">tool_path</span>
        <span class="k">for</span> <span class="n">tool_path</span> <span class="ow">in</span> <span class="n">archive_paths</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)}</span>
    <span class="k">yield</span> <span class="n">all_files</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>