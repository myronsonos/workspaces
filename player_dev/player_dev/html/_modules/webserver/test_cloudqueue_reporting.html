
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>webserver.test_cloudqueue_reporting &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for webserver.test_cloudqueue_reporting</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sonos.client.websockets.event</span> <span class="k">import</span> <span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">PlaybackState</span><span class="p">,</span> <span class="n">SessionErrorEvent</span><span class="p">,</span>\
    <span class="n">Success</span><span class="p">,</span> <span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">GroupStatus</span><span class="p">,</span> <span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">GroupInfoEvent</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="ne">TimeoutError</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.suite</span> <span class="k">import</span> <span class="n">WorkflowTestSuite</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">skip</span><span class="p">,</span> <span class="n">wait_until_true</span><span class="p">,</span> <span class="n">combinatorial</span>
<span class="kn">from</span> <span class="nn">webserver.base_muse_fixture</span> <span class="k">import</span> <span class="n">MuseClientFixtureMixin</span><span class="p">,</span> <span class="n">BaseMuseFixture</span>
<span class="kn">from</span> <span class="nn">webserver.helpers.muse_api_helpers</span> <span class="k">import</span> <span class="n">MuseSessionMixin</span>
<span class="kn">from</span> <span class="nn">webserver.helpers.cloud_queue_helpers</span> <span class="k">import</span> <span class="n">cq_helpers</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">ifilter</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">common.utils</span> <span class="k">import</span> <span class="n">is_locked_build</span>

<span class="n">muse_session_mixin_2</span> <span class="o">=</span> <span class="n">MuseSessionMixin</span><span class="p">()</span>
<span class="n">cq_helper</span> <span class="o">=</span> <span class="n">cq_helpers</span><span class="p">()</span>

<span class="c1"># Keys from playback reports</span>
<span class="n">DURATION_PLAYED</span> <span class="o">=</span> <span class="s1">&#39;durationPlayedMillis&#39;</span>
<span class="n">TIME_SINCE_PLAYBACK</span> <span class="o">=</span> <span class="s1">&#39;timeSincePlaybackMillis&#39;</span>
<span class="n">POSITION</span> <span class="o">=</span> <span class="s2">&quot;positionMillis&quot;</span>
<span class="n">POSITION_AT_SEGMENT_START</span> <span class="o">=</span> <span class="s2">&quot;positionMillisAtSegmentStart&quot;</span>


<div class="viewcode-block" id="bool_generator"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.bool_generator">[docs]</a><span class="k">def</span> <span class="nf">bool_generator</span><span class="p">():</span>
    <span class="k">for</span> <span class="nb">bool</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">yield</span> <span class="nb">bool</span></div>


<div class="viewcode-block" id="report_policy_generator"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.report_policy_generator">[docs]</a><span class="k">def</span> <span class="nf">report_policy_generator</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">,</span> <span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">policy</span></div>


<div class="viewcode-block" id="sendUpdateAfterMillis_value_generator"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.sendUpdateAfterMillis_value_generator">[docs]</a><span class="k">def</span> <span class="nf">sendUpdateAfterMillis_value_generator</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">value</span></div>


<div class="viewcode-block" id="timePlayed_mode_generator"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.timePlayed_mode_generator">[docs]</a><span class="k">def</span> <span class="nf">timePlayed_mode_generator</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">304</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">value</span></div>


<div class="viewcode-block" id="CloudQueueReportingImpl"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl">[docs]</a><span class="k">class</span> <span class="nc">CloudQueueReportingImpl</span><span class="p">(</span><span class="n">BaseMuseFixture</span><span class="p">):</span>
<div class="viewcode-block" id="CloudQueueReportingImpl.setUpFixture"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CloudQueueReportingImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="c1"># assign a port for the cq server that increments per test to avoid reports bleeding into other tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span> <span class="o">=</span> <span class="mi">3000</span>
        <span class="k">for</span> <span class="n">player</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">player</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()</span> <span class="ow">and</span> <span class="n">player</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetCrossfadeMode</span><span class="p">():</span>
                    <span class="n">player</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetCrossfadeMode</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_default_playback_id_verifier</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.tearDownFixture"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CloudQueueReportingImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.setUpTest"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CloudQueueReportingImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="c1"># Start CQ server and make a session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                             <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Subscribe to playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Get the current queueVersion from the server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.tearDownTest"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">host_port</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CloudQueueReportingImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.get_item_played_data"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.get_item_played_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_item_played_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filtered_logs</span><span class="p">):</span>
        <span class="n">playback_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_logs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Got no entries back from the wait_for_filtered_log function&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">filtered_logs</span><span class="p">:</span>
                <span class="n">playback_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">playback_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Should have at least one entry on track playback data&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">playback_data</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.get_item_played_data_for_track"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.get_item_played_data_for_track">[docs]</a>    <span class="k">def</span> <span class="nf">get_item_played_data_for_track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_id</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">queueVersion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">playback_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">muse_mixin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an itemPlayed report for a given track. Returns the first report</span>
<span class="sd">        found or stops the test if at least one report does not exist.</span>

<span class="sd">        :param int t_id: Track ID</span>
<span class="sd">        :param int timeout_seconds: Number of seconds to poll logs</span>
<span class="sd">        :param str type: Type of itemPlayed report to look for eg &quot;update&quot;, &quot;final&quot;, &quot;skip&quot;</span>

<span class="sd">        :return: :obj:`dict` repr of itemPlayed report</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">muse_mixin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">muse_mixin</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data</span><span class="p">(</span>
            <span class="n">muse_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                        <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">t_id</span><span class="p">)</span> <span class="ow">and</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">type</span> <span class="ow">and</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;queueVersion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">queueVersion</span> <span class="ow">and</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;durationPlayedMillis&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
                                                        <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">,</span>
                                                        <span class="n">playback_id</span><span class="o">=</span><span class="n">playback_id</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.verify_time_since_playback"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.verify_time_since_playback">[docs]</a>    <span class="k">def</span> <span class="nf">verify_time_since_playback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">item_data</span><span class="p">[</span><span class="n">field2</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item_data</span><span class="p">[</span><span class="n">field1</span><span class="p">])</span> <span class="ow">and</span> \
               <span class="nb">int</span><span class="p">(</span><span class="n">item_data</span><span class="p">[</span><span class="n">field1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">item_data</span><span class="p">[</span><span class="n">field2</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">delta</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.verify_itemPlayed_duration_relationship"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.verify_itemPlayed_duration_relationship">[docs]</a>    <span class="k">def</span> <span class="nf">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_played</span><span class="p">,</span> <span class="n">ms_delta</span><span class="p">,</span> <span class="n">field1</span><span class="p">,</span> <span class="n">field2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that field1 and field2 in an</span>
<span class="sd">        itemPlayedData report is within expected margins:</span>
<span class="sd">            (field2 &lt;= field1,</span>
<span class="sd">             field1 - field2 &lt; ms_delta)</span>

<span class="sd">        :param dict item_played: Item played report</span>
<span class="sd">        :param ms_delta: Acceptable delta in milliseconds</span>
<span class="sd">        :param str field1: Name of the first itemPlayed object attribute</span>
<span class="sd">        :param str field2: Name of the second itemPlayed object attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Adding this due to SWPBL-59401, which was causing failures in automation</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">field1</span> <span class="o">==</span> <span class="n">POSITION</span> <span class="ow">and</span> <span class="n">field1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item_played</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">field2</span> <span class="o">==</span> <span class="n">POSITION</span> <span class="ow">and</span> <span class="n">field2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item_played</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;positionMillis is missing from the /timePlayed report, &quot;</span>
                      <span class="s2">&quot;probable due to SWPBL-59401&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Verify time since playback and duration played within delta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_time_since_playback</span><span class="p">(</span><span class="n">item_data</span><span class="o">=</span><span class="n">item_played</span><span class="p">,</span>
                                                                      <span class="n">delta</span><span class="o">=</span><span class="n">ms_delta</span><span class="p">,</span>
                                                                      <span class="n">field1</span><span class="o">=</span><span class="n">field1</span><span class="p">,</span>
                                                                      <span class="n">field2</span><span class="o">=</span><span class="n">field2</span><span class="p">),</span>
                                      <span class="s2">&quot;player reported </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2"> and </span><span class="si">{2}</span><span class="s2">: </span><span class="si">{3}</span><span class="s2">, &quot;</span>
                                      <span class="s2">&quot;expected </span><span class="si">{2}</span><span class="s2">: </span><span class="si">{3}</span><span class="s2"> &lt;= </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2"> and (</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2"> - </span><span class="si">{2}</span><span class="s2">: </span><span class="si">{3}</span><span class="s2">) &lt;= delta </span><span class="si">{4}</span><span class="s2">&quot;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field1</span><span class="p">,</span>
                                              <span class="n">item_played</span><span class="p">[</span><span class="n">field1</span><span class="p">],</span>
                                              <span class="n">field2</span><span class="p">,</span>
                                              <span class="n">item_played</span><span class="p">[</span><span class="n">field2</span><span class="p">],</span>
                                              <span class="n">ms_delta</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.verify_itemPlayed_duration"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.verify_itemPlayed_duration">[docs]</a>    <span class="k">def</span> <span class="nf">verify_itemPlayed_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_played</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">ms_expected_value</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the desired field duration value in a itemPlayedData report matches</span>
<span class="sd">        an expected duration within acceptable margins (delta)</span>

<span class="sd">        :param dict item_played: Item played report</span>
<span class="sd">        :param str field: The desired itemPlayed attribute to verify</span>
<span class="sd">        :param ms_expected_value: Expected field value in milliseconds</span>
<span class="sd">        :param ms_delta: Acceptable delta in milliseconds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Adding this due to SWPBL-59401, which was causing failures in automation</span>
        <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="n">POSITION</span> <span class="ow">and</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item_played</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;positionMillis is missing from the /timePlayed report, &quot;</span>
                      <span class="s2">&quot;probable due to SWPBL-59401&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># verify duration played is accurate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="n">field</span><span class="p">]),</span>
                                             <span class="n">ms_expected_value</span><span class="p">,</span>
                                             <span class="s2">&quot;expected </span><span class="si">{1}</span><span class="s2">: </span><span class="si">{0}</span><span class="s2"> seconds for in track </span><span class="si">{2}</span><span class="s2">, actual </span><span class="si">{1}</span><span class="s2">: </span><span class="si">{3}</span><span class="s2">&quot;</span>
                                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms_expected_value</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">,</span>
                                                     <span class="n">field</span><span class="p">,</span>
                                                     <span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                                                     <span class="n">item_played</span><span class="p">[</span><span class="n">field</span><span class="p">]),</span>
                                             <span class="n">delta</span><span class="o">=</span><span class="n">ms_delta</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_duration_played"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_duration_played">[docs]</a>    <span class="k">def</span> <span class="nf">test_duration_played</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test verifies accurate time reported for regular uninterrrupted playback of 3 short tracks in the queue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_playback_policy</span><span class="p">({</span><span class="s2">&quot;pauseAtEndOfQueue&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;sendPlaybackActions&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                                            <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
                                        <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">30000</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                                            <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
                                        <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">30000</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>
        <span class="n">last_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                          <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="c1"># SWPBL-66771</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotInOrFailCase</span><span class="p">(</span><span class="s2">&quot;actions&quot;</span><span class="p">,</span> <span class="n">last_report</span><span class="p">,</span>
                                   <span class="s2">&quot;actions.pause item should not be in the itemPlayed report&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">last_report</span><span class="p">,</span>
                                        <span class="n">DURATION_PLAYED</span><span class="p">,</span>
                                        <span class="mi">30000</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_time_since_playback"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_time_since_playback">[docs]</a>    <span class="k">def</span> <span class="nf">test_time_since_playback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test to verify SWPBL-47192. Instead of just playing through a queue this test starts</span>
<span class="sd">        playback on the second track and allows the second two tracks to play through.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_paused</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                                                         <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                                                         <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
                                                     <span class="mi">100000</span><span class="p">,</span> <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_time_since_playback_large_sync_error"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_time_since_playback_large_sync_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_time_since_playback_large_sync_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that in the event of a large sync error, the durationPlayed is</span>
<span class="sd">        reported as greater than 0 but less than the timeSinceMillis. This is</span>
<span class="sd">        to cover a regression reported in SWPBL-53634.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># (/7/6/16) Moving away from using the slowStream option on the mock CQ server,</span>
        <span class="c1"># its not just reliable enough currently.</span>
        <span class="c1"># Restart cq server with slowStream option to induce LSE</span>
        <span class="c1"># self.cleanup_cq()</span>
        <span class="c1"># self.setup_cq(slowStream=True)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">has_testpoint_support</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;Cannot run testpoint tests against builds without testpoint support&#39;</span><span class="p">)</span>

        <span class="c1"># Delete tracks one and two (default 3 tracks, 0-indexed),</span>
        <span class="c1"># to only play track 0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Get the new queueVersion</span>
        <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">newQV</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">:</span>
            <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>

        <span class="c1"># Load CQ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Play two tracks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Use the testpoint to triggr a LSE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">testpoint_trigger_lse</span><span class="p">()</span>

        <span class="c1"># Wait until playback of all tracks finishes</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_paused</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Skip this test is the LSE endpoint failed to generate a LSE in chsnk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyFalseOrSkip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_chsnk_stats</span><span class="p">()[</span><span class="s2">&quot;LSE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;chsnk LSE value should be greater then 0&quot;</span><span class="p">)</span>

        <span class="c1"># Get the timePlayed report for track 0</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="n">newQV</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="c1"># Verify duration played greater than 0 and &lt; time since playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterOrFailCase</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> in &quot;</span>
            <span class="s2">&quot; report after LSE greater than zero?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DURATION_PLAYED</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyLessEqualOrFailCase</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span>
            <span class="n">item_played</span><span class="p">[</span><span class="n">TIME_SINCE_PLAYBACK</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> in report following LSE less &quot;</span>
            <span class="s2">&quot;than </span><span class="si">{}</span><span class="s2">?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_inprogress_timePlayed_reports_after_seek"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_inprogress_timePlayed_reports_after_seek">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">report_policy_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_inprogress_timePlayed_reports_after_seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covers SWPBL-63537, SWPBL-66770</span>
<span class="sd">        Verifies that the amount a track is played is not discard if the user seeks and</span>
<span class="sd">        is used to send the &quot;update&quot; /timePlayed report in a prompt manner</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Restart the mock CQ server to use longer length tracks</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="mi">15000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">,</span>
                                      <span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/normal_length&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="n">policy</span><span class="p">:</span> <span class="n">delay</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="n">policy</span><span class="p">],</span>
                               <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">delay</span><span class="p">))</span>
        <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:23&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1"># We clear the log here since in the case of using only &quot;periodicIntervalMillis&quot;,</span>
        <span class="c1"># one extra /update report will be sent after 1 second of playback since the default value</span>
        <span class="c1"># of &quot;sendUpdateAfterMillis&quot; is 1000ms in this case.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">40000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:42&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Verify the in-progress timePlayed event data</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="n">newQV</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="c1"># We make no promises when the in-progress timePlayed report will be sent,</span>
        <span class="c1"># only that it should be reasonably close when what &quot;sendUpdateAfterMillis&quot; is set to.</span>
        <span class="c1"># Therefore, these tests will verify that we see the report anytime within the next 2</span>
        <span class="c1"># TPM polling intervals(every 5 seconds).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrStop</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;durationPlayedMillis&quot;</span><span class="p">],</span> <span class="n">delay</span><span class="o">+</span><span class="mi">5000</span><span class="p">,</span>
                                     <span class="n">delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
                                     <span class="n">message</span><span class="o">=</span><span class="s2">&quot;update-type /timePlayed report should have been sent promptly&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_scrub_forwards"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_scrub_forwards">[docs]</a>    <span class="k">def</span> <span class="nf">test_scrub_forwards</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that scrubbing forwards within a track will result in an accurate duration</span>
<span class="sd">        and time since playback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">25000</span><span class="p">)</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="mi">600000</span><span class="p">,</span>
                                                     <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_scrub_backwards"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_scrub_backwards">[docs]</a>    <span class="k">def</span> <span class="nf">test_scrub_backwards</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that scrubbing backwards within a track will result in an accurate duration</span>
<span class="sd">        and time since playback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">19000</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># wait for 6 seconds of audio to play, scrub back to 0:00:15, and let the track play out</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:25&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">item_id</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span>
                                                     <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">21000</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_report_on_delegation"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_report_on_delegation">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_on_delegation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify timePlayed reports are handled correctly on delegation.</span>

<span class="sd">        Scenario:</span>
<span class="sd">        # Playing track 1 on ZP A for CQ A</span>
<span class="sd">        # Playing track 1 on ZP B for CQ B</span>
<span class="sd">        # Group players</span>
<span class="sd">        # Delegate from ZP A to ZP B</span>

<span class="sd">        Verify a timePlayed report is generated for track 1 using ZP A&#39;s groupId</span>
<span class="sd">        (the player that started playback).</span>

<span class="sd">        Verify a timePlayed report is generated for track 1 using ZP B&#39;s groupId.</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get another device</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="o">.</span><span class="n">generate_testbed_playback_devices</span><span class="p">()</span> <span class="k">if</span> <span class="n">zp</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrSkipCase</span><span class="p">(</span><span class="n">zps</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Test requires an additional device for grouping operations!&quot;</span><span class="p">)</span>
        <span class="n">zp_2</span> <span class="o">=</span> <span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mute_zp</span><span class="p">(</span><span class="n">zp_2</span><span class="p">)</span>

        <span class="c1"># Start another CQ server</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">muse_session_mixin_2</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="mi">3100</span><span class="p">,</span>
                                                          <span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                          <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

            <span class="n">muse_session_mixin_2</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="s2">&quot;api&quot;</span><span class="p">)</span>

            <span class="c1"># Make a muse connection to second player</span>
            <span class="n">muse_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="n">zp_2</span><span class="p">)</span>
            <span class="n">gid_2</span> <span class="o">=</span> <span class="n">zp_2</span><span class="o">.</span><span class="n">GroupManagement</span><span class="o">.</span><span class="n">get_local_group_uuid</span><span class="p">()</span>
            <span class="n">muse_2</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">gid_2</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="n">zp_2</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
            <span class="n">muse_session_mixin_2</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span>
                <span class="n">muse_2</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="n">gid_2</span><span class="p">,</span>
                <span class="n">hhid</span><span class="o">=</span><span class="n">zp_2</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1"># Start playing CQ on ZP 1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                       <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                       <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                       <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                                       <span class="n">position_millis</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                                       <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Start playing CQ on ZP 2</span>
            <span class="n">muse_2</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="n">muse_2</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                    <span class="n">hhid</span><span class="o">=</span><span class="n">zp_2</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                    <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin_2</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                    <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                                    <span class="n">position_millis</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                                    <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">muse_2</span><span class="p">,</span>
                <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Wait for 15 seconds</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:20&quot;</span><span class="p">,</span>
                            <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp_2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:20&quot;</span><span class="p">,</span>
                            <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

            <span class="c1"># Join ZP 2 to other ZP&#39;s group</span>
            <span class="n">zp_2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
            <span class="n">qv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
            <span class="n">qv_2</span> <span class="o">=</span> <span class="n">muse_session_mixin_2</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
            <span class="n">group_gid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gid</span>
            <span class="c1"># # Have group coordinator leave group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                              <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">MOVED</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_stopped</span><span class="p">(),</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Timed out waiting for ZP to enter stop state after continuing playback &quot;</span>
                          <span class="s2">&quot;from delegation.&quot;</span><span class="p">)</span>

            <span class="c1"># Verify track played duration for both groups</span>
            <span class="n">item_played_zp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                                  <span class="n">queueVersion</span><span class="o">=</span><span class="n">qv</span><span class="p">,</span>
                                                                  <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                                                  <span class="n">playback_id</span><span class="o">=</span><span class="n">group_gid</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played_zp1</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span>
                                                         <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played_zp1</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>

            <span class="n">item_played_zp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                                  <span class="n">queueVersion</span><span class="o">=</span><span class="n">qv_2</span><span class="p">,</span>
                                                                  <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                                                  <span class="n">playback_id</span><span class="o">=</span><span class="n">gid_2</span><span class="p">,</span>
                                                                  <span class="n">muse_mixin</span><span class="o">=</span><span class="n">muse_session_mixin_2</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played_zp2</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span>
                                                         <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played_zp2</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">muse_session_mixin_2</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_session_leave"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_session_leave">[docs]</a>    <span class="k">def</span> <span class="nf">test_session_leave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that leaving the active playback session will still send timePlayed reports with</span>
<span class="sd">        accurate duration and time since played.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">leave_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_stopped</span><span class="p">(),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># get the time played report for the track</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="mi">600000</span><span class="p">,</span>
                                                     <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_change_avtransport_from_cloudqueue"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_change_avtransport_from_cloudqueue">[docs]</a>    <span class="k">def</span> <span class="nf">test_change_avtransport_from_cloudqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that evicting the active playback session by changing AVTransport will still send</span>
<span class="sd">        timePlayed reports with accurate duration and time since played.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetAVTransportURI_and_wait</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="mi">600000</span><span class="p">,</span>
                                                     <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_session_evict_by_second_muse_client"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_session_evict_by_second_muse_client">[docs]</a>    <span class="k">def</span> <span class="nf">test_session_evict_by_second_muse_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that evicting the active playback session with a second Muse client will still send</span>
<span class="sd">        timePlayed reports with accurate duration and time since playback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">second_muse_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># getPositionInfo 0:00:05</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">second_muse_client</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                          <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                          <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                          <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                          <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span><span class="p">))</span>

        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="mi">600000</span><span class="p">,</span>
                                                     <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_skip_forward_in_the_queue"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_skip_forward_in_the_queue">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_forward_in_the_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify player sends timePlayed reports when skipping through tracks with enough playback time to</span>
<span class="sd">        be reported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># Get the new queueVersion</span>
        <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">newQV</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">:</span> <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="c1"># Verify that the desired track has started playback then</span>
            <span class="c1"># wait for 2 seconds of playback then skip</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s1">&#39;0:00:02&#39;</span><span class="p">,</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                              <span class="n">queueVersion</span><span class="o">=</span><span class="n">newQV</span><span class="p">,</span>
                                                              <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span>
                                            <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>

        <span class="c1"># Checks for SWPBL-54933</span>
        <span class="c1"># Get all the final /timePlayed reports again and verifies that the order they were sent</span>
        <span class="c1"># is sequential</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                   <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;queueVersion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">newQV</span><span class="p">),</span>
                                                                   <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                                                   <span class="n">expected</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">logs</span><span class="p">[</span><span class="n">z</span><span class="p">][</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;/timePlayed id should be in sequential order&quot;</span><span class="p">)</span>
        <span class="c1"># Skip this verification until SWPBL-61236 is fixed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span>
                                   <span class="s2">&quot;Should have 4 /timePlayed reports&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_skip_backward_in_the_queue"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_skip_backward_in_the_queue">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_backward_in_the_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify player sends timePlayed reports when skipping backwards through tracks with enough playback time to</span>
<span class="sd">        be reported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Get the new queueVersion</span>
        <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">newQV</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">:</span> <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;4&quot;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Verify that the desired track has started playback then</span>
            <span class="c1"># wait for 2 seconds of playback then skip</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s1">&#39;0:00:02&#39;</span><span class="p">,</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_previous</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                              <span class="n">queueVersion</span><span class="o">=</span><span class="n">newQV</span><span class="p">,</span>
                                                              <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span>
                                            <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>

        <span class="c1"># Checks for SWPBL-54933</span>
        <span class="c1"># Get all the final /timePlayed reports again and verifies that the order they were sent</span>
        <span class="c1"># is sequential</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                     <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                   <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span> <span class="ow">and</span>
                                                                   <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;queueVersion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">newQV</span><span class="p">),</span>
                                                     <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                                     <span class="n">expected</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="n">z</span><span class="p">),</span> <span class="n">logs</span><span class="p">[</span><span class="n">z</span><span class="p">][</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;/timePlayed id should be in reverse sequential order&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_pause_at_end_report_submit"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_pause_at_end_report_submit">[docs]</a>    <span class="nd">@skip</span><span class="p">(</span><span class="s1">&#39;Currently unused but potentially useful for SWPBL-58002&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_pause_at_end_report_submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify player reports timePlayed data after hitting pause at end with normal playback</span>
<span class="sd">        and then generates another report after scrubbing backwards in the last track and</span>
<span class="sd">        letting it play out to the end again</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_playback_policy</span><span class="p">({</span><span class="s2">&quot;pauseAtEndOfQueue&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;sendPlaybackActions&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_paused</span><span class="p">(),</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>

        <span class="n">first_play</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                         <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                         <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="c1"># SWPBL-66771</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="s2">&quot;pause&quot;</span><span class="p">,</span> <span class="n">first_play</span><span class="p">[</span><span class="s2">&quot;actions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                <span class="s2">&quot;actions.pause item should be in the itemPlayed report&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">first_play</span><span class="p">[</span><span class="s2">&quot;actions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;pause&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;positionMillis&quot;</span><span class="p">],</span>
                                         <span class="mi">30000</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                                         <span class="n">message</span><span class="o">=</span><span class="s2">&quot;positionMillis of the pause action should be accurate&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="s2">&quot;api&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_paused</span><span class="p">(),</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">second_play</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="c1"># SWPBL-66771</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="s2">&quot;pause&quot;</span><span class="p">,</span> <span class="n">second_play</span><span class="p">[</span><span class="s2">&quot;actions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                <span class="s2">&quot;actions.pause item should be in the itemPlayed report&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">second_play</span><span class="p">[</span><span class="s2">&quot;actions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;pause&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;positionMillis&quot;</span><span class="p">],</span>
                                         <span class="mi">30000</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                                         <span class="n">message</span><span class="o">=</span><span class="s2">&quot;positionMillis of the pause action should be accurate&quot;</span><span class="p">)</span>

        <span class="c1"># player should have sent two timePlayed reports that do not match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">first_play</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">]</span> <span class="o">!=</span> <span class="n">second_play</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span>
            <span class="s2">&quot;Track played once for </span><span class="si">{}</span><span class="s2"> seconds and a second time for </span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">first_play</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span> <span class="n">second_play</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">]))</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_skip_to_item_within_track"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_skip_to_item_within_track">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_to_item_within_track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for SWPBL-51750, This test verifies a correct cumulative time played report is sent</span>
<span class="sd">        when skipToItem is sent for a position within the current track.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">queue_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
                               <span class="n">position_millis</span><span class="o">=</span><span class="mi">25000</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                                            <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
                                        <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_play_skip_forward_stress_then_pause"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_play_skip_forward_stress_then_pause">[docs]</a>    <span class="k">def</span> <span class="nf">test_play_skip_forward_stress_then_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for SWPBL-51313 and SWPBL-52078.</span>
<span class="sd">        Verifies player sends accurate playback reports after skip stress then pause.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Get the new queueVersion</span>
        <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">newQV</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">:</span> <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s1">&#39;RelTime&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:10&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Rapid skip through tracks for stress. TrackPlayRecorder can hold 8 pending</span>
        <span class="c1"># playback reports. Skip 7 times to make sure we don&#39;t miss the report of interest.</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">)</span>

        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="n">newQV</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="mi">600000</span><span class="p">,</span>
                                                     <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>

        <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                   <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;queueVersion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">newQV</span><span class="p">),</span>
                                                                   <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                                                   <span class="n">expected</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="c1"># Skip this verification until SWPBL-61236 is fixed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span>
                                   <span class="s2">&quot;Should have 7 /timePlayed reports&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_report_paused_track_on_skip"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_report_paused_track_on_skip">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_paused_track_on_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the player promptly reports timePlayed data on a paused track after skip.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                                            <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
                                        <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_timeSincePlaybackMillis_on_cancelled_nonstarted_tracks"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_timeSincePlaybackMillis_on_cancelled_nonstarted_tracks">[docs]</a>    <span class="k">def</span> <span class="nf">test_timeSincePlaybackMillis_on_cancelled_nonstarted_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Covers SWPBL-54110</span>
<span class="sd">        Tracks that no longer exist on the server should report a timeSincePlaybackMillis value of 0.</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">)</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                  <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span><span class="p">,</span>
                                                                  <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="s2">&quot;Expect the player to report all 7 skips&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">m_id</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="n">timeSincePlaybackMillis</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">TIME_SINCE_PLAYBACK</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeSincePlaybackMillis</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> for track </span><span class="si">{}</span><span class="s2"> should be 0, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">m_id</span><span class="p">,</span> <span class="n">timeSincePlaybackMillis</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_player_inhibits_zero_length_time_played_reports_to_v1_servers"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_player_inhibits_zero_length_time_played_reports_to_v1_servers">[docs]</a>    <span class="k">def</span> <span class="nf">test_player_inhibits_zero_length_time_played_reports_to_v1_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Tests that timePlayed reports of zero seconds are not sent to v1.0 cloud queue servers.</span>
<span class="sd">        The production Google servers (the only v1.0 partner) returns a 500 if the time is zero.</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

        <span class="n">v1_queue_base_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/musicqueue/v</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="n">v1_queue_base_url</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">)</span>

        <span class="n">timePlayed_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
            <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">timePlayed_log</span><span class="p">),</span>
            <span class="s2">&quot;Expect the player not to report any skips&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_player_still_reports_after_repeated_skipBacks_on_first_track"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_player_still_reports_after_repeated_skipBacks_on_first_track">[docs]</a>    <span class="k">def</span> <span class="nf">test_player_still_reports_after_repeated_skipBacks_on_first_track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Covers SWPBL-55459</span>
<span class="sd">        Player should reliably send /timePlayed report even if a track is interrupted before it can start playing</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s1">&#39;RelTime&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:02&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s1">&#39;RelTime&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:02&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                                    <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_previous</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                           <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                           <span class="n">position_millis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;api&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
          <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="mi">600000</span><span class="p">,</span>
                                                     <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">30000</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_player_still_reports_after_repeated_skips_then_pause_play"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_player_still_reports_after_repeated_skips_then_pause_play">[docs]</a>    <span class="k">def</span> <span class="nf">test_player_still_reports_after_repeated_skips_then_pause_play</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Covers SWPBL-55962</span>
<span class="sd">        An assertion was causing the report to be not sent when these steps occurred.</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">,</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="mi">600000</span><span class="p">,</span>
                                                     <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">30000</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_skipToItem_after_playing_track_without_positionMillis"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_skipToItem_after_playing_track_without_positionMillis">[docs]</a>    <span class="k">def</span> <span class="nf">test_skipToItem_after_playing_track_without_positionMillis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        There is some concern whether a skipToItem without providing positionMillis</span>
<span class="sd">        would cause some kind of issue with reporting the first track.</span>
<span class="sd">        This test verifies that both tracks are reported.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">)</span>

        <span class="c1"># Verify that both tracks reported</span>
        <span class="n">item0_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                           <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                           <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item0_played</span><span class="p">,</span> <span class="mi">600000</span><span class="p">,</span>
                                                     <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item0_played</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
        <span class="n">item1_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                           <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                           <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item1_played</span><span class="p">,</span> <span class="mi">600000</span><span class="p">,</span>
                                                     <span class="n">TIME_SINCE_PLAYBACK</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item1_played</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_md_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span> <span class="k">if</span> <span class="nb">bool</span> <span class="k">else</span> <span class="kc">None</span>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_positionMillis_accuracy"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_positionMillis_accuracy">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">bool_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_positionMillis_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covers SWPBL-58048</span>
<span class="sd">        Verifies that the in-progress timePlayed report comes out within a reasonable amount of time</span>
<span class="sd">        and that the &quot;positionMillis&quot; and &quot;positionMillisAtSegmentStart&quot; fields are accurate.</span>
<span class="sd">        :param bool:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Restart the mock CQ server to use longer length tracks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">,</span>
                                      <span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/normal_length&quot;</span><span class="p">)</span>
        <span class="c1"># Set the reports policy and verify that its correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;sendUpdateAfterMillis should be 5000&quot;</span><span class="p">)</span>
        <span class="c1"># Get the new queueVersion</span>
        <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">newQV</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">:</span> <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_md_generator</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
                                   <span class="n">queue_version</span><span class="o">=</span><span class="n">newQV</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Verify the in-progress timePlayed event data</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                           <span class="n">queueVersion</span><span class="o">=</span><span class="n">newQV</span><span class="p">,</span>
                                                           <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="c1"># We make no promises when the in-progress timePlayed report will be sent,</span>
        <span class="c1"># only that it should be reasonably close when what &quot;sendUpdateAfterMillis&quot; is set to.</span>
        <span class="c1"># Therefore, these tests will verify that we see the report anytime within the next 2</span>
        <span class="c1"># TPM polling intervals(every 5 seconds).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">POSITION</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">item_played</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span>
                                                     <span class="n">POSITION</span><span class="p">,</span> <span class="n">POSITION_AT_SEGMENT_START</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_positionMillisAtSegmentStart_accuracy"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_positionMillisAtSegmentStart_accuracy">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">bool_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_positionMillisAtSegmentStart_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covers SWPBL-58048</span>
<span class="sd">        Verifies that the in-progress timePlayed report has accurate &quot;positionMillisAtSegmentStart&quot;</span>
<span class="sd">        values if you load at a custom position_millis and that the final report is accurate if</span>
<span class="sd">        the client pauses in the middle of the track</span>
<span class="sd">        :param bool:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the reports policy and verify that its correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;sendUpdateAfterMillis should be 5000&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_md_generator</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                                   <span class="n">queue_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>

        <span class="c1"># We make no promises when the in-progress timePlayed report will be sent,</span>
        <span class="c1"># only that it should be reasonably close when what &quot;sendUpdateAfterMillis&quot; is set to.</span>
        <span class="c1"># Therefore, these tests will verify that we see the report anytime within the next 2</span>
        <span class="c1"># TPM polling intervals(every 5 seconds).</span>
        <span class="n">item_played_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                                 <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                                 <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">curPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">position_millis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="c1"># Verify the in-progress timePlayed event data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played_update</span><span class="p">,</span>
                                                     <span class="n">item_played_update</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span>
                                                     <span class="n">POSITION</span><span class="p">,</span> <span class="n">POSITION_AT_SEGMENT_START</span><span class="p">)</span>
        <span class="c1"># Verify the final timePlayed event data</span>
        <span class="n">item_played_final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                                <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played_final</span><span class="p">,</span> <span class="n">POSITION_AT_SEGMENT_START</span><span class="p">,</span>
                                        <span class="n">curPos</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played_final</span><span class="p">,</span>
                                                     <span class="n">item_played_final</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span>
                                                     <span class="n">POSITION</span><span class="p">,</span> <span class="n">POSITION_AT_SEGMENT_START</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_change_sendUpdateAfterMillis_has_effect"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_change_sendUpdateAfterMillis_has_effect">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">bool_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_change_sendUpdateAfterMillis_has_effect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covers SWPBL-58048</span>
<span class="sd">        Verifies that the &quot;sendUpdateAfterMillis&quot; server policy does change the report time of</span>
<span class="sd">        the in-progress timePlayed report and that no more then one in-progress report is sent per</span>
<span class="sd">        track</span>
<span class="sd">        :param bool:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interval1</span> <span class="o">=</span> <span class="mi">5000</span>
        <span class="n">interval2</span> <span class="o">=</span> <span class="n">interval1</span> <span class="o">+</span> <span class="mi">10000</span>
        <span class="n">interval3</span> <span class="o">=</span> <span class="n">interval2</span> <span class="o">+</span> <span class="mi">20000</span>
        <span class="c1"># Restart the mock CQ server to use longer length tracks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">,</span>
                                      <span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/normal_length&quot;</span><span class="p">)</span>
        <span class="c1"># Get the new queueVersion</span>
        <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">newQV</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">:</span> <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="c1"># Set the reports policy and verify that its correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">:</span> <span class="n">interval1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="n">interval1</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;sendUpdateAfterMillis should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interval1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_md_generator</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
                                   <span class="n">queue_version</span><span class="o">=</span><span class="n">newQV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Verify the in-progress timePlayed event data for track 0</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="n">newQV</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">POSITION</span><span class="p">,</span> <span class="n">interval1</span> <span class="o">+</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">item_played</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span>
                                                     <span class="n">POSITION</span><span class="p">,</span> <span class="n">POSITION_AT_SEGMENT_START</span><span class="p">)</span>

        <span class="c1"># Skip to the next track and change the &quot;sendUpdateAfterMillis&quot; value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">:</span> <span class="n">interval2</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="n">interval2</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;sendUpdateAfterMillis should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interval2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="s2">&quot;api&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/context&#39;</span><span class="p">,</span>
                                                                <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                               <span class="s2">&quot;Player should have made a /context fetch&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:15&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Verify the in-progress timePlayed event data for track 1</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="n">newQV</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">POSITION</span><span class="p">,</span> <span class="n">interval2</span> <span class="o">+</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">item_played</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span>
                                                     <span class="n">POSITION</span><span class="p">,</span> <span class="n">POSITION_AT_SEGMENT_START</span><span class="p">)</span>

        <span class="c1"># Change &quot;sendUpdateAfterMillis&quot; again to be greater then the current report threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">:</span> <span class="n">interval3</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="n">interval3</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;sendUpdateAfterMillis should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interval3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="s2">&quot;api&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/context&#39;</span><span class="p">,</span>
                                                                <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                               <span class="s2">&quot;Player should have made a /context fetch&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="s2">&quot;api&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:35&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Verify that we do not get another in-progress timePlayed report</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;update&quot;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;queueVersion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">newQV</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;durationPlayedMillis&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
                                                                <span class="n">timeout</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
                                                                <span class="n">expected</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                   <span class="s2">&quot;Should have not received another in-progress timePlayed report&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_delete_sendUpdateAfterMillis_from_server"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_delete_sendUpdateAfterMillis_from_server">[docs]</a>    <span class="k">def</span> <span class="nf">test_delete_sendUpdateAfterMillis_from_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covers SWPBL-58048</span>
<span class="sd">        Verifies that if the removes the &quot;sendUpdateAfterMillis&quot; policy, no more in-progress timePlayed</span>
<span class="sd">        reports will be sent</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Restart the mock CQ server to use longer length tracks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">,</span>
                                      <span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/normal_length&quot;</span><span class="p">)</span>
        <span class="c1"># Set the reports policy and verify that its correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;sendUpdateAfterMillis should be 5000&quot;</span><span class="p">)</span>
        <span class="c1"># Get the new queueVersion</span>
        <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">newQV</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">:</span> <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Verify the in-progress timePlayed event data</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                           <span class="n">queueVersion</span><span class="o">=</span><span class="n">newQV</span><span class="p">,</span>
                                                           <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="c1"># We make no promises when the in-progress timePlayed report will be sent,</span>
        <span class="c1"># only that it should be reasonably close when what &quot;sendUpdateAfterMillis&quot; is set to.</span>
        <span class="c1"># Therefore, these tests will verify that we see the report anytime within the next 2</span>
        <span class="c1"># TPM polling intervals(every 5 seconds).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">POSITION</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">item_played</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span>
                                                     <span class="n">POSITION</span><span class="p">,</span> <span class="n">POSITION_AT_SEGMENT_START</span><span class="p">)</span>

        <span class="c1"># Skip to the next track and remove the &quot;sendUpdateAfterMillis&quot; policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_reports_policy</span><span class="p">(</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyDictEqualOrFailCase</span><span class="p">({},</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">(),</span>
                               <span class="s2">&quot;Server reports policy should be empty&quot;</span><span class="p">)</span>

        <span class="c1"># Reload the CQ for the new context changes to take effect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                               <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Verify that we do not get another in-progress timePlayed report</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;update&quot;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;queueVersion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">newQV</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;durationPlayedMillis&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
                                                                <span class="n">timeout</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
                                                                <span class="n">expected</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                   <span class="s2">&quot;Should have not received another in-progress timePlayed report&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_inprogress_timePlayed_does_not_report"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_inprogress_timePlayed_does_not_report">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">bool_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_inprogress_timePlayed_does_not_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covers SWPBL-58048</span>
<span class="sd">        Verifies that the in-progress timePlayed report does not report if the playback time has</span>
<span class="sd">        not crossed the &quot;sendUpdateAfterMillis&quot; threshold</span>
<span class="sd">        :param bool:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="c1"># Restart the mock CQ server to use longer length tracks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">,</span>
                                      <span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/normal_length&quot;</span><span class="p">)</span>
        <span class="c1"># Set the reports policy and verify that its correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">:</span> <span class="n">interval</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;sendUpdateAfterMillis should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interval</span><span class="p">))</span>
        <span class="c1"># Get the new queueVersion</span>
        <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">newQV</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">:</span> <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_md_generator</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
                                   <span class="n">queue_version</span><span class="o">=</span><span class="n">newQV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:09&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="c1"># Verify that we do not get an in-progress timePlayed report</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;update&quot;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;queueVersion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">newQV</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;durationPlayedMillis&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
                                                                <span class="n">timeout</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
                                                                <span class="n">expected</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                   <span class="s2">&quot;Should have not received another in-progress timePlayed report&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_skipToItem_while_playing_reporting_stress_test"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_skipToItem_while_playing_reporting_stress_test">[docs]</a>    <span class="k">def</span> <span class="nf">test_skipToItem_while_playing_reporting_stress_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-54933</span>
<span class="sd">        Verifies that the player can still send out /timePlayed reports while it is being hammered</span>
<span class="sd">        by skipToItem commands to the same track.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">md0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">md1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="n">md0</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                   <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="n">md1</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;durationPlayedMillis&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">15000</span><span class="p">),</span>
                                                                <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                                                <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                   <span class="s2">&quot;Should have a final /timePlayed report for track 0&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_skipToItem_with_no_positionMillis_before_skipToItem_with_positionMillis"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_skipToItem_with_no_positionMillis_before_skipToItem_with_positionMillis">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">bool_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_skipToItem_with_no_positionMillis_before_skipToItem_with_positionMillis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-61780</span>
<span class="sd">        Verifies that the player will continue to send out /timePlayed reports after SCA-style</span>
<span class="sd">        skipToItem commands (no positionMillis, same itemId as current track).</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_md_generator</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_md_generator</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">position_millis</span><span class="o">=</span><span class="mi">27000</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_md_generator</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span>

        <span class="c1"># SWPBL-62534</span>
        <span class="c1"># Add additional verification for &#39;positionMillisAtSegmentStart&#39; == 0</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                     <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                   <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;positionMillisAtSegmentStart&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
                                                                   <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                                   <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span> <span class="ow">and</span>
                                                                   <span class="mi">4000</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;durationPlayedMillis&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6000</span><span class="p">),</span>
                                                     <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span>
                                   <span class="s2">&quot;Player should have sent a final /timePlayed report for track 0&quot;</span><span class="p">)</span>
        <span class="c1"># SWPBL-62534</span>
        <span class="c1"># Add additional verification for &#39;positionMillisAtSegmentStart&#39; == 27000</span>
        <span class="n">logs2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                      <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                    <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;positionMillisAtSegmentStart&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">27000</span> <span class="ow">and</span>
                                                                    <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span> <span class="ow">and</span>
                                                                    <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span> <span class="ow">and</span>
                                                                    <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;durationPlayedMillis&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">),</span>
                                                      <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs2</span><span class="p">),</span>
                                   <span class="s2">&quot;Player should have sent a final /timePlayed report for track 2&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_timePlayed_reports_using_latest_queueVersion"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_timePlayed_reports_using_latest_queueVersion">[docs]</a>    <span class="k">def</span> <span class="nf">test_timePlayed_reports_using_latest_queueVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for SWPBL-62125</span>
<span class="sd">        Verify that /timePlayed reports uses the latest queueVersion known to the player</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>

        <span class="c1"># Set the reports policy to something short and verify that its correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;sendUpdateAfterMillis should be 5000&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Add a track and get the new queueVersion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">newQV</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">:</span> <span class="n">newQV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotEqualOrStop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span> <span class="n">newQV</span><span class="p">,</span>
                                  <span class="s2">&quot;queueVersion should have changed after adding a track&quot;</span><span class="p">)</span>

        <span class="c1"># Get the new itemWindow and send it to the player via a SCA-style skipToItemWithWindow</span>
        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_itemwindow_endpoint</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item_with_window</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>

        <span class="c1"># Verify that the /timePlayed reports have the new queueVersion</span>
        <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="n">newQV</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="n">newQV</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">final</span><span class="p">,</span> <span class="n">DURATION_PLAYED</span><span class="p">,</span> <span class="mi">15000</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_seek_to_end"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_seek_to_end">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek_to_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-63025</span>
<span class="sd">        Repeatedly seek to the end of a series of tracks.</span>
<span class="sd">        Verify that the each track played generates a /timePlayed report</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Play the beginning of each track for a second, seek to 1 second before end of of track,</span>
        <span class="c1"># and play to end of track for 9 tracks</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                            <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="mi">3</span><span class="p">)))</span>
                <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:01&quot;</span><span class="p">,</span>
                                <span class="n">iteration_delay</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="n">y</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">29000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;24&quot;</span><span class="p">))</span>

        <span class="c1"># We should get 24 reports with durationPlayedMillis between 2 and 3 seconds</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                            <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                          <span class="mi">3000</span> <span class="o">&gt;</span>
                                                                          <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;durationPlayedMillis&#39;</span><span class="p">]</span>
                                                                          <span class="o">&gt;</span> <span class="mi">1500</span><span class="p">),</span>
                                                            <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                                            <span class="n">expected</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span>
                                   <span class="s2">&quot;There should be 24 /timePlayed reports&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_periodic_timePlayed_reports_repeat"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_periodic_timePlayed_reports_repeat">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">timePlayed_mode_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_periodic_timePlayed_reports_repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covers SWPBL-66770</span>
<span class="sd">        Verify that periodic reports repeat at the desired interval</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Restart the mock CQ server to use longer length tracks</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">,</span>
                                      <span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/normal_length&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">:</span> <span class="n">delay</span><span class="p">})</span>

        <span class="c1"># the following policy customizes the mock behavior, but is not part of the official API</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;custom-mode-return-value&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;periodicIntervalMillis should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delay</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Using &quot;periodicIntervalMillis&quot; by itself will result in a update report to be sent after</span>
        <span class="c1"># 1 second of playback</span>
        <span class="c1"># Pause here so we can verify this initial report and then clear it before playing more</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:02&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="c1"># SWPBL-69510</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;update&quot;</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;queueVersion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qv</span> <span class="ow">and</span>
                                                                              <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;durationPlayedMillis&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
                                                                <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span>
                                   <span class="s2">&quot;sendUpdateAfterMillis is not set on the server so there should not be a report after 1000ms&quot;</span><span class="p">)</span>

        <span class="c1"># Clear the log and restart playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Verify the first periodic report is sent in a timely fashion and is accurate</span>
        <span class="c1"># Clear the log before verifying the next report</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:10&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;durationPlayedMillis&quot;</span><span class="p">],</span> <span class="n">delay</span><span class="o">+</span><span class="mi">5000</span><span class="p">,</span>
                                         <span class="n">delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
                                         <span class="n">message</span><span class="o">=</span><span class="s2">&quot;update-type /timePlayed report should have been sent promptly&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">POSITION</span><span class="p">,</span> <span class="n">delay</span><span class="o">+</span><span class="mi">5000</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">item_played</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span>
                                                     <span class="n">POSITION</span><span class="p">,</span> <span class="n">POSITION_AT_SEGMENT_START</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>

        <span class="c1"># Verify the next periodic report is sent</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:20&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;durationPlayedMillis&quot;</span><span class="p">],</span> <span class="n">delay</span><span class="o">+</span><span class="mi">15000</span><span class="p">,</span>
                                         <span class="n">delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
                                         <span class="n">message</span><span class="o">=</span><span class="s2">&quot;update-type /timePlayed report should have been sent promptly&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">POSITION</span><span class="p">,</span> <span class="n">delay</span><span class="o">+</span><span class="mi">15000</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">item_played</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span>
                                                     <span class="n">POSITION</span><span class="p">,</span> <span class="n">POSITION_AT_SEGMENT_START</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_reports_policy</span><span class="p">(</span><span class="s2">&quot;custom-mode-return-value&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_use_both_periodic_and_updateAfterMillis"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_use_both_periodic_and_updateAfterMillis">[docs]</a>    <span class="k">def</span> <span class="nf">test_use_both_periodic_and_updateAfterMillis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covers SWPBL-66770</span>
<span class="sd">        Verifies reporting behavior if &quot;periodicIntervalMillis&quot; and &quot;sendUpdateAfterMillis&quot; policies</span>
<span class="sd">        are both used</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">,</span>
                                      <span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/normal_length&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">:</span> <span class="n">delay</span><span class="p">,</span>
                                            <span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">:</span> <span class="n">delay</span><span class="o">-</span><span class="mi">5000</span><span class="p">,</span>
                                            <span class="s2">&quot;sendPlaybackActions&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_playback_policy</span><span class="p">({</span><span class="s2">&quot;pauseAtEndOfQueue&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;periodicIntervalMillis should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delay</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">delay</span><span class="o">-</span><span class="mi">5000</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;sendUpdateAfterMillis should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delay</span><span class="o">-</span><span class="mi">5000</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Verify that the first update report comes out in a time consistent with the value set for</span>
        <span class="c1"># &quot;sendUpdateAfterMillis&quot;</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:03&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;durationPlayedMillis&quot;</span><span class="p">],</span> <span class="n">delay</span><span class="o">-</span><span class="mi">5000</span><span class="p">,</span>
                                         <span class="n">delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
                                         <span class="n">message</span><span class="o">=</span><span class="s2">&quot;update-type /timePlayed report from &quot;</span>
                                                 <span class="s2">&quot;&#39;sendUpdateAfterMillis&#39; should have been sent promptly&quot;</span><span class="p">)</span>
        <span class="c1"># SWPBL-66771</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="s2">&quot;pause&quot;</span><span class="p">,</span> <span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;actions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                <span class="s2">&quot;actions.pause item should be in the itemPlayed report&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;actions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;pause&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;positionMillis&quot;</span><span class="p">],</span>
                                         <span class="mi">3000</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                                         <span class="n">message</span><span class="o">=</span><span class="s2">&quot;positionMillis of the pause action should be accurate&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Verify that before playtime exceeded the periodic time, we do not get another update report</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:11&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">timePlayed_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                               <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                             <span class="s2">&quot;actions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                                               <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                               <span class="n">expected</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">timePlayed_log</span><span class="p">),</span>
                                   <span class="s2">&quot;There should not be an update report before the periodic playtime is met&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Verify the next update report comes out in a time consistant with the periodic interval</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;durationPlayedMillis&quot;</span><span class="p">],</span> <span class="n">delay</span><span class="o">+</span><span class="mi">5000</span><span class="p">,</span>
                                         <span class="n">delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
                                         <span class="n">message</span><span class="o">=</span><span class="s2">&quot;update-type /timePlayed report from &quot;</span>
                                                 <span class="s2">&quot;&#39;periodicIntervalMillis&#39; should have been sent promptly&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_periodic_timePlayed_reports_repeat_after_delegation"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_periodic_timePlayed_reports_repeat_after_delegation">[docs]</a>    <span class="k">def</span> <span class="nf">test_periodic_timePlayed_reports_repeat_after_delegation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covers SWPBL-87699</span>
<span class="sd">        Test timePlayed reports repeat after delegation. Cloudqueue playback is initiated</span>
<span class="sd">        on {zp(gc), zp2}, which means that zp should recieve the reporting policies.</span>
<span class="sd">        Via a grouping command, we then force zp to delegate to zp2, which should mean that</span>
<span class="sd">        zp2 now has the original reporting policies from the cloudqueue server. Hence, we then</span>
<span class="sd">        verify that we receive the expected reports from zp2.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Select a second ZP to use</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span> <span class="o">=</span> <span class="n">ifilter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()</span> <span class="ow">and</span> <span class="n">d</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;No second playable ZP found&quot;</span><span class="p">)</span>

        <span class="c1"># Create a group with zp (gc) and zp2 using Muse createGroup()</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">];</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupInfoEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;coordinatorId&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;playerIds&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Restart the mock CQ server to use longer length tracks</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">,</span>
                                      <span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/normal_length&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">:</span> <span class="n">delay</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;periodicIntervalMillis should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delay</span><span class="p">))</span>

        <span class="c1"># Load a cloud queue and wait for playback to stat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Force zp to delegate to zp2 using Muse setGroupMembers()</span>
        <span class="n">new_pids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">];</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                           <span class="n">playerIds</span><span class="o">=</span><span class="n">new_pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupInfoEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;coordinatorId&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="o">.</span><span class="n">raw_udn</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;playerIds&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Store zp2&#39;s group id at this point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gid2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="o">.</span><span class="n">GroupManagement</span><span class="o">.</span><span class="n">get_local_group_uuid</span><span class="p">()</span>

        <span class="c1"># Make sure that playback is stopped on zp at this point</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># For the rest of the test, check zp2&#39;s state</span>

        <span class="c1"># Clear the log and restart playback on zp2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Verify the first periodic report is sent in a timely fashion and is accurate</span>
        <span class="c1"># Clear the log before verifying the next report</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:10&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">playback_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid2</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;durationPlayedMillis&quot;</span><span class="p">],</span> <span class="n">delay</span><span class="o">+</span><span class="mi">5000</span><span class="p">,</span>
                                         <span class="n">delta</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                                         <span class="n">message</span><span class="o">=</span><span class="s2">&quot;update-type /timePlayed report should have been sent promptly&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">POSITION</span><span class="p">,</span> <span class="n">delay</span><span class="o">+</span><span class="mi">5000</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">item_played</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span>
                                                     <span class="n">POSITION</span><span class="p">,</span> <span class="n">POSITION_AT_SEGMENT_START</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>

        <span class="c1"># Verify the next periodic report is sent</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:20&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">playback_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid2</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;durationPlayedMillis&quot;</span><span class="p">],</span> <span class="n">delay</span><span class="o">+</span><span class="mi">15000</span><span class="p">,</span>
                                         <span class="n">delta</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                                         <span class="n">message</span><span class="o">=</span><span class="s2">&quot;update-type /timePlayed report should have been sent promptly&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">POSITION</span><span class="p">,</span> <span class="n">delay</span><span class="o">+</span><span class="mi">15000</span><span class="p">,</span> <span class="n">ms_delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_itemPlayed_duration_relationship</span><span class="p">(</span><span class="n">item_played</span><span class="p">,</span> <span class="n">item_played</span><span class="p">[</span><span class="n">DURATION_PLAYED</span><span class="p">],</span>
                                                     <span class="n">POSITION</span><span class="p">,</span> <span class="n">POSITION_AT_SEGMENT_START</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_change_periodic_interval_while_playing"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_change_periodic_interval_while_playing">[docs]</a>    <span class="k">def</span> <span class="nf">test_change_periodic_interval_while_playing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covers SWPBL-66770</span>
<span class="sd">        Verifies that changes to the periodic reporting interval take effect after each report POST to the CQ server</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="mi">20000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">,</span>
                                      <span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/normal_length&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">:</span> <span class="n">delay</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;periodicIntervalMillis should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delay</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:18&quot;</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="c1"># Increase the periodic reporting interval before the first update report is sent so that the</span>
        <span class="c1"># player will pick up the change after the server responds to the report POST</span>
        <span class="n">delay</span><span class="o">-=</span><span class="mi">10000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">:</span> <span class="n">delay</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;periodicIntervalMillis should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delay</span><span class="p">))</span>
        <span class="c1"># Verify that the first update was sent in a reasonable time frame relating to the initial</span>
        <span class="c1"># periodic reporting interval</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;durationPlayedMillis&quot;</span><span class="p">],</span> <span class="n">delay</span><span class="o">+</span><span class="mi">15000</span><span class="p">,</span>
                                         <span class="n">delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
                                         <span class="n">message</span><span class="o">=</span><span class="s2">&quot;update-type /timePlayed report should have been sent promptly&quot;</span><span class="p">)</span>

        <span class="c1"># Verify that the next update report reflects the new periodic reporting interval</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:28&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="c1"># Set the periodic reporting interval to 0 to stop updates after this one</span>
        <span class="n">delay</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">:</span> <span class="n">delay</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;periodicIntervalMillis should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delay</span><span class="p">))</span>
        <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                          <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;durationPlayedMillis&quot;</span><span class="p">],</span> <span class="n">delay</span><span class="o">+</span><span class="mi">35000</span><span class="p">,</span>
                                         <span class="n">delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
                                         <span class="n">message</span><span class="o">=</span><span class="s2">&quot;update-type /timePlayed report should have been sent promptly&quot;</span><span class="p">)</span>

        <span class="c1"># Verify that if you remove &quot;durationPlayedMillis&quot;, no more periodic updates will be sent</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:38&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="n">timePlayed_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                             <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span><span class="p">,</span>
                                                                             <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                             <span class="n">expected</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">timePlayed_log</span><span class="p">),</span>
                                   <span class="s2">&quot;There should not be an update report since the periodic policy is set to 0&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_sendUpdateAfterMillis_set_to_zero_sends_initial_report"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_sendUpdateAfterMillis_set_to_zero_sends_initial_report">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">sendUpdateAfterMillis_value_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_sendUpdateAfterMillis_set_to_zero_sends_initial_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-69510</span>
<span class="sd">        Verify that explicitly setting periodicIntervalMillis to None is the same as omitting it.</span>
<span class="sd">        Also verify that periodicIntervalMillis set to zero enables the old behavior of sending the first</span>
<span class="sd">        report after one second of playback.</span>
<span class="sd">        :param delay:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">:</span> <span class="n">delay</span><span class="p">,</span>
                                            <span class="s2">&quot;sendPlaybackActions&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_reports_policy</span><span class="p">()[</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;periodicIntervalMillis should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delay</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Pause here so we can verify the behavior of the initial report</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:02&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>

        <span class="c1"># Verify no report is the value is set to None</span>
        <span class="k">if</span> <span class="n">delay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                        <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span> <span class="ow">and</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;update&quot;</span> <span class="ow">and</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;queueVersion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qv</span> <span class="ow">and</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;durationPlayedMillis&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
                                                        <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span>
                                       <span class="s2">&quot;sendUpdateAfterMillis is set to None on the server&quot;</span>
                                       <span class="s2">&quot;so there should not be a report after 1000ms&quot;</span><span class="p">)</span>
        <span class="c1"># Verify te 1 sec report if the value is set to 0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                              <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span>
                                                              <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">item_played</span><span class="p">[</span><span class="s2">&quot;durationPlayedMillis&quot;</span><span class="p">],</span> <span class="mi">2000</span><span class="p">,</span>
                                             <span class="n">delta</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
                                             <span class="n">message</span><span class="o">=</span><span class="s2">&quot;update-type /timePlayed report should have been sent promptly&quot;</span><span class="p">)</span>
            <span class="c1"># SWPBL-66771</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotInOrFailCase</span><span class="p">(</span><span class="s2">&quot;actions&quot;</span><span class="p">,</span> <span class="n">item_played</span><span class="p">,</span>
                                       <span class="s2">&quot;actions.pause item should not be in the itemPlayed report&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueReportingImpl.test_timePlayed_reports_correlated_via_reportId"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReportingImpl.test_timePlayed_reports_correlated_via_reportId">[docs]</a>    <span class="k">def</span> <span class="nf">test_timePlayed_reports_correlated_via_reportId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-116383</span>
<span class="sd">        Verifies that the reportId for v2.3 CQ are consistent across tracks in timePlayed update and final reports</span>
<span class="sd">        Also verifies reportId changes upon loading the next track</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Configure and load CQ server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">,</span>
                                      <span class="n">endpoint_version</span><span class="o">=</span><span class="mf">2.3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;sendUpdateAfterMillis&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_reports_policy</span><span class="p">({</span><span class="s2">&quot;periodicIntervalMillis&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>

        <span class="c1"># Grab first update</span>
        <span class="n">time_played</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                          <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>

        <span class="c1"># Grab next update</span>
        <span class="n">time_played_later</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                                <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Verify reportIds match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">time_played</span><span class="p">[</span><span class="s1">&#39;reportId&#39;</span><span class="p">],</span> <span class="n">time_played_later</span><span class="p">[</span><span class="s1">&#39;reportId&#39;</span><span class="p">],</span>
                                   <span class="s2">&quot;update reportIds should match. Expected:</span><span class="si">{}</span><span class="s2"> Actual:</span><span class="si">{}</span><span class="s2">&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_played</span><span class="p">[</span><span class="s1">&#39;reportId&#39;</span><span class="p">],</span> <span class="n">time_played_later</span><span class="p">[</span><span class="s1">&#39;reportId&#39;</span><span class="p">]))</span>

        <span class="c1"># Grab the final</span>
        <span class="n">time_played_final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">,</span>
                                                                <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

        <span class="c1"># Verify reportIds match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">time_played</span><span class="p">[</span><span class="s1">&#39;reportId&#39;</span><span class="p">],</span> <span class="n">time_played_final</span><span class="p">[</span><span class="s1">&#39;reportId&#39;</span><span class="p">],</span>
                                   <span class="s2">&quot;final reportIds should match. Expected:</span><span class="si">{}</span><span class="s2"> &quot;</span>
                                   <span class="s2">&quot;Actual:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_played</span><span class="p">[</span><span class="s1">&#39;reportId&#39;</span><span class="p">],</span> <span class="n">time_played_later</span><span class="p">[</span><span class="s1">&#39;reportId&#39;</span><span class="p">]))</span>

        <span class="c1"># Grab next track update</span>
        <span class="n">time_played_next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_played_data_for_track</span><span class="p">(</span><span class="n">t_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                                                               <span class="n">queueVersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qv</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

        <span class="c1"># Verify reportIds DO NOT match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotEqualOrFailCase</span><span class="p">(</span><span class="n">time_played</span><span class="p">[</span><span class="s1">&#39;reportId&#39;</span><span class="p">],</span> <span class="n">time_played_next</span><span class="p">[</span><span class="s1">&#39;reportId&#39;</span><span class="p">],</span>
                                      <span class="s2">&quot;new track reportIds should NOT match. Found:</span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_played_later</span><span class="p">[</span><span class="s1">&#39;reportId&#39;</span><span class="p">]))</span></div></div>


<div class="viewcode-block" id="CloudQueueReporting"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_reporting.CloudQueueReporting">[docs]</a><span class="k">class</span> <span class="nc">CloudQueueReporting</span><span class="p">(</span><span class="n">CloudQueueReportingImpl</span><span class="p">,</span> <span class="n">MuseClientFixtureMixin</span><span class="p">):</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NIGHTLY_CLOUDQUEUE_TPM&#39;</span><span class="p">]</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">WorkflowTestSuite</span><span class="p">(</span><span class="s2">&quot;Cloud Queue Reporting Tests&quot;</span><span class="p">,)</span>
    <span class="n">suite</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">CloudQueueReporting</span><span class="p">()])</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">suite</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_pass</span><span class="p">()</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>