
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>webserver.muse_session_namespace &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for webserver.muse_session_namespace</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Integration tests for the Muse protocol session namespace commands.</span>
<span class="sd">Players must support the muse endpoint.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">ifilter</span>
<span class="kn">from</span> <span class="nn">sonos.client.websockets.event</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Error</span><span class="p">,</span> <span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">GroupStatus</span><span class="p">,</span>
    <span class="n">MetadataStatusEvent</span><span class="p">,</span> <span class="n">PlaybackState</span><span class="p">,</span> <span class="n">PlaybackStatusEvent</span><span class="p">,</span>
    <span class="n">SessionInfoEvent</span><span class="p">,</span> <span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">SessionState</span><span class="p">,</span>
    <span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">Success</span><span class="p">,</span> <span class="n">sessionConditionCheckErrorEvent</span><span class="p">,</span> <span class="n">AccountErrorEvent</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sonos.client.websockets.base_websocket</span> <span class="k">import</span> <span class="n">WebsocketMessageRaw</span>
<span class="kn">from</span> <span class="nn">webserver.base_muse_fixture</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">BaseMuseFixture</span><span class="p">,</span> <span class="n">MuseClientFixtureMixin</span><span class="p">,</span>
    <span class="n">MuseCloudServerFixtureMixin</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.suite</span> <span class="k">import</span> <span class="n">WorkflowTestSuite</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">combinatorial</span><span class="p">,</span> <span class="n">skip</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">webserver.helpers.cloud_queue_helpers</span> <span class="k">import</span> <span class="n">cq_helpers</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">upnp.helpers.ignore_invoke_errors</span> <span class="k">import</span> <span class="n">IgnoreInvokeErrors</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">webserver.helpers.node_smapi_control</span>
<span class="kn">from</span> <span class="nn">coherence.upnp.core</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">common.utils</span> <span class="k">import</span> <span class="n">is_locked_build</span>


<span class="n">smapi_ctl</span> <span class="o">=</span> <span class="n">webserver</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">node_smapi_control</span><span class="o">.</span><span class="n">NodeSmapiControl</span><span class="p">()</span>
<span class="n">cq_helper</span> <span class="o">=</span> <span class="n">cq_helpers</span><span class="p">()</span>


<span class="c1"># Data limit is 1023 bytes</span>
<span class="n">data_limit</span> <span class="o">=</span> <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123456789012345678901234567890123456789012345678901234567890&quot;</span>\
             <span class="s2">&quot;123&quot;</span>


<span class="c1"># Define command structures to test for missing app parameter response</span>
<div class="viewcode-block" id="both_missing"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.both_missing">[docs]</a><span class="k">def</span> <span class="nf">both_missing</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;[{&quot;namespace&quot;: &quot;playbackSession:1&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;command&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;groupId&quot;: &quot;gid&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;householdId&quot;: &quot;hhid&quot;}, &#39;</span> \
                <span class="s1">&#39;{&quot;groupId&quot;: &quot;gid&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;householdId&quot;: &quot;hhid&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;customData&quot;: &quot;&quot;}]&#39;</span>
    <span class="k">return</span> <span class="n">payload</span></div>


<div class="viewcode-block" id="appcontext_missing"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.appcontext_missing">[docs]</a><span class="k">def</span> <span class="nf">appcontext_missing</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;[{&quot;namespace&quot;: &quot;playbackSession:1&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;command&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;groupId&quot;: &quot;gid&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;householdId&quot;: &quot;hhid&quot;}, &#39;</span> \
                <span class="s1">&#39;{&quot;groupId&quot;: &quot;gid&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;householdId&quot;: &quot;hhid&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;appId&quot;: &quot;appid&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;customData&quot;: &quot;&quot;}]&#39;</span>
    <span class="k">return</span> <span class="n">payload</span></div>


<div class="viewcode-block" id="appid_missing"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.appid_missing">[docs]</a><span class="k">def</span> <span class="nf">appid_missing</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;[{&quot;namespace&quot;: &quot;playbackSession:1&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;command&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;groupId&quot;: &quot;gid&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;householdId&quot;: &quot;hhid&quot;}, &#39;</span> \
                <span class="s1">&#39;{&quot;groupId&quot;: &quot;gid&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;householdId&quot;: &quot;hhid&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;appContext&quot;: &quot;appcontext&quot;, &#39;</span> \
                <span class="s1">&#39;&quot;customData&quot;: &quot;&quot;}]&#39;</span>
    <span class="k">return</span> <span class="n">payload</span></div>


<span class="c1"># Create the muse command payloads</span>
<div class="viewcode-block" id="define_join_create_payload"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.define_join_create_payload">[docs]</a><span class="k">def</span> <span class="nf">define_join_create_payload</span><span class="p">():</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;joinOrCreateSession&quot;</span><span class="p">,</span> <span class="s2">&quot;joinSession&quot;</span><span class="p">,</span> <span class="s2">&quot;createSession&quot;</span><span class="p">]</span>
        <span class="n">payloads</span> <span class="o">=</span> <span class="p">[</span><span class="n">both_missing</span><span class="p">,</span> <span class="n">appid_missing</span><span class="p">,</span> <span class="n">appcontext_missing</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">payloads</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">p</span><span class="p">(</span><span class="n">c</span><span class="p">)</span></div>


<div class="viewcode-block" id="app_id_and_context_generator"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.app_id_and_context_generator">[docs]</a><span class="k">def</span> <span class="nf">app_id_and_context_generator</span><span class="p">():</span>
    <span class="n">app_ids</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;notNoneAppId&quot;</span><span class="p">]</span>
    <span class="n">app_contexts</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;notNoneAppContext&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">app_id</span> <span class="ow">in</span> <span class="n">app_ids</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">app_context</span> <span class="ow">in</span> <span class="n">app_contexts</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">app_context</span></div>


<div class="viewcode-block" id="valid_preconditions_generator"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.valid_preconditions_generator">[docs]</a><span class="k">def</span> <span class="nf">valid_preconditions_generator</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">precondition</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">,</span> <span class="s2">&quot;playing&quot;</span><span class="p">,</span> <span class="s2">&quot;itemId&quot;</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">precondition</span></div>


<div class="viewcode-block" id="MuseSessionTests"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests">[docs]</a><span class="k">class</span> <span class="nc">MuseSessionTests</span><span class="p">(</span><span class="n">BaseMuseFixture</span><span class="p">):</span>
<div class="viewcode-block" id="MuseSessionTests.setUpFixture"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseSessionTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseSessionTests.setUpTest"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseSessionTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseSessionTests.tearDownTest"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">remove_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_all</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseSessionTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseSessionTests.tearDownFixture"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseSessionTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_appid_appcontext_attribute_check"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_appid_appcontext_attribute_check">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">define_join_create_payload</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_appid_appcontext_attribute_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">WebsocketMessageRaw</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">send_message_raw</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># SWPBL-61954</span>
        <span class="c1"># Adding extra verification to make sure this globalError has a householdId and groupId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span> <span class="ow">and</span>
                                                           <span class="n">e</span><span class="o">.</span><span class="n">household_id</span> <span class="o">==</span> <span class="s2">&quot;hhid&quot;</span> <span class="ow">and</span>
                                                           <span class="n">e</span><span class="o">.</span><span class="n">group_id</span> <span class="o">==</span> <span class="s2">&quot;gid&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_subscribe"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_subscribe">[docs]</a>    <span class="k">def</span> <span class="nf">test_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test subscribe on the playbackSession namespace</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">((</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span>
                                                    <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">householdId</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sessionId</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">))</span>

        <span class="c1">#create a second Muse client to the same player</span>
        <span class="n">second_muse_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">second_muse_client</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                          <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                          <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                          <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                          <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">REPLACED</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_subscribe_no_session_id"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_subscribe_no_session_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_subscribe_no_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">((</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span>
                                                    <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_subscribe_expired_session_id"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_subscribe_expired_session_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_subscribe_expired_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                             <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">original_session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="n">original_session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="c1"># SWPBL-61954</span>
        <span class="c1"># Adding extra verification to make sure this globalError has the householdId and sessionId</span>
        <span class="c1"># that was passed in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">INVALID_OBJECT_ID</span> <span class="ow">and</span>
                                                           <span class="n">e</span><span class="o">.</span><span class="n">household_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span> <span class="ow">and</span>
                                                           <span class="n">e</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="n">original_session_id</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_unsubscribe"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_unsubscribe">[docs]</a>    <span class="k">def</span> <span class="nf">test_unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test unsubscribe on the playbackSession namespace</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">((</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span>
                                                    <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">unsubscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#create a second Muse client to the same player</span>
        <span class="n">second_muse_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">second_muse_client</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                          <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                          <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                          <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                          <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">expect_event</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">REPLACED</span><span class="p">))</span>
        <span class="c1"># Manually update session_id since this connection is not receiving session evictions.</span>
        <span class="c1"># Otherwise, &quot;leave_session&quot; command is invoked from test tear down.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_unsubscribe_expired_session_id"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_unsubscribe_expired_session_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_unsubscribe_expired_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                             <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">original_session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">unsubscribe_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="n">original_session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">INVALID_OBJECT_ID</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_implicit_unsubscribe_on_evict"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_implicit_unsubscribe_on_evict">[docs]</a>    <span class="k">def</span> <span class="nf">test_implicit_unsubscribe_on_evict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that leaving a playbackSession will implicitly close out the clients</span>
<span class="sd">        subscription to playbackSession.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">((</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span>
                                                    <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sessionId</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>

        <span class="c1">#create a second Muse client to the same player</span>
        <span class="n">second_muse_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">second_muse_client</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                          <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                          <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                          <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                          <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">REPLACED</span><span class="p">))</span>

        <span class="c1">#create a third session to send a second eviction</span>
        <span class="n">second_muse_client</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                          <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                          <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                          <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                          <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1">#verify no eviction event is received</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span><span class="n">expect_event</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_implicit_unsubscribe_on_leave"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_implicit_unsubscribe_on_leave">[docs]</a>    <span class="k">def</span> <span class="nf">test_implicit_unsubscribe_on_leave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that leaving a playbackSession will implicitly unsubscribe the client</span>
<span class="sd">        from playbackSession</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">((</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span>
                                                    <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sessionId</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">leave_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span> <span class="ow">and</span>
                                                     <span class="n">e</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;Last client left session&quot;</span><span class="p">))</span>

        <span class="c1">#connect a second Muse client and create a second session to the same player</span>
        <span class="n">second_muse_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">second_muse_client</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                          <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                          <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                          <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                          <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">expect_event</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_unsubscribe_no_session_id"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_unsubscribe_no_session_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_unsubscribe_no_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                             <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">unsubscribe_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_unsubscribe_after_gc_gone"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_unsubscribe_after_gc_gone">[docs]</a>    <span class="k">def</span> <span class="nf">test_unsubscribe_after_gc_gone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test unsubscribe to playback session namespace on after gc gone</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Other group coordinator</span>
        <span class="n">diff_gc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_playback_gc</span><span class="p">()</span>
        <span class="n">diff_gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
        <span class="n">diff_gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue</span><span class="p">()</span>

        <span class="c1"># Create playback session on zp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">((</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span>
                                                    <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">)))</span>

        <span class="c1"># Subscribe to MUSE playback session on zp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">householdId</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sessionId</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">))</span>

        <span class="c1"># Cache session ID</span>
        <span class="n">session_id_cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span>

        <span class="c1"># Join other group, zp is no longer group coordinator, this will trigger group coordinator gone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="n">diff_gc</span><span class="p">)</span>
        <span class="n">diff_gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">GONE</span><span class="p">))</span>

        <span class="c1"># Send playback session unsubscribe command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">unsubscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">session_id_cached</span><span class="p">)</span>

        <span class="c1"># Verify the error is global error with code INVALID_OBJECT_ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">INVALID_OBJECT_ID</span><span class="p">)</span>

        <span class="c1"># Manually update session_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_is_not_subscribed_create"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_is_not_subscribed_create">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_not_subscribed_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that when creating a new session on the player the client</span>
<span class="sd">        is not implicitly subscribed. The failure in this test case currently is</span>
<span class="sd">        that if an eviction event comes through the test will still pass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create a second Muse client to the same player to evict the first client</span>
        <span class="n">second_muse_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">second_muse_client</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                          <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                          <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                          <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">second_muse_client</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>

        <span class="c1">#verify no eviction event is received</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span><span class="n">expect_event</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">connection</span><span class="o">=</span><span class="n">second_muse_client</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_is_not_subscribed_join_or_create"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_is_not_subscribed_join_or_create">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_not_subscribed_join_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#create a second Muse client to the same player to evict the first client</span>
        <span class="n">second_muse_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">second_muse_client</span><span class="o">.</span><span class="n">join_or_create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                                  <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                                  <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                                  <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">second_muse_client</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>

        <span class="c1">#verify no eviction event is received</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span><span class="n">expect_event</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">connection</span><span class="o">=</span><span class="n">second_muse_client</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_is_not_subscribed_join"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_is_not_subscribed_join">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_not_subscribed_join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that when joining a playbackSession the client does not</span>
<span class="sd">        implicitly subscribe to the namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>
        <span class="c1">#create a second Muse client to the same player to evict the first client</span>
        <span class="n">second_muse_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">second_muse_client</span><span class="o">.</span><span class="n">join_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                        <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                        <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span><span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">second_muse_client</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>
        <span class="c1">#evict the current session and check that no eviction is received on second_muse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span><span class="n">expect_event</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">connection</span><span class="o">=</span><span class="n">second_muse_client</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_is_subscribed_gc_events"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_is_subscribed_gc_events">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_subscribed_gc_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test that subscribing to playbackSession implicitly subscribes</span>
<span class="sd">        the client to GroupCoordinatorChangedEvents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#restart muse connection to clear subscriptions from muse_session_namespace.setUpTest</span>
        <span class="n">MuseClientFixtureMixin</span><span class="o">.</span><span class="n">disconnect_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">diff_gc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_playback_gc</span><span class="p">()</span>
        <span class="n">diff_gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
        <span class="n">diff_gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="n">diff_gc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">leave_group_and_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="c1"># Session Management Tests</span>
    <span class="c1"># State &quot;NoSession&quot;</span>

<div class="viewcode-block" id="MuseSessionTests.test_no_session_create"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_no_session_create">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_session_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test createSession and joinOrCreateSession when there is not a pre-existing</span>
<span class="sd">        muse session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">my_custom_data</span> <span class="o">=</span> <span class="s2">&quot;SessionManagementCreateNoPreExistingSession&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="n">my_custom_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">my_custom_data</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_no_session_join_or_create"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_no_session_join_or_create">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_session_join_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test createSession and joinOrCreateSession when there is not a pre-existing</span>
<span class="sd">        muse session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">my_custom_data</span> <span class="o">=</span> <span class="s2">&quot;SessionManagementCreateNoPreExistingSession&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_or_create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                         <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                         <span class="n">custom_data</span><span class="o">=</span><span class="n">my_custom_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">my_custom_data</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_no_session_join"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_no_session_join">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_session_join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test joinSession when there is not a pre-existing muse session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                               <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span></div>

    <span class="c1"># State &quot;Inactive&quot;</span>

<div class="viewcode-block" id="MuseSessionTests.test_inactive_session_create"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_inactive_session_create">[docs]</a>    <span class="k">def</span> <span class="nf">test_inactive_session_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test createSession when there is a pre-existing muse session without content.</span>
<span class="sd">        * The original connection should be evicted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create a session</span>
        <span class="n">second_muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">second_muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                   <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">second_muse</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">second_muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">second_muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">connection</span><span class="o">=</span><span class="n">second_muse</span><span class="p">)</span>

        <span class="c1"># Test that creating succeeds</span>
        <span class="n">my_custom_data</span> <span class="o">=</span> <span class="s2">&quot;SessionManagementCreateInactiveSession&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="n">my_custom_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">my_custom_data</span><span class="p">))</span>

        <span class="c1"># look for the eviction on the other connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">second_muse</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_inactive_session_join"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_inactive_session_join">[docs]</a>    <span class="k">def</span> <span class="nf">test_inactive_session_join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test joinSession when there is a pre-existing muse session without content.</span>
<span class="sd">        * The original connection should *not* be evicted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create a session</span>
        <span class="n">my_custom_data</span> <span class="o">=</span> <span class="s2">&quot;SessionManagementJoinInactiveSession&quot;</span>
        <span class="n">first_muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">first_muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                  <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                  <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                  <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                  <span class="n">custom_data</span><span class="o">=</span><span class="n">my_custom_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">first_muse</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">my_custom_data</span><span class="p">))</span>
        <span class="n">first_session_id</span> <span class="o">=</span> <span class="n">first_muse</span><span class="o">.</span><span class="n">session_id</span>

        <span class="c1"># Test that joining with mismatched arguments returns SESSION_IN_PROGRESS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                               <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,)</span>

        <span class="c1"># Test that joining succeeds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                               <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="n">first_session_id</span><span class="p">,</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">my_custom_data</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_inactive_session_join_or_create"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_inactive_session_join_or_create">[docs]</a>    <span class="k">def</span> <span class="nf">test_inactive_session_join_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test joinSession when there is a pre-existing muse session without content.</span>
<span class="sd">        * The original connection should *not* be evicted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create a session</span>
        <span class="n">my_custom_data</span> <span class="o">=</span> <span class="s2">&quot;SessionManagementJoinInactiveSession&quot;</span>
        <span class="n">first_muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">first_muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                  <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                  <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                  <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                  <span class="n">custom_data</span><span class="o">=</span><span class="n">my_custom_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">first_muse</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">my_custom_data</span><span class="p">))</span>
        <span class="n">first_session_id</span> <span class="o">=</span> <span class="n">first_muse</span><span class="o">.</span><span class="n">session_id</span>

        <span class="c1"># Test that joining with mismatched arguments returns SESSION_IN_PROGRESS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_or_create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                         <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Test that joining succeeds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_or_create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                         <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="n">first_session_id</span><span class="p">,</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">my_custom_data</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_active_session_create"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_active_session_create">[docs]</a>    <span class="k">def</span> <span class="nf">test_active_session_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test creating a new session while playing content</span>
<span class="sd">        * The original connection should be evicted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">my_custom_data</span> <span class="o">=</span> <span class="s2">&quot;SessionManagementCreateActiveSession&quot;</span>
        <span class="n">first_muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">first_muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                  <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                  <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                  <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                  <span class="n">custom_data</span><span class="o">=</span><span class="n">my_custom_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">first_muse</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">my_custom_data</span><span class="p">))</span>
        <span class="n">first_session_id</span> <span class="o">=</span> <span class="n">first_muse</span><span class="o">.</span><span class="n">session_id</span>
        <span class="n">first_muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">first_session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">first_muse</span><span class="p">)</span>
        <span class="n">first_muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="n">first_session_id</span><span class="p">,</span>
                                    <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                    <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">first_muse</span><span class="p">)</span>

        <span class="n">updated_custom_data</span> <span class="o">=</span> <span class="s2">&quot;AnotherString&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="n">updated_custom_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_id</span> <span class="o">!=</span> <span class="n">first_session_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">updated_custom_data</span><span class="p">))</span>

        <span class="c1"># look for the eviction on the other connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">first_muse</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_active_session_join"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_active_session_join">[docs]</a>    <span class="k">def</span> <span class="nf">test_active_session_join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test joining a session while playing content</span>
<span class="sd">        * The original connection should *not* be evicted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">my_custom_data</span> <span class="o">=</span> <span class="s2">&quot;SessionManagementCreateActiveSession&quot;</span>
        <span class="n">first_muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">first_muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                  <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                  <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                  <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                  <span class="n">custom_data</span><span class="o">=</span><span class="n">my_custom_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">first_muse</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">my_custom_data</span><span class="p">))</span>
        <span class="n">first_session_id</span> <span class="o">=</span> <span class="n">first_muse</span><span class="o">.</span><span class="n">session_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="n">first_muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Joining with mismatched parameters should fail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">app_id</span><span class="o">=</span><span class="s1">&#39;---&#39;</span><span class="p">,</span>
                               <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_JOIN_FAILED</span><span class="p">))</span>

        <span class="c1"># Joining should succeed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                               <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="n">first_session_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">my_custom_data</span><span class="p">))</span>
        <span class="c1"># verify playback state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                      <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_active_session_join_or_create"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_active_session_join_or_create">[docs]</a>    <span class="k">def</span> <span class="nf">test_active_session_join_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test joining a session while playing content</span>
<span class="sd">        * The original connection should *not* be evicted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">my_custom_data</span> <span class="o">=</span> <span class="s2">&quot;SessionManagementCreateActiveSession&quot;</span>
        <span class="n">first_muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">first_muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                  <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                  <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                  <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                  <span class="n">custom_data</span><span class="o">=</span><span class="n">my_custom_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">first_muse</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">my_custom_data</span><span class="p">))</span>
        <span class="n">first_session_id</span> <span class="o">=</span> <span class="n">first_muse</span><span class="o">.</span><span class="n">session_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="n">first_muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Joining with mismatched parameters should fail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_or_create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">app_id</span><span class="o">=</span><span class="s1">&#39;---&#39;</span><span class="p">,</span>
                                         <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_IN_PROGRESS</span><span class="p">))</span>

        <span class="c1"># Joining should succeed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_or_create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                         <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="n">first_session_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">my_custom_data</span><span class="p">))</span>
        <span class="c1"># verify playback state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                      <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_session_invalid_create_preserves_existing"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_session_invalid_create_preserves_existing">[docs]</a>    <span class="k">def</span> <span class="nf">test_session_invalid_create_preserves_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">))</span>
        <span class="n">orig_session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="s1">&#39;garbage&#39;</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="s1">&#39;not right&#39;</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="s1">&#39;else&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">leave_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="n">orig_session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_no_session_leave"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_no_session_leave">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_session_leave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">leave_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;some-string&quot;</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">INVALID_OBJECT_ID</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_session_leave"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_session_leave">[docs]</a>    <span class="k">def</span> <span class="nf">test_session_leave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>
        <span class="n">my_session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="n">my_session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">leave_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="n">my_session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="n">my_session_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">leave_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="n">my_session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">INVALID_OBJECT_ID</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_session_leave_bad_session_id"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_session_leave_bad_session_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_session_leave_bad_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An invalid(non-overflowing) sessionID should result in an INVALID_OBJECT_ID error event</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">leave_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;BAD_SESSION_ID&quot;</span><span class="p">,</span>
                                <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">INVALID_OBJECT_ID</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_session_leave_overflowed_session_id"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_session_leave_overflowed_session_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_session_leave_overflowed_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-68348</span>
<span class="sd">        An overflowed sessionId value should result in a INVALID_PARAM error event</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">leave_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span> <span class="o">+</span> <span class="s2">&quot;some-garbage&quot;</span><span class="p">),</span>
                                <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">INVALID_PARAM</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_session_leave_null_session_id"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_session_leave_null_session_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_session_leave_null_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">leave_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_session_custom_data_limit_exceeded"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_session_custom_data_limit_exceeded">[docs]</a>    <span class="k">def</span> <span class="nf">test_session_custom_data_limit_exceeded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># execute this test on self.muse.join_or_create_session and self.muse.create_session</span>
        <span class="n">limit_exceeded</span> <span class="o">=</span> <span class="n">data_limit</span> <span class="o">+</span> <span class="s2">&quot;4567890&quot;</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_or_create_session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">):</span>
            <span class="n">fn</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
               <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
               <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
               <span class="n">custom_data</span><span class="o">=</span><span class="n">limit_exceeded</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">data_limit</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_session_custom_data_limit"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_session_custom_data_limit">[docs]</a>    <span class="k">def</span> <span class="nf">test_session_custom_data_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># execute this test on self.muse.join_or_create_session and self.muse.create_session</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_or_create_session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">):</span>
            <span class="n">fn</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
               <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
               <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
               <span class="n">custom_data</span><span class="o">=</span><span class="n">data_limit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">custom_data</span> <span class="o">==</span> <span class="n">data_limit</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_session_evict_by_changing_avt_uri"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_session_evict_by_changing_avt_uri">[docs]</a>    <span class="k">def</span> <span class="nf">test_session_evict_by_changing_avt_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetAVTransportURI_and_wait</span><span class="p">(</span><span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_session_evict_by_grouping"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_session_evict_by_grouping">[docs]</a>    <span class="k">def</span> <span class="nf">test_session_evict_by_grouping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">diff_gc</span> <span class="o">=</span> <span class="n">ifilter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()</span> <span class="ow">and</span>
                                     <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">is_bonded</span><span class="p">()</span> <span class="ow">and</span>
                                     <span class="n">d</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">diff_gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
        <span class="n">diff_gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue</span><span class="p">()</span>
        <span class="n">my_group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="n">diff_gc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">GONE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">group_id</span> <span class="o">==</span> <span class="n">my_group_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_group_gone_after_joining_player_to_different_muse_session"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_group_gone_after_joining_player_to_different_muse_session">[docs]</a>    <span class="k">def</span> <span class="nf">test_group_gone_after_joining_player_to_different_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that a player delivers a GROUP_GONE event when it is delegated into a different</span>
<span class="sd">        muse session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># setup another player</span>
        <span class="n">diff_gc</span> <span class="o">=</span> <span class="n">ifilter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()</span> <span class="ow">and</span>
                                     <span class="n">d</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">diff_gc_gid</span> <span class="o">=</span> <span class="n">diff_gc</span><span class="o">.</span><span class="n">GroupManagement</span><span class="o">.</span><span class="n">get_local_group_uuid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_debug_module_levels</span><span class="p">(</span><span class="n">module_levels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;muse&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                                                     <span class="s2">&quot;cloudqueue&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                                                     <span class="s2">&quot;chsrc&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                                     <span class="s2">&quot;cqfsm&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                                     <span class="s2">&quot;cssc&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                      <span class="n">zp</span><span class="o">=</span><span class="n">diff_gc</span><span class="p">)</span>
        <span class="n">diff_gc</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log_to_file</span><span class="p">(</span><span class="s2">&quot;/tmp/diff_gc.log&quot;</span><span class="p">)</span>
        <span class="n">diff_muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="n">diff_gc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="n">diff_muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="n">diff_gc_gid</span><span class="p">,</span>
                                                   <span class="n">hhid</span><span class="o">=</span><span class="n">diff_gc</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">zp_group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                  <span class="s2">&quot;load&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;queryParams&#39;</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">]),</span>
                                                    <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                    <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span>
                                   <span class="s2">&quot;Wait for the initial /itemWindow request&quot;</span><span class="p">)</span>

        <span class="c1"># join the second player to self.zp</span>
        <span class="n">diff_gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">diff_muse</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">GONE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">group_id</span> <span class="o">==</span> <span class="n">diff_gc_gid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">diff_muse</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">SessionErrorEvent</span><span class="o">.</span><span class="n">SESSION_EVICTED</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">UPDATED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">group_id</span> <span class="o">==</span> <span class="n">zp_group_id</span><span class="p">))</span>

        <span class="c1"># Clear the server logs and move the music to the second player</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># SWPBL-70270</span>
        <span class="c1"># After delegating the music, the original player should not be making additional</span>
        <span class="c1"># itemWindow requests though there might be a refresh request before the delegation</span>
        <span class="n">itemWindow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                         <span class="n">zp_group_id</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">][</span><span class="s1">&#39;x-sonos-playback-id&#39;</span><span class="p">]),</span>
                                                           <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                           <span class="n">expected</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyLessEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">itemWindow</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                       <span class="s2">&quot;There should not be more then 1 itemWindow request at this point&quot;</span><span class="p">)</span>

        <span class="n">diff_gc</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log_to_file</span><span class="p">()</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/tmp/diff_gc.log&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;BEGIN DIFF_GC ANACAPA LOG, PLAYER </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff_gc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;END DIFF_GC ANACAPA LOG, PLAYER </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff_gc</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;/tmp/diff_gc.log&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_joinOrCreateSession_with_nonempty_queueOwnerId"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_joinOrCreateSession_with_nonempty_queueOwnerId">[docs]</a>    <span class="k">def</span> <span class="nf">test_joinOrCreateSession_with_nonempty_queueOwnerId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-67050</span>
<span class="sd">        The player should be able to create a queue if the private queue&#39;s owner isn&#39;t none but is</span>
<span class="sd">        inactive.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Point the player&#39;s AVT to its private queue with a custom queueOwnerId</span>
        <span class="n">queueId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s2">&quot;Python&quot;</span><span class="p">,</span>
                                            <span class="n">queueownercontext</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                                            <span class="n">queuepolicy</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;x-rincon-queue:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">queueId</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetAVTransportURI_and_wait</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Now point the AVT to the public queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">()</span>

        <span class="c1"># The player should be able to create a new session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_or_create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                         <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                         <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="s2">&quot;SESSION_STATE_CONNECTED&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_createSession_bad_accountId"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_createSession_bad_accountId">[docs]</a>    <span class="k">def</span> <span class="nf">test_createSession_bad_accountId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-83898</span>
<span class="sd">        Verify that passing a bad accountId to createSession results in the correct error event and</span>
<span class="sd">        verify the event paramters match expected values.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">accountId</span> <span class="o">=</span> <span class="s2">&quot;sn_garbage&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">accountId</span><span class="o">=</span><span class="n">accountId</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">AccountErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">AccountErrorEvent</span><span class="o">.</span><span class="n">ACCOUNT_INVALID_ID</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;Invalid account id&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">accountId</span> <span class="o">==</span> <span class="n">accountId</span><span class="p">))</span></div>

    <span class="c1"># Load Cloud Queue Tests</span>

<div class="viewcode-block" id="MuseSessionTests.test_load_cloud_queue"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_load_cloud_queue">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_cloud_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">my_item_id</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
        <span class="n">my_position</span> <span class="o">=</span> <span class="mi">1200</span>
        <span class="n">my_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="n">my_position</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="n">my_metadata</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                      <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">!=</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">!=</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">my_item_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="n">my_position</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_load_cloud_queue_without_track_metadata"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_load_cloud_queue_without_track_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_cloud_queue_without_track_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">my_item_id</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">my_position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                      <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">my_item_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="n">my_position</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_load_cloud_queue_with_null_session_id"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_load_cloud_queue_with_null_session_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_cloud_queue_with_null_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_load_cloud_queue_empty_playlist"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_load_cloud_queue_empty_playlist">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_cloud_queue_empty_playlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Verify the player gracefully handles a loadCloudQueue command that points to an empty playlist.</span>
<span class="sd">        This results in a 404 error on the player but the loadCloudQueue command should return success</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_verify_behavior_after_load_cloud_queue_with_without_autoplay"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_verify_behavior_after_load_cloud_queue_with_without_autoplay">[docs]</a>    <span class="k">def</span> <span class="nf">test_verify_behavior_after_load_cloud_queue_with_without_autoplay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-60538</span>
<span class="sd">        Verify that the player always enters the correct state after a loudCloudQueue command</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="c1"># verify player continues playing if loaded again with autoplay true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>

        <span class="c1"># verify player goes to idle with autoplay false</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                        <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>

        <span class="c1"># verify player goes to idle with no autoplay value</span>
        <span class="c1"># commented out for now until SWBPL-60951 is resolved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                       <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;[{{&quot;namespace&quot;: &quot;playbackSession:1&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;command&quot;: &quot;loadCloudQueue&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;cmdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;sessionId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;householdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;}}, &#39;</span> \
                  <span class="s1">&#39;{{&quot;queueBaseUrl&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;contentType&quot;: &quot;application/x-cloud-queue&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;httpAuthorization&quot;: &quot;playon=12345&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;itemId&quot;: null, &#39;</span> \
                  <span class="s1">&#39;&quot;positionMillis&quot;: null, &#39;</span> \
                  <span class="s1">&#39;&quot;trackMetadata&quot;: null, &#39;</span> \
                  <span class="s1">&#39;&quot;queueVersion&quot;: null}}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">_get_next_cmd_id</span><span class="p">()),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">WebsocketMessageRaw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">send_message_raw</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>

        <span class="c1"># verify player starts playing with autoplay true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>

        <span class="c1"># verify player goes to idle with no autoplay</span>
        <span class="c1"># commented out for now until SWBPL-60951 is resolved</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;[{{&quot;namespace&quot;: &quot;playbackSession:1&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;command&quot;: &quot;loadCloudQueue&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;cmdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;sessionId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;householdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;}}, &#39;</span> \
                  <span class="s1">&#39;{{&quot;queueBaseUrl&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;contentType&quot;: &quot;application/x-cloud-queue&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;httpAuthorization&quot;: &quot;playon=12345&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;itemId&quot;: null, &#39;</span> \
                  <span class="s1">&#39;&quot;positionMillis&quot;: null, &#39;</span> \
                  <span class="s1">&#39;&quot;trackMetadata&quot;: null, &#39;</span> \
                  <span class="s1">&#39;&quot;queueVersion&quot;: null}}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">_get_next_cmd_id</span><span class="p">()),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">WebsocketMessageRaw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">send_message_raw</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>

        <span class="c1"># verify player goes to idle with autoplay false</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                       <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span></div>

    <span class="c1"># The next three tests are to make sure anacapa does not crash when the player</span>
    <span class="c1"># receives JSON data in unexpected formats for input params.</span>
    <span class="c1"># SWPBL-41737</span>
<div class="viewcode-block" id="MuseSessionTests.test_load_cloud_queue_itemid_as_int"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_load_cloud_queue_itemid_as_int">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_cloud_queue_itemid_as_int</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">123</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_load_cloud_queue_itemid_with_extra_closing_quote"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_load_cloud_queue_itemid_with_extra_closing_quote">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_cloud_queue_itemid_with_extra_closing_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;{&quot;header&quot;: &#39;</span> \
                  <span class="s1">&#39;{&quot;namespace&quot;: &quot;session:1&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;command&quot;: &quot;loadCloudQueue&quot;}, &#39;</span> \
                  <span class="s1">&#39;&quot;body&quot;: &#39;</span> \
                  <span class="s1">&#39;{&quot;sessionId&quot;: &quot;sessionIdDoesNotMatter&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;queueBaseUrl&quot;: &quot;queueBaseUriDoesNotMatter&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;contentType&quot;: &quot;application/x-cloud-queue&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;httpAuthorization&quot;: &quot;playon=12345&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;itemId&quot;: &quot;abc&quot;&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;positionMillis&quot;: 0, &#39;</span> \
                  <span class="s1">&#39;&quot;playOnCompletion&quot;: true, &#39;</span> \
                  <span class="s1">&#39;&quot;firstTrackMetadata&quot;: null}}&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">WebsocketMessageRaw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">send_message_raw</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_load_cloud_queue_itemid_str_without_quotes"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_load_cloud_queue_itemid_str_without_quotes">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_cloud_queue_itemid_str_without_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;{&quot;header&quot;: &#39;</span> \
                  <span class="s1">&#39;{&quot;namespace&quot;: &quot;session:1&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;command&quot;: &quot;loadCloudQueue&quot;}, &#39;</span> \
                  <span class="s1">&#39;&quot;body&quot;: &#39;</span> \
                  <span class="s1">&#39;{&quot;sessionId&quot;: &quot;sessionIdDoesNotMatter&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;queueBaseUrl&quot;: &quot;queueBaseUriDoesNotMatter&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;contentType&quot;: &quot;application/x-cloud-queue&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;httpAuthorization&quot;: &quot;playon=12345&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;itemId&quot;: abc, &#39;</span> \
                  <span class="s1">&#39;&quot;positionMillis&quot;: 0, &#39;</span> \
                  <span class="s1">&#39;&quot;playOnCompletion&quot;: true, &#39;</span> \
                  <span class="s1">&#39;&quot;firstTrackMetadata&quot;: null}}&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">WebsocketMessageRaw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">send_message_raw</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_seek"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_seek">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">my_item_id</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">my_position</span> <span class="o">=</span> <span class="mi">1200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                       <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="n">my_position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                      <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">!=</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">!=</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">my_item_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="n">my_position</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_seekRelative"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_seekRelative">[docs]</a>    <span class="k">def</span> <span class="nf">test_seekRelative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-83857</span>
<span class="sd">        Basic test to verify seekRelative functionality.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">negative_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5000</span>
        <span class="n">positive_pos</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seekRelative</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">sessionId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">itemId</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">deltaMillis</span><span class="o">=</span><span class="n">positive_pos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="n">positive_pos</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seekRelative</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">sessionId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">itemId</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">deltaMillis</span><span class="o">=</span><span class="n">negative_pos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="n">positive_pos</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">negative_pos</span><span class="o">*</span><span class="n">y</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_seek_incorrect_itemId"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_seek_incorrect_itemId">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek_incorrect_itemId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">my_item_id</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="n">my_position</span> <span class="o">=</span> <span class="mi">1200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="n">my_position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">INVALID_OBJECT_ID</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_seek_out_of_bounds_paused"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_seek_out_of_bounds_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek_out_of_bounds_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test to verify a seek command longer than the track is successful but</span>
<span class="sd">        only seeks to the end of the track</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">my_item_id</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">my_position</span> <span class="o">=</span> <span class="mi">31000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="n">my_position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                      <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">my_item_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&lt;</span> <span class="n">my_position</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_seek_out_of_bounds"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_seek_out_of_bounds">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek_out_of_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test to verify a seek command longer than the track is successful but</span>
<span class="sd">        doesn&#39;t seek further than the end of the track</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">my_position</span> <span class="o">=</span> <span class="mi">31000</span>
        <span class="n">my_item_id</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">next_item_id</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="n">my_position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                      <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">!=</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">!=</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">next_item_id</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_seek_with_null_session_id"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_seek_with_null_session_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek_with_null_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_skip_to_item_without_track_metadata"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_skip_to_item_without_track_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_to_item_without_track_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">my_item_id</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
        <span class="n">my_position</span> <span class="o">=</span> <span class="mi">1200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">,</span>
                               <span class="n">position_millis</span><span class="o">=</span><span class="n">my_position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">,</span>
                               <span class="n">position_millis</span><span class="o">=</span><span class="n">my_position</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                      <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">!=</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">!=</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">my_item_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="n">my_position</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_skip_to_item"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_skip_to_item">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_to_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">my_item_id</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
        <span class="n">my_position</span> <span class="o">=</span> <span class="mi">1200</span>
        <span class="n">my_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">)</span>

        <span class="c1"># w/ item_id only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="n">my_metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                      <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">my_item_id</span><span class="p">))</span>

        <span class="c1"># w/ position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">,</span>
                               <span class="n">position_millis</span><span class="o">=</span><span class="n">my_position</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="n">my_metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                      <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">my_item_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="n">my_position</span><span class="p">))</span>

        <span class="c1"># w/ position and play-on-completion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="n">my_metadata</span><span class="p">,</span>
                               <span class="n">position_millis</span><span class="o">=</span><span class="n">my_position</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">get_playback_status</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                      <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">!=</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">!=</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">my_item_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="n">my_position</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_verify_paused_after_skipToItem_no_autoplay"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_verify_paused_after_skipToItem_no_autoplay">[docs]</a>    <span class="k">def</span> <span class="nf">test_verify_paused_after_skipToItem_no_autoplay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-60538</span>
<span class="sd">        Verify that the player enters the correct state after a skipToItem command</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;2&quot;</span><span class="p">))</span>

        <span class="c1"># verify player continues playing if loaded again with autoplay true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>

        <span class="c1"># verify player goes to paused with autoplay false</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                        <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;1&quot;</span><span class="p">))</span>

        <span class="c1"># verify player stays playing with no autoplay value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                       <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;1&quot;</span><span class="p">))</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;[{{&quot;namespace&quot;: &quot;playbackSession:1&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;command&quot;: &quot;skipToItem&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;cmdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;sessionId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;householdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;}}, &#39;</span> \
                  <span class="s1">&#39;{{&quot;itemId&quot;: &quot;0&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;positionMillis&quot;: null, &#39;</span> \
                  <span class="s1">&#39;&quot;trackMetadata&quot;: null, &#39;</span> \
                  <span class="s1">&#39;&quot;queueVersion&quot;: null}}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">_get_next_cmd_id</span><span class="p">()),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">WebsocketMessageRaw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">send_message_raw</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>

        <span class="c1"># verify player starts playing with autoplay true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;1&quot;</span><span class="p">))</span>

        <span class="c1"># verify player goes to idle with no autoplay</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;[{{&quot;namespace&quot;: &quot;playbackSession:1&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;command&quot;: &quot;skipToItem&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;cmdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;sessionId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;householdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;}}, &#39;</span> \
                  <span class="s1">&#39;{{&quot;itemId&quot;: &quot;0&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;positionMillis&quot;: null, &#39;</span> \
                  <span class="s1">&#39;&quot;trackMetadata&quot;: null, &#39;</span> \
                  <span class="s1">&#39;&quot;queueVersion&quot;: null}}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">_get_next_cmd_id</span><span class="p">()),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">WebsocketMessageRaw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">send_message_raw</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_skipToItem_current_itemId_no_positionMillis_while_playing"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_skipToItem_current_itemId_no_positionMillis_while_playing">[docs]</a>    <span class="k">def</span> <span class="nf">test_skipToItem_current_itemId_no_positionMillis_while_playing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-56338 skipToItem should not interrupt playback</span>
<span class="sd">        Test that the playback should not be interrupted when a skipToItem command with the current</span>
<span class="sd">        playing item id and no positionMillis parameter is recieved. Before the fix, an &quot;interruption&quot;</span>
<span class="sd">        in this scenario would entail the player starting to play the current track from the start.</span>
<span class="sd">        This test first seeks 15 seconds into the track, sends the skipToItem command, and then checks</span>
<span class="sd">        that the current playhead position is greater than 15 seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Item id to play and then to skip to</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Load cloud queue and begin playing track with item id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Seek 15 seconds into track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Make sure player is playing after the seek</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Send seek to item command with current item id and no positionMillis parameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Make sure player is playing after the skip</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Verify that the current position is greater than 15 seconds after skip to item command</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s1">&#39;RelTime&#39;</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_str</span><span class="p">,</span> <span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">current_position</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="n">current_position</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
                                          <span class="s2">&quot;Current position should be greater than or equal to 15 seconds after skipToItem&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_skipToItem_current_itemId_no_positionMillis_metadata_while_paused"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_skipToItem_current_itemId_no_positionMillis_metadata_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_skipToItem_current_itemId_no_positionMillis_metadata_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-56338 skipToItem should not interrupt playback</span>
<span class="sd">        Test that the playback should resume from paused position when a skipToItem command with</span>
<span class="sd">        the current item id, no positionMillis parameter, track metadata, and play_on_completion=true is recieved.</span>
<span class="sd">        This test loads a cloud queue with a position offset of 15 seconds into the track and play on completion=true</span>
<span class="sd">        and then sends a pause command so the player is initially paused (and not stopped).</span>
<span class="sd">        It then sends the skipToItem command and checks that the current playhead position is greater than or equal to 15 seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Item id to play and then to skip to</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Load cloud queue with position offset of 15 seconds and play on completion as false</span>
        <span class="c1"># This leaves the player in the paused state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Send pause to enter paused state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Send seek to item command with current item id, no positionMillis parameter, track metadata, playOnCompletion</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Make sure player is playing after the skip</span>
        <span class="c1"># Entering the playing state gives us a recent playhead position from the latest UPnP events</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Verify that the current position is greater than 15 seconds after skip to item command</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s1">&#39;RelTime&#39;</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_str</span><span class="p">,</span> <span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">current_position</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="n">current_position</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
                                          <span class="s2">&quot;Current position should be greater than or equal to 15 seconds after skipToItem&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_skipToItem_different_itemId_no_positionMillis_while_playing"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_skipToItem_different_itemId_no_positionMillis_while_playing">[docs]</a>    <span class="k">def</span> <span class="nf">test_skipToItem_different_itemId_no_positionMillis_while_playing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-56338 skipToItem should not interrupt playback</span>
<span class="sd">        Test that the playback should change to beginning of different track when a skipToItem command with</span>
<span class="sd">        a different item id, no positionMillis parameter, and play_on_completion=true is recieved while playing.</span>
<span class="sd">        This test first seeks 15 seconds into the track, pauses, sends the skipToItem command, and then checks</span>
<span class="sd">        that the current playhead position is less than 5 seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Item id to play and then to skip to</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">different_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Load cloud queue with position offset of 15 seconds and play on completion as false</span>
        <span class="c1"># This leaves the player in the paused state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Send seek to item command with different item id, no positionMillis parameter, play on completion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="n">different_id</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Make sure player is playing after the skip</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Verify that the current position is less than 5 seconds after skip to item command</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s1">&#39;RelTime&#39;</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_str</span><span class="p">,</span> <span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">current_position</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyLessOrFailCase</span><span class="p">(</span><span class="n">current_position</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
                                  <span class="s2">&quot;Current position should be less than 5 seconds after skipToItem&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_skipToItem_different_itemId_no_positionMillis_while_paused"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_skipToItem_different_itemId_no_positionMillis_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_skipToItem_different_itemId_no_positionMillis_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-56338 skipToItem should not interrupt playback</span>
<span class="sd">        Test that the playback should change to beginning of different track when a skipToItem command with</span>
<span class="sd">        a different item id, no positionMillis parameter, and play_on_completion=true is recieved while paused.</span>
<span class="sd">        This test loads a cloud queue with a position offset of 15 seconds into the track and play on completion=true</span>
<span class="sd">        and then sends a pause command so that the player is initially paused (and not stopped).</span>
<span class="sd">        It then sends the skipToItem command and checks that the current playhead position is less than 5 seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initial item id and then to skip to</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">different_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Load cloud queue with position offset of 15 seconds and play on completion as false</span>
        <span class="c1"># This leaves the player in the paused state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Send pause to enter paused state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Send seek to item command with different item id, no positionMillis parameter, play on completion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="n">different_id</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Make sure player is playing after the skip</span>
        <span class="c1"># Entering the playing state gives us a recent playhead position from the latest UPnP events</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Verify that the current position is less than 5 seconds after skip to item command</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s1">&#39;RelTime&#39;</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_str</span><span class="p">,</span> <span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">current_position</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyLessOrFailCase</span><span class="p">(</span><span class="n">current_position</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
                                  <span class="s2">&quot;Current position should be less than 5 seconds after skipToItem&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_skip_to_item_with_null_session_id"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_skip_to_item_with_null_session_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_to_item_with_null_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">my_item_id</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
        <span class="n">my_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="n">my_metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_skip_to_item_window_playhead"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_skip_to_item_window_playhead">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_to_item_window_playhead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-88086: verify that the player uses the window playhead when processing itemWindow</span>
<span class="sd">                     response from skipToItem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_window_playhead</span><span class="p">({</span><span class="s2">&quot;itemId&quot;</span><span class="p">:</span><span class="s2">&quot;2&quot;</span><span class="p">})</span>
        <span class="n">my_item_id</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="n">my_item_id</span><span class="p">)</span>

        <span class="c1"># Verify that the player skipped to the itemId (2) found in the window playhead.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s2">&quot;2&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_refresh_cloud_queue"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_refresh_cloud_queue">[docs]</a>    <span class="k">def</span> <span class="nf">test_refresh_cloud_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">has_testpoint_support</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Test needs testpoint access&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_cloudqueue_poll_timers</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span>
                                                   <span class="n">playing_timer</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
                                                   <span class="n">paused_timer</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                      <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span><span class="p">,</span>
                                                                  <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
                                          <span class="s2">&quot;Expect at least 2 itemWindow requests&quot;</span><span class="p">)</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/version&#39;</span><span class="p">,</span>
                                                                  <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Expect at least 1 version request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>

        <span class="c1"># Added for SWPBL-82900</span>
        <span class="c1"># A second createSession should not trigger additional itemWindow/version requests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># SWPBL-108159 might have enabled a final version request when the eviction occurs but</span>
        <span class="c1"># that request should have updateToken in the queryParam</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">((</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">or</span>
                                                                   <span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/version&#39;</span><span class="p">)</span> <span class="ow">and</span>
                                                                  <span class="s1">&#39;updateToken&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;queryParams&#39;</span><span class="p">]),</span>
                                                    <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span>
                                   <span class="s2">&quot;No requests without queryParam should have been made&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_refresh_cloud_queue_with_null_session_id"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_refresh_cloud_queue_with_null_session_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_refresh_cloud_queue_with_null_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_session_creation_trio_null_appid_and_context"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_session_creation_trio_null_appid_and_context">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">app_id_and_context_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_session_creation_trio_null_appid_and_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">app_context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the joinOrCreateSession trio of commands (joinOrCreateSession, createSession, joinSession) return</span>
<span class="sd">        ERROR_MISSING_PARAMETER when appId or appContext is sent as NULL.</span>
<span class="sd">        Test skips in the case that both appId and appContext are not NULL when passed from the generator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># skip test if neither appId or appContext are None, verifications are not expecting success</span>
        <span class="k">if</span> <span class="n">app_id</span> <span class="ow">and</span> <span class="n">app_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Negative test will fail when run with both appId and appContext filled in&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_or_create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">app_id</span><span class="o">=</span><span class="n">app_id</span><span class="p">,</span>
                                         <span class="n">app_context</span><span class="o">=</span><span class="n">app_context</span><span class="p">,</span>
                                         <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="n">app_id</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="n">app_context</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">app_id</span><span class="o">=</span><span class="n">app_id</span><span class="p">,</span>
                               <span class="n">app_context</span><span class="o">=</span><span class="n">app_context</span><span class="p">,</span>
                               <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_playbackSession_command_null_preconditions"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_playbackSession_command_null_preconditions">[docs]</a>    <span class="k">def</span> <span class="nf">test_playbackSession_command_null_preconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Covers SWPBL-49484</span>
<span class="sd">        Verify that the player accepts &#39;null&#39; value for the &#39;conditions&#39; field</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                   <span class="n">first_track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_autoplay_metadata_bool_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cq_helper</span><span class="o">.</span><span class="n">fake_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">autoplay</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cq_helper</span><span class="o">.</span><span class="n">fake_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">autoplay</span><span class="p">,</span> <span class="n">metadata</span>

<div class="viewcode-block" id="MuseSessionTests.test_playbackSession_command_valid_preconditions"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_playbackSession_command_valid_preconditions">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s1">&#39;_autoplay_metadata_bool_generator&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_playbackSession_command_valid_preconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">autoplay</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Covers SWPBL-49484</span>
<span class="sd">        Verify that the player will successfully process the command if the preconditions</span>
<span class="sd">        are valid and correct with play_on_completion/metadata enabled/disabled.</span>
<span class="sd">        :param autoplay:</span>
<span class="sd">        :param metadata:</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">queueVersion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="n">autoplay</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                               <span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">:</span> <span class="n">queueVersion</span><span class="p">,</span>
                                           <span class="s2">&quot;playing&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                           <span class="s2">&quot;itemId&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_playbackSession_command_invalid_preconditions"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_playbackSession_command_invalid_preconditions">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s1">&#39;_autoplay_metadata_bool_generator&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_playbackSession_command_invalid_preconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">autoplay</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Covers SWPBL-49484</span>
<span class="sd">        Verify that the player will event the proper error message process if the precondition check</span>
<span class="sd">        fails with play_on_completion/metadata enabled/disabled.</span>
<span class="sd">        :param autoplay:</span>
<span class="sd">        :param metadata:</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="n">autoplay</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                               <span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;BAD&quot;</span><span class="p">,</span>
                                           <span class="s2">&quot;playing&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                           <span class="s2">&quot;itemId&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">})</span>
        <span class="c1"># Added additional verifications for SWPBL-74531</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">sessionConditionCheckErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_PRECONDITION_CHECK_FAILED&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">currentValues</span><span class="p">[</span><span class="s2">&quot;playing&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">currentValues</span><span class="p">[</span><span class="s2">&quot;itemId&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">expect_event</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="c1"># Covers SWPBL-60053</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_playbackSession_command_unsupported_precondition"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_playbackSession_command_unsupported_precondition">[docs]</a>    <span class="k">def</span> <span class="nf">test_playbackSession_command_unsupported_precondition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Covers SWPBL-49484</span>
<span class="sd">        Verify that the player will event the ignore unsupported preconditions</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;BAD1&quot;</span><span class="p">:</span> <span class="s2">&quot;BAD2&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_generate_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precondition</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate appropriate precondition values for the</span>
<span class="sd">        &#39;test_playbackSession_command_individual_precondition_check&#39; test case</span>
<span class="sd">        :param precondition:</span>
<span class="sd">        :param value:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;queueVersion&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="s2">&quot;BAD&quot;</span><span class="p">,</span>
            <span class="s1">&#39;itemId&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span>
            <span class="s1">&#39;playing&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="p">}[</span><span class="n">precondition</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="MuseSessionTests.test_playbackSession_command_individual_precondition_check"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_playbackSession_command_individual_precondition_check">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">valid_preconditions_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_playbackSession_command_individual_precondition_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precondition</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Covers SWPBL-49484</span>
<span class="sd">        Verify that each individual precondition is checked for accuracy and that the</span>
<span class="sd">        right error message is event if the precondition fails</span>
<span class="sd">        :param precondition:</span>
<span class="sd">        :param value:</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                       <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                       <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                       <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                               <span class="n">position_millis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="n">precondition</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_value</span><span class="p">(</span><span class="n">precondition</span><span class="p">,</span>
                                                                              <span class="kc">True</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="n">precondition</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_value</span><span class="p">(</span><span class="n">precondition</span><span class="p">,</span>
                                                                              <span class="kc">False</span><span class="p">)})</span>
        <span class="c1"># Added additional verifications for SWPBL-74531</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">sessionConditionCheckErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_PRECONDITION_CHECK_FAILED&quot;</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="n">precondition</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">currentValues</span><span class="p">[</span><span class="s2">&quot;playing&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">currentValues</span><span class="p">[</span><span class="s2">&quot;itemId&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                                  <span class="s2">&quot;Player should be playing&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_playbackSession_command_precondition_evaluation_order"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_playbackSession_command_precondition_evaluation_order">[docs]</a>    <span class="k">def</span> <span class="nf">test_playbackSession_command_precondition_evaluation_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Covers SWPBL-49484</span>
<span class="sd">        Verify that the player will verify command for all the right objects before</span>
<span class="sd">        doing the precondition check</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>
        <span class="c1"># Using another load command here since skip_to_item does async error processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;playing&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_MISSING_PARAMETERS&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_evented_app_id_string"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_evented_app_id_string">[docs]</a>    <span class="k">def</span> <span class="nf">test_evented_app_id_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-55180 Sonos CR can identify the app that created the playback session</span>
<span class="sd">        This tests checks that DirectControlClientId included in an UPnP event is the expected value</span>
<span class="sd">        before createSession is called, after createSession and loadCloudQueue, and after</span>
<span class="sd">        calling leaveSession.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get direct control client id at beginning of test (should be empty)</span>
        <span class="n">dcc_id_str0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">get_state_variable</span><span class="p">(</span><span class="s2">&quot;DirectControlClientID&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">dcc_id_str0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                   <span class="s2">&quot;DirectControlClientId should be empty before creating session&quot;</span><span class="p">)</span>

        <span class="c1"># Create session with unique app id</span>
        <span class="n">my_app_id</span> <span class="o">=</span> <span class="s1">&#39;my_app_id&#39;</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="n">my_app_id</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>

        <span class="c1"># Load cloud queue with playOnCompletion = true and wait until we are playing</span>
        <span class="n">my_item_id</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">my_position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Wait for direct control client id to change</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">get_state_variable</span><span class="p">(</span><span class="s2">&quot;DirectControlClientID&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dcc_id_str0</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Get direct control client id that is parsed from UPnP event once we are playing</span>
        <span class="c1"># (should be the app id sent during create_session)</span>
        <span class="n">dcc_id_str1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">get_state_variable</span><span class="p">(</span><span class="s2">&quot;DirectControlClientID&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">dcc_id_str1</span><span class="p">,</span> <span class="n">my_app_id</span><span class="p">,</span>
                <span class="s2">&quot;DirectControlClientId must match app id sent in createSession after playback begins&quot;</span><span class="p">)</span>

        <span class="c1"># Leave session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">leave_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,)</span>

        <span class="c1"># Wait for direct control client id to change</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">get_state_variable</span><span class="p">(</span><span class="s2">&quot;DirectControlClientID&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dcc_id_str1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Get direct control client id that is parsed from UPnP event after leaving the session</span>
        <span class="n">dcc_id_str2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">get_state_variable</span><span class="p">(</span><span class="s2">&quot;DirectControlClientID&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">dcc_id_str2</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                   <span class="s2">&quot;DirectControlClientId should be empty after leaving session&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_rejoin_session"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_rejoin_session">[docs]</a>    <span class="k">def</span> <span class="nf">test_rejoin_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-57485</span>
<span class="sd">        Verify that using &quot;rejoinSession&quot; will allow lechmere to rejoing a session with only</span>
<span class="sd">        the sessionId</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds do not have rejoinSession avaliable for LAN use&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span>
                                                    <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>
        <span class="n">muse2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">muse2</span><span class="o">.</span><span class="n">rejoin_session</span><span class="p">(</span><span class="n">hhId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                             <span class="n">sessionId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">muse2</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_rejoin_session_delegation_bad_sessionId"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_rejoin_session_delegation_bad_sessionId">[docs]</a>    <span class="k">def</span> <span class="nf">test_rejoin_session_delegation_bad_sessionId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-57485</span>
<span class="sd">        Verify that a bad sessionId will result in an error</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds do not have rejoinSession avaliable for LAN use&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span>
                                                    <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>
        <span class="n">muse2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">muse2</span><span class="o">.</span><span class="n">rejoin_session</span><span class="p">(</span><span class="n">hhId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                             <span class="n">sessionId</span><span class="o">=</span><span class="s2">&quot;bad_sessionId&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">muse2</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_INVALID_OBJECT_ID&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_locked_rejoin_session_fail_locked_builds"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_locked_rejoin_session_fail_locked_builds">[docs]</a>    <span class="k">def</span> <span class="nf">test_locked_rejoin_session_fail_locked_builds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the rejoinSession command results in an error in locked builds</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;unlocked builds have rejoinSession avaliable for LAN use&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span>
                                                    <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>
        <span class="n">muse2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">muse2</span><span class="o">.</span><span class="n">rejoin_session</span><span class="p">(</span><span class="n">hhId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                             <span class="n">sessionId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">muse2</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_UNSUPPORTED_COMMAND&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_load_skip_track_with_no_contentType"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_load_skip_track_with_no_contentType">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_skip_track_with_no_contentType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-64420</span>
<span class="sd">        Verify that the player behaves normally when you load or skip to a track with no contentType</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_custom_track_to_end</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;test_track</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span>
                                                                  <span class="n">mediaUrl</span><span class="o">=</span><span class="s1">&#39;/track/data/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_itemwindow_endpoint</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;3&#39;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">past_events</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">expect_event</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_SESSION_EVICTED&quot;</span><span class="p">))</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_private_queueID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="s2">&quot;QueueId&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)[</span><span class="s1">&#39;NumberReturned&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;5&quot;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">past_events</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">expect_event</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_SESSION_EVICTED&quot;</span><span class="p">))</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="s2">&quot;QueueId&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)[</span><span class="s1">&#39;NumberReturned&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item_with_window</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                           <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;4&quot;</span><span class="p">,</span>
                                           <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
                                           <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionErrorEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">past_events</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">expect_event</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_SESSION_EVICTED&quot;</span><span class="p">))</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="s2">&quot;QueueId&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)[</span><span class="s1">&#39;NumberReturned&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_load_skip_at_nonzero_position_is_allowed"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_load_skip_at_nonzero_position_is_allowed">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_skip_at_nonzero_position_is_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-85242</span>
<span class="sd">        Verify that we can skip and load track at non-zero positionMillis if the canSeek policy</span>
<span class="sd">        is disabled on the server</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_itemwindow_endpoint</span><span class="p">(</span><span class="n">itemid</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Disable seeking on the server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_playback_policy</span><span class="p">({</span><span class="s2">&quot;canSeek&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

        <span class="c1"># Load at a non-zero start point and verify we start playing there</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">10000</span><span class="p">))</span>

        <span class="c1"># Skip to a different track at a different position and verify we play the right track/position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item_with_window</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                           <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                                           <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
                                           <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">position_millis</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">20000</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_multiple_create_sessions"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_multiple_create_sessions">[docs]</a>    <span class="k">def</span> <span class="nf">test_multiple_create_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-65515</span>
<span class="sd">        Creating a session after a previous create_session should be processed in a timely manner</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load and play this specific tunein radio station that is known to cause issues before the fix</span>
        <span class="n">HLS_RADIO</span> <span class="o">=</span> <span class="s2">&quot;x-sonosapi-stream:s27533?sid=254&amp;flags=8224&amp;sn=0&quot;</span>
        <span class="n">md</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;DIDL-Lite xmlns:dc=</span><span class="se">\&quot;</span><span class="s2">http://purl.org/dc/elements/1.1/</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
                           <span class="s2">&quot;xmlns:upnp=</span><span class="se">\&quot;</span><span class="s2">urn:schemas-upnp-org:metadata-1-0/upnp/</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
                           <span class="s2">&quot;xmlns:r=</span><span class="se">\&quot;</span><span class="s2">urn:schemas-rinconnetworks-com:metadata-1-0/</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
                           <span class="s2">&quot;xmlns=</span><span class="se">\&quot;</span><span class="s2">urn:schemas-upnp-org:metadata-1-0/DIDL-Lite/</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
                           <span class="s2">&quot;&lt;item id=</span><span class="se">\&quot;</span><span class="s2">-1</span><span class="se">\&quot;</span><span class="s2"> parentID=</span><span class="se">\&quot;</span><span class="s2">-1</span><span class="se">\&quot;</span><span class="s2"> restricted=</span><span class="se">\&quot;</span><span class="s2">true</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
                           <span class="s2">&quot;&lt;dc:title&gt;98.5 The Sports Hub&lt;/dc:title&gt;&lt;upnp:class&gt;object.item.audioItem.audioBroadcast&quot;</span>
                           <span class="s2">&quot;&lt;/upnp:class&gt;&lt;desc id=</span><span class="se">\&quot;</span><span class="s2">cdudn</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
                           <span class="s2">&quot;nameSpace=</span><span class="se">\&quot;</span><span class="s2">urn:schemas-rinconnetworks-com:metadata-1-0/</span><span class="se">\&quot;</span><span class="s2">&gt;SA_RINCON65031_&quot;</span>
                           <span class="s2">&quot;&lt;/desc&gt;&lt;/item&gt;&lt;/DIDL-Lite&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetAVTransportURI</span><span class="p">(</span><span class="n">HLS_RADIO</span><span class="p">,</span> <span class="n">md</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="c1"># Create a muse session and play a cloudqueue track so that the AVt changes from the tunein station</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">((</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span>
                                                    <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>

        <span class="c1"># Use a raw second create command so the test isn&#39;t locked waiting for the success response message</span>
        <span class="c1"># We want to know if the player is taking too long to respond.</span>
        <span class="c1"># Remove once 65641 is done.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;[{&quot;namespace&quot;: &quot;playbackSession:1&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;command&quot;: &quot;createSession&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;cmdId&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">_get_next_cmd_id</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;groupId&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;householdId&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;&quot;}, &#39;</span> \
                  <span class="s1">&#39;{&quot;appId&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;appContext&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;customData&quot;: &quot;None&quot;}]&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">WebsocketMessageRaw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">send_message_raw</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">((</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span>
                                                    <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">)))</span>

        <span class="c1"># Play another station that doesn&#39;t take as long to load so it doesn&#39;t mess up downstream tests</span>
        <span class="n">HLS_RADIO</span> <span class="o">=</span> <span class="s2">&quot;x-sonosapi-stream:s24062?sid=254&amp;flags=8224&amp;sn=0&quot;</span>
        <span class="n">md</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;DIDL-Lite xmlns:dc=</span><span class="se">\&quot;</span><span class="s2">http://purl.org/dc/elements/1.1/</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
                           <span class="s2">&quot;xmlns:upnp=</span><span class="se">\&quot;</span><span class="s2">urn:schemas-upnp-org:metadata-1-0/upnp/</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
                           <span class="s2">&quot;xmlns:r=</span><span class="se">\&quot;</span><span class="s2">urn:schemas-rinconnetworks-com:metadata-1-0/</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
                           <span class="s2">&quot;xmlns=</span><span class="se">\&quot;</span><span class="s2">urn:schemas-upnp-org:metadata-1-0/DIDL-Lite/</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
                           <span class="s2">&quot;&lt;item id=</span><span class="se">\&quot;</span><span class="s2">-1</span><span class="se">\&quot;</span><span class="s2"> parentID=</span><span class="se">\&quot;</span><span class="s2">-1</span><span class="se">\&quot;</span><span class="s2"> restricted=</span><span class="se">\&quot;</span><span class="s2">true</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
                           <span class="s2">&quot;&lt;dc:title&gt;92.5 the River&lt;/dc:title&gt;&lt;upnp:class&gt;object.item.audioItem.audioBroadcast&quot;</span>
                           <span class="s2">&quot;&lt;/upnp:class&gt;&lt;desc id=</span><span class="se">\&quot;</span><span class="s2">cdudn</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
                           <span class="s2">&quot;nameSpace=</span><span class="se">\&quot;</span><span class="s2">urn:schemas-rinconnetworks-com:metadata-1-0/</span><span class="se">\&quot;</span><span class="s2">&gt;SA_RINCON65031_&quot;</span>
                           <span class="s2">&quot;&lt;/desc&gt;&lt;/item&gt;&lt;/DIDL-Lite&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetAVTransportURI</span><span class="p">(</span><span class="n">HLS_RADIO</span><span class="p">,</span> <span class="n">md</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_sessionId_does_not_duplicate_after_reset"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_sessionId_does_not_duplicate_after_reset">[docs]</a>    <span class="k">def</span> <span class="nf">test_sessionId_does_not_duplicate_after_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-65752</span>
<span class="sd">        Verifies that the player will generate a random sessionId when a new session is created</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">))</span>
        <span class="n">old_session_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span>

        <span class="c1"># Verify that the sessionId does not dup after a second createSession</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                     <span class="n">e</span><span class="o">.</span><span class="n">session_id</span> <span class="o">!=</span> <span class="n">old_session_id1</span><span class="p">))</span>
        <span class="n">old_session_id2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span>

        <span class="c1"># Verify that the sessionId still does not dupe after bouncing anacapa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span>
                                                     <span class="n">e</span><span class="o">.</span><span class="n">session_id</span> <span class="o">!=</span> <span class="n">old_session_id2</span> <span class="ow">and</span>
                                                     <span class="n">e</span><span class="o">.</span><span class="n">session_id</span> <span class="o">!=</span> <span class="n">old_session_id1</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_pause_resume_track_with_no_durationMillis"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_pause_resume_track_with_no_durationMillis">[docs]</a>    <span class="k">def</span> <span class="nf">test_pause_resume_track_with_no_durationMillis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-63057</span>
<span class="sd">        Verify that the player pauses and resumes on the correct track if it doesn&#39;t have durationMillis</span>
<span class="sd">        Verify that pause at end of queue is working correctly if the last track doesn&#39;t have durationMillis</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Add a track at the end that doesn&#39;t have durationMillis in the metadata</span>
        <span class="n">md</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;durationMillis&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;test_track&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_custom_track_to_end</span><span class="p">(</span><span class="n">md</span><span class="o">=</span><span class="n">md</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;3&#39;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">27000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                        <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_play_track_with_no_positionMillis_bad_mediauri"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_play_track_with_no_positionMillis_bad_mediauri">[docs]</a>    <span class="k">def</span> <span class="nf">test_play_track_with_no_positionMillis_bad_mediauri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-63057</span>
<span class="sd">        Verify that the player will go to the beginning of the queue if the last track doesn&#39;t have</span>
<span class="sd">        positionMillis and a bad mediaUrl</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Add a track at the end that doesn&#39;t have durationMillis in the metadata</span>
        <span class="n">md</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;durationMillis&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;test_track&quot;</span>
        <span class="n">md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;mediaUrl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bad_url&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_custom_track_to_end</span><span class="p">(</span><span class="n">md</span><span class="o">=</span><span class="n">md</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">27000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_pause_at_end_on_track_with_no_durationMillis"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_pause_at_end_on_track_with_no_durationMillis">[docs]</a>    <span class="nd">@skip</span><span class="p">(</span><span class="s2">&quot;SWPBL-78261&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_pause_at_end_on_track_with_no_durationMillis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-63057</span>
<span class="sd">        Verify that the player pauses at end of queue on the correct track is the last track is deleted</span>
<span class="sd">        and the new last track doesn&#39;t have durationMillis</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Add a track at the end that doesn&#39;t have durationMillis in the metadata</span>
        <span class="n">md</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;durationMillis&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;test_track&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_custom_track_to_end</span><span class="p">(</span><span class="n">md</span><span class="o">=</span><span class="n">md</span><span class="p">)</span>
        <span class="c1"># self.cq_control.delete_track(&quot;0&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;4&#39;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">27000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="s2">&quot;4&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_bad_command_valid_sessionId"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_bad_command_valid_sessionId">[docs]</a>    <span class="k">def</span> <span class="nf">test_bad_command_valid_sessionId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-64254</span>
<span class="sd">        The player should event out a &quot;ERROR_UNSUPPORTED_COMMAND&quot; error if an unsupported command is sent</span>
<span class="sd">        with a valid sessionID/householdId</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">((</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span>
                                                    <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">)))</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;[{{&quot;namespace&quot;: &quot;playbackSession:1&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;command&quot;: &quot;badCommand&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;cmdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;sessionId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;householdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;}}, &#39;</span> \
                  <span class="s1">&#39;{{}}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">_get_next_cmd_id</span><span class="p">()),</span>
                                 <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">),</span>
                                 <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">WebsocketMessageRaw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">send_message_raw</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">UNSUPPORTED_CMD</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_loadCloudQueue_no_itemid"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_loadCloudQueue_no_itemid">[docs]</a>    <span class="k">def</span> <span class="nf">test_loadCloudQueue_no_itemid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-58874</span>
<span class="sd">        The player should event a missing params error if the loadCloudqueue command has</span>
<span class="sd">        first track metadata but no valid itemId.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">MISSING_PARAM</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_internal_player_queue_cleared_after_server_queue_cleared"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_internal_player_queue_cleared_after_server_queue_cleared">[docs]</a>    <span class="k">def</span> <span class="nf">test_internal_player_queue_cleared_after_server_queue_cleared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-70055</span>
<span class="sd">        Verify that the private queue is cleared after the queue on the server is clear</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                             <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                         <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">item_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">position_millis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="c1"># Clear the queue on the server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_queue</span><span class="p">()</span>

        <span class="c1"># Force an /itemWindow request and clear the api log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>

        <span class="c1"># Wait until the request occurs</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span><span class="p">,</span>
                                                                          <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                   <span class="s2">&quot;Player should have made at least one /itemWindow request&quot;</span><span class="p">)</span>

        <span class="c1"># Verify that the player behaves as expected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="kc">None</span><span class="p">))</span>

        <span class="c1"># Verify that the queue is cleared</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_private_queueID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="s2">&quot;QueueId&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)[</span><span class="s1">&#39;NumberReturned&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_playback_event_and_error_after_404_with_autoplay"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_playback_event_and_error_after_404_with_autoplay">[docs]</a>    <span class="k">def</span> <span class="nf">test_playback_event_and_error_after_404_with_autoplay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-70689</span>
<span class="sd">        If playOnCompletion is true, the player should attempt to play and then send an error</span>
<span class="sd">        if playback fails. verify that the proper playback status and error event are sent after</span>
<span class="sd">        loading on an invalid itemId.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                             <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Provide a positionMillis value to trigger the fixed bug</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;[{{&quot;namespace&quot;: &quot;playbackSession:1&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;command&quot;: &quot;loadCloudQueue&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;cmdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;sessionId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;householdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;}}, &#39;</span> \
                  <span class="s1">&#39;{{&quot;queueBaseUrl&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;contentType&quot;: &quot;application/x-cloud-queue&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;httpAuthorization&quot;: &quot;playon=12345&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;itemId&quot;: 99, &#39;</span> \
                  <span class="s1">&#39;&quot;trackMetadata&quot;: null, &#39;</span> \
                  <span class="s1">&#39;&quot;positionMillis&quot;: 1000, &#39;</span> \
                  <span class="s1">&#39;&quot;playOnCompletion&quot;: true, &#39;</span> \
                  <span class="s1">&#39;&quot;queueVersion&quot;: null}}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">_get_next_cmd_id</span><span class="p">()),</span>
                                                   <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">),</span>
                                                   <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">),</span>
                                                   <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">WebsocketMessageRaw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">send_message_raw</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Verify that when playback fails, an error event is sent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">past_events</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_PLAYBACK_NO_CONTENT&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_previous_data_not_lost_after_queue_is_cleared"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_previous_data_not_lost_after_queue_is_cleared">[docs]</a>    <span class="k">def</span> <span class="nf">test_previous_data_not_lost_after_queue_is_cleared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-73370</span>
<span class="sd">        Verify that the previous position and itemId is not lost if the queue is cleared</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                             <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                        <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">))</span>

        <span class="c1"># Delete all the tracks on the server playlist</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="p">))</span>

        <span class="c1"># Refresh to request a new itemWindow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                      <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="c1"># The last playback status event should have something in the previous position</span>
        <span class="c1"># and itemid fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">previousPositionMillis</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">previousItemId</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_no_negative_value_previousPositionMillis"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_no_negative_value_previousPositionMillis">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_negative_value_previousPositionMillis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-79063</span>
<span class="sd">        Verify that if there&#39;s nothing to play, the playback status does not report a negative</span>
<span class="sd">        value for previousPositionMillis</span>
<span class="sd">        </span>
<span class="sd">        This test might need to be adjusted/deleted after SWPBL-79050</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start playing first to make sure we get an idle event after clearing the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                             <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">))</span>

        <span class="c1"># skip the test if the previous playback status event does not have a previousPositionMillis</span>
        <span class="c1"># value</span>
        <span class="n">previousPositionMillis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">previousPositionMillis</span>
        <span class="k">if</span> <span class="n">previousPositionMillis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="n">previousPositionMillis</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="s2">&quot;If present, previousPositionMillis should never be negative&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;No previousPositionMillis value was found in the playback status event&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionTests.test_delayed_media_does_not_delay_loadCloudqueue_response"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionTests.test_delayed_media_does_not_delay_loadCloudqueue_response">[docs]</a>    <span class="k">def</span> <span class="nf">test_delayed_media_does_not_delay_loadCloudqueue_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-84368</span>
<span class="sd">        Verify that if the server is slow to stream the media to the player, it does not also delay</span>
<span class="sd">        the response to the loadCloudqueue command</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Restart the server with a media delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">mediaDelay</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

        <span class="c1"># load the cloudqueue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                             <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># verify that a success response is received within a couple seconds of the command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;loadCloudQueue&quot;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="GroupMovedResponseTests"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests">[docs]</a><span class="k">class</span> <span class="nc">GroupMovedResponseTests</span><span class="p">(</span><span class="n">BaseMuseFixture</span><span class="p">):</span>
<div class="viewcode-block" id="GroupMovedResponseTests.setUpFixture"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GroupMovedResponseTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc</span> <span class="o">=</span> <span class="n">ifilter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">device</span><span class="p">:</span> <span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()</span>
                                          <span class="ow">and</span> <span class="ow">not</span> <span class="n">device</span><span class="o">.</span><span class="n">is_bonded</span><span class="p">()</span>
                                          <span class="ow">and</span> <span class="n">device</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_debug_module_levels</span><span class="p">(</span><span class="n">module_levels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                                     <span class="s2">&quot;gm_impl&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                                     <span class="s2">&quot;upnpeventing&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                                      <span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_debug_module_levels</span><span class="p">(</span><span class="n">module_levels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                                     <span class="s2">&quot;gm_impl&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                                     <span class="s2">&quot;upnpeventing&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                                      <span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_all</span><span class="p">()</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.tearDownFixture"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GroupMovedResponseTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_debug_module_levels</span><span class="p">(</span><span class="n">module_levels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                                     <span class="s2">&quot;gm_impl&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                                     <span class="s2">&quot;upnpeventing&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                                      <span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_debug_module_levels</span><span class="p">(</span><span class="n">module_levels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                                     <span class="s2">&quot;gm_impl&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                                     <span class="s2">&quot;upnpeventing&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                                      <span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span></div>

    <span class="c1"># Before every test force a GROUP_MOVED event so that we can verify if all subsequent</span>
    <span class="c1"># playbackSession:commands (except for unsubscribe) send GROUP_MOVED responses.</span>
<div class="viewcode-block" id="GroupMovedResponseTests.setUpTest"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GroupMovedResponseTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="c1"># cleanup previous sessions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">clear_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                                              <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                              <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                              <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># playbackSession::createSession on self.zp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span>
                                 <span class="n">custom_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionStatusEvent</span><span class="p">,</span>
                          <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">((</span><span class="n">e</span><span class="o">.</span><span class="n">session_created</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
                                                    <span class="ow">and</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">session_state</span> <span class="o">==</span> <span class="n">SessionState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">)))</span>

        <span class="c1"># playbackSession::subscribe to self.zp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                    <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">householdId</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span>
                                                    <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sessionId</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">))</span>

        <span class="c1"># cache the current GID for later use</span>
        <span class="c1"># TODO: This needs to be revisited in SWPBL-54915</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached_gid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gid</span>

        <span class="c1"># cache the current sessionId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessionId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span>
        <span class="c1"># Add self.gc to self.zp&#39;s group (generates a group updated event)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">UPDATED</span><span class="p">))</span>

        <span class="c1"># Drop self.zp from the group (generates a group moved event)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">MOVED</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.tearDownTest"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GroupMovedResponseTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.test_rejoin_session_delegation"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.test_rejoin_session_delegation">[docs]</a>    <span class="k">def</span> <span class="nf">test_rejoin_session_delegation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-57485</span>
<span class="sd">        Verify that using &quot;rejoinSession&quot; will allow lechmere to rejoing a session with only</span>
<span class="sd">        the sessionId</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds do not have rejoinSession avaliable for LAN use&#39;</span><span class="p">)</span>

        <span class="n">muse2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="p">)</span>
        <span class="n">muse2</span><span class="o">.</span><span class="n">rejoin_session</span><span class="p">(</span><span class="n">hhId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                             <span class="n">sessionId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sessionId</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">muse2</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.test_rejoin_session_delegation_bad_sessionId"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.test_rejoin_session_delegation_bad_sessionId">[docs]</a>    <span class="k">def</span> <span class="nf">test_rejoin_session_delegation_bad_sessionId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-57485</span>
<span class="sd">        Verify that a bad sessionId will result in an error</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds do not have rejoinSession avaliable for LAN use&#39;</span><span class="p">)</span>

        <span class="n">muse2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="p">)</span>
        <span class="n">muse2</span><span class="o">.</span><span class="n">rejoin_session</span><span class="p">(</span><span class="n">hhId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                             <span class="n">sessionId</span><span class="o">=</span><span class="s2">&quot;bad_sessionId&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">muse2</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_INVALID_OBJECT_ID&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.test_subscribe"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.test_subscribe">[docs]</a>    <span class="k">def</span> <span class="nf">test_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                    <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">MOVED</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.test_join_or_create_session"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.test_join_or_create_session">[docs]</a>    <span class="k">def</span> <span class="nf">test_join_or_create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_or_create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cached_gid</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                         <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">MOVED</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.test_create_session"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.test_create_session">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cached_gid</span><span class="p">,</span>
                                 <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                 <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">MOVED</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.test_join_session"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.test_join_session">[docs]</a>    <span class="k">def</span> <span class="nf">test_join_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">join_session</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cached_gid</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                               <span class="n">app_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">MOVED</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.test_leave_session"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.test_leave_session">[docs]</a>    <span class="k">def</span> <span class="nf">test_leave_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">leave_session</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">MOVED</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.test_load_cloud_queue"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.test_load_cloud_queue">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_cloud_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cq_server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">start_cloudqueue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">MOVED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">stop_cloudqueue_server</span><span class="p">(</span><span class="n">cq_server</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.test_refresh_cloud_queue"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.test_refresh_cloud_queue">[docs]</a>    <span class="k">def</span> <span class="nf">test_refresh_cloud_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                      <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">MOVED</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.test_skip_to_item"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.test_skip_to_item">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_to_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">MOVED</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.test_seek"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.test_seek">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                       <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">MOVED</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupMovedResponseTests.test_unsubscribe"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.GroupMovedResponseTests.test_unsubscribe">[docs]</a>    <span class="k">def</span> <span class="nf">test_unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test unsubscribe to playback session on after gc moved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Session already created on zp, subscribed to, and GC has been moved</span>

        <span class="c1"># Send playback session unsubscribe command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">unsubscribe_session</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>

        <span class="c1"># Verify the error is global error with code INVALID_OBJECT_ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">INVALID_OBJECT_ID</span><span class="p">)</span>

        <span class="c1"># Manually update session_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="MuseSessionWindowTests"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests">[docs]</a><span class="k">class</span> <span class="nc">MuseSessionWindowTests</span><span class="p">(</span><span class="n">BaseMuseFixture</span><span class="p">):</span>
    <span class="c1"># Covers SWBPL-61328</span>
<div class="viewcode-block" id="MuseSessionWindowTests.setUpFixture"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseSessionWindowTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="c1"># mock SMAPI server setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smapi_port</span> <span class="o">=</span> <span class="mi">3200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="mi">240</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_type</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">get_account_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">start_node_smapi_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                       <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                       <span class="n">server_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smapi_port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
            <span class="s2">&quot;Successfully added SMAPI account?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_account_id</span> <span class="o">=</span> <span class="s1">&#39;sn_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">get_service_account</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">account_type</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">serial_number</span><span class="p">)</span>
        <span class="c1"># Start CQ server and get the initial itemWindow from the CQ server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_smapi_track_to_end</span><span class="p">(</span><span class="n">track</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">smapi_ctl</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                             <span class="n">accountId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse_account_id</span><span class="p">,</span>
                                                             <span class="n">serviceId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_itemwindow_endpoint</span><span class="p">(</span><span class="n">itemid</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_itemwindow_endpoint</span><span class="p">(</span><span class="n">itemid</span><span class="o">=</span><span class="mi">23</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.tearDownFixture"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseSessionWindowTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span>
        <span class="c1"># Remove the mock SMAPI service and account</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrWarn</span><span class="p">(</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_teardown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                              <span class="s2">&quot;Removed account for mock SMAPI server&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.setUpTest"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseSessionWindowTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_cq</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.tearDownTest"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseSessionWindowTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_cq</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.setup_cq"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.setup_cq">[docs]</a>    <span class="k">def</span> <span class="nf">setup_cq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for performing common options to setup the CQ server.</span>

<span class="sd">        :param dict kwargs: Keyword arguments for start_cloud_queue_server. If</span>
<span class="sd">            cq_port is not specified, it will be increased by one each time the server</span>
<span class="sd">            is restarted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">scaMode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_smapi_track_to_end</span><span class="p">(</span><span class="n">track</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">smapi_ctl</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                             <span class="n">accountId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse_account_id</span><span class="p">,</span>
                                                             <span class="n">serviceId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                             <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">SessionInfoEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">suspended</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Subscribe to playback and mute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.cleanup_cq"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.cleanup_cq">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_cq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for performing common options to cleanup the CQ server</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_cloudqueue_poll_timers</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span>
                                                                 <span class="n">playing_timer</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
                                                                 <span class="n">paused_timer</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_metadata_emitted_on_skip_to_item_with_window_changed"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_metadata_emitted_on_skip_to_item_with_window_changed">[docs]</a>    <span class="k">def</span> <span class="nf">test_metadata_emitted_on_skip_to_item_with_window_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-69353</span>
<span class="sd">        Verifies that the player properly emits the next track when added to the window without</span>
<span class="sd">        the queueVersion or context changing.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>

        <span class="c1"># Arm the 304 itemWindow script so that the window on the player doesn&#39;t change from player requests</span>
        <span class="c1"># We want to be in control of the window via the withWindow commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">arm_error_script</span><span class="p">(</span><span class="n">call</span><span class="o">=</span><span class="s2">&quot;itemWindow&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mi">304</span><span class="p">,</span>
                                                       <span class="n">num_errors</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;23&#39;</span><span class="p">,</span>
                                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window_end</span><span class="p">)</span>

        <span class="c1"># Make sure a context request has been made</span>
        <span class="c1"># The show next track policy isn&#39;t applied until the context has been fetched</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                   <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/context&#39;</span><span class="p">),</span>
                                                                   <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                   <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Context request should have been made&quot;</span><span class="p">)</span>

        <span class="c1"># Get the last track in the window and re-add it to the end with a spoofed value.</span>
        <span class="n">fake_window</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_end</span><span class="p">)</span>
        <span class="n">fake_window</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_end</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">fake_window</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;99&#39;</span>
        <span class="n">fake_track</span> <span class="o">=</span> <span class="n">fake_window</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;track&#39;</span><span class="p">]</span>
        <span class="n">fake_track</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;sentinel&#39;</span>

        <span class="c1"># Skip to item with window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item_with_window</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                           <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                           <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;23&#39;</span><span class="p">,</span>
                                           <span class="n">window</span><span class="o">=</span><span class="n">fake_window</span><span class="p">)</span>

        <span class="c1"># Verify the player emits the metadata for the fake track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">MetadataStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">next_item</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">next_item</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span>
                                                    <span class="n">fake_track</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_304_itemWindow_response_doesnt_lock_up_player"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_304_itemWindow_response_doesnt_lock_up_player">[docs]</a>    <span class="k">def</span> <span class="nf">test_304_itemWindow_response_doesnt_lock_up_player</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-63498</span>
<span class="sd">        Verify that the player is responsive after receiving a 304 from an /itemWindow request</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;15&#39;</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;15&quot;</span><span class="p">))</span>

        <span class="c1"># Wait until the player makes an /itemWindow request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                                    <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span><span class="p">),</span>
                                                                                    <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                                    <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Send a raw skip back command so that the test isn&#39;t blocked while waiting for the response</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;[{{&quot;namespace&quot;: &quot;playback:1&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;command&quot;: &quot;skipToPreviousTrack&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;cmdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;groupId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                  <span class="s1">&#39;&quot;householdId&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;}}, &#39;</span> \
                  <span class="s1">&#39;{{}}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">_get_next_cmd_id</span><span class="p">()),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">),</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">WebsocketMessageRaw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">send_message_raw</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># The player should be responsive and skip to the previous track as normal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;14&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_loadCloudqueue_with_window"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_loadCloudqueue_with_window">[docs]</a>    <span class="k">def</span> <span class="nf">test_loadCloudqueue_with_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that the player is able to play cloudqueue tracks in the provided window</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_loadCloudqueue_with_SMAPI_tracks_in_window"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_loadCloudqueue_with_SMAPI_tracks_in_window">[docs]</a>    <span class="k">def</span> <span class="nf">test_loadCloudqueue_with_SMAPI_tracks_in_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that the player can play smapi tracks in the provided window</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;3&#39;</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_skipIoItem_within_same_track_with_window"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_skipIoItem_within_same_track_with_window">[docs]</a>    <span class="k">def</span> <span class="nf">test_skipIoItem_within_same_track_with_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that the player is able to seek within the same track using skipToItemWithWindow</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item_with_window</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">15000</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_skipToItem_new_track_with_window"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_skipToItem_new_track_with_window">[docs]</a>    <span class="k">def</span> <span class="nf">test_skipToItem_new_track_with_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that the player is able to skip to a new track with the provided window</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item_with_window</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_error_on_load_with_invalid_itemIds"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_error_on_load_with_invalid_itemIds">[docs]</a>    <span class="k">def</span> <span class="nf">test_error_on_load_with_invalid_itemIds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that the player will event an error when the itemId is centered on a tombstoned track,</span>
<span class="sd">        a track that&#39;s outside of the window, and a null value.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;5&#39;</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_INVALID_PARAMETER&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;20&#39;</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_INVALID_PARAMETER&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_MISSING_PARAMETERS&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_verify_context_requests"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_verify_context_requests">[docs]</a>    <span class="k">def</span> <span class="nf">test_verify_context_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-62107, 663059, 63775</span>
<span class="sd">        Verifies that the player will make 1 and only 1 /context fetch after skipToItemWithWindow</span>
<span class="sd">        if the context value changes in the new window.</span>
<span class="sd">        Verifies that no /context fetch occurs if the context value doesn&#39;t change in the new window.</span>
<span class="sd">        Verifies that the player will fetch a /context after the initial loadWithWindow.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>
        <span class="n">new_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span>
        <span class="n">new_window</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="n">new_window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                   <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/context&#39;</span><span class="p">),</span>
                                                                   <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                   <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_playback_policy</span><span class="p">({</span><span class="s2">&quot;canRepeat&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="n">new_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_version_endpoint</span><span class="p">()[</span><span class="s2">&quot;contextVersion&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotEqualOrStop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">[</span><span class="s2">&quot;contextVersion&quot;</span><span class="p">],</span> <span class="n">new_context</span><span class="p">,</span>
                                  <span class="s2">&quot;contextVersion should have changed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">[</span><span class="s2">&quot;contextVersion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item_with_window</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                   <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/context&#39;</span><span class="p">),</span>
                                                                   <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                   <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span>
                               <span class="s2">&quot;Player should have fetched /context due to contextVersion change&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item_with_window</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                   <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/context&#39;</span><span class="p">),</span>
                                                                   <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                                   <span class="n">expected</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span>
                                   <span class="s2">&quot;Player should not have fethed /context due to no contextVersion change&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_player_uses_queueVersion_from_window"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_player_uses_queueVersion_from_window">[docs]</a>    <span class="k">def</span> <span class="nf">test_player_uses_queueVersion_from_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that the player will use whatever queueVersion is provided in the window provided</span>
<span class="sd">        in load and skip commands.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NEWQUEUEVERSION&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">queue_version</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NEWQUEUEVERSION2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item_with_window</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">15000</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">queue_version</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">[</span><span class="s2">&quot;queueVersion&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_normal_playback_with_304_itemWindow_responses"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_normal_playback_with_304_itemWindow_responses">[docs]</a>    <span class="k">def</span> <span class="nf">test_normal_playback_with_304_itemWindow_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that the player handles 304s while playing a few tracks, including</span>
<span class="sd">        end-of-queue scenario.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;13&#39;</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;14&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;15&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">))</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span><span class="p">),</span>
                                                                <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                                <span class="n">expected</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyLessEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span>
                                       <span class="s2">&quot;The player should process end of window gracefully and&quot;</span>
                                       <span class="s2">&quot; not make excessive /itemWindow requests&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_mixed_200_304_itemWindow_response"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_mixed_200_304_itemWindow_response">[docs]</a>    <span class="k">def</span> <span class="nf">test_mixed_200_304_itemWindow_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that the player can handle situations where the server will return a mix of</span>
<span class="sd">        200/304 responses to itemWindow requests</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item_with_window</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">arm_error_script</span><span class="p">(</span><span class="n">call</span><span class="o">=</span><span class="s2">&quot;itemWindow&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mi">304</span><span class="p">,</span>
                                                       <span class="n">num_errors</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item_with_window</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                               <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_loadCloudqueue_with_window_plays_preloaded_track_first"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_loadCloudqueue_with_window_plays_preloaded_track_first">[docs]</a>    <span class="k">def</span> <span class="nf">test_loadCloudqueue_with_window_plays_preloaded_track_first</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-81455</span>
<span class="sd">        SWPBL-52858</span>
<span class="sd">        Verify that the cloudqueue will play if the player is provided with a valid window and</span>
<span class="sd">        that the context request is delayed on the server. The request should not stop the player from</span>
<span class="sd">        starting playback.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_context_response_delay</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                                   <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                              <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>

        <span class="c1"># SWPBL-85660</span>
        <span class="c1"># Verify that we can&#39;t seek before getting the context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">Error</span><span class="o">.</span><span class="n">DISALLOWED_POLICY</span><span class="p">))</span>

        <span class="c1"># Make sure a context request has been made</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                     <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/context&#39;</span><span class="p">),</span>
                                                     <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                     <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Context request should have been made&quot;</span><span class="p">)</span>

        <span class="c1"># Verify that we can pause after getting the context back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                        <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                        <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">4000</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseSessionWindowTests.test_player_polls_version_after_skip_with_window"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionWindowTests.test_player_polls_version_after_skip_with_window">[docs]</a>    <span class="k">def</span> <span class="nf">test_player_polls_version_after_skip_with_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-102094</span>
<span class="sd">        Verify that the player polls version at correct intervals when queue is loaded from window</span>
<span class="sd">        and skipToItemWithWindow is called</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds does not support withWindow commands on the LAN&#39;</span><span class="p">)</span>

        <span class="c1"># Start cq with queue from long ( &gt; 1hr) tracks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/long_tracks/&quot;</span><span class="p">)</span>

        <span class="c1"># Speed up the player version polling interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_cloudqueue_poll_timers</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">playing_timer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">paused_timer</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Load cloud queue with long track</span>
        <span class="n">item_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_itemwindow_endpoint</span><span class="p">(</span><span class="n">itemid</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue_with_window</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                               <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">item_window</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>

        <span class="c1"># Wait for the player to grab context before sending skip command to replicate the bug</span>
        <span class="n">context_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/context&#39;</span><span class="p">),</span>
                                                    <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">context_req</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Expect a context request&quot;</span><span class="p">)</span>

        <span class="c1"># skip to item with window to trigger bug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item_with_window</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                           <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                                           <span class="n">window</span><span class="o">=</span><span class="n">item_window</span><span class="p">,</span>
                                           <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that 3 polling events occured within timeout</span>
        <span class="n">ver_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/version&#39;</span><span class="p">),</span>
                                                    <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ver_req</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Expect at least 3 version requests&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MuseSessionNamespaceTests"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionNamespaceTests">[docs]</a><span class="k">class</span> <span class="nc">MuseSessionNamespaceTests</span><span class="p">(</span><span class="n">MuseSessionTests</span><span class="p">,</span> <span class="n">MuseClientFixtureMixin</span><span class="p">):</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NIGHTLY_MUSE_SESSION_NAMESPACE&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="MuseSessionNamespaceGroupMovedResponseTests"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionNamespaceGroupMovedResponseTests">[docs]</a><span class="k">class</span> <span class="nc">MuseSessionNamespaceGroupMovedResponseTests</span><span class="p">(</span><span class="n">GroupMovedResponseTests</span><span class="p">,</span> <span class="n">MuseClientFixtureMixin</span><span class="p">):</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NIGHTLY_MUSE_SESSION_NAMESPACE&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="MuseSessionNamespaceWindowTests"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseSessionNamespaceWindowTests">[docs]</a><span class="k">class</span> <span class="nc">MuseSessionNamespaceWindowTests</span><span class="p">(</span><span class="n">MuseSessionWindowTests</span><span class="p">,</span> <span class="n">MuseClientFixtureMixin</span><span class="p">):</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NIGHTLY_MUSE_SESSION_NAMESPACE&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="MuseCloudClientSessionNamespaceTests"><a class="viewcode-back" href="../../webserver.html#webserver.muse_session_namespace.MuseCloudClientSessionNamespaceTests">[docs]</a><span class="k">class</span> <span class="nc">MuseCloudClientSessionNamespaceTests</span><span class="p">(</span><span class="n">MuseSessionTests</span><span class="p">,</span> <span class="n">MuseCloudServerFixtureMixin</span><span class="p">):</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NIGHTLY_CLOUD_MUSE&#39;</span><span class="p">]</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">WorkflowTestSuite</span><span class="p">(</span><span class="s2">&quot;Muse Session Namespace Tests&quot;</span><span class="p">)</span>
    <span class="c1"># suite.run([MuseSessionNamespaceGroupMovedResponseTests()])</span>
    <span class="n">suite</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">MuseSessionNamespaceTests</span><span class="p">(),</span>
               <span class="n">MuseSessionNamespaceGroupMovedResponseTests</span><span class="p">(),</span>
               <span class="n">MuseSessionNamespaceWindowTests</span><span class="p">()])</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">suite</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_pass</span><span class="p">()</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>