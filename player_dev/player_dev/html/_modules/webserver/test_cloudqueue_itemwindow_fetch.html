
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>webserver.test_cloudqueue_itemwindow_fetch &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for webserver.test_cloudqueue_itemwindow_fetch</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functional tests for the player getItemWindow cloudqueue API. These</span>
<span class="sd">tests utilize a player testpoint to restrict when it can request a new</span>
<span class="sd">itemWindow from the cloudqueue server and then verify that the player</span>
<span class="sd">plays/doesn&#39;t play and errors out in the expected scenarios.</span>

<span class="sd">Testpoint info can be found here: https://confluence.sonos.com/x/rwFb</span>
<span class="sd">testpoint in use: testpoint?name=chsrc.cq&amp;action=&lt;action&gt;&amp;option=fetch-at-window-edge</span>

<span class="sd">Players must support the muse websocket endpoint.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="k">import</span> <span class="n">unquote</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.suite</span> <span class="k">import</span> <span class="n">WorkflowTestSuite</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">wait_until_true</span><span class="p">,</span> <span class="n">combinatorial</span>
<span class="kn">import</span> <span class="nn">webserver.helpers.muse_api_helpers</span>
<span class="kn">from</span> <span class="nn">sonos.client.websockets.event</span> <span class="k">import</span> <span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span>
                                           <span class="n">PlaybackErrorEvent</span><span class="p">,</span> <span class="n">PlaybackState</span><span class="p">,</span> <span class="n">Success</span><span class="p">,</span> <span class="n">GroupStatus</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">webserver.base_muse_fixture</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">BaseMuseFixture</span><span class="p">,</span> <span class="n">MuseClientFixtureMixin</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">webserver.helpers.muse_api_helpers</span> <span class="k">import</span> <span class="n">MuseSessionMixin</span>
<span class="kn">from</span> <span class="nn">webserver.helpers.cloud_queue_helpers</span> <span class="k">import</span> <span class="n">cq_helpers</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="ne">TimeoutError</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">muse_helper</span> <span class="o">=</span> <span class="n">webserver</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">muse_api_helpers</span><span class="o">.</span><span class="n">MuseApiHelpers</span><span class="p">()</span>
<span class="n">muse_session_mixin</span> <span class="o">=</span> <span class="n">MuseSessionMixin</span><span class="p">()</span>
<span class="n">cq_helper</span> <span class="o">=</span> <span class="n">cq_helpers</span><span class="p">()</span>


<div class="viewcode-block" id="bool_generator"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.bool_generator">[docs]</a><span class="k">def</span> <span class="nf">bool_generator</span><span class="p">():</span>
    <span class="k">for</span> <span class="nb">bool</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">yield</span> <span class="nb">bool</span></div>


<span class="c1"># Define some global constants</span>
<span class="n">FIRST_TRACK_ITEM_ID</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
<span class="n">SECOND_TRACK_ITEM_ID</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
<span class="n">THIRD_TRACK_ITEM_ID</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>


<div class="viewcode-block" id="endpoint_version"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.endpoint_version">[docs]</a><span class="k">def</span> <span class="nf">endpoint_version</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">2.1</span><span class="p">]:</span>
        <span class="k">yield</span> <span class="n">v</span></div>


<div class="viewcode-block" id="GetItemWindowTestImpl"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl">[docs]</a><span class="k">class</span> <span class="nc">GetItemWindowTestImpl</span><span class="p">(</span><span class="n">BaseMuseFixture</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Holds the base setup and teardown. This is expanded on later in</span>
<span class="sd">    classes that utilize different numbers of tracks in the CQ and</span>
<span class="sd">    different states of the testpoint that changes itemWindow fetch</span>
<span class="sd">    behavior.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="GetItemWindowTestImpl.setUpFixture"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GetItemWindowTestImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span> <span class="o">=</span> <span class="mi">3000</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.setUpTest"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GetItemWindowTestImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                    <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                    <span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.tearDownTest"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GetItemWindowTestImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">host_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.tearDownFixture"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GetItemWindowTestImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.url_encode_test_string_gen"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.url_encode_test_string_gen">[docs]</a>    <span class="k">def</span> <span class="nf">url_encode_test_string_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator for yielding test strings for url encoding in</span>
<span class="sd">        itemWindow requests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">u</span><span class="s2">&quot;!#$&#39;()*+,-./:;=?@_~ &amp;&quot;</span><span class="p">,</span> <span class="c1"># Punctuation, reserved chars</span>
                  <span class="sa">u</span><span class="s2">&quot; %+;abc--+/!!!!&amp;&quot;</span><span class="p">,</span> <span class="c1"># Mix of ascii, punctuation reserved chars</span>
                  <span class="sa">u</span><span class="s2">&quot;herecomedatboi&quot;</span><span class="p">,</span> <span class="c1"># No characters that need to be encoded</span>
                  <span class="sa">u</span><span class="s2">&quot;        &quot;</span><span class="p">):</span> <span class="c1"># All spaces</span>
            <span class="k">yield</span> <span class="n">s</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.set_up_one_track_cq_server"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.set_up_one_track_cq_server">[docs]</a>    <span class="k">def</span> <span class="nf">set_up_one_track_cq_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Set up the CQ server with only one track</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">track</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_single_track_normal_operation_without_preload_metadata"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_single_track_normal_operation_without_preload_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">test_single_track_normal_operation_without_preload_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player loads a CQ, plays the CQ tracks</span>
<span class="sd">        and transitions to the paused-at-end state when done, while there</span>
<span class="sd">        is only 1 track in the CQ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_up_one_track_cq_server</span><span class="p">()</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                    <span class="n">track_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">))</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_single_track_normal_operation_with_preload_metadata"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_single_track_normal_operation_with_preload_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">test_single_track_normal_operation_with_preload_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player uses firstTrackMetadata, plays the CQ to completion</span>
<span class="sd">        and transitions to the paused-at-end state when done, while there is only</span>
<span class="sd">        1 track in the CQ</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_up_one_track_cq_server</span><span class="p">()</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">))</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_multiple_tracks_normal_operation_with_preload_md"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_multiple_tracks_normal_operation_with_preload_md">[docs]</a>    <span class="k">def</span> <span class="nf">test_multiple_tracks_normal_operation_with_preload_md</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player loads a CQ, plays the CQ tracks</span>
<span class="sd">        and transitions to the paused-at-end state when done when there</span>
<span class="sd">        is more than one track in the CQ and the loadCloudQueue call</span>
<span class="sd">        supplies firstTrackMetadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s1">&#39;0&#39;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="c1"># Wait for the initial context request otherwise the seek operations will not be allowed</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                      <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/context&#39;</span><span class="p">,</span>
                                                                      <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                      <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
                                   <span class="s1">&#39;Wait until the player makes the initial context request&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                       <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">25</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s1">&#39;0&#39;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">25000</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s1">&#39;1&#39;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
                       <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">25</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s1">&#39;2&#39;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="c1"># Let the third track play all the way through naturally.  I (TadC) am not seeking here</span>
        <span class="c1"># to make this final track play as naturally as possible.  (This may be overly conservative)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_multiple_tracks_normal_operation_no_preload_md"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_multiple_tracks_normal_operation_no_preload_md">[docs]</a>    <span class="k">def</span> <span class="nf">test_multiple_tracks_normal_operation_no_preload_md</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player loads a CQ, plays the CQ tracks</span>
<span class="sd">        and transitions to the paused-at-end state when done when there</span>
<span class="sd">        is more than one track in the CQ and the loadCloudQueue call</span>
<span class="sd">        does not supply firstTrackMetadata.</span>
<span class="sd">        Seek 25 seconds into each track so that only 5 seconds of each track plays.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">track_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s1">&#39;0&#39;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                       <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">25</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s1">&#39;1&#39;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
                       <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">25</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s1">&#39;2&#39;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="p">,</span>
                       <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">25</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s1">&#39;2&#39;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">30000</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">))</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_flung_url_used_once_load_cloud_queue"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_flung_url_used_once_load_cloud_queue">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">bool_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_flung_url_used_once_load_cloud_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">play_on_completion</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the &quot;flung&quot; url (the medialUrl passed in by the client app) is used, and used only once, by the</span>
<span class="sd">        player. This is functionality that the Google Play Music implementation relies upon.</span>

<span class="sd">        This variant uses loadCloudQueue() to specify the &quot;flung&quot; url, which has a query param tacked on to it.</span>
<span class="sd">        Playback begins on the second track (B) in the queue, then we skip back to the first track in the queue, letting</span>
<span class="sd">        it progress naturally to the second track in the queue. Verification: check the mock CQ mediaUrl log to verify</span>
<span class="sd">        that the first fetch(es) of track B use the &quot;flung&quot; url with the query param, and the later fetch of track B</span>
<span class="sd">         uses the &quot;normal&quot; url.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_media_log</span><span class="p">()</span>
        <span class="n">first_track_media_url</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">FIRST_TRACK_ITEM_ID</span><span class="p">)[</span><span class="s1">&#39;mediaUrl&#39;</span><span class="p">]</span>
        <span class="n">third_track_media_url</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">THIRD_TRACK_ITEM_ID</span><span class="p">)[</span><span class="s1">&#39;mediaUrl&#39;</span><span class="p">]</span>

        <span class="c1"># Start playing the second track; add a query param to the end of the mediaUrl to make it distinct</span>
        <span class="n">second_track_metadata</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">SECOND_TRACK_ITEM_ID</span><span class="p">)</span>
        <span class="n">normal_url</span> <span class="o">=</span> <span class="n">second_track_metadata</span><span class="p">[</span><span class="s1">&#39;mediaUrl&#39;</span><span class="p">]</span>
        <span class="n">flung_url</span> <span class="o">=</span> <span class="n">normal_url</span> <span class="o">+</span> <span class="s2">&quot;?action=explicit&quot;</span>
        <span class="n">second_track_metadata</span><span class="p">[</span><span class="s1">&#39;mediaUrl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flung_url</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                                    <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                    <span class="n">my_item_id</span><span class="o">=</span><span class="n">SECOND_TRACK_ITEM_ID</span><span class="p">,</span>
                                                    <span class="n">track_metadata</span><span class="o">=</span><span class="n">second_track_metadata</span><span class="p">,</span>
                                                    <span class="n">auto_playback</span><span class="o">=</span><span class="n">play_on_completion</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">play_on_completion</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">SECOND_TRACK_ITEM_ID</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">),</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># skip back to the first track, positioning 5 seconds from the end (this assumes the track is 30 seconds</span>
        <span class="c1"># long) and wait for playback to progress naturally to the second track.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="n">FIRST_TRACK_ITEM_ID</span><span class="p">,</span>
                             <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">25</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">FIRST_TRACK_ITEM_ID</span><span class="p">),</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">SECOND_TRACK_ITEM_ID</span><span class="p">),</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>

        <span class="c1"># VERIFICATIONS</span>
        <span class="c1"># fetch the mediaUrl log from the mock CQ server and verify</span>
        <span class="n">media_log</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_media_log</span><span class="p">()</span>
        <span class="c1"># The first log entry should be for the flung url.  It may be fetched multiple times due to the way</span>
        <span class="c1"># the Sonos player seeks around to read id3v2 tags and other metadata from an mp3 file.</span>
        <span class="n">log_entry</span> <span class="o">=</span> <span class="n">media_log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">flung_url</span><span class="p">,</span> <span class="n">log_entry</span><span class="p">[</span><span class="s1">&#39;fullUrl&#39;</span><span class="p">],</span> <span class="s2">&quot;expected flung url for second track&quot;</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;expect_flung_second_track&quot;</span>
        <span class="k">for</span> <span class="n">log_entry</span> <span class="ow">in</span> <span class="n">media_log</span><span class="p">:</span>
            <span class="n">track_url</span> <span class="o">=</span> <span class="n">log_entry</span><span class="p">[</span><span class="s1">&#39;fullUrl&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;expect_flung_second_track&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotEqualOrFailCase</span><span class="p">(</span><span class="n">normal_url</span><span class="p">,</span> <span class="n">track_url</span><span class="p">,</span>
                                              <span class="s2">&quot;don&#39;t expect the normal url for second track until after the first track&quot;</span><span class="p">)</span>
                <span class="c1"># There may be additional fetches of the flung url for the second track - ignore those</span>
                <span class="k">if</span> <span class="n">track_url</span> <span class="o">==</span> <span class="n">flung_url</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># The Sonos player may have enough buffer space to pre-fetch the third track; therefore, if</span>
                <span class="c1"># we see the third track URL in the media log, just ignore it.</span>
                <span class="k">if</span> <span class="n">track_url</span> <span class="o">==</span> <span class="n">third_track_media_url</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">first_track_media_url</span><span class="p">,</span> <span class="n">track_url</span><span class="p">,</span> <span class="s2">&quot;expecting first track url&quot;</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;expect_first_track&quot;</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;expect_first_track&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">track_url</span> <span class="o">==</span> <span class="n">first_track_media_url</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">normal_url</span><span class="p">,</span> <span class="n">track_url</span><span class="p">,</span> <span class="s2">&quot;expect normal url for the second track&quot;</span><span class="p">)</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_flung_url_used_once_skip_to_item"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_flung_url_used_once_skip_to_item">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">bool_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_flung_url_used_once_skip_to_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">play_on_completion</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the &quot;flung&quot; url (the medialUrl passed in by the client app) is used, and used once, when</span>
<span class="sd">        skipToItem() is called. This is functionality that the Google Play Music implementation relies upon.</span>

<span class="sd">        This variant uses skipToItem() to specify the &quot;flung&quot; url, which has a query param tacked on to it.  Playback</span>
<span class="sd">        begins (paused) on the first track in the queue, then we skipToItem() to the second track (B) in the queue</span>
<span class="sd">        (using a modified mediaUrl). The skip back to the end of the first item in the queue and let playback progress</span>
<span class="sd">        naturally to the second track in the queue.</span>
<span class="sd">        Verification: check the mock CQ media log to verify that the first fetch(es) of track B use the &quot;flung&quot; url</span>
<span class="sd">        with the query param, and the later fetch of track B uses the &quot;normal&quot; url.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_media_log</span><span class="p">()</span>
        <span class="n">first_track_media_url</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">FIRST_TRACK_ITEM_ID</span><span class="p">)[</span><span class="s1">&#39;mediaUrl&#39;</span><span class="p">]</span>
        <span class="n">third_track_media_url</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">THIRD_TRACK_ITEM_ID</span><span class="p">)[</span><span class="s1">&#39;mediaUrl&#39;</span><span class="p">]</span>

        <span class="c1"># Load the cloud queue (paused/idle) with the playhead at the start of the first track</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                                    <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                    <span class="n">auto_playback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">FIRST_TRACK_ITEM_ID</span> <span class="ow">and</span>
                                                    <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">or</span>
                                                     <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">)),</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># skipToItem() to the second track, using a modified &quot;flung&quot; url for the mediaUrl</span>
        <span class="n">second_track_metadata</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">SECOND_TRACK_ITEM_ID</span><span class="p">)</span>
        <span class="n">normal_url</span> <span class="o">=</span> <span class="n">second_track_metadata</span><span class="p">[</span><span class="s1">&#39;mediaUrl&#39;</span><span class="p">]</span>
        <span class="n">flung_url</span> <span class="o">=</span> <span class="n">normal_url</span> <span class="o">+</span> <span class="s2">&quot;?action=explicit&quot;</span>
        <span class="n">second_track_metadata</span><span class="p">[</span><span class="s1">&#39;mediaUrl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flung_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="n">SECOND_TRACK_ITEM_ID</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="n">second_track_metadata</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="n">play_on_completion</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">play_on_completion</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
              <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">SECOND_TRACK_ITEM_ID</span> <span class="ow">and</span>
                                        <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">),</span>
              <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># skip back to the first track, positioning 5 seconds from the end (this assumes the track is 30 seconds</span>
        <span class="c1"># long).  Wait for playback to continue naturally to the second track, then pause.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="n">FIRST_TRACK_ITEM_ID</span><span class="p">,</span>
                             <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">25</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">FIRST_TRACK_ITEM_ID</span><span class="p">),</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">SECOND_TRACK_ITEM_ID</span><span class="p">),</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>

        <span class="c1"># VERIFICATIONS</span>
        <span class="c1"># fetch the media log from the mock CQ server and verify</span>
        <span class="n">media_log</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_media_log</span><span class="p">()</span>
        <span class="c1"># The first log entry should be for the flung url.  It may be fetched multiple times due to the way</span>
        <span class="c1"># the Sonos player seeks around to read id3v2 tags and other metadata from an mp3 file.</span>
        <span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;expect_flung_second_track&quot;</span>
        <span class="k">for</span> <span class="n">log_entry</span> <span class="ow">in</span> <span class="n">media_log</span><span class="p">:</span>
            <span class="n">track_url</span> <span class="o">=</span> <span class="n">log_entry</span><span class="p">[</span><span class="s1">&#39;fullUrl&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;expect_flung_second_track&quot;</span><span class="p">:</span>
                <span class="c1"># The Sonos player may pre-fetch the first track to get its embedded metadata - ignore those fetches.</span>
                <span class="k">if</span> <span class="n">track_url</span> <span class="o">==</span> <span class="n">first_track_media_url</span><span class="p">:</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">flung_url</span><span class="p">,</span> <span class="n">track_url</span><span class="p">,</span> <span class="s2">&quot;expected flung url for second track&quot;</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;expect_first_track&quot;</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;expect_first_track&quot;</span><span class="p">:</span>
                <span class="c1"># There may be additional fetches of the flung url for the second track - ignore those</span>
                <span class="k">if</span> <span class="n">track_url</span> <span class="o">==</span> <span class="n">flung_url</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># The Sonos player may have enough buffer space to pre-fetch the third track; therefore, if</span>
                <span class="c1"># we see the third track URL in the media log, just ignore it.</span>
                <span class="k">if</span> <span class="n">track_url</span> <span class="o">==</span> <span class="n">third_track_media_url</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">first_track_media_url</span><span class="p">,</span> <span class="n">track_url</span><span class="p">,</span> <span class="s2">&quot;expected first track url&quot;</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;expect_flung_url&quot;</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;expect_flung_url&quot;</span><span class="p">:</span>
                <span class="c1"># There may be additional fetches of the first track url - ignore those</span>
                <span class="k">if</span> <span class="n">track_url</span> <span class="o">==</span> <span class="n">first_track_media_url</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">normal_url</span><span class="p">,</span> <span class="n">track_url</span><span class="p">,</span> <span class="s2">&quot;expected normal url for second track&quot;</span><span class="p">)</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_fetch_after_skip_to_item_with_md"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_fetch_after_skip_to_item_with_md">[docs]</a>    <span class="k">def</span> <span class="nf">test_fetch_after_skip_to_item_with_md</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that the player attempts to fetch the itemWindow in a timely manner</span>
<span class="sd">        after a load and skip with metadata.</span>
<span class="sd">        This tests uses a normal (3.5 min) length mp3 file</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                    <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                    <span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/special/&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="n">md</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">md</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="n">md</span><span class="p">)</span>

        <span class="c1"># Verify a itemWindow request was made and that a playback status event with a queueVersion was sent</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                  <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                                <span class="n">l</span><span class="p">[</span><span class="s1">&#39;queryParams&#39;</span><span class="p">][</span><span class="s2">&quot;itemId&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">),</span>
                                                                  <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                                                  <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s1">&#39;Player should have made an itemWindow request centered on itemId 1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">queue_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">queue_version</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_fetch_after_upcoming_window_range_deletion"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_fetch_after_upcoming_window_range_deletion">[docs]</a>    <span class="k">def</span> <span class="nf">test_fetch_after_upcoming_window_range_deletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies the player will request another window if the current and</span>
<span class="sd">        the next 10 tracks are deleted. The player should fetch a new window and continue playing.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">27</span><span class="p">):</span>
            <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                         <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;10&#39;</span><span class="p">,</span>
                                         <span class="n">position_millis</span><span class="o">=</span><span class="mi">25000</span><span class="p">,</span>
                                         <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
            <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s1">&#39;21&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_fetch_after_previous_window_range_deletion"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_fetch_after_previous_window_range_deletion">[docs]</a>    <span class="k">def</span> <span class="nf">test_fetch_after_previous_window_range_deletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies the player will request another window if the current and</span>
<span class="sd">        the previous 10 tracks are deleted. The player should fetch a new window and pause on the last track in the queue.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">27</span><span class="p">):</span>
            <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                         <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;29&#39;</span><span class="p">,</span>
                                         <span class="n">position_millis</span><span class="o">=</span><span class="mi">25000</span><span class="p">,</span>
                                         <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">):</span>
            <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s1">&#39;19&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_fetch_verify_item_id_and_queue_version_url_encoded"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_fetch_verify_item_id_and_queue_version_url_encoded">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s1">&#39;url_encode_test_string_gen&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_fetch_verify_item_id_and_queue_version_url_encoded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that values passed in itemWindow GET for itemId and queueVersion are</span>
<span class="sd">        properly urlencoded. Tests various cases including reserved characters.</span>
<span class="sd">        See SWPBL-49404</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Attempt to start CQ client pointing at s_custom_id for item_id</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                                                    <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                                    <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                                    <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                    <span class="n">my_item_id</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                                    <span class="n">track_metadata</span><span class="o">=</span><span class="n">cq_helper</span><span class="o">.</span><span class="n">fake_metadata</span><span class="p">(</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span>
                                                                                           <span class="n">item</span><span class="o">=</span><span class="n">s</span><span class="p">),</span>
                                                    <span class="n">queue_version</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># Verify we saw an itemWindow request</span>
        <span class="n">iw_log</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
            <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">full_url</span> <span class="o">=</span> <span class="n">iw_log</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fullUrl&#39;</span><span class="p">]</span>

        <span class="c1"># Extract the encoded itemId from the fullUrl</span>
        <span class="n">s_encoded_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;itemId=([^&amp;]*)&amp;&#39;</span><span class="p">,</span> <span class="n">full_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyIsNotNoneOrFailCase</span><span class="p">(</span><span class="n">s_encoded_id</span><span class="p">,</span>
            <span class="s2">&quot;Found itemId in itemWindow GET request?&quot;</span><span class="p">)</span>

        <span class="c1"># Extract the encoded itemId from the fullUrl</span>
        <span class="n">s_encoded_qv</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;queueVersion=([^&amp;]*)&amp;&#39;</span><span class="p">,</span> <span class="n">full_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyIsNotNoneOrFailCase</span><span class="p">(</span><span class="n">s_encoded_qv</span><span class="p">,</span>
            <span class="s2">&quot;Found queueVersion in itemWindow GET request?&quot;</span><span class="p">)</span>

        <span class="c1"># Decode the extracted string and verify it matches what we passed in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
            <span class="n">unquote</span><span class="p">(</span><span class="n">s_encoded_id</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
            <span class="s2">&quot;URL encoded string for itemId matches expected?&quot;</span><span class="p">)</span>

        <span class="c1"># Decode the extracted string and verify it matches what we passed in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
            <span class="n">unquote</span><span class="p">(</span><span class="n">s_encoded_qv</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
            <span class="s2">&quot;URL encoded string for queueVersion matches expected?&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_verify_no_itemWindow_fetch_on_shutdown"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_verify_no_itemWindow_fetch_on_shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">test_verify_no_itemWindow_fetch_on_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player does not make an /itemWindow fetch when stopping</span>
<span class="sd">        during shutdown.</span>

<span class="sd">        See SWPBL-70596.</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The CQ needs enough tracks so that the queue doesn&#39;t include</span>
        <span class="c1"># the beginning of the window.</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">27</span><span class="p">):</span>
            <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Load CQ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;25&#39;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Verify playing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="c1"># Let the player play for a bit</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Clear the log</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">)</span>

        <span class="c1"># Bounce anacapa and verify player does not fetch a new window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">()</span>
        <span class="n">itemWindow_log</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                             <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span><span class="p">,</span>
                                                                             <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                                             <span class="n">expected</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemWindow_log</span><span class="p">),</span>
                                   <span class="s1">&#39;Player should not fetch window on STOP&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_play_after_initial_window_and_queue_content"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_play_after_initial_window_and_queue_content">[docs]</a>    <span class="k">def</span> <span class="nf">test_play_after_initial_window_and_queue_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies the player will request a window at end of a the initial window range and continue playing.</span>
<span class="sd">        Verifies that the player will request a window and resume playing if the user adds tracks to the queue</span>
<span class="sd">        after the player finishes playing the initial queue</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">):</span>
            <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                         <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;11&#39;</span><span class="p">,</span>
                                         <span class="n">position_millis</span><span class="o">=</span><span class="mi">25000</span><span class="p">,</span>
                                         <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">track_metadata</span><span class="o">=</span><span class="n">md</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s1">&#39;11&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s1">&#39;12&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;19&#39;</span><span class="p">,</span>
                                         <span class="n">position_millis</span><span class="o">=</span><span class="mi">25000</span><span class="p">,</span>
                                         <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">track_metadata</span><span class="o">=</span><span class="n">md</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s1">&#39;19&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
            <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s1">&#39;20&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_end_of_queue_window_version_fetch_count"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_end_of_queue_window_version_fetch_count">[docs]</a>    <span class="k">def</span> <span class="nf">test_end_of_queue_window_version_fetch_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Make sure that the player is making at least one itemWindow and</span>
<span class="sd">        one version call at the end of queue.</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_playback_policy</span><span class="p">({</span><span class="s1">&#39;refreshAuthWhilePaused&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="n">playback_policy</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_playback_policies</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyFalseOrFailCase</span><span class="p">(</span><span class="n">playback_policy</span><span class="p">[</span><span class="s1">&#39;refreshAuthWhilePaused&#39;</span><span class="p">],</span>
                               <span class="s2">&quot;Container refreshAuthWhilePaused policy should be False&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">cq_helper</span><span class="o">.</span><span class="n">fake_metadata</span><span class="p">(</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="s2">&quot;8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                         <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;8&quot;</span><span class="p">,</span>
                                         <span class="n">position_millis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">track_metadata</span><span class="o">=</span><span class="n">md</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                                         <span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s1">&#39;8&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">))</span>

        <span class="n">itemWindow_log</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                             <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span><span class="p">,</span>
                                                                             <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                             <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">itemWindow_log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> /itemWindow calls were logged, expected at least 1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">itemWindow_log</span><span class="p">)))</span>

        <span class="n">version_log</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                          <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/version&#39;</span><span class="p">,</span>
                                                                          <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                          <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">version_log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> /version calls were logged, expected at least 1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">version_log</span><span class="p">)))</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_correct_final_track_after_skip_stress"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_correct_final_track_after_skip_stress">[docs]</a>    <span class="k">def</span> <span class="nf">test_correct_final_track_after_skip_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure rapid skipping in both directions should always results in landing on the proper final track</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># total of 15 tracks</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span>
            <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>

        <span class="c1"># Rapid skip through tracks for stress</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s1">&#39;10&#39;</span><span class="p">)</span>

        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_previous</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>

        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">14</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s1">&#39;14&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_timePlayed_version_check"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_timePlayed_version_check">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">endpoint_version</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_timePlayed_version_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Covers SWPBL-51991</span>
<span class="sd">        The endpoint the player hits on the server depends on the queue_base_url passed in</span>
<span class="sd">        from load_cloud_queue.</span>
<span class="sd">        This test ensures that each version hits their correct respective endpoints and that</span>
<span class="sd">        v1 does not make a context endpoint request.</span>
<span class="sd">        :param version:</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">expected_timePlayed_item_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;itemId&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;trackUrl&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;kind&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;timeSincePlaybackMillis&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;durationPlayedMillis&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expected_timePlayed_item_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timeSincePlaybackMillis&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;queueVersion&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;contextVersion&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;mediaUrl&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;positionMillis&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;positionMillisAtSegmentStart&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;durationPlayedMillis&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;type&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;id&#39;</span><span class="p">]</span>

        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                    <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                    <span class="n">endpoint_version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                                                    <span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">25000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">),</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="n">timePlayed_log</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                             <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/timePlayed&#39;</span><span class="p">),</span>
                                                                             <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;/musicqueue/v</span><span class="si">{}</span><span class="s2">/timePlayed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)),</span>
                                   <span class="n">timePlayed_log</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;fullPath&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;timePlayed POST should be using v</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">timePlayed_log</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;body&quot;</span><span class="p">][</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                   <span class="nb">set</span><span class="p">(</span><span class="n">expected_timePlayed_item_keys</span><span class="p">),</span>
                                   <span class="s2">&quot;timePlayed format should be using v</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_endpoint_version_check"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_endpoint_version_check">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">endpoint_version</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_endpoint_version_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covers SWPBL-51991</span>
<span class="sd">        The itemWindow, context, and version endpoints the player hits on the server depends on the queue_base_url passed in</span>
<span class="sd">        from load_cloud_queue.</span>
<span class="sd">        This test ensures that each version hits their correct respective endpoints and that</span>
<span class="sd">        v1 does not make a context endpoint request.</span>

<span class="sd">        SWPBL-68185 changed the behavior of when the player sends a /version check to the CQ endpoint. That</span>
<span class="sd">        verification has been removed from this test, which also removed a pause and some other extraneous</span>
<span class="sd">        setup steps. See CL 295386</span>
<span class="sd">        :param version:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                    <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                    <span class="n">endpoint_version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                                                    <span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">)</span>

        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                                                    <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                                    <span class="n">track_metadata</span><span class="o">=</span><span class="n">cq_helper</span><span class="o">.</span><span class="n">fake_metadata</span><span class="p">(</span>
                                                        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span>
                                                        <span class="n">item</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">),</span>
                                                    <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="n">itemWindow_log</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                             <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span><span class="p">,</span>
                                                                             <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;/musicqueue/v</span><span class="si">{}</span><span class="s2">/itemWindow&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)),</span>
                               <span class="n">itemWindow_log</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;fullPath&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;itemWindow GET should be using v</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span>

        <span class="n">context_log</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                          <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/context&#39;</span><span class="p">,</span>
                                                                          <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">context_log</span><span class="p">),</span>
                                   <span class="s2">&quot;No context endpoint logs should have been made with v</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;/musicqueue/v</span><span class="si">{}</span><span class="s2">/context&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)),</span>
                                       <span class="n">context_log</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;fullPath&quot;</span><span class="p">],</span>
                                       <span class="s2">&quot;context GET should be using v</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_no_itemwindow_fetch_on_delegation_with_notify_user_intent"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_no_itemwindow_fetch_on_delegation_with_notify_user_intent">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_itemwindow_fetch_on_delegation_with_notify_user_intent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that delegation does not cause any extra window fetches when notifyUserIntent</span>
<span class="sd">        is set.</span>

<span class="sd">        This test covers SWPBL-87800:</span>
<span class="sd">            CQ: Moving music results in itemWindow reason=pause request from the originating</span>
<span class="sd">            group</span>

<span class="sd">        Test steps:</span>
<span class="sd">        1. Set playbackPolicy notifyUserIntent=true</span>
<span class="sd">        2. Load CQ on ZP 1 with playOnCompletion=true</span>
<span class="sd">        3. Join ZP2 to ZP1 group</span>
<span class="sd">        4. ZP1 leave group (ZP2 is the new coordinator)</span>
<span class="sd">        5. Verify playback stops on ZP1 and we get a group_moved event</span>
<span class="sd">        6. Verify no additional window fetch is made as part of delegation.</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_playback_policy</span><span class="p">({</span><span class="s2">&quot;notifyUserIntent&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="c1"># Get another device</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="o">.</span><span class="n">generate_testbed_playback_devices</span><span class="p">()</span> <span class="k">if</span> <span class="n">zp</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrSkipCase</span><span class="p">(</span><span class="n">zps</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Test requires an additional device for grouping operations!&quot;</span><span class="p">)</span>
        <span class="n">zp_2</span> <span class="o">=</span> <span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mute_zp</span><span class="p">(</span><span class="n">zp_2</span><span class="p">)</span>
        <span class="c1"># Start playing CQ on ZP 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
            <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Wait for 3 seconds</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:03&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Clear API log to flush out the initial window request</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">)</span>

        <span class="c1"># Join ZP 2 to other ZP&#39;s group</span>
        <span class="n">zp_2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="c1"># GC leave group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupCoordinatorChangedEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group_status</span> <span class="o">==</span> <span class="n">GroupStatus</span><span class="o">.</span><span class="n">MOVED</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_stopped</span><span class="p">()</span> <span class="ow">or</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_paused</span><span class="p">(),</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Timed out waiting for ZP to enter stop state after becoming standalone&quot;</span><span class="p">)</span>

        <span class="c1"># Subscribe and make sure new GC is playing</span>
        <span class="n">muse_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="n">zp_2</span><span class="p">)</span>
        <span class="n">gid_2</span> <span class="o">=</span> <span class="n">zp_2</span><span class="o">.</span><span class="n">GroupManagement</span><span class="o">.</span><span class="n">get_local_group_uuid</span><span class="p">()</span>
        <span class="n">muse_2</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">gid_2</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="n">zp_2</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">muse_2</span><span class="p">,</span>
            <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Verify no window fetch</span>
        <span class="n">itemWindow_log</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                             <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                                          <span class="n">l</span><span class="p">[</span><span class="s1">&#39;queryParams&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reason&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;refresh&#39;</span><span class="p">,</span>
                                                                             <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                                             <span class="n">expected</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemWindow_log</span><span class="p">),</span>
                                   <span class="s2">&quot;Neither player in delegation should have requested a new window&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_bad_trackUrl_itemWindow_context_check"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_bad_trackUrl_itemWindow_context_check">[docs]</a>    <span class="k">def</span> <span class="nf">test_bad_trackUrl_itemWindow_context_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that when the player fails to open a stream to the preload metadata</span>
<span class="sd">        url that we still request the context and itemWindow, in that order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">)</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                                                    <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                                    <span class="n">track_metadata</span><span class="o">=</span><span class="n">cq_helper</span><span class="o">.</span><span class="n">fake_metadata</span><span class="p">(</span>
                                                        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span>
                                                        <span class="n">item</span><span class="o">=</span><span class="s2">&quot;75&quot;</span><span class="p">),</span>
                                                    <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackErrorEvent</span><span class="p">)</span>

        <span class="n">api_log</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                      <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                                      <span class="n">expected</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1"># The player will POST a timePlayed entry for the track that was loaded with the load CQ</span>
        <span class="c1"># command and it doesn&#39;t always appear after the context/itemWindow.</span>
        <span class="c1"># This is to protect against that possibility.</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">api_log</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/context&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;/context&quot;</span><span class="p">,</span>
                                       <span class="n">api_log</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
                                       <span class="s2">&quot;First GET after media fetch should be to /context&quot;</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Did not see the initial /context GET&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">api_log</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/itemWindow&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;/itemWindow&quot;</span><span class="p">,</span>
                                           <span class="n">api_log</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
                                           <span class="s2">&quot;Second GET after media fetch should be to /itemWindow&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Did not see /itemWindow after the initial /context GET&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_itemwindow_returned_while_playing_and_buffering"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_itemwindow_returned_while_playing_and_buffering">[docs]</a>    <span class="k">def</span> <span class="nf">test_itemwindow_returned_while_playing_and_buffering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the normal use case of loading a cloudqueue with first track metadata where the</span>
<span class="sd">        itemWindow is returned before the queue completion routine has run (before the track has</span>
<span class="sd">        completely buffered or finished playing).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span></div>

<div class="viewcode-block" id="GetItemWindowTestImpl.test_cloudqueue_playback_with_gzip_server_support"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTestImpl.test_cloudqueue_playback_with_gzip_server_support">[docs]</a>    <span class="k">def</span> <span class="nf">test_cloudqueue_playback_with_gzip_server_support</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-84539</span>
<span class="sd">        Verify that cloudqueue playback works if the server has gzip support enabled on cq responses.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># restart the server with gzip enabled</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                    <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                    <span class="n">gzip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">cq_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_port</span><span class="p">)</span>

        <span class="c1"># load the cq and verify playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="GetItemWindowTests"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowTests">[docs]</a><span class="k">class</span> <span class="nc">GetItemWindowTests</span><span class="p">(</span><span class="n">GetItemWindowTestImpl</span><span class="p">,</span> <span class="n">MuseClientFixtureMixin</span><span class="p">):</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NIGHTLY_CQ&#39;</span><span class="p">]</span></div>


<span class="kn">from</span> <span class="nn">sonos.client.zone_player</span> <span class="k">import</span> <span class="n">ENCORE</span><span class="p">,</span> <span class="n">SOLBASE</span><span class="p">,</span> <span class="n">SOUNDBAR</span><span class="p">,</span> <span class="n">ZONEPLAYER_S1</span><span class="p">,</span> <span class="n">ZONEPLAYER_S3</span>
<span class="n">FRAME_CACHE_PLAYERS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ENCORE</span><span class="p">,</span> <span class="n">SOLBASE</span><span class="p">,</span> <span class="n">SOUNDBAR</span><span class="p">,</span> <span class="n">ZONEPLAYER_S1</span><span class="p">,</span> <span class="n">ZONEPLAYER_S3</span><span class="p">,)</span>


<div class="viewcode-block" id="GetItemWindowChecksFrameCacheTests"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowChecksFrameCacheTests">[docs]</a><span class="k">class</span> <span class="nc">GetItemWindowChecksFrameCacheTests</span><span class="p">(</span><span class="n">MuseClientFixtureMixin</span><span class="p">):</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NIGHTLY_CQ&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_generate_frame_cache_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="o">.</span><span class="n">generate_testbed_unique_playback_devices</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="ow">in</span> <span class="n">FRAME_CACHE_PLAYERS</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">zp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Did not find any playback devices with a frame cache&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GetItemWindowChecksFrameCacheTests.setUpFixture"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowChecksFrameCacheTests.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GetItemWindowChecksFrameCacheTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_frame_cache_zp</span><span class="p">()</span></div>

<div class="viewcode-block" id="GetItemWindowChecksFrameCacheTests.setUpTest"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowChecksFrameCacheTests.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GetItemWindowChecksFrameCacheTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resumed_from_frame_cache</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log</span><span class="p">()</span>

        <span class="c1"># DIAGC(&quot;chsrc&quot;, 2, &quot;FC: starting replay off=%u&quot;, fch.m_streamOffset);</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">watch_udp_log_for_string</span><span class="p">(</span><span class="s2">&quot;FC: starting replay&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_replay</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">my_item_id</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_item_id</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
        <span class="n">my_metadata</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_item_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_item_id</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="n">my_metadata</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_item_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                        <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_item_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">))</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_item_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetItemWindowChecksFrameCacheTests.tearDownTest"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowChecksFrameCacheTests.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GetItemWindowChecksFrameCacheTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log</span><span class="p">()</span>
        <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span></div>

<div class="viewcode-block" id="GetItemWindowChecksFrameCacheTests.tearDownFixture"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowChecksFrameCacheTests.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GetItemWindowChecksFrameCacheTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_handle_replay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resumed_from_frame_cache</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_resume_playback_and_check_frame_cache_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                       <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resumed_from_frame_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Playback incorrectly resumed from frame cache; should of started new track&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GetItemWindowChecksFrameCacheTests.test_delete_on_refresh_cloud_queue_while_paused"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowChecksFrameCacheTests.test_delete_on_refresh_cloud_queue_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_delete_on_refresh_cloud_queue_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for SWPBL-45130</span>
<span class="sd">        Verify that the player moves to the next track when the current</span>
<span class="sd">        track is deleted while paused.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_item_id</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">),</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resume_playback_and_check_frame_cache_usage</span><span class="p">()</span></div>

<div class="viewcode-block" id="GetItemWindowChecksFrameCacheTests.test_delete_on_load_cloud_queue_while_paused"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowChecksFrameCacheTests.test_delete_on_load_cloud_queue_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_delete_on_load_cloud_queue_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">my_metadata</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_item_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">next_item_id</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="n">my_metadata</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resume_playback_and_check_frame_cache_usage</span><span class="p">()</span></div>

<div class="viewcode-block" id="GetItemWindowChecksFrameCacheTests.test_delete_on_skip_to_item_while_paused"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowChecksFrameCacheTests.test_delete_on_skip_to_item_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_delete_on_skip_to_item_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">my_metadata</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_item_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">next_item_id</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="n">my_metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resume_playback_and_check_frame_cache_usage</span><span class="p">()</span></div>

<div class="viewcode-block" id="GetItemWindowChecksFrameCacheTests.test_delete_on_skip_to_item_with_offset_while_paused"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowChecksFrameCacheTests.test_delete_on_skip_to_item_with_offset_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_delete_on_skip_to_item_with_offset_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">my_metadata</span> <span class="o">=</span> <span class="n">muse_session_mixin</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_item_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">next_item_id</span><span class="p">,</span>
                               <span class="n">position_millis</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                               <span class="n">track_metadata</span><span class="o">=</span><span class="n">my_metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resume_playback_and_check_frame_cache_usage</span><span class="p">()</span></div>

<div class="viewcode-block" id="GetItemWindowChecksFrameCacheTests.test_delete_on_skip_to_next_while_paused"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowChecksFrameCacheTests.test_delete_on_skip_to_next_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_delete_on_skip_to_next_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                               <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resume_playback_and_check_frame_cache_usage</span><span class="p">()</span></div>

<div class="viewcode-block" id="GetItemWindowChecksFrameCacheTests.test_delete_on_skip_to_previous_while_paused"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_itemwindow_fetch.GetItemWindowChecksFrameCacheTests.test_delete_on_skip_to_previous_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_delete_on_skip_to_previous_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_previous</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="c1"># The muse command fails because there isn&#39;t a previous track, but playback</span>
        <span class="c1"># should still start from the beginning of a new track. Therefore, the</span>
        <span class="c1"># frame cache should (still) not be used. The samples in the frame cache</span>
        <span class="c1"># correspond to the deleted track.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resume_playback_and_check_frame_cache_usage</span><span class="p">()</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">WorkflowTestSuite</span><span class="p">(</span><span class="s2">&quot;CloudQueue getItemWindow Tests&quot;</span><span class="p">)</span>
    <span class="c1"># suite.run([GetItemWindowTests()])</span>
    <span class="n">suite</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">GetItemWindowTests</span><span class="p">(),</span>
               <span class="n">GetItemWindowChecksFrameCacheTests</span><span class="p">()])</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>