
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>webserver.test_cloudqueue_end_of_queue_behavior &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for webserver.test_cloudqueue_end_of_queue_behavior</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functional tests for the different times a player may receive a response to</span>
<span class="sd">getItemWindow() while playing music. Each timing has a slightly different</span>
<span class="sd">expected result.</span>

<span class="sd">Tests require a local cloudQueue test server running on the testrunner</span>
<span class="sd">and the muse websocket endpoint on the player.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">sonos.client.websockets.event</span> <span class="k">import</span> <span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">PlaybackState</span><span class="p">,</span> <span class="n">Success</span><span class="p">,</span> <span class="n">Error</span><span class="p">,</span>
                                           <span class="n">MetadataStatusEvent</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">webserver.base_muse_fixture</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">BaseMuseFixture</span><span class="p">,</span> <span class="n">MuseClientFixtureMixin</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.suite</span> <span class="k">import</span> <span class="n">WorkflowTestSuite</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">wait_until_true</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">combinatorial</span>
<span class="kn">from</span> <span class="nn">upnp.api.queue.helpers</span> <span class="k">import</span> <span class="n">QueueServiceHelpers</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">upnp.helpers.queue_helper</span>
<span class="kn">from</span> <span class="nn">sonos.websrv</span> <span class="k">import</span> <span class="n">DEFAULT_TRACK_SOURCE_LOCATION</span>
<span class="kn">import</span> <span class="nn">track_source.http_track_source</span>
<span class="kn">from</span> <span class="nn">sonos.websrv</span> <span class="k">import</span> <span class="n">WebServer</span>
<span class="kn">from</span> <span class="nn">coherence.upnp.core</span> <span class="k">import</span> <span class="n">utils</span>


<span class="n">WINDOW_EDGE_SIZE</span> <span class="o">=</span> <span class="mi">3</span>


<span class="n">queue_helpers</span> <span class="o">=</span> <span class="n">QueueServiceHelpers</span><span class="p">()</span>
<span class="n">md_helper</span> <span class="o">=</span> <span class="n">upnp</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">queue_helper</span><span class="o">.</span><span class="n">QueueHelpers</span><span class="p">()</span>
<span class="n">webserver</span> <span class="o">=</span> <span class="n">track_source</span><span class="o">.</span><span class="n">http_track_source</span><span class="o">.</span><span class="n">HTTPTrackSource</span><span class="p">(</span><span class="n">DEFAULT_TRACK_SOURCE_LOCATION</span><span class="p">)</span>


<div class="viewcode-block" id="bool_generator"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.bool_generator">[docs]</a><span class="k">def</span> <span class="nf">bool_generator</span><span class="p">():</span>
    <span class="k">for</span> <span class="nb">bool</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">yield</span> <span class="nb">bool</span></div>


<div class="viewcode-block" id="itemWindow_reason_generator"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.itemWindow_reason_generator">[docs]</a><span class="k">def</span> <span class="nf">itemWindow_reason_generator</span><span class="p">():</span>
    <span class="n">reason</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.0</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;queueCompleted&quot;</span><span class="p">,),</span>
              <span class="mf">2.0</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;load+queueCompleted&quot;</span><span class="p">,</span> <span class="s2">&quot;pause&quot;</span><span class="p">),</span>
              <span class="mf">2.1</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;queueCompleted&quot;</span><span class="p">,</span> <span class="s2">&quot;pause&quot;</span><span class="p">),</span>
              <span class="mf">2.2</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;load+queueCompleted&quot;</span><span class="p">,</span> <span class="s2">&quot;pause&quot;</span><span class="p">)}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">reason</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span></div>


<span class="k">def</span> <span class="nf">_create_uri_and_metadata_xml</span><span class="p">(</span><span class="n">didl_info</span><span class="p">,</span> <span class="n">media_info</span><span class="p">):</span>
    <span class="n">uris</span> <span class="o">=</span> <span class="s1">&#39;&lt;URIs&gt;&#39;</span>
    <span class="k">for</span> <span class="n">didl</span><span class="p">,</span> <span class="n">media</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">didl_info</span><span class="p">,</span> <span class="n">media_info</span><span class="p">):</span>
        <span class="n">uris</span> <span class="o">+=</span> <span class="s1">&#39;&lt;URI uri=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">media</span><span class="p">)</span>
        <span class="n">uris</span> <span class="o">+=</span> <span class="n">didl</span>
        <span class="n">uris</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/URI&gt;&#39;</span>
    <span class="n">uris</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/URIs&gt;&#39;</span>
    <span class="k">return</span> <span class="n">uris</span>


<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl">[docs]</a><span class="k">class</span> <span class="nc">CloudqueueEndOfQueueBehaviorImpl</span><span class="p">(</span><span class="n">BaseMuseFixture</span><span class="p">):</span>
<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.setUpFixture"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CloudqueueEndOfQueueBehaviorImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.setUpTest"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CloudqueueEndOfQueueBehaviorImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.tearDownTest"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CloudqueueEndOfQueueBehaviorImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.tearDownFixture"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CloudqueueEndOfQueueBehaviorImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.set_up_one_track_cq_server"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.set_up_one_track_cq_server">[docs]</a>    <span class="k">def</span> <span class="nf">set_up_one_track_cq_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Set up the CQ server with only one track</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">track</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_single_track_itemwindow_fetch_in_queue_completion_without_preload_metadata"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_single_track_itemwindow_fetch_in_queue_completion_without_preload_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">test_single_track_itemwindow_fetch_in_queue_completion_without_preload_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player loads a CQ, plays the CQ tracks</span>
<span class="sd">        and transitions to the paused-at-end state when done, while there</span>
<span class="sd">        is only 1 track in the CQ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_up_one_track_cq_server</span><span class="p">()</span>
        <span class="n">real_md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                                                    <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                                    <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                    <span class="n">track_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">real_md</span><span class="p">[</span><span class="s1">&#39;durationMillis&#39;</span><span class="p">])),</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">filtered_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_logs</span><span class="p">),</span>
                               <span class="s2">&quot;Should have gotten an /itemWindow fetch while in queue completion&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_single_track_itemwindow_fetch_in_queue_completion_with_preload_metadata"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_single_track_itemwindow_fetch_in_queue_completion_with_preload_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">test_single_track_itemwindow_fetch_in_queue_completion_with_preload_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player uses firstTrackMetadata, plays the CQ to completion</span>
<span class="sd">        and transitions to the paused-at-end state when done, while there is only</span>
<span class="sd">        1 track in the CQ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_up_one_track_cq_server</span><span class="p">()</span>
        <span class="n">real_md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span>
                                                    <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                    <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                                                    <span class="n">track_metadata</span><span class="o">=</span><span class="n">real_md</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">real_md</span><span class="p">[</span><span class="s1">&#39;durationMillis&#39;</span><span class="p">])),</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">filtered_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_logs</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                               <span class="s2">&quot;Should have gotten at least 1 /itemWindow fetch while in queue completion&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_verify_end_of_queue_pause_play"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_verify_end_of_queue_pause_play">[docs]</a>    <span class="k">def</span> <span class="nf">test_verify_end_of_queue_pause_play</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-45131 fixes the behavior that this test was relying on to get to the end-of-queue</span>
<span class="sd">        paused state. We still want to test that paused state so I&#39;ve removed the itemwindow</span>
<span class="sd">        response manipulation and combined the pause and play check into one test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">start_cloud_queue_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                                         <span class="n">position_millis</span><span class="o">=</span><span class="mi">29000</span><span class="p">,</span>
                                         <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="sa">u</span><span class="s1">&#39;2&#39;</span><span class="p">),</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="c1"># Verify the private queue has changed to be 4</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_private_queueID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="s2">&quot;QueueId&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)[</span><span class="s1">&#39;NumberReturned&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span> <span class="ow">and</span>
                          <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">),</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_player_stays_paused_after_deleting_last_track"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_player_stays_paused_after_deleting_last_track">[docs]</a>    <span class="k">def</span> <span class="nf">test_player_stays_paused_after_deleting_last_track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-73017</span>
<span class="sd">        Verify that the player stays paused on the previous track if the last track in the queue</span>
<span class="sd">        is deleted while the player is in queue completion</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="c1"># wait until the player has entered queue completion</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                  <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                                <span class="s2">&quot;reason&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">]</span> <span class="ow">and</span>
                                                                                <span class="n">l</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;queueCompleted&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Should be a /itemWindow fetch with reason queueCompletion&quot;</span><span class="p">)</span>

        <span class="c1"># Delete the last track and verify the player is still paused after a refresh which</span>
        <span class="c1"># forces an /itemWindow fetch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                  <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                                <span class="s2">&quot;reason&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">]</span> <span class="ow">and</span>
                                                                                <span class="n">l</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;queueCompleted&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Should be another /itemWindow fetch after the refresh&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">30000</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_player_stays_paused_after_deleting_last_track_while_paused"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_player_stays_paused_after_deleting_last_track_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_player_stays_paused_after_deleting_last_track_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-70668</span>
<span class="sd">        Verify that if you remove the last track in the queue while paused on it, the player</span>
<span class="sd">        will stay paused on the second to last track at the end of the track</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                  <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="p">(</span><span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                                       <span class="n">logEntry</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;refresh&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Should be another /itemWindow fetch after the refresh&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">30000</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_player_stays_paused_after_deleting_last_track_before_queue_completion"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_player_stays_paused_after_deleting_last_track_before_queue_completion">[docs]</a>    <span class="k">def</span> <span class="nf">test_player_stays_paused_after_deleting_last_track_before_queue_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-70668</span>
<span class="sd">        Verify that if your remove while playing the last track in the queue before the player enters queue completion,</span>
<span class="sd">        it will pause on the second to last track </span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># restart the cloudqueue server with really long tracks so that the player doesn&#39;t immediately</span>
        <span class="c1"># enter queue completion when it starts playing the last track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/long_tracks&quot;</span><span class="p">)</span>
        <span class="n">md1_dur</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)[</span><span class="s2">&quot;durationMillis&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="p">(</span><span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                         <span class="n">logEntry</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;refresh&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Should be another /itemWindow fetch after the refresh&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                                                    <span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">-</span> <span class="n">md1_dur</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">past_events</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expect_event</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">BUFFERING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_player_idle_after_deleting_only_track_before_queue_completion"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_player_idle_after_deleting_only_track_before_queue_completion">[docs]</a>    <span class="k">def</span> <span class="nf">test_player_idle_after_deleting_only_track_before_queue_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-70668</span>
<span class="sd">        Verifies that the player goes to idle if you delete the only track in its queue while playing</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/long_tracks&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                  <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="p">(</span><span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                                       <span class="n">logEntry</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;refresh&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Should be another /itemWindow fetch after the refresh&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_player_idle_after_deleting_only_track_while_paused"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_player_idle_after_deleting_only_track_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_player_idle_after_deleting_only_track_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-70668</span>
<span class="sd">        Verifies that the player goes to idle if you delete the only track in its queue while paused</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                  <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="p">(</span><span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                                       <span class="n">logEntry</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;refresh&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Should be another /itemWindow fetch after the refresh&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_player_pauses_after_last_track_deleted_while_playing_second_to_last_track"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_player_pauses_after_last_track_deleted_while_playing_second_to_last_track">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">bool_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_player_pauses_after_last_track_deleted_while_playing_second_to_last_track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that if the last track in the queue is deleted, the player will pause on the second to</span>
<span class="sd">        last track even if you delete the last track after it has started to download</span>
<span class="sd">        :param refresh: </span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>

        <span class="c1"># wait until the the player starts to download the 4th track</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                  <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="s2">&quot;data/3&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;fullUrl&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;itemId 3 should have started to download&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">)</span>

        <span class="c1"># force an /itemWindow fetch via refreshCloudqueue is called for</span>
        <span class="k">if</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
            <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                  <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                                <span class="n">l</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;queueCompleted&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Should be another /itemWindow fetch after the refresh&quot;</span><span class="p">)</span>

        <span class="c1"># either way, the player should end up paused on itemId 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">30000</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_reordering_tracks_in_shared_queue_completion"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_reordering_tracks_in_shared_queue_completion">[docs]</a>    <span class="k">def</span> <span class="nf">test_reordering_tracks_in_shared_queue_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-13323</span>
<span class="sd">        Verify that the player doesn&#39;t repeat the last track in the shared queue if a track is moved</span>
<span class="sd">        to the last track position while playing the last few seconds of the track</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start playback from the webserver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">()</span>
        <span class="n">track_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_source</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
            <span class="n">track_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
        <span class="n">track_list_md</span> <span class="o">=</span> <span class="n">queue_helpers</span><span class="o">.</span><span class="n">create_didl_lite_md</span><span class="p">(</span><span class="n">track_list</span><span class="p">)</span>
        <span class="n">enqueued_uris_and_metadata</span> <span class="o">=</span> <span class="n">queue_helpers</span><span class="o">.</span><span class="n">create_uri_and_metadata_xml</span><span class="p">(</span><span class="n">track_list</span><span class="p">,</span> <span class="n">track_list_md</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddMultipleURIs</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">container_uri</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                      <span class="n">container_metadata</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                      <span class="n">desired_first_track_number_enqueued</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="n">enqueue_as_next</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">number_of_uris</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">track_list</span><span class="p">),</span>
                                      <span class="n">enqueued_uris_and_metadata</span><span class="o">=</span><span class="n">enqueued_uris_and_metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Seek towards the end of the track to save time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:02:56&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">176000</span><span class="p">))</span>
        <span class="c1"># Let it play for a couple of seconds</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:03:00&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># Move the first and currently heard track to the last track in the queue position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">ReorderTracks</span><span class="p">(</span><span class="n">queueid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">updateid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                       <span class="n">startingindex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberoftracks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">insertbefore</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;Track 1 should now be track 5&quot;</span><span class="p">)</span>

        <span class="c1"># Verify that the player is IDLE when playback is done and that the playhead has wrapped</span>
        <span class="c1"># to the track 1 position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;Playhead should have wrapped to the top of the queue&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_play_after_last_queue_track_deletion"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_play_after_last_queue_track_deletion">[docs]</a>    <span class="k">def</span> <span class="nf">test_play_after_last_queue_track_deletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-48214</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                         <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                         <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;11&quot;</span><span class="p">,</span>
                                         <span class="n">position_millis</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>
                                         <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;11&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s1">&#39;11&#39;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="c1"># The play head should reset to the beginning of the queue, not the beginning of the window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">item_id</span><span class="o">==</span><span class="s1">&#39;0&#39;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span><span class="o">==</span><span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_play_last_track_after_track_deletion"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_play_last_track_after_track_deletion">[docs]</a>    <span class="k">def</span> <span class="nf">test_play_last_track_after_track_deletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-70241</span>
<span class="sd">        Verify that the last track in the queue is played if the second to last track is deleted</span>
<span class="sd">        after the last track has started to play</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">MetadataStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">md3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">)[</span><span class="s2">&quot;album&quot;</span><span class="p">]</span>
        <span class="c1"># SWPBL-74358</span>
        <span class="k">del</span> <span class="n">md3</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">][</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">md3</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:27&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="c1"># Delete the second to last track and verify that the last track naturally plays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">MetadataStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;album&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">current_item</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">]</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">current_item</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;album&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">md3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">past_events</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_play_last_track_after_track_deletion_via_upnp"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_play_last_track_after_track_deletion_via_upnp">[docs]</a>    <span class="k">def</span> <span class="nf">test_play_last_track_after_track_deletion_via_upnp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-70241</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">MetadataStatusEvent</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">)</span>
        <span class="c1"># Set up the constants needed further down</span>
        <span class="n">shared_queue_uri</span> <span class="o">=</span> <span class="s2">&quot;x-rincon-queue:</span><span class="si">{}</span><span class="s2">#</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">workspace</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;WORKSPACE&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">workspace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Unable to start local CloudQueue server because the environment variable $WORKSPACE is not set&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">resource_path</span> <span class="o">=</span> <span class="s2">&quot;/tmp/cloudqueue/&quot;</span>
        <span class="n">resource_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">resource_path</span> <span class="o">+</span> <span class="s2">&quot;/*.mp3&quot;</span><span class="p">)</span>
        <span class="n">didl_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">media_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">track</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Start up the server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span> <span class="o">=</span> <span class="n">WebServer</span><span class="p">(</span><span class="n">start_reactor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">8080</span><span class="p">,</span> <span class="n">resource_path</span><span class="p">)</span>
        <span class="n">served_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">resource_files</span><span class="p">:</span>
            <span class="n">served_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;http://</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">host</span><span class="p">(),</span>
                                                      <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

        <span class="c1"># Make the didl metadata and media url for each track to be fed into the queue</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">didl_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">md_helper</span><span class="o">.</span><span class="n">generate_didl_lite</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;track_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">track</span><span class="p">),</span>
                                                          <span class="n">svc_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                          <span class="n">acct_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                          <span class="n">upnp_class</span><span class="o">=</span><span class="s2">&quot;object.item.audioItem.musicTrack&quot;</span><span class="p">,</span>
                                                          <span class="n">artist</span><span class="o">=</span><span class="s2">&quot;artist_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">track</span><span class="p">),</span>
                                                          <span class="n">album</span><span class="o">=</span><span class="s2">&quot;album_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">track</span><span class="p">),</span>
                                                          <span class="n">aa_uri</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">media_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">served_files</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
            <span class="n">track</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Create the two track lists we&#39;re going to use</span>
        <span class="n">track_list_before</span> <span class="o">=</span> <span class="n">_create_uri_and_metadata_xml</span><span class="p">(</span><span class="n">didl_info</span><span class="p">,</span> <span class="n">media_info</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">didl_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">media_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">track_list_after</span> <span class="o">=</span> <span class="n">_create_uri_and_metadata_xml</span><span class="p">(</span><span class="n">didl_info</span><span class="p">,</span> <span class="n">media_info</span><span class="p">)</span>

        <span class="c1"># Load and play the first track list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddMultipleURIs</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">container_uri</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                      <span class="n">container_metadata</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                      <span class="n">desired_first_track_number_enqueued</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="n">enqueue_as_next</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">number_of_uris</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">media_info</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="n">enqueued_uris_and_metadata</span><span class="o">=</span><span class="n">track_list_before</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetAVTransportURI</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">shared_queue_uri</span><span class="p">,</span>
                                              <span class="n">metadata</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Make sure we&#39;re playing the right track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TRACK_NR&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:20&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:27&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

        <span class="c1"># Do a queue replacement with the deleted second to last track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">ReplaceAllTracks</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                       <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                       <span class="n">container_uri</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                       <span class="n">container_metadata</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                       <span class="n">current_track_index</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                       <span class="n">new_current_track_indices</span><span class="o">=</span><span class="s2">&quot;2,0,3&quot;</span><span class="p">,</span>
                                       <span class="n">number_of_uris</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">media_info</span><span class="p">),</span>
                                       <span class="n">enqueued_uris_and_metadata</span><span class="o">=</span><span class="n">track_list_after</span><span class="p">)</span>

        <span class="c1"># Verify that the last track is playing</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:01&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">MetadataStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;album&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">current_item</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">]</span> <span class="ow">and</span>
                                                     <span class="n">e</span><span class="o">.</span><span class="n">current_item</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;track_4&quot;</span><span class="p">))</span>

        <span class="c1"># Cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_seek_after_adding_short_track_to_end_of_queue"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_seek_after_adding_short_track_to_end_of_queue">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek_after_adding_short_track_to_end_of_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-69456</span>
<span class="sd">        Verify that the player is able to seek after adding a short track to the end of the queue</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/short_length&quot;</span><span class="p">)</span>

        <span class="c1"># Create a dict of how the tracks are arranged on the server</span>
        <span class="n">md0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">md0</span><span class="p">[</span><span class="s2">&quot;durationMillis&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;10000&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;10000&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;1000&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;10000&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># add the short track to the end while playing</span>
        <span class="c1"># make sure we get a /itemWindow fetch after the refresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;1000&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">timePlayed_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                             <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span><span class="p">,</span>
                                                                             <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                             <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timePlayed_log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                   <span class="s2">&quot;There should have been a /itemWindow fetch&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;10000&quot;</span><span class="p">],</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">track</span><span class="p">[</span><span class="s2">&quot;10000&quot;</span><span class="p">]</span> <span class="ow">and</span>
                                                    <span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_seek_after_deleting_short_track_from_end_of_queue"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_seek_after_deleting_short_track_from_end_of_queue">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek_after_deleting_short_track_from_end_of_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-69456</span>
<span class="sd">        Verify that the player is able to seek after removing a short track at the end of the queue</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/short_length&quot;</span><span class="p">)</span>

        <span class="c1"># Create a dict of how the tracks are arranged on the server</span>
        <span class="n">md0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">md0</span><span class="p">[</span><span class="s2">&quot;durationMillis&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;10000&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;10000&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;10000&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Delete the short track at the end of the queue</span>
        <span class="c1"># Make sure the player makes a /itemWindow fetch after the refresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;1000&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">timePlayed_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                                             <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logEntry</span><span class="p">:</span> <span class="n">logEntry</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span><span class="p">,</span>
                                                                             <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                                             <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timePlayed_log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;There should have been a /itemWindow fetch&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                       <span class="n">item_id</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;10000&quot;</span><span class="p">],</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">track</span><span class="p">[</span><span class="s2">&quot;10000&quot;</span><span class="p">]</span> <span class="ow">and</span>
                                                    <span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_deleting_buffered_tracks_should_not_cause_player_to_event_only_last_track"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_deleting_buffered_tracks_should_not_cause_player_to_event_only_last_track">[docs]</a>    <span class="k">def</span> <span class="nf">test_deleting_buffered_tracks_should_not_cause_player_to_event_only_last_track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-73868</span>
<span class="sd">        Verify that the player events the correct playback status and metadata events if buffered tracks</span>
<span class="sd">        are deleted while the player is playing</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/short_length&quot;</span><span class="p">)</span>

        <span class="c1"># Create a dict of how the tracks are initialized on the server</span>
        <span class="n">md0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">md0</span><span class="p">[</span><span class="s2">&quot;durationMillis&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;10000&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;10000&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span>

        <span class="c1"># Add another one second and 10 second track to the end of the playlist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;1000&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;10000&quot;</span><span class="p">])</span>
        <span class="c1"># Get the one-based second to last track id</span>
        <span class="n">last_track_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;1000&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="c1"># Load and play the first 10 second track first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;10000&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Wait until the last track has started to buffer, which means all the one second tracks</span>
        <span class="c1"># has already been buffered</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="s2">&quot;data/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">last_track_id</span><span class="p">))</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;fullUrl&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span>
                                   <span class="s2">&quot;If the player has not started to cache the last track within the duration&quot;</span>
                                   <span class="s2">&quot; of the first track then something has gone wrong&quot;</span><span class="p">)</span>

        <span class="c1"># Return 304 to any /itemWindow requests so that the player doesn&#39;t override the existing</span>
        <span class="c1"># queue with one that has the deleted track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">arm_error_script</span><span class="p">(</span><span class="n">call</span><span class="o">=</span><span class="s2">&quot;itemWindow&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mi">304</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Remove the second of the 1 second tracks and verify the new number of total tracks</span>
        <span class="c1"># startingIndex is 1-based</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_private_queueID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_track_from_queue</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">queueId</span><span class="o">=</span><span class="n">ids</span><span class="p">[</span><span class="s2">&quot;QueueId&quot;</span><span class="p">],</span> <span class="n">updateId</span><span class="o">=</span><span class="n">ids</span><span class="p">[</span><span class="s2">&quot;UpdateID&quot;</span><span class="p">],</span>
                                     <span class="n">startingIndex</span><span class="o">=</span><span class="n">last_track_id</span><span class="p">,</span> <span class="n">numberOfTracks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">totalTracks</span><span class="o">=</span><span class="s2">&quot;3&quot;</span><span class="p">)</span>

        <span class="c1"># Verify that the player progressed to the first 1 second track</span>
        <span class="c1"># Verify that the metadata of the 1 second track matches expectations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;1000&quot;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;ZP is playing track </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">MetadataStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">current_item</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;One Second&quot;</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">current_item</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">track</span><span class="p">[</span><span class="s2">&quot;1000&quot;</span><span class="p">]))</span>

        <span class="c1"># SWPBL-78220</span>
        <span class="c1"># Delete the buffered track and attempt to skip back to the first track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_track_id</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;1000&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">refresh_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="c1"># Wait until the last track has started to buffer</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="s2">&quot;data/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">last_track_id</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;fullUrl&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;The last track in the queue has started to buffer&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">last_track_id</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">last_track_id</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_previous</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">track</span><span class="p">[</span><span class="s2">&quot;10000&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_skip_next_with_short_track_at_end_of_queue"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_skip_next_with_short_track_at_end_of_queue">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_next_with_short_track_at_end_of_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-78158</span>
<span class="sd">        SWPBL-75348</span>
<span class="sd">        Verifies that the player will correctly skip to a short track if that track is cached and player</span>
<span class="sd">        enters queue completion before its heard</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/short_length&quot;</span><span class="p">)</span>

        <span class="c1"># Create a dict of how the tracks are initialized on the server</span>
        <span class="n">md0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">md0</span><span class="p">[</span><span class="s2">&quot;durationMillis&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;10000&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;10000&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span>

        <span class="c1"># Load and play the first 10 second track first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;10000&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Wait until the last track has started to buffer</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="s2">&quot;data/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;1000&quot;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;fullUrl&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;The last track in the queue has started to buffer&quot;</span><span class="p">)</span>

        <span class="c1"># Verify the player is still playing the 10 sec track</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;10000&quot;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;ZP is playing track </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]))</span>

        <span class="c1"># Verify that we&#39;re able to skip to the short track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_next</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">track</span><span class="p">[</span><span class="s2">&quot;1000&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_player_skips_back_after_buffered_track_is_deleted"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_player_skips_back_after_buffered_track_is_deleted">[docs]</a>    <span class="k">def</span> <span class="nf">test_player_skips_back_after_buffered_track_is_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-78220</span>
<span class="sd">        Verify that the player is able to skip to previous if the last track in the queue</span>
<span class="sd">        has started to buffer and then is deleted</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Wait until the last track has started to buffer</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                  <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="s2">&quot;data/2&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;fullUrl&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                   <span class="s2">&quot;The last track in the queue has started to buffer&quot;</span><span class="p">)</span>

        <span class="c1"># Delete the buffered track and attempt to skip back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">delete_track</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_previous</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_seek_while_in_queue_completion"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_seek_while_in_queue_completion">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek_while_in_queue_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-69456</span>
<span class="sd">        SWPBL-69512</span>
<span class="sd">        Verify that the player makes an /itemWindow request with &#39;queueCompleted&#39; reason</span>
<span class="sd">        every time a track is scrubbed while in queue completion</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load, skip, and seek to the last 10 seconds of the last track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">skip_to_item</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                               <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
                               <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span>

        <span class="c1"># For each seek back, the player should make an itemWindow request with reason &#39;queueCompletion&#39;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">clear_log</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">position_millis</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
            <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                  <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                                <span class="n">l</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;queueCompleted&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyLessEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Player should have made an itemWindow request with &#39;queueCompleted&quot;</span>
                                          <span class="s2">&quot; as the reason&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_no_excessive_itemWindow_requests_in_window_edge"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_no_excessive_itemWindow_requests_in_window_edge">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_excessive_itemWindow_requests_in_window_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-69512</span>
<span class="sd">        This test mimics the alexa bridge. The window on the player does not have the final track</span>
<span class="sd">        but there is nothing to play beyond the initial window since we are forcing a 304 to that request.</span>

<span class="sd">        Outline of Test Steps:</span>
<span class="sd">            1. Add 15 tracks to queue (5 tracks ahead of default window size). The first track is a 10 second</span>
<span class="sd">            track, followed by 14 1-second tracks.</span>
<span class="sd">            2. laodCloudQueue on the first track with playOnCompletion=true (no metadata)</span>
<span class="sd">            3. Arm the error script to return 304 for all window requests. This means the player&#39;s window won&#39;t</span>
<span class="sd">            change throughout the course of the test. The window size should be 10.</span>
<span class="sd">            4. Wait for the player to play to the end of the window.</span>

<span class="sd">        The player should make one window fetch with reason=refresh for each track in the window edge</span>
<span class="sd">        (3 tracks - 7, 8, 9).</span>

<span class="sd">        The player should make one window fetch with reason=queueCompleted at the end of the last track.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/short_length&quot;</span><span class="p">)</span>

        <span class="n">start_track</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">end_track</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">window_edge_start</span> <span class="o">=</span> <span class="n">end_track</span> <span class="o">-</span> <span class="n">WINDOW_EDGE_SIZE</span>

        <span class="c1"># Add a bunch of the 1 second track to the end</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_track</span> <span class="o">+</span> <span class="mi">5</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="n">start_track</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">)</span>

        <span class="c1"># Make sure the player fetched the initial window</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                       <span class="n">l</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;load&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span>
            <span class="s2">&quot;Got expected number of itemWindow requests with reason &#39;load&#39;? (one on initial track)&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure the player&#39;s known window doesn&#39;t change during the test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">arm_error_script</span><span class="p">(</span><span class="n">call</span><span class="o">=</span><span class="s2">&quot;itemWindow&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mi">304</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># Verify we play to the end of the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">)</span>

        <span class="c1"># Make sure we got one queueCompleted request for the final track (10)</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                       <span class="n">l</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;queueCompleted&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span>
            <span class="s2">&quot;Got expected number of itemWindow requests with reason &#39;queueCompleted&#39;? (one at end)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">end_track</span><span class="p">),</span> <span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;queryParams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;itemId&quot;</span><span class="p">),</span>
            <span class="s2">&quot;Window fetch with reason=queueCompleted was made at the end of the last track?&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure we got only one refresh for each track in the window edge (tracks 7, 8, 9)</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">window_edge_start</span><span class="p">,</span> <span class="n">end_track</span><span class="p">):</span>
            <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                           <span class="n">l</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;refresh&quot;</span> <span class="ow">and</span>
                                           <span class="n">l</span><span class="p">[</span><span class="s2">&quot;queryParams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;itemId&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span>
               <span class="s2">&quot;Got expected number of itemWindow requests with reason &#39;refresh&#39;?&quot;</span>
               <span class="s2">&quot; (for track </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2"> in window edge)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">end_track</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_load_play_short_track_at_end_of_queue"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_load_play_short_track_at_end_of_queue">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="n">itemWindow_reason_generator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_load_play_short_track_at_end_of_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">request_reason</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-89959, SWPBL-90347, SWPBL-45131</span>
<span class="sd">        Verify that if the last track is short (&lt;7 seconds), the player will make an itemWindow</span>
<span class="sd">        request with reason=queueCompleted</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Restart the server with the short tracks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/short_length&quot;</span><span class="p">,</span>
                                      <span class="n">endpoint_version</span><span class="o">=</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_playback_policy</span><span class="p">({</span><span class="s2">&quot;pauseAtEndOfQueue&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                             <span class="s2">&quot;notifyUserIntent&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="c1"># Organize the playlist so a 1 sec track is the last track</span>
        <span class="n">md0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">md0</span><span class="p">[</span><span class="s2">&quot;durationMillis&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;10000&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;10000&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;1000&quot;</span><span class="p">])</span>

        <span class="c1"># Load on the last track and verify that it plays and pauses at end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">),</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span>

        <span class="c1"># Verify that the player makes itemWindow requests with all expected reasons</span>
        <span class="c1"># v1.0 - only request should have reason=&quot;queueCompleted&quot;</span>
        <span class="c1"># v2.0 - the &quot;reason&quot; query parameter was not part of the v2.0 specification. Therefore, the player</span>
        <span class="c1">#       uses the normal v2.2 behavior and sends the concatenated reason.</span>
        <span class="c1"># v2.1 - reason was added to CQ specification in v2.1. However, there was no general way to</span>
        <span class="c1">#       concatenate requests. As a result, the player must make two requests to send all of the data.</span>
        <span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="n">request_reason</span><span class="p">:</span>
            <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                        <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s1">&#39;queryParams&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reason&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">reason</span><span class="p">),</span>
                                                        <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span>
                                       <span class="s2">&quot;With server version </span><span class="si">{}</span><span class="s2">, should be a /itemWindow fetch w/ reason=&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span>
                                                                                                                     <span class="n">reason</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudqueueEndOfQueueBehaviorImpl.test_load_play_short_track_at_end_of_queue_v2_1_handlesRetry"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehaviorImpl.test_load_play_short_track_at_end_of_queue_v2_1_handlesRetry">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_play_short_track_at_end_of_queue_v2_1_handlesRetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-89959, SWPBL-90347</span>
<span class="sd">        Verify that if the last track is short (&lt;7 seconds), the player will make an itemWindow</span>
<span class="sd">        request with reason=queueCompleted</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Restart the server with the short tracks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="n">library_path</span><span class="o">=</span><span class="s2">&quot;/smapi/short_length&quot;</span><span class="p">,</span> <span class="n">endpoint_version</span><span class="o">=</span><span class="mf">2.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">set_playback_policy</span><span class="p">({</span><span class="s2">&quot;pauseAtEndOfQueue&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                             <span class="s2">&quot;notifyUserIntent&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="c1"># Organize the playlist so a 1 sec track is the last track</span>
        <span class="n">md0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">md0</span><span class="p">[</span><span class="s2">&quot;durationMillis&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;10000&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;10000&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">add_track_to_end</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;1000&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">arm_error_script</span><span class="p">(</span><span class="n">call</span><span class="o">=</span><span class="s2">&quot;itemWindow&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">retry_after_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Load on the last track and verify that it plays and pauses at end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">),</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span>

        <span class="c1"># Verify that the player makes itemWindow requests with all expected reasons</span>
        <span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;queueCompleted&quot;</span><span class="p">,):</span>
            <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
                                                        <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/itemWindow&#39;</span> <span class="ow">and</span>
                                                                      <span class="n">reason</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;queryParams&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reason&#39;</span><span class="p">)),</span>
                                                        <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                              <span class="s2">&quot;Should be one /itemWindow fetch w/ reason=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="CloudqueueEndOfQueueBehavior"><a class="viewcode-back" href="../../webserver.html#webserver.test_cloudqueue_end_of_queue_behavior.CloudqueueEndOfQueueBehavior">[docs]</a><span class="k">class</span> <span class="nc">CloudqueueEndOfQueueBehavior</span><span class="p">(</span><span class="n">CloudqueueEndOfQueueBehaviorImpl</span><span class="p">,</span> <span class="n">MuseClientFixtureMixin</span><span class="p">):</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NIGHTLY_CQ&#39;</span><span class="p">]</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">WorkflowTestSuite</span><span class="p">(</span><span class="s2">&quot;Cloudqueue end of queue behavior tests&quot;</span><span class="p">)</span>
    <span class="n">suite</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">CloudqueueEndOfQueueBehavior</span><span class="p">()])</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>