
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>webserver.muse_groups_namespace &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for webserver.muse_groups_namespace</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sonos.client.websockets.event</span> <span class="k">import</span> <span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">Success</span><span class="p">,</span> <span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">GroupInfoEvent</span><span class="p">,</span> <span class="n">PlaybackState</span><span class="p">,</span>
                                           <span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">PlaybackError</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">webserver.base_muse_fixture</span> <span class="k">import</span> <span class="p">(</span><span class="n">BaseMuseFixture</span><span class="p">,</span> <span class="n">MuseClientFixtureMixin</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.suite</span> <span class="k">import</span> <span class="n">WorkflowTestSuite</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">ifilter</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.saved_generators</span> <span class="k">import</span> <span class="n">SavedWorkflowGenerators</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">combinatorial</span><span class="p">,</span> <span class="n">skip</span>
<span class="kn">from</span> <span class="nn">Queue</span> <span class="k">import</span> <span class="n">Empty</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">common.utils</span> <span class="k">import</span> <span class="n">is_locked_build</span>
<span class="kn">import</span> <span class="nn">track_source.http_track_source</span>
<span class="kn">from</span> <span class="nn">sonos.websrv</span> <span class="k">import</span> <span class="n">DEFAULT_TRACK_SOURCE_LOCATION</span>
<span class="kn">import</span> <span class="nn">webserver.helpers.node_smapi_control</span>

<span class="c1"># This namespace was implemented in SWPBL-62582</span>
<span class="c1"># Documented here: https://confluence.sonos.com/pages/viewpage.action?pageId=89311531</span>
<span class="n">smapi_ctl</span> <span class="o">=</span> <span class="n">webserver</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">node_smapi_control</span><span class="o">.</span><span class="n">NodeSmapiControl</span><span class="p">()</span>


<div class="viewcode-block" id="smapi_queue_setup_and_play"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.smapi_queue_setup_and_play">[docs]</a><span class="k">def</span> <span class="nf">smapi_queue_setup_and_play</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;00&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the player queue based on desired number of tracks</span>
<span class="sd">    :param zp: player object</span>
<span class="sd">    :param num_tracks: number of tracks to add to the queue</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">()</span>
    <span class="n">track_indices</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tracks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Add three tracks to the queue.</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">track_indices</span><span class="p">:</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">enqueueduri</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">SMAPI_SERVER_TRACK_URIS</span><span class="p">[</span><span class="n">track</span><span class="p">],</span>
                        <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">SMAPI_TRACK_METADATA</span><span class="p">[</span><span class="n">track</span><span class="p">],</span>
                        <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">enqueueasnext</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="c1"># Wait for the queue status to be reflected in the zp</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="n">starting_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="n">requested_count</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="s2">&quot;NumberReturned&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">track_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">)))</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">)),</span>
                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="MuseGroupsNamespaceTestsImpl"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTestsImpl">[docs]</a><span class="k">class</span> <span class="nc">MuseGroupsNamespaceTestsImpl</span><span class="p">(</span><span class="n">BaseMuseFixture</span><span class="p">):</span>
<div class="viewcode-block" id="MuseGroupsNamespaceTestsImpl.setUpFixture"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTestsImpl.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseGroupsNamespaceTestsImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;groups&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">():</span>
                <span class="n">d</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">()</span>
                <span class="n">d</span><span class="o">.</span><span class="n">GroupRenderingControl</span><span class="o">.</span><span class="n">SetGroupVolume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">GroupRenderingControl</span><span class="o">.</span><span class="n">SetGroupMute</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">raw_udn</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceTestsImpl.setUpTest"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTestsImpl.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseGroupsNamespaceTestsImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceTestsImpl.tearDownTest"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTestsImpl.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseGroupsNamespaceTestsImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceTestsImpl.tearDownFixture"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTestsImpl.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseGroupsNamespaceTestsImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;groups&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceTestsImpl.test_subscribe_groups"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTestsImpl.test_subscribe_groups">[docs]</a>    <span class="k">def</span> <span class="nf">test_subscribe_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that subscribing to the namespace results in a groupsStatus event</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the values from the /info endpoint first</span>
        <span class="n">apiVersion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;apiVersion&quot;</span><span class="p">)</span>
        <span class="n">minApiVersion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;minApiVersion&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># SWPBL-69561</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">GroupsEvent</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">player</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">players</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">minApiVersion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                                              <span class="s2">&quot;minApiVersion field should not be empty&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotInOrFailCase</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">player</span><span class="o">.</span><span class="n">minApiVersion</span><span class="p">,</span>
                                               <span class="s2">&quot;minApiVersion should not have buildinfo&quot;</span><span class="p">)</span>
                    <span class="c1"># Added the following verifications for SWPBL-78544</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">apiVersion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                                              <span class="s2">&quot;apiVersion field should not be empty&quot;</span><span class="p">)</span>
                    <span class="c1">#SWPBL-83629</span>
                    <span class="k">if</span> <span class="n">player</span><span class="o">.</span><span class="n">isUnregistered</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">isUnregistered</span><span class="p">,</span>
                                                  <span class="s2">&quot;isUnregistered for </span><span class="si">{}</span><span class="s2"> is populated, should be true&quot;</span>
                                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">id</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceTestsImpl.test_unsubscribe_groups"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTestsImpl.test_unsubscribe_groups">[docs]</a>    <span class="k">def</span> <span class="nf">test_unsubscribe_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies the unsubscribe command</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Success</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceTestsImpl.test_invalid_hhid"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTestsImpl.test_invalid_hhid">[docs]</a>    <span class="k">def</span> <span class="nf">test_invalid_hhid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies the error event after using a bad hhid</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="s2">&quot;BAD_HHID&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_INVALID_OBJECT_ID&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceTestsImpl.test_getGroups"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTestsImpl.test_getGroups">[docs]</a>    <span class="k">def</span> <span class="nf">test_getGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the getGroups command returns a groupsStatus event</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Skip this test if running on locked builds</span>
        <span class="c1"># Reasoning is that not all players on a testbed is supported by a specific release branch</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds might not have support for all players on the testbed&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="c1"># The event parser implicitly verifies that this command returns non-empty fields for:</span>
        <span class="c1"># *groups</span>
        <span class="c1"># *players</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Verify each player&#39;s id/group&#39;s GC listed in the event</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">coordinatorId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                    <span class="s2">&quot;Each group&#39;s GC should match a player on the testbed&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">player</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">players</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                    <span class="s2">&quot;Each player&#39;s id should match a player on the testbed&quot;</span><span class="p">)</span>
        <span class="c1"># Verify quantity of player/group objects in the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groups</span><span class="p">),</span>
                                   <span class="s2">&quot;Each group should be its own GC so the number of groups listed&quot;</span>
                                   <span class="s2">&quot;in the event should equal number of players on the testbed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">players</span><span class="p">),</span>
                                   <span class="s2">&quot;Number of players listed in the event should equal number of players&quot;</span>
                                   <span class="s2">&quot;on the testbed&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceTestsImpl.test_verify_playerIds_after_grouping_ungrouping"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTestsImpl.test_verify_playerIds_after_grouping_ungrouping">[docs]</a>    <span class="k">def</span> <span class="nf">test_verify_playerIds_after_grouping_ungrouping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that the groupsStatus event reflects accurate group names and playerIds after</span>
<span class="sd">        grouping and ungrouping</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Select a second ZP to use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span> <span class="o">=</span> <span class="n">ifilter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()</span>
                       <span class="ow">and</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">is_bonded</span><span class="p">()</span>
                       <span class="ow">and</span> <span class="n">d</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;No second playable ZP found&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure each ZP is its own GC</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="p">]:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">()</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">GroupManagement</span><span class="o">.</span><span class="n">is_group_coordinator_local</span><span class="p">())</span>

        <span class="c1"># Store each of the 2 ZPs&#39; playerId</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;playerId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;playerId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}]</span>

        <span class="c1"># Store each of the 2 ZPs&#39; group name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">player</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">players</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="n">zp</span><span class="p">[</span><span class="s2">&quot;playerId&quot;</span><span class="p">]:</span>
                    <span class="n">zp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Group the second ZP into the first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>

        <span class="c1"># Verify that the new group has both ZPs&#39; playerIds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">zp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; + 1&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">playerIds</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">([</span><span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;playerId&quot;</span><span class="p">],</span>
                                                                                         <span class="n">zps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;playerId&quot;</span><span class="p">]])),</span>
                                               <span class="s2">&quot;PlayerId for group </span><span class="si">{}</span><span class="s2"> should include </span><span class="si">{}</span><span class="s2">&quot;</span>
                                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; + 1&quot;</span><span class="p">,</span>
                                                       <span class="p">[</span><span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;playerId&quot;</span><span class="p">],</span>
                                                        <span class="n">zps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;playerId&quot;</span><span class="p">]]))</span>

        <span class="c1"># Ungroup and make each ZP its own GC again</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp2</span><span class="p">]:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">()</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">GroupManagement</span><span class="o">.</span><span class="n">is_group_coordinator_local</span><span class="p">())</span>

        <span class="c1"># Verify that each of the 2 ZPs&#39; playerIds match the original player name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">playerIds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">zp</span><span class="p">[</span><span class="s2">&quot;playerId&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="n">zp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                            <span class="s2">&quot;name for playerId </span><span class="si">{}</span><span class="s2"> should be </span><span class="si">{}</span><span class="s2">&quot;</span>
                                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">[</span><span class="s2">&quot;playerId&quot;</span><span class="p">],</span>
                                                    <span class="n">zp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceTestsImpl.test_players_object_reflects_stereo_pair"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTestsImpl.test_players_object_reflects_stereo_pair">[docs]</a>    <span class="k">def</span> <span class="nf">test_players_object_reflects_stereo_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-69941</span>
<span class="sd">        Verify that only the master ZP in a stereo pair shows up in the players object</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Try to get all the devices, skip if it can&#39;t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_all</span><span class="p">()</span>
        <span class="n">zp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">zp_r</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">SavedWorkflowGenerators</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">generate_testbed_stereo_pairable_devices</span><span class="p">(</span><span class="n">stop_on_fail</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">player</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">:</span>
            <span class="n">zp</span> <span class="o">=</span> <span class="n">player</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">zp_r</span> <span class="o">=</span> <span class="n">player</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">zp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">zp_r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Missing required devices&quot;</span><span class="p">)</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">add_stereo_pair</span><span class="p">(</span><span class="n">zp_r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span> <span class="o">=</span> <span class="n">zp</span>

        <span class="c1"># Verify that the stereo pairing worked</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">is_left_channel</span><span class="p">(),</span>
                                  <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be the left channel of the stero pair&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">zp_r</span><span class="o">.</span><span class="n">is_right_channel</span><span class="p">(</span><span class="n">zp</span><span class="p">),</span>
                                  <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be the right channel of the stero pair&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp_r</span><span class="p">))</span>

        <span class="c1"># Get the groups event and make a dict of each player&#39;s {udn:name}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">players</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">player</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">players</span><span class="p">:</span>
            <span class="n">players</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Verify that only the left channel shows up in the players object and</span>
        <span class="c1"># that the left channel&#39;s room name is as expected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">players</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                <span class="s2">&quot;Left channel ZP should in the players object&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">get_zone_name</span><span class="p">(),</span> <span class="n">players</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">],</span>
                                   <span class="s2">&quot;Player name should match&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotInOrFailCase</span><span class="p">(</span><span class="n">zp_r</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">players</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                   <span class="s2">&quot;Right channel ZP should not be in the players object&quot;</span><span class="p">)</span>

        <span class="c1"># Cleanup</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceTestsImpl.test_players_object_reflects_surround_config"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTestsImpl.test_players_object_reflects_surround_config">[docs]</a>    <span class="k">def</span> <span class="nf">test_players_object_reflects_surround_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-69941</span>
<span class="sd">        Verify that only the master ZP in a surround config shows up in the players object</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Try to get all the needed devices, skip the test if it can&#39;t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_all</span><span class="p">()</span>
        <span class="n">ht</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">surround</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="o">.</span><span class="n">generate_testbed_ht_master_satellite_capable_devices</span><span class="p">(</span><span class="n">stop_on_fail</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">player</span> <span class="ow">in</span> <span class="n">surround</span><span class="p">:</span>
            <span class="n">ht</span> <span class="o">=</span> <span class="n">player</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="n">player</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sr</span> <span class="o">=</span> <span class="n">player</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">ht</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sl</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Missing required devices&quot;</span><span class="p">)</span>
        <span class="n">ht</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">create_50_config</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span> <span class="o">=</span> <span class="n">ht</span>

        <span class="c1"># Verify that the satellites are bonded</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sl</span><span class="p">,</span> <span class="n">sr</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">is_satellite</span><span class="p">(),</span>
                                      <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be a satellite&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

        <span class="c1"># Get the groups event and make a dict of each player&#39;s {udn:name}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">players</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">player</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">players</span><span class="p">:</span>
            <span class="n">players</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Verify that the ht ZP is in the players pbject and that the room name is correct</span>
        <span class="c1"># Verify that the satellites are not in the players object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">players</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should in the players object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ht</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">get_zone_name</span><span class="p">(),</span> <span class="n">players</span><span class="p">[</span><span class="n">ht</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">],</span>
                                   <span class="s2">&quot;Player name should match&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sl</span><span class="p">,</span> <span class="n">sr</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotInOrFailCase</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">,</span> <span class="n">players</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                       <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should not be in the players object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

        <span class="c1"># Cleanup</span>
        <span class="n">ht</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl">[docs]</a><span class="k">class</span> <span class="nc">MuseGroupsNamespaceGroupModificationTestsImpl</span><span class="p">(</span><span class="n">BaseMuseFixture</span><span class="p">):</span>
    <span class="c1"># Created for SWPBL-12574</span>
<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.setUpFixture"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">SMAPI_SERVER_CAPS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;manifest&#39;</span><span class="p">]</span>
        <span class="c1"># Mute and make sure all devices on the testbed is its own GC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">playback_devices</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">():</span>
                <span class="n">d</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">()</span>
                <span class="n">d</span><span class="o">.</span><span class="n">GroupRenderingControl</span><span class="o">.</span><span class="n">SetGroupVolume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">GroupRenderingControl</span><span class="o">.</span><span class="n">SetGroupMute</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">playback_devices</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">MuseGroupsNamespaceGroupModificationTestsImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>

        <span class="c1"># Create a dict of the 3 ZPs to use for all the tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">zp</span> <span class="o">=</span> <span class="n">ifilter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()</span>
                                     <span class="ow">and</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">is_bonded</span><span class="p">()</span>
                                     <span class="ow">and</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrSkipCase</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">),</span>
                                          <span class="s2">&quot;We need at least 3 ZPs&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">254</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smapi_port</span> <span class="o">=</span> <span class="mi">3200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span><span class="p">]</span>

        <span class="c1"># mock SMAPI server setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">start_node_smapi_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                       <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                       <span class="n">server_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smapi_port</span><span class="p">,</span>
                                                       <span class="n">server_internal_id</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">get_account_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                                                       <span class="n">server_sid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
            <span class="s2">&quot;Successfully added SMAPI account?&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.setUpTest"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseGroupsNamespaceGroupModificationTestsImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">playback_devices</span><span class="p">))</span>
        <span class="c1"># Get the number of groups in the testbed before running tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>
        <span class="c1"># cache the old gid since some tests will cause self.zp&#39;s gid to rev up due it being</span>
        <span class="c1"># removed from the starting group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gid</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.tearDownTest"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Clean up each ZP that was used in the tests</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">:</span>
            <span class="c1"># Try again and make sure each zp has anacapa running</span>
            <span class="n">key</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">()</span>
            <span class="n">key</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
            <span class="n">key</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">()</span>
        <span class="c1"># Final verifications that each player is in its own group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_message_queue</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseGroupsNamespaceGroupModificationTestsImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.tearDownFixture"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">SystemProperties</span><span class="o">.</span><span class="n">remove_all_service_accounts</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">stop_node_smapi_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseGroupsNamespaceGroupModificationTestsImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_groups_hh</span><span class="p">,</span> <span class="n">num_players_group</span><span class="p">,</span> <span class="n">gc_pid</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PAUSED&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Common groups verifier. Checks number of groups in the hh, number of players in new/modifed group,</span>
<span class="sd">        and the new/modified group&#39;s GC. Can also optionally check the new/modified group&#39;s gid.</span>
<span class="sd">        :param num_groups_hh:</span>
<span class="sd">        :param num_players_group:</span>
<span class="sd">        :param gc_pid:</span>
<span class="sd">        :param gid:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Verify response event for correct GC and member players</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupInfoEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;coordinatorId&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">gc_pid</span> <span class="ow">and</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;playerIds&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">num_players_group</span><span class="p">))</span>
        <span class="c1"># Cache the new group&#39;s id</span>
        <span class="n">new_gid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="c1"># Some groups commands shouldn&#39;t change the targeted group&#39;s id</span>
        <span class="k">if</span> <span class="n">gid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">new_gid</span><span class="p">,</span>
                                       <span class="s2">&quot;New groupId should not have changed&quot;</span><span class="p">)</span>

        <span class="c1"># Try to empty the queue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Queue is empty&quot;</span><span class="p">)</span>

        <span class="c1"># Try 3 times to find the correct groups event</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
            <span class="c1"># Verify the groups event has the right number of groups</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_groups_hh</span><span class="p">))):</span>
                <span class="c1"># Verify the groups object</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                    <span class="c1"># Verify the groupId is the one that was just created/modified</span>
                    <span class="k">if</span> <span class="n">new_gid</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># Check if this group has the GC we&#39;re looking for</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">coordinatorId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gc_pid</span><span class="p">):</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Did not find GC </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2">&quot;</span>
                                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gc_pid</span><span class="p">,</span> <span class="n">group</span><span class="o">.</span><span class="n">coordinatorId</span><span class="p">))</span>
                        <span class="c1"># Check if this group has the number of players we&#39;re looking for</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">num_players_group</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">playerIds</span><span class="p">)):</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Expected </span><span class="si">{}</span><span class="s2"> number of players in group, got </span><span class="si">{}</span><span class="s2">&quot;</span>
                                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_players_group</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">playerIds</span><span class="p">)))</span>
                        <span class="c1"># Return true only is neither comps fail</span>
                        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">playbackState</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">playbackState</span><span class="p">,</span> <span class="n">group</span><span class="o">.</span><span class="n">playbackState</span><span class="p">,</span>
                                                           <span class="s2">&quot;Group playbackState should be as expected&quot;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Looking for group </span><span class="si">{}</span><span class="s2"> , got </span><span class="si">{}</span><span class="s2">)&quot;</span>
                                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_gid</span><span class="p">,</span> <span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">found</span>

    <span class="k">def</span> <span class="nf">_start_cq_playback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemId</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">positionMillis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">playOnCompletion</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts playing a cloudqueue playlist</span>
<span class="sd">        :param itemId:</span>
<span class="sd">        :param positionMillis:</span>
<span class="sd">        :param playOnCompletion:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse_session_helper</span><span class="o">.</span><span class="n">make_muse_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">test_fixture</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">load_cloud_queue</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                                   <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span>
                                   <span class="n">queue_base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cq_control</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">,</span>
                                   <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">httpAuthorization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">item_id</span><span class="o">=</span><span class="n">itemId</span><span class="p">,</span>
                                   <span class="n">play_on_completion</span><span class="o">=</span><span class="n">playOnCompletion</span><span class="p">,</span>
                                   <span class="n">track_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">position_millis</span><span class="o">=</span><span class="n">positionMillis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">itemId</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_playback_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemId</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PLAYING&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        subscribes to the playback namespace and verifies the playback status of self.zp</span>
<span class="sd">        :param itemId:</span>
<span class="sd">        :param playbackState:</span>
<span class="sd">        :param timeout:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">playbackState</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">itemId</span><span class="p">))</span>

    <span class="c1"># createGroup tests</span>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_duplicated_playerId"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_duplicated_playerId">[docs]</a>    <span class="k">def</span> <span class="nf">test_createGroup_duplicated_playerId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that createGroup tests for duplicate entries in the playerId array and</span>
<span class="sd">        sends out an accurate error event.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add a duplicate self.zp id to the playerId array</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="c1"># Verify that the error even has the right playerId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">]</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_bad_pid_in_playerId_array"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_bad_pid_in_playerId_array">[docs]</a>    <span class="k">def</span> <span class="nf">test_createGroup_bad_pid_in_playerId_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that createGroup tests for invalid playerIds and sends out an accurate error event.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add bogus value to the playerId array</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;BAD_PID&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="c1"># Verify that the bogus value is in the error event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BAD_PID&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_all_at_once"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_all_at_once">[docs]</a>    <span class="nd">@skip</span><span class="p">(</span><span class="s2">&quot;test skipped until fix on jira issue SWPBL-107952&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_createGroup_all_at_once</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that creating a new group with 2+ zps in the playerId array works and</span>
<span class="sd">        that the first id will the new group&#39;s GC</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the playerId array with self.zp first</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Group!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_incremental"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_incremental">[docs]</a>    <span class="k">def</span> <span class="nf">test_createGroup_incremental</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that we can create groups by adding one player at a time. playerId position in the array</span>
<span class="sd">        is irrelevant when trying to group smaller groups into bigger groups.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the playerId array without self.zp</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Create the first group with 2 members</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># Add self.zp back to the front of the array</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Group again, 3 total zps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="p">[</span><span class="n">pids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pids</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_move_zp_to_new_group"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_move_zp_to_new_group">[docs]</a>    <span class="k">def</span> <span class="nf">test_createGroup_move_zp_to_new_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that we can use createGroup to remove a zp from one group and use it as a part of a</span>
<span class="sd">        new group</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the array without self.zp</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Create the first group with 2 zps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># Make a new array with self.zp and one of the zps from the first groups</span>
        <span class="k">del</span> <span class="n">pids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Create the new group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_first_playerId_in_array_offline"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_first_playerId_in_array_offline">[docs]</a>    <span class="k">def</span> <span class="nf">test_createGroup_first_playerId_in_array_offline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that createGroup will behave in a sane manner if the first id in the playerId array</span>
<span class="sd">        is offline</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the array with self.zp last</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Force quit anacapad and make sure its killed</span>
        <span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">stop_anacapa</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_anacapa_running</span><span class="p">())</span>

        <span class="c1"># Attempt to create the group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="c1"># pids[0] is in its own group and first in the array so it will be the new group&#39;s GC</span>
        <span class="c1"># However since the grouping operation failed as pids[0] is offline</span>
        <span class="c1"># createGroup returns pids[0] as its own group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># Restart anacapa</span>
        <span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_partial_success"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_partial_success">[docs]</a>    <span class="k">def</span> <span class="nf">test_createGroup_partial_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that createGroup will make a best effort to group together all the zps</span>
<span class="sd">        defined in the playerId array</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the array with self.zp last</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Force quit anacapad and make sure its killed</span>
        <span class="n">zps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">stop_anacapa</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="n">zps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_anacapa_running</span><span class="p">())</span>

        <span class="c1"># Attempt to create the group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># Restart anacapa</span>
        <span class="n">zps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_player_to_be_ungrouped_offline"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_player_to_be_ungrouped_offline">[docs]</a>    <span class="k">def</span> <span class="nf">test_createGroup_player_to_be_ungrouped_offline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that createGroup behaves gracefully if it needs to ungroup an offline player.</span>
<span class="sd">        It should take make a group out of the non-grouped players, with the new GC being the first</span>
<span class="sd">        non-grouped, online player in the array.</span>
<span class="sd">        The command should also not modify any groups that the members of the array might be in.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the array without self.zp</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Create the new group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># kill anacapa on GC of the first group</span>
        <span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">stop_anacapa</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_anacapa_running</span><span class="p">())</span>
        <span class="c1"># Make a new array with the GC and self.zp</span>
        <span class="n">new_pids</span> <span class="o">=</span> <span class="p">[</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">]]</span>

        <span class="c1"># Attempt to create a new group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span> <span class="n">new_pids</span><span class="p">)</span>
        <span class="c1"># Since pids[0] belongs to another group, pids[1] will be the GC of the new group</span>
        <span class="c1"># Since pids[0] is offline, it will failed to grouped into the new group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="n">new_pids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># Restart anacapa</span>
        <span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_invalid_musicContextGroupId_generates_error"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_invalid_musicContextGroupId_generates_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_invalid_musicContextGroupId_generates_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that using an invalid musicContext value will cause an error</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the playerId array without the source of the musicContext</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Start playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_cq_playback</span><span class="p">(</span><span class="n">positionMillis</span><span class="o">=</span><span class="mi">27000</span><span class="p">)</span>

        <span class="c1"># Attempt to create the new group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span> <span class="n">musicContextGroupId</span><span class="o">=</span><span class="s2">&quot;BAD_GID&quot;</span><span class="p">)</span>
        <span class="c1"># Verify that an error event was generated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;musicContextGroupId&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
        <span class="c1"># Verify that the grouping operation was not performed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">))</span>

        <span class="c1"># Verify that the original playing source continued to play after the grouping error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">itemId</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_playing_through_musicContextGroupId_from_outside_group"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_playing_through_musicContextGroupId_from_outside_group">[docs]</a>    <span class="k">def</span> <span class="nf">test_playing_through_musicContextGroupId_from_outside_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that a valid musicContext works with createGroup is the source if not in the new group</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the ZP/playerId array without the source of the musicContext</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Start playback</span>
        <span class="n">smapi_queue_setup_and_play</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;22&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:25&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create the new group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span> <span class="n">musicContextGroupId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="n">pids</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># Make a connection to the GC of the new group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse2</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">GroupManagement</span><span class="o">.</span><span class="n">get_local_group_uuid</span><span class="p">(),</span>
                                      <span class="n">hhid</span><span class="o">=</span><span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="c1"># Attempt to play</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse2</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">GroupManagement</span><span class="o">.</span><span class="n">get_local_group_uuid</span><span class="p">(),</span>
                        <span class="n">hhid</span><span class="o">=</span><span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="c1"># Verify that its playing where it left off on the source player</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse2</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">BUFFERING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">previousPositionMillis</span> <span class="o">&gt;=</span> <span class="mi">25000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">muse2</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_playing_through_musicContextGroupId_from_inside_group"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_playing_through_musicContextGroupId_from_inside_group">[docs]</a>    <span class="k">def</span> <span class="nf">test_playing_through_musicContextGroupId_from_inside_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that if we create a new group using the musicContext from the GC of the new group,</span>
<span class="sd">        the new group continues to play and didn&#39;t restart from the top of the queue.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the playerId array with the source of the musicContext first</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Start playback</span>
        <span class="n">smapi_queue_setup_and_play</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;20&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:23&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create the group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span>
                              <span class="n">musicContextGroupId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PAUSED&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># Resubscribe, play and verify that the new group is playing and didn&#39;t restart the track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">subscribe_playback</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                     <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">PlaybackStatusEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">playback_state</span> <span class="o">==</span> <span class="n">PlaybackState</span><span class="o">.</span><span class="n">PLAYING</span> <span class="ow">and</span>
                                                    <span class="n">e</span><span class="o">.</span><span class="n">position_millis</span> <span class="o">&gt;=</span> <span class="mi">23000</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_fails_with_musicContextGroupId"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_fails_with_musicContextGroupId">[docs]</a>    <span class="k">def</span> <span class="nf">test_createGroup_fails_with_musicContextGroupId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If a createGroup attempt fails, the member that is the source of the musicContext</span>
<span class="sd">        should end up in a relatively normal state and its AVT should not be blown away.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create zp/pid array so that self.zp is not first</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Start playback</span>
        <span class="n">smapi_queue_setup_and_play</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:03&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Hold anacapa off on the GC of the new group</span>
        <span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">stop_anacapa</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_anacapa_running</span><span class="p">())</span>

        <span class="c1"># Attempt to create the new group</span>
        <span class="c1"># Since the new GC is offline, the grouping operation will not finish and thus only create</span>
        <span class="c1"># a group that contains just the new GC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span>
                              <span class="n">musicContextGroupId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>
        <span class="c1"># For reasons I&#39;m not entirely sure of, self.zp&#39;s groupId will rev when the</span>
        <span class="c1"># grouping operation fails</span>
        <span class="c1"># remove if SWPBL-72645 is resolved</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Resubscribe and verify that the original musicContext source is idle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">,</span> <span class="n">itemId</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Verify that we can still play on that zp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                       <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">itemId</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Restart anacapa</span>
        <span class="n">zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start_anacapa</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_with_valid_but_empty_musicContextGroupId"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_with_valid_but_empty_musicContextGroupId">[docs]</a>    <span class="k">def</span> <span class="nf">test_createGroup_with_valid_but_empty_musicContextGroupId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copying a valid but empty musicContext should be OK. The new group should be created</span>
<span class="sd">        and attempt to play should result in a NO_CONTENT error.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create zp/pid array so that self.zp is first</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Attempt to create the new group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span>
                              <span class="n">musicContextGroupId</span><span class="o">=</span><span class="n">zps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GroupManagement</span><span class="o">.</span><span class="n">get_local_group_uuid</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># Subscribe and verify that the new group is idle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">itemId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">)</span>

        <span class="c1"># Verify attempt to play will result in an error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">GroupManagement</span><span class="o">.</span><span class="n">get_local_group_uuid</span><span class="p">(),</span>
                       <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_PLAYBACK_NO_CONTENT&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_with_new_GC_currently_playing"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_createGroup_with_new_GC_currently_playing">[docs]</a>    <span class="k">def</span> <span class="nf">test_createGroup_with_new_GC_currently_playing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that when grouping and the potential new GC is already playing, the new group should start</span>
<span class="sd">        off playing as well.</span>
<span class="sd">        Verify that when ungrouping a playing group&#39;s GC with createGroup, the removed player continues to play</span>
<span class="sd">        and the new group is not</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create zp/pid array so that self.zp is first</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Start playback</span>
        <span class="n">smapi_queue_setup_and_play</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;20&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:23&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create the group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="c1"># Verify that the number of groups in the hh is now 2 less</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PAUSED&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>
        <span class="c1"># Verify that the new group is able to resume playing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span> <span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">itemId</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Update the playerId array to remove self.zp</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Create the new group without self.zp. This will create a new group with just the 2 other zps</span>
        <span class="c1"># and self.zp as its own group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>
        <span class="c1"># Verify that self.zp is still playing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">itemId</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Verify that the new group&#39;s GC is not playing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="ow">not</span> <span class="n">zps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                                  <span class="s2">&quot;The new group&#39;s GC should not be playing&quot;</span><span class="p">)</span></div>

    <span class="c1"># modifyGroupMembers tests</span>
    <span class="c1"># SWBPL-70958</span>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_modifyGroup_add_remove_simultaneous"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_modifyGroup_add_remove_simultaneous">[docs]</a>    <span class="k">def</span> <span class="nf">test_modifyGroup_add_remove_simultaneous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that we can add and remove players at the same time</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Start playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_cq_playback</span><span class="p">()</span>

        <span class="c1"># Add and remove zps at the same time, no ZP overlap</span>
        <span class="c1"># Result should be a 2 zp group, with self.zp&#39;s original gid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">modifyGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                              <span class="n">playerIdsToAdd</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span>
                              <span class="n">playerIdsToRemove</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">),</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PLAYING&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># Verify the 2 non-self.zp players are still playing</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                            <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1"># self.zp was removed from the group so it should stop playing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">itemId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">)</span>
        <span class="c1"># Do the same but with overlapping zps</span>
        <span class="c1"># Result should be self.zp in its own group as the only member</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">modifyGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                              <span class="n">playerIdsToAdd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                              <span class="n">playerIdsToRemove</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PLAYING&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># self.zp was added back into the group so it should have restarted playing</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_modifyGroup_same_pid_to_add_remove"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_modifyGroup_same_pid_to_add_remove">[docs]</a>    <span class="k">def</span> <span class="nf">test_modifyGroup_same_pid_to_add_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify if we try to add and remove the same player, new events gets sent out</span>
<span class="sd">        but the end result would be like a NO-OP</span>
<span class="sd">        Changed as of SWPBL-121733: new group is created according to the playerIdsToAdd list</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">modifyGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                              <span class="n">playerIdsToAdd</span><span class="o">=</span><span class="p">[</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                              <span class="n">playerIdsToRemove</span><span class="o">=</span><span class="p">[</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_modifyGroup_bad_pid"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_modifyGroup_bad_pid">[docs]</a>    <span class="k">def</span> <span class="nf">test_modifyGroup_bad_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the player sends an error if we try to add/remove invalid players and no</span>
<span class="sd">        additional actions should be done even if the targeted playerId is valid</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Add another player to self.zp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">modifyGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                              <span class="n">playerIdsToAdd</span><span class="o">=</span><span class="p">[</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># Start playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_cq_playback</span><span class="p">()</span>

        <span class="c1"># Simultaneous add/remove with invalid playerId in the add array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">modifyGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                              <span class="n">playerIdsToAdd</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BAD_PID&quot;</span><span class="p">],</span>
                              <span class="n">playerIdsToRemove</span><span class="o">=</span><span class="p">[</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;invalid player id&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
        <span class="c1"># Verify that the number of groups in the hh has not changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Try again with bad pid in the remove array</span>
        <span class="c1"># As of SWPBL-89938, this should not result in an error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">modifyGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                              <span class="n">playerIdsToAdd</span><span class="o">=</span><span class="p">[</span><span class="n">pids</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                              <span class="n">playerIdsToRemove</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BAD_PID&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PLAYING&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_modifyGroup_remove_only_player_in_group"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_modifyGroup_remove_only_player_in_group">[docs]</a>    <span class="k">def</span> <span class="nf">test_modifyGroup_remove_only_player_in_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removing a stand alone group should result in a no-op</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start playback and remove self.zp from its own group</span>
        <span class="c1"># The gid should not change and playback should continue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_cq_playback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">modifyGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                              <span class="n">playerIdsToRemove</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PAUSED&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_modifyGroup_empty_add_remove_arrays"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_modifyGroup_empty_add_remove_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">test_modifyGroup_empty_add_remove_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that providing no player array to remove or add is a no-op</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start playback and use modifyGroup with nothing to add or remove</span>
        <span class="c1"># Groups should not change, self.zp&#39;s gid should not change and playback should continue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_cq_playback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">modifyGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PLAYING&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_modifyGroup_playback_pauses_on_gc_if_all_memebers_removed"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_modifyGroup_playback_pauses_on_gc_if_all_memebers_removed">[docs]</a>    <span class="k">def</span> <span class="nf">test_modifyGroup_playback_pauses_on_gc_if_all_memebers_removed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Add the other players to self.zp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">modifyGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                              <span class="n">playerIdsToAdd</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>
        <span class="c1"># Start playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_cq_playback</span><span class="p">()</span>

        <span class="c1"># Add remove all players</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">modifyGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                              <span class="n">playerIdsToRemove</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PAUSED&quot;</span><span class="p">)</span></div>

    <span class="c1"># setGroupMember tests</span>
    <span class="c1"># SWPBL-70958</span>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_setGroup_bad_pid"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_setGroup_bad_pid">[docs]</a>    <span class="k">def</span> <span class="nf">test_setGroup_bad_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify sending bad playerIds via setGroup results in an error and does not disrupt playback</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Group everything together and start playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                           <span class="n">playerIds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_cq_playback</span><span class="p">()</span>

        <span class="c1"># setGroup with a bad playerId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                           <span class="n">playerIds</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BAD_PID&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;invalid player id&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
        <span class="c1"># Verify that the number of groups in the hh has not changed and that playback continues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">()</span>

        <span class="c1"># Try again with overlap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                           <span class="n">playerIds</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span> <span class="s2">&quot;BAD_PID&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;invalid player id&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
        <span class="c1"># Verify that the number of groups in the hh has not changed and that playback continues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_setGroup_replace_group_gc"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_setGroup_replace_group_gc">[docs]</a>    <span class="k">def</span> <span class="nf">test_setGroup_replace_group_gc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that replacing the GC of a group via setGroup works as expected</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Group everything together and start playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                           <span class="n">playerIds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_cq_playback</span><span class="p">()</span>

        <span class="c1"># set to the group now to just the two non-self.zp players</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                           <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PLAYING&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># self.zp should not be playing since it was removed from the group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">itemId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">)</span>
        <span class="c1"># Verify other 2 zps are still playing</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                            <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># now set the group to be self.zp and one other player</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                           <span class="n">playerIds</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span> <span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span> <span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PLAYING&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># self.zp is now back in the original group and should have restarted playing</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_setGroup_empty_playerId_array"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_setGroup_empty_playerId_array">[docs]</a>    <span class="k">def</span> <span class="nf">test_setGroup_empty_playerId_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that an empty playerId array makes every player in the group stand alone</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start playback and group 3 zps together</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                           <span class="n">playerIds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_cq_playback</span><span class="p">()</span>

        <span class="c1"># Empty playerId array should make all the players in the group stand alone</span>
        <span class="c1"># playback should continue on self.zp only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PAUSED&quot;</span><span class="p">)</span>
        <span class="c1"># Verify no playback on the other speakers</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">zps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                            <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Try again to verify that nothing bad happens; the gid should not change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span>
                                                                           <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_playback_state</span><span class="p">(</span><span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_PAUSED&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTestsImpl.test_no_duplicate_pids_in_playerId_arrays"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTestsImpl.test_no_duplicate_pids_in_playerId_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_duplicate_pids_in_playerId_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-78930</span>
<span class="sd">        Verify that playerIds are not duplicated in multiple groups after a group modification</span>
<span class="sd">        action</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the array without self.zp</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Create the first group with 2 zps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_groupsInfoEvent_groupsEvent</span><span class="p">(</span><span class="n">num_groups_hh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">num_players_group</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                           <span class="n">gc_pid</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span>
                                                                           <span class="n">playbackState</span><span class="o">=</span><span class="s2">&quot;PLAYBACK_STATE_IDLE&quot;</span><span class="p">),</span>
                                  <span class="s2">&quot;New group&#39;s GC/number of members should be as expected&quot;</span><span class="p">)</span>

        <span class="c1"># The the first group&#39;s GC and make it a member of self.zp&#39;s group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">modifyGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">old_gid</span><span class="p">,</span>
                              <span class="n">playerIdsToAdd</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">],</span> <span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="n">pids_found</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">generate_events</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
            <span class="c1"># process all the groups events as they get sent by the player</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">GroupsEvent</span><span class="p">):</span>
                <span class="c1"># loop through each pid we&#39;re interested in</span>
                <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">pids_found</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># look for the desired pid in the playerId arrays of each group object in the event</span>
                    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                        <span class="c1"># self.logger.debug(&quot;Examining {} for pid {}&quot;.format(group, pid))</span>
                        <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">playerIds</span><span class="p">:</span>
                            <span class="c1"># increment the found counter for each pid each time its seen in any group&#39;s</span>
                            <span class="c1"># playerId array</span>
                            <span class="c1"># self.logger.debug(&quot;Found pid {} in {}&quot;.format(pid, group.playerIds))</span>
                            <span class="n">pids_found</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>

            <span class="c1"># In the end, each pid should only show up in a single group&#39;s playerId array</span>
            <span class="k">if</span> <span class="n">pids_found</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Did not find a GroupsEvent&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids_found</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pids_found</span><span class="p">[</span><span class="n">pid</span><span class="p">],</span>
                                               <span class="s2">&quot;pid </span><span class="si">{}</span><span class="s2"> should be in only one group&#39;s playerId array&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="MuseGroupsNamespaceVersionCompatibilityTestsImpl"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceVersionCompatibilityTestsImpl">[docs]</a><span class="k">class</span> <span class="nc">MuseGroupsNamespaceVersionCompatibilityTestsImpl</span><span class="p">(</span><span class="n">BaseMuseFixture</span><span class="p">):</span>
    <span class="c1"># Created for SWPBL-70535</span>
<div class="viewcode-block" id="MuseGroupsNamespaceVersionCompatibilityTestsImpl.setUpFixture"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceVersionCompatibilityTestsImpl.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseGroupsNamespaceVersionCompatibilityTestsImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="c1"># Mute and make sure all devices on the testbed is its own GC</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">():</span>
                <span class="n">d</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">()</span>
                <span class="n">d</span><span class="o">.</span><span class="n">GroupRenderingControl</span><span class="o">.</span><span class="n">SetGroupVolume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">GroupRenderingControl</span><span class="o">.</span><span class="n">SetGroupMute</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create a dict of the 3 ZPs to use for all the tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">zp</span> <span class="o">=</span> <span class="n">ifilter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()</span>
                                     <span class="ow">and</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrSkipCase</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">),</span>
                                          <span class="s2">&quot;We need at least 3 ZPs&quot;</span><span class="p">)</span>

        <span class="c1"># Get the number of expected groups in the hh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">GroupsEvent</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>

        <span class="c1"># set the version on self.zp to something really old</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;12.3-45678-PTSTeam&quot;</span>
        <span class="c1"># spoof self.zp&#39;s version and bounce anacapa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_spoofed_version</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="n">num_zones_before_bounce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_num_zones</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_num_zones</span><span class="p">()</span> <span class="o">==</span> <span class="n">num_zones_before_bounce</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for all zones to be present after the bounce&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceVersionCompatibilityTestsImpl.setUpTest"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceVersionCompatibilityTestsImpl.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseGroupsNamespaceVersionCompatibilityTestsImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="c1"># Create zp/pid array so that self.zp is first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zps_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zps_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zps_keys</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># verify that all of the known player ids (self.pids) are present in the getGroups response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_all_player_ids_are_present</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pids</span><span class="p">),</span>
                                  <span class="s2">&quot;Verifying all expected playerIds are present in getGroups response&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceVersionCompatibilityTestsImpl.tearDownTest"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceVersionCompatibilityTestsImpl.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseGroupsNamespaceVersionCompatibilityTestsImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceVersionCompatibilityTestsImpl.tearDownFixture"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceVersionCompatibilityTestsImpl.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseGroupsNamespaceVersionCompatibilityTestsImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span>
        <span class="c1"># unspoof self.zp&#39;s version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">set_spoofed_version</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_verify_num_groups_hh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_groups_in_hh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper to verify the correct number of groups shows up in the household</span>
<span class="sd">        :param num_groups_in_hh: </span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Try 5 times</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">generate_events</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">GroupsEvent</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_groups_in_hh</span><span class="p">:</span>
            <span class="c1"># Return if the last groups event has the expected number of groups</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># Wait 5 seconds if the number of groups isn&#39;t correct</span>
            <span class="c1"># This is needed if this helper was called after bouncing anacapa</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Unexpected number of groups found (Expected </span><span class="si">{}</span><span class="s2">, got </span><span class="si">{}</span><span class="s2">)&quot;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">test_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groups</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_verify_all_player_ids_are_present</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper to verify that all of the known player Ids have been found by the player under test.</span>
<span class="sd">        :param pids: A list of known player Ids</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Try 5 times</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="c1"># Create a dictionary to track which playerIds are present in the response</span>
            <span class="n">myPids</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">pids</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">myGroups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">player</span> <span class="ow">in</span> <span class="n">myGroups</span><span class="o">.</span><span class="n">players</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">player</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">myPids</span><span class="p">:</span>
                    <span class="n">myPids</span><span class="p">[</span><span class="n">player</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Create a new dictionary that only has the missing player Ids</span>
            <span class="n">missingPids</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">myPids</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">False</span> <span class="p">}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missingPids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># All of the known player Ids were returned by the player under test.</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Missing Player Ids: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">missingPids</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="c1"># Wait 5 seconds if the number of groups isn&#39;t correct</span>
            <span class="c1"># This is needed if this helper was called after bouncing anacapa</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="MuseGroupsNamespaceVersionCompatibilityTestsImpl.test_version_check_createGroup"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceVersionCompatibilityTestsImpl.test_version_check_createGroup">[docs]</a>    <span class="k">def</span> <span class="nf">test_version_check_createGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify we get the correct error if one of the players has an incompatible version</span>
<span class="sd">        with createGroup</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Verify the error if self.zp is the new gc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_PLAYERS_HAVE_INCOMPATIBLE_FIRMWARE&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_num_groups_hh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">),</span>
                                  <span class="s2">&quot;Number of groups after createGroups error should not have changed&quot;</span><span class="p">)</span>

        <span class="c1"># Create zp/pid array so that self.zp is not first</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pids</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>
        <span class="n">pids</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">])</span>

        <span class="c1"># Verify the error if self.zp is just one of the members</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">createGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">playerIds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_PLAYERS_HAVE_INCOMPATIBLE_FIRMWARE&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_num_groups_hh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">),</span>
                                  <span class="s2">&quot;Number of groups after createGroups error should not have changed&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceVersionCompatibilityTestsImpl.test_version_check_setGroup"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceVersionCompatibilityTestsImpl.test_version_check_setGroup">[docs]</a>    <span class="k">def</span> <span class="nf">test_version_check_setGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify we get the correct error if one of the players has an incompatible version</span>
<span class="sd">        with setGroup</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                           <span class="n">playerIds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_PLAYERS_HAVE_INCOMPATIBLE_FIRMWARE&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_num_groups_hh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">),</span>
                                  <span class="s2">&quot;Number of groups after createGroups error should not have changed&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseGroupsNamespaceVersionCompatibilityTestsImpl.test_version_check_modifyGroup"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceVersionCompatibilityTestsImpl.test_version_check_modifyGroup">[docs]</a>    <span class="k">def</span> <span class="nf">test_version_check_modifyGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify we get the correct error if one of the players has an incompatible version</span>
<span class="sd">        with modifyGroup</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muse</span><span class="o">.</span><span class="n">modifyGroup</span><span class="p">(</span><span class="n">hhid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">muse_hhid</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
                              <span class="n">playerIdsToAdd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_event</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">event_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;ERROR_PLAYERS_HAVE_INCOMPATIBLE_FIRMWARE&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_num_groups_hh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_groups_in_hh</span><span class="p">),</span>
                                  <span class="s2">&quot;Number of groups after createGroups error should not have changed&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MuseGroupsNamespaceTests"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceTests">[docs]</a><span class="k">class</span> <span class="nc">MuseGroupsNamespaceTests</span><span class="p">(</span><span class="n">MuseGroupsNamespaceTestsImpl</span><span class="p">,</span>
                               <span class="n">MuseClientFixtureMixin</span><span class="p">):</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NIGHTLY_MUSE_MISC_NAMESPACE&#39;</span><span class="p">,</span> <span class="s1">&#39;NIGHTLY_MUSE_GROUP_NAMESPACE&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="MuseGroupsNamespaceGroupModificationTests"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceGroupModificationTests">[docs]</a><span class="k">class</span> <span class="nc">MuseGroupsNamespaceGroupModificationTests</span><span class="p">(</span><span class="n">MuseGroupsNamespaceGroupModificationTestsImpl</span><span class="p">,</span>
                                                <span class="n">MuseClientFixtureMixin</span><span class="p">):</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NIGHTLY_MUSE_MISC_NAMESPACE&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="MuseGroupsNamespaceVersionCompatibilityTests"><a class="viewcode-back" href="../../webserver.html#webserver.muse_groups_namespace.MuseGroupsNamespaceVersionCompatibilityTests">[docs]</a><span class="k">class</span> <span class="nc">MuseGroupsNamespaceVersionCompatibilityTests</span><span class="p">(</span><span class="n">MuseGroupsNamespaceVersionCompatibilityTestsImpl</span><span class="p">,</span>
                                                   <span class="n">MuseClientFixtureMixin</span><span class="p">):</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NIGHTLY_MUSE_MISC_NAMESPACE&#39;</span><span class="p">]</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">WorkflowTestSuite</span><span class="p">(</span><span class="s2">&quot;Muse Groups namespace Tests&quot;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="c1"># suite.run([MuseGroupsNamespaceGroupModificationTests()])</span>
    <span class="n">suite</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">MuseGroupsNamespaceTests</span><span class="p">(),</span>
               <span class="n">MuseGroupsNamespaceGroupModificationTests</span><span class="p">(),</span>
               <span class="n">MuseGroupsNamespaceVersionCompatibilityTests</span><span class="p">()])</span>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>