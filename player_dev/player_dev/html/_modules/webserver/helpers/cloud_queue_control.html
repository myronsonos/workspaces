
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>webserver.helpers.cloud_queue_control &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for webserver.helpers.cloud_queue_control</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Helper functions for administering the node.js mock CloudQueue server.</span>

<span class="sd">A note on playbackPolicies and playmodes:</span>
<span class="sd">See this page for more information on which playmodes/playback policies are currently implemented</span>
<span class="sd">https://confluence.sonos.com/x/3jNvB</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="ne">TimeoutError</span>
<span class="kn">from</span> <span class="nn">sonos.network</span> <span class="k">import</span> <span class="n">Network</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">WorkflowTestFixture</span>
<span class="kn">import</span> <span class="nn">webserver.helpers.cloud_queue_helpers</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">wait_until_true</span><span class="p">,</span> <span class="n">skip</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="n">cq_helper</span> <span class="o">=</span> <span class="n">webserver</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">cloud_queue_helpers</span><span class="o">.</span><span class="n">cq_helpers</span><span class="p">()</span>


<div class="viewcode-block" id="CloudQueueControl"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl">[docs]</a><span class="k">class</span> <span class="nc">CloudQueueControl</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CloudQueueControl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;SONOS.tests.webserver.helpers.CloudQueueControl&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">Network</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_ips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">get_external_non_virtual_ips</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_ips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host_port</span> <span class="o">=</span> <span class="mi">3000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cq_rdy_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;sonos-nodejs-cq-&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;/tmp/&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cq</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_playback_id_verifier</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PROTO</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">REVOKE_TOKENS_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/tokens/delete&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GET_TOKEN_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/tokens/get&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPIRE_TOKEN_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/tokens/expire&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DELETE_TRACK_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/track/delete/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ADD_TO_END_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/playlist/addTrack/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LIMITS_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/playlist/limits&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RESET_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/track/reset&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CLEAR_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/track/clearAll&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACTIVATE_SCRIPT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/scripts/activate/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GET_METADATA_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/track/metadata/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GET_MEDIA_LOG</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/logs/medialog&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CLEAR_MEDIA_LOG</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/logs/medialog/clear&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PLAYBACK_POLICIES_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/context/playbackpolicies&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PLAYMODE_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/context/playmodes&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONTAINER_METADATA_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/context/queuecontainer&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GET_CONTEXT_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/context&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ADD_TRACK_WITH_MD_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/playlist/addTrackWithMd&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_QUEUE_VERSION</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/playlist/updateQueueVersion&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">POLICY_HEADERS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LIMITS_HEADERS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CQ_SKIP_ENFORCEMENT_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/context/skipenforcement&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CQ_VERSION_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">version&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CQ_REPORTS_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/context/reports&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CQ_ITEMWINDOW_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">itemWindow&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CQ_WINDOW_PLAYHEAD</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">windowPlayhead&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CQ_SET_POLICY</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/track/policies/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_CONTEXT_VERSION</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/context/updatecontextversion&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CQ_DOMAIN_NAME</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="CloudQueueControl.get_log"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_log">[docs]</a>    <span class="k">def</span> <span class="nf">get_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">apilog</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/logs/</span><span class="si">{}</span><span class="s2">log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">apilog</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">payload</span></div>

<div class="viewcode-block" id="CloudQueueControl.clear_log"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.clear_log">[docs]</a>    <span class="k">def</span> <span class="nf">clear_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;api&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;clear </span><span class="si">{}</span><span class="s2"> log:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

        <span class="n">log</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/logs/</span><span class="si">{}</span><span class="s2">log/clear&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueControl.wait_for_filtered_log"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.wait_for_filtered_log">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_filtered_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;api&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                              <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">playback_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns entries from the CQ server&#39;s API or Media logs based on a variety of inputs</span>
<span class="sd">        :param type: Use either the server&#39;s &#39;api&#39; or &#39;media&#39; log</span>
<span class="sd">        :param flush: Force a flush of the server&#39;s usageMetrics buffer</span>
<span class="sd">        :param clear: clears the server&#39;s logs before the parsing begins</span>
<span class="sd">        :param fn: filter function that pulls out entries from the server log</span>
<span class="sd">        :param timeout: how long the parser should run for</span>
<span class="sd">        :param expected: how many entries the filter should return from the server log</span>
<span class="sd">        :param history: return either just the filtered items or the entire server log up to the point of the filter match</span>
<span class="sd">        :param zp: ZP if you&#39;re using the flush option</span>
<span class="sd">        :param iteration_delay: how long to delay between each filter attempt</span>
<span class="sd">        :param playback_id: Optional playback ID to filter on instead of using the verifier</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_log</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">flush_usage_metrics_events</span><span class="p">()</span>
        <span class="n">full_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">final_logs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">full_logs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;api&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">playback_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">final_logs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_playback_id</span><span class="p">(</span><span class="n">playback_id</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">final_logs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">playback_id_verifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">final_logs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">playback_id_verifier</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">final_logs</span><span class="p">)</span>
        <span class="n">elapsed_secs</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">elapsed_secs</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="n">iteration_delay</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">flush_usage_metrics_events</span><span class="p">()</span>

            <span class="c1"># the &quot;my&quot; variants are the logs for this iteration of the loop</span>
            <span class="n">my_full_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_log</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
            <span class="n">filtered_logs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">my_full_logs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;api&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">playback_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">filtered_logs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_playback_id</span><span class="p">(</span><span class="n">playback_id</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">filtered_logs</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">playback_id_verifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">filtered_logs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">playback_id_verifier</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">filtered_logs</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">my_full_logs</span><span class="p">:</span>
                <span class="n">full_logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">filtered_logs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_logs</span><span class="p">:</span>
                    <span class="n">final_logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_logs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">expected</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">elapsed_secs</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expected</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Expected </span><span class="si">{}</span><span class="s2"> entries after waiting </span><span class="si">{}</span><span class="s2"> seconds, got </span><span class="si">{}</span><span class="s2">&quot;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span>
                                         <span class="n">elapsed_secs</span><span class="p">,</span>
                                         <span class="nb">len</span><span class="p">(</span><span class="n">final_logs</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">history</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">full_logs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">final_logs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full_logs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;drop </span><span class="si">{}</span><span class="s2"> log:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;keep </span><span class="si">{}</span><span class="s2"> log:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

            <span class="k">return</span> <span class="n">final_logs</span></div>

<div class="viewcode-block" id="CloudQueueControl.expire_tokens"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.expire_tokens">[docs]</a>    <span class="k">def</span> <span class="nf">expire_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">EXPIRE_TOKEN_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received HTTP </span><span class="si">{0}</span><span class="s2"> error attempting to expire cloudQueue auth tokens&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.delete_track"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.delete_track">[docs]</a>    <span class="k">def</span> <span class="nf">delete_track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_id</span><span class="p">):</span>
        <span class="n">delete_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE_TRACK_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="n">track_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">delete_uri</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="s1">&#39;404&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not delete selected track from CloudQueue, track doesn&#39;t exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received HTTP </span><span class="si">{0}</span><span class="s2"> error attempting to delete a track&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_track_policy"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_track_policy">[docs]</a>    <span class="k">def</span> <span class="nf">set_track_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_id</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="n">track_policy_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CQ_SET_POLICY</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="n">track_id</span><span class="p">)</span>
        <span class="n">pay</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;policies&quot;</span><span class="p">:</span> <span class="n">policy</span><span class="p">}</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">pay</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">track_policy_uri</span><span class="p">,</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
                                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">POLICY_HEADERS</span><span class="p">,</span>
                                <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="s1">&#39;404&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not set policy on track from CloudQueue, track doesn&#39;t exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received HTTP </span><span class="si">{0}</span><span class="s2"> error attempting to set policy on a track&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.add_track_to_end"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.add_track_to_end">[docs]</a>    <span class="k">def</span> <span class="nf">add_track_to_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_id</span><span class="p">):</span>
        <span class="n">add_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ADD_TO_END_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="n">track_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">add_uri</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received HTTP </span><span class="si">{0}</span><span class="s2"> error attempting to add track to CQ server&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_current_auth_token"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_current_auth_token">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_auth_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GET_TOKEN_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="c1"># Grab the longest living token, at the token half life</span>
            <span class="c1"># the server will return both the half expired, and the new</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">token</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received HTTP </span><span class="si">{0}</span><span class="s2"> error attempting to get auth token&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_track_metadata"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_track_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_track_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GET_METADATA_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="n">item_id</span><span class="p">)),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="c1"># normalize the track URL</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="sa">u</span><span class="s1">&#39;mediaUrl&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;imageUrl&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">):</span>
                        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>

                    <span class="c1"># convert escaped ASCII sequence into UTF-8</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;unicode-escape&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

            <span class="c1"># return just the contents of the &#39;track&#39; object since Muse commands treat that the same as &#39;trackMetadata&#39;</span>
            <span class="k">return</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received HTTP </span><span class="si">{0}</span><span class="s2"> error attempting to get metadata for item </span><span class="si">{1}</span><span class="s2">&quot;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">item_id</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">playback_id_verifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_playback_id_verifier</span>

    <span class="nd">@playback_id_verifier</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">playback_id_verifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_playback_id_verifier</span> <span class="o">=</span> <span class="n">v</span>

    <span class="nd">@playback_id_verifier</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span> <span class="nf">playback_id_verifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_playback_id_verifier</span>

    <span class="nd">@playback_id_verifier</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">playback_id_verifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_playback_id_verifier</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">verify_playback_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">playback_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Contextmanager to change the verifier for a given scope.</span>

<span class="sd">        :param str playback_id: Playback ID to verify.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">playback_id_verifier</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_default_playback_id_verifier</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">playback_id</span><span class="p">)</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">playback_id_verifier</span> <span class="o">=</span> <span class="n">verifier</span>

<div class="viewcode-block" id="CloudQueueControl.set_default_playback_id_verifier"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_default_playback_id_verifier">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_playback_id_verifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gid_cb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the default verifier, takes a callback that returns the playbackId</span>
<span class="sd">        and returns a function that returns a boolean based on whether the</span>
<span class="sd">        playback ID matches.</span>

<span class="sd">        :param func gid_cb:</span>
<span class="sd">        :return: :obj:`func`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">playback_id_verifier</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_playback_id</span><span class="p">(</span><span class="n">gid_cb</span><span class="p">(),</span> <span class="n">l</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueControl.verify_playback_id"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.verify_playback_id">[docs]</a>    <span class="k">def</span> <span class="nf">verify_playback_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">playback_id</span><span class="p">,</span> <span class="n">log_entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify a playback ID for a given log entry.</span>

<span class="sd">        :param str playback_id: Expected playback ID</span>
<span class="sd">        :param str log_entry: Log entry to check</span>
<span class="sd">        :return: :obj:`bool`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span><span class="s1">&#39;x-sonos-playback-id&#39;</span> <span class="ow">in</span> <span class="n">log_entry</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">playback_id</span> <span class="o">==</span> <span class="n">log_entry</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">][</span><span class="s1">&#39;x-sonos-playback-id&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error parsing APIlog request &lt;</span><span class="si">{}</span><span class="s2">&gt;, no playback ID&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_entry</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;x-sonos-playback-id not present in APIlog &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_entry</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CloudQueueControl.copy_track_with_policies"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.copy_track_with_policies">[docs]</a>    <span class="k">def</span> <span class="nf">copy_track_with_policies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_id</span><span class="p">,</span> <span class="n">policies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a track to the CQ server using custom MD. This allows adding a track with any MD you wish but also</span>
<span class="sd">        supports adding in track level policies for use in testing. This uses an existing track from the CQ playlist</span>
<span class="sd">        as a base and allows you to add custom playback policies to that newly added track.</span>

<span class="sd">        :param track_id: :int: which track from the server to use as the base for the new track</span>
<span class="sd">        :param policies: :dict: which, if any playback policies should be set on the track</span>

<span class="sd">        example policies:</span>
<span class="sd">        {&#39;canSkip&#39;: &#39;false&#39;, &#39;canSkipBack&#39;: &#39;false&#39;}</span>

<span class="sd">        Example output:</span>
<span class="sd">        {</span>
<span class="sd">        &quot;policies&quot;: {&#39;canSkip&#39;: &#39;false&#39;, &#39;canSkipBack&#39;: &#39;false&#39;},</span>
<span class="sd">        &quot;track&quot;:{</span>
<span class="sd">            &quot;album&quot;: {</span>
<span class="sd">                &quot;name&quot;:&quot;Album Name&quot;</span>
<span class="sd">                },</span>
<span class="sd">            &quot;name&quot;: &quot;Track Name&quot;,</span>
<span class="sd">                &quot;artist&quot;: {</span>
<span class="sd">                &quot;name&quot;: &quot;Artist Name&quot;</span>
<span class="sd">                },</span>
<span class="sd">            &quot;imageUrl&quot;: &quot;http://acmemusicservice.com/path_to_image_url&quot;,</span>
<span class="sd">            &quot;durationMillis&quot;: 319000,</span>
<span class="sd">            &quot;contentType&quot;: &quot;audio/mpeg&quot;,</span>
<span class="sd">            &quot;mediaUrl&quot;: &quot;http://acmemusicservice.com/path_to_track_url&quot;</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">md</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">md</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">track_id</span><span class="p">)</span>
        <span class="n">md</span><span class="p">[</span><span class="s1">&#39;policies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policies</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ADD_TRACK_WITH_MD_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
                                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">POLICY_HEADERS</span><span class="p">,</span>
                                <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Added track with MD to CloudQueue playlist&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Add track with MD failed, server returned </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.add_smapi_track_to_end"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.add_smapi_track_to_end">[docs]</a>    <span class="k">def</span> <span class="nf">add_smapi_track_to_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track</span><span class="p">,</span> <span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">accountId</span><span class="p">,</span>
        <span class="n">serviceId</span><span class="o">=</span><span class="s2">&quot;255&quot;</span><span class="p">,</span> <span class="n">policies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mediaUrl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trackId</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the flat metadata from a SMAPI track from the mock SMAPI server and</span>
<span class="sd">        converts it to the expected nested format that the CQ server needs when adding a track.</span>
<span class="sd">        :param str track: trackId of the SMAPI track, 1 based</span>
<span class="sd">        :param smapi_ctl: smapi control object passed in from the test case</span>
<span class="sd">        :param str serviceId: serviceId of the SMAPI server, 255 is the mock SMAPI server</span>
<span class="sd">        :param dict policies: track level policies</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">flat_md</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">get_track</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
        <span class="n">nested_md</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nested_md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nested_md</span><span class="p">[</span><span class="s2">&quot;policies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policies</span>
        <span class="n">nested_md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;contentType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flat_md</span><span class="p">[</span><span class="s2">&quot;mimeType&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">nested_md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flat_md</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>
            <span class="n">nested_md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;artist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">flat_md</span><span class="p">[</span><span class="s2">&quot;trackMetadata&quot;</span><span class="p">][</span><span class="s2">&quot;artist&quot;</span><span class="p">]}</span>
            <span class="n">nested_md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;imageUrl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flat_md</span><span class="p">[</span><span class="s2">&quot;trackMetadata&quot;</span><span class="p">][</span><span class="s2">&quot;albumArtURI&quot;</span><span class="p">]</span>
            <span class="n">nested_md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;durationMillis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">flat_md</span><span class="p">[</span><span class="s2">&quot;trackMetadata&quot;</span><span class="p">][</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">nested_md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;album&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">flat_md</span><span class="p">[</span><span class="s2">&quot;trackMetadata&quot;</span><span class="p">][</span><span class="s2">&quot;album&quot;</span><span class="p">],</span>
                                           <span class="s2">&quot;artist&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">flat_md</span><span class="p">[</span><span class="s2">&quot;trackMetadata&quot;</span><span class="p">][</span><span class="s2">&quot;artist&quot;</span><span class="p">]}}</span>
        <span class="k">if</span> <span class="n">trackId</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">nested_md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;serviceId&quot;</span><span class="p">:</span> <span class="n">serviceId</span><span class="p">,</span>
                                        <span class="s2">&quot;objectId&quot;</span><span class="p">:</span> <span class="n">flat_md</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="n">accountId</span><span class="p">}</span>
            <span class="c1"># Remove none values from id field</span>
            <span class="n">nested_md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nested_md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">mediaUrl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nested_md</span><span class="p">[</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;mediaUrl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mediaUrl</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">nested_md</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ADD_TRACK_WITH_MD_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
                                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">POLICY_HEADERS</span><span class="p">,</span>
                                <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">track</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)[</span><span class="s1">&#39;track&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Added </span><span class="si">{}</span><span class="s1"> to CloudQueue playlist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">track</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">track</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Add track with MD failed, server returned </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CloudQueueControl.add_custom_track_to_end"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.add_custom_track_to_end">[docs]</a>    <span class="k">def</span> <span class="nf">add_custom_track_to_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a custom track to the end.</span>

<span class="sd">        :param dict kwargs: Keyword arguments representing objects to include in</span>
<span class="sd">            the track object, ex. mediaUrl=&#39;http://1234&#39;, contentType=&#39;audio/mpegurl&#39;,</span>
<span class="sd">                id={&#39;serviceId&#39;=255, &#39;accountId&#39;=&#39;sn_49&#39;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">add_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ADD_TRACK_WITH_MD_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">md</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;track&#39;</span><span class="p">:</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">})</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">add_uri</span><span class="p">,</span>
                                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">POLICY_HEADERS</span><span class="p">,</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received HTTP </span><span class="si">{0}</span><span class="s2"> error attempting to add track to CQ server&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_track_duration_s"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_track_duration_s">[docs]</a>    <span class="k">def</span> <span class="nf">get_track_duration_s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This returns the duration in milliseconds, as a string.</span>
<span class="sd">        It returns a string because the usage metrics output is ed as a string.</span>

<span class="sd">        @throws a KeyError if the durationMillis key is missing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_track_metadata</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;durationMillis&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="CloudQueueControl.revoke_auth_tokens"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.revoke_auth_tokens">[docs]</a>    <span class="k">def</span> <span class="nf">revoke_auth_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">REVOKE_TOKENS_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Revoking all auth tokens on cloudQueue server&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received HTTP </span><span class="si">{0}</span><span class="s2"> error attempting to revoke tokens&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.reset_server"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.reset_server">[docs]</a>    <span class="k">def</span> <span class="nf">reset_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RESET_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Resetting cloudQueue server&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received HTTP </span><span class="si">{0}</span><span class="s2"> error attempting to reset cloudQueue server&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.clear_queue"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.clear_queue">[docs]</a>    <span class="k">def</span> <span class="nf">clear_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLEAR_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">add_uri</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Clearing the cloudQueue item list&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received HTTP </span><span class="si">{0}</span><span class="s2"> error attempting to clear the cloudQueue track list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_window_limits"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_window_limits">[docs]</a>    <span class="k">def</span> <span class="nf">set_window_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LIMITS_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">limits</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LIMITS_HEADERS</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received HTTP </span><span class="si">{}</span><span class="s2"> error attempting to set window limits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_media_log"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_media_log">[docs]</a>    <span class="k">def</span> <span class="nf">get_media_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the log of mediaUrl fetches from the cloud queue server.</span>
<span class="sd">        This uses the CQ endpoint /logs/medialog.</span>
<span class="sd">        :return: an array of log entries, where each log entry is a dict.</span>
<span class="sd">        See test/javascript/cloudqueue_api/app/models/endpointlog.js for the format of each log entry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GET_MEDIA_LOG</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">media_log</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">media_log</span></div>

<div class="viewcode-block" id="CloudQueueControl.clear_media_log"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.clear_media_log">[docs]</a>    <span class="k">def</span> <span class="nf">clear_media_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the log of mediaUrl fetches on the cloud queue server.</span>
<span class="sd">        This uses the CQ endpoint /logs/medialog/clear.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CLEAR_MEDIA_LOG</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueControl.arm_error_script"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.arm_error_script">[docs]</a>    <span class="k">def</span> <span class="nf">arm_error_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">retry_after_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">itemId</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param call: string, cloudQueue response to force the error on (itemWindow, getVersion)</span>
<span class="sd">        :param error: int, the HTTP error to force. 401, 404, 503</span>
<span class="sd">        :param num_errors: int, number of calls to cause failures on</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">call</span> <span class="o">==</span> <span class="s1">&#39;itemWindow&#39;</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">=</span> <span class="s1">&#39;itemwindowError</span><span class="si">{}</span><span class="s1">.js&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">call</span> <span class="o">==</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">=</span> <span class="s1">&#39;versionError</span><span class="si">{}</span><span class="s1">.js&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">call</span> <span class="o">==</span> <span class="s1">&#39;mediaError&#39;</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">=</span> <span class="s1">&#39;mediaError</span><span class="si">{}</span><span class="s1">.js&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">call</span> <span class="o">==</span> <span class="s1">&#39;context&#39;</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">=</span> <span class="s1">&#39;contextError</span><span class="si">{}</span><span class="s1">.js&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">call</span> <span class="o">==</span> <span class="s1">&#39;removeRequestedItem&#39;</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">=</span> <span class="s1">&#39;removeRequestedItem.js&#39;</span>
        <span class="k">elif</span> <span class="n">call</span> <span class="o">==</span> <span class="s1">&#39;rating&#39;</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">=</span> <span class="s1">&#39;ratingResponse</span><span class="si">{}</span><span class="s1">.js&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
        <span class="n">script_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIVATE_SCRIPT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="n">script</span><span class="p">)</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">num_errors</span><span class="p">,</span> <span class="s1">&#39;itemId&#39;</span><span class="p">:</span> <span class="n">itemId</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">retry_after_time</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">post_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;retryAfterTime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">retry_after_time</span><span class="p">)})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">script_uri</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Armed </span><span class="si">{}</span><span class="s2"> script on cloudQueue server&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Attempt to activate </span><span class="si">{0}</span><span class="s2"> script failed, returned HTTP </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_cloudqueue_poll_timers"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_cloudqueue_poll_timers">[docs]</a>    <span class="k">def</span> <span class="nf">set_cloudqueue_poll_timers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">playing_timer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">paused_timer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">paused_timer</span><span class="p">:</span>
            <span class="c1"># Player needs to transition to PAUSED state for new value to apply(IDLE-&gt;PLAYING-&gt;PAUSED)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">/cloudqueuepoll&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">zp</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;timeoutpaused&#39;</span><span class="p">:</span><span class="n">paused_timer</span><span class="p">},</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting </span><span class="si">{0}</span><span class="s2"> cloudqueue poll while paused to </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">,</span> <span class="n">paused_timer</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not set player poll time. Received </span><span class="si">{}</span><span class="s2"> error&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">playing_timer</span><span class="p">:</span>
            <span class="c1"># Player needs to transition to PLAYING state for new value to apply(IDLE-&gt;PLAYING)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">/cloudqueuepoll&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">zp</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;timeoutplaying&#39;</span><span class="p">:</span><span class="n">playing_timer</span><span class="p">},</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting </span><span class="si">{0}</span><span class="s2"> cloudqueue poll while playing to </span><span class="si">{1}</span><span class="s2"> secs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">,</span> <span class="n">playing_timer</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not set player poll time. Received </span><span class="si">{}</span><span class="s2"> error&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_itemwindow_response_delay"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_itemwindow_response_delay">[docs]</a>    <span class="k">def</span> <span class="nf">set_itemwindow_response_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Arm the itemWindowDelay.js script on the cloud queue test server. This will cause the server to delay [num_error]</span>
<span class="sd">        responses to the getItemWindow() call by [delay] amount. The script defaults the delay to 5 on the server.</span>
<span class="sd">        :param delay: int, the number of seconds to delay the getItemWindow() responses</span>
<span class="sd">        :param num_errors: int, the number of responses to delay</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;delay&#39;</span><span class="p">:</span> <span class="n">delay</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">num_errors</span><span class="p">}</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIVATE_SCRIPT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="s1">&#39;itemWindowDelay.js&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">req</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Armed itemWindowDelay script on cloudQueue server&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Attempt to activate itemWindowDelay script failed, returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_version_response_delay"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_version_response_delay">[docs]</a>    <span class="k">def</span> <span class="nf">set_version_response_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Arm the versionDelay.js script on the cloud queue test server. This will cause the server to delay [num_error]</span>
<span class="sd">        responses to the getItemWindow() call by [delay] amount. The script defaults the delay to 5 on the server.</span>
<span class="sd">        :param delay: int, the number of seconds to delay the getVersion() responses</span>
<span class="sd">        :param num_errors: int, the number of responses to delay</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIVATE_SCRIPT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="s1">&#39;versionDelay.js&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">req</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;delay&#39;</span><span class="p">:</span><span class="n">delay</span><span class="p">,</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">num_errors</span><span class="p">},</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Attempt to activate versionDelay script failed, returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_timePlayed_response_delay"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_timePlayed_response_delay">[docs]</a>    <span class="k">def</span> <span class="nf">set_timePlayed_response_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Arm the timePlayedDelay.js script on the cloud queue test server. This will cause the server to delay [num_error]</span>
<span class="sd">        responses to the timePlayed() call by [delay] amount. The script defaults the delay to 5 on the server.</span>
<span class="sd">        :param delay: int, the number of seconds to delay the timePlayed() responses</span>
<span class="sd">        :param num_errors: int, the number of responses to delay</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIVATE_SCRIPT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="s1">&#39;timePlayedDelay.js&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">req</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;delay&#39;</span><span class="p">:</span><span class="n">delay</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">num_errors</span><span class="p">},</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Attempt to activate timePlayedDelay script failed, returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_context_response_delay"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_context_response_delay">[docs]</a>    <span class="k">def</span> <span class="nf">set_context_response_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Arm the contextDelay.js script on the cloud queue test server. This will cause the server to delay [num_error]</span>
<span class="sd">        responses to the getContext() call by [delay] amount. The script defaults the delay to 5 on the server.</span>
<span class="sd">        :param delay: int, the number of seconds to delay the getContext() responses</span>
<span class="sd">        :param num_errors: int, the number of responses to delay</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIVATE_SCRIPT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="s1">&#39;contextDelay.js&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">req</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;delay&#39;</span><span class="p">:</span><span class="n">delay</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span><span class="n">num_errors</span><span class="p">},</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Attempt to activate contextDelay script failed, returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_itemwindow_abort"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_itemwindow_abort">[docs]</a>    <span class="k">def</span> <span class="nf">set_itemwindow_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arm the itemWindowAbort.js script on the mock cq server. This will cause the itemWindow request to close prematurely.</span>
<span class="sd">        :param num_errors:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">num_errors</span><span class="p">}</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIVATE_SCRIPT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span> <span class="s1">&#39;itemWindowAbort.js&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">req</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Armed itemWindowAbort script on cloudQueue server&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Attempt to activate itemWindowAbort script failed, returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_version_endpoint"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_version_endpoint">[docs]</a>    <span class="k">def</span> <span class="nf">get_version_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_VERSION_ENDPOINT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not get version endpoint, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_itemwindow_endpoint"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_itemwindow_endpoint">[docs]</a>    <span class="k">def</span> <span class="nf">get_itemwindow_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemid</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">window_width</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the contents of the itemWindow endpoint</span>
<span class="sd">        :param itemid: param itemid: str, itemId of the desired track</span>
<span class="sd">        :param window_width: param window_width: int, how wide the desired window should be</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_ITEMWINDOW_ENDPOINT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">),</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;itemId&#39;</span><span class="p">:</span><span class="n">itemid</span><span class="p">,</span> <span class="s1">&#39;previousWindowSize&#39;</span><span class="p">:</span><span class="n">window_width</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;upcomingWindowSize&#39;</span><span class="p">:</span><span class="n">window_width</span><span class="p">},</span>
                                <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not get itemWindow endpoint, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_playback_policies"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_playback_policies">[docs]</a>    <span class="k">def</span> <span class="nf">get_playback_policies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the current set of playback policies set on the CloudQueue playlist that is loaded.</span>
<span class="sd">        :return playback_policies: :list: a list of the decoded JSON playback policies set on the CQ playlist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PLAYBACK_POLICIES_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">playback_policies</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)[</span><span class="s1">&#39;playbackPolicies&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">playback_policies</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not get playback policies, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_playback_policy"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_playback_policy">[docs]</a>    <span class="k">def</span> <span class="nf">set_playback_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">playback_policies</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set/change the playback policies on the CloudQueue playlist. This will take an arbitrary input list of policies</span>
<span class="sd">        and set them on the CloudQueue server (which does not validate policy inputs for expandability). The playback</span>
<span class="sd">        policies setter will set one or more policies at a time but cannot be used to remove a policy that is already</span>
<span class="sd">        set. See &#39;delete_playback_policy&#39; in order to remove a policy from the playlist.</span>
<span class="sd">        :param playback_policies: :dict: the requested playlist playback policies in kv format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">playback_policies</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PLAYBACK_POLICIES_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">POLICY_HEADERS</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not set playback policies, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.delete_playback_policy"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.delete_playback_policy">[docs]</a>    <span class="k">def</span> <span class="nf">delete_playback_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the requested playback policy from the CloudQueue playlist. This method was part of the reason</span>
<span class="sd">        for subclassing urllib2 since we need a DELETE message to process this request on the CQ server</span>
<span class="sd">        :param policy: :str: - which playback policy to delete from the CQ server playlist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PLAYBACK_POLICIES_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not delete policy, server returned </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_container_metadata"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_container_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_container_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the current container metadata on the CloudQueue playlist that is loaded.</span>
<span class="sd">        :return metadata: :list: a list of the decoded JSON container metadata set on the CQ playlist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CONTAINER_METADATA_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">metadata</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not get container metadata, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_container_metadata"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_container_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">set_container_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set/change the container metadata on the CloudQueue playlist. This will take an arbitrary input list of policies</span>
<span class="sd">        and set them on the CloudQueue server (which does not validate policy inputs for expandability). The playback</span>
<span class="sd">        policies setter will set one or more policies at a time but cannot be used to remove a policy that is already</span>
<span class="sd">        set.</span>
<span class="sd">        :param metadata: :dict: the requested metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CONTAINER_METADATA_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">POLICY_HEADERS</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not set container metadata, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_reports_policy"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_reports_policy">[docs]</a>    <span class="k">def</span> <span class="nf">set_reports_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the reports policy on the CQ server using the /context/reports endpoint</span>
<span class="sd">        :param policy: :dict: dictionary report policies</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_REPORTS_ENDPOINT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">policy</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">POLICY_HEADERS</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not set server reports policy, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_reports_policy"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_reports_policy">[docs]</a>    <span class="k">def</span> <span class="nf">get_reports_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the reports policy on the CQ server using the /context/reports endpoint</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_REPORTS_ENDPOINT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">policy</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not get playback policies, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.delete_reports_policy"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.delete_reports_policy">[docs]</a>    <span class="k">def</span> <span class="nf">delete_reports_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the requested reports policy from the CloudQueue playlist. This method was part of the reason</span>
<span class="sd">        for subclassing urllib2 since we need a DELETE message to process this request on the CQ server</span>
<span class="sd">        :param policy: :str: - which reports policy to delete from the CQ server playlist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_REPORTS_ENDPOINT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not delete policy, server returned </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_skip_enforcement"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_skip_enforcement">[docs]</a>    <span class="k">def</span> <span class="nf">get_skip_enforcement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the /context/skipenforcement information from the cloudqueue server. This includes the values for:</span>
<span class="sd">        - lastReportId</span>
<span class="sd">        - skips remaining</span>
<span class="sd">        - ttl</span>

<span class="sd">        :return skipenforcement: :dict: list of skipenforcement information from the server.</span>
<span class="sd">        {&#39;lastReportId&#39;: {}, &#39;remaining&#39;: {}, &#39;ttl&#39;: {}}</span>

<span class="sd">        Note: skipEnforcement data is only returned from the server when the &#39;canSkip&#39; playbackPolicy is set to</span>
<span class="sd">        &#39;limited&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_SKIP_ENFORCEMENT_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">skip_enforcement</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">skip_enforcement</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not get skip enforcement info, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_skip_enforcement"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_skip_enforcement">[docs]</a>    <span class="k">def</span> <span class="nf">set_skip_enforcement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remaining</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxSkips</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">restoreAfterSec</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the remaining number of skips on the CloudQueue server.</span>
<span class="sd">        :param remaining: :int: the number of skips the server allows, decremented each skip report from the player</span>
<span class="sd">        :param maxSkips: :int: the maximum number of skips allowed by this container</span>
<span class="sd">        :param restoreAfterSec: :int: time after which the cloudqueue server will restore &#39;maxSkips&#39;</span>
<span class="sd">                                      skips back to the user</span>

<span class="sd">        Note: limitedSkipsState object is only returned on itemWindow responses from the server when &#39;limitedSkips&#39;</span>
<span class="sd">        playbackPolicy is set to &#39;true&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pre_json_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;remaining&#39;</span><span class="p">:</span> <span class="n">remaining</span><span class="p">,</span>
                            <span class="s1">&#39;configuration&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;maxSkips&#39;</span><span class="p">:</span> <span class="n">maxSkips</span><span class="p">,</span> <span class="s1">&#39;restoreSkipsAfterSec&#39;</span><span class="p">:</span> <span class="n">restoreAfterSec</span>
                            <span class="p">}}</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">pre_json_payload</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_SKIP_ENFORCEMENT_URI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">POLICY_HEADERS</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to set skip enforcement, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_window_playhead"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_window_playhead">[docs]</a>    <span class="k">def</span> <span class="nf">set_window_playhead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the reports policy on the CQ server using the /context/reports endpoint</span>
<span class="sd">        :param policy: :dict: dictionary report policies</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_WINDOW_PLAYHEAD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">),</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">position</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">POLICY_HEADERS</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not set server itemWindow playhead position, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_window_playhead"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_window_playhead">[docs]</a>    <span class="k">def</span> <span class="nf">get_window_playhead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the reports policy on the CQ server using the /context/reports endpoint</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_WINDOW_PLAYHEAD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">position</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not get playback itemWindow playhead position, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.dump_runtime_logs"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.dump_runtime_logs">[docs]</a>    <span class="k">def</span> <span class="nf">dump_runtime_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints all the current logs to file</span>
<span class="sd">        :param logger:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cq_logs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cq_rdy_path</span><span class="p">,</span> <span class="s2">&quot;cq-port_*&quot;</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">cq_logs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">log</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;===== BEGIN </span><span class="si">{}</span><span class="s2"> ====&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">))</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;===== END </span><span class="si">{}</span><span class="s2"> ====&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not open cq log file (</span><span class="si">{}</span><span class="s2">): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.start_cloud_queue_server"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.start_cloud_queue_server">[docs]</a>    <span class="k">def</span> <span class="nf">start_cloud_queue_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">authToken</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">authTokenLength</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">authTokenExpiration</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">apiKey</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">partnerApiKey</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mediaDelay</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">randomizeMediaDelay</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">upcomingLimit</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">saltTrackURIs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">slowStream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cq_port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint_version</span><span class="o">=</span><span class="mf">2.2</span><span class="p">,</span>
                                 <span class="n">scaMode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">containersPath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">proto</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mediaUnsecured</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">gzip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the javascript mock cloudqueue server that lives in /test/javascript/cloudqueue-api.</span>
<span class="sd">        Default output and error paths pipe to /dev/null but can be overridden by passing in those</span>
<span class="sd">        params through your test.</span>
<span class="sd">        :param delay: Delay in seconds to prevent server from responding. Default: 0 seconds</span>
<span class="sd">        :param mediadelay: Delay in seconds to prevent media server from responding. Default: 0 seconds</span>
<span class="sd">        :param cq_port: optional to add a designated port, still checks that the specified port is currently unused</span>
<span class="sd">        :return: object; a running cloudqueue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_cloud_queue_server</span><span class="p">()</span>
        <span class="n">workspace</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;WORKSPACE&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">workspace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;$WORKSPACE is not set&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Normalize the path to remove any &quot;..&quot;.  node.js will not serve up files that contain &quot;..&quot; in the path</span>
            <span class="c1"># because it is a little paranoid about security.</span>
            <span class="n">workspace</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">workspace</span><span class="p">)</span>
            <span class="n">cq_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/test/javascript/cloudqueue-api&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">workspace</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;cq_path is &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cq_path</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cq_rdy_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cq_rdy_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;sonos-nodejs-cq-&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;/tmp/&quot;</span><span class="p">)</span>

        <span class="n">required_files</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/test/javascript/certificates/sonos-service-mock.dev.ws.sonos.com.p12&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">workspace</span><span class="p">),</span>
                          <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/test/javascript/cloudqueue-api/https/server.crt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">workspace</span><span class="p">),</span>
                          <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/test/javascript/cloudqueue-api/https/server.key&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">workspace</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">required_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> does not exist, SWPBL-113537?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;/tmp/cloudqueue&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;/tmp/cloudqueue media repo does not exist on local testrunner&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cq_music_path</span> <span class="o">=</span> <span class="s2">&quot;/tmp/cloudqueue/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">library_path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>

        <span class="c1"># Check if anything is using the default server port of 3000, if so pick something else</span>
        <span class="k">if</span> <span class="n">cq_port</span><span class="p">:</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">cq_port</span><span class="p">,</span> <span class="n">cq_port</span><span class="o">+</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">3100</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
            <span class="n">port_check</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s1">&#39;lsof -i -P | grep -i &quot;listen&quot; | grep </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
                                          <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">port_check_output</span> <span class="o">=</span> <span class="n">port_check</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">port_check</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">port_check_output</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="c1"># &#39;library&#39;: {key: &#39;l&#39;, args: 1, description: &#39;Full path to music library - will only parse MP3s.&#39;, mandatory: true},</span>
                <span class="c1"># &#39;authToken&#39;: {key: &#39;t&#39;, args: 1, description: &#39;Authentication token. Must be passed in request headers to access resources.&#39;},</span>
                <span class="c1"># &#39;authTokenLength&#39;: {key: &#39;L&#39;, args: 1, description: &#39;Authentication token length.&#39;},</span>
                <span class="c1"># &#39;authTokenExpiration&#39;: {key: &#39;e&#39;, args: 1, description: &#39;Authentication token expiration in minutes. Only used if Auth Token is passed. Default: 30 minutes.&#39;},</span>
                <span class="c1"># &#39;apiKey&#39;: {key: &#39;k&#39;, args: 1, description: &#39;Api Key which will need to be passed in the &quot;key&quot; parameter for requests against the cloud queue.&#39;},</span>
                <span class="c1"># &#39;partnerApiKey&#39;: {key: &#39;K&#39;, args: 1, description: &#39;PartnerApiKey to be used to authorize all requests.&#39;},</span>
                <span class="c1"># &#39;port&#39; : {key: &#39;p&#39;, args: 1, description: &#39;Port to use for the HTTP server. Default: 3000&#39;},</span>
                <span class="c1"># &#39;httpsPort&#39; : {key: &#39;s&#39;, args: 1, description: &#39;Port to use for the HTTPS server. Default: 3443&#39;},</span>
                <span class="c1"># &#39;delay&#39;: {key: &#39;d&#39;, args: 1, description: &#39;Delay in seconds to prevent server from responding. Default: 0 seconds&#39;},</span>
                <span class="c1"># &#39;mediaDelay&#39;: {key: &#39;m&#39;, args: 1, description: &#39;Delay in seconds to prevent media server from responding. Default: 0 seconds&#39;},</span>
                <span class="c1"># &#39;randomizeMediaDelay&#39; : {key: &#39;M&#39;, args: 0, description: &#39;Randomize the media delay, delaying up to mediaDelay. Default: no&#39;},</span>
                <span class="c1"># &#39;upcomingLimit&#39;: {key: &#39;u&#39;, args: 1, description: &#39;Limit on upcoming items to return in window. Default: none&#39;},</span>
                <span class="c1"># &#39;saltTrackURIs&#39;: {key: &#39;a&#39;, args: 0, description: &#39;Add a salt to track URIs (for testing PTS-2086). Default: no salt&#39;},</span>
                <span class="c1"># &#39;slowStream&#39;: {key: &#39;o&#39;, args: 0, description: &#39;Fill the returned track stream with delays to simulate large sync errors. Default: no&#39;},</span>
                <span class="c1"># &#39;scaMode&#39;: {key: &#39;c&#39;, args: 0, description: &#39;Respond to all /itemWindow requests with a 304. Default: no&#39;},</span>
                <span class="c1"># &#39;containers&#39;: {key: &#39;C&#39;, args: 1, description: &#39;Root folder where to find configurations about different containers/cloudqueues&#39;},</span>
                <span class="c1"># &#39;gzip&#39;: {key: &quot;z&quot;, args: 0, description: &quot;Enable gzip support for CQ responses&#39;}</span>

                <span class="n">cq_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cq_path</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">),</span>
                           <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
                           <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="mi">43</span><span class="p">),</span>
                           <span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="n">cq_music_path</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">authToken</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">authToken</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">authTokenLength</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-L&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">authTokenLength</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">authTokenExpiration</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">authTokenExpiration</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">apiKey</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">apiKey</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">partnerApiKey</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-K&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">partnerApiKey</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">delay</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">delay</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">mediaDelay</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mediaDelay</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">randomizeMediaDelay</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-M&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">upcomingLimit</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">upcomingLimit</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">saltTrackURIs</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-a&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-R&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">slowStream</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-o&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">scaMode</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-c&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">containersPath</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-C&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cq_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">containersPath</span><span class="p">))])</span>
                <span class="k">if</span> <span class="n">authToken</span> <span class="ow">and</span> <span class="n">mediaUnsecured</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-A&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">gzip</span><span class="p">:</span>
                    <span class="n">cq_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-z&#39;</span><span class="p">])</span>

                <span class="c1"># Create output files for port</span>
                <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cq_rdy_path</span><span class="p">,</span> <span class="s2">&quot;cq-port_</span><span class="si">{}</span><span class="s2">.stdout&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">)),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
                <span class="n">err</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cq_rdy_path</span><span class="p">,</span> <span class="s2">&quot;cq-port_</span><span class="si">{}</span><span class="s2">.stderr&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">)),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
                <span class="n">cq</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cq_args</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cq_path</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">req_url</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">/playlist/ready&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host_ip</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

                <span class="k">def</span> <span class="nf">check_if_ready</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">req_url</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mock CQ server /playlist/ready endpoint responded with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">status</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span>
                    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wait_until_true</span><span class="p">(</span><span class="n">check_if_ready</span><span class="p">,</span>
                                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                                    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waited too long for the mock CQ server to start&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CQ Server started on port </span><span class="si">{}</span><span class="s2">; logs in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cq_rdy_path</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CQ server failed to start on port </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dump_runtime_logs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">(</span><span class="n">cq</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">proto</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">host_port</span> <span class="o">=</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">43</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">PROTO</span> <span class="o">=</span> <span class="s2">&quot;https&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">host_port</span> <span class="o">=</span> <span class="n">port</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">PROTO</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">://</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROTO</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_port</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CQ_DOMAIN_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">://</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROTO</span><span class="p">,</span>
                                                         <span class="s2">&quot;mock.dev.ws.sonos.com&quot;</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">host_port</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">proto</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/musicqueue/v</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_DOMAIN_URI</span><span class="p">,</span>
                                                                       <span class="n">endpoint_version</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CQ_PLAYBACK_URI</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/musicqueue/v</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">,</span>
                                                                       <span class="n">endpoint_version</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;grep&quot;</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p1</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_runtime_logs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;CQ Server failed to find open port, node processes: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cq</span> <span class="o">=</span> <span class="n">cq</span>
        <span class="k">return</span> <span class="n">cq</span></div>

<div class="viewcode-block" id="CloudQueueControl.stop_cloud_queue_server"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.stop_cloud_queue_server">[docs]</a>    <span class="k">def</span> <span class="nf">stop_cloud_queue_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cq_server</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kills the mock CQ server</span>
<span class="sd">        :param cq_server:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cq_server</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="c1"># Don&#39;t try to read the error codes in cases where the CQ is piping output to /dev/null</span>
            <span class="k">if</span> <span class="n">cq_server</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cq_server</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">and</span> <span class="n">cq_server</span><span class="o">.</span><span class="n">stderr</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;CQ server failed [</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cq_server</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span>
                                                                         <span class="n">cq_server</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">readlines</span><span class="p">(),</span>
                                                                         <span class="n">cq_server</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_cq</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">del</span> <span class="n">cq_server</span></div>

<div class="viewcode-block" id="CloudQueueControl.delete_all_logs"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.delete_all_logs">[docs]</a>    <span class="k">def</span> <span class="nf">delete_all_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes ALL cloudqueue logs and directories, ignoring errors</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;/tmp/sonos-nodejs-cq-*/&quot;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueControl.reset_cloud_queue_server"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.reset_cloud_queue_server">[docs]</a>    <span class="k">def</span> <span class="nf">reset_cloud_queue_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cq</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueControl.has_cloud_queue_logs"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.has_cloud_queue_logs">[docs]</a>    <span class="k">def</span> <span class="nf">has_cloud_queue_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cq_rdy_path</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cq_rdy_path</span><span class="p">,</span> <span class="s2">&quot;cq-port_*&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="CloudQueueControl.start_cloudqueue_server"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.start_cloudqueue_server">[docs]</a>    <span class="k">def</span> <span class="nf">start_cloudqueue_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this function is deprecated; use start_cloud_queue_server</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_cloud_queue_server</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueControl.stop_cloudqueue_server"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.stop_cloudqueue_server">[docs]</a>    <span class="k">def</span> <span class="nf">stop_cloudqueue_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cq_server</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this function is deprecated; use stop_cloud_queue_server</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_cloud_queue_server</span><span class="p">(</span><span class="n">cq_server</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudQueueControl.set_cloudqueue_option"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.set_cloudqueue_option">[docs]</a>    <span class="k">def</span> <span class="nf">set_cloudqueue_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets mock CQ server options while it is running</span>
<span class="sd">        :param options:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/options&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]},</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to set slowstream, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.update_cloudqueue_version"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.update_cloudqueue_version">[docs]</a>    <span class="k">def</span> <span class="nf">update_cloudqueue_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modify the CQ version while the server is running. Causes the CQ to</span>
<span class="sd">        generate a new random version string.</span>

<span class="sd">        :return str: New version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_QUEUE_VERSION</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to change queueversion, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_context"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_context">[docs]</a>    <span class="k">def</span> <span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queueVersion</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">contextVersion</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/musicqueue/v2.1/context&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span>
                               <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;queueVersion&#39;</span><span class="p">:</span><span class="n">queueVersion</span><span class="p">,</span> <span class="s1">&#39;contextVersion&#39;</span><span class="p">:</span><span class="n">contextVersion</span><span class="p">},</span>
                               <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to get context, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.update_context_version"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.update_context_version">[docs]</a>    <span class="k">def</span> <span class="nf">update_context_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modify the context version while the server is running. Causes the CQ to</span>
<span class="sd">        generate a new random version string.</span>

<span class="sd">        :return str: New version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_CONTEXT_VERSION</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to update the context version, server returned </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_raw_response"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_raw_response">[docs]</a>    <span class="k">def</span> <span class="nf">get_raw_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param responses: :list: list of raw response strings, most likely from self.muse.raw_responses</span>
<span class="sd">        :param type: :str: String object to feed into the filter below. I like to use the event &#39;type&#39;</span>
<span class="sd">        :param position: :int: Return a specific response or if None, the whole list of filtered responses</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filtered_responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">f</span><span class="p">,</span> <span class="n">responses</span><span class="p">):</span>
            <span class="n">filtered_responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">position</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filtered_responses</span><span class="p">[</span><span class="n">position</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">filtered_responses</span><span class="p">[</span><span class="n">position</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filtered_responses</span></div>

<div class="viewcode-block" id="CloudQueueControl.get_device_id_in_header"><a class="viewcode-back" href="../../../webserver.helpers.html#webserver.helpers.cloud_queue_control.CloudQueueControl.get_device_id_in_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_device_id_in_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">apilog</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/logs/apilog&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CQ_URI</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">apilog</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">text</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                    <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;fullUrl&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;fullUrl&#39;</span><span class="p">],</span> <span class="s1">&#39;deviceId&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;deviceId&#39;</span><span class="p">],</span> <span class="s1">&#39;userAgent&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;userAgent&#39;</span><span class="p">]})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Will not get HTTP headers.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">headers</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>