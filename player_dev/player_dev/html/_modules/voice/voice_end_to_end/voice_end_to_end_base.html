
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>voice.voice_end_to_end.voice_end_to_end_base &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for voice.voice_end_to_end.voice_end_to_end_base</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">Queue</span> <span class="k">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Empty</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">socket</span> <span class="k">import</span> <span class="n">gaierror</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">sonos.websrv</span> <span class="k">import</span> <span class="n">WebServer</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">WorkflowTestFixture</span><span class="p">,</span> <span class="n">AssertionLevel</span>
<span class="kn">from</span> <span class="nn">sftp.sonosSFTP</span> <span class="k">import</span> <span class="n">SonosAutomationSFTP</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">UPnPError</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span><span class="p">,</span> <span class="n">XMLAccessor</span>
<span class="kn">from</span> <span class="nn">sonos.voice.amazon</span> <span class="k">import</span> <span class="n">PreAuthorizedAmazonVoiceServiceAccount</span>
<span class="kn">from</span> <span class="nn">sonos.voice.constants</span> <span class="k">import</span> <span class="n">VoiceServices</span><span class="p">,</span> <span class="n">VoiceNicknames</span>
<span class="kn">from</span> <span class="nn">upnp.helpers.diag</span> <span class="k">import</span> <span class="n">UDPDiagnosticModuleMonitor</span>
<span class="kn">from</span> <span class="nn">voice_util.voice_overlay</span> <span class="k">import</span> <span class="n">VoiceOverlay</span>
<span class="kn">from</span> <span class="nn">voice_util.wav_to_raw</span> <span class="k">import</span> <span class="n">WavToRaw</span>
<span class="kn">from</span> <span class="nn">jenkins.disable_node</span> <span class="k">import</span> <span class="n">DisableTestbed</span>
<span class="kn">from</span> <span class="nn">sonos.client.zp_logger</span> <span class="k">import</span> <span class="n">ZpLogger</span><span class="p">,</span> <span class="n">Logs</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">sonos.client.zone_player</span> <span class="k">import</span> <span class="n">DEVICES_WITH_BUILT_IN_MICS</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">VOICETAP_PATH_BASE</span> <span class="o">=</span> <span class="s2">&quot;/Automation/voicetap/alexa_tests_wav/&quot;</span>
<span class="n">WEB_SRV_PORT</span> <span class="o">=</span> <span class="mi">8080</span>
<span class="n">WEB_SRV_PATH</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
<span class="n">LOCAL_WEB_SERVER</span> <span class="o">=</span> <span class="s1">&#39;local_web_server&#39;</span>
<span class="n">DEFAULT_TIMEOUT</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">VOICETAP</span> <span class="o">=</span> <span class="s2">&quot;voicetap.raw&quot;</span>
<span class="n">JFFS</span> <span class="o">=</span> <span class="s1">&#39;/jffs/&#39;</span>
<span class="n">TIMEOUT_REASON</span> <span class="o">=</span> <span class="s2">&quot;Timeout waiting for </span><span class="si">{}</span><span class="s2">.&quot;</span>

<span class="n">AVS_RECONNECT_TIMEOUT</span> <span class="o">=</span> <span class="mi">300</span>
<span class="c1"># event state related defines to make code more readable.</span>
<span class="n">EVENT_RECD</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">REASON</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">NUM_RECD</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">NUM_PROCESSED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">AVS_REASON</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># music sources</span>
<span class="n">SHARE</span> <span class="o">=</span> <span class="s1">&#39;share&#39;</span>
<span class="n">QUEUE</span> <span class="o">=</span> <span class="s1">&#39;queue&#39;</span>
<span class="n">TV</span> <span class="o">=</span> <span class="s1">&#39;tv&#39;</span>
<span class="n">RADIO</span> <span class="o">=</span> <span class="s1">&#39;radio&#39;</span>
<span class="n">HTTP</span> <span class="o">=</span> <span class="s1">&#39;http&#39;</span>
<span class="n">CIFS</span> <span class="o">=</span> <span class="s1">&#39;cifs&#39;</span>
<span class="n">INTERNET</span> <span class="o">=</span> <span class="s1">&#39;internet&#39;</span>
<span class="n">INTERNET_HLS</span> <span class="o">=</span> <span class="s1">&#39;hls&#39;</span>
<span class="n">LINEIN</span> <span class="o">=</span> <span class="s1">&#39;linein&#39;</span>
<span class="n">SPDIF</span> <span class="o">=</span> <span class="s1">&#39;spdif&#39;</span>
<span class="n">TV_URI</span> <span class="o">=</span> <span class="s1">&#39;x-sonos-htastream:</span><span class="si">{}</span><span class="s1">:spdif&#39;</span>
<span class="n">SHARE_TRACK_URI</span> <span class="o">=</span> <span class="s1">&#39;x-rincon-queue:</span><span class="si">{}</span><span class="s1">#0&#39;</span>
<span class="n">SHARE_TRACK</span> <span class="o">=</span> <span class="s1">&#39;MaggieFarm.mp3&#39;</span>
<span class="n">AUDIO_SOURCES</span> <span class="o">=</span> <span class="p">[</span><span class="n">SHARE</span><span class="p">,</span> <span class="n">INTERNET</span><span class="p">,</span> <span class="n">INTERNET_HLS</span><span class="p">,</span> <span class="n">LINEIN</span><span class="p">,</span> <span class="n">SPDIF</span><span class="p">]</span>

<span class="n">RADIO_URI</span> <span class="o">=</span> <span class="s1">&#39;x-sonosapi-stream:s21342?sid=254&amp;flags=8224&amp;sn=0&#39;</span>
<span class="n">RADIO_MD</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&lt;DIDL-Lite xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:upnp&#39;</span>
            <span class="s1">&#39;=&quot;urn:schemas-upnp-org:metadata-1-0/upnp/&quot; xmlns:r=&quot;urn:schemas-&#39;</span>
            <span class="s1">&#39;rinconnetworks-com:metadata-1-0/&quot; xmlns=&quot;urn:schemas-upnp-&#39;</span>
            <span class="s1">&#39;org:metadata-1-0/DIDL-Lite/&quot;&gt;&lt;item id=&quot;-1&quot; parentID=&quot;-1&quot; &#39;</span>
            <span class="s1">&#39;restricted=&quot;true&quot;&gt;&lt;dc:title&gt;Classic Hits 93.1&lt;/dc:title&gt;&#39;</span>
            <span class="s1">&#39;&lt;upnp:class&gt;object.item.audioItem.audioBroadcast&lt;/upnp:class&gt;&#39;</span>
            <span class="s1">&#39;&lt;desc id=&quot;cdudn&quot; nameSpace=&quot;urn:schemas-rinconnetworks-com:&#39;</span>
            <span class="s1">&#39;metadata-1-0/&quot;&gt;SA_RINCON65031_&lt;/desc&gt;&lt;/item&gt;&lt;/DIDL-Lite&gt;&#39;</span><span class="p">)</span>

<span class="n">RETRY_SECONDS</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">MAX_RETIRES</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">AVS_NO_CONNECTION_EXCEPTION</span> <span class="o">=</span> <span class="s1">&#39;AVS Connection Failure exception!&#39;</span>

<span class="n">CONNECTED</span> <span class="o">=</span> <span class="s1">&#39;CONNECTED&#39;</span>


<span class="c1"># TTS max response time</span>
<span class="n">TTS_MAX_RESPONSE_TIME</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># generator defines</span>
<span class="c1"># playing states</span>
<span class="n">PLAYING</span> <span class="o">=</span> <span class="s1">&#39;playing&#39;</span>
<span class="n">IDLE</span> <span class="o">=</span> <span class="s1">&#39;idle&#39;</span>
<span class="n">PLAYING_STATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">IDLE</span>
    <span class="c1"># PLAYING</span>
<span class="p">]</span>

<span class="c1"># configuration, voice zp config state</span>
<span class="n">STANDALONE</span> <span class="o">=</span> <span class="s1">&#39;standalone&#39;</span>
<span class="n">GROUP_GC</span> <span class="o">=</span> <span class="s1">&#39;group_gc&#39;</span>
<span class="n">GROUP_GM</span> <span class="o">=</span> <span class="s1">&#39;group_gm&#39;</span>
<span class="n">STEREO_LEFT</span> <span class="o">=</span> <span class="s1">&#39;stereo_left&#39;</span>
<span class="n">STEREO_RIGHT</span> <span class="o">=</span> <span class="s1">&#39;stereo_right&#39;</span>
<span class="n">HT_REAR</span> <span class="o">=</span> <span class="s1">&#39;ht_rear&#39;</span>
<span class="n">CONFIG_STATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">STANDALONE</span><span class="p">,</span>
    <span class="n">GROUP_GC</span><span class="p">,</span>
    <span class="n">GROUP_GM</span>
    <span class="c1"># STEREO_LEFT,</span>
    <span class="c1"># STEREO_RIGHT,</span>
    <span class="c1"># HT_REAR</span>
<span class="p">]</span>


<div class="viewcode-block" id="AVSConnectionFailureException"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSConnectionFailureException">[docs]</a><span class="k">class</span> <span class="nc">AVSConnectionFailureException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    AVS Connection failure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="VoiceEvents"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEvents">[docs]</a><span class="k">class</span> <span class="nc">VoiceEvents</span><span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Voice Events management class. Handle voice events using udp logger.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># voice events to watch for</span>
    <span class="c1"># non-avs player voice events</span>
    <span class="n">VOICE_OVERLAY_START</span> <span class="o">=</span> <span class="s2">&quot;opened input overlay&quot;</span>
    <span class="n">VOICE_OVERLAY_END</span> <span class="o">=</span> <span class="s2">&quot;input overlay file eof&quot;</span>
    <span class="n">VOICE_OVERLAY_REWIND</span> <span class="o">=</span> <span class="s1">&#39;rewinding input overlay&#39;</span>
    <span class="n">WAKEWORD_DETECTED</span> <span class="o">=</span> <span class="s2">&quot;uploading stream&quot;</span>
    <span class="n">SILENCE_DETECTED</span> <span class="o">=</span> <span class="s2">&quot;no speech detected&quot;</span>
    <span class="n">VOICE_UPLOAD</span> <span class="o">=</span> <span class="s2">&quot;voice_upload&quot;</span>
    <span class="n">AMP_OFF</span> <span class="o">=</span> <span class="s2">&quot;AMP - AMP_OFF&quot;</span>
    <span class="n">DUCKING</span> <span class="o">=</span> <span class="s1">&#39;\[(?:default|hta-chsnk|inline)-mixer\]: ducking streams&#39;</span>
    <span class="n">UN_DUCKING</span> <span class="o">=</span> <span class="s1">&#39;\[(?:default|hta-chsnk|inline)-mixer\]: unducking streams&#39;</span>
    <span class="n">PROCESSING_STREAM</span> <span class="o">=</span> <span class="s1">&#39;processing STREAM&#39;</span>
    <span class="n">SET_VOLUME</span> <span class="o">=</span> <span class="s1">&#39;Set volume&#39;</span>
    <span class="n">FADE_ADDED</span> <span class="o">=</span> <span class="s1">&#39;fade added&#39;</span>
    <span class="c1"># avs transactions</span>
    <span class="n">AVS_DIRECTIVE_RECD</span> <span class="o">=</span> <span class="s2">&quot;recv&#39;d msg:&quot;</span>
    <span class="n">AVS_EVENT_SENT</span> <span class="o">=</span> <span class="s2">&quot;sending event:&quot;</span>
    <span class="c1"># voice controller reporting</span>
    <span class="n">SPEECH_PLAYBACK_FINISHING</span> <span class="o">=</span> <span class="s1">&#39;SpeechPlaybackFinishing&#39;</span>
    <span class="n">SPEECH_PLAYBACK_STARTING</span> <span class="o">=</span> <span class="s1">&#39;SpeechPlaybackStarting&#39;</span>
    <span class="n">NEW_DIALOG_NEEDED</span> <span class="o">=</span> <span class="s1">&#39;New dialog needed&#39;</span>
    <span class="n">VOICE_UPLOAD_FINISH</span> <span class="o">=</span> <span class="s1">&#39;handleUploadFinishing&#39;</span>
    <span class="n">VOICE_UPLOAD_FINISHED</span> <span class="o">=</span> <span class="s1">&#39;handleUploadFinished&#39;</span>
    <span class="n">VOICE_PLAYBACK_STARTED</span> <span class="o">=</span> <span class="s1">&#39;handleExternalPlaybackStarted&#39;</span>
    <span class="n">AVS_RECONNECT</span> <span class="o">=</span> <span class="s1">&#39;re-kicking connect&#39;</span>
    <span class="n">AVS_CONNECTED_STATUS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;connection status change from PENDING \[\d</span><span class="si">{1}</span><span class="s1">\]&#39;</span>
                            <span class="s1">&#39; to CONNECTED \[\d</span><span class="si">{1}</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">AVS_ENDPOINT_REVERT</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;reverting endpoint to &#39;</span>
                           <span class="s1">&#39;https:\/\/avs-alexa-na.amazon.com&#39;</span><span class="p">)</span>
    <span class="n">AVS_ENDPOINT_SAVED</span> <span class="o">=</span> <span class="s1">&#39;new endpoint saved https:\/\/avs-alexa-na.amazon.com&#39;</span>
    <span class="n">VOICEFEEDBACK_TIMEOUT_EXCEEDED</span> <span class="o">=</span> <span class="s1">&#39;VoiceFeedback timeout exceeded&#39;</span>

    <span class="c1"># avs connection failures other then reconnect or explicit reconnect based</span>
    <span class="c1"># on pingpong threshold.</span>
    <span class="n">AVS_REQ_DISCONNECT</span> <span class="o">=</span> <span class="s1">&#39;requesting disconnect \[ppthresh\]&#39;</span>
    <span class="n">AVS_FAILED_SEND</span> <span class="o">=</span> <span class="s1">&#39;failed send \[NOT_CONNECTED\]&#39;</span>
    <span class="n">AVS_EVENT_REJECTED</span> <span class="o">=</span> <span class="s1">&#39;event rejected. state \[DISCONNECTED\]&#39;</span>
    <span class="n">AVS_NOT_CONNECTED</span> <span class="o">=</span> <span class="s1">&#39;checking connect \[DISCONNECTED\]&#39;</span>
    <span class="n">AVS_DROPPED_EVENT</span> <span class="o">=</span> <span class="s1">&#39;dropped event&#39;</span>
    <span class="n">AVS_INTERNAL_ERROR</span> <span class="o">=</span> <span class="s1">&#39;SERVER_INTERNAL_ERROR_V2&#39;</span>

    <span class="c1"># AVS alert events</span>
    <span class="n">AVS_ALERT_STARTED</span> <span class="o">=</span> <span class="s1">&#39;AlertStarted&#39;</span>
    <span class="n">AVS_DELETE_ALERT_SUCCEEDED</span> <span class="o">=</span> <span class="s1">&#39;DeleteAlertSucceeded&#39;</span>

    <span class="c1"># AVS connection related events.</span>
    <span class="n">AVS_CONNECT_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
                          <span class="n">AVS_RECONNECT</span><span class="p">,</span>
                          <span class="n">AVS_ENDPOINT_REVERT</span><span class="p">,</span>
                          <span class="n">AVS_ENDPOINT_SAVED</span>
                         <span class="p">]</span>

    <span class="c1"># aggregating events in logical groups</span>
    <span class="n">VOICEP_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
                     <span class="n">VOICE_OVERLAY_START</span><span class="p">,</span>
                     <span class="n">VOICE_OVERLAY_END</span><span class="p">,</span>
                     <span class="n">VOICE_OVERLAY_REWIND</span><span class="p">,</span>
                     <span class="n">WAKEWORD_DETECTED</span>
                    <span class="p">]</span>

    <span class="n">AVS_TRANSACTIONS</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">AVS_DIRECTIVE_RECD</span><span class="p">,</span>
                        <span class="n">AVS_EVENT_SENT</span><span class="p">,</span>
                        <span class="p">]</span>

    <span class="n">AVS_TRANSACTION_TO_MSG_MAP</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;directive&quot;</span><span class="p">:</span> <span class="n">AVS_DIRECTIVE_RECD</span><span class="p">,</span>
                                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="n">AVS_EVENT_SENT</span>
                                 <span class="p">}</span>

    <span class="c1"># avs connection failure indicators.</span>
    <span class="n">AVS_CONNECTION_FAILURES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">AVS_REQ_DISCONNECT</span><span class="p">,</span>
        <span class="n">AVS_FAILED_SEND</span><span class="p">,</span>
        <span class="n">AVS_EVENT_REJECTED</span><span class="p">,</span>
        <span class="n">AVS_NOT_CONNECTED</span><span class="p">,</span>
        <span class="n">AVS_INTERNAL_ERROR</span>
    <span class="p">]</span>

    <span class="n">MIXER_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">DUCKING</span><span class="p">,</span>
                    <span class="n">UN_DUCKING</span>
                    <span class="p">]</span>

    <span class="n">EXT_AUDIO_SRC_EVENTS</span> <span class="o">=</span> <span class="p">[</span><span class="n">PROCESSING_STREAM</span><span class="p">]</span>

    <span class="n">VOICE_CONTROLLER_EVENTS</span> <span class="o">=</span> <span class="p">[</span><span class="n">SILENCE_DETECTED</span><span class="p">,</span>
                               <span class="n">VOICE_UPLOAD_FINISH</span><span class="p">,</span>
                               <span class="n">VOICE_UPLOAD_FINISHED</span><span class="p">,</span>
                               <span class="n">VOICEFEEDBACK_TIMEOUT_EXCEEDED</span><span class="p">,</span>
                               <span class="n">VOICE_PLAYBACK_STARTED</span><span class="p">]</span>

    <span class="c1"># overall voice events that we will look for in tests</span>
    <span class="n">VOICE_EVENTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;voicep&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">4</span><span class="p">:</span> <span class="n">VOICEP_EVENTS</span><span class="p">},</span>
        <span class="s1">&#39;voictrlr&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">5</span><span class="p">:</span> <span class="n">VOICE_CONTROLLER_EVENTS</span><span class="p">},</span>
        <span class="s1">&#39;mixer&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">3</span><span class="p">:</span> <span class="n">MIXER_EVENTS</span><span class="p">},</span>
        <span class="s1">&#39;extaudiosrc&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">3</span><span class="p">:</span> <span class="n">EXT_AUDIO_SRC_EVENTS</span><span class="p">},</span>
        <span class="s1">&#39;reporting&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="n">VOICE_UPLOAD</span><span class="p">]},</span>
        <span class="s1">&#39;attenuation&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="n">FADE_ADDED</span><span class="p">]},</span>
        <span class="s1">&#39;avs2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">5</span><span class="p">:</span> <span class="n">AVS_TRANSACTIONS</span> <span class="o">+</span> <span class="n">AVS_CONNECT_EVENTS</span><span class="p">},</span>
        <span class="s1">&#39;buttons&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="n">AMP_OFF</span><span class="p">]},</span>
        <span class="s1">&#39;rc_impl&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="n">SET_VOLUME</span><span class="p">]},</span>
        <span class="s1">&#39;leds_zp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">3</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;enable:&#39;</span><span class="p">,</span> <span class="s1">&#39;apply led mode mode&#39;</span><span class="p">]}</span>
    <span class="p">}</span>

    <span class="c1"># when any of these AVS_CONNECTION_FAILURES occurs, stop the current test,</span>
    <span class="c1"># wait for reconnect when proceed with the test.</span>
    <span class="n">AVS_FATAL_CONNECTION_FAILURES</span> <span class="o">=</span> <span class="p">{</span>
                                      <span class="s1">&#39;avs2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">4</span><span class="p">:</span> <span class="n">AVS_CONNECTION_FAILURES</span><span class="p">}</span>
                                    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span> <span class="o">=</span> <span class="n">zp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wake_word_detected_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="c1"># avs events can come in and get detected by udplogger thread much</span>
        <span class="c1"># faster than the main test thread processing of events. So keep a</span>
        <span class="c1"># count of current number of events and directives received and</span>
        <span class="c1"># update as soon as there is a new event. This happens a lot with</span>
        <span class="c1">#  multi-turn</span>
        <span class="c1"># Note: Store avs directives and events in queue and process them</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_test_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># keep state of non avs player voice events as received via udp</span>
        <span class="c1"># logger and the reason to report in case the event is not</span>
        <span class="c1"># received before timeout.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_states</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VOICE_OVERLAY_END</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;voice overlay finish&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VOICE_OVERLAY_START</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;voice overlay start&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VOICE_OVERLAY_REWIND</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;voice overlay rewind&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">WAKEWORD_DETECTED</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;wake word &#39;&#39;detection&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SILENCE_DETECTED</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;silence detection&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VOICE_UPLOAD_FINISH</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;voice upload finish&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AVS_RECONNECT</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;avs reconnect&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AVS_CONNECTED_STATUS</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Failed to make AVS connection&#39;</span><span class="p">)</span>
                <span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AVS_ENDPOINT_REVERT</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;avs endpoint revert&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AVS_ENDPOINT_SAVED</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;avs endpoint saved&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AMP_OFF</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;amp off&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DUCKING</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;ducking&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UN_DUCKING</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;un ducking&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SET_VOLUME</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;set volume event&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AVS_ALERT_STARTED</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;avs alert started&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AVS_DELETE_ALERT_SUCCEEDED</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;avs delete alert succeeded&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VOICEFEEDBACK_TIMEOUT_EXCEEDED</span><span class="p">:</span> <span class="p">[</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;voice feedback timeout exceeded&#39;</span><span class="p">)]</span>
        <span class="p">}</span>

        <span class="c1"># keep state of number of avs transactions (directives or events)</span>
        <span class="c1"># received and processed. Report the reason if transaction is not</span>
        <span class="c1"># received before timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_states</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AVS_DIRECTIVE_RECD</span><span class="p">:</span> <span class="p">[</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;directive from amazon&#39;</span><span class="p">)],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AVS_EVENT_SENT</span><span class="p">:</span> <span class="p">[</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TIMEOUT_REASON</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;event sent to amazon&#39;</span><span class="p">)],</span>
            <span class="p">}</span>
        <span class="c1"># check for playback errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># misc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wake_word_detected_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish_upload_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_playing_response_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avs_reconnect</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avs_endpoint_saved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avs_endpoint_revert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avs_connection_failure_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avs_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avs_disconnected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_avs_connection_recovery</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="VoiceEvents.set_current_test_name"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEvents.set_current_test_name">[docs]</a>    <span class="k">def</span> <span class="nf">set_current_test_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_test_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the current running test name.</span>

<span class="sd">        :param current_test_name: The current running test name.</span>
<span class="sd">        :type current_test_name: :str:</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_test_name</span> <span class="o">=</span> <span class="n">current_test_name</span></div>

<div class="viewcode-block" id="VoiceEvents.get_current_test_name"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEvents.get_current_test_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_test_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current running test name.</span>

<span class="sd">        :return: The current running test name.</span>
<span class="sd">        :rtype: :str:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_test_name</span></div>

<div class="viewcode-block" id="VoiceEvents.cb_watch_event"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEvents.cb_watch_event">[docs]</a>    <span class="k">def</span> <span class="nf">cb_watch_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">counters</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback when a watch string matches</span>
<span class="sd">        :param str msg: anacapa log message from udplogger</span>
<span class="sd">        :param zp: Sonos zone component</span>
<span class="sd">        :type zp: :class:`~sonos.client.SonosZoneComponent`</span>
<span class="sd">        :param expr: Watch string used to get matching log msg via udplogger</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;expr = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
        <span class="c1"># check if the event is from one of the avs transactions or a</span>
        <span class="c1"># a non-avs player voice event</span>
        <span class="k">if</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_states</span><span class="p">[</span><span class="n">expr</span><span class="p">][</span><span class="n">EVENT_RECD</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_states</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVS_DIRECTIVE_RECD</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding AVS &#39;DIRECTIVE&#39; to transaction queue.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVS_EVENT_SENT</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding player AVS &#39;EVENT&#39; to transaction &quot;</span>
                                 <span class="s2">&quot;queue.&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AVS transaction added to queue&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AVS Transactions queue content: </span><span class="si">{}</span><span class="s2">&quot;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_queue</span><span class="o">.</span><span class="n">queue</span><span class="p">))</span>
            <span class="c1"># increment count of number of avs transaction caught for tracking</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_states</span><span class="p">[</span><span class="n">expr</span><span class="p">][</span><span class="n">NUM_RECD</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;self.avs_transaction_states[expr] = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_states</span><span class="p">[</span><span class="n">expr</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;self.avs_transaction_states[expr][NUM_RECD] = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_states</span><span class="p">[</span><span class="n">expr</span><span class="p">][</span><span class="n">NUM_RECD</span><span class="p">]))</span>

        <span class="c1"># handle special cases</span>
        <span class="c1"># save wakeword detection message for extract VAD info from msg.</span>
        <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">WAKEWORD_DETECTED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wake_word_detected_msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="c1"># save times to measure time between finishing voice upload and</span>
        <span class="c1"># downloading and playing voice upload via ext audio src</span>
        <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOICE_UPLOAD_FINISH</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish_upload_msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="c1"># AVS endpoint related entries</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AVS_ENDPOINT_SAVED</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avs_endpoint_saved</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AVS_ENDPOINT_REVERT</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avs_endpoint_revert</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AVS_CONNECTED_STATUS</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_avs_connection_recovery</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AVS_ALERT_STARTED</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">AVS_ALERT_STARTED</span><span class="p">][</span><span class="n">EVENT_RECD</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AVS_DELETE_ALERT_SUCCEEDED</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">AVS_DELETE_ALERT_SUCCEEDED</span><span class="p">][</span>
                <span class="n">EVENT_RECD</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VOICE_PLAYBACK_STARTED</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_playing_response_msg</span> <span class="o">=</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="VoiceEvents.reset_states"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEvents.reset_states">[docs]</a>    <span class="k">def</span> <span class="nf">reset_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset event states</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Resetting voice event states&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_states</span><span class="p">[</span><span class="n">event</span><span class="p">][</span><span class="n">EVENT_RECD</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">avs_transaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_states</span><span class="p">[</span><span class="n">avs_transaction</span><span class="p">][</span><span class="n">NUM_RECD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_states</span><span class="p">[</span><span class="n">avs_transaction</span><span class="p">][</span><span class="n">NUM_PROCESSED</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wake_word_detected_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">empty_avs_msg_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avs_disconnected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avs_reconnect</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_avs_connection_recovery</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="VoiceEvents.wait_for_event"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEvents.wait_for_event">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">DEFAULT_TIMEOUT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for a given event</span>
<span class="sd">        :param str event: Log event aka watch string to wait for</span>
<span class="sd">        :param int timeout_seconds: Timeout waiting for the event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVS_TRANSACTIONS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for AVS Transaction: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
            <span class="n">wait_until_true</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_states</span><span class="p">[</span><span class="n">event</span><span class="p">][</span><span class="n">NUM_RECD</span><span class="p">]</span> <span class="o">&gt;</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_states</span><span class="p">[</span><span class="n">event</span><span class="p">][</span><span class="n">NUM_PROCESSED</span><span class="p">]),</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_states</span><span class="p">[</span><span class="n">event</span><span class="p">][</span><span class="n">AVS_REASON</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_states</span><span class="p">[</span><span class="n">event</span><span class="p">][</span><span class="n">NUM_PROCESSED</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for non-AVS transaction event: </span><span class="si">{}</span><span class="s2">&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_states</span><span class="p">[</span><span class="n">event</span><span class="p">][</span><span class="n">EVENT_RECD</span><span class="p">],</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">,</span>
                            <span class="n">reason</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">event_states</span><span class="p">[</span><span class="n">event</span><span class="p">][</span><span class="n">REASON</span><span class="p">])</span>
            <span class="c1"># reset state to false to allow detecting next event</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_states</span><span class="p">[</span><span class="n">event</span><span class="p">][</span><span class="n">EVENT_RECD</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="VoiceEvents.cb_detected_error"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEvents.cb_detected_error">[docs]</a>    <span class="k">def</span> <span class="nf">cb_detected_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">counters</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback on detecting error string</span>
<span class="sd">        :param str msg: error message</span>
<span class="sd">        :param zp: Sonos zone component on which error string was detected</span>
<span class="sd">        :type zp: :class:`~sonos.client.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Detected error: </span><span class="si">{}</span><span class="s2"> on &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">avs_connnection_error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVS_CONNECTION_FAILURES</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_avs_connection_recovery</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">avs_connnection_error</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;!! AVS CONNECTION FAILURE SEEN !!&quot;</span><span class="p">)</span>
                    <span class="c1"># go into waiting to waiting for avs connection</span>
                    <span class="c1"># recovery mode until connection is restored.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">avs_disconnected</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_avs_connection_recovery</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># raise sigusr1 by returning false here.</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="VoiceEvents.setup_udplogger"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEvents.setup_udplogger">[docs]</a>    <span class="k">def</span> <span class="nf">setup_udplogger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Udp logger set up.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting up udp logger on: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_raise</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_watch</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cb_watch_event</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VOICE_EVENTS</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AVS_FATAL_CONNECTION_FAILURES</span><span class="p">,</span>
            <span class="n">reset</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># restart_logging for this device</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_fatal_errors_callbacks</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avs_connection_fail_signal_handler</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cb_detected_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turn_on_upnp_invocation_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEvents.avs_connection_fail_signal_handler"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEvents.avs_connection_fail_signal_handler">[docs]</a>    <span class="k">def</span> <span class="nf">avs_connection_fail_signal_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Signal handler when a avs connection failure is encountered from</span>
<span class="sd">        matching UDP logging. Executes in main thread.</span>

<span class="sd">        :param signum: Signal number</span>
<span class="sd">        :type signum: :obj: `int`</span>

<span class="sd">        :param frame: Current stack frame</span>
<span class="sd">        :type frame: Frame object</span>

<span class="sd">        :return: None):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">AVSConnectionFailureException</span><span class="p">(</span><span class="n">AVS_NO_CONNECTION_EXCEPTION</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEvents.teardown_udplogger"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEvents.teardown_udplogger">[docs]</a>    <span class="k">def</span> <span class="nf">teardown_udplogger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        UDP logger teardown</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tearing down udp logger on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dataframe_to_hdf</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_timeline-</span><span class="si">{}</span><span class="s1">.h5&#39;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unreg_fatal_errors_callbacks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turn_off_upnp_invocation_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_watch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEvents.empty_avs_msg_queue"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEvents.empty_avs_msg_queue">[docs]</a>    <span class="k">def</span> <span class="nf">empty_avs_msg_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Empty event queue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Emptying avs message queues&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="AVSValidationException"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSValidationException">[docs]</a><span class="k">class</span> <span class="nc">AVSValidationException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception while validating AVS transaction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="AVSTransactionValidator"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator">[docs]</a><span class="k">class</span> <span class="nc">AVSTransactionValidator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to perform AVS directive validation against a json with directive</span>
<span class="sd">    specs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DIRECTIVE</span> <span class="o">=</span> <span class="s2">&quot;directive&quot;</span>
    <span class="n">EVENT</span> <span class="o">=</span> <span class="s2">&quot;event&quot;</span>
    <span class="n">MUTE_CHANGED</span> <span class="o">=</span> <span class="s2">&quot;MuteChanged&quot;</span>
    <span class="n">VOLUME_CHANGED</span> <span class="o">=</span> <span class="s2">&quot;VolumeChanged&quot;</span>
    <span class="n">DIALOG_ID</span> <span class="o">=</span> <span class="s2">&quot;dialogRequestId&quot;</span>
    <span class="n">MESSAGE_ID</span> <span class="o">=</span> <span class="s2">&quot;messageId&quot;</span>
    <span class="n">STOP_CAPTURE</span> <span class="o">=</span> <span class="s2">&quot;SpeechRecognizer.StopCapture&quot;</span>
    <span class="n">SPATIAL_DATA</span> <span class="o">=</span> <span class="s2">&quot;SpeechRecognizer.ReportEchoSpatialPerceptionData&quot;</span>
    <span class="n">USER_INACTIVITY_REPORT</span> <span class="o">=</span> <span class="s2">&quot;System.UserInactivityReport&quot;</span>
    <span class="n">SPEAK_DIRECTIVE</span> <span class="o">=</span> <span class="s2">&quot;SpeechSynthesizer.Speak&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">json_spec_file</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_json_from_file</span><span class="p">(</span><span class="n">json_spec_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span> <span class="o">=</span> <span class="n">zp</span>

<div class="viewcode-block" id="AVSTransactionValidator.load_json_from_file"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.load_json_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_json_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load json to a dictionary</span>
<span class="sd">        :param str json_file: Json file name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="AVSTransactionValidator.extract_json_from_log"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.extract_json_from_log">[docs]</a>    <span class="k">def</span> <span class="nf">extract_json_from_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract directive json from anacapa log message</span>
<span class="sd">        :param str log_message: Anacapa log message to parse</span>
<span class="sd">        :return: Dictionary contianing keys and values of avs transaction</span>
<span class="sd">        :rtype: :obj:`dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting avs json from log message: </span><span class="si">{}</span><span class="s2">&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_message</span><span class="p">))</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;(?={)(.*)&#39;</span>
        <span class="n">compiled_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="n">match_obj</span> <span class="o">=</span> <span class="n">compiled_pat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match_obj</span><span class="p">:</span>
            <span class="n">transaction_dict_json_string</span> <span class="o">=</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;JSON String: </span><span class="si">{}</span><span class="s2">&quot;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transaction_dict_json_string</span><span class="p">))</span>
                <span class="n">transaction_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">transaction_dict_json_string</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">AVSValidationException</span><span class="p">(</span>
                        <span class="s2">&quot;Exception: Truncated AVS transaction json string. &quot;</span>
                        <span class="s2">&quot;UPP logger only allows 1024 message length&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">AVSValidationException</span><span class="p">(</span>
                        <span class="s2">&quot;Exception: Invalid AVS transaction json string &quot;</span>
                        <span class="s2">&quot;found when converting to dictionary&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AVS Transaction : </span><span class="si">{}</span><span class="s2">&quot;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transaction_dict</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">transaction_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AVSValidationException</span><span class="p">(</span><span class="s2">&quot;No AVS json found in message&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AVSTransactionValidator.get_exp_avs_seq_from_spec"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.get_exp_avs_seq_from_spec">[docs]</a>    <span class="k">def</span> <span class="nf">get_exp_avs_seq_from_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">voicetap_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get expected sequence of avs transaction from spec json</span>
<span class="sd">        sample input =   {&quot;alexa_set_alarm_for_5_oclock_then_pm.raw&quot;: {</span>
<span class="sd">                            &quot;directive1&quot;: {</span>
<span class="sd">                                &quot;header&quot;: {</span>
<span class="sd">                                    &quot;namespace&quot;:&quot;SpeechRecognizer&quot;,</span>
<span class="sd">                                    &quot;name&quot;:&quot;StopCapture&quot;</span>
<span class="sd">                                },</span>
<span class="sd">                                &quot;payload&quot;: {</span>
<span class="sd">                                    }</span>
<span class="sd">                            }</span>
<span class="sd">                        }</span>
<span class="sd">        sample output: {&#39;directive1&#39; : &quot;SpeechRecognizer.StopCapture&quot; }</span>
<span class="sd">        :param str voicetap_name: Name of voicetap for which to get avs sequence</span>
<span class="sd">        :return dict exp_avs_trans_sec: dictionary of avs transaction type</span>
<span class="sd">        and namespace and name info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting expected AVS transaction sequence for &quot;</span>
                         <span class="s2">&quot;voicetap: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">voicetap_name</span><span class="p">))</span>
        <span class="n">transaction_sequence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">voicetap_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_spec</span><span class="p">:</span>
            <span class="n">transaction_sequence</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">avs_transaction_spec</span><span class="p">[</span><span class="n">voicetap_name</span><span class="p">]</span>
                                         <span class="p">[</span><span class="s1">&#39;avs_transaction_sequence&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Expected AVS transaction sequence:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="n">transaction_sequence</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;TYPE: </span><span class="si">{}</span><span class="s2"> --&gt; TRANSACTION: header &lt;</span><span class="si">{}</span><span class="s2">&gt;, payload &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                                     <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">],</span>
                                     <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;payload&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">transaction_sequence</span></div>

<div class="viewcode-block" id="AVSTransactionValidator.is_stop_capture_directive"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.is_stop_capture_directive">[docs]</a>    <span class="k">def</span> <span class="nf">is_stop_capture_directive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check is directive received has name &#39;StopCapture&quot;</span>
<span class="sd">        :param str log_message: Anacapa log message</span>
<span class="sd">        :return bool: is directive a stopcapture directive</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking if rec&#39;d directive is a &#39;StopCapture&#39;&quot;</span><span class="p">)</span>
        <span class="n">avs_transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_json_from_log</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">avs_transaction</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;directive&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">directive</span> <span class="o">=</span> <span class="n">avs_transaction</span><span class="p">[</span><span class="s1">&#39;directive&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">STOP_CAPTURE</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">directive</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">],</span> <span class="n">directive</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="AVSTransactionValidator.is_avs_event_type"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.is_avs_event_type">[docs]</a>    <span class="k">def</span> <span class="nf">is_avs_event_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_event</span><span class="p">,</span> <span class="n">log_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if AVS event received is expected</span>
<span class="sd">        :param str log_message: Anacapa log message</span>
<span class="sd">        :return bool: is AVS event expected?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Checking if event sent is &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expected_event</span><span class="p">))</span>
        <span class="n">avs_transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_json_from_log</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;event&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">avs_transaction</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">actual_event</span> <span class="o">=</span> <span class="n">avs_transaction</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">expected_event</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">actual_event</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">],</span>
            <span class="n">actual_event</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="AVSTransactionValidator.is_user_inactivity_report_event"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.is_user_inactivity_report_event">[docs]</a>    <span class="k">def</span> <span class="nf">is_user_inactivity_report_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if event received is of type &#39;UserInactivityReport&#39;</span>
<span class="sd">        :param str log_message: Anacapa log message</span>
<span class="sd">        :return bool: is event a UserInactivityReport event?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_avs_event_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">USER_INACTIVITY_REPORT</span><span class="p">,</span> <span class="n">log_message</span><span class="p">)</span></div>

<div class="viewcode-block" id="AVSTransactionValidator.is_spatial_data_event"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.is_spatial_data_event">[docs]</a>    <span class="k">def</span> <span class="nf">is_spatial_data_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if event received is of type &#39;ReportEchoSpatialPerceptionData&#39;</span>
<span class="sd">        :param str log_message: Anacapa log message</span>
<span class="sd">        :return bool: is event a spatial data event?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_avs_event_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SPATIAL_DATA</span><span class="p">,</span> <span class="n">log_message</span><span class="p">)</span></div>

<div class="viewcode-block" id="AVSTransactionValidator.get_namespace_and_name_string"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.get_namespace_and_name_string">[docs]</a>    <span class="k">def</span> <span class="nf">get_namespace_and_name_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get namespace and name from avs transaction dictionary</span>
<span class="sd">        :param dict transaction:</span>
<span class="sd">        :return: String of format &#39;&lt;avs_namespace&gt;.&lt;name&gt;&#39;</span>
<span class="sd">        :rtype: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;namespace&#39;</span><span class="p">],</span>
                               <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="AVSTransactionValidator.is_volume_change_event"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.is_volume_change_event">[docs]</a>    <span class="k">def</span> <span class="nf">is_volume_change_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if event sent is a volume change event</span>
<span class="sd">        :param str log_message: Anacapa log message</span>
<span class="sd">        :return bool: is event a volume change event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">avs_transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_json_from_log</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">avs_transaction</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOLUME_CHANGED</span> <span class="o">==</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AVSTransactionValidator.is_mute_change_event"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.is_mute_change_event">[docs]</a>    <span class="k">def</span> <span class="nf">is_mute_change_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if event sent is a mute change event</span>
<span class="sd">        :param str log_message: Anacapa log message</span>
<span class="sd">        :return bool: is event a mute change event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">avs_transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_json_from_log</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">avs_transaction</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">MUTE_CHANGED</span> <span class="o">==</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AVSTransactionValidator.validate_avs_transaction"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.validate_avs_transaction">[docs]</a>    <span class="k">def</span> <span class="nf">validate_avs_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">voicetap_name</span><span class="p">,</span>
                                 <span class="n">spec_transaction</span><span class="p">,</span>
                                 <span class="n">transaction_log</span><span class="p">,</span>
                                 <span class="n">transaction_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract avs json from log message and validate avs transactions against</span>
<span class="sd">        spec file. Does basic check for</span>
<span class="sd">        namespace, token search for keyword, verify serial number in</span>
<span class="sd">        dialog and messages.</span>
<span class="sd">        :param str voicetap_name: name of voicetap used to get avs</span>
<span class="sd">        transaction spec.</span>
<span class="sd">        :param str transaction_log: Transaction log that is caught via udp</span>
<span class="sd">        logger</span>
<span class="sd">        :param str transaction_type: Transaction type whether directive or</span>
<span class="sd">        one of the events - speechStarted or speechFinished</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">actual_transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_json_from_log</span><span class="p">(</span><span class="n">transaction_log</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match_avs_transaction</span><span class="p">(</span><span class="n">spec_transaction</span><span class="p">,</span>
                                   <span class="n">actual_transaction</span><span class="p">,</span>
                                   <span class="n">transaction_type</span><span class="p">,</span>
                                   <span class="n">voicetap_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="AVSTransactionValidator.match_avs_transaction"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.match_avs_transaction">[docs]</a>    <span class="k">def</span> <span class="nf">match_avs_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">spec_transaction</span><span class="p">,</span>
                              <span class="n">actual_transaction</span><span class="p">,</span>
                              <span class="n">transaction_type</span><span class="p">,</span>
                              <span class="n">voicetap_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Match actual avs json against spec json for voicetap_name.</span>
<span class="sd">        ..note: Not all key/value pair verification is done. For token,</span>
<span class="sd">        we only seacrh for a matching word in actual token</span>
<span class="sd">        :param dict spec_transaction: Dictionary with transaction spec</span>
<span class="sd">        :param dict actual_transaction: Actual AVS transaction from player</span>
<span class="sd">        :param str transaction_type: Transaction type whether directive or</span>
<span class="sd">            events</span>
<span class="sd">        :param str voicetap_name: voicetap filename</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Matching SPEC transaction with ACTUAL. voicetap_name = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>
                <span class="nb">format</span><span class="p">(</span><span class="n">voicetap_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Spec Transaction: </span><span class="si">{}</span><span class="s2">&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec_transaction</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Actual Transaction: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">actual_transaction</span><span class="p">))</span>
        <span class="n">spec_header</span> <span class="o">=</span> <span class="n">spec_transaction</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span>
        <span class="n">spec_payload</span> <span class="o">=</span> <span class="n">spec_transaction</span><span class="p">[</span><span class="s1">&#39;payload&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">transaction_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">actual_transaction</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AVSValidationException</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected transaction type found. Expected: </span><span class="si">{}</span><span class="s2">. Actual &quot;</span>
                <span class="s2">&quot;Transaction: </span><span class="si">{}</span><span class="s2">. voicetap_name = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">spec_transaction</span><span class="p">,</span> <span class="n">actual_transaction</span><span class="p">,</span> <span class="n">voicetap_name</span><span class="p">))</span>
        <span class="n">actual_header</span> <span class="o">=</span> <span class="n">actual_transaction</span><span class="p">[</span><span class="n">transaction_type</span><span class="p">][</span><span class="s1">&#39;header&#39;</span><span class="p">]</span>
        <span class="n">actual_payload</span> <span class="o">=</span> <span class="n">actual_transaction</span><span class="p">[</span><span class="n">transaction_type</span><span class="p">][</span><span class="s1">&#39;payload&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SPEC HEADER: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec_header</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ACTUAL HEADER: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">actual_header</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SPEC PAYLOAD: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec_payload</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ACTUAL PAYLOAD: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">actual_payload</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">actual_header</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AVS transaction header key/value pair - </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">actual_header</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">spec_header</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying key: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">spec_header</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">AVSValidationException</span><span class="p">(</span>
                        <span class="s2">&quot;voicetap_name = &lt;</span><span class="si">{}</span><span class="s2">&gt;, spec_header = &lt;</span><span class="si">{}</span><span class="s2">&gt;, &quot;</span>
                        <span class="s2">&quot;actual_header = &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">voicetap_name</span><span class="p">,</span> <span class="n">spec_header</span><span class="p">,</span> <span class="n">actual_header</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIALOG_ID</span> <span class="ow">and</span> <span class="n">transaction_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIRECTIVE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying player serial number in dialogID&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">,</span> <span class="n">actual_header</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="n">AVSValidationException</span><span class="p">(</span>
                        <span class="s2">&quot;Unexpected destination device serial in AVS Dialog &quot;</span>
                        <span class="s2">&quot;ID. Expected serial: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">MESSAGE_ID</span> <span class="ow">and</span> <span class="n">transaction_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">EVENT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying player serial number in messageID&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">,</span> <span class="n">actual_header</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="n">AVSValidationException</span><span class="p">(</span>
                        <span class="s2">&quot;Unexpected destination device serial in AVS message &quot;</span>
                        <span class="s2">&quot;ID. Expected serial: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">actual_payload</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AVS transaction payload key/value pair - </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">actual_payload</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;token&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying key: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">spec_payload</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">actual_payload</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="n">AVSValidationException</span><span class="p">(</span>
                        <span class="s2">&quot;Unexpected token value in AVS transaction payload&quot;</span>
                        <span class="s2">&quot;Expected token: </span><span class="si">{}</span><span class="s2"> not found in actual: </span><span class="si">{}</span><span class="s2">. &quot;</span>
                        <span class="s2">&quot;voicetap_name = </span><span class="si">{}</span><span class="s2">, index = </span><span class="si">{}</span><span class="s2">&quot;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">spec_payload</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">actual_payload</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                            <span class="n">voicetap_name</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span></div>

<div class="viewcode-block" id="AVSTransactionValidator.reset_directive_and_event_numbering"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.AVSTransactionValidator.reset_directive_and_event_numbering">[docs]</a>    <span class="k">def</span> <span class="nf">reset_directive_and_event_numbering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When processing avs transactions for more than 1 voicetaps in a test,</span>
<span class="sd">        reset numbering to start fresh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directive_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_num</span> <span class="o">=</span> <span class="mi">0</span></div></div>


<div class="viewcode-block" id="VoiceEndToEndBase"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase">[docs]</a><span class="k">class</span> <span class="nc">VoiceEndToEndBase</span><span class="p">(</span><span class="n">WorkflowTestFixture</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Voice tests base class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="VoiceEndToEndBase.generate_voice_zones"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.generate_voice_zones">[docs]</a>    <span class="k">def</span> <span class="nf">generate_voice_zones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voice_players</span><span class="p">),</span> <span class="p">)</span></div>
        <span class="c1"># seen_models = []</span>
        <span class="c1"># for zp in self.voice_players:</span>
        <span class="c1">#     if zp.modelNumber not in seen_models:</span>
        <span class="c1">#         seen_models.append(zp.modelNumber)</span>
        <span class="c1">#         yield (zp,)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VoiceEndToEndBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parameterized_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avs_validator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voice_event_handler</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wav_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voice_account_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_logs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zp_logger</span> <span class="o">=</span> <span class="n">ZpLogger</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

<div class="viewcode-block" id="VoiceEndToEndBase.setUpFixture"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span> <span class="o">=</span> <span class="p">{</span>
             <span class="s1">&#39;voictrlr&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
             <span class="s1">&#39;voicep&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
             <span class="s1">&#39;voiceupl&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
             <span class="s1">&#39;avs2&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
             <span class="s1">&#39;extaudiosrc&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
             <span class="s1">&#39;attenuation&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
             <span class="s1">&#39;mixer&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
             <span class="s1">&#39;vcduck&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
             <span class="s1">&#39;voiceacct&#39;</span><span class="p">:</span> <span class="mi">3</span>
         <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voice_players</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_capable</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voice_players</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s2">&quot;Expect atleast one voice enabled player in HH&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice_players</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_service</span><span class="o">.</span><span class="n">get_valid_accounts</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Voice account exists on: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">voice_account_ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">voice_account_ok</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># https://jira.sonos.com/browse/SWPBL-85312</span>
                <span class="c1"># Require a pre setup voice account</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_suite</span><span class="p">(</span><span class="s2">&quot;Voice account required!  &quot;</span>
                                <span class="s2">&quot;See https://jira.sonos.com/browse/SWPBL-85312&quot;</span><span class="p">)</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()]</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span> <span class="o">=</span> <span class="n">local_path</span> <span class="o">+</span> <span class="s1">&#39;/resource/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voicetap_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span> <span class="o">+</span> <span class="s1">&#39;voicetap/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_webserver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice_players</span><span class="p">:</span>
            <span class="c1"># If for any reason ext audio src is already playing, stop it.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Stop</span><span class="p">(</span><span class="mi">8008</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">UPnPError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">voice_event_handler</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">]</span> <span class="o">=</span> <span class="n">VoiceEvents</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">voice_event_handler</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">]</span><span class="o">.</span><span class="n">setup_udplogger</span><span class="p">()</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.remove_avs_alert"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.remove_avs_alert">[docs]</a>    <span class="k">def</span> <span class="nf">remove_avs_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">voicetap</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove AVS alert (alarm or timer)</span>

<span class="sd">        :param zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param str voicetap:</span>
<span class="sd">            &#39;alexa_delete_alarm.raw&#39; or &#39;alexa_cancel_timer.raw&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">enable_raise</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">reset_raised</span><span class="p">()</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">post_diagmsg</span><span class="p">(</span>
            <span class="s1">&#39;[START] Removing AVS alert using </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">voicetap</span><span class="p">))</span>
        <span class="n">voicetap_path</span> <span class="o">=</span> <span class="s2">&quot;/Automation/voicetap/alexa_tests_wav/alerts/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_files_from_nas</span><span class="p">(</span><span class="n">voicetap_path</span><span class="p">,</span> <span class="n">files_list</span><span class="o">=</span><span class="p">[</span><span class="n">voicetap</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_voicetaps_for_player</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_voicetap_url</span><span class="p">(</span><span class="n">voicetap</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">voice_overlay</span><span class="o">.</span><span class="n">load_and_start_overlay</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">cleanup_overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;loaded and started </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">voicetap</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_avs_transactions</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">voicetap</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">diag_id</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">ZoneGroupTopology</span><span class="o">.</span><span class="n">SubmitDiagnostics</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s1">&#39;Failed to remove AVS alert on &lt;</span><span class="si">{}</span><span class="s1">&gt;. DIAG: </span><span class="si">{}</span><span class="s1">&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">diag_id</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">AVSConnectionFailureException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">date_time_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H_%M_%S&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">AVSConnectionFailureException</span><span class="p">):</span>
                <span class="n">log_file_name</span> <span class="o">=</span> <span class="s1">&#39;AVS_Connection_Failure_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">date_time_str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collect_anacapa_trace</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="n">log_file_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Test stopped due to AVS Connection failure.&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">post_diagmsg</span><span class="p">(</span>
            <span class="s1">&#39;[END] Removing AVS alert using </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">voicetap</span><span class="p">))</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.cleanup_avs_alerts"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.cleanup_avs_alerts">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_avs_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If ZP has an AVS alarm or timer, remove it</span>

<span class="sd">        :param zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Cleaning up AVS alerts&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avs_validator</span> <span class="o">=</span> <span class="n">AVSTransactionValidator</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                <span class="vm">__file__</span><span class="p">)),</span> <span class="s1">&#39;voice_remove_alerts.json&#39;</span><span class="p">),</span> <span class="n">zp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">does_avs_alarm_exist</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_avs_alert</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s1">&#39;alexa_delete_alarm.wav&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">does_avs_timer_exist</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_avs_alert</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s1">&#39;alexa_cancel_timer.wav&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.get_files_from_nas"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.get_files_from_nas">[docs]</a>    <span class="k">def</span> <span class="nf">get_files_from_nas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files_path</span><span class="p">,</span> <span class="n">files_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy files from NAS</span>
<span class="sd">        :param str files_path: Path to download files from</span>
<span class="sd">        :param list files_list: The list of files to download</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting files from </span><span class="si">{}</span><span class="s2"> on NAS&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">files_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wav_path</span> <span class="o">=</span> <span class="n">files_path</span>
        <span class="k">if</span> <span class="n">files_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files_list</span> <span class="o">=</span> <span class="n">files_list</span>
        <span class="k">with</span> <span class="n">SonosAutomationSFTP</span><span class="p">()</span> <span class="k">as</span> <span class="n">sftp</span><span class="p">:</span>
            <span class="n">sftp</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">files_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">files_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">files_list</span> <span class="o">=</span> <span class="n">sftp</span><span class="o">.</span><span class="n">listdir</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Available files on nas : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">files_list</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a_file</span> <span class="ow">in</span> <span class="n">files_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copying file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a_file</span><span class="p">))</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">files_path</span> <span class="o">+</span> <span class="n">a_file</span>
                    <span class="n">dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span> <span class="o">+</span> <span class="n">a_file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Source: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Destination: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span>
                    <span class="n">sftp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_suite</span><span class="p">(</span><span class="s2">&quot;Required files not available&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.setup_webserver"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.setup_webserver">[docs]</a>    <span class="k">def</span> <span class="nf">setup_webserver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_path</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">WEB_SRV_PORT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup local web server</span>
<span class="sd">        :param handlers: Basically dictionary of tracks to serve up</span>
<span class="sd">        :type handlers: :obj:`dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">websrv</span> <span class="o">=</span> <span class="n">WebServer</span><span class="p">(</span><span class="n">start_reactor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">websrv</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">resource_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_suite</span><span class="p">(</span><span class="s2">&quot;Could not start web server&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Unexpected exception found: &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started web server&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">websrv</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.convert_voicetaps_for_player"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.convert_voicetaps_for_player">[docs]</a>    <span class="k">def</span> <span class="nf">convert_voicetaps_for_player</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s2">&quot; --norm=-12&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convet local voicetap.wav files to voicetap.raw according to the</span>
<span class="sd">        zp that they will be played on</span>
<span class="sd">        :param zp: class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting conversion for model: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voicetap_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voicetap_path</span><span class="p">)</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">a_file</span> <span class="k">for</span> <span class="n">a_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span><span class="p">)</span>
                     <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span> <span class="o">+</span> <span class="n">a_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.wav&quot;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting conversion of files: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_list</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">a_file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">a_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wav_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span>
            <span class="n">raw_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voicetap_path</span>
            <span class="n">raw_name</span> <span class="o">=</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s1">&#39;.raw&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;infile: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wav_path</span><span class="o">+</span><span class="n">a_file</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;outfile_name: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_path</span> <span class="o">+</span> <span class="n">raw_name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">raw_path</span> <span class="o">+</span> <span class="n">raw_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;confirmed </span><span class="si">{}</span><span class="s2"> exists, skipping conversion&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">converter</span> <span class="o">=</span> <span class="n">WavToRaw</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">wav_path</span> <span class="o">+</span> <span class="n">a_file</span><span class="p">,</span>
                                     <span class="n">outfile_name</span><span class="o">=</span><span class="n">raw_path</span> <span class="o">+</span> <span class="n">raw_name</span><span class="p">,</span>
                                     <span class="n">num_mics</span><span class="o">=</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_num_mics</span><span class="p">(),</span>
                                     <span class="n">num_dacs</span><span class="o">=</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_num_dacs</span><span class="p">(),</span>
                                     <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
                <span class="n">converter</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">raw_path</span> <span class="o">+</span> <span class="n">raw_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
                                      <span class="s2">&quot;verifying post conversion </span><span class="si">{}</span><span class="s2"> is not empty&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_name</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">raw_path</span> <span class="o">+</span> <span class="n">raw_name</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;confirmed </span><span class="si">{}</span><span class="s2"> exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;conversion for </span><span class="si">{}</span><span class="s2"> finished&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.setUpTest"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up test</span>
<span class="sd">        :param zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">print_logs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">logs_to_print</span> <span class="o">=</span> <span class="p">[</span><span class="n">Logs</span><span class="o">.</span><span class="n">ANACAPA</span><span class="p">,</span> <span class="n">Logs</span><span class="o">.</span><span class="n">PERF</span><span class="p">,</span> <span class="n">Logs</span><span class="o">.</span><span class="n">ANACAPA_VI</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zp_logger</span><span class="o">.</span><span class="n">zp</span> <span class="o">=</span> <span class="n">zp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp_logger</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">logs_to_print</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">)</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">ZpLogger</span><span class="o">.</span><span class="n">print_backtraces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">),</span> <span class="s2">&quot;Backtraces found! Ending test&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setup Test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_voicetaps_for_player</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">post_diagmsg</span><span class="p">(</span><span class="s2">&quot;Start test: </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_testFixtureName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">))</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voice_overlay</span> <span class="o">=</span> <span class="n">VoiceOverlay</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">veh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice_event_handler</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">]</span>
        <span class="c1"># disable raising signal on non test device to cut the noise</span>
        <span class="k">for</span> <span class="n">udn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice_event_handler</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">voice_event_handler</span><span class="p">[</span><span class="n">udn</span><span class="p">]</span><span class="o">.</span><span class="n">disable_raise</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_voice_service_connection_status</span><span class="p">()</span> <span class="o">==</span>
                         <span class="n">CONNECTED</span><span class="p">),</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Connected to AVS.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_anacapa_trace</span><span class="p">(</span>
                <span class="n">zp</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="s2">&quot;NO_AVS_Connection_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_test_name</span><span class="p">(),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H_%M_%S&#39;</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Not Connected to AVS !&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Unexpected exception found: &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_diagcs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_avs_alerts</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="c1"># enable raising signal on avs connection failure so that actual test</span>
        <span class="c1"># can catch the condition as soon as it occurs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Enabling raise of signal on AVS Connection Failure.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">enable_raise</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">reset_raised</span><span class="p">()</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.tearDownTest"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tear down Test</span>
<span class="sd">        :param zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">)):</span>
            <span class="c1"># Always print on failure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_logs</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_logs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zp_logger</span><span class="o">.</span><span class="n">print_active_logs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zp_logger</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tear down test: Base&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_avs_alerts</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span>
        <span class="c1"># disable raising signal on avs connection failure.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">disable_raise</span><span class="p">()</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">post_diagmsg</span><span class="p">(</span><span class="s2">&quot;End test: </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_testFixtureName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voice_overlay</span><span class="o">.</span><span class="n">remove_overlay_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">error_detected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voicetap_path</span><span class="p">)</span>
        <span class="c1"># Add some delay between tests.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting 10 seconds before starting next test&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.get_voicetap_url"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.get_voicetap_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_voicetap_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get voicetap file url after hosting on web server</span>
<span class="sd">        :param str file_name: name of file with a .wav extension</span>
<span class="sd">        :return str url: Voice tap file url</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## the file_name passed in is a .wav but we&#39;re</span>
        <span class="c1">## actually looking for a .raw so here we strip</span>
        <span class="c1">## the old extension and add a new one.</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">host</span><span class="p">(),</span>
                                    <span class="s1">&#39;voicetap/&#39;</span>
                                    <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="o">+</span> <span class="s1">&#39;.raw&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">url</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.get_voicetap_list_from_file"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.get_voicetap_list_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_voicetap_list_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get voice list of files from fi</span>
<span class="sd">        :param str file_name:</span>
<span class="sd">        :return list voicetap_list:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">voicetap_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">voicetap_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span>
                             <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">voicetap_list</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.cleanup"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear avt and queue, remove bonded config if it exists</span>
<span class="sd">        :param zp: Sonos zone component</span>
<span class="sd">        :type zp: :class:`~sonos.client.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Performing cleanup&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>

        <span class="c1"># Bonding/Group cleanup</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">GroupManagement</span><span class="o">.</span><span class="n">is_group_coordinator_local</span><span class="p">():</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">GroupManagement</span><span class="o">.</span><span class="n">is_group_coordinator_local</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for </span><span class="si">{}</span><span class="s2"> to be GC&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">))</span>

        <span class="c1"># Volume/playback cleanup</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s1">&#39;RenderingControl&#39;</span><span class="p">):</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">():</span>
            <span class="c1"># Explicitly stop ext audio source</span>
            <span class="c1"># Note: if no ext audio soure is playing or if device</span>
            <span class="c1"># does not have ext audio src, it will raise UPnPError</span>
            <span class="c1"># 718 will be sent from devices that can&#39;t do extaudio</span>
            <span class="c1"># 701 will be sent on a device that can do extaudio,</span>
            <span class="c1">#     but has nothing playing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Stop</span><span class="p">(</span><span class="mi">8008</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">UPnPError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Unexpected exception found: &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Otherwise clean any kind of playback and queue items</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_queue_empty</span><span class="p">():</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">:</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>

        <span class="c1"># mic mode/avs cleanup</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_voice_capable</span><span class="p">():</span>
            <span class="n">google_account</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_service</span><span class="o">.</span><span class="n">get_account</span><span class="p">(</span><span class="n">VoiceServices</span><span class="o">.</span><span class="n">GOOGLE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">google_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">google_account</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span><span class="p">:</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">voice_service</span><span class="o">.</span><span class="n">set_service_status</span><span class="p">(</span><span class="n">VoiceServices</span><span class="o">.</span><span class="n">GOOGLE</span><span class="p">,</span> <span class="s2">&quot;INACTIVE&quot;</span><span class="p">)</span>

            <span class="n">alexa_account</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_service</span><span class="o">.</span><span class="n">get_account</span><span class="p">(</span><span class="n">VoiceServices</span><span class="o">.</span><span class="n">AMAZON</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alexa_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">voice_service</span><span class="o">.</span><span class="n">set_service_status</span><span class="p">(</span><span class="n">VoiceServices</span><span class="o">.</span><span class="n">AMAZON</span><span class="p">,</span> <span class="s2">&quot;ACTIVE&quot;</span><span class="p">)</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_service</span><span class="o">.</span><span class="n">get_account</span><span class="p">(</span><span class="n">VoiceServices</span><span class="o">.</span><span class="n">AMAZON</span><span class="p">)</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span><span class="p">,</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Alexa service was not ACTIVE on </span><span class="si">{}</span><span class="s2"> after waiting 30 sec&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">))</span>

            <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">unmute_mic</span><span class="p">()</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_voice_service_connection_status</span><span class="p">()</span> <span class="o">==</span> <span class="n">CONNECTED</span><span class="p">),</span>
                            <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;AVS not connected on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.tearDownFixture"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Teardown fixture</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Teardown fixture: Base&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice_account_ok</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">udn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice_event_handler</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">voice_event_handler</span><span class="p">[</span><span class="n">udn</span><span class="p">]</span><span class="o">.</span><span class="n">disable_raise</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_diagcs</span><span class="p">(</span><span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice_players</span><span class="p">:</span>
                    <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">remove_file</span><span class="p">(</span><span class="n">JFFS</span> <span class="o">+</span> <span class="n">VOICETAP</span><span class="p">)</span>
                    <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">unmute_mic</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">voice_event_handler</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">]</span><span class="o">.</span><span class="n">teardown_udplogger</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NODE_NAME&quot;</span><span class="p">)</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AUTOMATION_USER&quot;</span><span class="p">)</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AUTOMATION_TOKEN&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">and</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">password</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No voice account. Taking testbed offline!&quot;</span>
                <span class="n">DisableTestbed</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                               <span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">set_node_offline</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_add_test_share</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add test share</span>
<span class="sd">        :param zp: Sonos zone component on which to perform share action</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">test_share</span><span class="p">,</span> <span class="n">test_share_credentials</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_configuration</span>
                                                <span class="o">.</span><span class="n">get_share_by_key</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">ContentDirectory</span><span class="o">.</span><span class="n">remove_all_shares</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">ContentDirectory</span><span class="o">.</span><span class="n">add_share</span><span class="p">(</span><span class="n">test_share</span><span class="p">,</span>
                                            <span class="o">*</span><span class="n">test_share_credentials</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s2">&quot;Expects the test share to be added&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="VoiceEndToEndBase.start_playback"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.start_playback">[docs]</a>    <span class="k">def</span> <span class="nf">start_playback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">zp</span><span class="p">,</span>
                       <span class="n">source</span><span class="o">=</span><span class="n">SHARE</span><span class="p">,</span>
                       <span class="n">play_mode</span><span class="o">=</span><span class="s1">&#39;NORMAL&#39;</span><span class="p">,</span>
                       <span class="n">crossfade</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">qpos</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start playback. For playing from queue, tracks should be added to</span>
<span class="sd">        queue already, provice position in queue to start playback from. For</span>
<span class="sd">        radio play from Tunein. For radio and TV avt is set in this function.</span>
<span class="sd">        :param zp: Sonos zone component</span>
<span class="sd">        :type zp: :`~sonos.client.SonosZoneComponent`</span>
<span class="sd">        :param str source: Source of music queue/share or radio or tv</span>
<span class="sd">        :param str play_mode: Play mode</span>
<span class="sd">        :param bool crossfade: Enable/disable crossfadel. Default False</span>
<span class="sd">        :param int qpos: Start position in queue for playback</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting playback from </span><span class="si">{}</span><span class="s2"> on </span><span class="si">{}</span><span class="s2">&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">zp</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="n">QUEUE</span><span class="p">,</span> <span class="n">SHARE</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_test_share</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">()</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">ContentDirectory</span><span class="o">.</span><span class="n">get_track_uri_for_filename</span><span class="p">(</span><span class="n">SHARE_TRACK</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">add_to_queue</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Queue position: </span><span class="si">{}</span><span class="s2"> Playmode: </span><span class="si">{}</span><span class="s2"> Crossfade: </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="n">play_mode</span><span class="p">,</span> <span class="n">crossfade</span><span class="p">))</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">set_queue_position</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">crossfade</span><span class="p">:</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetCrossfadeMode</span><span class="p">(</span><span class="n">crossfade</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetPlayMode</span><span class="p">(</span><span class="n">play_mode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="n">TV</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">TV_URI</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetAVTransportURI_and_wait</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="n">RADIO</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetAVTransportURI_and_wait</span><span class="p">(</span><span class="n">RADIO_URI</span><span class="p">,</span> <span class="n">RADIO_MD</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Timed out waiting for &lt;</span><span class="si">{}</span><span class="s2">&gt; to start play&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Unexpected exception found: &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.stop_playback"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.stop_playback">[docs]</a>    <span class="k">def</span> <span class="nf">stop_playback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop playback on given zone player</span>
<span class="sd">        :param zp: Sonos zone component from which to submit</span>
<span class="sd">        :type zp: :class:`~sonos.client.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping playback on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetPlayMode</span><span class="p">(</span><span class="s2">&quot;NORMAL&quot;</span><span class="p">)</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Stop_and_wait</span><span class="p">()</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.get_audio_download_time"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.get_audio_download_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_audio_download_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the time since we stopped uploading our query and  we</span>
<span class="sd">        finish downloading audio respoinse and start playing via external audio</span>
<span class="sd">        src.</span>
<span class="sd">        :return float download_time: time taken to download</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_time_from_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">finish_upload_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Upload finish time: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
        <span class="n">finish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_time_from_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">start_playing_response_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Response start time: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finish</span><span class="p">))</span>
        <span class="n">time_to_response</span> <span class="o">=</span> <span class="p">(</span><span class="n">finish</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Time to audio response: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_to_response</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">time_to_response</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.extract_time_from_log"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.extract_time_from_log">[docs]</a>    <span class="k">def</span> <span class="nf">extract_time_from_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract time from log message</span>
<span class="sd">        :param str log: Anacapa Log string containing time</span>
<span class="sd">        :return date_time_obj: datetime object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Extracting time from log: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">))</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;^\[(.*?)\]&#39;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">log</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">time_string</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">date_time_obj</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_string</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">date_time_obj</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.collect_anacapa_trace"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.collect_anacapa_trace">[docs]</a>    <span class="k">def</span> <span class="nf">collect_anacapa_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect anacapa trace from zp</span>
<span class="sd">        :param zp: Sonos zone component from which to collect threadinfo</span>
<span class="sd">        :type zp: :class:`~sonos.client.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">log_file_name</span><span class="p">:</span>
            <span class="n">anacapa_log</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_anacapa.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">,</span>
                                                       <span class="n">log_file_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">date_time_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H_%M_%S&#39;</span><span class="p">)</span>
            <span class="n">anacapa_log</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_anacapa.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">,</span>
                                                       <span class="n">date_time_str</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_anacapa_trace</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anacapa_log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Anacapa trace saved to: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">anacapa_log</span><span class="p">))</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.set_diagcs"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.set_diagcs">[docs]</a>    <span class="k">def</span> <span class="nf">set_diagcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set diagcs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting diagc&#39;s&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice_players</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
                <span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">diagc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">diagc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">diagc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;Setting diagc &lt;</span><span class="si">{}</span><span class="s1">&gt; to &lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">diagc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">[</span><span class="n">diagc</span><span class="p">]))</span>
                    <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">diagc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">[</span><span class="n">diagc</span><span class="p">])</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.configure_voice_account"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.configure_voice_account">[docs]</a>    <span class="k">def</span> <span class="nf">configure_voice_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure a voice account on the device passed in.</span>
<span class="sd">        This method will remove any voice account file that has already been</span>
<span class="sd">        created on the DUT.</span>

<span class="sd">        :param zp: The zone player under test</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting up PreAuthorizedAmazonVoiceServiceAccount on&quot;</span>
                         <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="n">PreAuthorizedAmazonVoiceServiceAccount</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">voice_service</span><span class="o">.</span><span class="n">get_account</span><span class="p">(</span>
            <span class="n">VoiceServices</span><span class="o">.</span><span class="n">AMAZON</span><span class="p">,</span> <span class="n">VoiceNicknames</span><span class="o">.</span><span class="n">AMAZON</span><span class="p">),</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> voice account should have been added to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">VoiceNicknames</span><span class="o">.</span><span class="n">AMAZON</span><span class="p">,</span> <span class="n">zp</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.do_test_config"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.do_test_config">[docs]</a>    <span class="k">def</span> <span class="nf">do_test_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">playing_state</span><span class="p">,</span> <span class="n">config_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do configuration as provided to function param : &#39;config_state&#39; and</span>
<span class="sd">        start playback as per function param &#39;playing_state&#39;</span>
<span class="sd">        :param str playing_state: Start playback on GC or leave in idle state</span>
<span class="sd">        :param str config_state: Configure devices as standalone, group,</span>
<span class="sd">        stereo or ht</span>
<span class="sd">        :return: tuple of master and devices in config</span>
<span class="sd">        :rtype: :obj:`tuple`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing test config&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config_state</span> <span class="o">==</span> <span class="n">STANDALONE</span><span class="p">:</span>
            <span class="n">master</span> <span class="o">=</span> <span class="n">zp</span>
            <span class="n">config_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">config_state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">GROUP_GC</span><span class="p">,</span> <span class="n">GROUP_GM</span><span class="p">]:</span>
            <span class="n">master</span><span class="p">,</span> <span class="n">config_devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_group</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">config_state</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">config_state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">STEREO_LEFT</span><span class="p">,</span> <span class="n">STEREO_RIGHT</span><span class="p">]:</span>
            <span class="n">master</span><span class="p">,</span> <span class="n">config_devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_stereo</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">config_state</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">config_state</span> <span class="o">==</span> <span class="n">HT_REAR</span><span class="p">:</span>
            <span class="n">master</span><span class="p">,</span> <span class="n">config_devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_ht</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">playing_state</span> <span class="o">==</span> <span class="n">PLAYING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_playback</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;share&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Master device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">master</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Config Devices: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config_devices</span><span class="p">))</span>
        <span class="c1"># Volume can get LOUD after config</span>
        <span class="n">master</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1"># When performing config, we may have a volume event.</span>
        <span class="c1"># Clear all AVS event queues to make sure queue is empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">empty_avs_msg_queue</span><span class="p">()</span>
        <span class="c1"># Wait to verify the mic is on on at least one of the voice zps</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">config_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_mic_on</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for mic on </span><span class="si">{}</span><span class="s2"> to be on&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">master</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">config_devices</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.configure_group"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.configure_group">[docs]</a>    <span class="k">def</span> <span class="nf">configure_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">config_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure group with zp as part of config as provided via</span>
<span class="sd">        config_state param</span>
<span class="sd">        :param :class:`sonos.client.internal.SonosZoneComponent` zp: test zp</span>
<span class="sd">        :param str config_state: Initial config state of voice player</span>
<span class="sd">        :return: tuple of master and devices in config</span>
<span class="sd">        :rtype: :obj:`tuple`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing group config.&quot;</span><span class="p">)</span>
        <span class="n">config_devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">config_devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="c1"># get a playback device other than the test voice player device</span>
        <span class="n">zones</span> <span class="o">=</span> <span class="p">[</span><span class="n">zone</span> <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span>
                 <span class="k">if</span> <span class="n">zone</span><span class="o">.</span><span class="n">playback_device</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">zone</span> <span class="o">==</span> <span class="n">zp</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s2">&quot;Expect atleast 1 playback device other than &quot;</span>
                              <span class="s2">&quot;voice player&quot;</span><span class="p">)</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="n">zones</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">config_devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config_state</span> <span class="o">==</span> <span class="n">GROUP_GC</span><span class="p">:</span>
            <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
            <span class="n">master</span> <span class="o">=</span> <span class="n">zp</span>
        <span class="k">elif</span> <span class="n">config_state</span> <span class="o">==</span> <span class="n">GROUP_GM</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>
            <span class="n">master</span> <span class="o">=</span> <span class="n">zone</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">config_devices</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.configure_stereo"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.configure_stereo">[docs]</a>    <span class="k">def</span> <span class="nf">configure_stereo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">config_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure stereo pair with zp being part of config as provided via</span>
<span class="sd">        config_state param</span>
<span class="sd">        :param :class:`sonos.client.internal.SonosZoneComponent` zp: test zp</span>
<span class="sd">        :param str config_state: Initial config state of voice player</span>
<span class="sd">        :return: tuple of master and devices in config</span>
<span class="sd">        :rtype: :obj:`tuple`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing stereo pair config&quot;</span><span class="p">)</span>
        <span class="n">config_devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">config_devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="c1"># get another stereo pairable voice device</span>
        <span class="n">zones</span> <span class="o">=</span> <span class="p">[</span><span class="n">zone</span> <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice_players</span> <span class="k">if</span> <span class="n">zone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">zp</span> <span class="ow">and</span>
                 <span class="n">zone</span><span class="o">.</span><span class="n">is_stereo_pairable</span><span class="p">()</span> <span class="ow">and</span> <span class="n">zone</span><span class="o">.</span><span class="n">modelName</span> <span class="ow">in</span> <span class="n">DEVICES_WITH_BUILT_IN_MICS</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s2">&quot;Expect at least 1 more voice stereo pairable device. Total voice devices: &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voice_players</span><span class="p">))</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">zones</span><span class="p">)</span>
        <span class="n">config_devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config_state</span> <span class="o">==</span> <span class="n">STEREO_LEFT</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">add_stereo_bonded_zone_to_this_device</span><span class="p">(</span>
                <span class="n">zone</span><span class="p">)</span>
            <span class="n">master</span> <span class="o">=</span> <span class="n">zp</span>
        <span class="k">elif</span> <span class="n">config_state</span> <span class="o">==</span> <span class="n">STEREO_RIGHT</span><span class="p">:</span>
            <span class="n">zone</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">add_stereo_bonded_zone_to_this_device</span><span class="p">(</span>
                <span class="n">zp</span><span class="p">)</span>
            <span class="n">master</span> <span class="o">=</span> <span class="n">zone</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">config_devices</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.configure_ht"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.configure_ht">[docs]</a>    <span class="k">def</span> <span class="nf">configure_ht</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure ht config with test zp as a rear</span>
<span class="sd">        :param :class:`sonos.client.internal.SonosZoneComponent` zp: test zp</span>
<span class="sd">        :return: tuple of master and devices in config</span>
<span class="sd">        :rtype: :obj:`tuple`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing HT config&quot;</span><span class="p">)</span>
        <span class="n">config_devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">zones</span> <span class="o">=</span> <span class="p">[</span><span class="n">zone</span> <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice_players</span> <span class="k">if</span> <span class="n">zone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">zp</span> <span class="ow">and</span>
                 <span class="n">zone</span><span class="o">.</span><span class="n">is_stereo_pairable</span><span class="p">()</span> <span class="ow">and</span> <span class="n">zone</span><span class="o">.</span><span class="n">modelName</span> <span class="ow">in</span> <span class="n">DEVICES_WITH_BUILT_IN_MICS</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s2">&quot;Expect at least 1 more voice stereo pairable device. Total voice devices: &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voice_players</span><span class="p">))</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">zones</span><span class="p">)</span>
        <span class="n">config_devices</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">zp</span><span class="p">,</span> <span class="n">right</span><span class="p">])</span>
        <span class="n">masters</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_ht_master_capable</span><span class="p">()</span> <span class="ow">and</span>
                   <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_voice_capable</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Need one HT master&quot;</span><span class="p">)</span>
        <span class="n">master</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">masters</span><span class="p">)</span>
        <span class="n">config_devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="n">master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">create_50_config</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="c1">#reset udp logger on rear after anacapa restart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_diagcs</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">config_devices</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.get_voicetap_file_names_from_json_spec"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.get_voicetap_file_names_from_json_spec">[docs]</a>    <span class="k">def</span> <span class="nf">get_voicetap_file_names_from_json_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get name of voicetap file names from json.</span>
<span class="sd">        :param str json_file: Name of json file to read from.</span>
<span class="sd">        :return</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">json_str</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">file_names</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">,</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">file_names</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.get_voicetap_files_from_json_spec"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.get_voicetap_files_from_json_spec">[docs]</a>    <span class="k">def</span> <span class="nf">get_voicetap_files_from_json_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of voicetap files from json.</span>
<span class="sd">        :param str json_file: Name of json file to read from.</span>
<span class="sd">        :return</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">json_str</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">decoded_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">,</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">object</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="nb">object</span> <span class="ow">in</span> <span class="n">decoded_json</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">file_names</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.validate_avs_transactions"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.validate_avs_transactions">[docs]</a>    <span class="k">def</span> <span class="nf">validate_avs_transactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                  <span class="n">zp</span><span class="p">,</span>
                                  <span class="n">file_name</span><span class="p">,</span>
                                  <span class="n">log_file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">ignore_spatial_data_event</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">ignore_stop_capture_directive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">ignore_user_inactivity_report</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate avs transactions. The verifications is based on avs</span>
<span class="sd">        directives and events specified in json spec.</span>
<span class="sd">        Currently, we can optionally ignore StopCapture directive</span>
<span class="sd">        and SpatialPerceptualData event.</span>

<span class="sd">        Verification fails if:</span>
<span class="sd">        1. JSON spec has avs transaction, but is not seen during test</span>
<span class="sd">        2. JSON spec has avs transaction, it is seen during test, but it is</span>
<span class="sd">        ignored</span>
<span class="sd">        3. JSON spec does not have avs transaction and it is not ignored.</span>

<span class="sd">        Verification Passes if:</span>
<span class="sd">        1. JSON spec has avs transaction and it is seen during test.</span>
<span class="sd">        2. JSON spec does not have avs transaction and it is ignored.</span>

<span class="sd">        Exception to above: When &#39;ignore_order&#39; is present in avs transaction</span>
<span class="sd">        sequence, the CURRENT and NEXT (and ONLY NEXT ) event can have reversed</span>
<span class="sd">        order. For example, expectSpeech is followed by speechStarted,</span>
<span class="sd">        if ignore_order is specified in expect speech, it can occur after</span>
<span class="sd">        speechStarted and validation would not fail.</span>
<span class="sd">        Using &#39;ignore_order&#39; 2 consecutive transactions is not supported.</span>

<span class="sd">        :param :class:`sonos.client.internal.SonosZoneComponent` zp: test zp</span>
<span class="sd">        :param str file_name: Name of voicetap file for which to perform avs</span>
<span class="sd">            validation</span>
<span class="sd">        :param str log_file_name: log file name to use when saving failure</span>
<span class="sd">            logs.</span>
<span class="sd">        :param bool ignore_spatial_data_event: Ignore spatial data event?</span>
<span class="sd">        :param bool ignore_stop_capture_directive: Ignore stop capture</span>
<span class="sd">            directive?</span>
<span class="sd">        :return Did validation pass?</span>
<span class="sd">        :rtype: :obj:`bool`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating AVS transactions for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
        <span class="n">exp_avs_trans_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avs_validator</span><span class="o">.</span><span class="n">get_exp_avs_seq_from_spec</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_test_name</span><span class="p">(),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H_%M_%S&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp_avs_trans_seq</span><span class="p">):</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Now validating AVS transaction, index &lt;</span><span class="si">{}</span><span class="s2">&gt;. &quot;</span>
                    <span class="s2">&quot;TYPE: &lt;</span><span class="si">{}</span><span class="s2">&gt;  ===&gt; TRANSACTION: header &lt;</span><span class="si">{}</span><span class="s2">&gt;, payload &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">,</span>
                                                                                     <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                                                                                     <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">],</span>
                                                                                     <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;payload&#39;</span><span class="p">]))</span>
                <span class="c1"># set timeout waiting for events to occur</span>
                <span class="k">if</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">in</span> <span class="n">transaction</span><span class="p">:</span>
                    <span class="n">timeout</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">timeout</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span>
                <span class="n">expired</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
                <span class="n">remaining_timeout</span> <span class="o">=</span> <span class="n">timeout</span>
                <span class="k">while</span> <span class="n">remaining_timeout</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">remaining_timeout</span> <span class="o">=</span> <span class="n">expired</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">avs_log</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">while</span> <span class="n">avs_log</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">avs_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">avs_transaction_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">remaining_timeout</span><span class="p">)</span>
                        <span class="n">is_spatial_data_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avs_validator</span><span class="o">.</span><span class="n">is_spatial_data_event</span><span class="p">(</span><span class="n">avs_log</span><span class="p">)</span>
                        <span class="n">is_stop_capture_directive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avs_validator</span><span class="o">.</span><span class="n">is_stop_capture_directive</span><span class="p">(</span><span class="n">avs_log</span><span class="p">)</span>
                        <span class="n">is_user_inactivity_report_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avs_validator</span><span class="o">.</span><span class="n">is_user_inactivity_report_event</span><span class="p">(</span><span class="n">avs_log</span><span class="p">)</span>
                        <span class="n">ignore_msg</span> <span class="o">=</span> <span class="s1">&#39;*** Ignoring &lt;</span><span class="si">{}</span><span class="s1">&gt; validation ***&#39;</span>
                        <span class="k">if</span> <span class="n">ignore_spatial_data_event</span> <span class="ow">and</span> <span class="n">is_spatial_data_event</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ignore_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;spatial data event&#39;</span><span class="p">))</span>
                            <span class="n">avs_log</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">continue</span>
                        <span class="k">elif</span> <span class="n">ignore_stop_capture_directive</span> <span class="ow">and</span> <span class="n">is_stop_capture_directive</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ignore_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;stop capture directive&#39;</span><span class="p">))</span>
                            <span class="n">avs_log</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">continue</span>
                        <span class="k">elif</span> <span class="n">ignore_user_inactivity_report</span> <span class="ow">and</span> <span class="n">is_user_inactivity_report_event</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ignore_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;user inactivity event&#39;</span><span class="p">))</span>
                            <span class="n">avs_log</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">continue</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Looking at actual AVS transaction: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avs_log</span><span class="p">))</span>
                        <span class="k">if</span> <span class="s1">&#39;preconditions&#39;</span> <span class="ow">in</span> <span class="n">transaction</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying preconditions before expected AVS transaction&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">verify_pre_or_post_transaction_conditions</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;preconditions&#39;</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">avs_validator</span><span class="o">.</span><span class="n">validate_avs_transaction</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span>
                                                                    <span class="n">transaction</span><span class="p">,</span>
                                                                    <span class="n">avs_log</span><span class="p">,</span>
                                                                    <span class="n">transaction_type</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s1">&#39;postconditions&#39;</span> <span class="ow">in</span> <span class="n">transaction</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying postconditions after expected AVS transaction&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">verify_pre_or_post_transaction_conditions</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;postconditions&#39;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="n">AVSValidationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;Timed out waiting for expected AVS transaction&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">Empty</span><span class="p">,</span> <span class="n">AVSValidationException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_anacapa_trace</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="n">log_file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ne">TimeoutError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;TimeoutError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Empty</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span>
                    <span class="s2">&quot;No item in queue while waiting </span><span class="si">{}</span><span class="s2"> sec to receive AVS&quot;</span>
                    <span class="s2">&quot; event for transaction: </span><span class="si">{}</span><span class="s2">, filename = &lt;</span><span class="si">{}</span><span class="s2">&gt;, index = &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">transaction</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">AVSValidationException</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.verify_pre_or_post_transaction_conditions"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.verify_pre_or_post_transaction_conditions">[docs]</a>    <span class="k">def</span> <span class="nf">verify_pre_or_post_transaction_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                  <span class="n">conditions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify pre or post avs transaction conditions. Sample format:</span>
<span class="sd">             &quot;postconditions&quot;: [</span>
<span class="sd">              {</span>
<span class="sd">                &quot;ducked&quot;: false,</span>
<span class="sd">                &quot;timeout&quot;: 2</span>
<span class="sd">              },</span>
<span class="sd">              {</span>
<span class="sd">                &quot;ext_audio_src_playing&quot;: false,</span>
<span class="sd">                &quot;timeout&quot;: 2</span>
<span class="sd">              }</span>
<span class="sd">            ],</span>
<span class="sd">            specified timeout is optional with default of 2sec</span>
<span class="sd">        :param dict conditions: Condition to verify.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">conditions</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying player event: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">condition</span><span class="p">))</span>
            <span class="c1"># default timeout if not specified in spec.</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="k">if</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">in</span> <span class="n">condition</span><span class="p">:</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="n">condition</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="nb">property</span> <span class="ow">in</span> <span class="n">condition</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">property</span> <span class="o">==</span> <span class="s2">&quot;ducked&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">condition</span><span class="p">[</span><span class="s2">&quot;ducked&quot;</span><span class="p">]:</span>
                        <span class="n">wait_until_true</span><span class="p">(</span>
                            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">is_player_ducked</span><span class="p">(),</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Expect to be ducked within </span><span class="si">{}</span><span class="s2"> sec&quot;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">wait_until_true</span><span class="p">(</span>
                            <span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">is_player_ducked</span><span class="p">(),</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Expect to be unducked within </span><span class="si">{}</span><span class="s2"> sec&quot;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">property</span> <span class="o">==</span> <span class="s2">&quot;ext_audio_src_playing&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">condition</span><span class="p">[</span><span class="s2">&quot;ext_audio_src_playing&quot;</span><span class="p">]:</span>
                        <span class="n">wait_until_true</span><span class="p">(</span>
                            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">is_ext_audio_src_playing</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">),</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Expect to be playing ext audio &quot;</span>
                                   <span class="s2">&quot;within </span><span class="si">{}</span><span class="s2"> sec&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">wait_until_true</span><span class="p">(</span>
                            <span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">is_ext_audio_src_playing</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">raw_udn</span><span class="p">),</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Expect not to be playing ext audio &quot;</span>
                                   <span class="s2">&quot;within </span><span class="si">{}</span><span class="s2"> sec&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">veh</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.verify_playback_and_stop"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.verify_playback_and_stop">[docs]</a>    <span class="k">def</span> <span class="nf">verify_playback_and_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies master is playing then stops playback</span>
<span class="sd">        :param :class:`sonos.client.internal.SonosZoneComponent` zp: test zp</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># allow playback to continue for few seconds before ending the test</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
            <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">&gt;: Should be playing&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_playback</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.play_voicetap_and_validate_transactions"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.play_voicetap_and_validate_transactions">[docs]</a>    <span class="k">def</span> <span class="nf">play_voicetap_and_validate_transactions</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">voicetap</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1. Get voicetap URL</span>
<span class="sd">        2. Load overlay &amp; start</span>
<span class="sd">        3. Validate AVS transactions</span>

<span class="sd">        :param :class:`sonos.client.internal.SonosZoneComponent` zp: test zp</span>
<span class="sd">        :param str voicetap: filename</span>
<span class="sd">        :param bool validate: Validate AVS transactions?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">post_diagmsg</span><span class="p">(</span>
            <span class="s1">&#39;[START] Playing voice overlay &lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">voicetap</span><span class="p">))</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_voicetap_url</span><span class="p">(</span><span class="n">voicetap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voice_overlay</span><span class="o">.</span><span class="n">load_and_start_overlay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cleanup_overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_avs_transactions</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">voicetap</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.wait_for_num_alarms"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.wait_for_num_alarms">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_num_alarms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">num_alarms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1. Waits 45s for expected number of alarms</span>
<span class="sd">        2. Verify actual number of alarms vs expected</span>

<span class="sd">        :param :class:`sonos.client.internal.SonosZoneComponent` zp: test zp</span>
<span class="sd">        :param num_alarms: Number of expected alarms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_num_alarms</span><span class="p">(</span><span class="s1">&#39;AVS Timer&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_alarms</span><span class="p">,</span>
                <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Should have </span><span class="si">{}</span><span class="s1"> timers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_alarms</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span>
                <span class="n">num_alarms</span><span class="p">,</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_num_alarms</span><span class="p">(</span><span class="s1">&#39;AVS Timer&#39;</span><span class="p">),</span>
                <span class="s1">&#39;Should have </span><span class="si">{}</span><span class="s1"> timers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_alarms</span><span class="p">))</span></div>

<div class="viewcode-block" id="VoiceEndToEndBase.convert_wav_to_raw_for_zp"><a class="viewcode-back" href="../../../voice.voice_end_to_end.html#voice.voice_end_to_end.voice_end_to_end_base.VoiceEndToEndBase.convert_wav_to_raw_for_zp">[docs]</a>    <span class="k">def</span> <span class="nf">convert_wav_to_raw_for_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convert the given wav file in the resources directory to a .raw file</span>
<span class="sd">        formatted appropriately for the given zp</span>
<span class="sd">        :param zp: the zone player to make the raw file work for</span>
<span class="sd">        :type zp: :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param filename: the wav file to convert to raw</span>
<span class="sd">        :type filename: :obj:`str`</span>
<span class="sd">        :return: the new filename</span>
<span class="sd">        :rtype: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voicetap_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voicetap_path</span><span class="p">,</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.wav&#39;</span><span class="p">,</span>
                               <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">.raw&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">)))</span>

        <span class="n">wav_to_raw</span> <span class="o">=</span> <span class="n">WavToRaw</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile_name</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span>
                              <span class="n">num_mics</span><span class="o">=</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_num_mics</span><span class="p">(),</span>
                              <span class="n">num_dacs</span><span class="o">=</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_num_dacs</span><span class="p">(),</span>
                              <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">wav_to_raw</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>