
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>voice.ducking.ducking_volume_levels &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for voice.ducking.ducking_volume_levels</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">WorkflowTestFixture</span><span class="p">,</span> <span class="n">combinatorial</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.suite</span> <span class="k">import</span> <span class="n">WorkflowTestSuite</span>
<span class="kn">from</span> <span class="nn">sonos.simple_upgrade</span> <span class="k">import</span> <span class="n">ConditionalUpgradeTestFixture</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">voice.voice_end_to_end.voice_end_to_end_base</span> <span class="k">import</span> <span class="n">VoiceEndToEndBase</span><span class="p">,</span> \
    <span class="n">VoiceOverlay</span>
<span class="kn">from</span> <span class="nn">voice_util.wav_to_raw</span> <span class="k">import</span> <span class="n">WavToRaw</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="ne">TimeoutError</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">ducking_base</span> <span class="k">import</span> <span class="n">DuckingBase</span>
<span class="kn">from</span> <span class="nn">sonos.client</span> <span class="k">import</span> <span class="n">zone_player</span>
<span class="kn">from</span> <span class="nn">decorators</span> <span class="k">import</span> <span class="n">retry</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="n">UNDUCKED_FLAG</span> <span class="o">=</span> <span class="mi">0</span>


<div class="viewcode-block" id="GainVolBreakpoints"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.GainVolBreakpoints">[docs]</a><span class="k">class</span> <span class="nc">GainVolBreakpoints</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    class to hold gain breakpoints</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># the PLAY:1 values are also used for the Sonos One</span>
    <span class="c1"># the bonded values are the same for all players we&#39;re interested in</span>
    <span class="c1"># except the PLAY:1, which is different only for bonded sub configs</span>
    <span class="n">S13_vol</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
    <span class="n">S13_gain_bonded_sub</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">67.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">21.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">S13_gain</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">63.3</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mf">21.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">S9_vol</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
    <span class="n">S9_gain</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">71.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">S11_vol</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
    <span class="n">S11_gain</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">67.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">22.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">S14_vol</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
    <span class="n">S14_gain</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">67.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">22.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">DEFAULT_vol</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
    <span class="n">DEFAULT_gain</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">80.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">61.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># there are different curves depending on if a sub is bonded to the ZP</span>
    <span class="n">b_sub_gains</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;S13&quot;</span><span class="p">:</span> <span class="n">S13_gain_bonded_sub</span><span class="p">,</span>
        <span class="s2">&quot;S9&quot;</span><span class="p">:</span> <span class="n">S9_gain</span><span class="p">,</span>
        <span class="s2">&quot;S11&quot;</span><span class="p">:</span> <span class="n">S11_gain</span><span class="p">,</span>
        <span class="s2">&quot;S14&quot;</span><span class="p">:</span> <span class="n">S14_gain</span>
    <span class="p">}</span>

    <span class="n">b_sub_vols</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;S13&quot;</span><span class="p">:</span> <span class="n">S13_vol</span><span class="p">,</span>
        <span class="s2">&quot;S9&quot;</span><span class="p">:</span> <span class="n">S9_vol</span><span class="p">,</span>
        <span class="s2">&quot;S11&quot;</span><span class="p">:</span> <span class="n">S11_vol</span><span class="p">,</span>
        <span class="s2">&quot;S14&quot;</span><span class="p">:</span> <span class="n">S14_vol</span>
    <span class="p">}</span>

    <span class="c1"># curves by model without bonded sub</span>
    <span class="n">gains</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;S13&quot;</span><span class="p">:</span> <span class="n">S13_gain</span><span class="p">,</span>
        <span class="s2">&quot;S9&quot;</span><span class="p">:</span> <span class="n">S9_gain</span><span class="p">,</span>
        <span class="s2">&quot;S11&quot;</span><span class="p">:</span> <span class="n">S11_gain</span><span class="p">,</span>
        <span class="s2">&quot;S14&quot;</span><span class="p">:</span> <span class="n">S14_gain</span>
    <span class="p">}</span>

    <span class="n">vols</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;S13&quot;</span><span class="p">:</span> <span class="n">S13_vol</span><span class="p">,</span>
        <span class="s2">&quot;S9&quot;</span><span class="p">:</span> <span class="n">S9_vol</span><span class="p">,</span>
        <span class="s2">&quot;S11&quot;</span><span class="p">:</span> <span class="n">S11_vol</span><span class="p">,</span>
        <span class="s2">&quot;S14&quot;</span><span class="p">:</span> <span class="n">S14_vol</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="PlayerVolumeDbConverter"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.PlayerVolumeDbConverter">[docs]</a><span class="k">class</span> <span class="nc">PlayerVolumeDbConverter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    class to handle the volume to/from db conversions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># from dspControl.cxx</span>
    <span class="n">vol_bps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">db_bps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># from sounddev.cxx -    1.0 , 2,  , 3,  , 4   , 5   , 6   , ...</span>
    <span class="n">n_player_db_reduction</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">3.01</span><span class="p">,</span> <span class="mf">4.77</span><span class="p">,</span> <span class="mf">6.02</span><span class="p">,</span> <span class="mf">6.99</span><span class="p">,</span> <span class="mf">7.78</span><span class="p">,</span>
                             <span class="mf">8.45</span><span class="p">,</span> <span class="mf">9.03</span><span class="p">,</span> <span class="mf">9.54</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initialize gain and volume levels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gvb</span> <span class="o">=</span> <span class="n">GainVolBreakpoints</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_bps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gvb</span><span class="o">.</span><span class="n">DEFAULT_gain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_bps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gvb</span><span class="o">.</span><span class="n">DEFAULT_vol</span>

<div class="viewcode-block" id="PlayerVolumeDbConverter.reset_gain_vol"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.PlayerVolumeDbConverter.reset_gain_vol">[docs]</a>    <span class="k">def</span> <span class="nf">reset_gain_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">bonded_sub</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set the gain and volume based on the input zp</span>
<span class="sd">        :param zp: the primary zone player (either HT master,</span>
<span class="sd">        left in stereo pair, or voice player standalone)</span>
<span class="sd">        :type zp: :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param bonded_sub: whether or not a bonded sub is included</span>
<span class="sd">        :type bonded_sub: :obj:`bool`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zp_m</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span>

        <span class="c1"># defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_bps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gvb</span><span class="o">.</span><span class="n">DEFAULT_vol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_bps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gvb</span><span class="o">.</span><span class="n">DEFAULT_gain</span>
        <span class="c1"># set gains</span>
        <span class="k">if</span> <span class="n">bonded_sub</span><span class="p">:</span>
            <span class="n">gain_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gvb</span><span class="o">.</span><span class="n">b_sub_gains</span>
            <span class="n">vol_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gvb</span><span class="o">.</span><span class="n">b_sub_vols</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gain_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gvb</span><span class="o">.</span><span class="n">gains</span>
            <span class="n">vol_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gvb</span><span class="o">.</span><span class="n">vols</span>

        <span class="c1"># assign</span>
        <span class="k">if</span> <span class="n">zp_m</span> <span class="ow">in</span> <span class="n">gain_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_bps</span> <span class="o">=</span> <span class="n">gain_table</span><span class="p">[</span><span class="n">zp_m</span><span class="p">]</span>

        <span class="c1"># set volumes</span>
        <span class="k">if</span> <span class="n">zp_m</span> <span class="ow">in</span> <span class="n">vol_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vol_bps</span> <span class="o">=</span> <span class="n">vol_table</span><span class="p">[</span><span class="n">zp_m</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_convert_via_bps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bp_1</span><span class="p">,</span> <span class="n">bp_2</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convert val from its place in bp_1 to its place in bp_2</span>
<span class="sd">        :param bp_1: the array of breakpoints to use in converting from</span>
<span class="sd">        :type bp_1: :obj:`list`</span>
<span class="sd">        :param bp_2: the array of breakpoints to use in converting to</span>
<span class="sd">        :type bp_2: :obj:`list`</span>
<span class="sd">        :param val: the integer value to convert</span>
<span class="sd">        :type val: :obj:`int`</span>
<span class="sd">        :return: the integer value converted</span>
<span class="sd">        :rtpe: :obj:`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">bp_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">bp_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">bp_1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">bp_2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bp_1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">bp_1</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">bp_2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">bp_1</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">bp_2</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bp_2</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="n">bp_1</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bp_1</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>

<div class="viewcode-block" id="PlayerVolumeDbConverter.db_to_vol"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.PlayerVolumeDbConverter.db_to_vol">[docs]</a>    <span class="k">def</span> <span class="nf">db_to_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convert the input db level to volume</span>
<span class="sd">        :param db: db level number</span>
<span class="sd">        :type db: :obj:`int`</span>
<span class="sd">        :return: integer volume level</span>
<span class="sd">        :rtype: :obj:`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_via_bps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_bps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_bps</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span></div>

<div class="viewcode-block" id="PlayerVolumeDbConverter.vol_to_db"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.PlayerVolumeDbConverter.vol_to_db">[docs]</a>    <span class="k">def</span> <span class="nf">vol_to_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convert the input volume level to db</span>
<span class="sd">        :param vol: volume level number</span>
<span class="sd">        :type vol: :obj:`int`</span>
<span class="sd">        :return: integer db level</span>
<span class="sd">        :rtype: :obj:`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_via_bps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vol_bps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_bps</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span></div>

<div class="viewcode-block" id="PlayerVolumeDbConverter.calculate_ducking_level"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.PlayerVolumeDbConverter.calculate_ducking_level">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_ducking_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">n_zps</span><span class="p">,</span> <span class="n">primary_zp</span><span class="p">,</span>
                                <span class="n">bonded_sub</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        given the number of zone players and the current volume, calculate</span>
<span class="sd">        the expected ducking level</span>
<span class="sd">        :param volume: the current volume level</span>
<span class="sd">        :type volume: :obj:`int`</span>
<span class="sd">        :param n_zps: the number of zone players</span>
<span class="sd">        :type n_zps: :obj:`int`</span>
<span class="sd">        :param primary_zp: the primary zone player (either HT master,</span>
<span class="sd">        left in stereo pair, or voice player standalone)</span>
<span class="sd">        :type primary_zp: :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param bonded_sub: boolean for whether or not a bonded sub is included</span>
<span class="sd">        :type bonded_sub: :obj:`bool`</span>
<span class="sd">        :return: the expected ducking level on each device</span>
<span class="sd">        :rtype: :obj:`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_gain_vol</span><span class="p">(</span><span class="n">primary_zp</span><span class="p">,</span> <span class="n">bonded_sub</span><span class="p">)</span>
        <span class="n">base_ducking_level</span> <span class="o">=</span> <span class="mf">0.35</span> <span class="o">*</span> <span class="n">volume</span>

        <span class="c1"># if only one zp, return value here</span>
        <span class="k">if</span> <span class="n">n_zps</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">base_ducking_level</span><span class="p">)</span>

        <span class="n">base_ducking_level_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_to_db</span><span class="p">(</span><span class="n">base_ducking_level</span><span class="p">)</span>
        <span class="n">db_reduction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_player_db_reduction</span><span class="p">[</span><span class="n">n_zps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">new_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_to_vol</span><span class="p">(</span><span class="n">base_ducking_level_db</span> <span class="o">-</span> <span class="n">db_reduction</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_level</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DuckingVolumeLevelsTest"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest">[docs]</a><span class="k">class</span> <span class="nc">DuckingVolumeLevelsTest</span><span class="p">(</span><span class="n">VoiceEndToEndBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    class to test the ducking volume levels changes.</span>
<span class="sd">    We test the following test cases:</span>
<span class="sd">    1. Changing volume via controller or voice both result in updated</span>
<span class="sd">    ducking level.</span>
<span class="sd">    2. Ducking level calculation is as expected in various bonded</span>
<span class="sd">    configurations.</span>
<span class="sd">    3. Ducking can be toggled by any voice capable player in a bonded zone.</span>
<span class="sd">    4. Toggling mute from On to Off while a player is ducked will defer the</span>
<span class="sd">    mute until the ducking has ended.</span>
<span class="sd">    5. Toggling a mute from Off to On while a player is ducked will</span>
<span class="sd">    immediately cause mute to occur.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">VOICE_OVERLAY_PATH</span> <span class="o">=</span> <span class="s2">&quot;/Automation/ducking/&quot;</span>
    <span class="n">VOICE_OVERLAY_VOLUMES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;alexa_volume_to_00.wav&quot;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;alexa_volume_to_01.wav&quot;</span><span class="p">,</span>
        <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;alexa_volume_to_05.wav&quot;</span><span class="p">,</span>
        <span class="mi">10</span><span class="p">:</span> <span class="s2">&quot;alexa_volume_to_10.wav&quot;</span>
    <span class="p">}</span>

    <span class="n">VOICE_OVERLAY_WHAT_TIME_IS_IT</span> <span class="o">=</span> <span class="s2">&quot;alexa_what_time_is_it.wav&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initializer for test class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DuckingVolumeLevelsTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvdc</span> <span class="o">=</span> <span class="n">PlayerVolumeDbConverter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duck_msgs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unduck_msgs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_count_cb_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_config</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ducking_base</span> <span class="o">=</span> <span class="n">DuckingBase</span><span class="p">()</span>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.setUpFixture"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        setup test fixture</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set up the fixture for the test</span>

        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span> <span class="o">=</span> <span class="n">local_path</span> <span class="o">+</span> <span class="s1">&#39;/resource/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voicetap_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span> <span class="o">+</span> <span class="s1">&#39;voicetap/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voicetap_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voicetap_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_webserver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_files_from_nas</span><span class="p">(</span>
            <span class="n">files_list</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VOICE_OVERLAY_VOLUMES</span><span class="p">[</span>
                    <span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOICE_OVERLAY_VOLUMES</span>
            <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">VOICE_OVERLAY_WHAT_TIME_IS_IT</span><span class="p">],</span>
            <span class="n">files_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VOICE_OVERLAY_PATH</span>
        <span class="p">)</span>
        <span class="c1"># move the voicetap files to the voicetap directory</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.wav&#39;</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voicetap_path</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

        <span class="c1"># overwrite the existing diagcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sound_device&quot;</span><span class="p">:</span> <span class="mi">4</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.tearDownFixture"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Teardown fixture</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># re-enable speakers as part of cleanup</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">enable_speaker_audio</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.clear_voice_overlays"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.clear_voice_overlays">[docs]</a>    <span class="k">def</span> <span class="nf">clear_voice_overlays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        clear the voice overlays on each of the zps given</span>
<span class="sd">        :param zps: a tuple of zone players</span>
<span class="sd">        :type zps: :obj:`tuple` of</span>
<span class="sd">        :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">vo</span> <span class="o">=</span> <span class="n">VoiceOverlay</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="n">zp</span><span class="p">)</span>
            <span class="n">vo</span><span class="o">.</span><span class="n">remove_overlay_file</span><span class="p">()</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.get_anacapa_lines"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.get_anacapa_lines">[docs]</a>    <span class="k">def</span> <span class="nf">get_anacapa_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">msg_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the lines from anacapa.trace that contain the given msg</span>
<span class="sd">        :param zp: the zone player to execute on</span>
<span class="sd">        :type zp: :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param msg_filter: the string to filter by</span>
<span class="sd">        :type msg_filter: :obj:`str`</span>
<span class="sd">        :return: a list of lines from the trace with the msg</span>
<span class="sd">        :rtype: :obj:`list` of :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">anacapa_lines</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span>
            <span class="s2">&quot;cat /opt/log/anacapa.trace&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">found_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">msg_filter</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">anacapa_lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">msg_filter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">found_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">found_lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.cleanup_zps"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.cleanup_zps">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_zps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">other_zps</span><span class="p">,</span> <span class="n">bounce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unbond</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        clear the voice overlays and cleanup bonded configuration on each zp</span>
<span class="sd">        :param zp: the primary zp</span>
<span class="sd">        :type zp: :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param other_zps: optional tuple of other zone players</span>
<span class="sd">        :type other_zps: :obj:`tuple` of</span>
<span class="sd">        :param bounce: flag to bounce anacapa</span>
<span class="sd">        :type bounce: :obj:`bool`</span>
<span class="sd">        :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zps</span> <span class="o">=</span> <span class="n">other_zps</span> <span class="o">+</span> <span class="p">(</span><span class="n">zp</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_voice_overlays</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span>
        <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">unbond</span><span class="p">:</span>
            <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">bounce</span><span class="p">:</span>
            <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">]</span>
        <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">disable_speaker_audio</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">]</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.setUpTest"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="o">*</span><span class="n">other_zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        setup for test -&gt; call cleanup</span>
<span class="sd">        :param zp: the primary zp</span>
<span class="sd">        :type zp: :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param other_zps: optional tuple of other zone players</span>
<span class="sd">        :type other_zps: :obj:`tuple` of</span>
<span class="sd">        :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_zps</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">other_zps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duck_msgs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unduck_msgs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_count_cb_map</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.tearDownTest"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="o">*</span><span class="n">other_zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        clear the voice overlays and cleanup bonded configuration on each zp</span>
<span class="sd">        :param zp: the primary zp</span>
<span class="sd">        :type zp: :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param other_zps: optional tuple of other zone players</span>
<span class="sd">        :type other_zps: :obj:`tuple` of</span>
<span class="sd">        :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_zps</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">other_zps</span><span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.wait_for_volume_change"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.wait_for_volume_change">[docs]</a>    <span class="nd">@retry</span><span class="p">(</span><span class="n">attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">expected_exception</span><span class="o">=</span><span class="ne">TimeoutError</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wait_for_volume_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        change the volume with the given filename and wait for the player&#39;s</span>
<span class="sd">        volume to adjust to the given volume * 10</span>
<span class="sd">        :param zp: the ZP to adjust</span>
<span class="sd">        :type zp: :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param level: the level to adjust to (/10)</span>
<span class="sd">        :type level: :obj:`int`</span>
<span class="sd">        :param filename: the filename to use to adjust the zp&#39;s volume</span>
<span class="sd">        :type: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vo</span> <span class="o">=</span> <span class="n">VoiceOverlay</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">vo</span><span class="o">.</span><span class="n">load_and_start_overlay</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_voicetap_url</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">cleanup_overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">level</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetVolume</span><span class="p">(),</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for volume change to take effect:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;Expected Level: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Actual Level:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">level</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetVolume</span><span class="p">()),</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">16</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waited for volume change to take effect&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.change_volume_via_voice"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.change_volume_via_voice">[docs]</a>    <span class="k">def</span> <span class="nf">change_volume_via_voice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        upload a voicetap file to adjust the volume level on the player</span>
<span class="sd">        :param zp: the zone player whose volume we want to adjust</span>
<span class="sd">        :type zp: :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param level: the level of volume to set the zp to</span>
<span class="sd">        :type level: :obj:`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># raw file</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_wav_to_raw_for_zp</span><span class="p">(</span>
            <span class="n">zp</span><span class="o">=</span><span class="n">zp</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VOICE_OVERLAY_VOLUMES</span><span class="p">[</span><span class="n">level</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOICE_OVERLAY_VOLUMES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Volume not supported: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>

        <span class="c1"># wait for volume to change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volume_change</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c1"># wait for player to un-duck</span>
        <span class="n">wait_until_true</span><span class="p">(</span>
            <span class="n">predicate</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ducking_base</span><span class="o">.</span><span class="n">get_ducking_flag</span><span class="p">(</span><span class="n">zp</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="n">UNDUCKED_FLAG</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for player to show un-duck flag after volume &quot;</span>
                   <span class="s2">&quot;change via voice: zp: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">),</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">8</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waited for player to unduck&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.trigger_ducking"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.trigger_ducking">[docs]</a>    <span class="k">def</span> <span class="nf">trigger_ducking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        upload a voicetap file to trigger ducking to occur</span>
<span class="sd">        :param zp: the zone player to which to upload the voicetap file</span>
<span class="sd">        :type zp: :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Triggering Ducking from ZP: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">force_duck_unduck</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;set&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.trigger_unducking"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.trigger_unducking">[docs]</a>    <span class="k">def</span> <span class="nf">trigger_unducking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        trigger the zp to un-duck</span>
<span class="sd">        :param zp: the ZP to trigger</span>
<span class="sd">        :type zp: :obj:`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Triggering Un-Ducking from ZP: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">force_duck_unduck</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;clear&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.ducking_cb"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.ducking_cb">[docs]</a>    <span class="k">def</span> <span class="nf">ducking_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match_str</span><span class="p">,</span> <span class="n">zp_sn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generic callback method to set the ducking dictionary for the given</span>
<span class="sd">        zone player&#39;s SN to true (ducking log detected)</span>
<span class="sd">        :param zp_sn: the serial number of the player that reported ducked</span>
<span class="sd">        :type zp_sn: :obj:`str`</span>
<span class="sd">        :param match_str: the string that matches the given regex</span>
<span class="sd">        :type match_str: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ducked str match: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">match_str</span><span class="p">))</span>
        <span class="c1"># generic cb for knowing when a player ducks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ducking_cb_map</span><span class="p">[</span><span class="n">zp_sn</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.unducking_cb"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.unducking_cb">[docs]</a>    <span class="k">def</span> <span class="nf">unducking_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match_str</span><span class="p">,</span> <span class="n">zp_sn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generic callback method to set the unducking dictionary for the given</span>
<span class="sd">        zone player&#39;s SN to true (unducking log detected)</span>
<span class="sd">        :param zp_sn: the serial number of the player that reported unducked</span>
<span class="sd">        :type zp_sn: :obj:`str`</span>
<span class="sd">        :param match_str: the string that matches the given regex</span>
<span class="sd">        :type match_str: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Un-ducked str match: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">match_str</span><span class="p">))</span>

        <span class="c1">#  generic cb for knowing when a player ducks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unducking_cb_map</span><span class="p">[</span><span class="n">zp_sn</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.unmute_cb"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.unmute_cb">[docs]</a>    <span class="k">def</span> <span class="nf">unmute_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match_str</span><span class="p">,</span> <span class="n">zp_sn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generic callback method to set the un-mute dictionary for the give</span>
<span class="sd">        zone player&#39;s serial number to true (unmute log detected)</span>
<span class="sd">        :param zp_sn: the serial number of the player that reported un-muted</span>
<span class="sd">        :type zp_sn: :obj:`str`</span>
<span class="sd">        :param match_str: the string that matches the given regex</span>
<span class="sd">        :type match_str: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Un-mute str match: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">match_str</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unmute_cb_map</span><span class="p">[</span><span class="n">zp_sn</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.wait_for_zps_to_duck"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.wait_for_zps_to_duck">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_zps_to_duck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        wait for all of the given zone players to report having ducked</span>
<span class="sd">        :param zps: a list of zone players on which to validate the</span>
<span class="sd">        ducking has occurred</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># wait until all zps duck</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span>
                <span class="n">predicate</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ducking_cb_map</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">],</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for all zps to report ducking to &quot;</span>
                       <span class="s2">&quot;expected level. &quot;</span>
                       <span class="s2">&quot;Statuses: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ducking_cb_map</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="n">expected_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duck_msgs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                <span class="s2">&quot;Not all players sent duck messages. </span><span class="si">{}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Expected duck messages: </span><span class="si">{}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;for current zp volumes: </span><span class="si">{}</span><span class="s2">.&quot;</span>
                <span class="s2">&quot;sound_device messages: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ducking_cb_map</span><span class="p">,</span> <span class="n">expected_msg</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetVolume</span><span class="p">()</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">],</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_anacapa_lines</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;sound_device&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">]</span>
                <span class="p">))</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.wait_for_zps_to_unduck"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.wait_for_zps_to_unduck">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_zps_to_unduck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        wait for all of the given zone players to report having unducked</span>
<span class="sd">        :param zps: a list of zone players on which to validate the</span>
<span class="sd">        unducking has occurred</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># wait until all zps unduck</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span>
                <span class="n">predicate</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unducking_cb_map</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">],</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for all zps to unduck. Status: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unducking_cb_map</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="n">expected_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unduck_msgs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Not all players sent unduck messages. </span><span class="si">{}</span><span class="s2">&quot;</span>
                      <span class="s2">&quot;Expected unduck messages: </span><span class="si">{}</span><span class="s2">&quot;</span>
                      <span class="s2">&quot;sound_device messages: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">unducking_cb_map</span><span class="p">,</span> <span class="n">expected_msg</span><span class="p">,</span>
                          <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_anacapa_lines</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;sound_device&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">zp</span>
                           <span class="ow">in</span> <span class="n">zps</span><span class="p">]))</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.setup_cbs_for_ducking_unducking"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.setup_cbs_for_ducking_unducking">[docs]</a>    <span class="k">def</span> <span class="nf">setup_cbs_for_ducking_unducking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">,</span> <span class="n">duck_msg</span><span class="p">,</span> <span class="n">unduck_msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        setup callbacks for ducking and unducking states for each zone player</span>
<span class="sd">        :param zps: the zone players to setup callbacks for</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param duck_msg: the regular expression to search for that will</span>
<span class="sd">        trigger a callback to mark the particular zp as &quot;ducked&quot;</span>
<span class="sd">        :type duck_msg: :obj:`string`</span>
<span class="sd">        :param unduck_msg: the regular expression to search for that will</span>
<span class="sd">        trigger a callback to mark the particular zp as &quot;unducked&quot;</span>
<span class="sd">        :type unduck_msg: :obj:`string`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ducking_cb_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unducking_cb_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ducking_cb_map</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unducking_cb_map</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">udp_logger</span><span class="o">.</span><span class="n">add_search</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">duck_msg</span><span class="p">,</span>
                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ducking_cb</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">,</span>
                <span class="n">zp</span><span class="o">=</span><span class="n">zp</span>
            <span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">udp_logger</span><span class="o">.</span><span class="n">add_search</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">unduck_msg</span><span class="p">,</span>
                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unducking_cb</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">,</span>
                <span class="n">zp</span><span class="o">=</span><span class="n">zp</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duck_msgs</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span> <span class="o">=</span> <span class="n">duck_msg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unduck_msgs</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span> <span class="o">=</span> <span class="n">unduck_msg</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.determine_primary_zp"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.determine_primary_zp">[docs]</a>    <span class="k">def</span> <span class="nf">determine_primary_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        determine which zp is primary in the group (either HT master or</span>
<span class="sd">        voice player)</span>
<span class="sd">        :param zps: list of zone players</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :return: primary zone player</span>
<span class="sd">        :rtype: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ht_masters</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">ht_master_capable</span><span class="p">]</span>
        <span class="n">voice_players</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_capable</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ht_masters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ht_masters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># otherwise, it&#39;s not a HT setup</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">voice_players</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.get_n_channels"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.get_n_channels">[docs]</a>    <span class="k">def</span> <span class="nf">get_n_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return the number of channels for the given zps</span>
<span class="sd">        :param zps: an array of zone players on which to validate the</span>
<span class="sd">        ducking levels</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :return: the number of channels used for calculated the ducking level</span>
<span class="sd">        :rtype: :obj:`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># if it&#39;s a standalone elrey, we treat it as 1.0</span>
        <span class="c1"># if it&#39;s part of a HT configuration, it&#39;s treated as 3 players</span>
        <span class="n">ht_multiplier</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ht_multiplier</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n_channels</span> <span class="o">+=</span> <span class="n">ht_multiplier</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
            <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">ht_master_capable</span><span class="p">])</span>

        <span class="c1"># add in non-HT master channels</span>
        <span class="n">n_channels</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">([</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">ht_master_capable</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;For zones: </span><span class="si">{}</span><span class="s2">, n_channels: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">zps</span><span class="p">,</span> <span class="n">n_channels</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="n">n_channels</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.sub_in_zps"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.sub_in_zps">[docs]</a>    <span class="k">def</span> <span class="nf">sub_in_zps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return true if there&#39;s a sub in the list of zps</span>
<span class="sd">        :param zps: an array of zone players</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :return: True/False</span>
<span class="sd">        :rtype: :obj:`bool`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span>
            <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_sub</span><span class="p">()])</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.verify_ducking_volume_level"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.verify_ducking_volume_level">[docs]</a>    <span class="k">def</span> <span class="nf">verify_ducking_volume_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        determine the ducking level expected based on the players and the</span>
<span class="sd">        configuration</span>
<span class="sd">        :param zps: an array of zone players on which to validate the</span>
<span class="sd">        ducking levels</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v_zps</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_capable</span><span class="p">]</span>

        <span class="c1"># determine which zps to check for the change messages</span>
        <span class="n">check_zps</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_capable</span><span class="p">]</span> <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">ht_master_capable</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">]</span> <span class="k">else</span> <span class="p">[</span>
            <span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">ht_master_capable</span><span class="p">]</span>

        <span class="n">volume_level</span> <span class="o">=</span> <span class="n">check_zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetVolume</span><span class="p">()</span>

        <span class="c1"># calcualte the expected ducking level</span>
        <span class="n">exp_ducking_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvdc</span><span class="o">.</span><span class="n">calculate_ducking_level</span><span class="p">(</span>
            <span class="n">volume</span><span class="o">=</span><span class="n">volume_level</span><span class="p">,</span> <span class="n">n_zps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_n_channels</span><span class="p">(</span><span class="n">zps</span><span class="p">),</span>
            <span class="n">primary_zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">determine_primary_zp</span><span class="p">(</span><span class="n">zps</span><span class="p">),</span>
            <span class="n">bonded_sub</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_in_zps</span><span class="p">(</span><span class="n">zps</span><span class="p">))</span>

        <span class="n">duck_msg</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;using ducking volume \(</span><span class="si">{}</span><span class="s2">\)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp_ducking_level</span><span class="p">)</span>
        <span class="n">unduck_msg</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;using normal volume \(</span><span class="si">{}</span><span class="s2">\)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">volume_level</span><span class="p">)</span>
        <span class="c1"># if the expected ducking level is the same as the normal level,</span>
        <span class="c1"># just use ducking enabled message as the flag</span>
        <span class="k">if</span> <span class="n">exp_ducking_level</span> <span class="o">==</span> <span class="n">volume_level</span><span class="p">:</span>
            <span class="n">duck_msg</span> <span class="o">=</span> <span class="s2">&quot;ducking enabled&quot;</span>

        <span class="c1"># now test the ducking is triggered as expected when invoked from all</span>
        <span class="c1"># voice capable zps. this verifies that ducking has occured at the</span>
        <span class="c1"># appropriate volume level (based on log)</span>
        <span class="k">for</span> <span class="n">v_zp</span> <span class="ow">in</span> <span class="n">v_zps</span><span class="p">:</span>

            <span class="c1"># each time, need to reset the callback maps so that values</span>
            <span class="c1"># don&#39;t latch to True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_cbs_for_ducking_unducking</span><span class="p">(</span>
                <span class="n">zps</span><span class="o">=</span><span class="n">check_zps</span><span class="p">,</span>
                <span class="n">duck_msg</span><span class="o">=</span><span class="n">duck_msg</span><span class="p">,</span>
                <span class="n">unduck_msg</span><span class="o">=</span><span class="n">unduck_msg</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_ducking</span><span class="p">(</span><span class="n">v_zp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_zps_to_duck</span><span class="p">(</span><span class="n">check_zps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_unducking</span><span class="p">(</span><span class="n">v_zp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_zps_to_unduck</span><span class="p">(</span><span class="n">check_zps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_volume_levels</span><span class="p">(</span><span class="n">zps</span><span class="p">,</span> <span class="n">volume_level</span><span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.execute_ducking_levels_test"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.execute_ducking_levels_test">[docs]</a>    <span class="k">def</span> <span class="nf">execute_ducking_levels_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        change the volume by controller, by voice, and ensure ducking level</span>
<span class="sd">        is as expected across all players. Exercise all permutations of</span>
<span class="sd">        which players change volume via voice</span>
<span class="sd">        :param zps: list of zone players (assumed bonded) to execute on</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v_zps</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_capable</span><span class="p">]</span>

        <span class="c1"># vc_zp is zp that changes volume via voice</span>
        <span class="k">for</span> <span class="n">vc_zp</span> <span class="ow">in</span> <span class="n">v_zps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Executing Ducking Levels Test.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;VC_ZP: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vc_zp</span><span class="p">))</span>

            <span class="c1"># set volume to 1 with controller on zp</span>
            <span class="n">vc_zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># raise volume to 5 with voice</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_volume_via_voice</span><span class="p">(</span><span class="n">vc_zp</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

            <span class="c1"># verify ducking levels are as expected</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_ducking_volume_level</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span>

            <span class="c1"># set volume to 1 with controller</span>
            <span class="n">vc_zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># lower volume to 1 with voice</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_volume_via_voice</span><span class="p">(</span><span class="n">vc_zp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># verify ducking level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_ducking_volume_level</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.verify_muted"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.verify_muted">[docs]</a>    <span class="k">def</span> <span class="nf">verify_muted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        verify that all given zone players are muted or fail case</span>
<span class="sd">        :param zps: list of zone players (assumed bonded) to execute on</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param msg: the msg to display in the event of a failure</span>
<span class="sd">        :type msg: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># verify all players are muted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span>
            <span class="kc">False</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetMute</span><span class="p">()</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">],</span>
            <span class="n">message</span><span class="o">=</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;: un-muted playes: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetMute</span><span class="p">()]</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.verify_unmuted"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.verify_unmuted">[docs]</a>    <span class="k">def</span> <span class="nf">verify_unmuted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        verify that all zone players are unmuted or fail case</span>
<span class="sd">        :param zps: list of zone players (assumed bonded) to execute on</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param msg: the msg to display in the event of a failure</span>
<span class="sd">        :type msg: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># verify all players are muted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span>
            <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetMute</span><span class="p">()</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">],</span>
            <span class="n">message</span><span class="o">=</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;: muted players: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetMute</span><span class="p">()]</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.verify_volume_levels"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.verify_volume_levels">[docs]</a>    <span class="k">def</span> <span class="nf">verify_volume_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        verify that all zone players have the specified volume level or fail</span>
<span class="sd">        case</span>
<span class="sd">        :param zps: list of zone players (assumed bonded) to execute on</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param level: the volume level that the players should be at</span>
<span class="sd">        :type level: :obj:`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetVolume</span><span class="p">()</span> <span class="o">==</span> <span class="n">level</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Volume level is as expected for zp.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> vs </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">level</span><span class="p">,</span> <span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetVolume</span><span class="p">(),</span> <span class="n">zp</span><span class="p">))</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.verify_mute_while_ducked"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.verify_mute_while_ducked">[docs]</a>    <span class="k">def</span> <span class="nf">verify_mute_while_ducked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        trigger the players to duck, mute one, verify mute takes effect</span>
<span class="sd">        right away on all players</span>
<span class="sd">        :param zps: list of zone players (assumed bonded) to execute on</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># determine which zps to check for the change messages</span>
        <span class="n">check_zps</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_capable</span><span class="p">]</span> <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">ht_master_capable</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">]</span> <span class="k">else</span> <span class="p">[</span>
            <span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">ht_master_capable</span><span class="p">]</span>

        <span class="c1"># get voice capable players</span>
        <span class="n">v_zps</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_capable</span><span class="p">]</span>

        <span class="c1"># set volume via controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Mute While Ducked Test&quot;</span><span class="p">)</span>
        <span class="n">volume_level</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">v_zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="n">volume_level</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">v_zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetVolume</span><span class="p">()</span> <span class="o">==</span> <span class="n">volume_level</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for volume to adjust to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">volume_level</span><span class="p">),</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>

        <span class="c1"># calculate expected ducking level</span>
        <span class="n">exp_ducking_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvdc</span><span class="o">.</span><span class="n">calculate_ducking_level</span><span class="p">(</span>
            <span class="n">volume_level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_n_channels</span><span class="p">(</span><span class="n">zps</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">determine_primary_zp</span><span class="p">(</span><span class="n">zps</span><span class="p">),</span> <span class="n">bonded_sub</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_in_zps</span><span class="p">(</span><span class="n">zps</span><span class="p">))</span>

        <span class="c1"># set regex&#39;s to look for</span>
        <span class="n">duck_msg</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;using ducking volume \(</span><span class="si">{}</span><span class="s2">\)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp_ducking_level</span><span class="p">)</span>
        <span class="n">unduck_msg</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;ducking disabled&quot;</span>

        <span class="c1"># set up callbacks for duck/unduck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_cbs_for_ducking_unducking</span><span class="p">(</span>
            <span class="n">zps</span><span class="o">=</span><span class="n">check_zps</span><span class="p">,</span>
            <span class="n">duck_msg</span><span class="o">=</span><span class="n">duck_msg</span><span class="p">,</span>
            <span class="n">unduck_msg</span><span class="o">=</span><span class="n">unduck_msg</span><span class="p">)</span>

        <span class="c1"># apply mute only at primary ZP (i.e. HT master)</span>
        <span class="n">mute_player</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_primary_zp</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span>

        <span class="c1"># execute tests</span>
        <span class="k">for</span> <span class="n">v_zp</span> <span class="ow">in</span> <span class="n">v_zps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Expected duck message: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">duck_msg</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Expected un-duck message: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unduck_msg</span><span class="p">))</span>

            <span class="c1"># trigger ducking on player</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_ducking</span><span class="p">(</span><span class="n">v_zp</span><span class="p">)</span>

            <span class="c1"># wait for ducking to occur</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_zps_to_duck</span><span class="p">(</span><span class="n">check_zps</span><span class="p">)</span>

            <span class="c1"># mute a player</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set mute from zp: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mute_player</span><span class="p">))</span>
            <span class="n">mute_player</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetMute</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># verify all players are muted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_muted</span><span class="p">(</span><span class="n">zps</span><span class="p">,</span> <span class="s2">&quot;SetMute &quot;</span>
                                   <span class="s2">&quot;called from zp: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mute_player</span><span class="p">))</span>

            <span class="c1"># trigger un-duck</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_unducking</span><span class="p">(</span><span class="n">v_zp</span><span class="p">)</span>

            <span class="c1"># wait for ducking to finish before moving on</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_zps_to_unduck</span><span class="p">(</span><span class="n">check_zps</span><span class="p">)</span>

            <span class="c1"># verify still muted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_muted</span><span class="p">(</span><span class="n">zps</span><span class="p">,</span> <span class="s2">&quot;Players remain muted after ducking &quot;</span>
                                   <span class="s2">&quot;completes&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.verify_unmute_after_ducked"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.verify_unmute_after_ducked">[docs]</a>    <span class="k">def</span> <span class="nf">verify_unmute_after_ducked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        mute the players, trigger ducking, unmute during ducking,</span>
<span class="sd">        verify unmute does not occur until after ducking ends</span>
<span class="sd">        :param zps: list of zone players (assumed bonded) to execute on</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># determine which zps to check for the change messages</span>
        <span class="n">check_zps</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_capable</span><span class="p">]</span> <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">ht_master_capable</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">]</span> <span class="k">else</span> <span class="p">[</span>
            <span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">ht_master_capable</span><span class="p">]</span>

        <span class="c1"># get voice capable players</span>
        <span class="n">v_zps</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">voice_capable</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Un-mute After Ducked Test&quot;</span><span class="p">)</span>

        <span class="c1"># set volume via controller</span>
        <span class="n">volume_level</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">v_zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="n">volume_level</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">v_zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetVolume</span><span class="p">()</span> <span class="o">==</span> <span class="n">volume_level</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for volume to adjust to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">volume_level</span><span class="p">),</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="n">volume_level</span> <span class="o">=</span> <span class="n">v_zps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">GetVolume</span><span class="p">()</span>

        <span class="c1"># create regex&#39;s for ducking/unducking</span>
        <span class="n">duck_msg</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;ducking enabled&quot;</span>
        <span class="n">unduck_msg</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;using normal volume \(</span><span class="si">{}</span><span class="s2">\)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">volume_level</span><span class="p">)</span>

        <span class="c1"># setup ducking/unducking callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_cbs_for_ducking_unducking</span><span class="p">(</span>
            <span class="n">zps</span><span class="o">=</span><span class="n">check_zps</span><span class="p">,</span>
            <span class="n">duck_msg</span><span class="o">=</span><span class="n">duck_msg</span><span class="p">,</span>
            <span class="n">unduck_msg</span><span class="o">=</span><span class="n">unduck_msg</span><span class="p">)</span>

        <span class="c1"># initialize callback map for zp sns to detect mute defer message</span>
        <span class="n">unmute_msg</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;deferring mute change&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unmute_cb_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">check_zps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unmute_cb_map</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">udp_logger</span><span class="o">.</span><span class="n">add_search</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">unmute_msg</span><span class="p">,</span>
                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unmute_cb</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">,</span>
                <span class="n">zp</span><span class="o">=</span><span class="n">zp</span><span class="p">)</span>

        <span class="c1"># determine player at which to apply mute (i.e. primary ZP -&gt; HT</span>
        <span class="c1"># master)</span>
        <span class="n">mute_player</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_primary_zp</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span>

        <span class="c1"># execute tests</span>
        <span class="k">for</span> <span class="n">v_zp</span> <span class="ow">in</span> <span class="n">v_zps</span><span class="p">:</span>
            <span class="c1"># set Mute to true</span>
            <span class="n">mute_player</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetMute</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># trigger ducking</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_ducking</span><span class="p">(</span><span class="n">v_zp</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Expected duck message: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">duck_msg</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Expected un-duck message: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unduck_msg</span><span class="p">))</span>

            <span class="c1"># wait for players to duck</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_zps_to_duck</span><span class="p">(</span><span class="n">check_zps</span><span class="p">)</span>

            <span class="c1"># verify all players are muted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_muted</span><span class="p">(</span><span class="n">zps</span><span class="p">,</span> <span class="s2">&quot;Players are muted while ducked&quot;</span><span class="p">)</span>

            <span class="c1"># unmute the players</span>
            <span class="n">mute_player</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetMute</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># verify players are still muted, but have deferred un-mute</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wait_until_true</span><span class="p">(</span>
                    <span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unmute_cb_map</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span>
                                          <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">check_zps</span><span class="p">],</span>
                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for players to defer mute change (&quot;</span>
                           <span class="s2">&quot;mute-&gt;un-mute): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unmute_cb_map</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Players did not defer mute change. &quot;</span>
                          <span class="s2">&quot;Msg: </span><span class="si">{}</span><span class="s2">, Map: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                           <span class="n">unmute_msg</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">unmute_cb_map</span><span class="p">))</span>

            <span class="c1"># trigger un-duck</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_unducking</span><span class="p">(</span><span class="n">v_zp</span><span class="p">)</span>

            <span class="c1"># wait for ducking to finish before moving on</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_zps_to_unduck</span><span class="p">(</span><span class="n">check_zps</span><span class="p">)</span>

            <span class="c1"># verify unmuted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_unmuted</span><span class="p">(</span><span class="n">zps</span><span class="p">,</span> <span class="s2">&quot;Players un-muted after ducking &quot;</span>
                                     <span class="s2">&quot;completes when un-mute called from &quot;</span>
                                     <span class="s2">&quot;zp: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_zp</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_volume_levels</span><span class="p">(</span><span class="n">zps</span><span class="p">,</span> <span class="n">volume_level</span><span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.run_verifications"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.run_verifications">[docs]</a>    <span class="k">def</span> <span class="nf">run_verifications</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        method to run through all of the ducking tests for all cases (</span>
<span class="sd">        standalone, stereo pair, HT).</span>
<span class="sd">        :param zps: list of zone players (assumed bonded) to execute on</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">        :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">primary_zp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_primary_zp</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span>
        <span class="n">primary_zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetMute</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="c1"># set logging levels as expected</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting diagc&#39;s&quot;</span><span class="p">)</span>
            <span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">diagc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">[</span><span class="n">diagc</span><span class="p">])</span>
             <span class="k">for</span> <span class="n">diagc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">]</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">disable_speaker_audio</span><span class="p">()</span>
            <span class="c1"># make sure the buttons are not in a lock state so as to enable</span>
            <span class="c1"># mic mute/unmute button presses</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">SetButtonLockState</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;--&gt;Executing Ducking Levels Tests&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_ducking_levels_test</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;--&gt;Executing Mute While Ducked Tests&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_mute_while_ducked</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;--&gt;Executing Unmute After Ducked Tests&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_unmute_after_ducked</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span>
        <span class="c1"># cleanup and remove overlay files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_voice_overlays</span><span class="p">(</span><span class="n">zps</span><span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.generate_voice_player_for_test"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.generate_voice_player_for_test">[docs]</a>    <span class="k">def</span> <span class="nf">generate_voice_player_for_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        wrap the output of the generator in the format expected by setUpTest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span>\
                <span class="n">generators</span><span class="o">.</span><span class="n">generate_testbed_unique_voice_capable_devices</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">get_arch</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arches</span><span class="p">:</span>
                <span class="k">yield</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="p">)</span>
                <span class="n">arches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">get_arch</span><span class="p">())</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.get_sub"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.get_sub">[docs]</a>    <span class="k">def</span> <span class="nf">get_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the sub (if any) from my devices</span>
<span class="sd">        :return: sonos sub</span>
<span class="sd">        :rtype: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subs</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_sub</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterOrStop</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Need at least one sub to test&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">subs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.channel_count_change_cb"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.channel_count_change_cb">[docs]</a>    <span class="k">def</span> <span class="nf">channel_count_change_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">zp_sn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        callback for a configured zone channel count change message</span>
<span class="sd">        :param msg: the msg we&#39;re receiving a cb for</span>
<span class="sd">        :type msg: :obj:`str`</span>
<span class="sd">        :param zp_sn: the serial number of the zone player</span>
<span class="sd">        :type zp_sn: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received callback for channel count change: ZP_SN &quot;</span>
                         <span class="s2">&quot;= </span><span class="si">{}</span><span class="s2">, msg = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp_sn</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>

        <span class="c1"># set the flag to true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_count_cb_map</span><span class="p">[</span><span class="n">zp_sn</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.add_watch_for_zone_channel_count_change"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.add_watch_for_zone_channel_count_change">[docs]</a>    <span class="k">def</span> <span class="nf">add_watch_for_zone_channel_count_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">channel_count</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add watcher for a message from &lt;sound_device, 4&gt;</span>
<span class="sd">        Zone channel count has been updated to &lt;channel_count&gt;</span>
<span class="sd">        :param zp: the zone player to monitor</span>
<span class="sd">        :type zp: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param channel_count: the channel count to watch for</span>
<span class="sd">        :type channel_count: :obj`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Zone channel count has been updated to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">channel_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_count_cb_map</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">udp_logger</span><span class="o">.</span><span class="n">add_search</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_count_change_cb</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">,</span>
            <span class="n">zp</span><span class="o">=</span><span class="n">zp</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DuckingVolumeLevelsTest.wait_for_zone_channel_count_change"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.wait_for_zone_channel_count_change">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_zone_channel_count_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">channel_count</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        wait for a message from &lt;sound_device, 4&gt;</span>
<span class="sd">        Zone channel count has been updated to &lt;channel_count&gt;</span>
<span class="sd">        :param zp: the zone player to monitor</span>
<span class="sd">        :type zp: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param channel_count: the channel count to watch for</span>
<span class="sd">        :type channel_count: :obj`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Zone channel count has been updated to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">channel_count</span><span class="p">)</span>
        <span class="n">match_found</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># do the waiting now</span>
            <span class="n">wait_until_true</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_count_cb_map</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">],</span>
                <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Waiting for channel count to change on zp: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">zp</span>
                <span class="p">),</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">120</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="n">match_found</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># remove the query</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">udp_logger</span><span class="o">.</span><span class="n">remove_search</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="n">zp</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># fail if nothing found</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match_found</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Waited for channel count to change on zp: </span><span class="si">{}</span><span class="s2"> &quot;</span>
                      <span class="s2">&quot;to: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span></div>

    <span class="c1"># only voice capable zone players</span>
    <span class="c1"># 1 player</span>
<div class="viewcode-block" id="DuckingVolumeLevelsTest.test_single_voice_player"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.test_single_voice_player">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s2">&quot;generate_voice_player_for_test&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_single_voice_player</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test the case for a standalone voice player (1.0 and 3.0 configs)</span>
<span class="sd">        :param zp: zone players to execute on</span>
<span class="sd">        :type zp: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_verifications</span><span class="p">([</span><span class="n">zp</span><span class="p">])</span></div>

    <span class="c1"># single voice player with bonded sub</span>
<div class="viewcode-block" id="DuckingVolumeLevelsTest.test_single_voice_player_and_sub"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.test_single_voice_player_and_sub">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s2">&quot;generate_voice_player_for_test&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_single_voice_player_and_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test the case for a standalone voice player with sub, covering 1.1</span>
<span class="sd">        and 3.1 configurations</span>
<span class="sd">        :param zp: zone players to execute on</span>
<span class="sd">        :type zp: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sub</span><span class="p">()</span>
        <span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">diagc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">[</span><span class="n">diagc</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">diagc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">]</span>
        <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">ht_master_capable</span><span class="p">:</span>
            <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_watch_for_zone_channel_count_change</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">create_31_config</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_watch_for_zone_channel_count_change</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">add_bonded_sub_to_this_device</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_zone_channel_count_change</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_verifications</span><span class="p">([</span><span class="n">zp</span><span class="p">,</span> <span class="n">sub</span><span class="p">])</span></div>

    <span class="c1"># only voice capable stereo pairs</span>
    <span class="c1"># 2 players</span>
<div class="viewcode-block" id="DuckingVolumeLevelsTest.test_stereo_pair_voice_players"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.test_stereo_pair_voice_players">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s2">&quot;generate_voice_pairs&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_stereo_pair_voice_players</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test the case for a pair of stereo bonded players</span>
<span class="sd">        :param left: left zone player</span>
<span class="sd">        :type left: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param right: right zone player</span>
<span class="sd">        :type right: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">[</span><span class="n">left</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">diagc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">[</span><span class="n">diagc</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">diagc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_watch_for_zone_channel_count_change</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">left</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">add_stereo_pair</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_zone_channel_count_change</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_verifications</span><span class="p">([</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">])</span></div>

    <span class="c1"># 3 players</span>
<div class="viewcode-block" id="DuckingVolumeLevelsTest.test_stereo_pair_voice_bonded_sub"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.test_stereo_pair_voice_bonded_sub">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s2">&quot;generate_voice_pairs&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_stereo_pair_voice_bonded_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test the case for a pair of stereo bonded players + sub</span>
<span class="sd">        :param left: left zone player</span>
<span class="sd">        :type left: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param right: right zone player</span>
<span class="sd">        :type right: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sub</span><span class="p">()</span>
        <span class="p">[</span><span class="n">left</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">diagc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">[</span><span class="n">diagc</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">diagc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_watch_for_zone_channel_count_change</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">left</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">add_stereo_bonded_zone_sub_to_this_device</span><span class="p">(</span>
            <span class="n">right</span><span class="p">,</span> <span class="n">sub</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_zone_channel_count_change</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_verifications</span><span class="p">([</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">sub</span><span class="p">])</span></div>

    <span class="c1"># 5.1 config =&gt; 6 elements</span>
<div class="viewcode-block" id="DuckingVolumeLevelsTest.test_ht_voice_51"><a class="viewcode-back" href="../../../voice.ducking.html#voice.ducking.ducking_volume_levels.DuckingVolumeLevelsTest.test_ht_voice_51">[docs]</a>    <span class="nd">@combinatorial</span><span class="p">(</span><span class="s2">&quot;generate_ht_master_satellite_with_voice&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_ht_voice_51</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test the case for a home theater configuration of players</span>
<span class="sd">        :param master: ht master zone player</span>
<span class="sd">        :type master: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param left: left zone player</span>
<span class="sd">        :type left: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param right: right zone player</span>
<span class="sd">        :type right: :obj`sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">[</span><span class="n">master</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">diagc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">[</span><span class="n">diagc</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">diagc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_watch_for_zone_channel_count_change</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sub</span><span class="p">()</span>
        <span class="n">master</span><span class="o">.</span><span class="n">get_bonded_zones</span><span class="p">()</span>
        <span class="n">master</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">create_51_config</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_zone_channel_count_change</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_verifications</span><span class="p">([</span><span class="n">master</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">sub</span><span class="p">])</span></div></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">WorkflowTestSuite</span><span class="p">(</span><span class="n">DuckingVolumeLevelsTest</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">suite</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">ConditionalUpgradeTestFixture</span><span class="p">(),</span> <span class="n">DuckingVolumeLevelsTest</span><span class="p">()])</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>