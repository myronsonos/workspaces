
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>networking.ht_proxy.test_dhcp &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for networking.ht_proxy.test_dhcp</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">getenv</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="k">import</span> <span class="n">copyfile</span>

<span class="kn">import</span> <span class="nn">pyshark</span>

<span class="kn">from</span> <span class="nn">common.networking.packet_capture</span> <span class="k">import</span> <span class="n">PacketCaptureMixin</span>
<span class="kn">from</span> <span class="nn">linux.cli.base</span> <span class="k">import</span> <span class="n">CliCommand</span>
<span class="kn">from</span> <span class="nn">networking.ht_proxy.proxy</span> <span class="k">import</span> <span class="n">ProxyBaseFixture</span>
<span class="kn">from</span> <span class="nn">sleep</span> <span class="k">import</span> <span class="n">guaranteed_sleep</span>
<span class="kn">from</span> <span class="nn">sonos.log_inspector.netstartd</span> <span class="k">import</span> <span class="p">(</span><span class="n">NetstartdLogInspector</span><span class="p">,</span>
                                           <span class="n">NetManagerEvent</span><span class="p">,</span> <span class="n">NetManagerState</span><span class="p">,</span>
                                           <span class="n">NetManagerMode</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">sonos.simple_upgrade</span> <span class="k">import</span> <span class="n">ConditionalUpgradeTestFixture</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.suite</span> <span class="k">import</span> <span class="n">WorkflowTestSuite</span>


<span class="c1"># Network protocol types</span>
<span class="n">DHCP_BC_FLAG</span> <span class="o">=</span> <span class="s2">&quot;32768&quot;</span>
<span class="n">ETH_PROTO_IP</span> <span class="o">=</span> <span class="s2">&quot;2048&quot;</span>
<span class="n">IP_PROTO_TCP</span> <span class="o">=</span> <span class="s2">&quot;6&quot;</span>
<span class="n">IP_PROTO_UDP</span> <span class="o">=</span> <span class="s2">&quot;17&quot;</span>
<span class="n">DHCP_DISCOVER</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DHCP_OFFER</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">DHCP_REQUEST</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">DHCP_ACK</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">DHCP_FULLSET</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">FILE_TRANSFER_PORT</span> <span class="o">=</span> <span class="mi">60000</span>
<span class="n">PATH_ON_RUNNER</span> <span class="o">=</span> <span class="s2">&quot;/tmp/&quot;</span>
<span class="n">PATH_TO_STORE_FILE_ON_ZP</span> <span class="o">=</span> <span class="s2">&quot;/tmp/&quot;</span>
<span class="n">UTILITIES_PATH_ON_ZP</span> <span class="o">=</span> <span class="s2">&quot;/jffs/&quot;</span>
<span class="n">CAPTURE_FILE_NAME_ON_ZP</span> <span class="o">=</span> <span class="s2">&quot;capture.pcap&quot;</span>
<span class="n">POPEN_WAIT_TIMEOUT</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">AVERAGE_PACKET_SIZE</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">DHCP_LEASE_DURATION</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">DHCP_RENEW_CHECK_INTERVAL</span> <span class="o">=</span> <span class="n">DHCP_LEASE_DURATION</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">10</span>
<span class="n">DHCP_FILTER</span> <span class="o">=</span> <span class="s2">&quot;udp and src port 67 or 68&quot;</span>

<span class="n">ACCEPTABLE_SAT_BOOT_UP_INTERVAL</span> <span class="o">=</span> <span class="mi">180</span> <span class="c1"># seconds</span>
<span class="n">ACCEPTABLE_SAT_NM_TRANSITION_INTERVAL</span> <span class="o">=</span> <span class="mi">60</span> <span class="c1"># seconds</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ProxyDHCPTestFixture:</span>
<span class="sd">The class to test DHCP related functionality of station mode home theater.</span>
<span class="sd">test_proxy_dhcp_broadcast_flag: Test whether DHCP discovers/request sent by</span>
<span class="sd">satellites have broadcast flag set.</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ProxyDHCPTestFixture"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture">[docs]</a><span class="k">class</span> <span class="nc">ProxyDHCPTestFixture</span><span class="p">(</span><span class="n">ProxyBaseFixture</span><span class="p">,</span> <span class="n">PacketCaptureMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test whether DHCP discovers/request sent by satellites have broadcast</span>
<span class="sd">    flag set and whether satellites can finish complete DHCP transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;HT_PROXY&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_get_network_pool_for_ht</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">managed_switch</span><span class="o">.</span><span class="n">get_dhcp_network_pools</span><span class="p">()</span>
        <span class="n">zone_ip_segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_mstr</span><span class="o">.</span><span class="n">ip</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ht_mstr</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span>
        <span class="n">zone_pool</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">pools</span>
            <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">address_range</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">zone_ip_segment</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testbed_network_pool</span> <span class="o">=</span> <span class="n">zone_pool</span> <span class="ow">and</span> <span class="n">zone_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyIsNotNoneOrStop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testbed_network_pool</span><span class="p">,</span>
            <span class="s2">&quot;Found a valid dhcp network pool on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">managed_switch</span><span class="p">))</span>

<div class="viewcode-block" id="ProxyDHCPTestFixture.setUpFixture"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProxyDHCPTestFixture</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">managed_switch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_mstr</span><span class="o">.</span><span class="n">wire</span><span class="o">.</span><span class="n">managed_switch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_network_pool_for_ht</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.tearDownFixture"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">ProxyDHCPTestFixture</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Try to recover DHCP lease duration settings</span>
            <span class="n">lease</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">recover_retries</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">expected_d</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">expected_h</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">expected_m</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">while</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;managed_switch&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">recover_retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">managed_switch</span><span class="o">.</span><span class="n">set_dhcp_lease_duration</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">testbed_network_pool</span><span class="p">,</span>
                    <span class="n">expected_d</span><span class="p">,</span>
                    <span class="n">expected_h</span><span class="p">,</span>
                    <span class="n">expected_m</span><span class="p">)</span>

                <span class="n">lease</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">managed_switch</span><span class="o">.</span><span class="n">get_dhcp_lease_duration</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">testbed_network_pool</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span> <span class="n">lease</span> <span class="ow">and</span>
                     <span class="n">lease</span><span class="o">.</span><span class="n">day</span>    <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_d</span><span class="p">)</span> <span class="ow">and</span>
                     <span class="n">lease</span><span class="o">.</span><span class="n">hour</span>   <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_h</span><span class="p">)</span> <span class="ow">and</span>
                     <span class="n">lease</span><span class="o">.</span><span class="n">minute</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_m</span><span class="p">)):</span>
                    <span class="k">break</span>

                <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">excluded_ip</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">managed_switch</span><span class="o">.</span><span class="n">dhcp_server_no_exclude_address</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>

                <span class="n">recover_tries</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="c1"># Remove packet capture artifacts generated during test.</span>
            <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_sats</span><span class="p">:</span>
                <span class="n">CliCommand</span><span class="p">(</span><span class="s2">&quot;rm -f /tmp/</span><span class="si">{}</span><span class="s2">.pcap&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">))</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.test_proxy_dhcp_broadcast_flag"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.test_proxy_dhcp_broadcast_flag">[docs]</a>    <span class="k">def</span> <span class="nf">test_proxy_dhcp_broadcast_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_station_mode_ht</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_uptime_before_reboot</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reboot_all_satellites</span><span class="p">()</span>
        <span class="n">capture</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_a_cap</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_capture_files_for_upload</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_CAPTURE_FILES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">INTERFACE_TO_TESTBED</span><span class="p">],</span>
            <span class="s2">&quot;proxy_dhcp_broadcast_flag&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_sats_in_hh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_topology</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_dhcp_broadcast_flag</span><span class="p">(</span><span class="n">capture</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_topology</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Need to wait for a while to ensure network to be stable to avoid test</span>
<span class="sd">        runner losing connection to testbed when fixture gets cleaned up.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">is_layer3_connected</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">devices_to_test</span><span class="p">]),</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">is_telnet_cli_available</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">devices_to_test</span><span class="p">]),</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices_to_test</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">subscribe_all_services</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.test_proxy_dhcp_renew_on_satellites"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.test_proxy_dhcp_renew_on_satellites">[docs]</a>    <span class="k">def</span> <span class="nf">test_proxy_dhcp_renew_on_satellites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function test DHCP renew on satellites by:</span>
<span class="sd">        Change DHCP server lease duration to 5 minutes. Then reboot satellites</span>
<span class="sd">        So when satellites come back, they will get DHCP offer with new lease</span>
<span class="sd">        duration and will send DHCP renew every 2 and half minutes.</span>
<span class="sd">        According to packet captures done on ZPs, check whether DHCP renew</span>
<span class="sd">        transactions were successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">captures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_station_mode_ht</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices_to_test</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_among_proxies</span><span class="p">(</span><span class="n">zp</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">managed_switch</span><span class="o">.</span><span class="n">set_dhcp_lease_duration</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">testbed_network_pool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DHCP_LEASE_DURATION</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_uptime_before_reboot</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reboot_all_satellites</span><span class="p">(</span><span class="n">wait_for_network</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">is_telnet_cli_available</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">]),</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_sats_settle_on_interface</span><span class="p">(</span><span class="s2">&quot;ath1&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_sats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_packet_capture_on_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;br0&quot;</span><span class="p">,</span> <span class="n">DHCP_FILTER</span><span class="p">)</span>
        <span class="n">guaranteed_sleep</span><span class="p">(</span><span class="n">DHCP_RENEW_CHECK_INTERVAL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_sats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_packet_capture_on_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_packet_capture_from_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_sats</span><span class="p">:</span>
            <span class="n">cap</span> <span class="o">=</span> <span class="n">pyshark</span><span class="o">.</span><span class="n">FileCapture</span><span class="p">(</span><span class="s2">&quot;/tmp/</span><span class="si">{}</span><span class="s2">.pcap&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">))</span>
            <span class="n">cap</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">cap</span><span class="o">.</span><span class="n">load_packets</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">captures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cap</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_capture_files_for_upload</span><span class="p">(</span>
                <span class="s2">&quot;/tmp/</span><span class="si">{}</span><span class="s2">.pcap&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">),</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;proxy_dhcp_renew_on_satellites&quot;</span><span class="p">,</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">captures</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_proxy_dhcp_renew_capture_on_satellites</span><span class="p">(</span><span class="n">captures</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">ht_sats</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_proxy_dhcp_renew_log_on_satellite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ht_sats</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">managed_switch</span><span class="o">.</span><span class="n">set_dhcp_lease_duration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testbed_network_pool</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_station_mode_ht</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.test_proxy_dhcp_renew_on_primary_orignal_ip"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.test_proxy_dhcp_renew_on_primary_orignal_ip">[docs]</a>    <span class="k">def</span> <span class="nf">test_proxy_dhcp_renew_on_primary_orignal_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_station_mode_ht</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_proxy_dhcp_renew_on_primary</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_station_mode_ht</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.test_proxy_dhcp_renew_on_primary_new_ip"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.test_proxy_dhcp_renew_on_primary_new_ip">[docs]</a>    <span class="k">def</span> <span class="nf">test_proxy_dhcp_renew_on_primary_new_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_station_mode_ht</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_proxy_dhcp_renew_on_primary</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_station_mode_ht</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.test_proxy_fast_boot_to_ip"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.test_proxy_fast_boot_to_ip">[docs]</a>    <span class="k">def</span> <span class="nf">test_proxy_fast_boot_to_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test whether satellites can quickly come up after reboot</span>
<span class="sd">        and whether satellites come up with expected behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Format of expected_sequence is (state, event, mode)</span>
        <span class="n">expected_sequence</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">NetManagerMode</span><span class="o">.</span><span class="n">DEAUTH</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NetManagerState</span><span class="o">.</span><span class="n">INIT</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NetManagerState</span><span class="o">.</span><span class="n">INIT</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">NetManagerEvent</span><span class="o">.</span><span class="n">RECONFIGURE</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">NetManagerMode</span><span class="o">.</span><span class="n">STATION</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NetManagerState</span><span class="o">.</span><span class="n">STATION</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NetManagerState</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">NetManagerEvent</span><span class="o">.</span><span class="n">PRIMARY_FOUND</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">NetManagerMode</span><span class="o">.</span><span class="n">SONOSNET</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NetManagerState</span><span class="o">.</span><span class="n">SONOSNET</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NetManagerState</span><span class="o">.</span><span class="n">SONOSNET</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">NetManagerEvent</span><span class="o">.</span><span class="n">PRIMARY_FOUND</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NetManagerState</span><span class="o">.</span><span class="n">SONOSNET</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">NetManagerEvent</span><span class="o">.</span><span class="n">IP</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NetManagerState</span><span class="o">.</span><span class="n">SONOSNET</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_sats_settle_on_interface</span><span class="p">(</span><span class="s2">&quot;ath1&quot;</span><span class="p">)</span>
        <span class="n">local_before_reboot</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reboot_all_satellites</span><span class="p">(</span><span class="n">wait_for_network</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_sats_settle_on_interface</span><span class="p">(</span><span class="s2">&quot;ath1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyLessOrFailCase</span><span class="p">(</span>
            <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">local_before_reboot</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
            <span class="n">ACCEPTABLE_SAT_BOOT_UP_INTERVAL</span><span class="p">,</span>
            <span class="s2">&quot;Verifying satellites rebooted and came up quickly.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_sats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_proxy_fast_boot_to_ip_on_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">expected_sequence</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.verify_proxy_dhcp_renew_on_primary"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.verify_proxy_dhcp_renew_on_primary">[docs]</a>    <span class="k">def</span> <span class="nf">verify_proxy_dhcp_renew_on_primary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_new_ip</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function test DHCP renew on primary, to make sure when DHCP renew</span>
<span class="sd">        happens on primary, satellites won&#39;t be impacted. For example,</span>
<span class="sd">        renew on primary should not trigger renew on satellites, and IP address</span>
<span class="sd">        of satellites should not change.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ip_to_exclude</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dhcp_log_stamps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dhcp_log_stamps_to_check</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary to record which satellites is good.</span>
<span class="sd">        Key will be MAC of ath1 in integer format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">satellites_to_check</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_sats</span><span class="p">:</span>
            <span class="n">satellites_to_check</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mac_to_int</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kick_dhcp_renew_on_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Record log stamp on satellites, so we can check whether there is</span>
<span class="sd">            new DHCP renew triggered on satellites later.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">dhcp_log_stamps</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span> <span class="o">=</span> <span class="n">stamp</span>
        <span class="c1"># Get brctl entries from primary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_brctl_for_zp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ht_mstr</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Because primary may be doing idle scanning when we are trying to</span>
<span class="sd">        inspect brctl entries. Wait satellites appear on ath1 for 2 minutes</span>
<span class="sd">        which should be more than enough.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">all</span><span class="p">([(</span><span class="n">entry</span><span class="o">.</span><span class="n">dev</span> <span class="o">==</span> <span class="s2">&quot;ath1&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">brctls</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ht_mstr</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span><span class="o">.</span><span class="n">showports</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mac_to_int</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">mac</span><span class="p">)</span> <span class="ow">in</span> <span class="n">satellites_to_check</span><span class="p">]),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
        <span class="n">original_entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">brctls</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ht_mstr</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span><span class="o">.</span><span class="n">showports</span><span class="p">()</span>
        <span class="c1"># Decide whether get a new IP for playbar</span>
        <span class="k">if</span> <span class="n">get_new_ip</span><span class="p">:</span>
            <span class="n">ip_to_exclude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_mstr</span><span class="o">.</span><span class="n">ip</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">excluded_ip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip_to_exclude</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">managed_switch</span><span class="o">.</span><span class="n">dhcp_server_exclude_address</span><span class="p">(</span>
                <span class="n">ip_to_exclude</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kick DHCP renew on primary</span>
<span class="sd">        For test cases where primary gonna have new IP and case where primary</span>
<span class="sd">        doesn&#39;t, kick_dhcp_renew_on_zp(...) takes different pathes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kick_dhcp_renew_on_zp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ht_mstr</span><span class="p">,</span> <span class="n">get_new_ip</span><span class="p">)</span>
        <span class="n">entries_to_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">brctls</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ht_mstr</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span><span class="o">.</span><span class="n">showports</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_sats</span><span class="p">:</span>
            <span class="n">stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_dhcp_log_time_stamp</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
            <span class="n">dhcp_log_stamps_to_check</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">]</span> <span class="o">=</span> <span class="n">stamp</span>
        <span class="c1"># Whether new DHCP renews happened on satellites by checking timestamp</span>
        <span class="n">dump_logs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_sats</span><span class="p">:</span>
            <span class="n">sat_passed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span>
                <span class="n">dhcp_log_stamps</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">],</span>
                <span class="n">dhcp_log_stamps_to_check</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">],</span>
                <span class="s2">&quot;Verifying timestamps matches on zp </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sat_passed</span><span class="p">:</span>
                <span class="n">dump_logs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">dump_logs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices_to_test</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dump_logs_from_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether brctl entries matches:</span>
<span class="sd">        First layer of loop is looping through brctl entries we got before</span>
<span class="sd">        renew kicked on primary. At each entry, loop through &#39;entries_to_check&#39;</span>
<span class="sd">        which we got after renew on primary.</span>
<span class="sd">        During the second loop, if matching of MAC is found, verify that</span>
<span class="sd">        satellite is on ath1 and &#39;satip&#39; did not change after renew, then set</span>
<span class="sd">        &#39;found_match&#39; flag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">original_entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mac_to_int</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">mac</span><span class="p">)</span> <span class="ow">in</span> <span class="n">satellites_to_check</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">dev</span> <span class="o">==</span> <span class="s2">&quot;ath1&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;Verifying satellite is on ath1 before&quot;</span>
                    <span class="s2">&quot;renew. Entry: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verifyIsNotNoneOrFailCase</span><span class="p">(</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">satip</span><span class="p">,</span> <span class="s2">&quot;Verifying Satellite IP from brctl entry &quot;</span>
                    <span class="s2">&quot;is not None. Entry: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
                <span class="n">found_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">to_check</span> <span class="ow">in</span> <span class="n">entries_to_check</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mac_to_int</span><span class="p">(</span><span class="n">to_check</span><span class="o">.</span><span class="n">mac</span><span class="p">)</span> <span class="ow">in</span> <span class="n">satellites_to_check</span> <span class="ow">and</span>
                            <span class="n">entry</span><span class="o">.</span><span class="n">mac</span> <span class="o">==</span> <span class="n">to_check</span><span class="o">.</span><span class="n">mac</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">to_check</span><span class="o">.</span><span class="n">dev</span> <span class="o">==</span> <span class="s2">&quot;ath1&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;Verifying satellite is on ath1 after &quot;</span>
                            <span class="s2">&quot;renew. Entry: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to_check</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span>
                            <span class="n">entry</span><span class="o">.</span><span class="n">satip</span><span class="p">,</span> <span class="n">to_check</span><span class="o">.</span><span class="n">satip</span><span class="p">,</span>
                            <span class="s2">&quot;Verifying satip matches before and after&quot;</span>
                            <span class="s2">&quot;renew. Entries: </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span>
                                                               <span class="n">to_check</span><span class="p">))</span>
                        <span class="n">found_match</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="n">satellites_to_check</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mac_to_int</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">mac</span><span class="p">)]</span> <span class="o">=</span> <span class="n">found_match</span>
                <span class="n">found_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found_match</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Satellite is present in original brctl, &quot;</span>
                                      <span class="s2">&quot;but not in entries after primary renew &quot;</span>
                                      <span class="s2">&quot;DHCP. </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">original_entries</span><span class="p">,</span>
                                                           <span class="n">entries_to_check</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        After loop above finishes, &#39;found_match&#39; will be verified for each</span>
<span class="sd">        satellites, so we know whether any one is missing after rewnew.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sat</span> <span class="ow">in</span> <span class="n">satellites_to_check</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span>
                <span class="n">satellites_to_check</span><span class="p">[</span><span class="n">sat</span><span class="p">],</span> <span class="s2">&quot;Verifying brctl entries match before &quot;</span>
                <span class="s2">&quot;and after DHCP renew on primary. Sat </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">sat</span><span class="p">)))</span></div>

    <span class="k">def</span> <span class="nf">_show_log_from_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">log_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print log with given log path.</span>
<span class="sd">        :param zp: The ZP where log will be retrieved from</span>
<span class="sd">        :type zp: :obj:`SonosZoneComponent`</span>
<span class="sd">        :param log_path: Path of log to be retrieved</span>
<span class="sd">        :type log_path: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;dmesg&quot;</span> <span class="k">if</span> <span class="n">log_path</span> <span class="o">==</span> <span class="s2">&quot;dmesg&quot;</span> <span class="k">else</span> <span class="s2">&quot;cat </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
            <span class="n">log_data</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Printing </span><span class="si">{}</span><span class="s2"> from ZP </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">log_path</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">log_data</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to get log </span><span class="si">{}</span><span class="s2"> from ZP </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">log_path</span><span class="p">,</span> <span class="n">zp</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_dump_logs_from_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump logs in anacapa.trace, udhcpc.log, netstartd.log and dmesg</span>
<span class="sd">        :param zp: The ZP where logs will be retrieved from</span>
<span class="sd">        :type zp: :obj:`SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_log_from_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;/opt/log/anacapa.trace&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_log_from_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;/opt/log/udhcpc.log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_log_from_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;/opt/log/netstartd.log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_log_from_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="s2">&quot;dmesg&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_a_cap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">cap_filter</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">capture</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_capture</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">INTERFACE_TO_TESTBED</span><span class="p">,</span>
                                        <span class="n">bpf_filter</span><span class="o">=</span><span class="n">cap_filter</span><span class="p">,</span>
                                        <span class="n">timeout</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">capture</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Verifying number&quot;</span>
                                      <span class="s2">&quot;of packets got captured is not ZERO&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">capture</span>

    <span class="k">def</span> <span class="nf">_bootp_match_client_addr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="n">addr_from_zp</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">addr_from_pkt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^a-f0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pkt</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">hw_mac_addr</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">addr_from_zp</span> <span class="o">==</span> <span class="n">addr_from_pkt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_dhcp_broadcast_flag_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If it is a request/discover we need to check the flag</span>
<span class="sd">        whenever we see a request from that client without bc flag set,</span>
<span class="sd">        we need to return false and the test fail</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pkt</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="n">DHCP_BC_FLAG</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_dhcp_broadcast_flag_rsp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If it is a respond, we need to make sure the packet comes back</span>
<span class="sd">        as broadcast. In fact, since we can see that packet, it should be</span>
<span class="sd">        broadcast already. Just double check here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_l2_broadcast</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_with_expected_dhcp_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_type</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_type</span> <span class="o">==</span> <span class="n">expected_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_type</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_get_dhcp_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="n">option_dhcp</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">option_dhcp</span>
        <span class="k">if</span> <span class="n">option_dhcp</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DHCP_DISCOVER</span>
        <span class="k">if</span> <span class="n">option_dhcp</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DHCP_OFFER</span>
        <span class="k">if</span> <span class="n">option_dhcp</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DHCP_REQUEST</span>
        <span class="k">if</span> <span class="n">option_dhcp</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DHCP_ACK</span>

    <span class="k">def</span> <span class="nf">_test_runner_start_receiving_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_file_name</span><span class="p">,</span> <span class="n">cap_file</span><span class="p">):</span>
        <span class="n">child_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;netcat&quot;</span><span class="p">,</span> <span class="s2">&quot;-l&quot;</span><span class="p">,</span>
                                          <span class="nb">str</span><span class="p">(</span><span class="n">FILE_TRANSFER_PORT</span><span class="p">)],</span>
                                         <span class="n">stdout</span><span class="o">=</span><span class="n">cap_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">child_process</span>

    <span class="k">def</span> <span class="nf">_zp_start_sending_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;busybox nc </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> &lt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_ip</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">FILE_TRANSFER_PORT</span><span class="p">),</span> <span class="n">PATH_TO_STORE_FILE_ON_ZP</span> <span class="o">+</span>
            <span class="n">CAPTURE_FILE_NAME_ON_ZP</span><span class="p">),</span> <span class="n">wait_for_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_wait_for_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Found error for process </span><span class="si">{}</span><span class="s2">, error </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">process</span><span class="p">,</span> <span class="n">ret</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_copy_file_from_zp_to_test_runner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_file_name</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">delete_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">cap_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest_file_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">receiving_file_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_runner_start_receiving_file</span><span class="p">(</span>
                                     <span class="n">dest_file_name</span><span class="p">,</span> <span class="n">cap_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zp_start_sending_file</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_process</span><span class="p">(</span><span class="n">receiving_file_process</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If ret is true, caller knows that dest_file_path is ready.</span>
<span class="sd">        Otherwise, that file is not ready</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cap_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_get_available_memory_size_on_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In returned value, 1 means 1kB available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">int_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">command_line</span> <span class="o">=</span> <span class="s2">&quot;free|grep &#39;Mem&#39;&quot;</span>
        <span class="nb">str</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">command_line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">split_str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">split_str</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">int_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_array</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">int_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_decide_number_of_packets_to_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="n">memory_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_available_memory_size_on_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">memory_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">AVERAGE_PACKET_SIZE</span>
        <span class="k">return</span> <span class="n">count</span>

    <span class="k">def</span> <span class="nf">_prepare_capture_files_for_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If environment variables JOB_NAME, BUILD_NUMBER and version</span>
<span class="sd">        is known, move packet capture files to current directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;JOB_NAME&quot;</span><span class="p">),</span> <span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BUILD_NUMBER&quot;</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">get_test_version</span><span class="p">()]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping preparing of capture file: </span><span class="si">{}</span><span class="s2"> &quot;</span>
                             <span class="s2">&quot;for job name: </span><span class="si">{}</span><span class="s2"> build number: </span><span class="si">{}</span><span class="s2"> &quot;</span>
                             <span class="s2">&quot;version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;JOB_NAME&quot;</span><span class="p">),</span>
                             <span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BUILD_NUMBER&quot;</span><span class="p">),</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">get_test_version</span><span class="p">()))</span>
            <span class="k">return</span>
        <span class="n">new_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.pcap&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">get_test_version</span><span class="p">(),</span> <span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;JOB_NAME&quot;</span><span class="p">),</span>
            <span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BUILD_NUMBER&quot;</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">copyfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error happened when copy </span><span class="si">{}</span><span class="s2"> to &quot;</span>
                              <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">. Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_print_uptime_before_reboot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Begin to reboot all satellites at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                         <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_sats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ZP </span><span class="si">{}</span><span class="s2"> has uptime </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                             <span class="n">zp</span><span class="p">,</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_uptime</span><span class="p">()))</span>

<div class="viewcode-block" id="ProxyDHCPTestFixture.kick_dhcp_renew_on_zp"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.kick_dhcp_renew_on_zp">[docs]</a>    <span class="k">def</span> <span class="nf">kick_dhcp_renew_on_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">expect_new_ip</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kick DHCP renew by USR1 signal on ZP.</span>
<span class="sd">        :return: timestamp of DHCP renew log triggered by this function.</span>
<span class="sd">        :rtype: :obj:`datetime`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_time_before_kick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_dhcp_log_time_stamp</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">log_time</span> <span class="o">=</span> <span class="n">log_time_before_kick</span>
        <span class="k">if</span> <span class="n">expect_new_ip</span><span class="p">:</span>
            <span class="n">original_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_mstr</span><span class="o">.</span><span class="n">ip</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;killall -USR1 udhcpc&quot;</span><span class="p">,</span>
                       <span class="n">wait_for_response</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">expect_new_ip</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">expect_new_ip</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Just check whether satellites can be reached by ping. At this</span>
<span class="sd">            moment test runner may have not realize primary&#39;s new IP.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">is_layer3_connected</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
                                         <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ht_sats</span><span class="p">]),</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;From test mstr id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ht_mstr</span><span class="p">)))</span>
            <span class="n">zp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">original_ip</span><span class="p">,</span> <span class="n">wait_for_new</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
        <span class="c1"># Sometimes DHCP logs comes later than expected, so have to wait for it.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expect_new_ip</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">log_time_before_kick</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_dhcp_log_time_stamp</span><span class="p">(</span><span class="n">zp</span><span class="p">)),</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_dhcp_log_time_stamp</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_do_get_last_dhcp_log_time_stamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do the actual work of getting timestamp from given DHCP leasing log.</span>
<span class="sd">        :return: timestamp of last DHCP leasing log.</span>
<span class="sd">        :rtype: :obj:`datetime`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_time_str</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span><span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span>
        <span class="n">log_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">log_time_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATETIME_FORMAT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">log_time</span>

<div class="viewcode-block" id="ProxyDHCPTestFixture.get_last_dhcp_log_time_stamp"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.get_last_dhcp_log_time_stamp">[docs]</a>    <span class="k">def</span> <span class="nf">get_last_dhcp_log_time_stamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function goes to ZP to get last DHCP leasing log, and then</span>
<span class="sd">        return its timestamp.</span>
<span class="sd">        :return: timestamp of last DHCP leasing log.</span>
<span class="sd">        :rtype: :obj:`datetime`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_proxy_dhcp_log_is_present_on_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_get_last_dhcp_log_time_stamp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.verify_proxy_dhcp_log_is_present_on_zp"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.verify_proxy_dhcp_log_is_present_on_zp">[docs]</a>    <span class="k">def</span> <span class="nf">verify_proxy_dhcp_log_is_present_on_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">retry_times</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that there is DHCP leasing log present on ZP, and return</span>
<span class="sd">        that log</span>
<span class="sd">        :return: last DHCP leasing log.</span>
<span class="sd">        :rtype: :obj:`list`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">retry_times</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">raw_log</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;cat /opt/log/udhcpc.log|grep -A 1 &quot;</span>
                                     <span class="s2">&quot;&#39;obtained, lease time&#39;|grep -B 1 &quot;</span>
                                     <span class="s2">&quot;&#39;renew parameters\|bound parameters&#39;|&quot;</span>
                                     <span class="s2">&quot;tail -n 2&quot;</span><span class="p">,</span>
                                     <span class="n">retry</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">raw_log</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;udhcpc:&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DHCP renew log empty&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrStop</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Verifying DHCP log line number. Lines: </span><span class="si">{}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;log: </span><span class="si">{}</span><span class="s2">, zp: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">raw_log</span><span class="p">,</span> <span class="n">zp</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.verify_proxy_dhcp_renew_log_on_satellite"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.verify_proxy_dhcp_renew_log_on_satellite">[docs]</a>    <span class="k">def</span> <span class="nf">verify_proxy_dhcp_renew_log_on_satellite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">retry_times</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function checks DHCP log for DHCP renew.</span>
<span class="sd">        For successful DHCP renew, there should be valid logs for udhcpc.</span>
<span class="sd">        IP address in lease should match original IP. And DHCP server&#39;s IP</span>
<span class="sd">        is expected to be the original one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Current time </span><span class="si">{}</span><span class="s2">, ZP </span><span class="si">{}</span><span class="s2"> uptime </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">zp</span><span class="p">,</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_uptime</span><span class="p">()))</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_proxy_dhcp_log_is_present_on_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">retry_times</span><span class="p">)</span>
        <span class="n">tmp_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_as_str_from_zp</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">tmp_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATETIME_FORMAT</span><span class="p">)</span>
        <span class="n">log_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_get_last_dhcp_log_time_stamp</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyLessEqualOrFailCase</span><span class="p">(</span>
            <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">log_time</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span> <span class="n">DHCP_RENEW_CHECK_INTERVAL</span><span class="p">,</span>
            <span class="s2">&quot;Verifying Log is not outdated. zp: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="c1"># Check whether the returned IP address matches original one</span>
        <span class="n">offset_beg</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Lease of &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;Lease of &quot;</span><span class="p">)</span>
        <span class="n">offset_end</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">offset_beg</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;Lease of &quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span>
            <span class="p">(</span><span class="n">offset_beg</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">offset_end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Verifying leased IP &quot;</span>
            <span class="s2">&quot;is included in DHCP log. zp: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="n">leased_ip</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">offset_beg</span><span class="p">:</span><span class="n">offset_end</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">leased_ip</span><span class="p">,</span> <span class="s2">&quot;Verifying newly leased IP matches orginal &quot;</span>
            <span class="s2">&quot;IP. zp: </span><span class="si">{}</span><span class="s2"> lease: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">leased_ip</span><span class="p">))</span>
        <span class="c1"># Check whether DHCP reply came from the right DHCP server</span>
        <span class="n">offset_beg</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;serverid=&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;serverid=&quot;</span><span class="p">)</span>
        <span class="n">offset_end</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">offset_beg</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;serverid=&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span>
            <span class="p">(</span><span class="n">offset_beg</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">offset_end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Verifying DHCP server IP &quot;</span>
            <span class="s2">&quot;is included in DHCP log. zp: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="n">server_ip</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">offset_beg</span><span class="p">:</span><span class="n">offset_end</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">managed_switch</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">,</span>
            <span class="s2">&quot;Verifying DHCP server IP matches orginal one. zp: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span>
                <span class="n">leased_ip</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_verify_dhcp_broadcast_flag_for_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkts</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="c1"># expected_type is for each transaction</span>
        <span class="n">expected_type</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">current_record</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">finished_transaction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dhcp_server_mac</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">managed_switch</span><span class="o">.</span><span class="n">get_system_information</span><span class="p">()</span><span class="o">.</span><span class="n">mac_address</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkts</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dhcp</span><span class="p">(</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bootp_match_client_addr</span><span class="p">(</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">zp</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_record</span><span class="p">:</span>
                    <span class="n">current_record</span><span class="p">[</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">expected_type</span><span class="p">[</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">DHCP_DISCOVER</span>
                <span class="n">dhcp_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dhcp_type</span><span class="p">(</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">dhcp_type</span> <span class="o">==</span> <span class="n">DHCP_DISCOVER</span> <span class="ow">or</span> <span class="n">dhcp_type</span> <span class="o">==</span> <span class="n">DHCP_REQUEST</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dhcp_broadcast_flag_req</span><span class="p">(</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dhcp_type</span> <span class="o">==</span> <span class="n">DHCP_OFFER</span> <span class="ow">or</span> <span class="n">dhcp_type</span> <span class="o">==</span> <span class="n">DHCP_ACK</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">dhcp_server_mac</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                        <span class="k">continue</span>
                <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_with_expected_dhcp_type</span><span class="p">(</span>
                    <span class="n">dhcp_type</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">[</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
                    <span class="n">current_record</span><span class="p">[</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">|=</span> <span class="n">update</span>
                    <span class="n">expected_type</span><span class="p">[</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">current_record</span><span class="p">[</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span>
                        <span class="n">finished_transaction</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">finished_transaction</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Found error in DHCP: </span><span class="si">{}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;record </span><span class="si">{}</span><span class="s2"> expecting </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">,</span>
                                                 <span class="n">current_record</span><span class="p">,</span>
                                                 <span class="n">expected_type</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Uptime on failed ZP </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">, running &quot;</span>
                              <span class="s2">&quot;mode </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="n">zp</span><span class="p">,</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_uptime</span><span class="p">(),</span>
                              <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_ath_status</span><span class="p">()</span><span class="o">.</span><span class="n">mode</span><span class="p">))</span>
            <span class="c1"># Print out log of udhcpc and netstartd on failure</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;cat /opt/log/udhcpc.log&quot;</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;cat /opt/log/netstartd.log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="n">finished_transaction</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Verifying there was DHCP &quot;</span>
                                          <span class="s2">&quot;transcation finished for &quot;</span>
                                          <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">))</span>

<div class="viewcode-block" id="ProxyDHCPTestFixture.get_packet_capture_from_zp"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.get_packet_capture_from_zp">[docs]</a>    <span class="k">def</span> <span class="nf">get_packet_capture_from_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy packet capture from ZP, which is located in</span>
<span class="sd">        &quot;/tmp/SERIAL_NUMBER.pcap&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path_on_runner</span> <span class="o">=</span> <span class="n">PATH_ON_RUNNER</span> <span class="o">+</span> <span class="n">zp</span><span class="o">.</span><span class="n">serialNumber</span> <span class="o">+</span> <span class="s2">&quot;.pcap&quot;</span>
        <span class="n">path_on_zp</span> <span class="o">=</span> <span class="n">PATH_TO_STORE_FILE_ON_ZP</span> <span class="o">+</span> <span class="n">CAPTURE_FILE_NAME_ON_ZP</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_file_from_zp_to_test_runner</span><span class="p">((</span><span class="n">path_on_runner</span><span class="p">),</span> <span class="n">zp</span><span class="p">)</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;rm -f </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_on_zp</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.start_packet_capture_on_zp"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.start_packet_capture_on_zp">[docs]</a>    <span class="k">def</span> <span class="nf">start_packet_capture_on_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">interface_name</span><span class="p">,</span> <span class="n">cap_filter</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call tcpdump on ZP through cli.command. And tcpdump will be run in</span>
<span class="sd">        background, so that we can do other work or wait for certain time</span>
<span class="sd">        while tcpdump is running on ZP.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count_to_capture</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_decide_number_of_packets_to_capture</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="n">tcpdump_path</span> <span class="o">=</span> <span class="n">UTILITIES_PATH_ON_ZP</span> <span class="o">+</span> <span class="s2">&quot;tcpdump&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">PATH_TO_STORE_FILE_ON_ZP</span> <span class="o">+</span> <span class="n">CAPTURE_FILE_NAME_ON_ZP</span>
        <span class="n">command_line</span> <span class="o">=</span> <span class="n">tcpdump_path</span> <span class="o">+</span> <span class="s2">&quot; -i &quot;</span> <span class="o">+</span> <span class="n">interface_name</span> <span class="o">+</span> \
            <span class="s2">&quot; -c &quot;</span> <span class="o">+</span> <span class="n">count_to_capture</span> <span class="o">+</span> <span class="s2">&quot; -w &quot;</span> <span class="o">+</span> <span class="n">file_path</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> \
            <span class="n">cap_filter</span> <span class="o">+</span> <span class="s2">&quot; 2&gt;/dev/null &amp;&quot;</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">command_line</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.stop_packet_capture_on_zp"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.stop_packet_capture_on_zp">[docs]</a>    <span class="k">def</span> <span class="nf">stop_packet_capture_on_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kill running tcpdump on ZP.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command_line</span> <span class="o">=</span> <span class="s2">&quot;killall tcpdump&quot;</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">command_line</span><span class="p">,</span> <span class="n">wait_for_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.get_time_as_str_from_zp"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.get_time_as_str_from_zp">[docs]</a>    <span class="k">def</span> <span class="nf">get_time_as_str_from_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get local date from ZP, as string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.verify_dhcp_broadcast_flag"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.verify_dhcp_broadcast_flag">[docs]</a>    <span class="k">def</span> <span class="nf">verify_dhcp_broadcast_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkts</span><span class="p">,</span> <span class="n">ht_config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify DHCP broadcast flag was set for DHCP transactions</span>
<span class="sd">        in given packet capture.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">master_hhid</span> <span class="o">=</span> <span class="n">ht_config</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">hhid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Begin verifying DHCP broadcast flag &quot;</span>
                         <span class="s2">&quot;at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
        <span class="n">sats</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">ht_config</span> <span class="k">if</span> <span class="n">zp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ht_config</span><span class="o">.</span><span class="n">master</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">sat</span> <span class="ow">in</span> <span class="n">sats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dhcp_broadcast_flag_for_zp</span><span class="p">(</span><span class="n">pkts</span><span class="p">,</span> <span class="n">sat</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.verify_proxy_dhcp_renew_capture_on_satellites"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.verify_proxy_dhcp_renew_capture_on_satellites">[docs]</a>    <span class="k">def</span> <span class="nf">verify_proxy_dhcp_renew_capture_on_satellites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkts</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify there are successful DHCP renew transactions among give</span>
<span class="sd">        packet capture.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expected_type</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">current_record</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">finished_transaction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dhcp_server_mac</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">managed_switch</span><span class="o">.</span><span class="n">get_system_information</span><span class="p">()</span><span class="o">.</span><span class="n">mac_address</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkts</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dhcp</span><span class="p">(</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bootp_match_client_addr</span><span class="p">(</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">zp</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_record</span><span class="p">:</span>
                    <span class="n">current_record</span><span class="p">[</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">expected_type</span><span class="p">[</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">DHCP_REQUEST</span>
                <span class="n">dhcp_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dhcp_type</span><span class="p">(</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">dhcp_type</span> <span class="o">==</span> <span class="n">DHCP_OFFER</span> <span class="ow">or</span> <span class="n">dhcp_type</span> <span class="o">==</span> <span class="n">DHCP_ACK</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">dhcp_server_mac</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">continue</span>
                <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_with_expected_dhcp_type</span><span class="p">(</span>
                    <span class="n">dhcp_type</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">[</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
                    <span class="n">current_record</span><span class="p">[</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">|=</span> <span class="n">update</span>
                    <span class="n">expected_type</span><span class="p">[</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">current_record</span><span class="p">[</span><span class="n">pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bootp</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">DHCP_REQUEST</span> <span class="o">|</span> <span class="n">DHCP_ACK</span><span class="p">):</span>
                        <span class="n">finished_transaction</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="n">finished_transaction</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Verifying there was DHCP renew &quot;</span>
                                          <span class="s2">&quot;transaction finished for &quot;</span>
                                          <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span></div>

<div class="viewcode-block" id="ProxyDHCPTestFixture.verify_proxy_fast_boot_to_ip_on_zp"><a class="viewcode-back" href="../../../networking.ht_proxy.html#networking.ht_proxy.test_dhcp.ProxyDHCPTestFixture.verify_proxy_fast_boot_to_ip_on_zp">[docs]</a>    <span class="k">def</span> <span class="nf">verify_proxy_fast_boot_to_ip_on_zp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">expected_sequence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify whether given ZP&#39;s behavior matches what is expected</span>
<span class="sd">        through netstartd log.</span>
<span class="sd">        :param zp: Zoneplayer that is under test</span>
<span class="sd">        :type zp :class:~sonos.client.internal.SonosZoneComponent</span>
<span class="sd">        :param expected_sequence: Expected netstartd state/event/mode</span>
<span class="sd">        :type expected_sequence: :obj:`list` of (NetManagerState,</span>
<span class="sd">                                 NetManagerEvent, NetManagerMode)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_inspector</span> <span class="o">=</span> <span class="n">NetstartdLogInspector</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">log_inspector</span><span class="o">.</span><span class="n">clear_marker</span><span class="p">()</span>
        <span class="n">failed_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">step_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">expected_sequence</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">log_inspector</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="o">**</span><span class="n">entry</span><span class="p">):</span>
                <span class="n">failed_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_inspector</span><span class="o">.</span><span class="n">current_marker</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="n">step_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_steps</span><span class="p">),</span>
            <span class="s2">&quot;Verifying expected netmanager log sequence after &quot;</span>
            <span class="s2">&quot;satellite </span><span class="si">{}</span><span class="s2"> rebooted. Failed steps :</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span>
            <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">expected_sequence</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">failed_steps</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_steps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;netstartd log on </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="n">zp</span><span class="p">,</span> <span class="n">log_inspector</span><span class="o">.</span><span class="n">log</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyLessOrFailCase</span><span class="p">(</span>
                <span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
                <span class="n">ACCEPTABLE_SAT_NM_TRANSITION_INTERVAL</span><span class="p">,</span>
                <span class="s2">&quot;Verifying netmanager state transition finished quickly.&quot;</span><span class="p">)</span></div></div>


<span class="n">TEST_FIXTURES</span> <span class="o">=</span> <span class="p">[</span><span class="n">ConditionalUpgradeTestFixture</span><span class="p">,</span> <span class="n">ProxyDHCPTestFixture</span><span class="p">]</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">WorkflowTestSuite</span><span class="p">(</span><span class="s1">&#39;ProxyDHCPTestFixture&#39;</span><span class="p">)</span>
    <span class="n">suite</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">fixture</span><span class="p">()</span> <span class="k">for</span> <span class="n">fixture</span> <span class="ow">in</span> <span class="n">TEST_FIXTURES</span><span class="p">])</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../networking.html">networking</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>