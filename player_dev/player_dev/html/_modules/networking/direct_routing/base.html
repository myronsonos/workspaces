
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>networking.direct_routing.base &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for networking.direct_routing.base</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>

<span class="kn">import</span> <span class="nn">pyshark</span>

<span class="kn">from</span> <span class="nn">common.networking.wireless_mode</span> <span class="k">import</span> <span class="n">WirelessModeMixin</span>
<span class="kn">from</span> <span class="nn">custom_tuples</span> <span class="k">import</span> <span class="n">namedtyple</span>
<span class="kn">from</span> <span class="nn">decorators</span> <span class="k">import</span> <span class="n">retry</span>
<span class="kn">from</span> <span class="nn">linux.cli.base</span> <span class="k">import</span> <span class="n">CliCommand</span>
<span class="kn">from</span> <span class="nn">sleep</span> <span class="k">import</span> <span class="n">guaranteed_sleep</span>
<span class="kn">from</span> <span class="nn">sonos.client.athconfiglib</span> <span class="k">import</span> <span class="n">Athconfig</span>
<span class="kn">from</span> <span class="nn">sonos.client.cli.brctl</span> <span class="k">import</span> <span class="n">Brctl</span>
<span class="kn">from</span> <span class="nn">sonos.client.zone_player</span> <span class="k">import</span> <span class="n">INTERFACE_2GHZ</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="p">(</span>
    <span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">UPnPError</span><span class="p">,</span> <span class="n">UPnPMissingService</span><span class="p">,</span> <span class="n">UPnPTimeout</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">sonos.websrv</span> <span class="k">import</span> <span class="n">WebServer</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">WorkflowTestFixture</span>
<span class="kn">from</span> <span class="nn">thread_processing</span> <span class="k">import</span> <span class="n">run_concurrent_processes</span>
<span class="kn">from</span> <span class="nn">wifi.channels</span> <span class="k">import</span> <span class="n">channel_frequency_to_number</span>
<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="k">import</span> <span class="ne">ConnectionError</span>
<span class="kn">from</span> <span class="nn">networking</span> <span class="k">import</span> <span class="n">ZoneSelector</span>


<span class="n">DRInfo</span> <span class="o">=</span> <span class="n">namedtyple</span><span class="p">(</span><span class="s1">&#39;DRInfo&#39;</span><span class="p">,</span> <span class="s1">&#39;settestpoint_cmds, peer, is_dr_enabled&#39;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">timeout to wait for the direct routing state to settle on</span>
<span class="sd">the expected value in seconds.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">40</span>
<span class="c1"># default time in seconds start_sniff will sniff for</span>
<span class="n">SNIFF_TIME</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">DIRECT_ROUTING_ENABLED_RSSI</span> <span class="o">=</span> <span class="mi">26</span>

<span class="c1"># audio source to eliminate erroneous streaming failures and sync errors</span>
<span class="n">LOCAL_PATH</span> <span class="o">=</span> <span class="s1">&#39;/srv/samba/Playback/queue_tests/small_share&#39;</span>
<span class="n">WEB_SRV_PORT</span> <span class="o">=</span> <span class="mi">8080</span>
<span class="n">TRACK</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mp3&#39;</span><span class="p">:</span> <span class="s1">&#39;13 Exodus.mp3&#39;</span><span class="p">}</span>
<span class="n">KEY</span> <span class="o">=</span> <span class="s1">&#39;mp3&#39;</span>


<div class="viewcode-block" id="DirectRoutingWorkflowTestFixture"><a class="viewcode-back" href="../../../networking.direct_routing.html#networking.direct_routing.base.DirectRoutingWorkflowTestFixture">[docs]</a><span class="k">class</span> <span class="nc">DirectRoutingWorkflowTestFixture</span><span class="p">(</span><span class="n">WorkflowTestFixture</span><span class="p">,</span> <span class="n">WirelessModeMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base Direct Routing Workflow Test Fixture class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SYNC_ERROR_MSG</span> <span class="o">=</span> <span class="s2">&quot;sync error&quot;</span>
    <span class="n">WIRELESS_CAP_ID</span> <span class="o">=</span> <span class="s1">&#39;mon0&#39;</span>
    <span class="n">WIRELESS_INT_ID</span> <span class="o">=</span> <span class="s1">&#39;wlan0&#39;</span>
    <span class="c1"># wireshark display filter to filter out potential audio packets</span>
    <span class="n">GROUP_AUDIO_FILTER</span> <span class="o">=</span> <span class="s1">&#39;wlan.qos.priority==1&#39;</span>
    <span class="c1"># time in seconds to sniff grouped audio playback</span>
    <span class="n">GROUP_AUDIO_SAMPLE_TIME</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="c1"># minimum number of packets seen to mark test as passing grouped</span>
    <span class="c1"># audio playback in a GROUP_AUDIO_SAMPLE second interval</span>
    <span class="n">PLAYBACK_PCKT_THRESHOLD</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="c1"># maximum allowable number of packets seen to mark</span>
    <span class="c1"># test as not sending audio packets to peer</span>
    <span class="n">NON_PLAYBACK_PCK_THRESHOLD</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="c1"># Fail test if capture file size is smaller than MIN_CAP_FILE_SIZE</span>
    <span class="c1"># because it means that it didn&#39;t see the expected amount of audio traffic.</span>
    <span class="n">MIN_CAP_FILE_SIZE</span> <span class="o">=</span> <span class="mi">500</span>

    <span class="c1"># The time it takes for a multicast entry to age out of the bridge</span>
    <span class="c1"># when no traffic destined for that ZP is detected.</span>
    <span class="n">MULTICAST_AGEING_TIME_SECS</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="n">MULTICAST_BUFFER_TIME_SECS</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fixture_name</span><span class="p">,</span> <span class="n">zone_json</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DirectRoutingWorkflowTestFixture</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fixture_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zone_json</span> <span class="o">=</span> <span class="n">zone_json</span>

<div class="viewcode-block" id="DirectRoutingWorkflowTestFixture.setUpFixture"><a class="viewcode-back" href="../../../networking.direct_routing.html#networking.direct_routing.base.DirectRoutingWorkflowTestFixture.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">zs</span> <span class="o">=</span> <span class="n">ZoneSelector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subnet</span><span class="o">.</span><span class="n">get_playback_devices</span><span class="p">())</span>
        <span class="n">duts</span> <span class="o">=</span> <span class="n">zs</span><span class="o">.</span><span class="n">select_from_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zone_json</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc</span> <span class="o">=</span> <span class="n">duts</span><span class="p">[</span><span class="s1">&#39;gc&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gms</span> <span class="o">=</span> <span class="n">duts</span><span class="p">[</span><span class="s1">&#39;gms&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zps</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gms</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Testbed contains a GC&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrStop</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gms</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;Verify minimum of two GMs&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_audio_server</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">athconfigs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brctls</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">athconfigs</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span> <span class="o">=</span> <span class="n">Athconfig</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">brctls</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span> <span class="o">=</span> <span class="n">Brctl</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>

        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">get_wireless_channel</span><span class="p">(</span><span class="n">INTERFACE_2GHZ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_channel</span> <span class="o">=</span> <span class="n">channel_frequency_to_number</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="c1"># set sniffer on the testrunner to be on the same channel as the AP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_sniffer_chan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_channel</span><span class="p">)</span></div>

<div class="viewcode-block" id="DirectRoutingWorkflowTestFixture.setUpTest"><a class="viewcode-back" href="../../../networking.direct_routing.html#networking.direct_routing.base.DirectRoutingWorkflowTestFixture.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_athconfig_testpoints</span><span class="p">(</span><span class="n">INTERFACE_2GHZ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ungroup_all</span><span class="p">()</span></div>

<div class="viewcode-block" id="DirectRoutingWorkflowTestFixture.tearDownTest"><a class="viewcode-back" href="../../../networking.direct_routing.html#networking.direct_routing.base.DirectRoutingWorkflowTestFixture.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="DirectRoutingWorkflowTestFixture.tearDownFixture"><a class="viewcode-back" href="../../../networking.direct_routing.html#networking.direct_routing.base.DirectRoutingWorkflowTestFixture.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transition_testbed_to_wired_sonosnet_mode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_start_audio_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a web server for local streaming playback</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span> <span class="o">=</span> <span class="n">WebServer</span><span class="p">(</span><span class="n">start_reactor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">WEB_SRV_PORT</span><span class="p">,</span> <span class="n">LOCAL_PATH</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="n">TRACK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Could not start web server&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started web server&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">http_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">host</span><span class="p">(),</span>
                                              <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">TRACK</span><span class="p">[</span><span class="n">KEY</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_add_track_to_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to clear the queue on the given zp</span>
<span class="sd">        and add the test song file</span>

<span class="sd">        :param zp: sonos zone component</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding test track to queue&quot;</span><span class="p">)</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">()</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">()</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">add_to_queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_uri</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_start_playback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to add the test track to the queue and play it</span>

<span class="sd">        :param zp: sonos zone component</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_track_to_queue</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">set_queue_position</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetPlayMode</span><span class="p">(</span><span class="s2">&quot;REPEAT_ALL&quot;</span><span class="p">)</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># try to workaround UPnP 701 errors caused by Twisted WebServer</span>
        <span class="c1"># refusing initial connection attempt</span>
        <span class="n">play_and_wait_and_retry</span> <span class="o">=</span> <span class="n">retry</span><span class="p">(</span><span class="n">attempts</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">expected_exception</span><span class="o">=</span><span class="n">UPnPError</span><span class="p">,</span>
            <span class="n">exception_verifier</span><span class="o">=</span><span class="k">lambda</span> <span class="n">exc</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">upnp_error</span> <span class="o">==</span> <span class="mi">701</span><span class="p">,</span>
            <span class="n">retry_delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">)</span>
        <span class="n">play_and_wait_and_retry</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_group_and_start_playback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">gms</span><span class="p">,</span> <span class="n">do_playback</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Group zps into playback group and start playback of music</span>

<span class="sd">        :param gc: group coordinator zp</span>
<span class="sd">        :type gc: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param gms: list of group member zps</span>
<span class="sd">        :type gms: :obj:`list` of</span>
<span class="sd">            :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param do_playback: flag to indicate if group playback should be</span>
<span class="sd">            started</span>
<span class="sd">        :type do_playback :obj:`bool`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">gm</span> <span class="ow">in</span> <span class="n">gms</span><span class="p">:</span>
            <span class="n">join_group</span> <span class="o">=</span> <span class="n">retry</span><span class="p">(</span><span class="n">attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">expected_exception</span><span class="o">=</span><span class="p">(</span><span class="n">UPnPError</span><span class="p">,</span>
                                                               <span class="n">UPnPMissingService</span><span class="p">,</span>
                                                               <span class="n">UPnPTimeout</span><span class="p">,</span>
                                                               <span class="ne">ConnectionError</span><span class="p">,</span>
                                                               <span class="ne">TimeoutError</span><span class="p">,</span>
                                                               <span class="ne">AttributeError</span><span class="p">),</span>
                               <span class="n">retry_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)(</span><span class="n">gm</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">)</span>
            <span class="n">join_group</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_playback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_playback</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Group playback started with GC </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gc</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_enable_all_eth_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable all ethernet ports on the managed switch for all ZPs</span>
<span class="sd">        in the testbed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Enabling ethernet ports of all ZPs in testbed&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transition_testbed_to_wired_sonosnet_mode</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_sniffer_chan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to initialize the sniffer to be on some</span>
<span class="sd">        specified channel.</span>

<span class="sd">        :param chan: channel to set the sniffer on</span>
<span class="sd">        :type chan :obj:`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CliCommand</span><span class="p">(</span><span class="s1">&#39;ip link set </span><span class="si">{}</span><span class="s1"> down&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WIRELESS_INT_ID</span><span class="p">))</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">CliCommand</span><span class="p">(</span><span class="s1">&#39;iwconfig </span><span class="si">{}</span><span class="s1"> channel </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WIRELESS_INT_ID</span><span class="p">,</span>
                                                   <span class="n">chan</span><span class="p">))</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">CliCommand</span><span class="p">(</span><span class="s1">&#39;ip link set </span><span class="si">{}</span><span class="s1"> up&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WIRELESS_INT_ID</span><span class="p">))</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_wait_for_devices_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to wait for all zps in the list to be in a state</span>
<span class="sd">        where each one is able to provide a response to</span>
<span class="sd">        its diag status page and UPnP state variables</span>

<span class="sd">        :param zps: list of ZPs</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">            :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Waiting for zps </span><span class="si">{}</span><span class="s1"> to provide response to &#39;</span>
                          <span class="s1">&#39;its diag device_info&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zps</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">wait_for_status_page</span><span class="p">(</span><span class="n">wait_timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">wait_delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_wait_for_mc_fwd_db_age_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to wait for the zp&#39;s brctl showmacs</span>
<span class="sd">        to show no peers under fowarding db. Previously</span>
<span class="sd">        grouped gms/peers age out after 60 seconds for sonosnet</span>
<span class="sd">        mode or 120 seconds for station mode. When a GM leaves</span>
<span class="sd">        a group, it doesn&#39;t immediately get removed from</span>
<span class="sd">        the showmacs forwarding db; it needs to age out.</span>

<span class="sd">        :param zp: sonos zone component to query brctl showstp</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param timeout: timeout in seconds</span>
<span class="sd">        :type timeout :obj:`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Waiting for zp </span><span class="si">{}</span><span class="s1"> to have no peers&#39;</span>
                          <span class="s1">&#39;listed under Multicast fowarding db&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span> <span class="n">_get_brctl_showmacs_num_mc_macs</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleanup the zp group and other HH zps in the same HH</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Stop_and_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_athconfig_testpoints</span><span class="p">(</span><span class="s1">&#39;ath0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ungroup_all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_clear_athconfig_testpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">netif</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to clear the athconfig testpoints</span>

<span class="sd">        :param netif: network interface to clear testpoints on</span>
<span class="sd">        :type netif: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure athconfig testpoints are set back to default</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">athconfigs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">athconfigs</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span><span class="o">.</span><span class="n">clear_testpoints</span><span class="p">(</span><span class="n">netif</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ungroup_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to make sure all zps used in test</span>
<span class="sd">        are no longer part of a group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mc_db_members</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_group_member</span><span class="p">():</span>
                <span class="n">mc_db_members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">leave_group_and_wait</span><span class="p">()</span>
        <span class="n">run_concurrent_processes</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">gm</span><span class="p">:</span> <span class="n">Brctl</span><span class="p">(</span><span class="n">gm</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_multicast_age_out</span><span class="p">(</span><span class="n">gm</span><span class="p">),</span>
            <span class="n">mc_db_members</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_ath0_dr_mac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to return the ath0 direct routing</span>
<span class="sd">        mac address for a given zp.</span>
<span class="sd">        For more details of rules:</span>
<span class="sd">        https://confluence.sonos.com/display/PDSW/Multiple+Wireless+MAC+address</span>

<span class="sd">        :param zp: sonos zone component</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :return: ath0 mac address (00:0E:58:00:00:01)</span>
<span class="sd">        :rtype: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">zp</span><span class="o">.</span><span class="n">direct_routing_mac_address</span>

    <span class="k">def</span> <span class="nf">_get_direct_enabled_num</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to return whether the direct routing enabled state</span>
<span class="sd">        should be &#39;3&#39; or &#39;1&#39; for a given zp peer.</span>

<span class="sd">        :param peer: peer zone to find direct enabled state</span>
<span class="sd">        :type peer: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :return: direct routing state</span>
<span class="sd">        :rtype: :obj:`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">peer</span><span class="o">.</span><span class="n">wire</span><span class="o">.</span><span class="n">is_on</span><span class="p">():</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">_get_peer_direct_routing_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">peer_mac</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to return the direct routing state under the &#39;d&#39;</span>
<span class="sd">        column when the brctl showports command is run on the given zp object</span>
<span class="sd">        and given mac addr of peer device.  If no entry is found then this</span>
<span class="sd">        method returns :class:`None &lt;types.NoneType&gt;`</span>

<span class="sd">        :param zp: zp to query its brctl showports</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param peer_mac: peer mac to find in brctl showports output</span>
<span class="sd">        :type peer_mac: :obj:`str`</span>
<span class="sd">        :return: direct routing state of specified peer</span>
<span class="sd">        :rtype: :obj:`int` or :class:`None &lt;types.NoneType&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">brctls</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span><span class="o">.</span><span class="n">showports</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">mac</span> <span class="o">==</span> <span class="n">peer_mac</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_brctl_showmacs_num_mc_macs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to return the number of entries from</span>
<span class="sd">        brctl showmacs that have a mc_mac entry.</span>

<span class="sd">        :param zp: zp to query its brctl showmacs</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :return: number of entries that have mc_mac</span>
<span class="sd">        :rtype: :obj:`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brctls</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span><span class="o">.</span><span class="n">showmacs</span><span class="p">()</span><span class="o">.</span><span class="n">mc_db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_dr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settestpoint_cmd_list</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">is_dr_enabled</span><span class="p">,</span>
                   <span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function that will:</span>
<span class="sd">        1. Execute a list of athconfig settestpoint command(s) on the zp.</span>
<span class="sd">        2. Verify the direct routing state for the peer on the zp.</span>

<span class="sd">        :param settestpoint_cmd_list: athconfig settestpoint commands</span>
<span class="sd">            to execute</span>
<span class="sd">        :type settestpoint_cmd_list: :obj:`list`</span>
<span class="sd">        :param zp: zp to execute settestpoint command</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param peer: zp peer</span>
<span class="sd">        :type peer: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param is_dr_enabled: are we testing for DR enabled?</span>
<span class="sd">        :type is_dr_enabled: :obj:`bool`</span>
<span class="sd">        :param timeout: seconds to wait for direct routing state to</span>
<span class="sd">            reach the expected state</span>
<span class="sd">        :type timeout: :obj:`int` or TIMEOUT</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">settestpoint_cmd_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">athconfigs</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span><span class="o">.</span><span class="n">settestpoint</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                                             <span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
                                             <span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">is_dr_enabled</span><span class="p">:</span>
            <span class="n">dr_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_direct_enabled_num</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dr_state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">peer_mac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ath0_dr_mac</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_peer_direct_routing_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span>
                    <span class="n">peer_mac</span><span class="p">)</span> <span class="o">==</span> <span class="n">dr_state</span><span class="p">,</span>
                <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="n">dr_state</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_peer_direct_routing_state</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">peer_mac</span><span class="p">),</span>
            <span class="s2">&quot;Verify direct routing state on </span><span class="si">{}</span><span class="s2"> for peer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">peer</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_verify_capture_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cap_file</span><span class="p">,</span> <span class="n">cap_filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to verify capture file is valid.</span>

<span class="sd">        :param cap_file: name of captuer file</span>
<span class="sd">        :type cap_file: :obj:`str`</span>
<span class="sd">        :param cap_filter: tshark capture filter</span>
<span class="sd">        :type cap_filter: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check that sniffer captured the expected data by via the file size.</span>
        <span class="n">file_info</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">cap_file</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">st_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Capture file </span><span class="si">{}</span><span class="s1"> is </span><span class="si">{}</span><span class="s1"> bytes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cap_file</span><span class="p">,</span>
                                                              <span class="n">size</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_CAP_FILE_SIZE</span><span class="p">:</span>
            <span class="c1"># sniffer appears to be stuck, try workaround</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Sniffer appears to have stopped capturing &#39;</span>
                             <span class="s1">&#39;packets or did not capture enough packets. &#39;</span>
                             <span class="s1">&#39;Toggling </span><span class="si">{}</span><span class="s1"> may fix the &#39;</span>
                             <span class="s1">&#39;problem&#39;</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WIRELESS_INT_ID</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_channel</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">]:</span>
                <span class="n">temp_chan</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp_chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_channel</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">CliCommand</span><span class="p">(</span><span class="s1">&#39;ip link set </span><span class="si">{}</span><span class="s1"> &#39;</span>
                       <span class="s1">&#39;down&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WIRELESS_INT_ID</span><span class="p">))</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="n">CliCommand</span><span class="p">(</span><span class="s1">&#39;iwconfig </span><span class="si">{}</span><span class="s1"> channel </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WIRELESS_INT_ID</span><span class="p">,</span>
                                                       <span class="n">temp_chan</span><span class="p">))</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="n">CliCommand</span><span class="p">(</span><span class="s1">&#39;ip link set </span><span class="si">{}</span><span class="s1"> up&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WIRELESS_INT_ID</span><span class="p">))</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="n">CliCommand</span><span class="p">(</span><span class="s1">&#39;ip link set </span><span class="si">{}</span><span class="s1"> &#39;</span>
                       <span class="s1">&#39;down&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WIRELESS_INT_ID</span><span class="p">))</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="n">CliCommand</span><span class="p">(</span><span class="s1">&#39;iwconfig </span><span class="si">{}</span><span class="s1"> channel &#39;</span>
                       <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WIRELESS_INT_ID</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">network_channel</span><span class="p">))</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="n">CliCommand</span><span class="p">(</span><span class="s1">&#39;ip link set </span><span class="si">{}</span><span class="s1"> up&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WIRELESS_INT_ID</span><span class="p">))</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting live capture again for </span><span class="si">{}</span><span class="s1"> &#39;</span>
                             <span class="s1">&#39;secs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GROUP_AUDIO_SAMPLE_TIME</span><span class="p">))</span>
            <span class="n">sniffer</span> <span class="o">=</span> <span class="n">pyshark</span><span class="o">.</span><span class="n">LiveCapture</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">WIRELESS_CAP_ID</span><span class="p">,</span>
                                          <span class="n">bpf_filter</span><span class="o">=</span><span class="n">cap_filter</span><span class="p">,</span>
                                          <span class="n">output_file</span><span class="o">=</span><span class="n">cap_file</span><span class="p">)</span>
            <span class="c1"># start sniffer for self.GROUP_AUDIO_SAMPLE seconds</span>
            <span class="n">sniffer</span><span class="o">.</span><span class="n">sniff</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GROUP_AUDIO_SAMPLE_TIME</span><span class="p">)</span>
            <span class="n">sniffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Capture redo completed.&#39;</span><span class="p">)</span>
            <span class="n">file_info</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">cap_file</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">st_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_CAP_FILE_SIZE</span><span class="p">,</span>
                                  <span class="s1">&#39;Capture file </span><span class="si">{}</span><span class="s1"> is </span><span class="si">{}</span><span class="s1"> bytes. &#39;</span>
                                  <span class="s1">&#39;It should be at least </span><span class="si">{}</span><span class="s1"> bytes &#39;</span>
                                  <span class="s1">&#39;if it captured the expected &#39;</span>
                                  <span class="s1">&#39;stuff&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cap_file</span><span class="p">,</span>
                                                 <span class="n">size</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">MIN_CAP_FILE_SIZE</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_start_sniffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sniff_start_delay</span><span class="p">,</span> <span class="n">cap_filter</span><span class="p">,</span>
                       <span class="n">sniff_time</span><span class="o">=</span><span class="n">SNIFF_TIME</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to start a wireless sniffer trace.</span>
<span class="sd">        Returns capture file created from the sniffer trace.</span>

<span class="sd">        :param name: name of test. also used for name of capture file.</span>
<span class="sd">        :type name: :obj:`str`</span>
<span class="sd">        :param sniff_start_delay: additional delay in seconds to start</span>
<span class="sd">            sniffing after playback has started</span>
<span class="sd">        :type sniff_start_delay: :obj:`int`</span>
<span class="sd">        :param cap_filter: capture filter to apply</span>
<span class="sd">        :type cap_filter: :obj:`str`</span>
<span class="sd">        :param sniff_time: duration of sniff/capture time</span>
<span class="sd">        :type sniff_time: :obj:`int`</span>
<span class="sd">        :return: capture file name</span>
<span class="sd">        :rtype: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cap_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.pcap&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sniff start delay of </span><span class="si">{}</span><span class="s1"> seconds for this &#39;</span>
                         <span class="s1">&#39;test&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sniff_start_delay</span><span class="p">))</span>
        <span class="n">guaranteed_sleep</span><span class="p">(</span><span class="n">sniff_start_delay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting live capture for </span><span class="si">{}</span><span class="s1"> &#39;</span>
                         <span class="s1">&#39;secs with capture filter set to &#39;</span>
                         <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sniff_time</span><span class="p">,</span>
                                     <span class="n">cap_filter</span><span class="p">))</span>
        <span class="n">sniffer</span> <span class="o">=</span> <span class="n">pyshark</span><span class="o">.</span><span class="n">LiveCapture</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">WIRELESS_CAP_ID</span><span class="p">,</span>
                                      <span class="n">bpf_filter</span><span class="o">=</span><span class="n">cap_filter</span><span class="p">,</span>
                                      <span class="n">output_file</span><span class="o">=</span><span class="n">cap_file</span><span class="p">,</span>
                                      <span class="n">only_summaries</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># start sniffer for sniff_time seconds</span>
        <span class="n">sniffer</span><span class="o">.</span><span class="n">sniff</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">sniff_time</span><span class="p">)</span>
        <span class="n">sniffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1"># sniffer post-processing when sniffer is done capturing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Capture completed. File </span><span class="si">{}</span><span class="s1"> created. &#39;</span>
                         <span class="s1">&#39;Starting capture file analysis.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cap_file</span><span class="p">))</span>
        <span class="c1"># check that sniffer captured the expected data by the file size.</span>
        <span class="c1"># stop test if it&#39;s not the expected size.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_capture_file</span><span class="p">(</span><span class="n">cap_file</span><span class="p">,</span> <span class="n">cap_filter</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cap_file</span>

    <span class="k">def</span> <span class="nf">_run_dr_state_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">dr_state</span><span class="p">,</span> <span class="n">ap_mac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basic test to check direct routing state.</span>
<span class="sd">        Groups dut1 (gc) and dut2 (gm).</span>
<span class="sd">        Set fixedrssi to be the rssi value.</span>
<span class="sd">        Verifies the direct rouitng enabled state and AP uplink</span>
<span class="sd">        port mac address on the dut gc.</span>

<span class="sd">        :param rssi: athconfig testpoint fixedrssi value</span>
<span class="sd">        :type rssi :obj:`int`</span>
<span class="sd">        :param dr_state: direct routing enabled (True) or</span>
<span class="sd">            disabled state (False)</span>
<span class="sd">        :type dr_state :obj:`bool`</span>
<span class="sd">        :param ap_mac: check ap mac address in uplink port if one</span>
<span class="sd">            is specified.</span>
<span class="sd">        :type ap_mac :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gc</span>
        <span class="n">dut2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;GC = </span><span class="si">{}</span><span class="s1">, GM = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dut1</span><span class="p">,</span> <span class="n">dut2</span><span class="p">))</span>
        <span class="n">join_group</span> <span class="o">=</span> <span class="n">retry</span><span class="p">(</span><span class="n">attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">expected_exception</span><span class="o">=</span><span class="p">(</span><span class="n">UPnPError</span><span class="p">,</span>
                                                           <span class="n">UPnPMissingService</span><span class="p">,</span>
                                                           <span class="n">UPnPTimeout</span><span class="p">,</span>
                                                           <span class="ne">TimeoutError</span><span class="p">,</span>
                                                           <span class="ne">AttributeError</span><span class="p">),</span>
                           <span class="n">retry_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)(</span><span class="n">dut2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">)</span>
        <span class="n">join_group</span><span class="p">(</span><span class="n">dut1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dr</span><span class="p">([</span><span class="s1">&#39;ath0 fixedrssi </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rssi</span><span class="p">)],</span> <span class="n">dut1</span><span class="p">,</span> <span class="n">dut2</span><span class="p">,</span>
            <span class="n">dr_state</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ap_mac</span><span class="p">:</span>
            <span class="n">brctl_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">brctls</span><span class="p">[</span><span class="n">dut1</span><span class="p">]</span><span class="o">.</span><span class="n">showports</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">brctl_output</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">u</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">uplink_port_mac</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">mac</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">ap_mac</span><span class="p">,</span> <span class="n">uplink_port_mac</span><span class="p">,</span>
                                       <span class="s2">&quot;Verify AP uplink port mac&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">athconfigs</span><span class="p">[</span><span class="n">dut1</span><span class="p">]</span><span class="o">.</span><span class="n">settestpoint</span><span class="p">(</span><span class="s1">&#39;ath0&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;fixedrssi&#39;</span><span class="p">,</span>
                                           <span class="mi">0</span><span class="p">)</span>
        <span class="n">dut2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">leave_group_and_wait</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_run_descend_rssi_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basic test that verifies that direct routing is enabled</span>
<span class="sd">        between the pair when RSSI descends from 26 to 19.</span>
<span class="sd">        When RSSI is 18, direct routing should be disabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gc</span>
        <span class="n">dut2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;GC = </span><span class="si">{}</span><span class="s1">, GM = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dut1</span><span class="p">,</span> <span class="n">dut2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_and_start_playback</span><span class="p">(</span><span class="n">dut1</span><span class="p">,</span> <span class="p">[</span><span class="n">dut2</span><span class="p">],</span> <span class="n">do_playback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dr</span><span class="p">([</span><span class="s1">&#39;ath0 fixedrssi </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span>
                            <span class="n">dut1</span><span class="p">,</span>
                            <span class="n">dut2</span><span class="p">,</span>
                            <span class="kc">True</span><span class="p">,</span>
                            <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dr</span><span class="p">([</span><span class="s1">&#39;ath0 fixedrssi 18&#39;</span><span class="p">],</span>
                        <span class="n">dut1</span><span class="p">,</span>
                        <span class="n">dut2</span><span class="p">,</span>
                        <span class="kc">False</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">athconfigs</span><span class="p">[</span><span class="n">dut1</span><span class="p">]</span><span class="o">.</span><span class="n">settestpoint</span><span class="p">(</span><span class="s1">&#39;ath0&#39;</span><span class="p">,</span> <span class="s1">&#39;fixedrssi&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">dut2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">leave_group_and_wait</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_run_ascend_rssi_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basic test that verifies that direct routing is disabled</span>
<span class="sd">        for the pair when RSSI ascends from 18 to 24 inclusive.</span>
<span class="sd">        Direct routing should be enabled when</span>
<span class="sd">        RSSI reaches 25.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gc</span>
        <span class="n">dut2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;GC = </span><span class="si">{}</span><span class="s1">, GM = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dut1</span><span class="p">,</span> <span class="n">dut2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_and_start_playback</span><span class="p">(</span><span class="n">dut1</span><span class="p">,</span> <span class="p">[</span><span class="n">dut2</span><span class="p">],</span> <span class="n">do_playback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dr</span><span class="p">([</span><span class="s1">&#39;ath0 fixedrssi 18&#39;</span><span class="p">],</span> <span class="n">dut1</span><span class="p">,</span> <span class="n">dut2</span><span class="p">,</span>
                        <span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">25</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dr</span><span class="p">([</span><span class="s1">&#39;ath0 fixedrssi </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span>
                            <span class="n">dut1</span><span class="p">,</span> <span class="n">dut2</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dr</span><span class="p">([</span><span class="s1">&#39;ath0 fixedrssi 25&#39;</span><span class="p">],</span>
                        <span class="n">dut1</span><span class="p">,</span> <span class="n">dut2</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">athconfigs</span><span class="p">[</span><span class="n">dut1</span><span class="p">]</span><span class="o">.</span><span class="n">settestpoint</span><span class="p">(</span><span class="s1">&#39;ath0&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;fixedrssi&#39;</span><span class="p">,</span>
                                            <span class="mi">0</span><span class="p">)</span>
        <span class="n">dut2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">leave_group_and_wait</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_run_pb_rssi_dynamic_enable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">gms</span><span class="p">,</span> <span class="n">test_name</span><span class="p">,</span>
                                    <span class="n">zp_wire_list</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basic test to run a unicast or multicast group playback test</span>
<span class="sd">        where direct routing is initially disabled during the start</span>
<span class="sd">        of the playback because RSSI is less than 19.</span>
<span class="sd">        Then dynamically increase the RSSI from GC to GM(s) to greater</span>
<span class="sd">        than 25. This should enable direct routing.</span>

<span class="sd">        :param gc: dut group coordinator</span>
<span class="sd">        :type gc: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param gms: zp group members</span>
<span class="sd">        :type gms: :obj:`list` of</span>
<span class="sd">            :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param test_name: test name</span>
<span class="sd">        :type test_name: :obj: `str`</span>
<span class="sd">        :param zp_wire_list: list of zp with ethernet wired enabled</span>
<span class="sd">        :type zp_wire_list: :obj: `list` of</span>
<span class="sd">            :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dr_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Set and verify that direct routing is disabled to all gm(s)</span>
        <span class="k">for</span> <span class="n">gm</span> <span class="ow">in</span> <span class="n">gms</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            At start of playback, GC will have rssi of 66 to everyone</span>
<span class="sd">            else, and rssi that is less than 19 (66 - 49) to ensure</span>
<span class="sd">            that direct routing is disabled between GC and GMs.</span>
<span class="sd">            Then change rssi between GC and GMs back to 66 to</span>
<span class="sd">            dynamically enable direct routing while playback continues.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">cmd_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ath0 fixedrssi 66&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;ath0 </span><span class="si">{}</span><span class="s1"> 49&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ath0_dr_mac</span><span class="p">(</span><span class="n">gm</span><span class="p">))]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dr</span><span class="p">(</span><span class="n">cmd_list</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">gm</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
            <span class="n">cmd_list2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ath0 </span><span class="si">{}</span><span class="s1"> 0&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ath0_dr_mac</span><span class="p">(</span><span class="n">gm</span><span class="p">))]</span>
            <span class="n">dynamic_dr_info_set</span> <span class="o">=</span> <span class="n">DRInfo</span><span class="p">(</span><span class="n">cmd_list2</span><span class="p">,</span> <span class="n">gm</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">dr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dynamic_dr_info_set</span><span class="p">)</span>
        <span class="c1"># start group playback and then change rssi during playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_group_playback</span><span class="p">(</span><span class="n">gms</span><span class="p">,</span> <span class="n">test_name</span><span class="p">,</span>
                                 <span class="n">zp_wire_list</span><span class="p">,</span>
                                 <span class="n">dynamic_dr_list</span><span class="o">=</span><span class="n">dr_list</span><span class="p">,</span>
                                 <span class="n">sniff_start_delay</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MULTICAST_AGEING_TIME_SECS</span> <span class="o">+</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">MULTICAST_BUFFER_TIME_SECS</span><span class="p">),</span>
                                 <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dr_enable_lists</span><span class="p">(</span><span class="n">gms</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_run_playback_dr_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">gms</span><span class="p">,</span> <span class="n">test_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basic test to run a group playback test where direct</span>
<span class="sd">        routing is disabled because RSSI is less than 19 on first</span>
<span class="sd">        gm given in gms list. GC and GMs are all wireless.</span>
<span class="sd">        For sonosnet mode test, the first bridge will be wired.</span>

<span class="sd">        :param gc: dut group coordinator</span>
<span class="sd">        :type gc: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param gms: zp group members</span>
<span class="sd">        :type gms: :obj:`list` of</span>
<span class="sd">            :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param test_name: test name</span>
<span class="sd">        :type test_name: :obj: `str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;RSSI between GC </span><span class="si">{}</span><span class="s1"> and GM </span><span class="si">{}</span><span class="s1"> &#39;</span>
                         <span class="s1">&#39;is less than 19&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">gms</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cmd_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ath0 fixedrssi &#39;</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DIRECT_ROUTING_ENABLED_RSSI</span><span class="p">),</span>
                    <span class="s1">&#39;ath0 </span><span class="si">{}</span><span class="s1"> 9&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ath0_dr_mac</span><span class="p">(</span><span class="n">gms</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dr</span><span class="p">(</span><span class="n">cmd_list</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">gms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_pb_rssi_dynamic_disable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">gms</span><span class="p">,</span> <span class="n">test_name</span><span class="p">,</span>
                                     <span class="n">zp_wire_list</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basic test to run a unicast or multicast group playback test</span>
<span class="sd">        where direct routin_run_playback_dr_disabledg is initially enabled during the start</span>
<span class="sd">        of the playback because RSSI is greater than 26.</span>
<span class="sd">        Then dynamically lower the RSSI from GC to GMs to less than 19.</span>
<span class="sd">        This should disable direct routing.</span>

<span class="sd">        :param gc: dut group coordinator</span>
<span class="sd">        :type gc: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param gms: zp group members</span>
<span class="sd">        :type gms: :obj:`list` of</span>
<span class="sd">            :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param test_name: test name</span>
<span class="sd">        :type test_name: :obj: `str`</span>
<span class="sd">        :param zp_wire_list: list of zp with ethernet wired enabled</span>
<span class="sd">        :type zp_wire_list: :obj: `list` of</span>
<span class="sd">            :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        From gc, gm(s) will have rssi of 25 (66 - 41), and all other zps</span>
<span class="sd">        will have rssi of 66. This will help ensure that gc will</span>
<span class="sd">        have lower path cost to wired bridge than other wired gms.</span>
<span class="sd">        The rssi (25) is still above the direct routing enabled</span>
<span class="sd">        threshhold between GC and GM initially during start of playback.</span>
<span class="sd">        In cb-mcs9 testbeds, root bridge is cisco switch.</span>
<span class="sd">        We want the dut GC to prefer to have forwarding</span>
<span class="sd">        stp state to wired bridge vs. wired gm so that we can</span>
<span class="sd">        differentiate when dut gc is forwarding via stp path</span>
<span class="sd">        vs. direct routing to gm.</span>
<span class="sd">        Then after playback has started with direct routing enabled,</span>
<span class="sd">        lower the rssi between GC and GM to less than 19 (66 - 49),</span>
<span class="sd">        so that direct routing will be dynamically disabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dr_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gm</span> <span class="ow">in</span> <span class="n">gms</span><span class="p">:</span>
            <span class="n">cmd_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ath0 fixedrssi 66&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;ath0 </span><span class="si">{}</span><span class="s1"> 41&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ath0_dr_mac</span><span class="p">(</span><span class="n">gm</span><span class="p">))]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dr</span><span class="p">(</span><span class="n">cmd_list</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">gm</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
            <span class="n">cmd_list2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ath0 </span><span class="si">{}</span><span class="s1"> 49&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ath0_dr_mac</span><span class="p">(</span><span class="n">gm</span><span class="p">))]</span>
            <span class="n">dynamic_dr_info_set</span> <span class="o">=</span> <span class="n">DRInfo</span><span class="p">(</span><span class="n">cmd_list2</span><span class="p">,</span> <span class="n">gm</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">dr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dynamic_dr_info_set</span><span class="p">)</span>
        <span class="c1"># start group playback and change rssi during playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_group_playback</span><span class="p">(</span><span class="n">gms</span><span class="p">,</span> <span class="n">test_name</span><span class="p">,</span>
                                 <span class="n">zp_wire_list</span><span class="p">,</span>
                                 <span class="n">dynamic_dr_list</span><span class="o">=</span><span class="n">dr_list</span><span class="p">,</span>
                                 <span class="n">sniff_start_delay</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MULTICAST_AGEING_TIME_SECS</span> <span class="o">+</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">MULTICAST_BUFFER_TIME_SECS</span><span class="p">),</span>
                                 <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dr_disable_lists</span><span class="p">(</span><span class="n">gms</span><span class="p">,</span>
                                     <span class="n">zp_wire_list</span><span class="p">))</span>

<div class="viewcode-block" id="DirectRoutingWorkflowTestFixture.got_sync_error"><a class="viewcode-back" href="../../../networking.direct_routing.html#networking.direct_routing.base.DirectRoutingWorkflowTestFixture.got_sync_error">[docs]</a>    <span class="k">def</span> <span class="nf">got_sync_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function called when sync error detected</span>

<span class="sd">        :param zp: zp where sync error was detected on</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param msg: message</span>
<span class="sd">        :type msg: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;got sync error on </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span></div>

<div class="viewcode-block" id="DirectRoutingWorkflowTestFixture.begin_watching_for_sync_error"><a class="viewcode-back" href="../../../networking.direct_routing.html#networking.direct_routing.base.DirectRoutingWorkflowTestFixture.begin_watching_for_sync_error">[docs]</a>    <span class="k">def</span> <span class="nf">begin_watching_for_sync_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Begin watching for sync errors on the zps</span>

<span class="sd">        :param zps: list of zps</span>
<span class="sd">        :type zp: :obj:`list` of</span>
<span class="sd">            :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log</span><span class="p">()</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">watch_udp_log_for_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNC_ERROR_MSG</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">got_sync_error</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span></div>

<div class="viewcode-block" id="DirectRoutingWorkflowTestFixture.stop_watching_for_sync_error"><a class="viewcode-back" href="../../../networking.direct_routing.html#networking.direct_routing.base.DirectRoutingWorkflowTestFixture.stop_watching_for_sync_error">[docs]</a>    <span class="k">def</span> <span class="nf">stop_watching_for_sync_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop watching for sync errors on the zps</span>

<span class="sd">        :param zps: group of zps</span>
<span class="sd">        :type zps: :obj:`list` of</span>
<span class="sd">            :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log</span><span class="p">()</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../networking.html">networking</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>