
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>upnp.helpers.diag &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for upnp.helpers.diag</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">coherence.extern.louie</span> <span class="k">as</span> <span class="nn">louie</span>
<span class="kn">from</span> <span class="nn">coherence.upnp.core.device</span> <span class="k">import</span> <span class="n">RootDevice</span>
<span class="kn">from</span> <span class="nn">coherence.upnp.core.utils</span> <span class="k">import</span> <span class="n">extract_udn_from_usn</span>
<span class="kn">from</span> <span class="nn">sonos.client.internal</span> <span class="k">import</span> <span class="p">(</span><span class="n">COHERENCE_ADD_DEVICE_SIGNAL</span><span class="p">,</span>
                                   <span class="n">COHERENCE_REMOVE_DEVICE_SIGNAL</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sonos.client.internal</span> <span class="k">import</span> <span class="n">zones_to_update_set</span>
<span class="kn">from</span> <span class="nn">upnp.helpers.timer</span> <span class="k">import</span> <span class="n">PeriodicCallback</span>
<span class="kn">from</span> <span class="nn">upnp.helpers.workflow</span> <span class="k">import</span> <span class="n">BaseWorkflowHelper</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="ne">TimeoutError</span>

<span class="n">HOUSEHOLD_DIAG_URL</span>          <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">%s</span><span class="s2">:1400/support/review&quot;</span>
<span class="n">DEFAULT_DIAG_XSL_PATH</span>       <span class="o">=</span> <span class="s2">&quot;/xml/review.xsl&quot;</span>


<div class="viewcode-block" id="DiagHelpers"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.DiagHelpers">[docs]</a><span class="k">class</span> <span class="nc">DiagHelpers</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper methods for zone diagnostics</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;DiagHelpers&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_replace_diag_xsl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diag_xml_buffer</span><span class="p">,</span> <span class="n">xsl_url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;replacing default XSL with &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">xsl_url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">diag_xml_buffer</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">DEFAULT_DIAG_XSL_PATH</span><span class="p">,</span> <span class="n">xsl_url</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_diag_buffer_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diag_xml_buffer</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_fh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;writing household diag to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">out_filename</span><span class="p">)</span>
            <span class="n">out_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">diag_xml_buffer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span><span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>

<div class="viewcode-block" id="DiagHelpers.save_household_diag"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.DiagHelpers.save_household_diag">[docs]</a>    <span class="k">def</span> <span class="nf">save_household_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">,</span> <span class="n">xsl_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the full household diagnostic from this Zone to disk</span>

<span class="sd">        Arguments:</span>
<span class="sd">        zp -- SonosZoneComponent to retrieve household diag from</span>
<span class="sd">        out_filename -- string, name of file to write household diag to</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">        xsl_url -- string, replace XSL stylesheet used in diag with this</span>

<span class="sd">        Returns:</span>
<span class="sd">        boolean -- was diag saved to disk?</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_diag_saved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">HOUSEHOLD_DIAG_URL</span> <span class="o">%</span> <span class="n">zp</span><span class="o">.</span><span class="n">ip</span>
        <span class="n">full_xml</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">getURL</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">full_xml</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xsl_url</span><span class="p">:</span>
                <span class="n">full_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace_diag_xsl</span><span class="p">(</span><span class="n">full_xml</span><span class="p">,</span> <span class="n">xsl_url</span><span class="p">)</span>
            <span class="n">is_diag_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_diag_buffer_to_disk</span><span class="p">(</span><span class="n">full_xml</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">is_diag_saved</span></div>

    <span class="c1"># TODO: move to services/diag.py or client/udp_logger.py</span>
<div class="viewcode-block" id="DiagHelpers.setup_udp_logger"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.DiagHelpers.setup_udp_logger">[docs]</a>    <span class="k">def</span> <span class="nf">setup_udp_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">queries</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Quickly setup a UDPLogger for this device, watching for the specified queries</span>

<span class="sd">        Arguments:</span>
<span class="sd">        zp -- SonosZoneComponent</span>
<span class="sd">        queries -- list of strings to watch incoming UDP log messages for</span>

<span class="sd">        Returns:</span>

<span class="sd">        udp_logger.LogAnacapa context manager, setup for this device and specified queries</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;setting up anacapa logger for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">)</span>
        <span class="n">anacapa_logger</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_anacapa_logger</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;adding anacapa query &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">watch_udp_log_for_string</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">anacapa_logger</span></div>

<div class="viewcode-block" id="DiagHelpers.get_udp_logger_query_results"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.DiagHelpers.get_udp_logger_query_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_udp_logger_query_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">queries</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the number of matches for these UDPLogger queries</span>

<span class="sd">        Arguments:</span>
<span class="sd">        zp -- SonosZoneComponent</span>
<span class="sd">        queries -- list of strings, UDPLogger queries</span>

<span class="sd">        Returns:</span>
<span class="sd">        dictionary --   key: string, UDPLogger query</span>
<span class="sd">                        value: integer, number of times this query has matched</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;checking </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%d</span><span class="s2"> UDPLogger queries&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)))</span>
        <span class="n">query_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
            <span class="n">num_detections</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_search_results</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">query_results</span><span class="p">[</span><span class="n">query</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_detections</span>
        <span class="k">return</span> <span class="n">query_results</span></div>

<div class="viewcode-block" id="DiagHelpers.wait_for_status_page_to_be_unavailable"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.DiagHelpers.wait_for_status_page_to_be_unavailable">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_status_page_to_be_unavailable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> 
                                               <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> 
                                               <span class="n">iteration_delay</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                                               <span class="n">retry</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for the diagnostic &#39;status&#39; page to be unavailable on this device.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        device -- SonosZoneComponent or SonosControllerComponent</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">        timeout_seconds -- integer, default=45, max seconds to wait</span>
<span class="sd">        iteration_delay -- float, default=0.1,  time to wait between iterations</span>
<span class="sd">        retry -- callable, default=None, optional method to call for each iteration</span>

<span class="sd">        Returns:</span>
<span class="sd">        boolean -- has the status page on this device become unavailable?</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;waiting for status page on </span><span class="si">%s</span><span class="s2"> to become unavailable&quot;</span> <span class="o">%</span> <span class="n">device</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_status_page_state</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> 
                                                <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">,</span>
                                                <span class="n">iteration_delay</span><span class="o">=</span><span class="n">iteration_delay</span><span class="p">,</span>
                                                <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span></div>

<div class="viewcode-block" id="DiagHelpers.wait_for_status_page_to_be_available"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.DiagHelpers.wait_for_status_page_to_be_available">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_status_page_to_be_available</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> 
                                             <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> 
                                             <span class="n">iteration_delay</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                                             <span class="n">retry</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for the diagnostic &#39;status&#39; page to be unavailable on this device.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        device -- SonosZoneComponent or SonosControllerComponent</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">        timeout_seconds -- integer, default=45, max seconds to wait</span>
<span class="sd">        iteration_delay -- float, default=0.1,  time to wait between iterations</span>
<span class="sd">        retry -- callable, default=None, optional method to call for each iteration</span>

<span class="sd">        Returns:</span>
<span class="sd">        boolean -- has the status page on this device become available?</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;waiting for status page on </span><span class="si">%s</span><span class="s2"> to become available&quot;</span> <span class="o">%</span> <span class="n">device</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_status_page_state</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> 
                                                <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">,</span>
                                                <span class="n">iteration_delay</span><span class="o">=</span><span class="n">iteration_delay</span><span class="p">,</span>
                                                <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_wait_for_status_page_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for the diagnostic &#39;status&#39; page state to change.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        device -- SonosZoneComponent or SonosControllerComponent</span>
<span class="sd">        state -- boolean, </span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">        timeout_seconds -- integer, default=45, max seconds to wait</span>
<span class="sd">        iteration_delay -- float, default=0.1,  time to wait between iterations</span>
<span class="sd">        retry -- callable, default=None, optional method to call for each iteration</span>

<span class="sd">        Returns:</span>
<span class="sd">        boolean -- has the status page on this device become available?</span>



<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_desired_state</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">device</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">does_status_page_exist</span><span class="p">()</span> <span class="o">==</span> <span class="n">state</span><span class="p">,</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">,</span>
                            <span class="n">iteration_delay</span><span class="o">=</span><span class="n">iteration_delay</span><span class="p">,</span>
                            <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span>
            <span class="n">is_desired_state</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;caught TimeoutError waiting for status page to become unavailable on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">device</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">is_desired_state</span></div>


<div class="viewcode-block" id="DiagWorkflowHelpers"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.DiagWorkflowHelpers">[docs]</a><span class="k">class</span> <span class="nc">DiagWorkflowHelpers</span><span class="p">(</span><span class="n">DiagHelpers</span><span class="p">,</span> <span class="n">BaseWorkflowHelper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Common diagnostic tests which utilize the Workflow framework</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_fixture</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a DiagWorkflowHelpers instance</span>

<span class="sd">        Arguments:</span>
<span class="sd">        workflow_fixture -- WorkflowTestFixture instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow_fixture</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DiagWorkflowHelpers</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">logger</span>

<div class="viewcode-block" id="DiagWorkflowHelpers.verify_udp_logger_queries"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.DiagWorkflowHelpers.verify_udp_logger_queries">[docs]</a>    <span class="k">def</span> <span class="nf">verify_udp_logger_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="n">assertion_level</span><span class="o">=</span><span class="s1">&#39;FAIL&#39;</span><span class="p">,</span> <span class="n">num_expected_detections</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that the specified UDPLogger queries match the expected number of detections</span>

<span class="sd">        Arguments:</span>
<span class="sd">        zp -- SonosZoneComponent</span>
<span class="sd">        queries -- list of strings, UDPLogger queries</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">        assertion_level -- string, default=FAIL, assertion level to use with Workflow framework</span>
<span class="sd">        num_expected_detections -- integer, default=0, number of detections expected for UDPLogger queries</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;checking for hits on anacapa query &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">num_detections</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_search_results</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="s2">&quot;verifyEqual&quot;</span><span class="p">,</span> <span class="n">assertion_level</span><span class="p">,</span> <span class="n">num_detections</span><span class="p">,</span> <span class="n">num_expected_detections</span><span class="p">,</span> <span class="s2">&quot;expected </span><span class="si">%d</span><span class="s2"> detections of &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_expected_detections</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span></div></div>


<span class="c1"># Not sure what to call this just yet...</span>
<div class="viewcode-block" id="ConfigurationBitmask"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.ConfigurationBitmask">[docs]</a><span class="k">class</span> <span class="nc">ConfigurationBitmask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">UNDEFINED</span> <span class="o">=</span> <span class="mh">0x0000</span>  <span class="c1"># I am calling this undefined, since a standalone GC shoud at least be a PRIMARY_BONDED</span>
    <span class="n">PRIMARY_GROUPED</span> <span class="o">=</span> <span class="mh">0x0001</span>
    <span class="n">SECONDARY_GROUPED</span> <span class="o">=</span> <span class="mh">0x0002</span>
    <span class="n">PRIMARY_BONDED</span> <span class="o">=</span> <span class="mh">0x0100</span>
    <span class="n">SECONDARY_BONDED</span> <span class="o">=</span> <span class="mh">0x0200</span>
    <span class="n">STEREO_BONDED</span> <span class="o">=</span> <span class="mh">0x1000</span>
    <span class="n">HT_BONDED</span> <span class="o">=</span> <span class="mh">0x2000</span></div>


<div class="viewcode-block" id="UDPDiagnosticModuleMonitor"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor">[docs]</a><span class="k">class</span> <span class="nc">UDPDiagnosticModuleMonitor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for monitoring UDP diagnostic messages, UPnP state variables and</span>
<span class="sd">    various convenience helpers/methods for performing failure analysis.</span>
<span class="sd">    It can output a HDF file whereby each row is an even of some sort per</span>
<span class="sd">    player so that we can do analysis on it.</span>

<span class="sd">    https://confluence.sonos.com/display/PDSW/Test+Automation+Failure+Analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>

    <span class="n">SHUTTING_DOWN_LOG_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;Shutting down&#39;</span>

    <span class="n">MAIN_REAL_TIME_REGEX_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;RealTime is\s+\[(?P&lt;localizedtimestr&gt;[^\]]+)\]\s+\(off=(?P&lt;utc&gt;[^\)]+)\)&#39;</span>
    <span class="c1"># [1970-01-01 18:05:50.255] &lt;htap,3&gt; audio external req. old 1 new 0 thread state 1</span>
    <span class="n">HTAP_EXT_AUDIO_SRC_PLAYING</span> <span class="o">=</span> <span class="s1">&#39;audio external req\. old (?P&lt;ext_audio_state_old&gt;\d+) new&#39;</span> \
                                 <span class="s1">&#39; (?P&lt;ext_audio_state_new&gt;\d+) thread state (?P&lt;htap_thread_state&gt;\d+)&#39;</span>
    <span class="n">DUCK_EXT_AUDIO_SRC_PLAYING</span> <span class="o">=</span> <span class="s2">&quot;external source is playing&quot;</span>
    <span class="n">DUCK_EXT_AUDIO_SRC_STOPPED</span> <span class="o">=</span> <span class="s2">&quot;external source is stopping&quot;</span>
    <span class="n">MIXER_DEFAULT_DUCKING</span> <span class="o">=</span> <span class="s1">&#39;\[default\-mixer\]: ducking streams&#39;</span>
    <span class="n">MIXER_DEFAULT_UN_DUCKING</span> <span class="o">=</span> <span class="s1">&#39;\[default\-mixer\]: unducking streams&#39;</span>
    <span class="n">MIXER_HTA_CHSNK_DUCKING</span> <span class="o">=</span> <span class="s1">&#39;\[hta\-chsnk\-mixer\]: ducking streams&#39;</span>
    <span class="n">MIXER_HTA_CHSNK_UN_DUCKING</span> <span class="o">=</span> <span class="s1">&#39;\[hta\-chsnk\-mixer\]: unducking streams&#39;</span>
    <span class="n">MIXER_INLINE_DUCKING</span> <span class="o">=</span> <span class="s1">&#39;\[inline\-mixer\]: ducking streams&#39;</span>
    <span class="n">MIXER_INLINE_UN_DUCKING</span> <span class="o">=</span> <span class="s1">&#39;\[inline\-mixer\]: unducking streams&#39;</span>

    <span class="c1"># &quot;[0]&quot; is the API ID from: http://bootleg:1400/status/api</span>
    <span class="c1"># &quot;1&quot; in &quot;playback:1#play()&quot; is the API version.</span>
    <span class="c1"># [1970-01-02 22:46:14.655] &lt;muse,3&gt; [0] Received command playback:1#play()</span>
    <span class="c1"># [1970-01-02 22:46:14.663] &lt;muse,3&gt; [0] Responded success=true(type=none) to playback:1#play()</span>
    <span class="c1"># [1970-01-02 22:46:23.785] &lt;muse,3&gt; [0] Received command playerVolume:1#setVolume()</span>
    <span class="c1"># [1970-01-02 22:46:23.793] &lt;muse,3&gt; [0] Responded success=true(type=none) to playerVolume:1#setVolume()</span>
    <span class="c1"># [1970-01-02 22:46:38.403] &lt;muse,3&gt; [0] Received command playback:1#skipToNextTrack()</span>
    <span class="c1"># [1970-01-02 22:46:38.424] &lt;muse,3&gt; [0] Responded success=true(type=none) to playback:1#skipToNextTrack()</span>
    <span class="c1"># [1970-01-02 22:47:07.322] &lt;muse,3&gt; [0] Received command playback:1#pause()</span>
    <span class="c1"># [1970-01-02 22:47:07.373] &lt;muse,3&gt; [0] Responded success=true(type=none) to playback:1#pause()</span>

    <span class="c1"># [1970-01-01 00:09:10.420] &lt;muse,3&gt; [0] Received command playerVolume:1#getVolume(f9003319e68811e7858cf5b86bd3db80)</span>
    <span class="c1"># [1970-01-01 00:09:10.420] &lt;muse,3&gt; [0] Sent response (success=true,type=playerVolume) to playerVolume:1#getVolume(f9003319e68811e7858cf5b86bd3db80)</span>
    <span class="n">MUSE_RECEIVED_COMMAND_REGEX_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;\[(?P&lt;lechmere_id&gt;\d+)\] Received command\s+(?P&lt;namespace&gt;[^:]+):&#39;</span> \
                                          <span class="s1">&#39;(?P&lt;api_ver&gt;\d+)#(?P&lt;command&gt;\w+)\(.*\)&#39;</span>
    <span class="n">MUSE_RESPONDED_SUCCESS_REGEX_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;\[(?P&lt;lechmere_id&gt;\d+)\] Sent response\s+\(success=(?P&lt;success&gt;\w+),&#39;</span> \
                                           <span class="s1">&#39;type=(?P&lt;namespace_type&gt;\w+)\) to (?P&lt;namespace&gt;\w+):&#39;</span> \
                                           <span class="s1">&#39;(?P&lt;api_ver&gt;\d+)#(?P&lt;command&gt;\w+)\(.*\)&#39;</span>
    <span class="n">MUSE_RESPONDED_REGEX_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;\[(?P&lt;lechmere_id&gt;\d+)\] Responded success=(?P&lt;success&gt;\w+)\(type=(?P&lt;type&gt;\w+)\)&#39;</span> \
                                   <span class="s1">&#39; to (?P&lt;namespace&gt;[^:]+):(?P&lt;api_ver&gt;\d+)#(?P&lt;command&gt;\w+)\(.*\)&#39;</span>

    <span class="c1"># [1970-01-01 04:21:39.442] &lt;reporting,2&gt; voice:eventType,UtteranceUpload,</span>
    <span class="c1"># win,239.000000,</span>
    <span class="c1"># wwd0,108.000000,</span>
    <span class="c1"># wwd1,239.000000,</span>
    <span class="c1"># wwd2,0.000000,</span>
    <span class="c1"># wwDirection,11,</span>
    <span class="c1"># localSilence,false,</span>
    <span class="c1"># service,avs2,</span>
    <span class="c1"># dialogId,7828CA000AF6t59CE8DF5x00000078,</span>
    <span class="c1"># doneTime,2017-09-29T18:16:27.442Z,</span>
    <span class="c1"># opMs,6344,</span>
    <span class="c1"># samples,49600,</span>
    <span class="c1"># success,true,</span>
    <span class="c1"># serviceCode,0,</span>
    <span class="c1"># timeout,false,</span>
    <span class="c1"># rcvdResponse,true</span>
    <span class="n">REPORTING_VOICE_UTTERENCE_UPLOAD</span> <span class="o">=</span> <span class="s1">&#39;voice:eventType,UtteranceUpload,&#39;</span> \
                                       <span class="s1">&#39;\s*win,\s*(?P&lt;win&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*wwd0,\s*(?P&lt;wwd0&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*wwd1,\s*(?P&lt;wwd1&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*wwd2,\s*(?P&lt;wwd2&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*wwDirection,\s*(?P&lt;wwDirection&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;(\s*wwEngine,\s*(?P&lt;wwEngine&gt;[^,]+),)?&#39;</span> \
                                       <span class="s1">&#39;(\s*wwSensitivity,\s*(?P&lt;wwSensitivity&gt;[^,]+),)?&#39;</span> \
                                       <span class="s1">&#39;\s*localSilence,\s*(?P&lt;localSilence&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*service,\s*(?P&lt;service&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*dialogId,\s*(?P&lt;dialogId&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*doneTime,\s*(?P&lt;doneTime&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*opMs,\s*(?P&lt;opMs&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*samples,\s*(?P&lt;samples&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*success,\s*(?P&lt;success&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*serviceCode,\s*(?P&lt;serviceCode&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*timeout,\s*(?P&lt;timeout&gt;[^,]+),&#39;</span> \
                                       <span class="s1">&#39;\s*rcvdResponse,\s*(?P&lt;rcvdResponse&gt;[^,]+)&#39;</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    [1970-01-07 20:53:58.128] &lt;thread,2&gt; asyncfileio id:1973736512 pid:4121 Terminating</span>
<span class="sd">    [1970-01-07 20:53:58.128] &lt;thread,2&gt; asyncfileio id:1973736512 pid:4121 Joining</span>
<span class="sd">    [1970-01-07 20:53:58.129] &lt;thread,2&gt; watchdog id:1983177792 pid:4120 Terminating</span>
<span class="sd">    [1970-01-07 20:53:58.129] &lt;thread,2&gt; watchdog id:1983177792 pid:4120 Joining</span>
<span class="sd">    [1970-01-07 20:53:58.212] &lt;thread,2&gt; main id:1996051792 pid:4213 Running</span>
<span class="sd">    [1970-01-07 20:53:58.214] &lt;thread,2&gt; watchdog id:1983554624 pid:4217 Starting</span>
<span class="sd">    [1970-01-07 20:53:58.244] &lt;thread,2&gt; asyncfileio id:1974113344 pid:4218 Starting</span>
<span class="sd">    [1970-01-07 20:53:58.264] &lt;thread,2&gt; nodetx_chsrc id:1955046464 pid:4219 Starting</span>
<span class="sd">    [1970-01-07 20:53:58.352] &lt;thread,2&gt; evt_dispatch id:1934771264 pid:4220 Starting</span>
<span class="sd">    [1970-01-07 20:53:58.385] &lt;thread,2&gt; mixthrd id:1926190144 pid:4221 Starting</span>
<span class="sd">    [1970-01-07 20:53:58.385] &lt;cpuafm,2&gt; set affinity 1 for mixthrd, category cpu-affinity-sink-playback</span>
<span class="sd">    [1970-01-07 20:53:59.068] &lt;thread,2&gt; sntp_server id:1917572160 pid:4222 Starting</span>
<span class="sd">    [1970-01-07 20:54:00.307] &lt;thread,2&gt; airplay_main id:1909183552 pid:4224 Starting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># name is 16 bytes long...pthread_setname_np only mentioned that it is null terminated.</span>
    <span class="c1"># I am assuming space is allowed.</span>
    <span class="n">THREADS_TERMINATING_REGEX_PATTERN</span> <span class="o">=</span> <span class="s2">&quot;(?P&lt;thread_name&gt;\w+) id:(?P&lt;tid&gt;\d+)\s+pid:(?P&lt;pid&gt;\d+)\s+Terminating&quot;</span>
    <span class="n">THREADS_JOINING_REGEX_PATTERN</span> <span class="o">=</span> <span class="s2">&quot;(?P&lt;thread_name&gt;\w+) id:(?P&lt;tid&gt;\d+)\s+pid:(?P&lt;pid&gt;\d+)\s+Joining&quot;</span>
    <span class="n">THREADS_STARTING_REGEX_PATTERN</span> <span class="o">=</span> <span class="s2">&quot;(?P&lt;thread_name&gt;\w+) id:(?P&lt;tid&gt;\d+)\s+pid:(?P&lt;pid&gt;\d+)\s+Starting&quot;</span>
    <span class="n">CPUAFM_SETAFF_REGEX_PATTERN</span> <span class="o">=</span> <span class="s2">&quot;set affinity (?P&lt;cpu_mask&gt;\d+) for (?P&lt;thread_name&gt;\w+), category (?P&lt;cpu_cat&gt;\w+)&quot;</span>

    <span class="c1"># [1970-01-03 02:55:28.007] &lt;chsnkfill,3&gt; now:59   min:58   max:59</span>
    <span class="n">CHSNKFILL_REGEX_PATTERN</span> <span class="o">=</span> <span class="s2">&quot;now:(?P&lt;now&gt;\d+)\s+min:(&quot;</span> \
                               <span class="s2">&quot;?P&lt;min&gt;\d+)\s+max:(?P&lt;max&gt;\d+)&quot;</span>

    <span class="c1"># [1970-01-07 00:32:11.527] &lt;dolby,2&gt; old data burst AC-3, new Unknown; st ST_DOLBY</span>
    <span class="n">DOLBY_DATA_BURST_REGEX_PATTERN</span> <span class="o">=</span> <span class="s2">&quot;old data burst\s+(?P&lt;old_burst&gt;[\w-]+),&quot;</span> \
                                     <span class="s2">&quot;\s+new\s+(?P&lt;new_burst&gt;[\w-]+);&quot;</span> \
                                     <span class="s2">&quot;\s+st\s+(?P&lt;st&gt;[\w-]+)&quot;</span>
    <span class="c1"># [1970-01-07 00:32:11.638] &lt;dolby,2&gt; transitioning from ST_DOLBY to ST_TRANSITIONAL_DOLBY; reset</span>
    <span class="n">DOLBY_TRANSITION_REGEX_PATTERN</span> <span class="o">=</span> <span class="s2">&quot;transitioning from\s+(&quot;</span> \
                                     <span class="s2">&quot;?P&lt;transition_from&gt;[\w-]+)&quot;</span> \
                                     <span class="s2">&quot;\s+to\s+(?P&lt;transition_to&gt;[\w-]+)[;]?&quot;</span> \
                                     <span class="s2">&quot;\s*(?P&lt;transition_ctx_str&gt;[\w-]+)&quot;</span>
    <span class="c1"># # [1970-01-07 00:32:32.489] &lt;dolby,2&gt; switching stream type from ST_DOLBY to ST_TRANSITIONAL_DOLBY pcmStatus 1 encoded content(a) 1 encoded content(b) 1 pcmValid 0 burst type -1 rc 11</span>
    <span class="n">DOLBY_SWITCHING_REGEX_PATTERN</span> <span class="o">=</span> <span class="s2">&quot;switching stream type &quot;</span> \
                                    <span class="s2">&quot;from\s+(?P&lt;stream_from&gt;[\w-]+)\s+&quot;</span> \
                                    <span class="s2">&quot;to\s+(?P&lt;stream_to&gt;[\w-]+)\s+&quot;</span> \
                                    <span class="s2">&quot;pcmStatus\s+(?P&lt;pcm_status&gt;\d+)\s+&quot;</span> \
                                    <span class="s2">&quot;encoded content\(a\)\s+(?P&lt;encoded_content_a&gt;\d+)\s+&quot;</span> \
                                    <span class="s2">&quot;encoded content\(b\)\s+(?P&lt;encoded_content_b&gt;\d+)\s+&quot;</span> \
                                    <span class="s2">&quot;pcmValid\s+(?P&lt;pcm_valid&gt;\d+)\s+&quot;</span> \
                                    <span class="s2">&quot;burst type\s+(?P&lt;burst_type&gt;[-\d]+)\s+&quot;</span> \
                                    <span class="s2">&quot;rc\s+(?P&lt;rc&gt;[-\d]+)&quot;</span>
    <span class="c1"># # [1970-01-07 00:32:12.332] &lt;spdif,2&gt; old burst type -1 new burst type 1</span>
    <span class="n">SPDIF_BURST_REGEX_PATTERN</span> <span class="o">=</span> <span class="s2">&quot;old burst type\s+(?P&lt;old_type&gt;[-\d]+)\s+&quot;</span> \
                                <span class="s2">&quot;new burst type\s+(?P&lt;new_type&gt;[-\d]+)&quot;</span>

    <span class="n">MIXTHRD_DEV_WRITE_ERR_PATTERN</span> <span class="o">=</span> <span class="s2">&quot;sound device write error:\s+(?P&lt;err&gt;[\d]+),&quot;</span> \
                                    <span class="s2">&quot;\s+od:\s+(?P&lt;od&gt;[\d]+),&quot;</span> \
                                    <span class="s2">&quot;\s+od1:\s+(?P&lt;od1&gt;[\d]+)&quot;</span>
    <span class="n">WATCH_METRICS</span> <span class="o">=</span> \
        <span class="p">{</span>
            <span class="s1">&#39;attenuation&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">2</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;fade added:&#39;</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;avs2&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">5</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;utterance preamble:&#39;</span><span class="p">,</span>
                    <span class="c1"># [1970-01-02 23:12:44.201] &lt;avs2,4&gt; sending event:</span>
                    <span class="c1"># {&quot;event&quot;:{&quot;header&quot;:{&quot;namespace&quot;:&quot;SpeechRecognizer&quot;,</span>
                    <span class="c1"># &quot;name&quot;:&quot;ReportEchoSpatialPerceptionData&quot;,</span>
                    <span class="c1"># &quot;messageId&quot;:&quot;7828CA100506t59A85B2Dx00000088&quot;,</span>
                    <span class="c1"># &quot;dialogRequestId&quot;:&quot;7828CA100506t59A85B2Dx00000087&quot;},</span>
                    <span class="c1"># &quot;payload&quot;:{&quot;voiceEnergy&quot;:1011345.5625,&quot;ambientEnergy&quot;:503066.90625}}}</span>
                    <span class="s1">&#39;sending event&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Parsed directive&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;recv&#39;d msg:&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;cpuafm&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">2</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">CPUAFM_SETAFF_REGEX_PATTERN</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;chsrc&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">3</span><span class="p">:</span> <span class="p">[</span>
                    <span class="c1"># Time to read the first frame of the payload, before deocding.  Question: Time from when?</span>
                    <span class="c1"># This prints *immediately* upon reading the first frame.</span>
                    <span class="c1"># [1970-01-01 22:20:41.805] &lt;chsrc,3&gt; m4a-m4a: time to first byte 77&quot;</span>
                    <span class="c1"># [1970-01-01 22:20:51.348] &lt;chsrc,3&gt; ogg: time to first byte 85&quot;</span>
                    <span class="c1"># [1970-01-01 22:20:08.819] &lt;chsrc,3&gt; wma: time to first byte 61&quot;</span>
                    <span class="c1"># [1970-01-01 22:20:14.776] &lt;chsrc,3&gt; aiff: time to first byte 14&quot;</span>
                    <span class="c1"># [1970-01-01 22:20:00.643] &lt;chsrc,3&gt; wav: time to first byte 35&quot;</span>
                    <span class="c1"># [1970-01-01 21:52:00.160] &lt;chsrc,3&gt; spotify-nts: time to first byte 215&quot;</span>
                    <span class="s1">&#39;time to first byte&#39;</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;chsnkfill&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">3</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">CHSNKFILL_REGEX_PATTERN</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;dolby&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">5</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">DOLBY_DATA_BURST_REGEX_PATTERN</span><span class="p">,</span>
                    <span class="n">DOLBY_TRANSITION_REGEX_PATTERN</span><span class="p">,</span>
                    <span class="n">DOLBY_SWITCHING_REGEX_PATTERN</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;duck&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">2</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">DUCK_EXT_AUDIO_SRC_PLAYING</span><span class="p">,</span>
                    <span class="n">DUCK_EXT_AUDIO_SRC_STOPPED</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;htap&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">3</span><span class="p">:</span> <span class="p">[</span>
                    <span class="c1"># [1970-01-01 18:05:42.549] &lt;htap,3&gt; audio external req. old 0 new 1 thread state 1</span>
                    <span class="c1"># [1970-01-01 18:05:50.255] &lt;htap,3&gt; audio external req. old 1 new 0 thread state 1</span>
                    <span class="n">HTAP_EXT_AUDIO_SRC_PLAYING</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;main&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">0</span><span class="p">:</span> <span class="p">[</span>
                    <span class="c1"># &lt;main,0&gt; RealTime is [Wed Jul 12 18:46:14 2017] (off=1499870451)</span>
                    <span class="n">MAIN_REAL_TIME_REGEX_PATTERN</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;mixer&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">3</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;\[hta\-chsnk\-mixer\]: ducking flags&#39;</span><span class="p">,</span>
                    <span class="n">MIXER_DEFAULT_DUCKING</span><span class="p">,</span>
                    <span class="n">MIXER_DEFAULT_UN_DUCKING</span><span class="p">,</span>
                    <span class="n">MIXER_HTA_CHSNK_DUCKING</span><span class="p">,</span>
                    <span class="n">MIXER_HTA_CHSNK_UN_DUCKING</span><span class="p">,</span>
                    <span class="n">MIXER_INLINE_DUCKING</span><span class="p">,</span>
                    <span class="n">MIXER_INLINE_UN_DUCKING</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;mixthrd&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">3</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">MIXTHRD_DEV_WRITE_ERR_PATTERN</span>
                <span class="p">]</span>
            <span class="p">},</span>

            <span class="s1">&#39;muse&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">3</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">MUSE_RECEIVED_COMMAND_REGEX_PATTERN</span><span class="p">,</span>
                    <span class="n">MUSE_RESPONDED_SUCCESS_REGEX_PATTERN</span><span class="p">,</span>
                    <span class="n">MUSE_RESPONDED_REGEX_PATTERN</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;reporting&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">2</span><span class="p">:</span> <span class="p">[</span>
                    <span class="c1"># This prints *at the end* of a track (or when it transitions to the next track?)</span>
                    <span class="c1"># The fb,xxx value is the first byte time in msecs.  It should match what was in:</span>
                    <span class="c1">#   &lt;chsrc,3&gt; m4a-m4a: time to first byte xxx&quot;</span>
                    <span class="c1"># [1970-01-01 22:20:36.807] &lt;reporting,2&gt; chsrc:framed:type,m4a-m4a,ms,11157,fb,69,mode,n,ss,1&quot;</span>
                    <span class="c1"># [1970-01-01 22:20:51.259] &lt;reporting,2&gt; chsrc:framed:type,ogg,ms,18146,fb,70,mode,n,ss,1&quot;</span>
                    <span class="c1"># [1970-01-01 22:20:30.313] &lt;reporting,2&gt; chsrc:framed:type,aiff,ms,8568,fb,21,mode,sc,ss,1&quot;</span>
                    <span class="c1"># [1970-01-01 22:20:10.969] &lt;reporting,2&gt; chsrc:framed:type,wma,ms,9229,fb,61,mode,sc,ss,1&quot;</span>
                    <span class="c1"># [1970-01-01 22:19:55.021] &lt;reporting,2&gt; chsrc:framed:type,wav,ms,8489,fb,3,mode,n,ss,1&quot;</span>
                    <span class="s1">&#39;chsrc:framed&#39;</span><span class="p">,</span>
                    <span class="n">REPORTING_VOICE_UTTERENCE_UPLOAD</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;spdif&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">2</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">SPDIF_BURST_REGEX_PATTERN</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;threads&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">2</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">THREADS_STARTING_REGEX_PATTERN</span><span class="p">,</span>
                    <span class="n">THREADS_TERMINATING_REGEX_PATTERN</span><span class="p">,</span>
                    <span class="n">THREADS_JOINING_REGEX_PATTERN</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;voictrlr&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">3</span><span class="p">:</span> <span class="p">[</span>
                    <span class="c1"># [1970-01-01 03:24:25.561] &lt;voictrlr,3&gt; handleWakeWordDetected [311.00|1] 2 c:1 f:1 n:0</span>
                    <span class="s1">&#39;handleWakeWordDetected&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;handleUploadFinishing&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;handleUploadFinished&#39;</span>
                <span class="p">]</span>

            <span class="p">}</span>
        <span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SWPBL-71453: [Sol] &quot;Audio Delay (Lip sync)&quot; settings caused periodic dropouts (user reported 3 min 23 seconds when at max delay)</span>
<span class="sd">    &lt;spdif,1&gt; reset spdif on overflow</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LLA_UNDERFLOW_CONDITIONAL_REGEX_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;underflow:\s+error\s+code\s+(?P&lt;error_code&gt;\d+):\s+uf\s+(&#39;</span> \
                                              <span class="s1">&#39;?P&lt;underflows&gt;\d+)&#39;</span>
    <span class="n">CHSNK_UNDERFLOW_CONDITIONAL_REGEX_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;LSE:\s+stream\s+underflow,\s+uf\s+(?P&lt;underflows&gt;\d+)&#39;</span>

    <span class="n">SOUND_WEMBLY_UNDERFLOW_CONDITIONAL_REGEX_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;start\s+of\s+playback:\s+\d+\s+s:\s+\d+\s+underflows\s+(&#39;</span> \
                                                       <span class="s1">&#39;?P&lt;underflows&gt;\d+)&#39;</span>
    <span class="n">HTASRC_SRC_VERBOSE_CONDITIONAL_REGEX_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;LE:\s+\[(?P&lt;LE&gt;-?[^\]]+)\]\s+LEP:\s+\[(?P&lt;LEP&gt;-?[&#39;</span> \
                                                   <span class="s1">&#39;^\]]+)\]\s+IC:\s*\[(?P&lt;IC&gt;-?[^\]]+)\]\s+ICP:\s+\[(?P&lt;ICP&gt;-?[&#39;</span> \
                                                   <span class="s1">&#39;^\]]+)\]&#39;</span>
    <span class="n">HTASRC_SRC_MUTING_CONDITIONAL_REGEX_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;Muting\s+SRC.\s+rate\s+=\s+(?P&lt;rate&gt;-?[^,]+),\s+error\s+=\s+(&#39;</span> \
                                                  <span class="s1">&#39;?P&lt;error&gt;-?[^,]+).*,\s+errmax\s+=\s+(?P&lt;errmax&gt;-?[^\s]+)&#39;</span>

    <span class="n">FATAL_ERRORS</span> <span class="o">=</span> \
        <span class="p">{</span>
            <span class="s1">&#39;chsnk&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">0</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;large sync error&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;request frame: network I/O error&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;synchronizedPlay: noderx I/O error&#39;</span>
                <span class="p">],</span>
                <span class="mi">1</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">CHSNK_UNDERFLOW_CONDITIONAL_REGEX_PATTERN</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;htap&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">1</span><span class="p">:</span> <span class="p">[</span>    <span class="c1"># SWPBL-66922</span>
                    <span class="s1">&#39;LSE: stream underflow&#39;</span>
                <span class="p">],</span>
                <span class="mi">3</span><span class="p">:</span> <span class="p">[</span>    <span class="c1"># SWPBL-48810</span>
                    <span class="s1">&#39;buffering might not be sufficient&#39;</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;htasrc&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">1</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">HTASRC_SRC_VERBOSE_CONDITIONAL_REGEX_PATTERN</span><span class="p">,</span>
                    <span class="n">HTASRC_SRC_MUTING_CONDITIONAL_REGEX_PATTERN</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;htsnk&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">0</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;failed to play samples&#39;</span>
                <span class="p">],</span>
                <span class="mi">2</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;stream underflow&#39;</span>
                <span class="p">]</span>
            <span class="p">},</span>

            <span class="s1">&#39;lla&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">0</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">LLA_UNDERFLOW_CONDITIONAL_REGEX_PATTERN</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;sound_wembley&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">1</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">SOUND_WEMBLY_UNDERFLOW_CONDITIONAL_REGEX_PATTERN</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;watchdog&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">0</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;WATCHDOG: &#39;</span>
                <span class="p">],</span>
            <span class="p">},</span>
            <span class="c1"># This is an error and should never happen.</span>
            <span class="s1">&#39;spdif&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">1</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;reset spdif on overflow$&#39;</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="n">ANACAPA_STRPTIME_FORMAT</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span>
    <span class="n">ANACAPA_LOG_EVENT_PATTERN_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;\s?\[(?P&lt;time&gt;[^\]]+)\]\s+&lt;(?P&lt;module&gt;[^\s]+),(?P&lt;level&gt;\d+)&gt;\s+(?P&lt;message&gt;{&quot;</span> \
                                         <span class="s2">&quot;}.*)$|.*&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # &quot;x-rincon-stream:RINCON_{}01400&quot; # Can be local or remote source</span>
<span class="sd">    # &quot;x-sonos-htastream:RINCON_{}01400:spdif&quot; # Always local spdif source</span>
<span class="sd">    # &quot;x-rincon:RINCON_{}01400&quot; # Always remote GC</span>
<span class="sd">    # &quot;x-rincon-queue:RINCON_{}01400#{}&quot; # Always local queue</span>

<span class="sd">    # HTSatChanMapSet</span>
<span class="sd">    # HT Master: RINCON_B8E93740151F01400:LF,RF;RINCON_5CAAFD080D4A01400:LR,LR;RINCON_5CAAFD0D407C01400:RR,RR</span>
<span class="sd">    # HT Sat: RINCON_B8E93740151F01400:LF,RF;RINCON_5CAAFD080D4A01400:LR,LR</span>
<span class="sd">    # HT Sat: RINCON_B8E93740151F01400:LF,RF;RINCON_5CAAFD0D407C01400:RR,RR</span>

<span class="sd">    # Sub: RINCON_5CAAFD300B1901400:LF,RF;RINCON_5CAAFD82A91C01400:SW,SW</span>

<span class="sd">    # Stereo</span>
<span class="sd">        str channel_map: description of channel map</span>
<span class="sd">            LF (left-front)</span>
<span class="sd">            RF (right-front)</span>
<span class="sd">            SW (subwoofer)</span>
<span class="sd">            syntax: &quot;&lt;UDN&gt;:LF,LF;&lt;UDN&gt;:RF,RF;&lt;UDN&gt;:SW,SW&quot;</span>
<span class="sd">            UDN = UDN of device in channel map</span>
<span class="sd">            example: &quot;000E58501235014001900:LF,LF;000E5850123401400:RF,RF;0000E588012340:SW,SW&quot;</span>
<span class="sd">            links 2 PLAY:5 devices to a SUB</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LINE_IN</span> <span class="o">=</span> <span class="s2">&quot;x-rincon-stream:&quot;</span>
    <span class="n">SPDIF</span> <span class="o">=</span> <span class="s2">&quot;x-sonos-htastream:&quot;</span>
    <span class="n">LOCAL_QUEUE</span> <span class="o">=</span> <span class="s2">&quot;x-rincon-queue:&quot;</span>
    <span class="n">GM</span> <span class="o">=</span> <span class="s2">&quot;x-rincon:&quot;</span>

    <span class="c1"># GetMediaInfo: CurrentURI</span>
    <span class="n">AVTransportURI_StateVariableName</span> <span class="o">=</span> <span class="s2">&quot;AVTransportURI&quot;</span>

    <span class="c1"># GetPositionInfo: TrackURI</span>
    <span class="n">CurrentTrackURI_StateVariableName</span> <span class="o">=</span> <span class="s2">&quot;CurrentTrackURI&quot;</span>
    <span class="c1"># GetPositionInfo: Track</span>
    <span class="n">CurrentTrack_StateVariableName</span> <span class="o">=</span> <span class="s2">&quot;CurrentTrack&quot;</span>
    <span class="c1"># GetPositionInfo: TrackMetaData</span>
    <span class="n">CurrentTrackMetaData_StateVariableName</span> <span class="o">=</span> <span class="s2">&quot;CurrentTrackMetaData&quot;</span>

    <span class="c1"># GetTransportInfo: CurrentTransportState</span>
    <span class="n">TransportState_StateVariableName</span> <span class="o">=</span> <span class="s2">&quot;TransportState&quot;</span>

    <span class="n">ChannelMapSet_StateVariableName</span> <span class="o">=</span> <span class="s2">&quot;ChannelMapSet&quot;</span>
    <span class="n">HTSatChanMapSet_StateVariableName</span> <span class="o">=</span> <span class="s2">&quot;HTSatChanMapSet&quot;</span>

    <span class="c1"># TODO: Find a place to store all tolerances for test code that corresponds to their h/w and s/w spec</span>
    <span class="n">HTASRC_TOLERANCE</span> <span class="o">=</span> <span class="mf">0.03</span>

    <span class="c1"># Throttle standard data collection for the same ZP to be at most once per below duration.</span>
    <span class="n">THROTTLED_STD_DATA_COLLECTION_PER_ZP_WINDOW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span>
        <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">)</span>

    <span class="c1"># Nanoseconds to look backwards and foward during failure analysis.</span>
    <span class="n">FAILURE_ANALYSIS_NEIGHBOURHOOD_LOOKBACK_NANOS</span> <span class="o">=</span> <span class="mi">10000000000</span>  <span class="c1"># 10 secs</span>
    <span class="n">FAILURE_ANALYSIS_NEIGHBOURHOOD_LOOKFORWARD_NANOS</span> <span class="o">=</span> <span class="mi">1000000000</span>  <span class="c1"># 1 sec</span>

    <span class="c1"># Nanoseconds to look backwards and foward during failure analysis.  This is the extended</span>
    <span class="c1"># neighbourhood for when a last change might be very very far back, like when a user</span>
    <span class="c1"># do not start playback immediately.</span>
    <span class="n">FAILURE_ANALYSIS_EXTENDED_NEIGHBOURHOOD_LOOKBACK_NANOS</span> <span class="o">=</span> <span class="mi">1800000000000</span>  <span class="c1"># 30 mins</span>
    <span class="n">FAILURE_ANALYSIS_EXTENDED_NEIGHBOURHOOD_LOOKFORWARD_NANOS</span> <span class="o">=</span> <span class="mi">1000000000</span>  <span class="c1"># 1 sec</span>

    <span class="c1"># Nanoseconds to look backwards and foward during transition analysis.</span>
    <span class="n">TRANSITION_ANALYSIS_NEIGHBOURHOOD_LOOKBACK_NANOS</span> <span class="o">=</span> <span class="mi">500000000</span>  <span class="c1"># 500 msecs</span>
    <span class="n">TRANSITION_ANALYSIS_NEIGHBOURHOOD_LOOKFORWARD_NANOS</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">udp_log_to_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">error_exclusion_arches_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">include_perf_stats_when_failure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">strict_configuration_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">enable_spdif_transition_discount</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param logger: Logger instance for logging.  If None, logs will be printed to stdout/stderr.</span>
<span class="sd">        :type logger: :class:`logging.Logger`</span>

<span class="sd">        :param udp_log_to_file: Do we want to store UDP logging to file</span>
<span class="sd">        :type udp_log_to_file: :bool:</span>

<span class="sd">        :param error_exclusion_arches_list: List of arches to exclude error</span>
<span class="sd">        :type error_exclusion_arches_list: :list:</span>

<span class="sd">        :param include_perf_stats_when_failure: Do we collect perf stats when failure</span>
<span class="sd">        :type include_perf_stats_when_failure: :bool:</span>

<span class="sd">        :param strict_configuration_check: Do we want to enforce strict</span>
<span class="sd">        configuration check?</span>
<span class="sd">        :type strict_configuration_check: :bool:</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__zps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All counters have the following nesting:</span>

<span class="sd">        self.query_matched_counters_xxx[zp1]</span>
<span class="sd">                                        :</span>
<span class="sd">        self.query_matched_counters_xxx[zp2]</span>
<span class="sd">                                        :</span>
<span class="sd">        self.query_matched_counters_xxx[zp3]</span>
<span class="sd">            self.query_matched_counters_xxx[zp3][diagc_module1]</span>
<span class="sd">                                                    :</span>
<span class="sd">            self.query_matched_counters_xxx[zp3][diagc_module2]</span>
<span class="sd">                                                    :</span>
<span class="sd">            self.query_matched_counters_xxx[zp3][diagc_module3]</span>
<span class="sd">                self.query_matched_counters_xxx[zp3][diagc_module3][udp_match_expr1]</span>
<span class="sd">                                                    :</span>
<span class="sd">                self.query_matched_counters_xxx[zp3][diagc_module3][udp_match_expr2]</span>
<span class="sd">                                                    :</span>
<span class="sd">                self.query_matched_counters_xxx[zp3][diagc_module3][udp_match_expr3]</span>
<span class="sd">                    where self.query_matched_counters_xxx[zp3][diagc_module3][udp_match_expr3]</span>
<span class="sd">                        is the counter of udp_match_expr3 that has been matched/detected</span>
<span class="sd">                            for diagc_module3</span>
<span class="sd">                                for zp3</span>
<span class="sd">                self.query_matched_counters_xxx[zp3][diagc_module3][udp_match_exprn]</span>
<span class="sd">            self.query_matched_counters_xxx[zp3][diagc_modulen]</span>
<span class="sd">        self.query_matched_counters_xxx[zpn]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_fatal</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_user</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_metrics</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__merged_errors</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__watch_string_dict_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__metrics_string_dict_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__additional_fatal_watch_string_dict_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)))</span>
        <span class="c1"># Dictionary of zp&#39;s list of tuples of (svc_name, var_name, cb) we want to monitor for a zp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Disable support for user to watch their own service states and callin into their callbacks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__allow_user_service_states_monitor</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Dictionary of zp&#39;s tracked states.  This is the last updated state variable of each ZP for the various svc.</span>
        <span class="c1"># It will by default create a state variable that is None unless assigned.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__raised</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__enable_raise</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__enable_fatal_error_check</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__prev_usr1_signal_handler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__usr_fatal_error_callback</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__signal_handling_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="c1"># Retain the last known max diag level so that subsequent lower levels will not overwrite it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__diag_max_levels</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__udp_log_to_file</span> <span class="o">=</span> <span class="n">udp_log_to_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data_collection_deque</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="c1"># For faster iterative fillna.  Remembers the last time of update, so we just need to fillna from here</span>
        <span class="c1"># Initialized to when the class was initialized so slicing will work (0 doesn&#39;t)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__start_datetime64</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_datetime64_now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__last_update_datetime64_index</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__start_datetime64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__louie_init</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__artifacts_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__artifacts_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__periodic_tasks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__include_perf_stats_when_failure</span> <span class="o">=</span> <span class="n">include_perf_stats_when_failure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__strict_configuration_check</span> <span class="o">=</span> <span class="n">strict_configuration_check</span>
        <span class="c1"># Dict of ZP&#39;s IC, key is ZP&#39;s uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__zp_ic</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># These are the Service state variables that we monitor internally</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__internal_watch_service_states_cb_tuple_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;DeviceProperties&quot;</span><span class="p">,</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">ChannelMapSet_StateVariableName</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;DeviceProperties&quot;</span><span class="p">,</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">HTSatChanMapSet_StateVariableName</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;AVTransport&quot;</span><span class="p">,</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">AVTransportURI_StateVariableName</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;AVTransport&quot;</span><span class="p">,</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">CurrentTrackURI_StateVariableName</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;AVTransport&quot;</span><span class="p">,</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">TransportState_StateVariableName</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;AVTransport&quot;</span><span class="p">,</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">CurrentTrack_StateVariableName</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># (&quot;AVTransport&quot;, UDPDiagnosticModuleMonitor.CurrentTrackMetaData_StateVariableName, None)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__timeframe_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="n">df_cols</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__internal_watch_service_states_cb_tuple_list</span><span class="p">)</span> <span class="o">+</span> \
                  <span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="s1">&#39;curl&#39;</span><span class="p">,</span> <span class="s1">&#39;expr&#39;</span><span class="p">,</span> <span class="s1">&#39;ip&#39;</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">df_cols</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">error_exclusion_arches_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_exclusion_arches_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__error_exclusion_arches_list</span> <span class="o">=</span> <span class="n">error_exclusion_arches_list</span>

        <span class="c1"># For ease of groupby operation to segment the data analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segment_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Initialize __last_perf_stats_collection to be</span>
        <span class="c1"># THROTTLED_STD_DATA_COLLECTION_PER_ZP_WINDOW before</span>
        <span class="c1"># start of test so that we will guarantee that perf stats will be</span>
        <span class="c1"># collected for first failure per ZP.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__last_perf_stats_collection</span> <span class="o">=</span> \
            <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__start_datetime64</span> <span class="o">-</span>
                        <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span>
                        <span class="n">THROTTLED_STD_DATA_COLLECTION_PER_ZP_WINDOW</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__perf_stats_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__enable_spdif_transition_discount</span> <span class="o">=</span> \
            <span class="n">enable_spdif_transition_discount</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__periodic_tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__periodic_tasks</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.memory_collection_function"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.memory_collection_function">[docs]</a>    <span class="k">def</span> <span class="nf">memory_collection_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Memory usage collection function using diag.get_memory_usage, add to timeline dataframe</span>
<span class="sd">        :param zp: Sonos Zone Component to execute the call in</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mem_usage</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_memory_usage</span><span class="p">()</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;Collecting /status/free&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mem-used&quot;</span><span class="p">:</span> <span class="n">mem_usage</span><span class="p">[</span><span class="s1">&#39;Used&#39;</span><span class="p">],</span>
            <span class="s2">&quot;mem-free&quot;</span><span class="p">:</span> <span class="n">mem_usage</span><span class="p">[</span><span class="s1">&#39;Free&#39;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_timeline_data</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.start_periodic_task"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.start_periodic_task">[docs]</a>    <span class="k">def</span> <span class="nf">start_periodic_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_secs</span><span class="p">,</span> <span class="n">periodic_func</span><span class="p">,</span> <span class="n">task_label</span><span class="p">,</span> <span class="o">*</span><span class="n">periodic_args</span><span class="p">,</span> <span class="o">**</span><span class="n">periodic_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start a periodic task.</span>

<span class="sd">        :param interval_secs: Interval in secs</span>
<span class="sd">        :param periodic_func: Callback</span>
<span class="sd">        :param task_label: Label for task</span>
<span class="sd">        :param periodic_args: args</span>
<span class="sd">        :param periodic_kwargs: kwargs</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_periodic_task</span><span class="p">(</span><span class="n">task_label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__periodic_tasks</span><span class="p">[</span><span class="n">task_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">PeriodicCallback</span><span class="p">(</span><span class="n">interval_secs</span><span class="p">,</span> <span class="n">periodic_func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__periodic_tasks</span><span class="p">[</span><span class="n">task_label</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">*</span><span class="n">periodic_args</span><span class="p">,</span> <span class="o">**</span><span class="n">periodic_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.stop_periodic_task"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.stop_periodic_task">[docs]</a>    <span class="k">def</span> <span class="nf">stop_periodic_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop periodic task.</span>

<span class="sd">        :param task_label: Label for task</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__periodic_tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__periodic_tasks</span><span class="p">[</span><span class="n">task_label</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__periodic_tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_label</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.start_periodic_memory_collection"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.start_periodic_memory_collection">[docs]</a>    <span class="k">def</span> <span class="nf">start_periodic_memory_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_secs</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to start periodic memory usage collection for ZPs</span>

<span class="sd">        :param interval_secs: Interval in secs</span>
<span class="sd">        :param zps: Sonos Zone Components we want to monitor</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_periodic_task</span><span class="p">(</span><span class="n">interval_secs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_collection_function</span><span class="p">,</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span> <span class="n">zp</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.stop_periodic_memory_collection"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.stop_periodic_memory_collection">[docs]</a>    <span class="k">def</span> <span class="nf">stop_periodic_memory_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the peridic memory usage collection for ZPs</span>
<span class="sd">        :param zps: Sonos Zone Components we want to stop monitor</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_periodic_task</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">__init_louie_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Setting up louie connection for </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">()&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">COHERENCE_ADD_DEVICE_SIGNAL</span><span class="p">,</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__device_added_callback</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Connecting </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">, internal callback: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">COHERENCE_ADD_DEVICE_SIGNAL</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__device_added_callback</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">louie_device_added_receiver</span> <span class="o">=</span> <span class="n">louie</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__device_added_callback</span><span class="p">,</span>
            <span class="c1"># Service wrappers *should* have been created/updated at this point.</span>
            <span class="n">COHERENCE_ADD_DEVICE_SIGNAL</span><span class="p">,</span>
            <span class="n">louie</span><span class="o">.</span><span class="n">Any</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Added </span><span class="si">{}</span><span class="s2"> into louie&#39;s _global_receivers_pool.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">louie_device_added_receiver</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Setting up louie connection for </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">COHERENCE_REMOVE_DEVICE_SIGNAL</span><span class="p">,</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__device_removed_callback</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Connecting </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">, internal callback: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">COHERENCE_REMOVE_DEVICE_SIGNAL</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__device_removed_callback</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">louie_device_removed_receiver</span> <span class="o">=</span> <span class="n">louie</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__device_removed_callback</span><span class="p">,</span>
            <span class="n">COHERENCE_REMOVE_DEVICE_SIGNAL</span><span class="p">,</span>
            <span class="n">louie</span><span class="o">.</span><span class="n">Any</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Added </span><span class="si">{}</span><span class="s2"> into louie&#39;s _global_receivers_pool.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">louie_device_removed_receiver</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__finit_louie_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Tearing down louie connection for </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">COHERENCE_REMOVE_DEVICE_SIGNAL</span><span class="p">,</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__device_removed_callback</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Dis-connecting </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">, internal callback: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">COHERENCE_REMOVE_DEVICE_SIGNAL</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__device_removed_callback</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">louie_device_removed_receiver</span> <span class="o">=</span> <span class="n">louie</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__device_removed_callback</span><span class="p">,</span>
            <span class="n">COHERENCE_REMOVE_DEVICE_SIGNAL</span><span class="p">,</span>
            <span class="n">louie</span><span class="o">.</span><span class="n">Any</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">{}</span><span class="s2"> from louie&#39;s _global_receivers_pool.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">louie_device_removed_receiver</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Tearing down louie connection for </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">()&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">COHERENCE_ADD_DEVICE_SIGNAL</span><span class="p">,</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__device_added_callback</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Dis-connecting </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">, internal callback: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">COHERENCE_ADD_DEVICE_SIGNAL</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__device_added_callback</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">louie_device_added_receiver</span> <span class="o">=</span> <span class="n">louie</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__device_added_callback</span><span class="p">,</span>
            <span class="n">COHERENCE_ADD_DEVICE_SIGNAL</span><span class="p">,</span>
            <span class="n">louie</span><span class="o">.</span><span class="n">Any</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">{}</span><span class="s2"> from louie&#39;s _global_receivers_pool.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">louie_device_added_receiver</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;UDP Monitoring for ZP(s) </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__zps</span><span class="p">)</span>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.merge_expressions_dict"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.merge_expressions_dict">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">merge_expressions_dict</span><span class="p">(</span><span class="n">exprs_dict_a</span><span class="p">,</span> <span class="n">exprs_dict_b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge 2 expressions dictionary.</span>

<span class="sd">        :param exprs_dict_a: Dictionary of diag module as key with embedded dict where level is key and value</span>
<span class="sd">                             is a list of watch strings</span>
<span class="sd">        :type exprs_dict_a: :obj:`dict`</span>

<span class="sd">        :param exprs_dict_b: Dictionary of diag module as key with embedded dict where level is key and value</span>
<span class="sd">                             is a list of watch strings</span>
<span class="sd">        :type exprs_dict_b: :obj:`dict`</span>

<span class="sd">        :return: Merged dictionary of above 2 dictionaries of diag module as key with embedded dict where level</span>
<span class="sd">                 is key and value is a list of watch strings</span>
<span class="sd">        :rtype: :obj:`dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">merged_exprs_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">exprs_dict_a</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k2</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">v1</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged_exprs_dict</span><span class="p">:</span>
                    <span class="n">merged_exprs_dict</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
                <span class="n">merged_exprs_dict</span><span class="p">[</span><span class="n">k1</span><span class="p">][</span><span class="n">k2</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>

        <span class="c1"># User fatal strings</span>
        <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">exprs_dict_b</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k2</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">v1</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged_exprs_dict</span><span class="p">:</span>
                    <span class="n">merged_exprs_dict</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
                <span class="n">merged_exprs_dict</span><span class="p">[</span><span class="n">k1</span><span class="p">][</span><span class="n">k2</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">merged_exprs_dict</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_exprs_set_from_dict"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_exprs_set_from_dict">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_exprs_set_from_dict</span><span class="p">(</span><span class="n">exprs_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return just the list of expressions string from the expressions dictionary.</span>

<span class="sd">        :param exprs_dict: Dictionary of diag module as key with embedded dict where level is key and value</span>
<span class="sd">                             is a list of watch strings</span>
<span class="sd">        :type exprs_dict: :obj:`dict`</span>

<span class="sd">        :return: List of all the expression strings in exprs_dict</span>
<span class="sd">        :rtype: :list:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
                      <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">y</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">exprs_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.set_artifacts_dir"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.set_artifacts_dir">[docs]</a>    <span class="k">def</span> <span class="nf">set_artifacts_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artifacts_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the artifacts directory.  All artifacts produced by this class will be saved there.</span>

<span class="sd">        :param artifacts_dir: The artifacts directory.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__artifacts_dir</span> <span class="o">=</span> <span class="n">artifacts_dir</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_artifacts_dir"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_artifacts_dir">[docs]</a>    <span class="k">def</span> <span class="nf">get_artifacts_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the artifacts directory.</span>
<span class="sd">        :return: The artifacts directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__artifacts_dir</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.set_artifacts_prefix"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.set_artifacts_prefix">[docs]</a>    <span class="k">def</span> <span class="nf">set_artifacts_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artifacts_prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the artifacts prefix.  All artifacts produced by this class will have the prefix.</span>

<span class="sd">        :param artifacts_prefix: The artifacts prefix.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__artifacts_prefix</span> <span class="o">=</span> <span class="n">artifacts_prefix</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_artifacts_prefix"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_artifacts_prefix">[docs]</a>    <span class="k">def</span> <span class="nf">get_artifacts_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the artifacts prefix.</span>
<span class="sd">        :return: The artifacts prefix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__artifacts_prefix</span></div>

    <span class="k">def</span> <span class="nf">__device_added_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback when device added detected.</span>

<span class="sd">        :param device: The coherence RootDevice detected.</span>
<span class="sd">        :type device: :class:`~coherence.upnp.core.device.RootDevice`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;__device_added_callback: Device </span><span class="si">{}</span><span class="s2"> added.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
        <span class="c1"># We need to find the SonosZoneComponent that has device as its RootDevice.</span>
        <span class="n">zp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zones_to_update_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zone</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">udn</span> <span class="o">==</span> <span class="n">device</span><span class="o">.</span><span class="n">udn</span> <span class="ow">and</span> <span class="n">zone</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="n">device</span><span class="p">:</span>
                <span class="n">zp</span> <span class="o">=</span> <span class="n">zone</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">zp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Automatically resubscribe all services for state variables we are monitoring.</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__subscribe_to_monitoring_services</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span>
                <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__start_monitor_service_states</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]):</span>
                        <span class="c1"># Sync service states with local cache</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__sync_monitored_service_states</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="s2">&quot;__device_added_callback did not __start_monitor_service_states due to </span><span class="si">{}</span><span class="s2"> not in </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="s2">&quot;__device_added_callback did not __start_monitor_service_states due to </span><span class="si">{}</span><span class="s2"> not in </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="s2">&quot;__device_added_callback did not __start_monitor_service_states due to zp being None.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__subscribe_to_monitoring_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">zp_watch_service_states_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subscribes to list of Services we want to monitor.</span>

<span class="sd">        :param zp: Sonos ZP we want to monitor and subscribe for service&#39;s state variable changes</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Subscribing to service state variables </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp_watch_service_states_dict</span><span class="p">,</span> <span class="n">zp</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">svc_name</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">zp_watch_service_states_dict</span><span class="p">)):</span>
            <span class="c1"># svc = zp.find_service(svc_name)   # Retuns the Service and not the ServiceWrapper</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">svc_name</span><span class="p">):</span>
                <span class="n">svc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">svc_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">svc</span><span class="o">.</span><span class="n">is_subscribed</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">svc</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_sid</span><span class="p">():</span>
                        <span class="n">svc</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">force_remove</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">svc</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;Subscribed to &lt;</span><span class="si">{}</span><span class="s2">&gt; state variables for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">svc_name</span><span class="p">,</span> <span class="n">zp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Subscribed to service state variables </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp_watch_service_states_dict</span><span class="p">,</span> <span class="n">zp</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__device_removed_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback when device removed detected.</span>

<span class="sd">        :param usn: USN of Sonos device</span>
<span class="sd">        :type usb: &quot;str:</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">udn</span> <span class="o">=</span> <span class="n">extract_udn_from_usn</span><span class="p">(</span><span class="n">usn</span><span class="p">)</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">udn</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;__device_removed_callback: Device </span><span class="si">{}</span><span class="s2"> removed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">:</span>
            <span class="c1"># Do we want to unsubscribe all services?  Is it possible since the device might not be &quot;around&quot;?</span>
            <span class="k">if</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__stop_monitor_service_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span><span class="s2">&quot;szc&quot;</span><span class="p">],</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">[</span><span class="n">uuid</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="s2">&quot;__device_removed_callback did not __stop_monitor_service_states due to </span><span class="si">{}</span><span class="s2"> not in </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="s2">&quot;__device_removed_callback did not __stop_monitor_service_states due to </span><span class="si">{}</span><span class="s2"> not in </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">))</span>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_counters"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_counters">[docs]</a>    <span class="k">def</span> <span class="nf">get_counters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the (user counters, fatal counters, metrics counters) tuple</span>

<span class="sd">        :param zp: Sonos ZP for querying matched expression in logs</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :return: (user counters, fatal counters, metrics counters) tuple for zp</span>
<span class="sd">        :rtype: :obj: :tuple:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_user</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_fatal</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_metrics</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_row_by_dt64"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_row_by_dt64">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_row_by_dt64</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dt64</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;US/Eastern&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dt64</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt64</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">tz</span><span class="o">=</span><span class="n">tz</span><span class="p">)</span><span class="o">.</span><span class="n">to_datetime64</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt64</span><span class="p">]</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.timestring_to_timstamp"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.timestring_to_timstamp">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">timestring_to_timstamp</span><span class="p">(</span><span class="n">ts_str</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;US/Eastern&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        eg: &#39;2016-12-28 18:11:30.808041216-05:00&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">ts_str</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">tz</span><span class="p">)</span>
        <span class="n">start_dt64</span> <span class="o">=</span> <span class="n">start_ts</span><span class="o">.</span><span class="n">to_datetime64</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">start_ts</span><span class="p">,</span> <span class="n">start_dt64</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.df_to_confluence_html"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.df_to_confluence_html">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">df_to_confluence_html</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">to_html</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_timeframe_neighbourhood"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_timeframe_neighbourhood">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_timeframe_neighbourhood</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                                    <span class="n">start_ts</span><span class="p">,</span>
                                    <span class="n">nanos_before</span><span class="o">=</span><span class="n">FAILURE_ANALYSIS_NEIGHBOURHOOD_LOOKBACK_NANOS</span><span class="p">,</span>
                                    <span class="n">nanos_after</span><span class="o">=</span><span class="n">FAILURE_ANALYSIS_NEIGHBOURHOOD_LOOKFORWARD_NANOS</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the dataframe from [start_ts-nanos_before:start_ts+nanos_after]</span>

<span class="sd">        :param df: DataFrame to select from.  Must have DateTimeIndex as its indices.</span>
<span class="sd">        :type df: :class:`~pandas.DataFrame`</span>

<span class="sd">        :param start_ts: Timestamp to be used to select nanos_before and nanos_after</span>
<span class="sd">        :type start_ts: :obj: `numpy.datetime64`</span>

<span class="sd">        :param nanos_before: Nanos before start_ts to include</span>
<span class="sd">        :type nanos_before: :obj: :int:</span>

<span class="sd">        :param nanos_after: Nanos after start_ts to include</span>
<span class="sd">        :type df: :obj: :int:</span>

<span class="sd">        :return: The selected dataframe</span>
<span class="sd">        :rtype: :class:`~pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ts_delta_ns_before</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">nanos_before</span><span class="p">)</span>
        <span class="n">ts_delta_ns_after</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">nanos_after</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">start_ts</span> <span class="o">-</span> <span class="n">ts_delta_ns_before</span><span class="p">:</span><span class="n">start_ts</span> <span class="o">+</span> <span class="n">ts_delta_ns_after</span><span class="p">]</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_following_timeline"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_following_timeline">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_following_timeline</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_ts</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns num_items of dataframe from timeindex.</span>

<span class="sd">        :param df: DataFrame to select from.  Must have DateTimeIndex as its indices.</span>
<span class="sd">        :type df: :class:`~pandas.DataFrame`</span>

<span class="sd">        :param start_ts: Timestamp to be used to select dataframe</span>
<span class="sd">        :type start_ts: :obj: `numpy.datetime64`</span>

<span class="sd">        :param num_items: Number of rows to return.</span>
<span class="sd">        :type num_items: :obj: :int:</span>

<span class="sd">        :return: The selected dataframe</span>
<span class="sd">        :rtype: :class:`~pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timeindex_iloc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">start_ts</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timeindex_iloc</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">num_items</span> <span class="o">+=</span> <span class="p">(</span><span class="n">timeindex_iloc</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">timeindex_iloc</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">timeindex_iloc</span> <span class="o">=</span> <span class="n">timeindex_iloc</span><span class="o">.</span><span class="n">start</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">timeindex_iloc</span><span class="p">:</span><span class="n">timeindex_iloc</span> <span class="o">+</span> <span class="n">num_items</span><span class="p">]</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_dataframe_with_non_null_value_for_column"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_dataframe_with_non_null_value_for_column">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_dataframe_with_non_null_value_for_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        T.B.D.</span>

<span class="sd">        :param df: DataFrame to select from.</span>
<span class="sd">        :type df: :class:`~pandas.DataFrame`</span>

<span class="sd">        :param col: Column name</span>
<span class="sd">        :type col: :obj: :str:</span>

<span class="sd">        :return: Selected dataframes</span>
<span class="sd">        :rtype: :class:`~pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span></div>

    <span class="c1"># noinspection PyRedundantParentheses</span>
<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_dataframe_with_columns_boolean_and_condition"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_dataframe_with_columns_boolean_and_condition">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_dataframe_with_columns_boolean_and_condition</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column_boolean_series_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        T.B.D.</span>
<span class="sd">        Example: error_window_df[18][(error_window_df[18].curl.isnull()) &amp; (error_window_df[18].model == &quot;S3&quot;)]</span>

<span class="sd">        :param df: DataFrame to select from.</span>
<span class="sd">        :type df: :class:`~pandas.DataFrame`</span>

<span class="sd">        :param column_boolean_series_list:</span>
<span class="sd">        :type column_boolean_series_list: :obj: :list: of :class:`pandas.Series`</span>

<span class="sd">        :return: Selected dataframes</span>
<span class="sd">        :rtype: :class:`~pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">column_boolean_series_list</span><span class="p">)]</span></div>

    <span class="c1"># noinspection PyRedundantParentheses</span>
<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_dataframe_with_columns_boolean_or_condition"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_dataframe_with_columns_boolean_or_condition">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_dataframe_with_columns_boolean_or_condition</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column_boolean_series_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        T.B.D.</span>
<span class="sd">        Example: error_window_df[18][(error_window_df[18].curl.isnull()) | (error_window_df[18].model == &quot;S3&quot;)]</span>

<span class="sd">        :param df: DataFrame to select from.</span>
<span class="sd">        :type df: :class:`~pandas.DataFrame`</span>

<span class="sd">        :param column_boolean_series_list:</span>
<span class="sd">        :type column_boolean_series_list: :obj: :list: of :class:`pandas.Series`</span>

<span class="sd">        :return: Selected dataframes</span>
<span class="sd">        :rtype: :class:`~pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">column_boolean_series_list</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">__process_metrics_in_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process metrics and put them in respective columns.  This is done in place!</span>

<span class="sd">        :param df: DataFrame to process metrics from.</span>
<span class="sd">        :type df: :class:`~pandas.DataFrame`</span>

<span class="sd">        :return: df with metrics columns in place</span>
<span class="sd">        :rtype: :class:`~pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Time to first byte metrics....</span>
        <span class="k">if</span> <span class="s2">&quot;framer&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="s2">&quot;Column </span><span class="si">{}</span><span class="s2"> will be over-written!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;framer&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;fb&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="s2">&quot;Column </span><span class="si">{}</span><span class="s2"> will be over-written!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;fb&quot;</span><span class="p">))</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">expr</span> <span class="o">==</span> <span class="s2">&quot;chsrc:framed&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;framer&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">expr</span> <span class="o">==</span> <span class="s2">&quot;chsrc:framed&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">comment</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">expr</span> <span class="o">==</span> <span class="s2">&quot;chsrc:framed&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;fb&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">expr</span> <span class="o">==</span> <span class="s2">&quot;chsrc:framed&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">comment</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">6</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">expr</span> <span class="o">==</span> <span class="s2">&quot;time to first byte&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;framer&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">expr</span> <span class="o">==</span> <span class="s2">&quot;time to first byte&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">comment</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">expr</span> <span class="o">==</span> <span class="s2">&quot;time to first byte&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;fb&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">expr</span> <span class="o">==</span> <span class="s2">&quot;time to first byte&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">comment</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">8</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.process_hdf_for_failure_analysis"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.process_hdf_for_failure_analysis">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">process_hdf_for_failure_analysis</span><span class="p">(</span><span class="n">hdf_file</span><span class="p">,</span>
                                         <span class="n">error_exprs_list</span><span class="p">,</span>
                                         <span class="n">nanos_before</span><span class="o">=</span><span class="n">FAILURE_ANALYSIS_NEIGHBOURHOOD_LOOKBACK_NANOS</span><span class="p">,</span>
                                         <span class="n">nanos_after</span><span class="o">=</span><span class="n">FAILURE_ANALYSIS_NEIGHBOURHOOD_LOOKFORWARD_NANOS</span><span class="p">,</span>
                                         <span class="n">fillna</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read in a HDF file and return dataframes to be used in failure analysis.</span>

<span class="sd">        :param hdf_file: H5 file for loading.  The key is always &#39;timeline&#39; for the dataframes that we are interested.</span>
<span class="sd">        :type hdf_file: :obj: :str: or :obj:`pandas.DataFrame`</span>

<span class="sd">        :param error_exprs_list: List of expressions that will be matched to determine error row.</span>
<span class="sd">        :type error_exprs_list: :list:</span>

<span class="sd">        :param nanos_before: Nanos before the error row we want to include in the neighbourhood of rows for failure analysis.</span>
<span class="sd">        :type nanos_before: :int:</span>

<span class="sd">        :param nanos_after: Nanos after the error row we want to include in the neighbourhood of rows for failure analysis.</span>
<span class="sd">        :type nanos_after: :int:</span>

<span class="sd">        :param fillna: Method to use for NA filling.  Refer to pandas.DataFrame.fillna</span>
<span class="sd">        :type fillna: :obj: :str:</span>

<span class="sd">        :return: Returns tuple of all dataframes, error dataframes and list of dataframes windowed around each error dataframe</span>
<span class="sd">        :rtype: :tuple: of (:class:`~pandas.DataFrame`, (:class:`~pandas.DataFrame`, :list: of :class:`~pandas.DataFrame`))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hdf_file</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">all_timeline_df</span> <span class="o">=</span> <span class="n">hdf_file</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hdf_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">all_timeline_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">hdf_file</span><span class="p">,</span> <span class="s1">&#39;timeline&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Un-supported type for hdf_file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">hdf_file</span><span class="p">)))</span>
        <span class="n">all_timeline_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">all_timeline_df</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">memory_usage</span><span class="o">=</span><span class="s1">&#39;deep&#39;</span><span class="p">)</span>

        <span class="c1"># Front fill columns BUT only per zone player...i.e. propagate last state variable as the current value</span>
        <span class="k">if</span> <span class="n">fillna</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_timeline_df</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">(),</span> <span class="n">all_timeline_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                    <span class="c1"># Use .loc index and then assigning to a copy of returned front filled columns</span>
                    <span class="n">row_indexer</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_timeline_df</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">uuid</span><span class="p">)</span>
                    <span class="n">col_indexer</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span>
                    <span class="n">all_timeline_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_indexer</span><span class="p">,</span> <span class="n">col_indexer</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">all_timeline_df</span><span class="p">[</span><span class="n">row_indexer</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Search for rows that has any of the expression in the comment field of the dataframe.</span>
        <span class="n">all_timeline_with_non_null_comments_df</span> <span class="o">=</span> <span class="n">all_timeline_df</span><span class="p">[</span><span class="o">~</span><span class="n">all_timeline_df</span><span class="o">.</span><span class="n">comment</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
        <span class="n">error_df</span> <span class="o">=</span> <span class="n">all_timeline_with_non_null_comments_df</span><span class="p">[</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">error_exprs_list</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">all_timeline_with_non_null_comments_df</span><span class="o">.</span><span class="n">comment</span><span class="p">)]</span>

        <span class="n">error_window_df_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">start_ts</span> <span class="ow">in</span> <span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">error_window_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_timeframe_neighbourhood</span><span class="p">(</span><span class="n">all_timeline_df</span><span class="p">,</span> <span class="n">start_ts</span><span class="p">,</span> <span class="n">nanos_before</span><span class="p">,</span>
                                                                           <span class="n">nanos_after</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">all_timeline_df</span><span class="p">,</span> <span class="p">(</span><span class="n">error_df</span><span class="p">,</span> <span class="n">error_window_df_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.print_nth_error"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.print_nth_error">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">print_nth_error</span><span class="p">(</span><span class="n">all_timeline_df</span><span class="p">,</span>
                        <span class="n">error_window_df</span><span class="p">,</span>
                        <span class="n">error_df</span><span class="p">,</span>
                        <span class="n">nth_error</span><span class="p">,</span>
                        <span class="n">nanos_back_for_transition_check</span><span class="o">=</span><span class="n">TRANSITION_ANALYSIS_NEIGHBOURHOOD_LOOKBACK_NANOS</span><span class="p">,</span>
                        <span class="n">nanos_after_for_transition_check</span><span class="o">=</span><span class="n">TRANSITION_ANALYSIS_NEIGHBOURHOOD_LOOKFORWARD_NANOS</span><span class="p">,</span>
                        <span class="n">nanos_before_failure_analysis</span><span class="o">=</span><span class="n">FAILURE_ANALYSIS_NEIGHBOURHOOD_LOOKBACK_NANOS</span><span class="p">,</span>
                        <span class="n">nanos_after_failure_analysis</span><span class="o">=</span><span class="n">FAILURE_ANALYSIS_NEIGHBOURHOOD_LOOKFORWARD_NANOS</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Help during failure analysis to print details of the nth error.</span>

<span class="sd">        :param all_timeline_df: all_timeline_df as returned from process_hdf_for_failure_analysis</span>
<span class="sd">        :type all_timeline_df: :class:`~pandas.DataFrame`</span>

<span class="sd">        :param error_window_df: error_window_df as returned from process_hdf_for_failure_analysis</span>
<span class="sd">        :type error_df: :class:`~pandas.DataFrame`</span>

<span class="sd">        :param error_df: error_df as returned from process_hdf_for_failure_analysis</span>
<span class="sd">        :type error_df: :list: of :class:`~pandas.DataFrame`</span>

<span class="sd">        :param nth_error: The error index you wany to print the details and also return the failure neighbourhood</span>
<span class="sd">        :type nth_error: :int:</span>

<span class="sd">        :param nanos_back_for_transition_check: Nanos before failure_datetime64_index to include in transition check</span>
<span class="sd">        :type nanos_back_for_transition_check: :int:</span>

<span class="sd">        :param nanos_after_for_transition_check: Nanos after failure_datetime64_index to include in transition check</span>
<span class="sd">        :type nanos_back_for_transition_check: :int:</span>

<span class="sd">        :param nanos_before_failure_analysis: Nanos before the error row we want to include in the neighbourhood of</span>
<span class="sd">            rows for failure analysis.</span>
<span class="sd">        :type nanos_back_for_transition_check: :int:</span>

<span class="sd">        :param nanos_after_failure_analysis: Nanos after the error row we want to include in the neighbourhood of</span>
<span class="sd">            rows for failure analysis.</span>
<span class="sd">        :type nanos_back_for_transition_check: :int:</span>

<span class="sd">        :return: The dataframe failure neighbourhood</span>
<span class="sd">        :rtype: :class:`~pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">htchanmapset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">chanmapset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">avturi</span> <span class="o">=</span> <span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]]</span><span class="o">.</span><span class="n">AVTransportURI</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">uuid</span> <span class="o">=</span> <span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]]</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]]</span><span class="o">.</span><span class="n">comment</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">],</span> <span class="s2">&quot;HTSatChanMapSet&quot;</span><span class="p">):</span>
                <span class="n">htchanmapset</span> <span class="o">=</span> <span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]]</span><span class="o">.</span><span class="n">HTSatChanMapSet</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">],</span> <span class="s2">&quot;ChannelMapSet&quot;</span><span class="p">):</span>
                <span class="n">chanmapset</span> <span class="o">=</span> <span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]]</span><span class="o">.</span><span class="n">ChannelMapSet</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]],</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]]</span><span class="o">.</span><span class="n">model</span>
            <span class="n">avturi</span> <span class="o">=</span> <span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]]</span><span class="o">.</span><span class="n">AVTransportURI</span>
            <span class="n">uuid</span> <span class="o">=</span> <span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]]</span><span class="o">.</span><span class="n">uuid</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]]</span><span class="o">.</span><span class="n">comment</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">],</span> <span class="s2">&quot;HTSatChanMapSet&quot;</span><span class="p">):</span>
                <span class="n">htchanmapset</span> <span class="o">=</span> <span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]]</span><span class="o">.</span><span class="n">HTSatChanMapSet</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">],</span> <span class="s2">&quot;ChannelMapSet&quot;</span><span class="p">):</span>
                <span class="n">chanmapset</span> <span class="o">=</span> <span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]]</span><span class="o">.</span><span class="n">ChannelMapSet</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">Error #</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nth_error</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Time of failure: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">]))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Model: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;AVTransportURI: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avturi</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Model: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">],</span> <span class="s2">&quot;HTSatChanMapSet&quot;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;HTSatChanMapSet: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">htchanmapset</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">error_window_df</span><span class="p">[</span><span class="n">nth_error</span><span class="p">],</span> <span class="s2">&quot;ChannelMapSet&quot;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ChannelMapSet: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chanmapset</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;UUID: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Comment: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comment</span><span class="p">))</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Looking back </span><span class="si">{}</span><span class="s2"> seconds before Error #</span><span class="si">{}</span><span class="s2"> for transition checks.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">TRANSITION_ANALYSIS_NEIGHBOURHOOD_LOOKBACK_NANOS</span> <span class="o">/</span> <span class="mf">1000000000.0</span><span class="p">,</span> <span class="n">nth_error</span><span class="p">))</span>

        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">log_str</span><span class="p">)</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">is_transition</span><span class="p">(</span><span class="n">all_timeline_df</span><span class="p">,</span>
                                                                <span class="n">uuid</span><span class="p">,</span>
                                                                <span class="n">avturi</span><span class="p">,</span>
                                                                <span class="n">htchanmapset</span><span class="p">,</span>
                                                                <span class="n">chanmapset</span><span class="p">,</span>
                                                                <span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">],</span>
                                                                <span class="n">nanos_before</span><span class="o">=</span><span class="n">nanos_back_for_transition_check</span><span class="p">,</span>
                                                                <span class="n">nanos_after</span><span class="o">=</span><span class="n">nanos_after_for_transition_check</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_str</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">failure_neighbourhood</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_timeframe_neighbourhood</span><span class="p">(</span>
            <span class="n">all_timeline_df</span><span class="p">,</span>
            <span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">],</span>
            <span class="n">nanos_before</span><span class="o">=</span><span class="n">nanos_before_failure_analysis</span><span class="p">,</span>
            <span class="n">nanos_after</span><span class="o">=</span><span class="n">nanos_after_failure_analysis</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">failure_neighbourhood</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.print_logs"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.print_logs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">print_logs</span><span class="p">(</span><span class="n">nth_error_window_df</span><span class="p">,</span> <span class="n">error_dt64</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error_timestr_tuple</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nth_error</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">error_row_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">error_dt64</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">error_timestr_tuple</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">error_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nth_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Need to pass error_dt64, error_timstr or error_df AND nth_error.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error_dt64</span><span class="p">:</span>
            <span class="n">error_row_df</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_row_by_dt64</span><span class="p">(</span><span class="n">nth_error_window_df</span><span class="p">,</span>
                                                                      <span class="n">error_dt64</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error_timestr_tuple</span><span class="p">:</span>
            <span class="n">error_timestr</span><span class="p">,</span> <span class="n">error_timestr_tz</span> <span class="o">=</span> <span class="n">error_timestr_tuple</span>
            <span class="n">error_row_df</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_row_by_dt64</span><span class="p">(</span><span class="n">nth_error_window_df</span><span class="p">,</span>
                                                                      <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">timestring_to_timstamp</span><span class="p">(</span>
                                                                          <span class="n">error_timestr</span><span class="p">,</span>
                                                                          <span class="n">tz</span><span class="o">=</span><span class="n">error_timestr_tz</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">error_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nth_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_row_df</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_row_by_dt64</span><span class="p">(</span><span class="n">nth_error_window_df</span><span class="p">,</span>
                                                                      <span class="n">error_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nth_error</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error_row_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">error_row_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">error_row_df</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">error_row_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">uuid: </span><span class="si">{}</span><span class="s2">, model: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{}</span><span class="s2"> anacapa.trace </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;perf&quot;</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{}</span><span class="s2"> perf counters </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">perf</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;dmesg&quot;</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{}</span><span class="s2"> dmesg </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">dmesg</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">error_row_df</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DeviceProperties&#39; ChannelMapSet and HTSatChanMapSet</span>
<span class="sd">        For bonding (i.e. Stereo pairing and HT configuration)</span>
<span class="sd">            Let&#39;s call it Primary HT/Stereo Bonded and Secondary HT/Stero Bonded</span>
<span class="sd">    AVTransport&#39;s AVTransportURI (and TransportState and CurrentTrackURI)</span>
<span class="sd">        For grouping/ungrouping</span>
<span class="sd">            Let&#39;s call it Primary Grouped and Secondary Grouped</span>

<span class="sd">    TODO: HT Master can also be a GM at the same time...i.e. there is both HT Master GC and HT Master GM</span>
<span class="sd">    (i.e. AVTransport *must* be exosed and with AVTransportURI attribute).</span>

<span class="sd">    TODO: As above, a Primary Stereo Bonded likewise.</span>

<span class="sd">    ########################################</span>
<span class="sd">    ### Grouping</span>
<span class="sd">    ########################################</span>
<span class="sd">    GC and GM both have AVTransportURI attributes.  A GC&#39;s AVTransportURI will point to its own UUID or a remote linein</span>
<span class="sd">    URI whereas that of a GM will point to the GC&#39;s UUID.</span>

<span class="sd">    ########################################</span>
<span class="sd">    ### Bonding</span>
<span class="sd">    ########################################</span>
<span class="sd">    A Satellite (i.e. Left Rear, Right Rear or Low Frequency Effects) *must* have HTSatChanMapSet to be in HT mode.</span>
<span class="sd">    Since it has HTSatChanMapSet, I would assume ChannelMapSet is exposed, unless we expose DeviceProperties and hide</span>
<span class="sd">    ChannelMapSet.  Say it is the former, would it mean that a Satellite can be configured to Stereo mode from HT mode,</span>
<span class="sd">    and vice versa?</span>

<span class="sd">    A Satellite do not have AVTransport.</span>

<span class="sd">    Like wise for a Secondary Stereo Bonded (and also the question - would it mean that a Satellite can be configured</span>
<span class="sd">    to go to HT mode from HT mode.</span>

<span class="sd">    # This statement is wrong, after speaking to Luis and Ted on 14th July 2017</span>
<span class="sd">    # vvv</span>
<span class="sd">    I know a Secondary Bonded does not have AVTransport, hence grouping is out of the question.  This is probably</span>
<span class="sd">    by implementation.  Is there anything that prevets a Secondary Bonded as being a GC of its own group?  Perhaps</span>
<span class="sd">    we might get into circular relationship?</span>
<span class="sd">    # ^^^</span>

<span class="sd">    Both Primary and Secondary Stereo Bonded ZP have AVTransportURI.  In the case of the Primary Stereo Bonded being</span>
<span class="sd">    the GC, the Secondary Stereo Bonded&#39;s AVTransportURI will point to the Primary Stereo Bonded.  In this case, the</span>
<span class="sd">    Primary Stereo Bonded AVTransportURI will just point to whatever source it is playing.</span>
<span class="sd">    In the case the stereo pair is a GM, both the Primary and Secondary Stereo Bonded AVTransportURI will point to the</span>
<span class="sd">    GC.</span>

<span class="sd">    Note that a Primary Bonded can also be playing from a remote linein.</span>

<span class="sd">    ########################################</span>
<span class="sd">    ### Grouped while bonded</span>
<span class="sd">    ########################################</span>
<span class="sd">    GC *must* have both HTSatChanMapSet and ChannelMapSet since it can be in both HT mode or stereo mode - it&#39;s</span>
<span class="sd">    DeviceProperties must be exposed so the above actions can be invoked.</span>

<span class="sd">    GM *must* have ChannelMapSet since it can also be in stereo mode.  Likewise, it *must* have HTSatChanMapSet since</span>
<span class="sd">    a GM can be a HT Master in HT mode.</span>

<span class="sd">    **Summary**:</span>
<span class="sd">    A GC has all attributes</span>
<span class="sd">        If it has ChannelMapSet, it is a Stereo Primary Bonded.</span>
<span class="sd">        If it has HTSatChanMapSet, it is a HT Primary Bonded.</span>
<span class="sd">        It cannot be a Satellite (as Satellite cannot be grouped).</span>
<span class="sd">    A GM has all attributes</span>
<span class="sd">        If it has ChannelMapSet, it is a Stereo Primary Bonded.</span>
<span class="sd">        If it has HTSatChanMapSet, it is a HT Primary Bonded.</span>
<span class="sd">        It cannot be a Satellite (as Satellite cannot be grouped).</span>
<span class="sd">    One with no AVTransport *must* be a HT Satellite...but what happens in Coherence?  If AVTransport disappears, does</span>
<span class="sd">    the framework set the AVTransportURI to None or an empty string???    </span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.deduce_configuration_role"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.deduce_configuration_role">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deduce_configuration_role</span><span class="p">(</span>
            <span class="n">avturi</span><span class="p">,</span>
            <span class="n">htsatchanmapset</span><span class="p">,</span>
            <span class="n">chanmapset</span><span class="p">,</span>
            <span class="n">local_uuid</span><span class="p">,</span>
            <span class="n">strict_configuration_check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduce configuration role of device with local_uuid from its (avturi, htsatchanmapset, chanmapset)</span>
<span class="sd">        There is no call to get UPNP state var.</span>

<span class="sd">        :param avturi: avturi of device</span>
<span class="sd">        :type avturi: :str:</span>

<span class="sd">        :param htsatchanmapset: htsatchanmapset of device</span>
<span class="sd">        :type htsatchanmapset: :str:</span>

<span class="sd">        :param chanmapset: chanmapset of device</span>
<span class="sd">        :type chanmapset: :str:</span>

<span class="sd">        :param local_uuid: UUID of device</span>
<span class="sd">        :type local_uuid: :str:</span>

<span class="sd">        :param strict_configuration_check: Do we want to enforce strict</span>
<span class="sd">        configuration check?</span>
<span class="sd">        :type strict_configuration_check: :bool:</span>

<span class="sd">        :return: Bitmask of configuration role</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">role_bitmask</span> <span class="o">=</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">UNDEFINED</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chanmapset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">chanmapset</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">chanmapset</span><span class="p">)))</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">chanmapset</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">chanmapset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># If chanmapset is empty, it cannot be in a Stereo configuration</span>
            <span class="c1"># If not in stereo config and not HT Satellite, this is not secondary bonded</span>
            <span class="n">role_bitmask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mh">0xffff</span> <span class="o">^</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">STEREO_BONDED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">role_bitmask</span> <span class="o">|=</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">STEREO_BONDED</span>  <span class="c1"># Must be stereo bonded</span>

            <span class="c1"># Check if Secondary Stereo Bonded from chanmapset</span>
            <span class="c1"># Split the chanmapset to uuid keys with the channel as its value:</span>
            <span class="c1"># &quot;RINCON_949F3E00033E01400:LF,LF;RINCON_B8E937815A8A01400:RF,RF;RINCON_000E589CED1601400:SW,SW&quot;</span>
            <span class="c1">#   to</span>
            <span class="c1"># {&#39;RINCON_000E589CED1601400&#39;: &#39;SW,SW&#39;,</span>
            <span class="c1">#  &#39;RINCON_949F3E00033E01400&#39;: &#39;LF,LF&#39;,</span>
            <span class="c1">#  &#39;RINCON_B8E937815A8A01400&#39;: &#39;RF,RF&#39;}</span>
            <span class="n">device_uuid_list</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span> \
                <span class="n">parse_config_map_set_to_uuid_list</span><span class="p">(</span><span class="n">chanmapset</span><span class="p">)</span>
            <span class="c1"># 1st is alawys the primary, according to Ted Lin (chat with SK), 25th Jul 2017</span>
            <span class="k">if</span> <span class="n">device_uuid_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">local_uuid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">role_bitmask</span> <span class="o">|=</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">PRIMARY_BONDED</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">role_bitmask</span> <span class="o">|=</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">SECONDARY_BONDED</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">htsatchanmapset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">htsatchanmapset</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">htsatchanmapset</span><span class="p">)))</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">htsatchanmapset</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">htsatchanmapset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># If htsatchanmapset is empty, it cannot be in a HT configuration</span>
            <span class="c1"># If not HT Satellite and not in stereo config, this is not secondary bonded</span>
            <span class="n">role_bitmask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mh">0xffff</span> <span class="o">^</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">HT_BONDED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">role_bitmask</span> <span class="o">|=</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">HT_BONDED</span>  <span class="c1"># Must be HT bonded</span>

            <span class="c1"># Check if satellite from htsatchanmapset</span>
            <span class="c1"># __order__ = &#39;MASTER,SW,LR,RR,LRRR&#39;</span>
            <span class="c1"># Split the htsatchanmapset to uuid keys with the channel as its value:</span>
            <span class="c1"># &quot;RINCON_B8E93740151F01400:LF,RF;RINCON_7828CA000AF601400:LR,LR;RINCON_7828CA10050601400:RR,RR&quot;</span>
            <span class="c1">#   to</span>
            <span class="c1"># {&#39;RINCON_7828CA000AF601400&#39;: &#39;LR,LR&#39;,</span>
            <span class="c1"># &#39;RINCON_7828CA10050601400&#39;: &#39;RR,RR&#39;,</span>
            <span class="c1"># &#39;RINCON_B8E93740151F01400&#39;: &#39;LF,RF&#39;}</span>
            <span class="n">device_uuid_list</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span> \
                <span class="n">parse_config_map_set_to_uuid_list</span><span class="p">(</span><span class="n">htsatchanmapset</span><span class="p">)</span>
            <span class="c1"># 1st is alawys the primary, according to Ted Lin (chat with SK), 25th Jul 2017</span>
            <span class="k">if</span> <span class="n">device_uuid_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">local_uuid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">role_bitmask</span> <span class="o">|=</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">PRIMARY_BONDED</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">role_bitmask</span> <span class="o">|=</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">SECONDARY_BONDED</span>

        <span class="c1"># Treat AVTransportURI different because AVTransport service disappears when device becomes HT Saellite</span>
        <span class="k">if</span> <span class="n">avturi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avturi</span><span class="p">)):</span>
            <span class="c1"># Must be a HT  satellite as HT satellite has no AVTransportURI</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">role_bitmask</span> <span class="o">&amp;</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">HT_BONDED</span> <span class="ow">and</span>
                    <span class="n">role_bitmask</span> <span class="o">&amp;</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">SECONDARY_BONDED</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">strict_configuration_check</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Configuration </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not &quot;</span>
                                       <span class="s2">&quot;recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">avturi</span><span class="p">,</span>
                                                            <span class="n">htsatchanmapset</span><span class="p">,</span>
                                                            <span class="n">chanmapset</span><span class="p">,</span>
                                                            <span class="n">local_uuid</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeWarning</span><span class="p">(</span><span class="s2">&quot;Configuration </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not &quot;</span>
                                         <span class="s2">&quot;recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">avturi</span><span class="p">,</span>
                                                              <span class="n">htsatchanmapset</span><span class="p">,</span>
                                                              <span class="n">chanmapset</span><span class="p">,</span>
                                                              <span class="n">local_uuid</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">avturi</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">avturi</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">GM</span><span class="p">):</span>
                    <span class="c1"># This must be GM</span>
                    <span class="n">role_bitmask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mh">0xffff</span> <span class="o">^</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">PRIMARY_GROUPED</span><span class="p">)</span>
                    <span class="n">role_bitmask</span> <span class="o">|=</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">SECONDARY_GROUPED</span>
                <span class="k">elif</span> <span class="n">avturi</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">SPDIF</span><span class="p">):</span>
                    <span class="c1"># SPDIF must be HT Master</span>
                    <span class="n">role_bitmask</span> <span class="o">|=</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">PRIMARY_GROUPED</span>
                    <span class="n">role_bitmask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mh">0xffff</span> <span class="o">^</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">SECONDARY_GROUPED</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">avturi</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">LOCAL_QUEUE</span><span class="p">):</span>
                    <span class="c1"># Local queue must be GC</span>
                    <span class="n">role_bitmask</span> <span class="o">|=</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">PRIMARY_GROUPED</span>
                    <span class="n">role_bitmask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mh">0xffff</span> <span class="o">^</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">SECONDARY_GROUPED</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">avturi</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">LINE_IN</span><span class="p">):</span>
                    <span class="c1"># if avturi[len(UDPDiagnosticModuleMonitor.LINE_IN):] == local_uuid:</span>
                    <span class="c1">#     return False    # Playing from own LineIn</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     return False    # Playing from remote LineIn, in which case it has to be a Primary</span>
                    <span class="n">role_bitmask</span> <span class="o">|=</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">PRIMARY_GROUPED</span>
                    <span class="n">role_bitmask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mh">0xffff</span> <span class="o">^</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">SECONDARY_GROUPED</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">strict_configuration_check</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AVTransportURI </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not &quot;</span>
                                           <span class="s2">&quot;recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avturi</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeWarning</span><span class="p">(</span><span class="s2">&quot;AVTransportURI </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not &quot;</span>
                                             <span class="s2">&quot;recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avturi</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This must be GM</span>
                <span class="n">role_bitmask</span> <span class="o">|=</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">PRIMARY_GROUPED</span>
                <span class="n">role_bitmask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mh">0xffff</span> <span class="o">^</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">SECONDARY_GROUPED</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">role_bitmask</span> <span class="o">==</span> <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">UNDEFINED</span><span class="p">:</span>
            <span class="c1"># Config at least have to be something.</span>
            <span class="k">if</span> <span class="n">strict_configuration_check</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Configuration </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not &quot;</span>
                                   <span class="s2">&quot;recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">avturi</span><span class="p">,</span>
                                                        <span class="n">htsatchanmapset</span><span class="p">,</span>
                                                        <span class="n">chanmapset</span><span class="p">,</span>
                                                        <span class="n">local_uuid</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeWarning</span><span class="p">(</span><span class="s2">&quot;Configuration </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not &quot;</span>
                                   <span class="s2">&quot;recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">avturi</span><span class="p">,</span>
                                                        <span class="n">htsatchanmapset</span><span class="p">,</span>
                                                        <span class="n">chanmapset</span><span class="p">,</span>
                                                        <span class="n">local_uuid</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">role_bitmask</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.deduce_if_primary_grouped"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.deduce_if_primary_grouped">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deduce_if_primary_grouped</span><span class="p">(</span>
            <span class="n">avturi</span><span class="p">,</span>
            <span class="n">htsatchanmapset</span><span class="p">,</span>
            <span class="n">chanmapset</span><span class="p">,</span>
            <span class="n">local_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduce from its avturi if it is a Group Cordinator.</span>
<span class="sd">        There is no call to get UPNP state var.</span>

<span class="sd">        :param avturi: avturi of device</span>
<span class="sd">        :type avturi: :str:</span>

<span class="sd">        :param htsatchanmapset: htsatchanmapset of device</span>
<span class="sd">        :type htsatchanmapset: :str:</span>

<span class="sd">        :param chanmapset: chanmapset of device</span>
<span class="sd">        :type chanmapset: :str:</span>

<span class="sd">        :param local_uuid: UUID of device</span>
<span class="sd">        :type local_uuid: :str:</span>

<span class="sd">        :return: True if Secondary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_configuration_role</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htsatchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">PRIMARY_GROUPED</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.deduce_if_secondary_grouped"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.deduce_if_secondary_grouped">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deduce_if_secondary_grouped</span><span class="p">(</span>
            <span class="n">avturi</span><span class="p">,</span>
            <span class="n">htsatchanmapset</span><span class="p">,</span>
            <span class="n">chanmapset</span><span class="p">,</span>
            <span class="n">local_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduce from its avturi if it is a Group Member.</span>
<span class="sd">        There is no call to get UPNP state var.</span>

<span class="sd">        :param avturi: avturi of device</span>
<span class="sd">        :type avturi: :str:</span>

<span class="sd">        :param htsatchanmapset: htsatchanmapset of device</span>
<span class="sd">        :type htsatchanmapset: :str:</span>

<span class="sd">        :param chanmapset: chanmapset of device</span>
<span class="sd">        :type chanmapset: :str:</span>

<span class="sd">        :param local_uuid: UUID of device</span>
<span class="sd">        :type local_uuid: :str:</span>

<span class="sd">        :return: True if Secondary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_configuration_role</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htsatchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">SECONDARY_GROUPED</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.deduce_if_primary_bonded"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.deduce_if_primary_bonded">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deduce_if_primary_bonded</span><span class="p">(</span>
            <span class="n">avturi</span><span class="p">,</span>
            <span class="n">htsatchanmapset</span><span class="p">,</span>
            <span class="n">chanmapset</span><span class="p">,</span>
            <span class="n">local_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduce from its avturi, htsatchanmapset, chanmapset, local_uuid if it is a HT Master or Primary Stereo Pair.</span>
<span class="sd">        There is no call to get UPNP state var.</span>

<span class="sd">        :param avturi: avturi of device</span>
<span class="sd">        :type avturi: :str:</span>

<span class="sd">        :param htsatchanmapset: htsatchanmapset of device</span>
<span class="sd">        :type htsatchanmapset: :str:</span>

<span class="sd">        :param chanmapset: chanmapset of device</span>
<span class="sd">        :type chanmapset: :str:</span>

<span class="sd">        :param local_uuid: UUID of device</span>
<span class="sd">        :type local_uuid: :str:</span>

<span class="sd">        :return: True if Secondary Bonded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_configuration_role</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htsatchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">PRIMARY_BONDED</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.deduce_if_secondary_bonded"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.deduce_if_secondary_bonded">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deduce_if_secondary_bonded</span><span class="p">(</span>
            <span class="n">avturi</span><span class="p">,</span>
            <span class="n">htsatchanmapset</span><span class="p">,</span>
            <span class="n">chanmapset</span><span class="p">,</span>
            <span class="n">local_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduce from its avturi, htsatchanmapset, chanmapset, local_uuid if it is a Satellite or Secondary Stereo Pair.</span>
<span class="sd">        There is no call to get UPNP state var.</span>

<span class="sd">        :param avturi: avturi of device</span>
<span class="sd">        :type avturi: :str:</span>

<span class="sd">        :param htsatchanmapset: htsatchanmapset of device</span>
<span class="sd">        :type htsatchanmapset: :str:</span>

<span class="sd">        :param chanmapset: chanmapset of device</span>
<span class="sd">        :type chanmapset: :str:</span>

<span class="sd">        :param local_uuid: UUID of device</span>
<span class="sd">        :type local_uuid: :str:</span>

<span class="sd">        :return: True if Secondary Bonded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_configuration_role</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htsatchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">SECONDARY_BONDED</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.deduce_if_stereo_primary_bonded"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.deduce_if_stereo_primary_bonded">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deduce_if_stereo_primary_bonded</span><span class="p">(</span>
            <span class="n">avturi</span><span class="p">,</span>
            <span class="n">htsatchanmapset</span><span class="p">,</span>
            <span class="n">chanmapset</span><span class="p">,</span>
            <span class="n">local_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduce from its avturi if it is a Primary Stereo Pair.</span>
<span class="sd">        There is no call to get UPNP state var.</span>

<span class="sd">        :param avturi: avturi of device</span>
<span class="sd">        :type avturi: :str:</span>

<span class="sd">        :param htsatchanmapset: (Not used) htsatchanmapset of device</span>
<span class="sd">        :type htsatchanmapset: :str:</span>

<span class="sd">        :param chanmapset: chanmapset of device</span>
<span class="sd">        :type chanmapset: :str:</span>

<span class="sd">        :param local_uuid: UUID of device</span>
<span class="sd">        :type local_uuid: :str:</span>

<span class="sd">        :return: True if Secondary Bonded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_configuration_role</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htsatchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">STEREO_BONDED</span> <span class="ow">and</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_configuration_role</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htsatchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">PRIMARY_BONDED</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.deduce_if_stereo_secondary_bonded"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.deduce_if_stereo_secondary_bonded">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deduce_if_stereo_secondary_bonded</span><span class="p">(</span>
            <span class="n">avturi</span><span class="p">,</span>
            <span class="n">htsatchanmapset</span><span class="p">,</span>
            <span class="n">chanmapset</span><span class="p">,</span>
            <span class="n">local_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduce from its avturi if it is a Secondary Stereo Pair.</span>
<span class="sd">        There is no call to get UPNP state var.</span>

<span class="sd">        :param avturi: avturi of device</span>
<span class="sd">        :type avturi: :str:</span>

<span class="sd">        :param htsatchanmapset: (Not used) htsatchanmapset of device</span>
<span class="sd">        :type htsatchanmapset: :str:</span>

<span class="sd">        :param chanmapset: chanmapset of device</span>
<span class="sd">        :type chanmapset: :str:</span>

<span class="sd">        :param local_uuid: UUID of device</span>
<span class="sd">        :type local_uuid: :str:</span>

<span class="sd">        :return: True if Secondary Bonded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_configuration_role</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htsatchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">STEREO_BONDED</span> <span class="ow">and</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_configuration_role</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htsatchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">SECONDARY_BONDED</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.deduce_if_ht_primary_bonded"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.deduce_if_ht_primary_bonded">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deduce_if_ht_primary_bonded</span><span class="p">(</span>
            <span class="n">avturi</span><span class="p">,</span>
            <span class="n">htsatchanmapset</span><span class="p">,</span>
            <span class="n">chanmapset</span><span class="p">,</span>
            <span class="n">local_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduce from its AVTransportURI if it is a HT Master.</span>
<span class="sd">        There is no call to get UPNP state var.</span>

<span class="sd">        :param avturi: avturi of device</span>
<span class="sd">        :type avturi: :str:</span>

<span class="sd">        :param htsatchanmapset: (Not used) htsatchanmapset of device</span>
<span class="sd">        :type htsatchanmapset: :str:</span>

<span class="sd">        :param chanmapset: chanmapset of device</span>
<span class="sd">        :type chanmapset: :str:</span>

<span class="sd">        :param local_uuid: UUID of device</span>
<span class="sd">        :type local_uuid: :str:</span>

<span class="sd">        :return: True if HT Master.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_configuration_role</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htsatchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">HT_BONDED</span> <span class="ow">and</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_configuration_role</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htsatchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">PRIMARY_BONDED</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.deduce_if_ht_secondary_bonded"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.deduce_if_ht_secondary_bonded">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deduce_if_ht_secondary_bonded</span><span class="p">(</span>
            <span class="n">avturi</span><span class="p">,</span>
            <span class="n">htsatchanmapset</span><span class="p">,</span>
            <span class="n">chanmapset</span><span class="p">,</span>
            <span class="n">local_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduce from its AVTransportURI if it is a Satellite.</span>
<span class="sd">        There is no call to get UPNP state var.</span>

<span class="sd">        :param avturi: avturi of device</span>
<span class="sd">        :type avturi: :str:</span>

<span class="sd">        :param htsatchanmapset: (Not used) htsatchanmapset of device</span>
<span class="sd">        :type htsatchanmapset: :str:</span>

<span class="sd">        :param chanmapset: chanmapset of device</span>
<span class="sd">        :type chanmapset: :str:</span>

<span class="sd">        :param local_uuid: UUID of device</span>
<span class="sd">        :type local_uuid: :str:</span>

<span class="sd">        :return: True if Secondary Bonded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_configuration_role</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htsatchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">HT_BONDED</span> <span class="ow">and</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_configuration_role</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htsatchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">ConfigurationBitmask</span><span class="o">.</span><span class="n">SECONDARY_BONDED</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_primary_grouped_uuid_from_secondary_grouped"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_primary_grouped_uuid_from_secondary_grouped">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_primary_grouped_uuid_from_secondary_grouped</span><span class="p">(</span><span class="n">avturi</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the primary grouped UUD from the secondary grouped device&#39;s various current state variables.</span>

<span class="sd">        :param avturi: AVTransportURI of the device we are querying</span>
<span class="sd">        :type avturi: :str:</span>

<span class="sd">        :return: UUID of primary grouped device or None</span>
<span class="sd">        :rtype: :str:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">avturi</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">GM</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">avturi</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">GM</span><span class="p">):]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.parse_config_map_set_to_uuid_channel_key_value_dict"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.parse_config_map_set_to_uuid_channel_key_value_dict">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_config_map_set_to_uuid_channel_key_value_dict</span><span class="p">(</span><span class="n">config_map_set</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)),</span> <span class="n">config_map_set</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))}</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_uuid_with_channel"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_uuid_with_channel">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_uuid_with_channel</span><span class="p">(</span><span class="n">uuid_channel_key_value_dict</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the 1st UUID of the device with matching channel.</span>

<span class="sd">        :param uuid_channel_key_value_dict: uuid_channel_key_value_dict returned from</span>
<span class="sd">            parse_config_map_set_to_uuid_channel_key_value_dict()</span>
<span class="sd">        :param channel: Channel Map Set channel str, like &quot;LF,RF&quot;, &quot;SW,SW&quot;, etc</span>
<span class="sd">        :return: The UUID of the device with channel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span> <span class="n">v</span> <span class="o">==</span> <span class="n">channel</span><span class="p">,</span> <span class="n">uuid_channel_key_value_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.parse_config_map_set_to_uuid_list"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.parse_config_map_set_to_uuid_list">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_config_map_set_to_uuid_list</span><span class="p">(</span><span class="n">config_map_set</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)),</span> <span class="n">config_map_set</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))]</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_primary_bonded_uuid_from_secondary_bonded_"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_primary_bonded_uuid_from_secondary_bonded_">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_primary_bonded_uuid_from_secondary_bonded_</span><span class="p">(</span>
            <span class="n">configmapset</span><span class="p">,</span>
            <span class="n">local_uuid</span><span class="p">,</span>
            <span class="n">strict_configuration_check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the primary bonded UUD from the secondary bonded device&#39;s various current state variables.</span>

<span class="sd">        :param configmapset: htchanmapset or chanmapset of device</span>
<span class="sd">        :type configmapset: :str:</span>

<span class="sd">        :param local_uuid: UUID of device</span>
<span class="sd">        :type local_uuid: :str:</span>

<span class="sd">        :param strict_configuration_check: Do we want to enforce strict</span>
<span class="sd">        configuration check?</span>
<span class="sd">        :type strict_configuration_check: :bool:</span>

<span class="sd">        :return: UUID of primary bonded device or None</span>
<span class="sd">        :rtype: :str:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In UPnP, it is probably possible for a device to have both htchanmapset and chanmapset...</span>
        <span class="c1"># we prioritize the htchanmapset and done deal with the co-existence of both.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">configmapset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">configmapset</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">configmapset</span><span class="p">)))</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">configmapset</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">configmapset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">device_uuid_list</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span> \
                <span class="n">parse_config_map_set_to_uuid_list</span><span class="p">(</span><span class="n">configmapset</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">device_uuid_list</span><span class="p">):</span>
                <span class="c1"># 1st is alawys the primary, according to Ted Lin (chat with SK), 25th Jul 2017</span>
                <span class="k">return</span> <span class="n">device_uuid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">strict_configuration_check</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bonded configuration </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not &quot;</span>
                                       <span class="s2">&quot;recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">configmapset</span><span class="p">,</span>
                                                            <span class="n">local_uuid</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeWarning</span><span class="p">(</span><span class="s2">&quot;Bonded configuration </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not &quot;</span>
                                         <span class="s2">&quot;recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">configmapset</span><span class="p">,</span>
                                                              <span class="n">local_uuid</span><span class="p">)))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strict_configuration_check</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bonded configuration </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not &quot;</span>
                                   <span class="s2">&quot;recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">configmapset</span><span class="p">,</span>
                                                        <span class="n">local_uuid</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeWarning</span><span class="p">(</span><span class="s2">&quot;Bonded configuration </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not &quot;</span>
                                   <span class="s2">&quot;recognised&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">configmapset</span><span class="p">,</span>
                                                        <span class="n">local_uuid</span><span class="p">)))</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_timeline_df"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_timeline_df">[docs]</a>    <span class="k">def</span> <span class="nf">get_timeline_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the current timeline dataframe</span>

<span class="sd">        :return: Current timeline dataframe</span>
<span class="sd">        :rtype: :class:`~pandas.DataFrame` or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.save_dataframe_to_hdf"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.save_dataframe_to_hdf">[docs]</a>    <span class="k">def</span> <span class="nf">save_dataframe_to_hdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the dataframe so we can collect as artifacts for analysis.</span>

<span class="sd">        :param hdf_name: HDF file name to save as</span>
<span class="sd">        :type hdf_name: :obj: `str`</span>

<span class="sd">        :param kwargs: Keyword arguments</span>
<span class="sd">        :type kwargs: :obj: `dict`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;Saving data frames to </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdf_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_df</span><span class="p">()</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">hdf_name</span><span class="p">,</span>
                                      <span class="s1">&#39;timeline&#39;</span><span class="p">,</span>
                                      <span class="n">complevel</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                      <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;bzip2&#39;</span><span class="p">,</span>
                                      <span class="n">fletcher32</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.disable_raise"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.disable_raise">[docs]</a>    <span class="k">def</span> <span class="nf">disable_raise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set flag to disable raising signal.SIGUSR1</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__enable_raise</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.enable_raise"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.enable_raise">[docs]</a>    <span class="k">def</span> <span class="nf">enable_raise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set flag to enable raising signal.SIGUSR1</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__enable_raise</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.raise_enabled"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.raise_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">raise_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Is raising signal.SIGUSR1 flag enabled?</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__enable_raise</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.disable_fatal_error_check"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.disable_fatal_error_check">[docs]</a>    <span class="k">def</span> <span class="nf">disable_fatal_error_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set flag to disable fatal_error_check</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__enable_fatal_error_check</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.enable_fatal_error_check"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.enable_fatal_error_check">[docs]</a>    <span class="k">def</span> <span class="nf">enable_fatal_error_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set flag to enable fatal_error_check</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__enable_fatal_error_check</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.fatal_error_check_enabled"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.fatal_error_check_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">fatal_error_check_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Is fatal_error_check enabled?</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__enable_fatal_error_check</span></div>

    <span class="k">def</span> <span class="nf">__register_watch_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">watch_string_dict_data</span><span class="p">,</span> <span class="n">matched_counters</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register watch_string_dict_data with ZP, using matched_counters for counting regex occurrences and then calling</span>
<span class="sd">        into callback when match occurs</span>

<span class="sd">        :param zp: Sonos ZP for querying matched expression in logs</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param watch_string_dict_data: Dictionary of diag diagc_module as key with embedded dict where level is key and value</span>
<span class="sd">                                        is a list of watch strings</span>
<span class="sd">        :type watch_string_dict_data: :obj:`dict`</span>

<span class="sd">        :param matched_counters: Counters for occurrences of matched strings for ZP</span>
<span class="sd">        :type watch_string_dict_data: :obj:`dict`</span>

<span class="sd">        :param callback: Callback function when any of watch_string_dict_data detected.  Executes in UDP Logger thread.</span>
<span class="sd">        :type callback: :func:</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">diagc_module</span><span class="p">,</span> <span class="n">levels_dict</span> <span class="ow">in</span> <span class="n">watch_string_dict_data</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">levels_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__diag_max_levels</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="n">diagc_module</span><span class="p">]:</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">diagc_module</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">levels_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__diag_max_levels</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="n">diagc_module</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">levels_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">watch_strings_set</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">levels_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">watch_strings_set</span><span class="p">:</span>
                <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;Watching </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">.*</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diagc_module</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span> <span class="n">zp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>
                <span class="c1"># We want to watch per diagc_module regex...</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">watch_udp_log_for_string</span><span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">.*</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diagc_module</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span>
                                                 <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="n">szc</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">watch_set</span><span class="p">,</span> <span class="n">counters</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">__match_detected</span><span class="p">(</span>
                                                     <span class="n">msg</span><span class="p">,</span>
                                                     <span class="n">szc</span><span class="p">,</span>
                                                     <span class="n">key</span><span class="p">,</span>
                                                     <span class="n">watch_set</span><span class="p">,</span>
                                                     <span class="n">counters</span><span class="p">,</span>
                                                     <span class="n">cb</span><span class="p">),</span>
                                                 <span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">diagc_module</span><span class="p">,</span> <span class="n">watch_string_dict_data</span><span class="p">,</span> <span class="n">matched_counters</span><span class="p">,</span> <span class="n">callback</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__unregister_watch_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">watch_string_dict_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        De-register watch_string_dict_data with ZP, using matched_counters for counting regex occurrences and then calling</span>
<span class="sd">        into callback when match occurs</span>

<span class="sd">        :param zp: Sonos ZP for querying matched expression in logs</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param watch_string_dict_data: Dictionary of diag diagc_module as key with embedded dict where level is key and value</span>
<span class="sd">                                        is a list of watch strings</span>
<span class="sd">        :type watch_string_dict_data: :obj:`dict`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">diagc_module</span><span class="p">,</span> <span class="n">levels_dict</span> <span class="ow">in</span> <span class="n">watch_string_dict_data</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">watch_strings_set</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">levels_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">watch_strings_set</span><span class="p">:</span>
                <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;Un-watching </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">.*</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diagc_module</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span> <span class="n">zp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_watching_udp_log_for_string</span><span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">.*</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diagc_module</span><span class="p">,</span> <span class="n">expr</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__diag_max_levels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__diag_max_levels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">())</span>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.reset_raised"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.reset_raised">[docs]</a>    <span class="k">def</span> <span class="nf">reset_raised</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset the raised flag.  The raised flag is set to True when a signal is raised.</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__raised</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">__var_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback for handling state variable changes.</span>
<span class="sd">        Executes in Coherence thread.</span>

<span class="sd">        :param variable: The state variable that changed.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">RootDevice</span><span class="p">):</span>
            <span class="n">root_device</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">device</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">RootDevice</span><span class="p">):</span>
            <span class="n">root_device</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;RootDevice not detected in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        result = {RootDevice} rootdevice u&#39;10.22.23.27 - Sonos Sol&#39; &#39;uuid:RINCON_B8E93740151F01400&#39; &#39;upnp:rootdevice&#39; &#39;10.22.23.27&#39;, manifestation &#39;remote&#39;</span>
<span class="sd">         client = {NoneType} None</span>
<span class="sd">         creation_timestamp = {float} 1487167116.68</span>
<span class="sd">         detection_completed = {bool} True</span>
<span class="sd">         device_description = {instance} _ElementInterface: &lt;Element {urn:schemas-upnp-org:device-1-0}device at 10d9523f8&gt;</span>
<span class="sd">         device_type = {unicode} u&#39;urn:schemas-upnp-org:device:ZonePlayer:1&#39;</span>
<span class="sd">         device_type_version = {unicode} u&#39;1&#39;</span>
<span class="sd">         devices = {list} &lt;type &#39;list&#39;&gt;: [embedded device u&#39;10.22.23.27 - Sonos Sol Media Server&#39; u&#39;urn:schemas-upnp-org:device:MediaServer:1&#39;, parent rootdevice u&#39;10.22.23.27 - Sonos Sol&#39; &#39;uuid:RINCON_B8E93740151F01400&#39; &#39;upnp:rootdevice&#39; &#39;10.22.23.27&#39;, manifestation &#39;remote&#39;, embe</span>
<span class="sd">         friendly_device_type = {unicode} u&#39;ZonePlayer&#39;</span>
<span class="sd">         friendly_name = {unicode} u&#39;10.22.23.27 - Sonos Sol&#39;</span>
<span class="sd">         host = {str} &#39;10.22.23.27&#39;</span>
<span class="sd">         icons = {list} &lt;type &#39;list&#39;&gt;: [{&#39;mimetype&#39;: &#39;image/png&#39;, &#39;realurl&#39;: &#39;/img/icon-S11.png&#39;, &#39;url&#39;: &#39;http://10.22.23.27:1400/img/icon-S11.png&#39;, &#39;height&#39;: &#39;48&#39;, &#39;width&#39;: &#39;48&#39;, &#39;depth&#39;: &#39;24&#39;}]</span>
<span class="sd">         location = {str} &#39;http://10.22.23.27:1400/xml/device_description.xml&#39;</span>
<span class="sd">         logCategory = {str} &#39;device&#39;</span>
<span class="sd">         manifestation = {str} &#39;remote&#39;</span>
<span class="sd">         manufacturer = {str} &#39;Sonos, Inc.&#39;</span>
<span class="sd">         manufacturer_url = {str} &#39;http://www.sonos.com&#39;</span>
<span class="sd">         model_description = {str} &#39;Sonos Sol&#39;</span>
<span class="sd">         model_name = {str} &#39;Sonos Sol&#39;</span>
<span class="sd">         model_number = {str} &#39;S11&#39;</span>
<span class="sd">         model_url = {str} &#39;http://www.sonos.com/products/zoneplayers/S11&#39;</span>
<span class="sd">         parent = {NoneType} None</span>
<span class="sd">         presentation_url = {NoneType} None</span>
<span class="sd">         root_detection_completed = {bool} True</span>
<span class="sd">         serial_number = {NoneType} None</span>
<span class="sd">         server = {str} &#39;Linux UPnP/1.0 Sonos/35.3-38140 (ZPS11)&#39;</span>
<span class="sd">         services = {list} &lt;type &#39;list&#39;&gt;: [Service urn:schemas-upnp-org:service:AlarmClock:1 urn:upnp-org:serviceId:AlarmClock, Service urn:schemas-upnp-org:service:MusicServices:1 urn:upnp-org:serviceId:MusicServices, Service urn:schemas-upnp-org:service:DeviceProperties:1 urn:upnp</span>
<span class="sd">         st = {str} &#39;upnp:rootdevice&#39;</span>
<span class="sd">         udn = {str} &#39;uuid:RINCON_B8E93740151F01400&#39;</span>
<span class="sd">         unsubscribe_on_teardown = {bool} False</span>
<span class="sd">         upc = {NoneType} None</span>
<span class="sd">         upnp_version = {str} &#39;1.0&#39;</span>
<span class="sd">         urlbase = {NoneType} None</span>
<span class="sd">         usn = {str} &#39;uuid:RINCON_B8E93740151F01400::upnp:rootdevice&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">root_device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">uuid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">:</span>
            <span class="c1"># For some reason louie still think there is a callback and will callback even though we have disconnected.</span>
            <span class="c1"># louie uses (cb, signal) as the key...and this key isn&#39;t unique per ZP.</span>
            <span class="c1"># louie doesn&#39;t use the sender argument to identify (cb. signal) for different ZPs.</span>
            <span class="c1"># raise RuntimeError(</span>
            <span class="c1">#     &quot;{} not found in {}!  Check watch_service_states_cb_tuple_list argument passed to start_watch()&quot;.format(</span>
            <span class="c1">#         root_device.udn, self.__current_service_states))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span>
                <span class="s2">&quot;RootDevice </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not found in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

                <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&#39;s </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> changed from </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span><span class="s2">&quot;szc&quot;</span><span class="p">],</span>
                    <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">old_value</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Callback: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">comment</span><span class="p">))</span>
                <span class="n">datetime64_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_timeline_data</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span><span class="s2">&quot;szc&quot;</span><span class="p">],</span>
                                       <span class="p">{</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="p">})</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">root_device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;cb&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">root_device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;cb&#39;</span><span class="p">](</span><span class="n">variable</span><span class="p">)</span>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.start_watch"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.start_watch">[docs]</a>    <span class="k">def</span> <span class="nf">start_watch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">watch_callback</span><span class="p">,</span> <span class="n">watch_string_dict_data</span><span class="p">,</span> <span class="n">additional_fatal_watch_string_dict_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">watch_service_states_cb_tuple_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start watching the error strings.  start_watch can only be called once per player.</span>
<span class="sd">        watch_service_states_cb_tuple_list is not supported now.</span>

<span class="sd">        :param zp: sonos zone player for which msg was detected</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param watch_callback: Callback function when any of watch_string_list detected.  Executes in UDP Logger thread.</span>
<span class="sd">        :type watch_callback: :func:</span>

<span class="sd">        :param watch_string_dict_data: Dictionary of diag module as key with embedded dict where level is key and value</span>
<span class="sd">                                        is a list of watch strings</span>
<span class="sd">        :type watch_string_dict_data: :obj:`dict`</span>

<span class="sd">        :param additional_fatal_watch_string_dict_data: Additional set of fatal dictionary of diag module as key with</span>
<span class="sd">                                        embedded dict where level is key and value is a list of watch strings</span>
<span class="sd">        :type additional_fatal_watch_string_dict_data: :obj:`dict`</span>

<span class="sd">        :param reset: Do we want to reset logging device</span>
<span class="sd">        :type reset: :bool:</span>

<span class="sd">        :param watch_service_states_cb_tuple_list: List of tuples containing (svc_name, var_name, cb)</span>
<span class="sd">        :type watch_service_states_cb_tuple_list: :obj:`list`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__louie_init</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__init_louie_callbacks</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__louie_init</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">additional_fatal_watch_string_dict_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_fatal_watch_string_dict_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">zp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__zps</span><span class="p">:</span>
            <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;start_watch() for id(zp): </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">: watch_string_dict_data: </span><span class="si">{}</span><span class="s2">, </span><span class="se">\</span>
<span class="s2">                            additional_fatal_watch_string_dict_data: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">id</span><span class="p">(</span><span class="n">zp</span><span class="p">),</span> <span class="n">zp</span><span class="p">,</span> <span class="n">watch_string_dict_data</span><span class="p">,</span> <span class="n">additional_fatal_watch_string_dict_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__zps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_udp_logging</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">reset</span><span class="p">)</span>

            <span class="c1"># We need to setup the service states first as the callbacks are dependent on it.</span>
            <span class="k">if</span> <span class="n">watch_service_states_cb_tuple_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">watch_service_states_cb_tuple_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">zp_watch_service_states_cb_tuple_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__internal_watch_service_states_cb_tuple_list</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__allow_user_service_states_monitor</span><span class="p">:</span>
                <span class="c1"># If user provided callbacks for these watch states, we override our internal item.</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">svc_name</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">usr_cb</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">watch_service_states_cb_tuple_list</span><span class="p">):</span>
                    <span class="c1"># Any (svc_name, var_name) in self.__internal_watch_service_states_cb_tuple_list, we replace with user&#39;s</span>
                    <span class="n">zp_watch_service_states_cb_tuple_list</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="p">(</span><span class="n">svc_name</span><span class="p">,</span> <span class="n">var_name</span><span class="p">),</span>
                                                                   <span class="n">zp_watch_service_states_cb_tuple_list</span><span class="p">)</span>
                    <span class="n">zp_watch_service_states_cb_tuple_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">svc_name</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">usr_cb</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span> <span class="o">=</span> <span class="n">zp_watch_service_states_cb_tuple_list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__subscribe_to_monitoring_services</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__start_monitor_service_states</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]):</span>
                    <span class="c1"># Sync service states with local cache</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__sync_monitored_service_states</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span>

            <span class="c1"># Watch shutdown messages so we can re-enable udp logger</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">watch_udp_log_for_string</span><span class="p">(</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">SHUTTING_DOWN_LOG_PATTERN</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">szc</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">detected_shutdown</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">szc</span><span class="p">),</span>
                <span class="n">zp</span><span class="p">)</span>

            <span class="c1"># Metrics</span>
            <span class="c1"># The copy() is important because we are clearing the dict on stop_watch.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__metrics_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">WATCH_METRICS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># Init counters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_metrics</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metrics_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_metrics</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="c1"># Register callbacks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__register_watch_strings</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">__metrics_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()],</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_metrics</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()],</span>
                                          <span class="c1"># Executes in UDP Logger thread.</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">__metrics_detected</span><span class="p">)</span>

            <span class="c1"># User watch strings</span>
            <span class="c1"># The copy() is important because we are clearing the dict on stop_watch.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__watch_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span> <span class="o">=</span> <span class="n">watch_string_dict_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># Init counters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_user</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_user</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="c1"># Register callbacks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__register_watch_strings</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">__watch_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()],</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_user</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()],</span>
                                          <span class="c1"># Executes in UDP Logger thread.</span>
                                          <span class="n">watch_callback</span><span class="p">)</span>

            <span class="c1"># Fatal errors</span>
            <span class="c1"># Merged 2 dict with embedded levels and error list</span>
            <span class="c1"># The copy() is important because we are clearing the dict on stop_watch.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__additional_fatal_watch_string_dict_data</span><span class="p">[</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span> <span class="o">=</span> <span class="n">additional_fatal_watch_string_dict_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__merged_errors</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_expressions_dict</span><span class="p">(</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">FATAL_ERRORS</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__additional_fatal_watch_string_dict_data</span><span class="p">[</span>
                    <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span>

            <span class="c1"># Init counters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_fatal</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__merged_errors</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_fatal</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="c1"># Register callbacks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__register_watch_strings</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">__merged_errors</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()],</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_fatal</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()],</span>
                                          <span class="c1"># Executes in UDP Logger thread.</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">__fatal_error_callback</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.stop_watch"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.stop_watch">[docs]</a>    <span class="k">def</span> <span class="nf">stop_watch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop watching log strings for zp.</span>

<span class="sd">        :param zp: sonos zone player to stop watching</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Watch shutdown messages so we can re-enable udp logger</span>
        <span class="k">if</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__zps</span><span class="p">:</span>
            <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;stop_watch() for </span><span class="si">{}</span><span class="s2">: watch_string_dict_data: </span><span class="si">{}</span><span class="s2">, additional_fatal_watch_string_dict_data: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__additional_fatal_watch_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>

            <span class="c1"># Fatal errors</span>
            <span class="c1"># De-register callbacks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__unregister_watch_strings</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__merged_errors</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span>
            <span class="c1"># Clear counters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_fatal</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_fatal</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__merged_errors</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__merged_errors</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__additional_fatal_watch_string_dict_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">())</span>

            <span class="c1"># User watch strings</span>
            <span class="c1"># De-register callbacks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__unregister_watch_strings</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span>
            <span class="c1"># Clear counters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_user</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_user</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__watch_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__watch_string_dict_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">())</span>

            <span class="c1"># Metrics</span>
            <span class="c1"># De-register callbacks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__unregister_watch_strings</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metrics_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span>
            <span class="c1"># Clear counters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_metrics</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_matched_counters_metrics</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__metrics_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__metrics_string_dict_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">())</span>

            <span class="c1"># Un-watch shutdown messages</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_watching_udp_log_for_string</span><span class="p">(</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">SHUTTING_DOWN_LOG_PATTERN</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__stop_monitor_service_states</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__watch_service_states_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">())</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__udp_log_to_file</span><span class="p">:</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log_to_file</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__zps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__louie_init</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__finit_louie_callbacks</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__louie_init</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">__start_monitor_service_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">service_states_cb_tuple_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start monitoring state variables from services.</span>
<span class="sd">        Any change will trigger a callback to the callback function passed in.</span>

<span class="sd">        :param zp: Sonos ZP to start monitor</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param service_states_cb_tuple_list: List of tuples containing (svc_name, var_name, cb)</span>
<span class="sd">        :type service_states_cb_tuple_list: :obj:`list`</span>

<span class="sd">        :return: Is it started</span>
<span class="sd">        :rtype: :bool:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">:</span>
            <span class="c1"># Already initialized in the constructor...</span>
            <span class="c1"># # It will by default create a state variable that is None unless assigned.</span>
            <span class="c1"># self.__current_service_states[zp.device.get_uuid()] = defaultdict(lambda: defaultdict(lambda: None))</span>
            <span class="c1"># Assigns the SonosZoneComponent object to the &quot;szc&quot; key (informational purposes)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="s2">&quot;szc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span>
                <span class="s2">&quot;Setting up louie connection for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">svc_name</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">service_states_cb_tuple_list</span><span class="p">:</span>
                <span class="c1"># This is the user&#39;s callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;cb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cb</span>
                <span class="c1"># This is the internal callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;__cb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> \
                    <span class="n">variable</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__var_changed</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
                <span class="c1"># louie.connect uses (cb, signal) as keys.  Forcing callback to use lambda so that</span>
                <span class="c1"># the keys will be unique each time.</span>
                <span class="n">var_changed_signal</span> <span class="o">=</span> <span class="s1">&#39;Coherence.UPnP.StateVariable.</span><span class="si">%s</span><span class="s1">.changed&#39;</span> <span class="o">%</span> <span class="n">var_name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;Connecting </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">), internal callback: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">var_changed_signal</span><span class="p">,</span>
                    <span class="n">svc_name</span><span class="p">,</span>
                    <span class="n">var_name</span><span class="p">,</span>
                    <span class="n">cb</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;__cb&#39;</span><span class="p">]))</span>
                <span class="n">louie_var_changed_receiver</span> <span class="o">=</span> <span class="n">louie</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;__cb&#39;</span><span class="p">],</span>
                    <span class="n">signal</span><span class="o">=</span><span class="n">var_changed_signal</span><span class="p">,</span>
                    <span class="n">sender</span><span class="o">=</span><span class="n">louie</span><span class="o">.</span><span class="n">Any</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;Added </span><span class="si">{}</span><span class="s2"> into louie&#39;s _global_receivers_pool.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">louie_var_changed_receiver</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span>
                <span class="s2">&quot;Set up louie connection for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">))</span>
            <span class="n">started</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span>
                <span class="s2">&quot;Won&#39;t __start_monitor_service_states, </span><span class="si">{}</span><span class="s2"> already in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span>
                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">started</span>

    <span class="k">def</span> <span class="nf">__stop_monitor_service_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">service_states_cb_tuple_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop monitoring state variables from services.  Removes all callbacks.</span>

<span class="sd">        :param zp: Sonos ZP to stop monitor</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param service_states_cb_tuple_list: List of tuples containing (svc_name, var_name, cb)</span>
<span class="sd">        :type service_states_cb_tuple_list: :obj:`list`</span>

<span class="sd">        :return: Is it stopped</span>
<span class="sd">        :rtype: :bool:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stopped</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span>
                <span class="s2">&quot;Tearing down louie connection for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">))</span>
            <span class="n">zp_current_service_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">svc_name</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">service_states_cb_tuple_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;Dis-connecting </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, internal callback: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">svc_name</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span>
                                                                                         <span class="n">zp_current_service_states</span><span class="p">[</span>
                                                                                             <span class="n">var_name</span><span class="p">][</span>
                                                                                             <span class="s1">&#39;__cb&#39;</span><span class="p">]))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">louie_receiver</span> <span class="o">=</span> <span class="n">louie</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span>
                        <span class="n">zp_current_service_states</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;__cb&#39;</span><span class="p">],</span>
                        <span class="n">signal</span><span class="o">=</span><span class="s1">&#39;Coherence.UPnP.StateVariable.</span><span class="si">%s</span><span class="s1">.changed&#39;</span> <span class="o">%</span> <span class="n">var_name</span><span class="p">,</span>
                        <span class="n">sender</span><span class="o">=</span><span class="n">louie</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="s2">&quot;KeyError when louie.disconnect: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">{}</span><span class="s2"> from louie&#39;s _global_receivers_pool.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">louie_receiver</span><span class="p">))</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># This is the user&#39;s callback</span>
                    <span class="n">zp_current_service_states</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;cb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># This is the internal callback</span>
                    <span class="n">zp_current_service_states</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;__cb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># self.__current_service_states.pop(zp.device.get_uuid())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span>
                <span class="s2">&quot;Teared down louie connection for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">))</span>
            <span class="n">stopped</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span>
                <span class="s2">&quot;Won&#39;t __stop_monitor_service_states, </span><span class="si">{}</span><span class="s2"> not in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">stopped</span>

    <span class="k">def</span> <span class="nf">__sync_monitored_service_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">service_states_cb_tuple_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sync monitored state variables from services for the ZP with internal states</span>

<span class="sd">        :param zp: Sonos ZP we want the service states sync&#39;ed</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param service_states_cb_tuple_list: List of tuples containing (svc_name, var_name, cb)</span>
<span class="sd">        :type service_states_cb_tuple_list: :obj:`list`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span>
                <span class="s2">&quot;Syncing service states for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="s2">&quot;szc&quot;</span><span class="p">],</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]))</span>
            <span class="k">for</span> <span class="n">svc_name</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">service_states_cb_tuple_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">svc_name</span><span class="p">):</span>
                    <span class="c1"># self.__current_service_states[zp.device.get_uuid()][var_name][&#39;value&#39;] = \</span>
                    <span class="c1">#     getattr(zp, svc_name).get_state_variable(var_name)</span>
                    <span class="c1"># When a device is added (callback is executed in the reactor thread), the local cache cannot</span>
                    <span class="c1"># call into reactor function (like get_state_variable).</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># We set to None if the service is not available, for example AVTransport after a device becomes</span>
                    <span class="c1"># a satellite.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> has no </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> attribute!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">svc_name</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Sync&#39;ed </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">svc_name</span><span class="p">,</span>
                                                            <span class="n">var_name</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="s2">&quot;szc&quot;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span>
                <span class="s2">&quot;Sync&#39;ed service states for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span><span class="s2">&quot;szc&quot;</span><span class="p">],</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span>
                <span class="s2">&quot;Won&#39;t __sync_monitored_service_states, </span><span class="si">{}</span><span class="s2"> not in in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span>
                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__upnp_invocation_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">service_name</span><span class="p">,</span>
                                   <span class="n">action_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">soap_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call back when a UPNP action is invoked.</span>
<span class="sd">        Executes in Coherence thread.</span>

<span class="sd">        :param results: UPNP Result dict from the call. Not used here.</span>
<span class="sd">        :type results: :obj: &#39;dict&#39;</span>
<span class="sd">        :param zp: sonos zone player which was invoked</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param service_name: Name of service containing action</span>
<span class="sd">        :type service_name: :obj: `str`</span>
<span class="sd">        :param action_name: Name of action to invoke</span>
<span class="sd">        :type action_name: :obj: `str`</span>
<span class="sd">        :param args: dict converted from action_arglist</span>
<span class="sd">        :type args: :obj: `dict`</span>
<span class="sd">        :param soap_kwargs: dict of the kwargs used in the upnp call.</span>
<span class="sd">            Contains headers, etc, from the call</span>
<span class="sd">        :type soap_dict: :obj: &#39;dict&#39;</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">curl_cmd</span> <span class="o">=</span> <span class="s2">&quot;curl -iX </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> -d </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">soap_kwargs</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">],</span>
            <span class="n">soap_kwargs</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span>
            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;-H </span><span class="se">\&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                    <span class="n">soap_kwargs</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())),</span>
            <span class="n">soap_kwargs</span><span class="p">[</span><span class="s1">&#39;postdata&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_timeline_data</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;Invoking </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">service_name</span><span class="p">,</span> <span class="n">action_name</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span>
            <span class="s2">&quot;curl&quot;</span><span class="p">:</span> <span class="n">curl_cmd</span><span class="p">})</span>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.turn_on_upnp_invocation_callback"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.turn_on_upnp_invocation_callback">[docs]</a>    <span class="k">def</span> <span class="nf">turn_on_upnp_invocation_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn on UPNP invocation callback and timeline data-framing.</span>

<span class="sd">        :param zp: sonos zone player which was invoked</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">set_upnp_invocation_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__upnp_invocation_callback</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.turn_off_upnp_invocation_callback"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.turn_off_upnp_invocation_callback">[docs]</a>    <span class="k">def</span> <span class="nf">turn_off_upnp_invocation_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn off UPNP invocation callback and timeline data-framing.</span>

<span class="sd">        :param zp: sonos zone player which was invoked</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">set_upnp_invocation_callback</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.log_lines_to_dict_list"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.log_lines_to_dict_list">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">log_lines_to_dict_list</span><span class="p">(</span><span class="n">log_lines_newline_delimited_list</span><span class="p">,</span> <span class="n">time_format_str</span><span class="o">=</span><span class="n">ANACAPA_STRPTIME_FORMAT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert newline-delimited log lines to list of dict with &#39;message&#39; and &#39;time&#39; keys.</span>

<span class="sd">        :param log_lines_newline_delimited_list: Newline-delimited log list</span>
<span class="sd">        :type log_lines_newline_delimited_list: :obj: `list`</span>

<span class="sd">        :param time_format_str: Format string for strptime</span>
<span class="sd">        :type time_format_str: :obj: `str`</span>

<span class="sd">        :return: List of dict with &quot;message&quot; and &quot;time&quot; keys whereby the &quot;time&quot; values are datetime type</span>
<span class="sd">        :rtype: :obj: `list`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">not_first_loop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">prev_line_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sa">u</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log_event_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">ANACAPA_LOG_EVENT_PATTERN_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">log_lines_newline_delimited_list</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">log_event_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">curr_line_dict</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">curr_line_dict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">curr_line_dict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">curr_line_dict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">time_format_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">curr_line_dict</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_line_dict</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prev_line_dict</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">not_first_loop</span> <span class="ow">and</span> <span class="n">prev_line_dict</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">not_first_loop</span> <span class="ow">and</span> <span class="n">prev_line_dict</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev_line_dict</span><span class="p">)</span>
                <span class="n">prev_line_dict</span> <span class="o">=</span> <span class="n">curr_line_dict</span>
                <span class="n">not_first_loop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">prev_line_dict</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_line_dict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev_line_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.set_ext_audio_src_playing_flag"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.set_ext_audio_src_playing_flag">[docs]</a>    <span class="k">def</span> <span class="nf">set_ext_audio_src_playing_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">ext_audio_src_playing_flag</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">DUCK_EXT_AUDIO_SRC_PLAYING</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext_audio_src_playing_flag</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.is_ext_audio_src_playing"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.is_ext_audio_src_playing">[docs]</a>    <span class="k">def</span> <span class="nf">is_ext_audio_src_playing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Is ZP with UUID playing external audio source (as inferred from UDP logging)</span>

<span class="sd">        :param uuid: UUID of ZP</span>
<span class="sd">        :type uuid: :str:</span>

<span class="sd">        :return: Is external audio source playing based on UDP logging messages</span>
<span class="sd">        :rtype: :bool: or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">DUCK_EXT_AUDIO_SRC_PLAYING</span><span class="p">]</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.set_spdif_stream_type"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.set_spdif_stream_type">[docs]</a>    <span class="k">def</span> <span class="nf">set_spdif_stream_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">spdif_stream_type</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">DOLBY_SWITCHING_REGEX_PATTERN</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">spdif_stream_type</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_spdif_stream_type"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_spdif_stream_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_spdif_stream_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">DOLBY_SWITCHING_REGEX_PATTERN</span><span class="p">]</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.set_spdif_burst_type"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.set_spdif_burst_type">[docs]</a>    <span class="k">def</span> <span class="nf">set_spdif_burst_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">spdif_burst_type</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">SPDIF_BURST_REGEX_PATTERN</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">spdif_burst_type</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_spdif_burst_type"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_spdif_burst_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_spdif_burst_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">SPDIF_BURST_REGEX_PATTERN</span><span class="p">]</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.is_default_mixer_ducked"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.is_default_mixer_ducked">[docs]</a>    <span class="k">def</span> <span class="nf">is_default_mixer_ducked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Is default-mixer of ZP with UUID ducked (as inferred from UDP logging)</span>

<span class="sd">        :param uuid: UUID of ZP</span>
<span class="sd">        :type uuid: :str:</span>

<span class="sd">        :return: Is default-mixer of ZP with UUID ducked based on UDP logging messages</span>
<span class="sd">        :rtype: :bool: or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_DEFAULT_DUCKING</span><span class="p">]</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.is_hta_chsnk_mixer_ducked"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.is_hta_chsnk_mixer_ducked">[docs]</a>    <span class="k">def</span> <span class="nf">is_hta_chsnk_mixer_ducked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Is hta-chsnk-mixer of ZP with UUID ducked (as inferred from UDP logging)</span>

<span class="sd">        :param uuid: UUID of ZP</span>
<span class="sd">        :type uuid: :str:</span>

<span class="sd">        :return: Is hta-chsnk-mixer of ZP with UUID ducked based on UDP logging messages</span>
<span class="sd">        :rtype: :bool: or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_HTA_CHSNK_DUCKING</span><span class="p">]</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.is_inline_mixer_ducked"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.is_inline_mixer_ducked">[docs]</a>    <span class="k">def</span> <span class="nf">is_inline_mixer_ducked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Is inline-mixer of ZP with UUID ducked (as inferred from UDP logging)</span>

<span class="sd">        :param uuid: UUID of ZP</span>
<span class="sd">        :type uuid: :str:</span>

<span class="sd">        :return: Is inline-mixer of ZP with UUID ducked based on UDP logging messages</span>
<span class="sd">        :rtype: :bool: or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_INLINE_DUCKING</span><span class="p">]</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.set_segment_id"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.set_segment_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_segment_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set set_segment_id so that rows are inserted with segment_id as an additional column, perhaps for easy groupby.</span>

<span class="sd">        :param segment_id: Segment id.</span>
<span class="sd">        :type segment_id: :obj: `str` or `int`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segment_id</span> <span class="o">=</span> <span class="n">segment_id</span></div>

    <span class="k">def</span> <span class="nf">__metrics_detected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">counters</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call back for metrics string detected.  Executes in UDP Logger thread.</span>

<span class="sd">        :param zp: sonos zone player for which msg was detected</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param counters: Dictionary of the matched expression counters for zp</span>
<span class="sd">        :type counters: :obj:`dict`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span>
            <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span>
            <span class="s2">&quot;counter&quot;</span><span class="p">:</span> <span class="n">counters</span><span class="p">[</span><span class="n">expr</span><span class="p">],</span>
            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">msg</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">counters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;dolby&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">DOLBY_SWITCHING_REGEX_PATTERN</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">mgd</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                        <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&#39;s </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> changed from </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">zp</span><span class="p">,</span>
                            <span class="s2">&quot;spdif_stream_type&quot;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_spdif_stream_type</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()),</span>
                            <span class="n">mgd</span><span class="p">[</span><span class="s1">&#39;stream_to&#39;</span><span class="p">])</span>
                        <span class="n">data_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;spdif_stream_type&quot;</span><span class="p">:</span> <span class="n">mgd</span><span class="p">[</span><span class="s1">&#39;stream_to&#39;</span><span class="p">],</span>
                                <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">comment</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_spdif_stream_type</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span>
                                                   <span class="n">mgd</span><span class="p">[</span><span class="s1">&#39;stream_to&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;duck&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">DUCK_EXT_AUDIO_SRC_PLAYING</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_ext_audio_src_playing_flag</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">DUCK_EXT_AUDIO_SRC_STOPPED</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_ext_audio_src_playing_flag</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;htap&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">HTAP_EXT_AUDIO_SRC_PLAYING</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">mgd</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s1">&#39;ext_audio_state_new&#39;</span> <span class="ow">in</span> <span class="n">mgd</span> <span class="ow">and</span> <span class="n">mgd</span><span class="p">[</span><span class="s2">&quot;ext_audio_state_new&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_ext_audio_src_playing_flag</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span>
                                                                <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mgd</span><span class="p">[</span><span class="s2">&quot;ext_audio_state_new&quot;</span><span class="p">])))</span>
            <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;mixer&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_DEFAULT_DUCKING</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span>
                        <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_DEFAULT_DUCKING</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_DEFAULT_UN_DUCKING</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span>
                        <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_DEFAULT_DUCKING</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_HTA_CHSNK_DUCKING</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span>
                        <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_HTA_CHSNK_DUCKING</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_HTA_CHSNK_UN_DUCKING</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span>
                        <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_HTA_CHSNK_DUCKING</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_INLINE_DUCKING</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span>
                        <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_INLINE_DUCKING</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_INLINE_UN_DUCKING</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__current_metrics_states</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()][</span>
                        <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">MIXER_INLINE_DUCKING</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;spdif&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">SPDIF_BURST_REGEX_PATTERN</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">mgd</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                        <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&#39;s </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> changed from </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">zp</span><span class="p">,</span>
                            <span class="s2">&quot;spdif_burst_type&quot;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_spdif_burst_type</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()),</span>
                            <span class="n">mgd</span><span class="p">[</span><span class="s1">&#39;new_type&#39;</span><span class="p">])</span>
                        <span class="n">data_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;spdif_burst_type&quot;</span><span class="p">:</span> <span class="n">mgd</span><span class="p">[</span><span class="s1">&#39;new_type&#39;</span><span class="p">],</span>
                                <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">comment</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_spdif_burst_type</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">(),</span>
                                                   <span class="n">mgd</span><span class="p">[</span><span class="s1">&#39;new_type&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_timeline_data</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_datetime64_now"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_datetime64_now">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_datetime64_now</span><span class="p">():</span>
        <span class="n">utc_nanos</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e9</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">utc_nanos</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ns&#39;</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_datetime64</span><span class="p">()</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_Timestamp_now"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_Timestamp_now">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_Timestamp_now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="s2">&quot;US/Eastern&quot;</span><span class="p">):</span>
        <span class="n">utc_nanos</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e9</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">utc_nanos</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ns&#39;</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.add_standard_data_collection_to_timeline"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.add_standard_data_collection_to_timeline">[docs]</a>    <span class="k">def</span> <span class="nf">add_standard_data_collection_to_timeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">add_dict_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_logs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datetime64_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                 <span class="n">logs_lookback_secs</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span>
                                                 <span class="n">include_perf_stats</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add standard data collection to timeline using the current timestamp.  Once can choose to</span>
<span class="sd">        add additional data using add_dict_data and/or add_logs.</span>

<span class="sd">        :param zp: sonos zone player for which msg was detected</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param add_dict_data: Additional dictionary of data to be added to the data frame.</span>
<span class="sd">        :type add_dict_data: :obj:`dict`</span>

<span class="sd">        :param add_logs: Additional log lines to add to the udp_log buffer (in memory or zp).  Remember that when you</span>
<span class="sd">                            are watching a udp log, during the callback, the msg is not in the udp_log buffer yet</span>
<span class="sd">        :type add_logs: :obj:`str`</span>

<span class="sd">        :param datetime64_index: numpy.datetime64 to be used for the DatetimeIndex for the new row in the dataframe</span>
<span class="sd">        :type datetime64_index: :obj: `numpy.datetime64`</span>

<span class="sd">        :param logs_lookback_secs: How far back (in secs) from datetime64_index (or now() if datetime64_index is None)</span>
<span class="sd">                                    we want to collect the logs for this device?</span>
<span class="sd">        :type logs_lookback_secs: :obj: `int`</span>

<span class="sd">        :param include_perf_stats: Do we want to include performance stats from free and ps, etc?</span>
<span class="sd">        :type include_perf_stats: :obj: `bool`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">add_dict_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">add_dict_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">add_logs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">add_logs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">include_perf_stats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">include_perf_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__include_perf_stats_when_failure</span>
        <span class="c1"># We want to pass in the time now as the metrics gathering is in the order of seconds.</span>
        <span class="k">if</span> <span class="n">datetime64_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">datetime64_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_datetime64_now</span><span class="p">()</span>
        <span class="c1"># TODO: Throttle standard data collection of the same ZP to be max once per THROTTLED_STD_DATA_COLLECTION_PER_ZP_WINDOW</span>
        <span class="c1"># TODO: Then execute expensive data collection away from the UDP Logger thread...</span>
        <span class="c1"># TODO: Add to data collection deque.</span>
        <span class="n">base_dict_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;logs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_udp_log</span><span class="p">(</span><span class="n">add_logs</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">lookback_secs</span><span class="o">=</span><span class="n">logs_lookback_secs</span><span class="p">),</span>
            <span class="c1"># &quot;netstartd&quot;: zp.diag.get_raw_netstartd_log(),</span>
            <span class="c1"># &quot;localsettings&quot;: zp.diag.get_localsettings(),</span>
        <span class="p">}</span>
        <span class="n">add_dict_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base_dict_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_perf_stats</span><span class="p">:</span>
            <span class="c1"># Perf stats collection takes the order of seconds, very long!</span>
            <span class="c1"># self.__last_perf_stats_collection is not updated until after</span>
            <span class="c1"># collection.  If we move the update of the time BEFORE</span>
            <span class="c1"># the collection, then we run the risk of collection failing...</span>
            <span class="c1"># TODO: See above.  Deferred collection with OneShotTimer?</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__perf_stats_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;Collecting perf stats for &lt;</span><span class="si">{}</span><span class="s2">&gt;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">datetime64_index</span> <span class="o">-</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">__last_perf_stats_collection</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span> \
                        <span class="o">&gt;=</span> \
                        <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span>\
                        <span class="n">THROTTLED_STD_DATA_COLLECTION_PER_ZP_WINDOW</span><span class="p">:</span>
                    <span class="n">add_dict_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;perf&quot;</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_perf</span><span class="p">()</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(),</span>
                            <span class="s2">&quot;dmesg&quot;</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_raw_dmesg</span><span class="p">(),</span>
                            <span class="c1"># &quot;mem-used&quot;: zp.diag.get_memory_usage()[&#39;Used&#39;],</span>
                            <span class="c1"># &quot;mem-free&quot;: zp.diag.get_memory_usage()[&#39;Free&#39;],</span>
                            <span class="c1"># &quot;ps&quot;: zp.diag.get_ps(),</span>
                            <span class="c1"># &quot;top&quot;: zp.cli.command(&quot;top -n1&quot;),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__last_perf_stats_collection</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span> <span class="o">=</span> \
                        <span class="n">datetime64_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_timeline_data</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">add_dict_data</span><span class="p">,</span>
                               <span class="n">datetime64_index</span><span class="o">=</span><span class="n">datetime64_index</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.is_transition"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.is_transition">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_transition</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">local_uuid</span><span class="p">,</span>
            <span class="n">avturi</span><span class="p">,</span>
            <span class="n">htchanmapset</span><span class="p">,</span>
            <span class="n">chanmapset</span><span class="p">,</span>
            <span class="n">datetime64_index</span><span class="p">,</span>
            <span class="n">nanos_before</span><span class="o">=</span><span class="n">TRANSITION_ANALYSIS_NEIGHBOURHOOD_LOOKBACK_NANOS</span><span class="p">,</span>
            <span class="n">nanos_after</span><span class="o">=</span><span class="n">TRANSITION_ANALYSIS_NEIGHBOURHOOD_LOOKFORWARD_NANOS</span><span class="p">,</span>
            <span class="n">enable_spdif_transition_discount</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter out some known errors that will be excluded due to transition.</span>

<span class="sd">        :param df: DataFrame to do transition analysis from.</span>
<span class="sd">        :type df: :class:`~pandas.DataFrame`</span>

<span class="sd">        :param local_uuid: The UUID of the device that had the error.</span>
<span class="sd">        :type local_uuid: :obj: :str:</span>

<span class="sd">        :param avturi: The avturi of the device that had the error.</span>
<span class="sd">        :type avturi: :obj: :str:</span>

<span class="sd">        :param htchanmapset: The htchanmapset of the device that had the error.</span>
<span class="sd">        :type htchanmapset: :obj: :str:</span>

<span class="sd">        :param chanmapset: The chanmapset of the device that had the error.</span>
<span class="sd">        :type chanmapset: :obj: :str:</span>

<span class="sd">        :param datetime64_index: numpy.datetime64 to be used for the DatetimeIndex look back/forward</span>
<span class="sd">        :type datetime64_index: :obj: `numpy.datetime64`</span>

<span class="sd">        :param nanos_before: Nanos before datetime64_index to include in transition check</span>
<span class="sd">        :type nanos_before: :obj: :int:</span>

<span class="sd">        :param nanos_after: Nanos after datetime64_index to include in transition check</span>
<span class="sd">        :type df: :obj: :int:</span>

<span class="sd">        :return: Is ZP in transition? and the log string as a tuple</span>
<span class="sd">        :rtype: (:bool:, :str:)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Filter out errors that happens when a transition occur in the last X nanos</span>
        <span class="c1"># Use current time as a reference.</span>
        <span class="c1"># TODO: Investigate using timestamp from error message as a reference time</span>
        <span class="k">if</span> <span class="n">datetime64_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">datetime64_index</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_datetime64_now</span><span class="p">()</span>

        <span class="c1"># This is the extended failure neighbourhood, i.e. it looks further back than the transition check window</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extended_failure_neighbourhood</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_timeframe_neighbourhood</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span>
                <span class="n">datetime64_index</span><span class="p">,</span>
                <span class="n">nanos_before</span><span class="o">=</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">FAILURE_ANALYSIS_EXTENDED_NEIGHBOURHOOD_LOOKBACK_NANOS</span><span class="p">,</span>
                <span class="n">nanos_after</span><span class="o">=</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">FAILURE_ANALYSIS_EXTENDED_NEIGHBOURHOOD_LOOKFORWARD_NANOS</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># https://github.com/pandas-dev/pandas/issues/5821</span>
            <span class="c1"># Index slicing requires monotonicity (i.e. sortedness)</span>
            <span class="k">raise</span>

        <span class="c1"># New logic using groupby object, aggregating and applying...</span>
        <span class="c1"># Grealy simplifies but at the expense of brevity (which might not be that readable)</span>
        <span class="c1"># Grouped by UUID becuase we only want to anazlye delta per ZP/UUID</span>
        <span class="n">extended_failure_neighbourhood_grouped</span> <span class="o">=</span> \
            <span class="n">extended_failure_neighbourhood</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>

        <span class="c1">########################################################################</span>
        <span class="c1"># Checking for playback transition (start)</span>
        <span class="c1">########################################################################</span>
        <span class="c1"># To check playback transitions we need to check AVTransportURI,</span>
        <span class="c1"># CurrentTrackURI and/or TransportState</span>
        <span class="n">__partial_playback_transition_check_col_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">AVTransportURI_StateVariableName</span><span class="p">,</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">CurrentTrackURI_StateVariableName</span><span class="p">,</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">TransportState_StateVariableName</span>
        <span class="p">}</span>

        <span class="c1"># If we the test do not use  queue, it is unlikely that there will be</span>
        <span class="c1"># Track Number state variable change events, so the column might not</span>
        <span class="c1"># be available.</span>
        <span class="n">__full_playback_transition_check_col_names</span> <span class="o">=</span> \
            <span class="n">__partial_playback_transition_check_col_names</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">CurrentTrack_StateVariableName</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="n">playback_transition_check_col_names</span> <span class="o">=</span> \
            <span class="nb">list</span><span class="p">(</span><span class="n">__full_playback_transition_check_col_names</span><span class="p">)</span> \
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">extended_failure_neighbourhood</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span>
                <span class="n">__full_playback_transition_check_col_names</span>
            <span class="p">)</span> \
                <span class="k">else</span> \
                <span class="nb">list</span><span class="p">(</span><span class="n">__partial_playback_transition_check_col_names</span><span class="p">)</span> \
                    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">extended_failure_neighbourhood</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span>
                    <span class="n">__partial_playback_transition_check_col_names</span>
                <span class="p">)</span> \
                    <span class="k">else</span> <span class="p">[]</span>

        <span class="c1"># This will aggregate all columns and count the number of unique values...</span>
        <span class="c1"># ...then apply on the aggregated columns, all values greater than 1 (this will make then True/False)...</span>
        <span class="c1"># ...we then logical OR all row data (not column series) for each uuid (&quot;axis=1&quot; is very important here!)</span>
        <span class="c1"># uuid_playback_transition_series will have UUID as its index and represents if ZP with UUID transitions</span>

        <span class="c1"># We diff (using ne on the columns we want to check) by group with one shfited.  This is to</span>
        <span class="c1"># check if we have a value that has changed frome the previous one.</span>
        <span class="n">extended_playback_transition_check_shifted_ne_df</span> <span class="o">=</span> \
            <span class="n">extended_failure_neighbourhood_grouped</span><span class="p">[</span>
                <span class="n">playback_transition_check_col_names</span>
            <span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span>
                <span class="n">extended_failure_neighbourhood_grouped</span><span class="p">[</span>
                    <span class="n">playback_transition_check_col_names</span>
                <span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">extended_playback_transition_check_shifted_ne_df</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">extended_failure_neighbourhood</span><span class="o">.</span><span class="n">uuid</span>
        <span class="c1"># Now lets zoom in to just the transition check window.</span>
        <span class="n">playback_transition_check_shifted_ne_df</span> <span class="o">=</span> \
            <span class="n">extended_playback_transition_check_shifted_ne_df</span><span class="p">[</span>
                <span class="n">datetime64_index</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">nanoseconds</span><span class="o">=-</span><span class="n">nanos_before</span><span class="p">):</span>
                <span class="n">datetime64_index</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">nanoseconds</span><span class="o">=</span><span class="n">nanos_after</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="n">playback_transition_check_grouped</span> <span class="o">=</span> \
            <span class="n">playback_transition_check_shifted_ne_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;uuid&quot;</span><span class="p">])</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        playback_transition_check_grouped will be of this form:</span>
<span class="sd">        | uuid                      | AVTransportURI    | CurrentTrack  | CurrentTrackURI   | TransportState    |</span>
<span class="sd">        | RINCON_xxxxxxxxxxxx01400  | False             | False         | False             | False             |</span>
<span class="sd">        | RINCON_yyyyyyyyyyyy01400  | False             | False         | False             | False             |</span>
<span class="sd">        | RINCON_zzzzzzzzzzzz01400  | False             | False         | False             | False             |</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the extended has more rows than the transition window, there is no need to skip the</span>
        <span class="c1"># first row (the first row in the extended will always be True for all columns since when compared to</span>
        <span class="c1"># the previous &quot;nothing&quot; row, ne() will always be True).</span>
        <span class="n">skip_row</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">extended_playback_transition_check_shifted_ne_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> \
                <span class="n">playback_transition_check_shifted_ne_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">skip_row</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">uuid_playback_transition_series</span> <span class="o">=</span> \
            <span class="n">playback_transition_check_grouped</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">skip_row</span><span class="p">:]</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">y</span> <span class="ow">or</span> <span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        uuid_playback_transition_series will be of this form:</span>
<span class="sd">        | uuid                      | any()     |</span>
<span class="sd">        | RINCON_xxxxxxxxxxxx01400  | False     |</span>
<span class="sd">        | RINCON_yyyyyyyyyyyy01400  | False     |</span>
<span class="sd">        | RINCON_zzzzzzzzzzzz01400  | False     |</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Old logic using number of unique value in the neighbourhood.</span>
        <span class="c1"># This logic doesn&#39;t work because a device might remain dormant for a long time and the transition</span>
        <span class="c1"># change only happen just before the failure occur.  In this case, there isn&#39;t much in the transition</span>
        <span class="c1"># window as there is perhaps only one event (in the past X time) and so nunique() ain&#39;t gonna work.</span>
        <span class="c1"># uuid_playback_transition_series = extended_failure_neighbourhood_grouped[</span>
        <span class="c1">#     playback_transition_check_col_names].\</span>
        <span class="c1">#     aggregate(lambda x: x.nunique()).\</span>
        <span class="c1">#     apply(lambda x: x &gt; 1).\</span>
        <span class="c1">#     apply(lambda x: reduce(lambda y, z: y or z, x), axis=1)</span>
        <span class="c1">########################################################################</span>
        <span class="c1"># Checking for playback transition (end)</span>
        <span class="c1">########################################################################</span>

        <span class="c1">########################################################################</span>
        <span class="c1"># Checking for spdif transition (start)</span>
        <span class="c1">########################################################################</span>
        <span class="k">if</span> <span class="n">enable_spdif_transition_discount</span><span class="p">:</span>
            <span class="c1"># To check spdif transitions we need to check spdif_stream_type and</span>
            <span class="c1"># spdif_burst_type</span>
            <span class="n">spdif_transition_check_col_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;spdif_stream_type&quot;</span><span class="p">,</span>
                <span class="s2">&quot;spdif_burst_type&quot;</span>
            <span class="p">]</span>

            <span class="c1"># This will aggregate all columns and count the number of unique values...</span>
            <span class="c1"># ...then apply on the aggregated columns, all values greater than 1 (this will make then True/False)...</span>
            <span class="c1"># ...we then logical OR all row data (not column series) for each uuid (&quot;axis=1&quot; is very important here!)</span>
            <span class="c1"># uuid_playback_transition_series will have UUID as its index and represents if ZP with UUID transitions</span>

            <span class="c1"># We diff (using ne on the columns we want to check) by group with one shfited.  This is to</span>
            <span class="c1"># check if we have a value that has changed frome the previous one.</span>
            <span class="n">extended_spdif_transition_check_shifted_ne_df</span> <span class="o">=</span> \
                <span class="n">extended_failure_neighbourhood_grouped</span><span class="p">[</span>
                    <span class="n">spdif_transition_check_col_names</span>
                <span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span>
                    <span class="n">extended_failure_neighbourhood_grouped</span><span class="p">[</span>
                        <span class="n">spdif_transition_check_col_names</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">extended_spdif_transition_check_shifted_ne_df</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">extended_failure_neighbourhood</span><span class="o">.</span><span class="n">uuid</span>
            <span class="c1"># Now lets zoom in to just the transition check window.</span>
            <span class="n">spdif_transition_check_shifted_ne_df</span> <span class="o">=</span> \
                <span class="n">extended_spdif_transition_check_shifted_ne_df</span><span class="p">[</span>
                <span class="n">datetime64_index</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">nanoseconds</span><span class="o">=-</span><span class="n">nanos_before</span><span class="p">):</span>
                <span class="n">datetime64_index</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">nanoseconds</span><span class="o">=</span><span class="n">nanos_after</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="n">spdif_transition_check_grouped</span> <span class="o">=</span> \
                <span class="n">spdif_transition_check_shifted_ne_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;uuid&quot;</span><span class="p">])</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            spdif_transition_check_grouped will be of this form:</span>
<span class="sd">            | uuid                      | spdif_stream_type | spdif_burst_type  |</span>
<span class="sd">            | RINCON_xxxxxxxxxxxx01400  | False             | False             |</span>
<span class="sd">            | RINCON_yyyyyyyyyyyy01400  | False             | False             |</span>
<span class="sd">            | RINCON_zzzzzzzzzzzz01400  | False             | False             |</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># If the extended has more rows than the transition window, there is no need to skip the</span>
            <span class="c1"># first row (the first row in the extended will always be True for all columns since when compared to</span>
            <span class="c1"># the previous &quot;nothing&quot; row, ne() will always be True).</span>
            <span class="n">skip_row</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">extended_spdif_transition_check_shifted_ne_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> \
                    <span class="n">spdif_transition_check_shifted_ne_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">skip_row</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">uuid_spdif_transition_series</span> <span class="o">=</span> \
                <span class="n">spdif_transition_check_grouped</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">skip_row</span><span class="p">:]</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">y</span> <span class="ow">or</span> <span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            uuid_spdif_transition_series will be of this form:</span>
<span class="sd">            | uuid                      | any()     |</span>
<span class="sd">            | RINCON_xxxxxxxxxxxx01400  | False     |</span>
<span class="sd">            | RINCON_yyyyyyyyyyyy01400  | False     |</span>
<span class="sd">            | RINCON_zzzzzzzzzzzz01400  | False     |</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uuid_spdif_transition_series</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">########################################################################</span>
        <span class="c1"># Checking for spdif transition (end)</span>
        <span class="c1">########################################################################</span>

        <span class="c1">########################################################################</span>
        <span class="c1"># Checking for grouping transition (start)</span>
        <span class="c1">########################################################################</span>
        <span class="c1"># To check grouping actions, we only need to check AVTransportURI</span>
        <span class="n">grouping_transition_check_col_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">AVTransportURI_StateVariableName</span>
        <span class="p">]</span>
        <span class="c1"># We diff (using ne on the columns we want to check) by group with one shfited.  This is to</span>
        <span class="c1"># check if we have a value that has changed frome the previous one.</span>
        <span class="n">extended_grouping_transition_check_shifted_ne_df</span> <span class="o">=</span> \
            <span class="n">extended_failure_neighbourhood_grouped</span><span class="p">[</span>
                <span class="n">grouping_transition_check_col_names</span>
            <span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span>
                <span class="n">extended_failure_neighbourhood_grouped</span><span class="p">[</span>
                    <span class="n">grouping_transition_check_col_names</span>
                <span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">extended_grouping_transition_check_shifted_ne_df</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">extended_failure_neighbourhood</span><span class="o">.</span><span class="n">uuid</span>
        <span class="c1"># Now lets zoom in to just the transition check window.</span>
        <span class="n">grouping_transition_check_shifted_ne_df</span> <span class="o">=</span> \
            <span class="n">extended_grouping_transition_check_shifted_ne_df</span><span class="p">[</span>
            <span class="n">datetime64_index</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">nanoseconds</span><span class="o">=-</span><span class="n">nanos_before</span><span class="p">):</span>
            <span class="n">datetime64_index</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">nanoseconds</span><span class="o">=</span><span class="n">nanos_after</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="n">grouping_transition_check_grouped</span> <span class="o">=</span> \
            <span class="n">grouping_transition_check_shifted_ne_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;uuid&quot;</span><span class="p">])</span>
        <span class="c1"># We remove the first row since it always compares to a previous value that is shifted out.</span>
        <span class="n">uuid_grouping_transition_series</span> <span class="o">=</span> \
            <span class="n">grouping_transition_check_grouped</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">y</span> <span class="ow">or</span> <span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Old logic using number of unique value in the neighbourhood</span>
        <span class="c1"># This logic doesn&#39;t work because a device might remain dormant for a long time and the transition</span>
        <span class="c1"># change only happen just before the failure occur.  In this case, there isn&#39;t much in the transition</span>
        <span class="c1"># window as there is perhaps only one event (in the past X time) and so nunique() ain&#39;t gonna work.</span>
        <span class="c1"># uuid_grouping_transition_series = extended_failure_neighbourhood_grouped[</span>
        <span class="c1">#     grouping_transition_check_col_names]. \</span>
        <span class="c1">#     aggregate(lambda x: x.nunique()). \</span>
        <span class="c1">#     apply(lambda x: x &gt; 1). \</span>
        <span class="c1">#     apply(lambda x: reduce(lambda y, z: y or z, x), axis=1)</span>
        <span class="c1">########################################################################</span>
        <span class="c1"># Checking for grouping transition (end)</span>
        <span class="c1">########################################################################</span>

        <span class="c1">########################################################################</span>
        <span class="c1"># Checking for bonding transition (start)</span>
        <span class="c1">########################################################################</span>
        <span class="c1"># To check bonding actions, we need to check HTSatChanMapSet (HT) or ChannelMapSet (stereo)</span>
        <span class="n">bonding_transition_check_col_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">HTSatChanMapSet_StateVariableName</span><span class="p">,</span>
            <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">ChannelMapSet_StateVariableName</span>
        <span class="p">]</span>

        <span class="c1"># We diff (using ne on the columns we want to check) by group with one shfited.  This is to</span>
        <span class="c1"># check if we have a value that has changed frome the previous one.</span>
        <span class="n">extended_bonding_transition_check_shifted_ne_df</span> <span class="o">=</span> \
            <span class="n">extended_failure_neighbourhood_grouped</span><span class="p">[</span>
                <span class="n">bonding_transition_check_col_names</span>
            <span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span>
                <span class="n">extended_failure_neighbourhood_grouped</span><span class="p">[</span>
                    <span class="n">bonding_transition_check_col_names</span>
                <span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">extended_bonding_transition_check_shifted_ne_df</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">extended_failure_neighbourhood</span><span class="o">.</span><span class="n">uuid</span>
        <span class="c1"># Now lets zoom in to just the transition check window.</span>
        <span class="n">bonding_transition_check_shifted_ne_df</span> <span class="o">=</span> \
            <span class="n">extended_bonding_transition_check_shifted_ne_df</span><span class="p">[</span>
            <span class="n">datetime64_index</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">nanoseconds</span><span class="o">=-</span><span class="n">nanos_before</span><span class="p">):</span>
            <span class="n">datetime64_index</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">nanoseconds</span><span class="o">=</span><span class="n">nanos_after</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="n">bonding_transition_check_grouped</span> <span class="o">=</span> \
            <span class="n">bonding_transition_check_shifted_ne_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;uuid&quot;</span><span class="p">])</span>
        <span class="c1"># We remove the first row since it always compares to a previous value that is shifted out.</span>
        <span class="n">uuid_bonding_transition_series</span> <span class="o">=</span> \
            <span class="n">bonding_transition_check_grouped</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">y</span> <span class="ow">or</span> <span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Old logic using number of unique value in the neighbourhood</span>
        <span class="c1"># This logic doesn&#39;t work because a device might remain dormant for a long time and the transition</span>
        <span class="c1"># change only happen just before the failure occur.  In this case, there isn&#39;t much in the transition</span>
        <span class="c1"># window as there is perhaps only one event (in the past X time) and so nunique() ain&#39;t gonna work.</span>
        <span class="c1"># uuid_bonding_transition_series = extended_failure_neighbourhood_grouped[</span>
        <span class="c1">#     bonding_transition_check_col_names]. \</span>
        <span class="c1">#     aggregate(lambda x: x.nunique()). \</span>
        <span class="c1">#     apply(lambda x: x &gt; 1). \</span>
        <span class="c1">#     apply(lambda x: reduce(lambda y, z: y or z, x), axis=1)</span>
        <span class="c1">########################################################################</span>
        <span class="c1"># Checking for bonding transition (end)</span>
        <span class="c1">########################################################################</span>

        <span class="k">if</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_if_stereo_secondary_bonded</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">):</span>
            <span class="c1"># Error on Stereo Secondary Bonded device</span>
            <span class="n">pri_uuid</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_primary_bonded_uuid_from_secondary_bonded_</span><span class="p">(</span><span class="n">chanmapset</span><span class="p">,</span>
                                                                                                 <span class="n">local_uuid</span><span class="p">)</span>
            <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error happened on Stereo Secondary Bonded: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_uuid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pri_uuid</span> <span class="ow">in</span> <span class="n">uuid_playback_transition_series</span> <span class="ow">and</span> \
                    <span class="n">uuid_playback_transition_series</span><span class="p">[</span><span class="n">pri_uuid</span><span class="p">]:</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot; during playback transition on Stereo Primary Bonded: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pri_uuid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pri_uuid</span> <span class="ow">in</span> <span class="n">uuid_spdif_transition_series</span> <span class="ow">and</span> \
                    <span class="n">uuid_spdif_transition_series</span><span class="p">[</span><span class="n">pri_uuid</span><span class="p">]:</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot; during spdif transition on Stereo Primary Bonded: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pri_uuid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">local_uuid</span> <span class="ow">in</span> <span class="n">uuid_bonding_transition_series</span> <span class="ow">and</span> \
                    <span class="n">uuid_bonding_transition_series</span><span class="p">[</span><span class="n">local_uuid</span><span class="p">]:</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot; during bonding transition on Stereo Secondary Bonded: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_uuid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_if_ht_secondary_bonded</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">):</span>
            <span class="c1"># Error on HT Secondary Bonded device</span>
            <span class="n">pri_uuid</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_primary_bonded_uuid_from_secondary_bonded_</span><span class="p">(</span><span class="n">htchanmapset</span><span class="p">,</span>
                                                                                                 <span class="n">local_uuid</span><span class="p">)</span>
            <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error happened on HT Secondary Bonded: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_uuid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pri_uuid</span> <span class="ow">in</span> <span class="n">uuid_playback_transition_series</span> <span class="ow">and</span> \
                    <span class="n">uuid_playback_transition_series</span><span class="p">[</span><span class="n">pri_uuid</span><span class="p">]:</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot; during playback transition on HT Primary Bonded: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pri_uuid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pri_uuid</span> <span class="ow">in</span> <span class="n">uuid_spdif_transition_series</span> <span class="ow">and</span> \
                    <span class="n">uuid_spdif_transition_series</span><span class="p">[</span><span class="n">pri_uuid</span><span class="p">]:</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot; during spdif transition on HT Primary Bonded: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pri_uuid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">local_uuid</span> <span class="ow">in</span> <span class="n">uuid_bonding_transition_series</span> <span class="ow">and</span> \
                    <span class="n">uuid_bonding_transition_series</span><span class="p">[</span><span class="n">local_uuid</span><span class="p">]:</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot; during bonding transition on HT Secondary Bonded: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_uuid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_if_secondary_grouped</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">):</span>
            <span class="c1"># Error on Secondary Grouped device</span>
            <span class="n">pri_uuid</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_primary_grouped_uuid_from_secondary_grouped</span><span class="p">(</span><span class="n">avturi</span><span class="p">)</span>
            <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error happened on Secondary Grouped: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_uuid</span><span class="p">)</span>
            <span class="c1"># Check playback transition on primary grouped.</span>
            <span class="k">if</span> <span class="n">pri_uuid</span> <span class="ow">in</span> <span class="n">uuid_playback_transition_series</span> <span class="ow">and</span> \
                    <span class="n">uuid_playback_transition_series</span><span class="p">[</span><span class="n">pri_uuid</span><span class="p">]:</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot; during playback transition on Primary Grouped: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pri_uuid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pri_uuid</span> <span class="ow">in</span> <span class="n">uuid_spdif_transition_series</span> <span class="ow">and</span> \
                    <span class="n">uuid_spdif_transition_series</span><span class="p">[</span><span class="n">pri_uuid</span><span class="p">]:</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot; during spdif transition on Primary Grouped: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pri_uuid</span><span class="p">)</span>

            <span class="c1"># Check grouping transition in secondary grouped</span>
            <span class="k">if</span> <span class="n">local_uuid</span> <span class="ow">in</span> <span class="n">uuid_grouping_transition_series</span> <span class="ow">and</span> \
                    <span class="n">uuid_grouping_transition_series</span><span class="p">[</span><span class="n">local_uuid</span><span class="p">]:</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot; during grouping transition on Secondary Grouped: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_uuid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_if_primary_grouped</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span>
                                                                <span class="n">htchanmapset</span><span class="p">,</span>
                                                                <span class="n">chanmapset</span><span class="p">,</span>
                                                                <span class="n">local_uuid</span><span class="p">):</span>
            <span class="c1"># Error was found on a GC</span>
            <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error happened on GC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_uuid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">local_uuid</span> <span class="ow">in</span> <span class="n">uuid_playback_transition_series</span> <span class="ow">and</span> \
                    <span class="n">uuid_playback_transition_series</span><span class="p">[</span><span class="n">local_uuid</span><span class="p">]:</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot; during playback transition on GC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_uuid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">local_uuid</span> <span class="ow">in</span> <span class="n">uuid_spdif_transition_series</span> <span class="ow">and</span> \
                    <span class="n">uuid_spdif_transition_series</span><span class="p">[</span><span class="n">local_uuid</span><span class="p">]:</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log_str</span> <span class="o">+=</span> <span class="s2">&quot; during spdif transition on GC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_uuid</span><span class="p">)</span>

        <span class="n">log_str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">is_transition</span><span class="p">,</span> <span class="n">log_str</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.is_conditional_error"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.is_conditional_error">[docs]</a>    <span class="k">def</span> <span class="nf">is_conditional_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">counters</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter out some known conditions/expressions that are errors/not errors.</span>

<span class="sd">        :param msg: The log message logged by module &lt;m&gt;</span>

<span class="sd">        :param zp: sonos zone player for which msg was detected</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param m: The module that logged this message</span>
<span class="sd">        :param expr: The expression that matched this message</span>
<span class="sd">        :param l: module log level</span>

<span class="sd">        :param counters: Dictionary of the matched expression counters for zp</span>
<span class="sd">        :type counters: :obj:`dict`</span>

<span class="sd">        :return: True/False if error, True/False if allowed transition check,</span>
<span class="sd">        True/False to collect perf stats when error and the log string as a</span>
<span class="sd">        4-tuple.  If flag for collect perf stats is None, it means to follow</span>
<span class="sd">        &quot;global&quot; policy (duting constructor).</span>
<span class="sd">        :rtype: (:bool:, :bool:, :bool:, :str:)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: Make this more elegant.</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        [1970-01-01 00:03:33.681] &lt;lla,0&gt; underflow: error code 5: uf 0 tr 209.225670 ct 209.220153 oa 0.000000</span>
<span class="sd">        ob -1.000000 bp 209.220030 ap 209.220153 le 5 lt 0.000000 lc 1</span>

<span class="sd">        [1970-01-01 00:03:33.681] &lt;chsnk,1&gt; LSE: stream underflow, uf 0 od 45238</span>

<span class="sd">        [1970-01-01 00:03:33.681] &lt;sound_wembley,1&gt; start of playback: 0 s: 5 underflows 0</span>

<span class="sd">        Above are not errors since the integer after &quot;uf&quot;/&quot;underflows&quot; are zero, meaning zero number of underflows.</span>
<span class="sd">        </span>
<span class="sd">        [1970-01-01 00:03:33.681] &lt;htasrc,1&gt; LE: [447209990] LEP: [447209767] IC:[18446744064458412296] ICP: [</span>
<span class="sd">        486765452] IL: [8499379589] RT: [9251139320] err: [-9737905015] errf: -29633854.798597 RE: [</span>
<span class="sd">        18446744064458412296] AP: [39555705] RL: [0]</span>

<span class="sd">        Above is not an error unless IC and ICP differs by more than 3%:</span>
<span class="sd">        &gt;&gt;&gt; math.log10(0.97)</span>
<span class="sd">        -0.01322826573375516</span>
<span class="sd">        &gt;&gt;&gt; math.log10(1.03)</span>
<span class="sd">        0.012837224705172217</span>

<span class="sd">        [1970-01-01 00:03:33.681] &lt;htasrc,0&gt; Muting SRC. rate = 0.952381, error = 29633854.798597, current canonical rate = 48000, mute adj. ratio = 1.016000, errmax = 100.000000 slip = 0</span>
<span class="sd">        Not an error if abs(error) is less than 100.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We default to be error unless certain conditions are true.</span>
        <span class="n">is_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># We allow transition check unless explicitly turned off due to an</span>
        <span class="c1"># absolute error</span>
        <span class="n">allow_transition_check</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Default to NOT collect perf stats</span>
        <span class="n">include_perf_stats</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;lla&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> \
                    <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">LLA_UNDERFLOW_CONDITIONAL_REGEX_PATTERN</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">include_perf_stats</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># mgd = match.groupdict()</span>
                    <span class="c1"># https://jira.sonos.com/browse/SWPBL-92898</span>
                    <span class="c1"># https://jira.sonos.com/browse/SWPBL-72482</span>
                    <span class="c1"># https://jira.sonos.com/browse/SWPBL-93444</span>
                    <span class="c1"># &quot;&lt;lla,0&gt; underflow: error code 5: uf 0&quot; is actually an</span>
                    <span class="c1"># underflow.  The reason uf is 0 is because the driver we got</span>
                    <span class="c1"># get to print the uf count before it can be updated.</span>
                    <span class="c1"># if &#39;underflows&#39; in mgd and mgd[&quot;underflows&quot;] is not None and int(mgd[&quot;underflows&quot;]) == 0:</span>
                    <span class="c1">#     log_str = &quot;Skipping non-error {}&quot;.format(mgd)</span>
                    <span class="c1">#     is_error = False</span>
        <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;chsnk&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> \
                    <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">CHSNK_UNDERFLOW_CONDITIONAL_REGEX_PATTERN</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">mgd</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;underflows&#39;</span> <span class="ow">in</span> <span class="n">mgd</span> <span class="ow">and</span> <span class="n">mgd</span><span class="p">[</span><span class="s2">&quot;underflows&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">mgd</span><span class="p">[</span><span class="s2">&quot;underflows&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;Skipping non-error </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mgd</span><span class="p">)</span>
                        <span class="n">is_error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;sound_wembley&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> \
                    <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">SOUND_WEMBLY_UNDERFLOW_CONDITIONAL_REGEX_PATTERN</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">mgd</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;underflows&#39;</span> <span class="ow">in</span> <span class="n">mgd</span> <span class="ow">and</span> <span class="n">mgd</span><span class="p">[</span><span class="s2">&quot;underflows&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">mgd</span><span class="p">[</span><span class="s2">&quot;underflows&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;Skipping non-error </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mgd</span><span class="p">)</span>
                        <span class="n">is_error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;htap&#39;</span><span class="p">:</span>
            <span class="n">include_perf_stats</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;htasrc&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> \
                    <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">HTASRC_SRC_VERBOSE_CONDITIONAL_REGEX_PATTERN</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="c1"># We use &quot;Innocent until proven guilty&quot; for this matched</span>
                    <span class="c1"># expression.</span>
                    <span class="n">is_error</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">mgd</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;IC&#39;</span> <span class="ow">in</span> <span class="n">mgd</span> <span class="ow">and</span> <span class="n">mgd</span><span class="p">[</span><span class="s2">&quot;IC&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;ICP&#39;</span> <span class="ow">in</span> <span class="n">mgd</span> <span class="ow">and</span> <span class="n">mgd</span><span class="p">[</span><span class="s2">&quot;ICP&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># IC and ICP are formatted as unsigned 64 in htaudio_samplerateconverter.cxx,</span>
                        <span class="c1"># so should not be negative.  Check non-zero to prevent zero division.</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">mgd</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">mgd</span><span class="p">[</span><span class="s1">&#39;ICP&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">include_perf_stats</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;IC or ICP must be positive: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mgd</span><span class="p">)</span>
                            <span class="n">is_error</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">allow_transition_check</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">mgd</span><span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">mgd</span><span class="p">[</span><span class="s1">&#39;ICP&#39;</span><span class="p">]):</span>
                            <span class="n">include_perf_stats</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;IC must be &gt;= ICP: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mgd</span><span class="p">)</span>
                            <span class="n">is_error</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">allow_transition_check</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1"># SWPBL-95787: No need to compare IC with IC as it</span>
                        <span class="c1"># gets reset upon certain criteria.</span>
                        <span class="c1"># elif int(mgd[&quot;IC&quot;]) &lt; self.__zp_ic[</span>
                        <span class="c1">#         zp.device.get_uuid()]:</span>
                        <span class="c1">#     include_perf_stats = None</span>
                        <span class="c1">#     log_str = &quot;IC has gone backwards&quot;</span>
                        <span class="c1">#     is_error = True</span>
                        <span class="c1">#     allow_transition_check = False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__zp_ic</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mgd</span><span class="p">[</span><span class="s2">&quot;IC&quot;</span><span class="p">])</span>

                        <span class="c1"># TODO: Study more on the exact meaning of the data before re-enabling.</span>
                        <span class="c1"># elif (1.0 - UDPDiagnosticModuleMonitor.HTASRC_TOLERANCE) &lt;= \</span>
                        <span class="c1">#         (float(mgd[&#39;IC&#39;]) / float(mgd[&#39;ICP&#39;])) &lt;= \</span>
                        <span class="c1">#         (1.0 + UDPDiagnosticModuleMonitor.HTASRC_TOLERANCE):</span>
                        <span class="c1">#     log_str = &quot;Skipping non-error {}&quot;.format(mgd)</span>
                        <span class="c1">#     is_error = False</span>
            <span class="c1"># TODO: Study more on the exact meaning of the data before re-enabling.</span>
            <span class="c1"># else:</span>
            <span class="c1">#     htasrc_src_muting_log_pattern = UDPDiagnosticModuleMonitor.ANACAPA_LOG_EVENT_PATTERN_TEMPLATE.format(</span>
            <span class="c1">#         UDPDiagnosticModuleMonitor.HTASRC_SRC_MUTING_CONDITIONAL_REGEX_PATTERN)</span>
            <span class="c1">#     match = re.search(htasrc_src_muting_log_pattern, msg)</span>
            <span class="c1">#     if match:</span>
            <span class="c1">#         mgd = match.groupdict()</span>
            <span class="c1">#         if &#39;error&#39; in mgd and mgd[&quot;error&quot;] is not None and &#39;errmax&#39; in mgd and mgd[&quot;errmax&quot;] is not None:</span>
            <span class="c1">#             if abs(float(mgd[&quot;error&quot;])) &lt; abs(float(mgd[&quot;errmax&quot;])):</span>
            <span class="c1">#                 log_str = &quot;Skipping non-error {}&quot;.format(mgd)</span>
            <span class="c1">#                 is_error = False</span>
        <span class="k">return</span> <span class="n">is_error</span><span class="p">,</span> <span class="n">allow_transition_check</span><span class="p">,</span> <span class="n">include_perf_stats</span><span class="p">,</span> <span class="n">log_str</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_current_test_name"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_current_test_name">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_current_test_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current running test name.</span>

<span class="sd">        :return: The current running test name.</span>
<span class="sd">        :rtype: :str:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="k">def</span> <span class="nf">__fatal_error_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">counters</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call back for UDP logging matching fatal (BASE) expressions.  Executes in UDP Logger thread.</span>

<span class="sd">        WARNING: Never ever call a method in the UPNP reactor thread.  There is a chance of deadlock.</span>
<span class="sd">        https://jira.sonos.com/browse/SWPBL-65679</span>

<span class="sd">        :param zp: sonos zone player for which msg was detected</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param counters: Dictionary of the matched expression counters for zp</span>
<span class="sd">        :type counters: :obj:`dict`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fatal_error_check_enabled</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">datetime64_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_datetime64_now</span><span class="p">()</span>
        <span class="n">local_uuid</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()</span>

        <span class="c1"># Get current avturi for zp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">local_uuid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span> <span class="ow">and</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">AVTransportURI_StateVariableName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span>
                        <span class="n">local_uuid</span><span class="p">]):</span>
            <span class="n">avturi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">avturi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">local_uuid</span><span class="p">][</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">AVTransportURI_StateVariableName</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="c1"># Get current htchanmapset for zp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">local_uuid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span> <span class="ow">and</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">HTSatChanMapSet_StateVariableName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span>
                        <span class="n">local_uuid</span><span class="p">]):</span>
            <span class="n">htchanmapset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">htchanmapset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">local_uuid</span><span class="p">][</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">HTSatChanMapSet_StateVariableName</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="c1"># Get current chanmapset for zp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">local_uuid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span> <span class="ow">and</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">ChannelMapSet_StateVariableName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span>
                        <span class="n">local_uuid</span><span class="p">]):</span>
            <span class="n">chanmapset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chanmapset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">local_uuid</span><span class="p">][</span>
                <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">ChannelMapSet_StateVariableName</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="c1"># Filter out SH4 errors, SWPBL-84394</span>
        <span class="n">zp_arch</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">get_arch</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">zp_arch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__error_exclusion_arches_list</span><span class="p">:</span>
            <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;Discounting errors on </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp_arch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Rolling back error counters...&quot;</span><span class="p">)</span>
            <span class="n">counters</span><span class="p">[</span><span class="n">expr</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_timeline_data</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span>
                                   <span class="p">{</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span> <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span>
                                    <span class="s2">&quot;counter&quot;</span><span class="p">:</span> <span class="n">counters</span><span class="p">[</span><span class="n">expr</span><span class="p">],</span>
                                    <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;[Test name: </span><span class="si">{}</span><span class="s2">][Filtered out error: </span><span class="si">{}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">get_current_test_name</span><span class="p">(),</span> <span class="n">log_str</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="p">},</span>
                                   <span class="n">datetime64_index</span><span class="o">=</span><span class="n">datetime64_now</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Filter out non-error and still log the matched encounter</span>
        <span class="p">(</span><span class="n">is_error</span><span class="p">,</span> <span class="n">allow_transition_check</span><span class="p">,</span> <span class="n">include_perf_stats</span><span class="p">,</span> <span class="n">log_str</span><span class="p">)</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">is_conditional_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">counters</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Rolling back error counters...&quot;</span><span class="p">)</span>
            <span class="n">counters</span><span class="p">[</span><span class="n">expr</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_timeline_data</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span>
                                   <span class="p">{</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span> <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span>
                                    <span class="s2">&quot;counter&quot;</span><span class="p">:</span> <span class="n">counters</span><span class="p">[</span><span class="n">expr</span><span class="p">],</span>
                                    <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;[Test name: </span><span class="si">{}</span><span class="s2">][Filtered out error: </span><span class="si">{}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">get_current_test_name</span><span class="p">(),</span> <span class="n">log_str</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="p">},</span>
                                   <span class="n">datetime64_index</span><span class="o">=</span><span class="n">datetime64_now</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># There is an error...is this an absolute error regardless of the</span>
        <span class="c1"># state of the ZPs or is error dependent on certain states,</span>
        <span class="c1"># like transitional changes?</span>
        <span class="k">if</span> <span class="n">allow_transition_check</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__timeframe_lock</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">is_transition</span><span class="p">,</span> <span class="n">log_str</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_transition</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_df</span><span class="p">(),</span>
                        <span class="n">local_uuid</span><span class="p">,</span>
                        <span class="n">avturi</span><span class="p">,</span>
                        <span class="n">htchanmapset</span><span class="p">,</span>
                        <span class="n">chanmapset</span><span class="p">,</span>
                        <span class="n">datetime64_now</span><span class="p">,</span>
                        <span class="n">enable_spdif_transition_discount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__enable_spdif_transition_discount</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeline_df</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_monotonic</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="s2">&quot;Index of timeline_df is not &quot;</span>
                                     <span class="s2">&quot;monotonic.  Transitional checks not &quot;</span>
                                     <span class="s2">&quot;possible&quot;</span><span class="p">)</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">log_str</span> <span class="o">=</span> <span class="n">ke</span><span class="o">.</span><span class="n">message</span>
            <span class="k">except</span> <span class="ne">RuntimeWarning</span> <span class="k">as</span> <span class="n">rtw</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="n">rtw</span><span class="p">)</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">log_str</span> <span class="o">=</span> <span class="n">rtw</span><span class="o">.</span><span class="n">message</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">rte</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_err</span><span class="p">(</span><span class="n">rte</span><span class="p">)</span>
                <span class="n">is_transition</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">log_str</span> <span class="o">=</span> <span class="n">rte</span><span class="o">.</span><span class="n">message</span>

            <span class="k">if</span> <span class="n">is_transition</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">&quot;Rolling back error counters...&quot;</span><span class="p">)</span>
                <span class="n">counters</span><span class="p">[</span><span class="n">expr</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_timeline_data</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span>
                                       <span class="p">{</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span> <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span>
                                        <span class="s2">&quot;counter&quot;</span><span class="p">:</span> <span class="n">counters</span><span class="p">[</span><span class="n">expr</span><span class="p">],</span>
                                        <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;[Test name: </span><span class="si">{}</span><span class="s2">][Error during transition]: </span><span class="si">{}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">get_current_test_name</span><span class="p">(),</span> <span class="n">log_str</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="p">},</span>
                                       <span class="n">datetime64_index</span><span class="o">=</span><span class="n">datetime64_now</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">log_str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>

        <span class="n">err_str</span> <span class="o">=</span> <span class="s2">&quot;Errors detected for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">zp</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">counters</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_err</span><span class="p">(</span><span class="n">err_str</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;Collecting failure data for &lt;</span><span class="si">{}</span><span class="s2">&gt;: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">zp</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">counters</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_standard_data_collection_to_timeline</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">add_dict_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span>
                                                                         <span class="s2">&quot;expr&quot;</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span>
                                                                         <span class="s2">&quot;counter&quot;</span><span class="p">:</span> <span class="n">counters</span><span class="p">[</span><span class="n">expr</span><span class="p">],</span>
                                                                         <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;[Test name: </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">get_current_test_name</span><span class="p">())</span> <span class="o">+</span> <span class="n">msg</span><span class="p">},</span>
                                                      <span class="n">add_logs</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                                                      <span class="n">datetime64_index</span><span class="o">=</span><span class="n">datetime64_now</span><span class="p">,</span>
                                                      <span class="n">include_perf_stats</span><span class="o">=</span><span class="n">include_perf_stats</span><span class="p">)</span>

        <span class="c1"># Collect GC or HT Master&#39;s logs if the failure occure on a GM or Satellites.</span>
        <span class="n">local_uuid</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># See WARNING above: https://jira.sonos.com/browse/SWPBL-65679</span>
            <span class="c1"># avturi = zp.AVTransport.get_avtransport_uri()</span>
            <span class="k">if</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_if_secondary_grouped</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">):</span>
                <span class="n">pri_uuid</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_primary_grouped_uuid_from_secondary_grouped</span><span class="p">(</span><span class="n">avturi</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pri_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pri_uuid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_standard_data_collection_to_timeline</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">pri_uuid</span><span class="p">][</span><span class="s2">&quot;szc&quot;</span><span class="p">],</span>
                        <span class="n">add_dict_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;Collecting GC:</span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> logs of GM:</span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pri_uuid</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)},</span>
                        <span class="n">datetime64_index</span><span class="o">=</span><span class="n">datetime64_now</span><span class="p">,</span>
                        <span class="n">include_perf_stats</span><span class="o">=</span><span class="n">include_perf_stats</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_if_stereo_secondary_bonded</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">):</span>
                <span class="n">pri_uuid</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_primary_bonded_uuid_from_secondary_bonded_</span><span class="p">(</span><span class="n">chanmapset</span><span class="p">,</span>
                                                                                                     <span class="n">local_uuid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pri_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pri_uuid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_standard_data_collection_to_timeline</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">pri_uuid</span><span class="p">][</span><span class="s2">&quot;szc&quot;</span><span class="p">],</span>
                        <span class="n">add_dict_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;Collecting Stereo Primary:</span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> logs of Stereo Secondary:</span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">pri_uuid</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)},</span>
                        <span class="n">datetime64_index</span><span class="o">=</span><span class="n">datetime64_now</span><span class="p">,</span>
                        <span class="n">include_perf_stats</span><span class="o">=</span><span class="n">include_perf_stats</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">deduce_if_ht_secondary_bonded</span><span class="p">(</span><span class="n">avturi</span><span class="p">,</span> <span class="n">htchanmapset</span><span class="p">,</span> <span class="n">chanmapset</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">):</span>
                <span class="n">pri_uuid</span> <span class="o">=</span> <span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">get_primary_bonded_uuid_from_secondary_bonded_</span><span class="p">(</span><span class="n">htchanmapset</span><span class="p">,</span>
                                                                                                     <span class="n">local_uuid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pri_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pri_uuid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_standard_data_collection_to_timeline</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__current_service_states</span><span class="p">[</span><span class="n">pri_uuid</span><span class="p">][</span><span class="s2">&quot;szc&quot;</span><span class="p">],</span>
                        <span class="n">add_dict_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;Collecting HT Primary:</span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> logs of HT Secondary:</span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">pri_uuid</span><span class="p">,</span> <span class="n">local_uuid</span><span class="p">)},</span>
                        <span class="n">datetime64_index</span><span class="o">=</span><span class="n">datetime64_now</span><span class="p">,</span>
                        <span class="n">include_perf_stats</span><span class="o">=</span><span class="n">include_perf_stats</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">RuntimeWarning</span> <span class="k">as</span> <span class="n">rtw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="n">rtw</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">rte</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_err</span><span class="p">(</span><span class="n">rte</span><span class="p">)</span>

        <span class="c1"># We call the user&#39;s fatal_error_callback first in case usr want to inspect error and</span>
        <span class="c1"># make decisions not to raise signal.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__signal_handling_lock</span><span class="p">:</span>
            <span class="n">skip_signal_thowing</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__usr_fatal_error_callback</span><span class="p">:</span>
                <span class="n">skip_signal_thowing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__usr_fatal_error_callback</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">counters</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_signal_thowing</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raise_enabled</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__raised</span><span class="p">:</span>
                    <span class="n">err_str</span> <span class="o">=</span> <span class="s2">&quot;Raising signal </span><span class="si">{}</span><span class="s2"> to PID </span><span class="si">{}</span><span class="s2">&#39;s main thread.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_err</span><span class="p">(</span><span class="n">err_str</span><span class="p">)</span>
                    <span class="c1"># Do not re-raise this signal.SIGUSR1, otherwise we might kill the process pre-maturely</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__raised</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">)</span>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.log_debug"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.log_debug">[docs]</a>    <span class="k">def</span> <span class="nf">log_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbg_str</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dbg_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dbg_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.log_info"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.log_info">[docs]</a>    <span class="k">def</span> <span class="nf">log_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_str</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.log_warning"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.log_warning">[docs]</a>    <span class="k">def</span> <span class="nf">log_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_str</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.log_err"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.log_err">[docs]</a>    <span class="k">def</span> <span class="nf">log_err</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_str</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">err_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.get_udp_log"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.get_udp_log">[docs]</a>    <span class="k">def</span> <span class="nf">get_udp_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latest_msg</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">lookback_secs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the UDP logs for ZP.  latest_msg is the latest message detected.  If lookback_secs is not None,</span>
<span class="sd">        it will get the last lookback_secs secs from the timestamp in latest_msg.</span>

<span class="sd">        :param latest_msg: The latest log message received from the udp watcher</span>
<span class="sd">        :type latest_msg: :obj: `str`</span>
<span class="sd">         :param zp: sonos zone player for which msg was detected</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        :param lookback_secs: How long back in secs to get the logs from?</span>
<span class="sd">        :type lookback_secs: :obj: `int`</span>
<span class="sd">        :return: Concatenated logs</span>
<span class="sd">        :rtype: :obj: `str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_dict_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_lines_to_dict_list</span><span class="p">((</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_udp_log</span><span class="p">()</span> <span class="o">+</span> <span class="n">latest_msg</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
        <span class="c1"># Get last lookback_secs seconds</span>
        <span class="k">if</span> <span class="n">lookback_secs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_dict_list</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">log_dict_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">lookback_secs</span><span class="p">),</span>
                <span class="n">log_dict_list</span><span class="p">)</span>
        <span class="n">log</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">UDPDiagnosticModuleMonitor</span><span class="o">.</span><span class="n">ANACAPA_STRPTIME_FORMAT</span><span class="p">))</span> <span class="o">+</span>
                          <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]),</span> <span class="n">log_dict_list</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">log</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.reg_fatal_errors_callbacks"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.reg_fatal_errors_callbacks">[docs]</a>    <span class="k">def</span> <span class="nf">reg_fatal_errors_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_sig_hdlr</span><span class="p">,</span> <span class="n">usr_fatal_error_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register fatal error callbacks.</span>

<span class="sd">        :param err_sig_hdlr: Signal handlers for catching signal.SIGUSR1.  Executes in main thread.</span>
<span class="sd">        :type err_sig_hdlr: :func:</span>

<span class="sd">        :param usr_fatal_error_callback: Callback function called prior to the err_sig_hdlr.  Executes in UDP Logger thread.</span>
<span class="sd">        :type usr_fatal_error_callback: :func:</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__signal_handling_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err_sig_hdlr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__prev_usr1_signal_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">err_sig_hdlr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__usr_fatal_error_callback</span> <span class="o">=</span> <span class="n">usr_fatal_error_callback</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.unreg_fatal_errors_callbacks"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.unreg_fatal_errors_callbacks">[docs]</a>    <span class="k">def</span> <span class="nf">unreg_fatal_errors_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unregister fatal error callbacks.</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__signal_handling_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__usr_fatal_error_callback</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__prev_usr1_signal_handler</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__prev_usr1_signal_handler</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_DFL</span><span class="p">)</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.add_timeline_data"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.add_timeline_data">[docs]</a>    <span class="k">def</span> <span class="nf">add_timeline_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">datetime64_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a row of data to the dataframe.</span>

<span class="sd">        :param zp: Sonos zone player the record is for</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param data_dict: Dictionary of data with keys matching to the pandas dataframe</span>
<span class="sd">        :type data_dict: :obj: `dict`</span>

<span class="sd">        :param datetime64_index: numpy.datetime64 to be used for the DatetimeIndex for the new row in the dataframe</span>
<span class="sd">        :type data_dict: :obj: `numpy.datetime64`</span>

<span class="sd">        :return: The timestamp of the record added</span>
<span class="sd">        :rtype: :obj: `numpy.datetime64`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__timeframe_lock</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                              <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">zp</span><span class="o">.</span><span class="n">get_arch</span><span class="p">(),</span>
                              <span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;segment_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_id</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">datetime64_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">datetime64_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_datetime64_now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;Adding row to dataframe at timestamp &lt;</span><span class="si">{}</span><span class="s2">&gt;: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime64_index</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">datetime64_index</span><span class="p">]))</span>
            <span class="c1"># TODO: Measure performance hit</span>
            <span class="c1"># https://github.com/pandas-dev/pandas/issues/5821</span>
            <span class="c1"># Index slicing requires monotonicity (i.e. sortedness)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1">####################################################################</span>
            <span class="c1"># IMPORTANT!</span>
            <span class="c1">####################################################################</span>
            <span class="c1"># There are certain columns that are state variables for ZP.</span>
            <span class="c1"># Theses state variables are processed so that it is forward</span>
            <span class="c1"># propagated, i.e. front-filled.</span>
            <span class="c1"># Front-filling is true if this event is the latest and we want</span>
            <span class="c1"># to propagate certain columns from the past to fill up the</span>
            <span class="c1"># current &#39;NA&quot; column.  However, this is not so if this event is</span>
            <span class="c1"># not the latest (i.e. 2 events so close that this past/older</span>
            <span class="c1"># event is processed by the code later on than by an event that is</span>
            <span class="c1"># present/newer.  In this case, we need to back-fill.</span>
            <span class="c1">####################################################################</span>
            <span class="c1"># Front fill NA columns per zone player for columns where first character is upper.  These are columns</span>
            <span class="c1"># for the state variables.  We front fill from last updated to now to save time (although the indexing of</span>
            <span class="c1">#  it might not).  TODO: Profile the difference in performance.</span>
            <span class="c1"># SWPBL-94306</span>
            <span class="c1"># Need to check if current time is less than last update</span>
            <span class="c1"># time...because if we have multiple threads adding to time</span>
            <span class="c1"># frame, time might not be added in ascending sequence...hence ffill</span>
            <span class="c1"># might not propagate correctly.  The elegant solutuon is to use</span>
            <span class="c1"># &#39;bfill&#39; instead.</span>
            <span class="c1"># Also see note about monotonicity above.</span>
            <span class="k">if</span> <span class="n">datetime64_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__last_update_datetime64_index</span><span class="p">[</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]:</span>
                <span class="c1"># We only want the current row and the row in front of us.</span>
                <span class="n">row_indexer</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="n">datetime64_index</span><span class="p">)</span> <span class="o">&amp;</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;=</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">__last_update_datetime64_index</span><span class="p">[</span>
                                   <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span> <span class="o">&amp;</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()))</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">or</span> <span class="n">x</span> <span class="ow">in</span> \
                                            <span class="p">(</span><span class="s2">&quot;spdif_burst_type&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;spdif_stream_type&quot;</span><span class="p">),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                    <span class="n">col_indexer</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_indexer</span><span class="p">,</span> <span class="n">col_indexer</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="p">[</span><span class="n">row_indexer</span><span class="p">][</span><span class="n">col_indexer</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bfill&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We only want the current row and the row behind us.</span>
                <span class="n">row_indexer</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">__last_update_datetime64_index</span><span class="p">[</span>
                                    <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()])</span> <span class="o">&amp;</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;=</span> <span class="n">datetime64_index</span><span class="p">)</span> <span class="o">&amp;</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()))</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">or</span> <span class="n">x</span> <span class="ow">in</span> \
                                            <span class="p">(</span><span class="s2">&quot;spdif_burst_type&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;spdif_stream_type&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                    <span class="n">col_indexer</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_indexer</span><span class="p">,</span> <span class="n">col_indexer</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">__timeline_df</span><span class="p">[</span><span class="n">row_indexer</span><span class="p">][</span><span class="n">col_indexer</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__last_update_datetime64_index</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span> <span class="o">=</span> <span class="n">datetime64_index</span>

        <span class="k">return</span> <span class="n">datetime64_index</span></div>

    <span class="k">def</span> <span class="nf">__match_detected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">watch_strings_set</span><span class="p">,</span> <span class="n">matched_counters</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matched strings detected.  Update expression counters.</span>
<span class="sd">        Executes in UDP Logger thread.</span>

<span class="sd">        :param msg: UDP log msg</span>
<span class="sd">        :type msg: :obj:`str`</span>

<span class="sd">        :param zp: sonos zone player for which msg was detected</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param key: The key for which the UDP regex string is matched.  This is the module name you passed into the</span>
<span class="sd">                    constructor or the base key.</span>
<span class="sd">        :type key: :obj:`str`</span>

<span class="sd">        :param matched_counters: Counters for occurrences of matched strings for ZP</span>
<span class="sd">        :type matched_counters: :obj:`dict`</span>

<span class="sd">        :param callback: The user-defined callback for the match.  Executes in UDP Logger thread.</span>
<span class="sd">        :type callback: :func:</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We match exactly the module and the level.</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">watch_strings_set</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">exprs</span> <span class="ow">in</span> <span class="n">watch_strings_set</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="p">),</span> <span class="n">exprs</span><span class="p">):</span>
                    <span class="c1"># There is a possibility of chance this will trigger falsely</span>
                    <span class="c1"># if &quot;&lt;{},{}&gt;&quot;.format(key, l) in expr:</span>
                    <span class="c1"># We always match lower module log level.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">msg</span><span class="p">),</span>
                                  <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))):</span>
                        <span class="n">matched_counters</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">expr</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;Match detected for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">matched_counters</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                            <span class="n">callback</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">matched_counters</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_str</span> <span class="o">=</span> <span class="s2">&quot;Key </span><span class="si">{}</span><span class="s2"> not found in watch_strings_set for </span><span class="si">{}</span><span class="s2">, likely to have been unwatched&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">zp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.enable_udp_logging"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.enable_udp_logging">[docs]</a>    <span class="k">def</span> <span class="nf">enable_udp_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable UDP logging for ZP.</span>

<span class="sd">        :param zp: sonos zone player for which UDP logging is to be enabled</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :param reset: Do we restart udp logging for this device</span>
<span class="sd">        :type reset: :bool:</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">wait_for_status_page</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__udp_log_to_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_artifacts_dir</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log_file_path</span> <span class="o">=</span> \
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_artifacts_dir</span><span class="p">(),</span>
                                     <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">anacapa.trace.</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">get_artifacts_prefix</span><span class="p">(),</span>
                                         <span class="n">zp</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                                         <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">zp</span><span class="o">.</span><span class="n">get_arch</span><span class="p">(),</span>
                                         <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">())</span>
                                     <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log_file_path</span> <span class="o">=</span> \
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">anacapa.trace.</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_artifacts_prefix</span><span class="p">(),</span>
                            <span class="n">zp</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                            <span class="n">zp</span><span class="o">.</span><span class="n">modelNumber</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">zp</span><span class="o">.</span><span class="n">get_arch</span><span class="p">(),</span>
                            <span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()</span>
                        <span class="p">)</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log_to_file</span><span class="p">(</span><span class="n">log_file_path</span><span class="p">,</span>
                                              <span class="n">reset</span><span class="p">,</span>
                                              <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a+&quot;</span><span class="p">,</span>
                                              <span class="n">log_to_buffer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log</span><span class="p">(</span><span class="n">reset</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;start_udp_log failed for </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="UDPDiagnosticModuleMonitor.detected_shutdown"><a class="viewcode-back" href="../../../upnp.helpers.html#upnp.helpers.diag.UDPDiagnosticModuleMonitor.detected_shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">detected_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shutdown has been detected by a zp...we need to restart the UDP logger.  Executes in UDP Logger thread.</span>

<span class="sd">        :param zp: sonos zone player for which msg was detected</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Workaround for https://jira.sonos.com/browse/SWPBL-55060, to re-enable UDP logger after restart</span>
        <span class="c1"># TODO: Use louie connect/disconnect so that it can be exected in Coherence&#39;s thread.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_udp_logging</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>  <span class="c1"># waits for device to be online...</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">reset_log_sequence</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">diagc_module</span><span class="p">,</span> <span class="n">levels_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metrics_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">diagc_module</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">levels_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">diagc_module</span><span class="p">,</span> <span class="n">levels_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__watch_string_dict_data</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">diagc_module</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">levels_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">diagc_module</span><span class="p">,</span> <span class="n">levels_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__merged_errors</span><span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_uuid</span><span class="p">()]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">diagc_module</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">levels_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../helpers.html">upnp.helpers</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>