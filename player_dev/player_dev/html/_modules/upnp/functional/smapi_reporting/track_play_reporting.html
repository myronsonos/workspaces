
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>upnp.functional.smapi_reporting.track_play_reporting &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for upnp.functional.smapi_reporting.track_play_reporting</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This test suite covers the trackPlayReporting mechanism players use to report time played events to</span>
<span class="sd">SMAPI partners. This includes the &quot;setPlayedSeconds&quot;, &quot;reportPlaySeconds&quot; and &quot;reportPlayStatus&quot;</span>
<span class="sd">SMAPI calls. These tests were built off of the legacy behavior before SWPBL-36988 work was completed.</span>

<span class="sd">For more information on the expected behaviors for SMAPI track play reporting please see:</span>
<span class="sd">https://confluence.sonos.com/x/4QG_Aw</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>

<span class="kn">import</span> <span class="nn">webserver.helpers.node_smapi_control</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="ne">TimeoutError</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.fixture</span> <span class="k">import</span> <span class="n">WorkflowTestFixture</span><span class="p">,</span> <span class="n">skip</span>
<span class="kn">from</span> <span class="nn">sonos.workflow.suite</span> <span class="k">import</span> <span class="n">WorkflowTestSuite</span>
<span class="kn">from</span> <span class="nn">webserver.base_muse_fixture</span> <span class="k">import</span> <span class="p">(</span><span class="n">BaseMuseFixture</span><span class="p">,</span> <span class="n">MuseClientFixtureMixin</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">common.utils</span> <span class="k">import</span> <span class="n">is_locked_build</span>

<span class="n">smapi_ctl</span> <span class="o">=</span> <span class="n">webserver</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">node_smapi_control</span><span class="o">.</span><span class="n">NodeSmapiControl</span><span class="p">()</span>

<div class="viewcode-block" id="wait_for_all_filtered_logs"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.wait_for_all_filtered_logs">[docs]</a><span class="k">def</span> <span class="nf">wait_for_all_filtered_logs</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="n">filt_kwds</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">expected_items</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param server: smapi server object</span>
<span class="sd">    :param cond: custom test conditional</span>
<span class="sd">    :param dict filt_kwds: dictionary desired log object:values to look for</span>
<span class="sd">    :param int timeout: timeout of this log aggregator</span>
<span class="sd">    :param int expected_items: number of items the log filtering should look for</span>
<span class="sd">    :return tuple: all the log entries and time it took to find them</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_timeout</span> <span class="o">=</span> <span class="n">timeout</span>
    <span class="n">total_time_secs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">all_log_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">total_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cond</span><span class="o">.</span><span class="n">is_expected_log_missing</span><span class="p">():</span>
        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">server</span><span class="p">,</span>
                                                                      <span class="n">calls</span><span class="o">=</span><span class="n">filt_kwds</span><span class="p">[</span><span class="s1">&#39;calls&#39;</span><span class="p">],</span>
                                                                      <span class="n">fn</span><span class="o">=</span><span class="n">filt_kwds</span><span class="p">[</span><span class="s1">&#39;fn&#39;</span><span class="p">],</span>
                                                                      <span class="n">item_id</span><span class="o">=</span><span class="n">filt_kwds</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">],</span>
                                                                      <span class="n">expected_items</span><span class="o">=</span><span class="n">expected_items</span><span class="p">)</span>
        <span class="n">all_log_values</span> <span class="o">=</span> <span class="n">all_log_values</span> <span class="o">+</span> <span class="n">cond</span><span class="o">.</span><span class="n">process_logs</span><span class="p">(</span><span class="n">log_values</span><span class="p">)</span>
        <span class="n">total_timeout</span> <span class="o">=</span> <span class="n">total_timeout</span> <span class="o">-</span> <span class="p">(</span><span class="n">time_taken_secs</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">total_time_secs</span> <span class="o">=</span> <span class="n">total_time_secs</span> <span class="o">+</span> <span class="n">time_taken_secs</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_log_values</span><span class="p">,</span> <span class="n">total_time_secs</span></div>


<div class="viewcode-block" id="queue_setup"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.queue_setup">[docs]</a><span class="k">def</span> <span class="nf">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the player queue based on desired number of tracks</span>
<span class="sd">    :param zp: player object</span>
<span class="sd">    :param num_tracks: number of tracks to add to the queue</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">track_indices</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tracks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Add three tracks to the queue.</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">track_indices</span><span class="p">:</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">enqueueduri</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">SMAPI_SERVER_TRACK_URIS</span><span class="p">[</span><span class="n">track</span><span class="p">],</span>
                        <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">SMAPI_TRACK_METADATA</span><span class="p">[</span><span class="n">track</span><span class="p">],</span>
                        <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">enqueueasnext</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="c1"># Wait for the queue status to be reflected in the zp</span>
    <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="n">starting_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="n">requested_count</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="s2">&quot;NumberReturned&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">track_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></div>

<span class="n">LOG_LEVELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;chsrc&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;cssc&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;avt_impl&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;sonoscp&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;sonosapi&quot;</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_set_up_fixture</span><span class="p">(</span><span class="n">zp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set log levels, clear queue &amp; play state, cleanup bonded configs, mute</span>
<span class="sd">    :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">LOG_LEVELS</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span>
    <span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetMute</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="TrackPlayReportingBase"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingBase">[docs]</a><span class="k">class</span> <span class="nc">TrackPlayReportingBase</span><span class="p">(</span><span class="n">WorkflowTestFixture</span><span class="p">):</span>

<div class="viewcode-block" id="TrackPlayReportingBase.setUpFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingBase.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;TrackPlayReportingBase.setUpFixture&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;pkill node&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="c1"># Make the list of usable spare serviceId numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">254</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="TrackPlayReportingBase.setUpTest"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingBase.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;TrackPlayReportingBase.setUpTest&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>

        <span class="c1"># Get a new serviceId and accountId for each test to prevent</span>
        <span class="c1"># tpm reports from leaking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span><span class="p">]</span>

        <span class="c1"># mock SMAPI server setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">start_node_smapi_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                       <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                       <span class="n">server_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                                                       <span class="n">server_internal_id</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">get_account_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                                                       <span class="n">server_sid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
            <span class="s2">&quot;Successfully added SMAPI account?&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log_to_file</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingBase.tearDownTest"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingBase.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;TrackPlayReportingBase.tearDownTest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_teardown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                              <span class="s2">&quot;Successfully removed SMAPI account?&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">stop_node_smapi_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log_to_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;BEGIN PLAYER LOG OF FAILURE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;END PLAYER LOG OF FAILURE&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Stale /tmp/anacapad.log file not deleted&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackPlayReportingBase.tearDownFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingBase.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;TrackPlayReportingBase.tearDownFixture&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">LOG_LEVELS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_test_partial_track_reported_accurately_when_transitioning</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">transition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player accurately reports the amount of time a track played</span>
<span class="sd">        when transitioning to TV or line-in</span>

<span class="sd">        Expected: Player should only report the amount of time the track played</span>
<span class="sd">        :param transition:</span>
<span class="sd">            lambda: self.test_zp.AVTransport.use_spdif() or</span>
<span class="sd">            lambda: self.test_zp.AVTransport.use_line_in()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">rel_time_greater_than_10</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:10&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span>
            <span class="n">rel_time_greater_than_10</span><span class="p">,</span>
            <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Timeout waiting for RelTime to be greater than 10s&#39;</span><span class="p">,</span>
            <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">transition</span><span class="p">()</span>
        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span>
            <span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
            <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span><span class="o">.</span>
                <span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span>
            <span class="mi">10</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
            <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 10 seconds&quot;</span><span class="o">.</span>
                <span class="nb">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="TrackPlayReportingTests"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests">[docs]</a><span class="k">class</span> <span class="nc">TrackPlayReportingTests</span><span class="p">(</span><span class="n">TrackPlayReportingBase</span><span class="p">):</span>

    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NIGHTLY_SMAPI_REPORTING&quot;</span><span class="p">]</span>

    <span class="n">port</span> <span class="o">=</span> <span class="mi">3000</span>

<div class="viewcode-block" id="TrackPlayReportingTests.setUpFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;TrackPlayReportingTests.setUpFixture&#39;</span><span class="p">)</span>
        <span class="c1"># make sure to choose a device that play music</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">))</span>
        <span class="n">_set_up_fixture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_invoke_transport_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">has_testpoint_support</span><span class="p">())</span> <span class="ow">or</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;Cannot run testpoint tests against builds without testpoint support&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">testpoint</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;chsrc.transport-error&#39;</span><span class="p">,</span> <span class="s1">&#39;trigger&#39;</span><span class="p">,</span>
                                                <span class="nb">type</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">recoverable</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">last_status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># TODO: Turn these tests into combinatorials by playable device once the code is stable</span>
    <span class="c1"># setPlaySeconds tests ----------------------------</span>

<div class="viewcode-block" id="TrackPlayReportingTests.test_report_after_track_finishes_playing"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_report_after_track_finishes_playing">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_after_track_finishes_playing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the SMAPI setPlayedSeconds call is not sent to the server before the track has finished</span>
<span class="sd">        playing (setPlayedSeconds should NOT report based on buffered audio, only on audio listened to).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;getMediaURI&quot;</span><span class="p">,</span> <span class="s2">&quot;setPlayedSeconds&quot;</span><span class="p">],</span>
                                                                      <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">expected_items</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                                   <span class="s2">&quot;setPlayedSeconds and getMediaURI should have been reported once each&quot;</span><span class="p">)</span>

        <span class="n">media_uri_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">set_play_sec_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">log_line</span> <span class="ow">in</span> <span class="n">log_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log_line</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;getMediaURI&quot;</span><span class="p">:</span>
                <span class="n">media_uri_time</span> <span class="o">=</span> <span class="n">log_line</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">log_line</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;setPlayedSeconds&quot;</span><span class="p">:</span>
                <span class="n">set_play_sec_time</span> <span class="o">=</span> <span class="n">log_line</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">media_uri_time</span> <span class="ow">and</span> <span class="n">set_play_sec_time</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterOrFailCase</span><span class="p">(</span><span class="n">set_play_sec_time</span><span class="p">,</span> <span class="n">media_uri_time</span><span class="p">,</span>
                                         <span class="s2">&quot;setPlayedSeconds should be reported after playback has finished&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Test was missing a start or end time&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_full_track_reported_accurately"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_full_track_reported_accurately">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_track_reported_accurately</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player reports the correct time of playback when a track transitions naturally through the</span>
<span class="sd">        Sonos queue.</span>

<span class="sd">        Expected: Player should report the full duration of the track</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> times, expected: 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 30 seconds&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_track_pause_resume_at_end"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_track_pause_resume_at_end">[docs]</a>    <span class="k">def</span> <span class="nf">test_track_pause_resume_at_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Related to SWPBL-51220</span>
<span class="sd">        Pauses and plays the currently playing track after its been cached and player is in queue completion.</span>
<span class="sd">        Makes sure setPlaySeconds report is accurate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:28&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> times, expected: 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 30 seconds&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_track_skip_backwards_on_first_track"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_track_skip_backwards_on_first_track">[docs]</a>    <span class="k">def</span> <span class="nf">test_track_skip_backwards_on_first_track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Related to SWPBL-51553</span>
<span class="sd">        Tries many skip backs on the first track in the queue and makes sure that</span>
<span class="sd">        the final playtime is as expected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:00&quot;</span><span class="p">)</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:00&quot;</span><span class="p">,</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                            <span class="n">iteration_delay</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> times, expected: 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 35 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_report_mutltiple_track_playback"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_report_mutltiple_track_playback">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_mutltiple_track_playback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Verifies that each track gets its own setPlayedSeconds entry</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">85</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">expected_items</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> times, expected: 3 times&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">log_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                       <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 30 seconds&quot;</span>
                                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_partial_track_reported_accurately_when_queue_cleared"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_partial_track_reported_accurately_when_queue_cleared">[docs]</a>    <span class="k">def</span> <span class="nf">test_partial_track_reported_accurately_when_queue_cleared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player accurately reports the amount of time a track played when the entire playback</span>
<span class="sd">        queue is cleared.</span>

<span class="sd">        Expected: Player should only report the amount of time the track played.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:10&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">RemoveAllTracks</span><span class="p">(</span><span class="n">queueid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">updateid</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">starting_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">requested_count</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="s2">&quot;NumberReturned&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 10 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_partial_track_reported_accurately_when_removed_from_queue"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_partial_track_reported_accurately_when_removed_from_queue">[docs]</a>    <span class="k">def</span> <span class="nf">test_partial_track_reported_accurately_when_removed_from_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player accurately reports the amount of time a track played when that track is removed</span>
<span class="sd">        from the playback queue.</span>

<span class="sd">        Expected: Player should only report the amount of time the track played.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:07&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Remove the current playing item from the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">RemoveTrackRange</span><span class="p">(</span><span class="n">queueid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">updateid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">startingindex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberoftracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">starting_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">requested_count</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="s2">&quot;NumberReturned&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">()</span> <span class="ow">and</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:01&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 7 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_partial_track_reported_accurately_when_transitioning_to_line_in"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_partial_track_reported_accurately_when_transitioning_to_line_in">[docs]</a>    <span class="k">def</span> <span class="nf">test_partial_track_reported_accurately_when_transitioning_to_line_in</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player accurately reports the amount of time a track played</span>
<span class="sd">        when transitioning to line-in</span>

<span class="sd">        Expected: Player should only report the amount of time the track played</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line_in_zps</span> <span class="o">=</span> <span class="p">[</span><span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span> <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">has_line_in</span><span class="p">()]</span>
        <span class="n">line_in_zp</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">AudioIn</span><span class="o">.</span><span class="n">LineInConnected</span><span class="p">()),</span> <span class="n">line_in_zps</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_partial_track_reported_accurately_when_transitioning</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_line_in</span><span class="p">(</span><span class="n">line_in_zp</span><span class="p">))</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_scrub_backwards_then_skip_to_new_track"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_scrub_backwards_then_skip_to_new_track">[docs]</a>    <span class="k">def</span> <span class="nf">test_scrub_backwards_then_skip_to_new_track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify when a user scrubs backwards within track A and then skips to a new track in the queue the player</span>
<span class="sd">        reports the correct amount of time played for Track A.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:04&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:02&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:08&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TRACK_NR&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 10 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_scrub_forwards_within_track"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_scrub_forwards_within_track">[docs]</a>    <span class="k">def</span> <span class="nf">test_scrub_forwards_within_track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player accurately reports the amount of time listened when the user scrubs forwards</span>
<span class="sd">        through a track and doesn&#39;t listen to all of it.</span>

<span class="sd">        Expected: Player should report the total amount of time that was actually heard by the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span>
                                      <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:25&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 5 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_skip_backwards_while_playing"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_skip_backwards_while_playing">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_backwards_while_playing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player sends the setPlaySeconds call when the user skips to a different track while playing.</span>
<span class="sd">        The report should contain the play time of the skipped track.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TRACK_NR&quot;</span><span class="p">,</span>
                                      <span class="n">target</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span>
                                      <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:20&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:25&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TRACK_NR&quot;</span><span class="p">,</span>
                                      <span class="n">target</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:01&quot;</span> <span class="ow">and</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="c1"># Make sure the report has the correct time played and trackId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 5 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_skip_forwards_while_playing"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_skip_forwards_while_playing">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_forwards_while_playing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player sends the setPlaySeconds call when the user skips to a different track while playing.</span>
<span class="sd">        The report should contain the play time of the skipped track.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:08&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TRACK_NR&quot;</span><span class="p">,</span>
                                      <span class="n">target</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:04&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="c1"># Make sure the report has the correct time played and trackId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 8 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_skip_forwards_while_paused"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_skip_forwards_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_forwards_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player sends the setPlaySeconds call when the user skips to a new track while paused. The</span>
<span class="sd">        report should contain the play time of the skipped track.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TRACK_NR&quot;</span><span class="p">,</span>
                                      <span class="n">target</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="c1"># Make sure the report has the correct time played and trackId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 5 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_skip_backwards_while_paused"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_skip_backwards_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_skip_backwards_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player sends the setPlaySeconds call when the user skips to a new track while paused. The</span>
<span class="sd">        report should contain the play time of the skipped track.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TRACK_NR&quot;</span><span class="p">,</span>
                                      <span class="n">target</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TRACK_NR&quot;</span><span class="p">,</span>
                                      <span class="n">target</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="c1"># Make sure the report has the correct time played and trackId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 5 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_report_on_reboot"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_report_on_reboot">[docs]</a>    <span class="nd">@skip</span><span class="p">(</span><span class="s2">&quot;Skip until SWPBL-51227 is addressed&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_report_on_reboot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify a player sends the setPlayedSeconds call when anacapa is shutdown cleanly. The report should contain</span>
<span class="sd">        the total play time of the track.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Reboot the player and wait for it to be found again by Coherence before moving on.</span>
        <span class="c1"># This won&quot;t affect the SMAPI logs, but if we don&quot;t wait here downstream tests will fail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">force_subnet_removal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">bounce_anacapa_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="c1"># Make sure the report has the correct time played and trackId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 5 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_change_track_position_in_queue_while_playing"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_change_track_position_in_queue_while_playing">[docs]</a>    <span class="k">def</span> <span class="nf">test_change_track_position_in_queue_while_playing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the track play segments are coalesced correctly when the current playing track has its position</span>
<span class="sd">        in the Sonos queue changed by adding or removing a track before it. This tests any dependence our reporting</span>
<span class="sd">        has on the trackId (Sonos queue position ID) and how our string pool allocation works. Once the string pool</span>
<span class="sd">        hits 50 entries we stop collecting track information until that buffer can be cleared by reporting and the</span>
<span class="sd">        trackId is used in the segment reporting which means a queue position change can cause different segments</span>
<span class="sd">        to take up more entries than a normal play through.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add 50 tracks to the queue</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">49</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">enqueueduri</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">SMAPI_SERVER_TRACK_URIS</span><span class="p">[</span><span class="n">track</span><span class="p">],</span>
                                          <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">SMAPI_TRACK_METADATA</span><span class="p">[</span><span class="n">track</span><span class="p">],</span>
                                          <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                          <span class="n">enqueueasnext</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                  <span class="n">starting_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                  <span class="n">requested_count</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="s2">&quot;NumberReturned&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">),</span>
                                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Set the playhead on the last track which we know is 30 seconds based on the SMAPI server</span>
        <span class="c1"># track map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TRACK_NR&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;50&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Remove the first 49 tracks from the queue while track 50 is playing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">RemoveTrackRange</span><span class="p">(</span><span class="n">queueid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                             <span class="n">updateid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                             <span class="n">startingindex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                             <span class="n">numberoftracks</span><span class="o">=</span><span class="mi">49</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">starting_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">requested_count</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="s2">&quot;NumberReturned&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 30 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_setPlayedSeconds_play_pause_stress_test"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_setPlayedSeconds_play_pause_stress_test">[docs]</a>    <span class="k">def</span> <span class="nf">test_setPlayedSeconds_play_pause_stress_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify a player correctly reports the time when Play/Pause are called in rapid succession over a non-trivial</span>
<span class="sd">        amount of time. This test sends Play/Pause commands spaced at 250ms 50 times (for 15 total call iterations)</span>
<span class="sd">        and expects the player to report roughly 13 seconds of play time (1.250ms * 15)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Main play/pause loop</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play</span><span class="p">()</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause</span><span class="p">()</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 16 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_scrubbing_backwards_within_a_track"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_scrubbing_backwards_within_a_track">[docs]</a>    <span class="k">def</span> <span class="nf">test_scrubbing_backwards_within_a_track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player accurately reports the amount of time listened when the user scrubs backwards</span>
<span class="sd">        to hear part of a track twice.</span>

<span class="sd">        Expected: The player should report the total time heard for the track, even if the amount heard</span>
<span class="sd">        exceeds the duration of the track.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:25&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span>
                                      <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:20&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 35 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_scrub_multiple_times_within_track"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_scrub_multiple_times_within_track">[docs]</a>    <span class="k">def</span> <span class="nf">test_scrub_multiple_times_within_track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that when a user scrubs back and forth through a track multiple times the player reports the correct</span>
<span class="sd">        amount of play time that was heard.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Wait for [5 seconds] of playback (played from 0 to 5)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># seek back to 2, play for [7 seconds] (played from 2 to 9)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:02&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:09&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># seek ahead to 25, play for [5 seconds] (played from 25 to 30)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:25&quot;</span><span class="p">)</span>

        <span class="c1"># the expected total is 17 seconds</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="c1"># Expect 17, but center the expectation around 16 because the player truncates floating point time</span>
        <span class="c1"># when generating these reports. Centering the expectation around 16 accounts for the bias introduced by</span>
        <span class="c1"># the truncation.</span>
        <span class="c1"># The delta is still 1, but we might want to increase that something bigger.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported </span><span class="si">{}</span><span class="s2"> after </span><span class="si">{}</span><span class="s2"> seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span><span class="p">),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_setPlayedSeconds_report_after_playback_error"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_setPlayedSeconds_report_after_playback_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_setPlayedSeconds_report_after_playback_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-51262</span>
<span class="sd">        Only works on non-release builds</span>
<span class="sd">        Verify a player sends the setPlayedSeconds report after the current playing item stops playing due to a</span>
<span class="sd">        transport error. The setPlayedSeconds report should contain the correct number of seconds played before the</span>
<span class="sd">        error was encountered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_transport_error</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Failed to invoke transport error&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 5 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

    <span class="c1"># reportPlayStatus tests --------------------</span>

<div class="viewcode-block" id="TrackPlayReportingTests.test_report_play_status_while_playing"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_report_play_status_while_playing">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_play_status_while_playing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the player sends a &quot;reportPlayStatus&quot; call to the SMAPI server each time a track</span>
<span class="sd">        is skipped while playing. Also verify that the correct reason is reported in the skip event.</span>

<span class="sd">        As documented the only time this call is made is on a track skip or pause operation:</span>
<span class="sd">        http://musicpartners.sonos.com/node/389</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:04&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span> <span class="ow">and</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:04&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span> <span class="ow">and</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:04&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Get the filtered log. Filter out paused events.</span>
        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlayStatus&quot;</span><span class="p">],</span>
                                                                      <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;paused&quot;</span><span class="p">,</span>
                                                                      <span class="n">expected_items</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;Player should have reported two skip events (waited </span><span class="si">{}</span><span class="s2"> seconds)&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_taken_secs</span><span class="p">))</span>

        <span class="c1"># Checked the filtered results for accuracy</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">log_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">],</span>
                <span class="s2">&quot;skippedTrack&quot;</span><span class="p">,</span> <span class="s2">&quot;Player should report reason as a track skip&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s2">&quot;The player reported skippedTrack for item </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_report_play_status_while_stopped"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_report_play_status_while_stopped">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_play_status_while_stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the player sends a &quot;reportPlayStatus&quot; call to the SMAPI server each time a track is skipped</span>
<span class="sd">        while stopped. Also verify that the correct reason is reported in the skip event.</span>

<span class="sd">        As documented the only time this call is made is on pause and track skip operations:</span>
<span class="sd">        http://musicpartners.sonos.com/node/389</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">num_tracks</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">track_indices</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tracks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">skipped_tracks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Skip to the last track</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">track_indices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># Skip to next track</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span>
            <span class="c1"># Wait until the current track becomes the next track</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">get_current_track</span><span class="p">()</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Verify we are in the stopped state before skipping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                                  <span class="s2">&quot;ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; is in the </span><span class="si">{}</span><span class="s2"> state?&quot;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">STOPPED_STATE</span><span class="p">))</span>
            <span class="c1"># Add the skipped track to the list of skipped tracks</span>
            <span class="n">skipped_tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
            <span class="c1"># Add a small delay to avoid reporting timing issues</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Get the filtered log. Filter out paused events.</span>
        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlayStatus&quot;</span><span class="p">],</span>
                                                                      <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;paused&quot;</span><span class="p">,</span>
                                                                      <span class="n">expected_items</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped_tracks</span><span class="p">))</span>

        <span class="c1"># Verify that the number of skip events is correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped_tracks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;Player should have reported </span><span class="si">{}</span><span class="s2"> skip events (waited </span><span class="si">{}</span><span class="s2"> seconds)&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped_tracks</span><span class="p">),</span> <span class="n">time_taken_secs</span><span class="p">))</span>

        <span class="c1"># Checked the filtered results for accuracy</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">log_values</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">log_values</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">],</span> <span class="s2">&quot;skippedTrack&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;Player should report reason as a track skip&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">skipped_tracks</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                                       <span class="s2">&quot;The player reported skippedTrack for item </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_report_play_status_while_paused"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_report_play_status_while_paused">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_play_status_while_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the player sends a &quot;reportPlayStatus&quot; call to the SMAPI server each time a track is skipped</span>
<span class="sd">        while paused. Also verify that the correct reason is reported in the skip event.</span>

<span class="sd">        As documented the only time this call is made is on pause and track skip operations:</span>
<span class="sd">        http://musicpartners.sonos.com/node/389</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Specify the number of tracks to use.</span>
        <span class="n">num_tracks</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">track_indices</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tracks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Start playing and then pause to transition to paused state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:03&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">skipped_tracks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Skip to the last track</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">track_indices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># Skip to next track</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span>
            <span class="c1"># Wait until the current track becomes the next track</span>
            <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">get_current_track</span><span class="p">()</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># Verify we are in the paused state before skipping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_paused</span><span class="p">(),</span> <span class="s2">&quot;ZP &lt;</span><span class="si">{}</span><span class="s2">&gt; is in the </span><span class="si">{}</span><span class="s2"> state?&quot;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">PAUSED_STATE</span><span class="p">))</span>
            <span class="c1"># Add the skipped track to the list of skipped tracks</span>
            <span class="n">skipped_tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
            <span class="c1"># Add a small delay to avoid reporting timing issues</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Get the filtered log. Filter out paused events.</span>
        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlayStatus&quot;</span><span class="p">],</span>
                                                                      <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;paused&quot;</span><span class="p">,</span>
                                                                      <span class="n">expected_items</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped_tracks</span><span class="p">))</span>

        <span class="c1"># Verify that the number of skip events is correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">skipped_tracks</span><span class="p">),</span>
                               <span class="s2">&quot;Player should have reported </span><span class="si">{}</span><span class="s2"> skip events (waited </span><span class="si">{}</span><span class="s2"> seconds)&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped_tracks</span><span class="p">),</span> <span class="n">time_taken_secs</span><span class="p">))</span>

        <span class="c1"># Checked the filtered results for accuracy</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">log_values</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">log_values</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">],</span> <span class="s2">&quot;skippedTrack&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;Player should report reason as a track skip&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">skipped_tracks</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                                       <span class="s2">&quot;The player reported skippedTrack for item </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_report_play_status_on_pause"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_report_play_status_on_pause">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_play_status_on_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the player sends a &quot;reportPlayStatus&quot; call to the SMAPI server each</span>
<span class="sd">        time a track is paused.</span>

<span class="sd">        As documented the only time this call is made is on pause and track skip operations:</span>
<span class="sd">        http://musicpartners.sonos.com/node/389</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Start playing and wait for 3 seconds of playback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:03&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># While the track is playing and there is still enough time left.</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">zp</span><span class="p">:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="s2">&quot;0:00:27&quot;</span> <span class="ow">and</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">())(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">):</span>
            <span class="c1"># Clear smapi logs</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">clear_smapi_server_logs</span><span class="p">()</span>
            <span class="c1"># Pause and wait for state transition</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

            <span class="c1"># Get the filtered log, verify we saw a pause event.</span>
            <span class="n">log</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                   <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlayStatus&quot;</span><span class="p">],</span>
                                                                   <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;paused&quot;</span><span class="p">,</span>
                                                                   <span class="n">expected_items</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Verify that the number of pause events is correct</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="s2">&quot;Player should have reported </span><span class="si">{}</span><span class="s2"> pause events (waited </span><span class="si">{}</span><span class="s2"> seconds)&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_taken_secs</span><span class="p">))</span>

            <span class="c1"># Start playing again.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Sleep for a random interval of 4-10 seconds</span>
            <span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span></div>

    <span class="c1"># reportPlaySeconds tests ----------------------------</span>

<div class="viewcode-block" id="TrackPlayReportingTests.test_report_play_seconds_normal_operation"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_report_play_seconds_normal_operation">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_play_seconds_normal_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that in normal playback operation the player sends the reportPlaySeconds call in at</span>
<span class="sd">        expected frequencies (at track start, 60 seconds from start and then each 60s thereafter).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;zonereportmgr&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:06&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

        <span class="c1"># Pause here so we don&quot;t continue to create new reportPlaySecond reports as track 2 continues</span>
        <span class="c1"># to play</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">log_values_item_1</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                             <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlaySeconds&quot;</span><span class="p">],</span>
                                                                             <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values_item_1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time for item 1&quot;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values_item_1</span><span class="p">)))</span>
        <span class="c1"># Iterate through the list of logs and make sure that we&#39;re only seeing the expected reports</span>
        <span class="c1"># for the expected ids. We played all of track 1 and started track 2 so we expect an initial</span>
        <span class="c1"># report on track 1 and the initial report on track 2</span>
        <span class="c1"># TODO 15 second reporting is not implemented yet. We are going to ask iHeartRadio to customize</span>
        <span class="c1"># their implementation by return &quot;15&quot; to the player via the normal mechanism.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">log_values_item_1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2">, expected: 1 for id&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values_item_1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">log_values_item_1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> second, expected: 1 second for item 1&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values_item_1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]))</span>

        <span class="n">log_values_item_2</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlaySeconds&quot;</span><span class="p">],</span>
                                                                <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;zonereportmgr&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values_item_2</span><span class="p">),</span>
                                      <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected at least 1 time for item 2&quot;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values_item_2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">log_values_item_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2">, expected: 2 for id&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values_item_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">log_values_item_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> second, expected: 1 second for item 2&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values_item_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_report_play_seconds_zero_second_track_play"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_report_play_seconds_zero_second_track_play">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_play_seconds_zero_second_track_play</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that in normal playback operation the player does not send a reportPlaySeconds report</span>
<span class="sd">        if the playback of a track is less then 1 second</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;zonereportmgr&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TRACK_NR&quot;</span><span class="p">,</span>
                                      <span class="n">target</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:03&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Pause here so we don&quot;t continue to create new reportPlaySecond reports</span>
        <span class="c1"># as track 2 continues to play</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">log_values_item</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                           <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlaySeconds&quot;</span><span class="p">],</span>
                                                                           <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                                                                           <span class="n">expected_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;zonereportmgr&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values_item</span><span class="p">),</span>
                               <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> times, expected 0 times for item 1&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values_item</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.time_str_to_seconds"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.time_str_to_seconds">[docs]</a>    <span class="k">def</span> <span class="nf">time_str_to_seconds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_str</span><span class="p">):</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="n">time_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="mi">3600</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">segments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">60</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">segments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">segments</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">seconds</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_verify_sendPlayedSeconds_after_play_pause_clear_queue"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_verify_sendPlayedSeconds_after_play_pause_clear_queue">[docs]</a>    <span class="k">def</span> <span class="nf">test_verify_sendPlayedSeconds_after_play_pause_clear_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the fix 55115 (where we do not want any &#39;in progress play time&#39;</span>
<span class="sd">        after pausing and clearing the queue). This can also be verified by analyzing anacapa logs.</span>
<span class="sd">        This test checks that one sendPlayedSeconds report is received after playing, pausing,</span>
<span class="sd">        and then clearing the queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;zonereportmgr&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Play</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
        <span class="c1"># Play for at least ten seconds</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_str_to_seconds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s1">&#39;RelTime&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1"># Pause</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">);</span>

        <span class="c1"># Clear the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">);</span>

        <span class="c1"># Check that one setPlayedSeconds report has been sent</span>
        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;zonereportmgr&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> times, expected: 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_report_play_seconds_server_override_frequency_to_zero"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_report_play_seconds_server_override_frequency_to_zero">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_play_seconds_server_override_frequency_to_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify when a SMAPI server responds to the first reportPlaySeconds call with a new interval of 0 the player</span>
<span class="sd">        never sends another reportPlaySeconds call for that track. Effectively this means only one report will be</span>
<span class="sd">        sent for the track (the start track report).</span>

<span class="sd">        This was an implementation detail for the Mudhoney project with Apple music on SMAPI. See SWPBL-45109</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;zonereportmgr&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">set_report_play_seconds_override</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:29&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">55</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># We should see two initial reports. One for track 1 and one for track 2</span>
        <span class="n">log_values_item_1</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                             <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlaySeconds&quot;</span><span class="p">],</span>
                                                                             <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values_item_1</span><span class="p">),</span>
                                   <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time for item 1&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values_item_1</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">log_values_item_1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                                       <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2">, expected: 1 for id&quot;</span>
                                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyLessEqualOrFailCase</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span>
                                           <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, &quot;</span>
                                           <span class="s2">&quot;expected: no more then 10 seconds for item 1&quot;</span>
                                           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]))</span>

        <span class="n">log_values_item_2</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                             <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlaySeconds&quot;</span><span class="p">],</span>
                                                                             <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;zonereportmgr&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values_item_2</span><span class="p">),</span>
                                   <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time for item 2&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values_item_2</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">log_values_item_2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                                       <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2">, expected: 2 for id&quot;</span>
                                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyLessEqualOrFailCase</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span>
                                           <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, &quot;</span>
                                           <span class="s2">&quot;expected: no more then 10 seconds for item 2&quot;</span>
                                           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_report_play_seconds_server_override_frequency"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_report_play_seconds_server_override_frequency">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_play_seconds_server_override_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify when a SMAPI server responds to the first reportPlaySeconds call with a new interval the player</span>
<span class="sd">        should send the reportPlaySeconds call on that new interval after the initial report.</span>

<span class="sd">        NOTE: the requested iteration begins after the initial report. So an iteration change to 10 seconds</span>
<span class="sd">        would result in reports at 0, 10, 20, 30... seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;zonereportmgr&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">set_report_play_seconds_override</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:06&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">CustomTestCond</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">upper_value</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_id</span> <span class="o">=</span> <span class="n">item_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">upper_value</span> <span class="o">=</span> <span class="n">upper_value</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expected_reports</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">is_expected_log_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Keep waiting until the final report (at 30 seconds) is received.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">has_initial_report</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_id</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_reports</span>
                <span class="n">has_final_report</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_reports</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_value</span><span class="p">:</span>
                        <span class="n">has_final_report</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

                <span class="k">return</span> <span class="ow">not</span> <span class="n">has_initial_report</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_final_report</span>

            <span class="k">def</span> <span class="nf">process_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_values</span><span class="p">):</span>
                <span class="n">new_log_values</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">log</span><span class="p">:</span> <span class="n">log</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_id</span> <span class="ow">and</span>
                                        <span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;seconds&#39;</span><span class="p">],</span> <span class="n">log</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_reports</span><span class="p">,</span>
                                        <span class="n">log_values</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expected_reports</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;seconds&#39;</span><span class="p">],</span>
                                              <span class="n">log</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">new_log_values</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">new_log_values</span>

        <span class="n">log_values_item_1</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">wait_for_all_filtered_logs</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                        <span class="n">cond</span><span class="o">=</span><span class="n">CustomTestCond</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
                                                                        <span class="n">filt_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;item_id&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
                                                                                   <span class="s1">&#39;fn&#39;</span><span class="p">:</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                                                   <span class="s1">&#39;calls&#39;</span><span class="p">:[</span><span class="s1">&#39;reportPlaySeconds&#39;</span><span class="p">]},</span>
                                                                        <span class="n">expected_items</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># The player makes a best effort to report periodically. At a minimum, it will report the track</span>
        <span class="c1"># start and end. It may drop the reports at 10 and 20 seconds.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyInRangeOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values_item_1</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
                                     <span class="s2">&quot;reportPlaySeconds reported </span><span class="si">{}</span><span class="s2"> times after </span><span class="si">{}</span><span class="s2"> seconds, &quot;</span>
                                     <span class="s2">&quot;expected between 2 and 4 times for item 1: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values_item_1</span><span class="p">),</span>
                                                                                            <span class="n">time_taken_secs</span><span class="p">,</span>
                                                                                            <span class="n">log_values_item_1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">log_values_item_1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2">, expected: 1 for id&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values_item_1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">log_values_item_1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 1 second&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values_item_1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">log_values_item_1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                                       <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2">, expected: 1 for id&quot;</span>
                                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterOrFailCase</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: at least 0 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyLessEqualOrFailCase</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span> <span class="mi">30</span><span class="p">,</span>
                                         <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, &quot;</span>
                                         <span class="s2">&quot;expected: no more then 30 seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]))</span>

        <span class="n">log_values_item_2</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">wait_for_all_filtered_logs</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                        <span class="n">cond</span><span class="o">=</span><span class="n">CustomTestCond</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                                        <span class="n">filt_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;item_id&#39;</span><span class="p">:</span><span class="s1">&#39;2&#39;</span><span class="p">,</span>
                                                                                   <span class="s1">&#39;fn&#39;</span><span class="p">:</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                                                   <span class="s1">&#39;calls&#39;</span><span class="p">:[</span><span class="s1">&#39;reportPlaySeconds&#39;</span><span class="p">]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;zonereportmgr&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values_item_2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="s2">&quot;reportPlaySeconds reported </span><span class="si">{}</span><span class="s2"> time after </span><span class="si">{}</span><span class="s2"> seconds, &quot;</span>
                                      <span class="s2">&quot;expected 1 time for item 2: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values_item_2</span><span class="p">),</span>
                                                                              <span class="n">time_taken_secs</span><span class="p">,</span>
                                                                              <span class="n">log_values_item_2</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">log_values_item_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2">, expected: 2 for id&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values_item_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">log_values_item_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 1 seconds&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values_item_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="TrackPlayReportingTests.test_report_play_seconds_no_offset_after_LSE"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTests.test_report_play_seconds_no_offset_after_LSE">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_play_seconds_no_offset_after_LSE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the player does not report the offsetMillis after a LSE</span>
<span class="sd">        occurs when the SMAPI server supports &quot;canResume&quot;.</span>

<span class="sd">        This test requires testpoint support.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked_build</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;locked builds do not support `chnsk.se` testpoint for LSE errors&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;zonereportmgr&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Report more frequently</span>
        <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">set_report_play_seconds_override</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Use the first track to test, record track statistics</span>
        <span class="n">test_track</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Replace the metadata for the track and add &#39;canResume&#39; == true</span>
        <span class="c1"># so that the track will report offsetMillis</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">get_track</span><span class="p">(</span><span class="n">test_track</span><span class="p">)</span>
        <span class="c1"># If the existing metadata has no trackMetadata field, add one</span>
        <span class="k">if</span> <span class="s1">&#39;trackMetadata&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">md</span><span class="p">[</span><span class="s1">&#39;trackMetadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Set canResume == true for the track</span>
        <span class="n">md</span><span class="p">[</span><span class="s1">&#39;trackMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;canResume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
        <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">set_track</span><span class="p">(</span><span class="n">test_track</span><span class="p">,</span> <span class="n">md</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="s2">&quot;canResume&quot;</span><span class="p">,</span>
                                <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">get_track</span><span class="p">(</span><span class="n">test_track</span><span class="p">)[</span><span class="s2">&quot;trackMetadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                <span class="s2">&quot;canResume field should exist in the track&#39;s MD&quot;</span><span class="p">)</span>

        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Play and wait for the ZP to indicate it is playing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Wait until there&#39;s 2 &#39;reportPlayseconds&#39; reports</span>
        <span class="n">log_values</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                        <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlaySeconds&quot;</span><span class="p">],</span>
                                                        <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                                                        <span class="n">expected_items</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                        <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="c1"># Verify that 2 got 2 reports and they both have the &#39;offsetMillis&#39; parameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
                                          <span class="s2">&quot;Got minimum number of required TPM reports (needed 2, got </span><span class="si">{}</span><span class="s2">)?&quot;</span>
                                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">log_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="s2">&quot;offsetMillis&quot;</span><span class="p">,</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                    <span class="s2">&quot;Offset reported before LSE for report </span><span class="si">{}</span><span class="s2">?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report</span><span class="p">))</span>

        <span class="c1"># Clear the previous reports</span>
        <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">clear_smapi_server_logs</span><span class="p">()</span>

        <span class="c1"># Trigger a large sync error.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">testpoint_trigger_lse</span><span class="p">()</span>

        <span class="c1"># Find all reportPlaySeconds events</span>
        <span class="n">log_values2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                        <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlaySeconds&quot;</span><span class="p">],</span>
                                                        <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="c1"># Make sure we got at least 1 more report post LSE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrFailCase</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="s2">&quot;Got minimum number of required TPM reports (needed 1, got </span><span class="si">{}</span><span class="s2">)?&quot;</span>
                                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values2</span><span class="p">)))</span>
        <span class="c1"># Verify that &#39;offsetMillis&#39; is not in the last report</span>
        <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">log_values2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotInOrFailCase</span><span class="p">(</span><span class="s2">&quot;offsetMillis&quot;</span><span class="p">,</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                       <span class="s2">&quot;Offset not reported after LSE for report </span><span class="si">{}</span><span class="s2">?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;zonereportmgr&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TrackPlayReportingContextIdTests"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingContextIdTests">[docs]</a><span class="k">class</span> <span class="nc">TrackPlayReportingContextIdTests</span><span class="p">(</span><span class="n">WorkflowTestFixture</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    These tests set up the node-smapi server on the household with the added capability to report the contextId</span>
<span class="sd">    along with the reportPlaySeconds and setPlayedSeconds calls. This feature was added in Mudhoney and is tested</span>
<span class="sd">    in a different class as it is only in use by Apple music at the time these tests were written (Sprint 3 2016).</span>

<span class="sd">    The contextId returned is the parent container the tracks came from and is added to the report based on an entire</span>
<span class="sd">    container being added to the queue or played from the browse node. As such the method of adding tracks to the queue</span>
<span class="sd">    is the same but requires a different set of MD to be passed in. These tests are not exhaustive, but test the main</span>
<span class="sd">    happy path that when a container is enqueued we report the contextId and that when a track is played normally the</span>
<span class="sd">    player only reports the track itemId as the contextId.</span>

<span class="sd">    See Yves comment on this page for more information (this feature is not yet documented anywhere officially):</span>
<span class="sd">    https://confluence.sonos.com/display/PDSW/SMAPI+Track+Reporting+Changes?focusedCommentId=73406001#comment-73406001</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Override the SMAPI capabilities flags from the node_smapi_control script</span>
    <span class="n">SMAPI_SERVER_CAPS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;logging&#39;</span><span class="p">,</span> <span class="s1">&#39;playbackLogging&#39;</span><span class="p">,</span> <span class="s1">&#39;extendedMD&#39;</span><span class="p">,</span> <span class="s1">&#39;contextReporting&#39;</span><span class="p">]</span>

    <span class="n">CONTEXT_ID</span> <span class="o">=</span> <span class="s2">&quot;browse:tracks&quot;</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NIGHTLY_SMAPI_REPORTING&quot;</span><span class="p">]</span>

    <span class="n">port</span> <span class="o">=</span> <span class="mi">3001</span>

<div class="viewcode-block" id="TrackPlayReportingContextIdTests.setUpFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingContextIdTests.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;pkill node&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingContextIdTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="c1"># make sure to choose a device that play music</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;chsrc&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;cssc&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonoscp&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonosapi&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetMute</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Make the list of usable spare serviceId numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">254</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="TrackPlayReportingContextIdTests.setUpTest"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingContextIdTests.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingContextIdTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="c1"># Get a new serviceId and accountId for each test to prevent</span>
        <span class="c1"># tpm reports from leaking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span><span class="p">]</span>
        <span class="c1"># mock SMAPI server setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">start_node_smapi_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                       <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                       <span class="n">server_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                                                       <span class="n">server_internal_id</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">get_account_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                                                       <span class="n">server_sid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">caps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SMAPI_SERVER_CAPS</span><span class="p">),</span>
            <span class="s2">&quot;Successfully added SMAPI account?&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">)</span>
        <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">clear_smapi_server_logs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log_to_file</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingContextIdTests.tearDownTest"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingContextIdTests.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_teardown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                              <span class="s2">&quot;Successfully removed SMAPI account?&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">stop_node_smapi_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log_to_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;BEGIN PLAYER LOG OF FAILURE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;END PLAYER LOG OF FAILURE&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Stale /tmp/anacapad.log file not deleted&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingContextIdTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackPlayReportingContextIdTests.tearDownFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingContextIdTests.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;chsrc&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;cssc&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonoscp&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonosapi&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingContextIdTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackPlayReportingContextIdTests.test_set_played_seconds_context_id"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingContextIdTests.test_set_played_seconds_context_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_played_seconds_context_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player reports the contextId in the setPlayedSeconds call when a container was the original</span>
<span class="sd">        source of a played track</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Enqueue as a container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">enqueueduri</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">SMAPI_CONTAINER_URI</span><span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">],</span>
                                  <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">SMAPI_CONTAINER_MD</span><span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">],</span>
                                  <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                                  <span class="n">enqueueasnext</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">starting_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">requested_count</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="s2">&quot;NumberReturned&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:25&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;contextId&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTEXT_ID</span><span class="p">,</span>
                                                                      <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time for context_id&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONTEXT_ID</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;contextId&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2">, expected: </span><span class="si">{}</span><span class="s2"> for context_id&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;contextId&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTEXT_ID</span><span class="p">))</span></div>

<div class="viewcode-block" id="TrackPlayReportingContextIdTests.test_set_played_seconds_no_context_id"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingContextIdTests.test_set_played_seconds_no_context_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_played_seconds_no_context_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player reports the itemId as the contextId when a track was played as a single track and not</span>
<span class="sd">        as part of a collection or container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Enqueue as a single track</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:25&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;contextId&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                                                                      <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time for context_id&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;contextId&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2">, expected: 1 for context_id&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;contextId&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="TrackPlayReportingContextIdTests.test_report_play_seconds_context_id"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingContextIdTests.test_report_play_seconds_context_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_play_seconds_context_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player reports the contextId in the reportPlaySeconds when a container was the original source</span>
<span class="sd">        of a played track</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Enqueue as a container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">enqueueduri</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">SMAPI_CONTAINER_URI</span><span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">],</span>
                                  <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">SMAPI_CONTAINER_MD</span><span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">],</span>
                                  <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                                  <span class="n">enqueueasnext</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">starting_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">requested_count</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="s2">&quot;NumberReturned&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:25&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlaySeconds&quot;</span><span class="p">],</span>
                                                                      <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;contextId&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTEXT_ID</span><span class="p">,</span>
                                                                      <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, &quot;</span>
                                      <span class="s2">&quot;expected at least 1 time for context_id&quot;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONTEXT_ID</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;contextId&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2">, expected: </span><span class="si">{}</span><span class="s2"> for context_id&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;contextId&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTEXT_ID</span><span class="p">))</span></div>

<div class="viewcode-block" id="TrackPlayReportingContextIdTests.test_report_play_seconds_no_context_id"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingContextIdTests.test_report_play_seconds_no_context_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_play_seconds_no_context_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player reports the itemId as the contextId when a track was played as a single track and not as</span>
<span class="sd">        part of a collection or container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Enqueue as a single track</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:25&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlaySeconds&quot;</span><span class="p">],</span>
                                                                      <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                                                      <span class="n">l</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;contextId&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                                                                      <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, &quot;</span>
                                      <span class="s2">&quot;expected at least 1 time for context_id&quot;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;contextId&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2">, expected: 1 for context_id&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;contextId&quot;</span><span class="p">]))</span></div></div>


<div class="viewcode-block" id="TrackPlayReportingDelegationTests"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingDelegationTests">[docs]</a><span class="k">class</span> <span class="nc">TrackPlayReportingDelegationTests</span><span class="p">(</span><span class="n">WorkflowTestFixture</span><span class="p">):</span>

    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NIGHTLY_SMAPI_REPORTING&quot;</span><span class="p">]</span>

    <span class="n">port</span> <span class="o">=</span> <span class="mi">3002</span>

    <span class="k">def</span> <span class="nf">_get_queue_track_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracks</span><span class="p">):</span>
        <span class="n">track_durs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tracks</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">track_durs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">get_track</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="s2">&quot;trackMetadata&quot;</span><span class="p">][</span><span class="s2">&quot;duration&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">track_durs</span>

    <span class="k">def</span> <span class="nf">_get_final_playback_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                <span class="n">item_id</span><span class="o">=</span><span class="n">track</span><span class="p">,</span>
                                                                <span class="n">expected_items</span><span class="o">=</span><span class="n">expected</span><span class="p">)</span>
        <span class="n">total_playback_secs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">lv</span> <span class="ow">in</span> <span class="n">log_values</span><span class="p">:</span>
                <span class="n">total_playback_secs</span> <span class="o">=</span> <span class="n">total_playback_secs</span> <span class="o">+</span> <span class="n">lv</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">total_playback_secs</span>

<div class="viewcode-block" id="TrackPlayReportingDelegationTests.setUpFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingDelegationTests.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;pkill node&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingDelegationTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="c1"># self.helpers = upnp.helpers.Help ers(logger=self.logger)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;need at least 1 zone to run this test&quot;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">]</span>
        <span class="n">test_zones</span> <span class="o">=</span> <span class="p">[</span> <span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span> <span class="k">if</span> \
                                <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_bridge</span><span class="p">()</span> <span class="ow">and</span> \
                                <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_dock</span><span class="p">()</span> <span class="ow">and</span> \
                                <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_sub</span><span class="p">()</span> <span class="ow">and</span> \
                                <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_model</span><span class="p">(</span><span class="s1">&#39;S9&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linkable_zones</span> <span class="o">=</span> <span class="n">test_zones</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linkable_zones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;this test requires more than 1 linkable zone&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testbed</span> <span class="o">=</span> <span class="p">[</span> <span class="n">zp</span> <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkable_zones</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testbed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testbed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testbed</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;chsrc&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;cssc&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetMute</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Make the list of usable spare serviceId numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">254</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">2</span></div>

<div class="viewcode-block" id="TrackPlayReportingDelegationTests.setUpTest"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingDelegationTests.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingDelegationTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="c1"># Get a new serviceId and accountId for each test to prevent</span>
        <span class="c1"># tpm reports from leaking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span><span class="p">]</span>
        <span class="c1"># mock SMAPI server setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">start_node_smapi_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                       <span class="n">server_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                                                       <span class="n">server_internal_id</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">get_account_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                                                       <span class="n">server_sid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span>
                                                       <span class="n">extra_path</span><span class="o">=</span><span class="s1">&#39;/normal_length&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
            <span class="s2">&quot;Successfully added SMAPI account?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">)</span>
        <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">clear_smapi_server_logs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">start_node_smapi_server</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testbed</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log_to_file</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="TrackPlayReportingDelegationTests.tearDownTest"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingDelegationTests.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_teardown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                              <span class="s2">&quot;Successfully removed SMAPI account?&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">stop_node_smapi_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testbed</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log_to_file</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">):</span>
                <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;BEGIN PLAYER </span><span class="si">{}</span><span class="s1"> LOG OF FAILURE&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;END PLAYER </span><span class="si">{}</span><span class="s1"> LOG OF FAILURE&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>
                <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Stale /tmp/anacapad.log file not deleted&quot;</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingDelegationTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackPlayReportingDelegationTests.tearDownFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingDelegationTests.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testbed</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;chsrc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;cssc&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingDelegationTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackPlayReportingDelegationTests.test_report_after_delegation_multiple_tracks"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingDelegationTests.test_report_after_delegation_multiple_tracks">[docs]</a>    <span class="nd">@skip</span><span class="p">(</span><span class="s2">&quot;Waiting on SWPBL-57473&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_report_after_delegation_multiple_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">track_durs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_queue_track_duration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">)</span>
        <span class="n">total_dur</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">dur</span> <span class="ow">in</span> <span class="n">track_durs</span><span class="p">:</span>
            <span class="n">total_dur</span> <span class="o">=</span> <span class="n">total_dur</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">dur</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">num_linked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">ZoneGroupTopology</span><span class="o">.</span><span class="n">get_num_linked_zones</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">num_linked</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                   <span class="s2">&quot;found </span><span class="si">{}</span><span class="s2"> zones linked to group coordinator </span><span class="si">{}</span><span class="s2">&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_linked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">track_durs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">track_durs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">leave_group</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">total_dur</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
                       <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># No guarantee that the new GC will send a report for track 1 so we just</span>
        <span class="c1"># want to make sure that we recieved at least one report from the original GC</span>
        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyGreaterEqualOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected at least 1 time for track 1&quot;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>

        <span class="c1"># Make sure track 2 has the correct time played</span>
        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                      <span class="n">item_id</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">track_durs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: </span><span class="si">{}</span><span class="s2"> seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span> <span class="n">track_durs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                         <span class="n">delta</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingDelegationTests.test_report_seamless_delegation_to_new_gc_first_5_secs"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingDelegationTests.test_report_seamless_delegation_to_new_gc_first_5_secs">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_seamless_delegation_to_new_gc_first_5_secs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Groups 2 players together and starts playback. Change playback to a new GC after 10 seconds and</span>
<span class="sd">        checkes to make sure both the old and new GC send out a setPlayedSeconds report to the smapi server.</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">tracks</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="n">tracks</span><span class="p">)</span>
        <span class="n">track_durs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_queue_track_duration</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">num_linked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">ZoneGroupTopology</span><span class="o">.</span><span class="n">get_num_linked_zones</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">num_linked</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                   <span class="s2">&quot;found </span><span class="si">{}</span><span class="s2"> zones linked to group coordinator </span><span class="si">{}</span><span class="s2">&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_linked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">leave_group</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="n">track_durs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Make sure the report has the correct time played and trackId</span>
        <span class="n">total_playback_secs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_final_playback_time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">track_durs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="n">total_playback_secs</span><span class="p">,</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: </span><span class="si">{}</span><span class="s2"> - 10 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_playback_secs</span><span class="p">,</span> <span class="n">track_durs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                         <span class="n">delta</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingDelegationTests.test_report_seamless_delegation_to_new_gc_last_10_secs"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingDelegationTests.test_report_seamless_delegation_to_new_gc_last_10_secs">[docs]</a>    <span class="nd">@skip</span><span class="p">(</span><span class="s2">&quot;Skip until SWPBL-51222 is fixed&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_report_seamless_delegation_to_new_gc_last_10_secs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Groups 2 players together and starts playback. Change playback to a new GC after 10 seconds and</span>
<span class="sd">        checkes to make sure both the old and new GC send out a setPlayedSeconds report to the smapi server.</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">track_durs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_queue_track_duration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">num_linked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">ZoneGroupTopology</span><span class="o">.</span><span class="n">get_num_linked_zones</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">num_linked</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                   <span class="s2">&quot;found </span><span class="si">{}</span><span class="s2"> zones linked to group coordinator </span><span class="si">{}</span><span class="s2">&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_linked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">track_durs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">track_durs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">leave_group</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">track_durs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
                       <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Make sure the report has the correct time played and trackId</span>
        <span class="n">total_playback_secs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_final_playback_time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">track_durs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="n">total_playback_secs</span><span class="p">,</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: </span><span class="si">{}</span><span class="s2"> - 10 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_playback_secs</span><span class="p">,</span> <span class="n">track_durs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                         <span class="n">delta</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TrackPlayReportingCrossfadeTests"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingCrossfadeTests">[docs]</a><span class="k">class</span> <span class="nc">TrackPlayReportingCrossfadeTests</span><span class="p">(</span><span class="n">WorkflowTestFixture</span><span class="p">):</span>

    <span class="c1"># Crossfading between 2 tracks begins when there is ~12 secs left in the first track</span>

    <span class="c1"># Disabling this class of tests until the following story is resolved</span>
    <span class="c1"># https://jira.sonos.com/browse/SWPBL-57796</span>
    <span class="c1">#TEST_TYPE = [&quot;NIGHTLY_SMAPI_REPORTING&quot;]</span>

    <span class="n">port</span> <span class="o">=</span> <span class="mi">3003</span>

<div class="viewcode-block" id="TrackPlayReportingCrossfadeTests.setUpFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingCrossfadeTests.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;pkill node&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingCrossfadeTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="c1"># make sure to choose a device that play music</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;chsrc&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;cssc&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonoscp&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonosapi&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetMute</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Make the list of usable spare serviceId numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">254</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">3</span></div>


<div class="viewcode-block" id="TrackPlayReportingCrossfadeTests.setUpTest"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingCrossfadeTests.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingCrossfadeTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="c1"># Get a new serviceId and accountId for each test to prevent</span>
        <span class="c1"># tpm reports from leaking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span><span class="p">]</span>
        <span class="c1"># mock SMAPI server setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">start_node_smapi_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                       <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                       <span class="n">server_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                                                       <span class="n">server_internal_id</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">get_account_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                                                       <span class="n">server_sid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
            <span class="s2">&quot;Successfully added SMAPI account?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">)</span>
        <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">clear_smapi_server_logs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log_to_file</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">)</span>

        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetCrossfadeMode</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetCrossfadeMode</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingCrossfadeTests.tearDownTest"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingCrossfadeTests.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log_to_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;BEGIN PLAYER LOG OF FAILURE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;END PLAYER LOG OF FAILURE&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Stale /tmp/anacapad.log file not deleted&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_teardown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                              <span class="s2">&quot;Successfully removed SMAPI account?&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">stop_node_smapi_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingCrossfadeTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackPlayReportingCrossfadeTests.tearDownFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingCrossfadeTests.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetCrossfadeMode</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetCrossfadeMode</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetCrossfadeMode</span><span class="p">(),</span> <span class="kc">False</span><span class="p">,</span>
                                   <span class="s2">&quot;Expect GetCrossfadeMode to return Off&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingCrossfadeTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackPlayReportingCrossfadeTests.test_normal_track_transition_with_crossfade"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingCrossfadeTests.test_normal_track_transition_with_crossfade">[docs]</a>    <span class="k">def</span> <span class="nf">test_normal_track_transition_with_crossfade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Verify the player sends the setPlaySeconds call when crossfading is turned on</span>
<span class="sd">        during normal track progression through the queue</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:20&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:10&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="c1"># Make sure the report has the correct time played and trackId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 30 seconds&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="TrackPlayReportingCrossfadeTests.test_pause_during_crossfade_transition"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingCrossfadeTests.test_pause_during_crossfade_transition">[docs]</a>    <span class="k">def</span> <span class="nf">test_pause_during_crossfade_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Verify the player sends the setPlaySeconds report when crossfade on and</span>
<span class="sd">        there&#39;s a pause action that interrupts the crossfade while playing second track.</span>
<span class="sd">        The expectation is that setPlayedSeconds for track 1 should be accurate and</span>
<span class="sd">        account for the crossfade being cut short by the seek.</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:20&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">clear_smapi_server_logs</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:02&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">setPlayedSeconds</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">setPlayedSeconds</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> times, expected: 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">setPlayedSeconds</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="n">setPlayedSeconds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 26 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">setPlayedSeconds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Extra check to make sure that the reportPlaySeconds report for track 2 has started</span>
        <span class="n">reportPlaySeconds</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span>
                                                                  <span class="n">calls</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reportPlaySeconds&quot;</span><span class="p">],</span>
                                                                  <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reportPlaySeconds</span><span class="p">),</span>
                               <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> times, expected: 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reportPlaySeconds</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">reportPlaySeconds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;reportPlaySeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 1 second&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reportPlaySeconds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingCrossfadeTests.test_transition_crossfade_scrub_on_second_track"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingCrossfadeTests.test_transition_crossfade_scrub_on_second_track">[docs]</a>    <span class="k">def</span> <span class="nf">test_transition_crossfade_scrub_on_second_track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Verify the player sends the setPlaySeconds report when crossfade on and</span>
<span class="sd">        there&#39;s a seek action that interrupts the crossfade while playing second track.</span>
<span class="sd">        The expectation is that setPlayedSeconds for track 1 should be accurate and</span>
<span class="sd">        account for the crossfade being cut short by the seek.</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:20&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:02&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;REL_TIME&quot;</span><span class="p">,</span>
                                      <span class="n">target</span><span class="o">=</span><span class="s2">&quot;0:00:25&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="c1"># Make sure the report has the correct time played and trackId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 26 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingCrossfadeTests.test_transition_crossfade_skip_back_to_first_track"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingCrossfadeTests.test_transition_crossfade_skip_back_to_first_track">[docs]</a>    <span class="k">def</span> <span class="nf">test_transition_crossfade_skip_back_to_first_track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player sends the setPlaySeconds report when crossfade on and</span>
<span class="sd">        there&#39;s a skip action that interrupts the crossfade while playing second track.</span>
<span class="sd">        The expectation is that setPlayedSeconds for track 1 should be accurate and</span>
<span class="sd">        account for the crossfade being cut short by the skip.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:20&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:02&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TRACK_NR&quot;</span><span class="p">,</span>
                                      <span class="n">target</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="c1"># Make sure the report has the correct time played and trackId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 26 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TrackPlayReportingShortTracksTests"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingShortTracksTests">[docs]</a><span class="k">class</span> <span class="nc">TrackPlayReportingShortTracksTests</span><span class="p">(</span><span class="n">WorkflowTestFixture</span><span class="p">):</span>

    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NIGHTLY_SMAPI_REPORTING&quot;</span><span class="p">]</span>

    <span class="n">port</span> <span class="o">=</span> <span class="mi">3004</span>

<div class="viewcode-block" id="TrackPlayReportingShortTracksTests.setUpFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingShortTracksTests.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;pkill node&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingShortTracksTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="c1"># make sure to choose a device that play music</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;chsrc&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;cssc&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonoscp&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonosapi&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetMute</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Make the list of usable spare serviceId numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">254</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">4</span></div>

<div class="viewcode-block" id="TrackPlayReportingShortTracksTests.setUpTest"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingShortTracksTests.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingShortTracksTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="c1"># Get a new serviceId and accountId for each test to prevent</span>
        <span class="c1"># tpm reports from leaking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span><span class="p">]</span>
        <span class="c1"># mock SMAPI server setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">start_node_smapi_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                       <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                       <span class="n">server_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                                                       <span class="n">server_internal_id</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">get_account_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                                                       <span class="n">server_sid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span>
                                                       <span class="n">extra_path</span><span class="o">=</span><span class="s1">&#39;/short_length&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
            <span class="s2">&quot;Successfully added SMAPI account?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">)</span>
        <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">clear_smapi_server_logs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log_to_file</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingShortTracksTests.tearDownTest"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingShortTracksTests.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_teardown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                              <span class="s2">&quot;Successfully removed SMAPI account?&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">stop_node_smapi_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log_to_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;BEGIN PLAYER LOG OF FAILURE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;END PLAYER LOG OF FAILURE&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Stale /tmp/anacapad.log file not deleted&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingShortTracksTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackPlayReportingShortTracksTests.tearDownFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingShortTracksTests.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;chsrc&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;cssc&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonoscp&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonosapi&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingShortTracksTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackPlayReportingShortTracksTests.test_play_after_next_tracks_downloaded"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingShortTracksTests.test_play_after_next_tracks_downloaded">[docs]</a>    <span class="k">def</span> <span class="nf">test_play_after_next_tracks_downloaded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that this situation reports playback time as expected:</span>
<span class="sd">        Playing Track A &gt; Track B and Track C are fully downloaded &gt; Pause Track A &gt; Resume Playing Track A</span>
<span class="sd">        In this case the player needs to throw away what it has buffered from Track B and C in order to resume</span>
<span class="sd">        Track A.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">enqueueduri</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">SMAPI_SERVER_TRACK_URIS</span><span class="p">[</span><span class="n">track</span><span class="p">],</span>
                                      <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">SMAPI_TRACK_METADATA</span><span class="p">[</span><span class="n">track</span><span class="p">],</span>
                                      <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                      <span class="n">enqueueasnext</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">starting_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">requested_count</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="s2">&quot;NumberReturned&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:07&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1"># Wait here for 3 seconds to guarantee that track 1 finished buffering and tracks</span>
        <span class="c1"># 2 and 3 completely buffer before resuming playback</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;Track&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1"># self.test_zp.AVTransport.Pause_and_wait(iteration_delay=1, timeout_seconds=5)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
                               <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> time, expected 1 time&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                         <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 10 seconds&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">]),</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TrackPlayReportingTestOnNoFrameCache"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTestOnNoFrameCache">[docs]</a><span class="k">class</span> <span class="nc">TrackPlayReportingTestOnNoFrameCache</span><span class="p">(</span><span class="n">WorkflowTestFixture</span><span class="p">):</span>

    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NIGHTLY_SMAPI_REPORTING&quot;</span><span class="p">]</span>

    <span class="n">port</span> <span class="o">=</span> <span class="mi">3005</span>

    <span class="k">def</span> <span class="nf">_find_player</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="o">.</span><span class="n">generate_testbed_playback_devices</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_sh4</span><span class="p">()</span> <span class="ow">or</span> <span class="n">zp</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">is_ppc</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">zp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Did not find any playback devices with a frame cache&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="TrackPlayReportingTestOnNoFrameCache.setUpFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTestOnNoFrameCache.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;pkill node&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingTestOnNoFrameCache</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="c1"># make sure to choose a device that play music and doesn&#39;t have a frame cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_player</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;chsrc&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;cssc&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonoscp&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonosapi&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">DeviceProperties</span><span class="o">.</span><span class="n">cleanup_bonded_configuration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetMute</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Make the list of usable spare serviceId numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">254</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">5</span></div>

<div class="viewcode-block" id="TrackPlayReportingTestOnNoFrameCache.setUpTest"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTestOnNoFrameCache.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingTestOnNoFrameCache</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpTest</span><span class="p">()</span>
        <span class="c1"># Get a new serviceId and accountId for each test to prevent</span>
        <span class="c1"># tpm reports from leaking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span><span class="p">]</span>
        <span class="c1"># mock SMAPI server setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">start_node_smapi_server</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                                       <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                                       <span class="n">server_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                                                       <span class="n">server_internal_id</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">get_account_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                                                       <span class="n">server_sid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
            <span class="s2">&quot;Successfully added SMAPI account?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">)</span>
        <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">clear_smapi_server_logs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">start_udp_log_to_file</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingTestOnNoFrameCache.tearDownTest"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTestOnNoFrameCache.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_queue_and_wait</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">clear_play_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="n">smapi_ctl</span><span class="o">.</span><span class="n">smapi_account_teardown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
                              <span class="s2">&quot;Successfully removed SMAPI account?&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">stop_node_smapi_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smapi</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid_range</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sid_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">stop_udp_log_to_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_stop</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_stop_count</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_fail_count</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;BEGIN PLAYER LOG OF FAILURE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;END PLAYER LOG OF FAILURE&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/anacapad.log&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Stale /tmp/anacapad.log file not deleted&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingTestOnNoFrameCache</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownTest</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackPlayReportingTestOnNoFrameCache.tearDownFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTestOnNoFrameCache.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;chsrc&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;cssc&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;avt_impl&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonoscp&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;sonosapi&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingTestOnNoFrameCache</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackPlayReportingTestOnNoFrameCache.test_full_track_reported_accurately"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingTestOnNoFrameCache.test_full_track_reported_accurately">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_track_reported_accurately</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player reports the correct time of playback when a track transitions naturally through the</span>
<span class="sd">        Sonos queue.</span>

<span class="sd">        Expected: Player should report the full duration of the track</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_setup</span><span class="p">(</span><span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">,</span> <span class="n">num_tracks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_playing</span><span class="p">(),</span>
                        <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">start_delay</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">log_values</span><span class="p">,</span> <span class="n">time_taken_secs</span> <span class="o">=</span> <span class="n">smapi_ctl</span><span class="o">.</span><span class="n">wait_for_filtered_log</span><span class="p">(</span><span class="n">smapi</span><span class="o">=</span><span class="n">smapi_ctl</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_values</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">],</span>
                                   <span class="s2">&quot;setPlayedSeconds reported actual: </span><span class="si">{}</span><span class="s2"> seconds, expected: 30 seconds&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;seconds&quot;</span><span class="p">])))</span></div></div>


<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">upnp.functional.hls.mock_smapi_base</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">MockSMAPIBase</span><span class="p">)</span>
<span class="n">CONTAINER</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x-rincon-cpcontainer:0004006cal</span><span class="si">%3a</span><span class="s2">48&quot;</span><span class="p">,)</span>

<div class="viewcode-block" id="TrackPlayReportingHLS"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingHLS">[docs]</a><span class="k">class</span> <span class="nc">TrackPlayReportingHLS</span><span class="p">(</span><span class="n">MockSMAPIBase</span><span class="p">):</span>

    <span class="c1"># Constants for test track/service</span>
    <span class="n">SHLS_TRACK_POS</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">SHLS_SERVICE_TITLE</span> <span class="o">=</span> <span class="s2">&quot;Static HLS DRE on Apple&quot;</span>

    <span class="n">SHLS_TRACK_TITLE</span> <span class="o">=</span> <span class="s2">&quot;Welcome To The Pharmacy&quot;</span>
    <span class="n">SHLS_TRACK_LEN</span> <span class="o">=</span> <span class="mf">15.976562</span>
    <span class="n">SHLS_TRACK_TITLE_2</span> <span class="o">=</span> <span class="s2">&quot;Good Times&quot;</span>
    <span class="n">SHLS_TRACK_LEN_2</span> <span class="o">=</span> <span class="mf">89.977325</span>

    <span class="c1"># Disabling the TrackPlayReportingHLS class until SWPBL-116429 is addressed</span>
    <span class="c1"># TEST_TYPE = [&quot;NIGHTLY_SMAPI_REPORTING&quot;]</span>

    <span class="k">def</span> <span class="nf">_setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform setup for static HLS tracks for a given ZP.</span>

<span class="sd">        :param zp: ZonePlayer</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingHLS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_setUpTest</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">generate_didl_lite</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SHLS_SERVICE_TITLE</span><span class="p">,</span>
            <span class="n">svc_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">svc_acct</span><span class="o">.</span><span class="n">service_id</span><span class="p">,</span>
            <span class="n">acct_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">svc_acct</span><span class="o">.</span><span class="n">serial_number</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">add_to_queue</span><span class="p">(</span><span class="n">CONTAINER</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">set_queue_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SHLS_TRACK_POS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;chsrc&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;hlsaudio&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;adts&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;chsrc&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;hlsaudio&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">set_diag_level</span><span class="p">(</span><span class="s2">&quot;adts&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrackPlayReportingHLS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_tearDownTest</span><span class="p">(</span><span class="n">zp</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_track_played_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">trackTitle</span><span class="p">,</span> <span class="n">trackLen</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the SHLS track played to the full duration by examining udp log for</span>
<span class="sd">        final time played report.</span>

<span class="sd">        :param zp: SonosZoneComponent</span>
<span class="sd">        :type zp: :class:`~sonos.client.internal.SonosZoneComponent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The first track is ~16 seconds; we&#39;re looking for something like the following:</span>
        <span class="c1"># [1970-01-01 18:52:07.679] &lt;tpm,4&gt; Final play time for (Welcome To The Pharmacy) is 15.976562 s (act: 0x0, offset: 15976)</span>
        <span class="c1"># [1970-01-01 18:52:07.745] &lt;sonoscp,2&gt; setPlayedSeconds: context: x-rincon-cpcontainer:0004006cal%3a48;</span>
        <span class="c1"># uri: x-sonosapi-hls-static:tr%3a551?sid=255&amp;flags=32&amp;sn=204; cid: al:48; id: tr:551; seconds: 15; offset: 15976</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;Final play time for \(</span><span class="si">{}</span><span class="s2">\) is (?P&lt;elapsed&gt;\d+\.\d+)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trackTitle</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_log</span> <span class="o">=</span> <span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">wait_for_anacapa_log_statement</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">seconds_played</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">raw_log</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;elapsed&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyAlmostEqualOrFailCase</span><span class="p">(</span><span class="n">trackLen</span><span class="p">,</span> <span class="n">seconds_played</span><span class="p">,</span>
                <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">&gt; expected time passed for final time played report?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">),</span>
                <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Did not receive final time played report &quot;</span>
                      <span class="s2">&quot; from &lt;</span><span class="si">{}</span><span class="s2">&gt; at the end of the track!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zp</span><span class="p">))</span>

<div class="viewcode-block" id="TrackPlayReportingHLS.test_setPlayedSeconds_from_hls_track_with_logical_boundaries"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingHLS.test_setPlayedSeconds_from_hls_track_with_logical_boundaries">[docs]</a>    <span class="k">def</span> <span class="nf">test_setPlayedSeconds_from_hls_track_with_logical_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-65851</span>
<span class="sd">        Make sure that the final play time is reported while playing a hls stream</span>
<span class="sd">        with logical track boundaries.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_track_played_full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHLS_TRACK_TITLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHLS_TRACK_LEN</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackPlayReportingHLS.test_setPlayedSeconds_not_reported_on_resume_from_hls_track_with_logical_boundaries"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingHLS.test_setPlayedSeconds_not_reported_on_resume_from_hls_track_with_logical_boundaries">[docs]</a>    <span class="k">def</span> <span class="nf">test_setPlayedSeconds_not_reported_on_resume_from_hls_track_with_logical_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SWPBL-67049</span>
<span class="sd">        Make sure the player does not generate a setPlayedSeconds report when resuming</span>
<span class="sd">        static HLS.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Give the player some time to play</span>
        <span class="n">wait_until_true</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
            <span class="n">iteration_delay</span><span class="o">=.</span><span class="mi">25</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Verify we time out within 5 seconds of resuming playback attempting</span>
        <span class="c1"># to find a &#39;final play time&#39; report.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyRaisesOrFailCase</span><span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span>
            <span class="s2">&quot;Player did not generate final report after resuming from pause?&quot;</span><span class="p">,</span>
            <span class="n">callable_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">wait_for_anacapa_log_statement</span><span class="p">,</span>
            <span class="n">query</span><span class="o">=</span><span class="s2">&quot;Final play time for \(</span><span class="si">{}</span><span class="s2">\)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SHLS_TRACK_TITLE</span><span class="p">),</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_track_played_full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHLS_TRACK_TITLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHLS_TRACK_LEN</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="TrackPlayReportingHLS.test_setPlayedSeconds_from_hls_track_with_logical_boundaries_two_tracks"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.TrackPlayReportingHLS.test_setPlayedSeconds_from_hls_track_with_logical_boundaries_two_tracks">[docs]</a>    <span class="k">def</span> <span class="nf">test_setPlayedSeconds_from_hls_track_with_logical_boundaries_two_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Give the player some time to play</span>
        <span class="n">wait_until_true</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:05&quot;</span><span class="p">,</span>
            <span class="n">iteration_delay</span><span class="o">=.</span><span class="mi">25</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Pause_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play_and_wait</span><span class="p">(</span><span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Verify we time out within 5 seconds of resuming playback attempting</span>
        <span class="c1"># to find a &#39;final play time&#39; report.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyRaisesOrFailCase</span><span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span>
                                    <span class="s2">&quot;Player did not generate final report after resuming from pause?&quot;</span><span class="p">,</span>
                                    <span class="n">callable_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">wait_for_anacapa_log_statement</span><span class="p">,</span>
                                    <span class="n">query</span><span class="o">=</span><span class="s2">&quot;Final play time for \(</span><span class="si">{}</span><span class="s2">\)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SHLS_TRACK_TITLE</span><span class="p">),</span>
                                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_track_played_full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHLS_TRACK_TITLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHLS_TRACK_LEN</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">position</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:00:15&quot;</span><span class="p">,</span> <span class="s2">&quot;Verify position is passed 1st track </span><span class="si">{}</span><span class="s2"> &gt;= </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="s2">&quot;0:00:15&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_track_played_full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHLS_TRACK_TITLE_2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHLS_TRACK_LEN_2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">GetPositionInfo</span><span class="p">()[</span><span class="s2">&quot;RelTime&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrFailCase</span><span class="p">(</span><span class="n">position</span> <span class="o">&gt;=</span> <span class="s2">&quot;0:01:45&quot;</span><span class="p">,</span> <span class="s2">&quot;Verify position is passed 2nd track </span><span class="si">{}</span><span class="s2"> &gt;= </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="s2">&quot;0:01:45&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HomeTheaterTrackPlayReportingTests"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.HomeTheaterTrackPlayReportingTests">[docs]</a><span class="k">class</span> <span class="nc">HomeTheaterTrackPlayReportingTests</span><span class="p">(</span><span class="n">TrackPlayReportingBase</span><span class="p">):</span>
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NIGHTLY_SMAPI_REPORTING&quot;</span><span class="p">]</span>

    <span class="n">port</span> <span class="o">=</span> <span class="mi">3000</span>

<div class="viewcode-block" id="HomeTheaterTrackPlayReportingTests.setUpFixture"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.HomeTheaterTrackPlayReportingTests.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;HomeTheaterTrackPlayReportingTests.setUpFixture&#39;</span><span class="p">)</span>
        <span class="c1"># make sure to choose a device that plays TV</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">is_ht_master_capable</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">))</span>
        <span class="n">_set_up_fixture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HomeTheaterTrackPlayReportingTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span></div>

<div class="viewcode-block" id="HomeTheaterTrackPlayReportingTests.test_partial_track_reported_accurately_when_transitioning_to_tv"><a class="viewcode-back" href="../../../../upnp.functional.smapi_reporting.html#upnp.functional.smapi_reporting.track_play_reporting.HomeTheaterTrackPlayReportingTests.test_partial_track_reported_accurately_when_transitioning_to_tv">[docs]</a>    <span class="k">def</span> <span class="nf">test_partial_track_reported_accurately_when_transitioning_to_tv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the player accurately reports the amount of time a track played</span>
<span class="sd">        when transitioning to TV</span>

<span class="sd">        Expected: Player should only report the amount of time the track played</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_partial_track_reported_accurately_when_transitioning</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_spdif</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zp</span><span class="p">))</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">WorkflowTestSuite</span><span class="p">(</span><span class="s2">&quot;TrackPlayReportingTests&quot;</span><span class="p">)</span>
    <span class="c1"># suite.run([TrackPlayReportingTests()])</span>
    <span class="n">suite</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">TrackPlayReportingTests</span><span class="p">(),</span>
               <span class="n">TrackPlayReportingContextIdTests</span><span class="p">(),</span>
               <span class="n">TrackPlayReportingShortTracksTests</span><span class="p">(),</span>
               <span class="n">TrackPlayReportingTestOnNoFrameCache</span><span class="p">(),</span>
               <span class="n">TrackPlayReportingDelegationTests</span><span class="p">(),</span>
               <span class="n">HomeTheaterTrackPlayReportingTests</span><span class="p">()])</span>
    <span class="c1"># Disabling the TrackPlayReportingHLS class until SWPBL-116429 is addressed</span>
    <span class="c1"># TrackPlayReportingHLS()</span>

    <span class="c1"># Disabled, see test class for notes</span>
    <span class="c1"># TrackPlayReportingCrossfadeTests()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>