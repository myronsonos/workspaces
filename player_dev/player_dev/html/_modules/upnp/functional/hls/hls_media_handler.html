
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>upnp.functional.hls.hls_media_handler &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for upnp.functional.hls.hls_media_handler</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="k">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto</span> <span class="k">import</span> <span class="n">Random</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="k">import</span> <span class="n">b16encode</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">sonos.settings</span> <span class="k">import</span> <span class="n">make_log_name</span>
<span class="kn">from</span> <span class="nn">sonos.websrv</span> <span class="k">import</span> <span class="n">StaticFileHandlerWithCallback</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">from</span> <span class="nn">sonos.exception</span> <span class="k">import</span> <span class="ne">TimeoutError</span>
<span class="kn">from</span> <span class="nn">custom_tuples</span> <span class="k">import</span> <span class="n">namedtyple</span>


<div class="viewcode-block" id="MediaHandler"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaHandler">[docs]</a><span class="k">class</span> <span class="nc">MediaHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic media playlist handler. All the default values correspond</span>
<span class="sd">    to the BBC media playback of</span>
<span class="sd">    //camb-sqa-nas2/Automation/HLS/bbc_live/media_bbc.m3u8</span>
<span class="sd">    Updates the media list with the relevant segment contents</span>
<span class="sd">    prior to responding to the HTTP GET request to return the</span>
<span class="sd">    contents of the media.</span>
<span class="sd">    The media playlist is updated to remove expired audio segments</span>
<span class="sd">    and introduce new segments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MEDIA</span> <span class="o">=</span> <span class="s2">&quot;media_bbc.m3u8&quot;</span>
    <span class="n">MEDIA_CONTENT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;#EXTM3U</span>
<span class="s2">#EXT-X-VERSION:2</span>
<span class="s2">## Created with Unified Streaming Platform(version=1.7.3)</span>
<span class="s2">#EXT-X-ALLOW-CACHE:NO</span>
<span class="s2">#EXT-X-TARGETDURATION:7</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">INIT_SEQUENCE</span> <span class="o">=</span> <span class="mi">1234124</span>
    <span class="n">MINIMUM_SEGMENTS</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">SEGMENT_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;data</span><span class="si">{:04d}</span><span class="s2">.ts&quot;</span>
    <span class="n">SEGMENT_DURATION</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">ACCEL_DECAY_MASK</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">AUDIO_SEGMENTS</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="n">LARGE_REPEAT_INTERVAL</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">websrv</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">MEDIA</span><span class="p">,</span> <span class="n">segment_fmt</span><span class="o">=</span><span class="n">SEGMENT_FORMAT</span><span class="p">,</span>
                 <span class="n">init_seq</span><span class="o">=</span><span class="n">INIT_SEQUENCE</span><span class="p">,</span> <span class="n">segments</span><span class="o">=</span><span class="n">MINIMUM_SEGMENTS</span><span class="p">,</span>
                 <span class="n">content</span><span class="o">=</span><span class="n">MEDIA_CONTENT</span><span class="p">,</span> <span class="n">audio_segments</span><span class="o">=</span><span class="n">AUDIO_SEGMENTS</span><span class="p">,</span>
                 <span class="n">segment_duration</span><span class="o">=</span><span class="n">SEGMENT_DURATION</span><span class="p">,</span>
                 <span class="n">rollback</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">accel_decay_mask</span><span class="o">=</span><span class="n">ACCEL_DECAY_MASK</span><span class="p">,</span>
                 <span class="n">over_segments</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">large_playlist</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">large_playlist_repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">large_playlist_interval</span><span class="o">=</span><span class="n">LARGE_REPEAT_INTERVAL</span><span class="p">,</span>
                 <span class="n">non_existant_segment</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize variables that govern how the media playlist is</span>
<span class="sd">        updated.</span>
<span class="sd">        The default media playlist is a captured HLS audio of BBC</span>
<span class="sd">        content.</span>
<span class="sd">        :param :class:`sonos.websrv.WebServer` websrv: Web server object</span>
<span class="sd">        :param str name: Media playlist file name</span>
<span class="sd">        :param str segment_fmt: The pattern format of the audio</span>
<span class="sd">        segment file</span>
<span class="sd">        :param int init_seq: Starting sequence of the media playlist</span>
<span class="sd">        :param int segments: Media duration expressed in audio segments</span>
<span class="sd">        :param str content: The media header information</span>
<span class="sd">        :param int audio_segments: The number of unique audio segments</span>
<span class="sd">        available during for the media playlist</span>
<span class="sd">        :param int segment_duration: Audio segment duration in seconds</span>
<span class="sd">        :param bool rollback: Roll back to first segment when media list</span>
<span class="sd">        exhausted. Continues updating the media file thereafter.</span>
<span class="sd">        :param int accel_decay_mask: The interval of decaying an extra audio</span>
<span class="sd">        segment. Defaults to ACCEL_DECAY_MASK.</span>
<span class="sd">        :param int over_segments: Number of audio segments to age</span>
<span class="sd">        :param int large_playlist: Number of segments to report in large</span>
<span class="sd">        playlist. A value of zero indicates that no large playlist will be</span>
<span class="sd">        created else the integer represents the number of segments to be</span>
<span class="sd">        reported in the large playlist.</span>
<span class="sd">        :param bool large_playlist_repeat: Keep sending the large playlist</span>
<span class="sd">        periodically every large_playlist_interval ? If False the large</span>
<span class="sd">        playlist is created once.</span>
<span class="sd">        :param int large_playlist_interval: The interval the large playlist</span>
<span class="sd">        is generated. Defaults to LARGE_REPEAT_INTERVAL</span>
<span class="sd">        :param str non_existant_segment: Segment file name the server will</span>
<span class="sd">        respond with an HTTP not found. Defaults to a random string of</span>
<span class="sd">        eight alphabetic characters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq_begin</span> <span class="o">=</span> <span class="n">init_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">init_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MINIMUM_SEGMENTS</span><span class="p">)</span>
        <span class="c1"># First sequence number assigned to data files - internal use only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Number of playable audio segments available on the server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio_segments</span> <span class="o">=</span> <span class="n">audio_segments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segment_duration</span> <span class="o">=</span> <span class="n">segment_duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_tik</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_repeat</span> <span class="o">=</span> <span class="n">large_playlist_repeat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_once</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_repeat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_mask</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="n">large_playlist_interval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE_REPEAT_INTERVAL</span><span class="p">)</span>
        <span class="c1"># Periodically BBC decays an extra segment...Defaults to every seventh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accel_decay_mask</span> <span class="o">=</span> <span class="n">accel_decay_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accel_decay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rollover</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span> <span class="o">=</span> <span class="n">rollback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapped</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">over_segments</span> <span class="o">=</span> <span class="n">over_segments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist</span> <span class="o">=</span> <span class="n">large_playlist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segment_fmt</span> <span class="o">=</span> <span class="n">segment_fmt</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_existant_segment</span> <span class="o">=</span> <span class="n">non_existant_segment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_non_existant_segment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span>
            <span class="n">make_log_name</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span> <span class="o">=</span> <span class="n">websrv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media_name</span><span class="p">,</span>
            <span class="n">StaticFileHandlerWithCallback</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">media_name</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">media_cb</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_create_non_existant_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If there&#39;s no name for the non existant audio segment</span>
<span class="sd">        and we&#39;re to generate large media playlists, create a</span>
<span class="sd">        random name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_existant_segment</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">non_existant_segment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">letters</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<div class="viewcode-block" id="MediaHandler.reset"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaHandler.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset all variables to their initial values.</span>
<span class="sd">        This method should be called when the media playlist</span>
<span class="sd">        will be used on subsequent player(s) than the first</span>
<span class="sd">        player that used the list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_begin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_tik</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_once</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_repeat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accel_decay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rollover</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapped</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="mf">0.0</span></div>

<div class="viewcode-block" id="MediaHandler.get_non_existant_segment_name"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaHandler.get_non_existant_segment_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_non_existant_segment_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the arbitrary name assigned to segments which the</span>
<span class="sd">        HTTP server will respond with an HTTP 404 - not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_existant_segment</span></div>

    <span class="k">def</span> <span class="nf">_write_non_existant_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes end - start occurrences of a non-existant segment.</span>
<span class="sd">        :param file fh: File object handle</span>
<span class="sd">        :param int start: Starting sequence</span>
<span class="sd">        :param int end: Ending sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;#EXTINF:</span><span class="si">{}</span><span class="s2">, no desc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segment_duration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_existant_segment</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_write_audio_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the audio segments in the media file.</span>
<span class="sd">        Updates the audio sequence number and potentially sets the</span>
<span class="sd">        flag to indicate the audio sequence number space</span>
<span class="sd">        has wrapped.</span>
<span class="sd">        :param file fh: File object handle</span>
<span class="sd">        :param int start: Starting audio sequence number</span>
<span class="sd">        :param int end: Ending sequence number (exclusive)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;#EXTINF:</span><span class="si">{}</span><span class="s2">, no desc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segment_duration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">segment_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_segments</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_segments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rollover</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollover</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrapped</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="MediaHandler.update_initial_playlist"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaHandler.update_initial_playlist">[docs]</a>    <span class="k">def</span> <span class="nf">update_initial_playlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The first media playlist will contain segments which the</span>
<span class="sd">        player SHOULD ignore only if the media playlist size</span>
<span class="sd">        exceeds four segments.</span>
<span class="sd">        For example, the media playlist size is a constant of</span>
<span class="sd">        6 segments. This method will compile a playlist with</span>
<span class="sd">        first and second segment pointing to an unhandled</span>
<span class="sd">        segment name (the HTTP server will respond with NOT FOUND)</span>
<span class="sd">        while segments three through six will be the first four</span>
<span class="sd">        segments of the audio playback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media_name</span><span class="p">,</span> <span class="s2">&quot;wb+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media_content</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#EXT-X-MEDIA-SEQUENCE:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">))</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_non_existant_segments</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Initial segment name begins </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">segment_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Initial segment name ends   </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">segment_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_audio_segments</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

<div class="viewcode-block" id="MediaHandler.update_large_playlist"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaHandler.update_large_playlist">[docs]</a>    <span class="k">def</span> <span class="nf">update_large_playlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">entries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a large list which contains several (hundreds) of old entries</span>
<span class="sd">        with some new entries.</span>
<span class="sd">        :param int seq: First sequence number of old entry</span>
<span class="sd">        :param int entries: The number of entries to report in the media</span>
<span class="sd">        :param int new: The number of new entries to report in the media</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Creating playlist with </span><span class="si">{}</span><span class="s2"> entries from sequence </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">entries</span><span class="p">,</span> <span class="n">seq</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media_name</span><span class="p">,</span> <span class="s2">&quot;wb+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media_content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Large playlist media sequence </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#EXT-X-MEDIA-SEQUENCE:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>
            <span class="c1"># have we advertised the sequence before ?</span>
            <span class="k">if</span> <span class="n">seq</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_begin</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_non_existant_segments</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_begin</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">base_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_begin</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_seq</span> <span class="o">=</span> <span class="n">seq</span>
                <span class="c1"># Compute the associated audio sequence</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span> <span class="o">-</span> <span class="n">entries</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_segments</span> <span class="o">+</span> <span class="n">new</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_segments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Using audio segment starting sequence </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_audio_segments</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">base_seq</span><span class="p">,</span> <span class="n">seq</span> <span class="o">+</span> <span class="n">entries</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">+</span> <span class="n">new</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Audio sequence </span><span class="si">{}</span><span class="s2"> media sequence </span><span class="si">{}</span><span class="s2"> post large update&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_segments_aged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a tuple consisting of number of segments that have</span>
<span class="sd">        expired a boolean of whether o large playlist needs to be</span>
<span class="sd">        compiled.</span>
<span class="sd">        Updates the large playlist counter and determines if a</span>
<span class="sd">        large playlist should be compiled.</span>
<span class="sd">        :param int elapsed: The number of seconds that have elapsed</span>
<span class="sd">        since the media file was updated.</span>
<span class="sd">        :return: Number of expired segments, large playlist ?</span>
<span class="sd">        :rtype: :obj:`tuple`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_tik</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_tik</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ticked</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_tik</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_mask</span>
        <span class="c1"># At least one. How many segments have aged ?</span>
        <span class="n">aged</span> <span class="o">=</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_duration</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_duration</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">decayed</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accel_decay</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">accel_decay_mask</span>
        <span class="k">if</span> <span class="n">decayed</span><span class="p">:</span>
            <span class="n">aged</span> <span class="o">=</span> <span class="n">aged</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Extra segment to be decayed - per BBC behavior&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">over_segments</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aged</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">over_segments</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Overriding natural segment decay with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aged</span><span class="p">))</span>
        <span class="c1"># cap it to number of segments in playlist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> segments aged capping to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">aged</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">aged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">)))</span>
        <span class="n">aged</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">aged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">aged</span><span class="p">,</span> <span class="n">ticked</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_required</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tuple consisting of a bool - True means</span>
<span class="sd">        update required, elapsed time in seconds since last</span>
<span class="sd">        media file was updated and the current time.</span>
<span class="sd">        Updates the accelerated decay counter.</span>
<span class="sd">        :return: Update required ?, elapsed time, current time</span>
<span class="sd">        :rtype: :obj:`tuple`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrapped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Audio segments exhausted ... ignoring update&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="c1"># Which segments need to be aged since the last media update ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accel_decay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accel_decay</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;elapsed=</span><span class="si">{}</span><span class="s2"> self.segment_duration=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">elapsed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_duration</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_duration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> No segment elapsed...keeping old playlist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">now</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>

<div class="viewcode-block" id="MediaHandler.update_playlist"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaHandler.update_playlist">[docs]</a>    <span class="k">def</span> <span class="nf">update_playlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the media playlist paying attention to audio segments which</span>
<span class="sd">        have aged replacing them with new audio segments.</span>
<span class="sd">        If configured, it updates the media list with entries that have been</span>
<span class="sd">        previously reported (aged) to simulate field behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_required</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="p">(</span><span class="n">aged</span><span class="p">,</span> <span class="n">ticked</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_segments_aged</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ticked</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_once</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_repeat</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist_once</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">+</span> <span class="n">aged</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist</span>
            <span class="k">if</span> <span class="n">seq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_large_playlist</span><span class="p">(</span>
                    <span class="n">seq</span><span class="p">,</span> <span class="n">entries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">large_playlist</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">aged</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Can&#39;t send large playlist of </span><span class="si">{}</span><span class="s2"> entries&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">large_playlist</span><span class="p">))</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span> <span class="o">+</span> <span class="n">aged</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media_name</span><span class="p">,</span> <span class="s2">&quot;wb+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span> <span class="o">+</span> <span class="n">aged</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Media sequence </span><span class="si">{}</span><span class="s2"> audio segment sequence </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_seq</span><span class="p">))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media_content</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#EXT-X-MEDIA-SEQUENCE:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_audio_segments</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">+</span> <span class="n">aged</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">now</span></div>

<div class="viewcode-block" id="MediaHandler.media_cb"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaHandler.media_cb">[docs]</a>    <span class="k">def</span> <span class="nf">media_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call back when the media playlist is requested via the HTTP GET</span>
<span class="sd">        message. Updates the media playlist file whose contents will be</span>
<span class="sd">        returned as a response to the HTTP request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_initial_playlist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_playlist</span><span class="p">()</span></div>

<div class="viewcode-block" id="MediaHandler.stop_cb"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaHandler.stop_cb">[docs]</a>    <span class="k">def</span> <span class="nf">stop_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">remove_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="MediaHandler.resume_cb"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaHandler.resume_cb">[docs]</a>    <span class="k">def</span> <span class="nf">resume_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cb</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websrv</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media_name</span><span class="p">,</span>
            <span class="n">StaticFileHandlerWithCallback</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">media_name</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">media_cb</span><span class="p">))</span></div></div>


<span class="n">MediaPlaylistFormat</span> <span class="o">=</span> <span class="n">namedtyple</span><span class="p">(</span>
    <span class="s2">&quot;MediaPlaylistFormat&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;uripat&#39;</span><span class="p">,</span> <span class="s1">&#39;numsegs&#39;</span><span class="p">,</span> <span class="s1">&#39;seglen&#39;</span><span class="p">,</span> <span class="s1">&#39;filepat&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;numfiles&#39;</span><span class="p">,</span> <span class="s1">&#39;seqnum&#39;</span><span class="p">,</span> <span class="s1">&#39;encrypted&#39;</span><span class="p">,</span> <span class="s1">&#39;bandwidth&#39;</span><span class="p">,</span> <span class="s1">&#39;codecs&#39;</span><span class="p">])</span>
<span class="n">INF_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=</span><span class="si">{}</span><span class="s2">,CODECS=</span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
<span class="n">EXT_KEY_FORMAT</span> <span class="o">=</span> <span class="s1">&#39;#EXT-X-KEY:METHOD=SAMPLE-AES,URI=&quot;skd://smapi.sonos.com/r1/</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&quot;,KEYFORMAT=&quot;com.sonos.streamingkey&quot;,KEYFORMATVERSIONS=&quot;1&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>


<div class="viewcode-block" id="MasterPlaylistThread"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MasterPlaylistThread">[docs]</a><span class="k">class</span> <span class="nc">MasterPlaylistThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Media playlist manager on playbacks that do not require</span>
<span class="sd">    HTTP intervention of master/media/segments.</span>
<span class="sd">    Initial implementation by Jeff Peters with subsequent</span>
<span class="sd">    re-factoring for automation frame work and media playlist</span>
<span class="sd">    reset by Paul Makridis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">STOP</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">RESET</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">DEFAULT_SEGLEN</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medialist</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NONE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span>
            <span class="n">make_log_name</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]))</span>

<div class="viewcode-block" id="MasterPlaylistThread.push"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MasterPlaylistThread.push">[docs]</a>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">media</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">media</span><span class="p">)</span></div>

<div class="viewcode-block" id="MasterPlaylistThread.pop"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MasterPlaylistThread.pop">[docs]</a>    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="p">)):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="n">m</span><span class="o">.</span><span class="n">purge</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span></div>

<div class="viewcode-block" id="MasterPlaylistThread.write"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MasterPlaylistThread.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#EXTM3U</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">media</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">media</span><span class="o">.</span><span class="n">isvisible</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">INF_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">media</span><span class="o">.</span><span class="n">getbandwidth</span><span class="p">(),</span> <span class="n">media</span><span class="o">.</span><span class="n">getcodecs</span><span class="p">()))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">media</span><span class="o">.</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MasterPlaylistThread.handle_event"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MasterPlaylistThread.handle_event">[docs]</a>    <span class="k">def</span> <span class="nf">handle_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">RESET</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Handling reset event&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">seglen</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">STOP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Handling stop event&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected signal reason=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="MasterPlaylistThread.run"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MasterPlaylistThread.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Based on the segment duration, update the corresponding</span>
<span class="sd">        media playlist files.</span>
<span class="sd">        On master reset event, reset the media playlists and</span>
<span class="sd">        resume update.</span>
<span class="sd">        A reset causes the media playlists to be updated from the</span>
<span class="sd">        beginning sequence; first audio segment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">media</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="p">:</span>
                <span class="n">media</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
            <span class="c1"># Replace with something that uses time of day.  That should be</span>
            <span class="c1"># accurate enough in the long run</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Ticking </span><span class="si">{}</span><span class="s2"> seconds to age audio segment&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">seglen</span><span class="p">)))</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">seglen</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ret=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">isSet</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Master thread main loop exiting&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MasterPlaylistThread.get_seglen"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MasterPlaylistThread.get_seglen">[docs]</a>    <span class="k">def</span> <span class="nf">get_seglen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">seglen</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_SEGLEN</span></div>

    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">media</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="p">:</span>
            <span class="n">media</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<div class="viewcode-block" id="MasterPlaylistThread.set_event_reason"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MasterPlaylistThread.set_event_reason">[docs]</a>    <span class="k">def</span> <span class="nf">set_event_reason</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span></div>

<div class="viewcode-block" id="MasterPlaylistThread.post_event"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MasterPlaylistThread.post_event">[docs]</a>    <span class="k">def</span> <span class="nf">post_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_event_reason</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wait_until_true</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">isSet</span><span class="p">(),</span>
                <span class="n">iteration_delay</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">seglen</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unexpected timeout waiting on reset&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MasterPlaylistThread.reset"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MasterPlaylistThread.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RESET</span><span class="p">)</span></div>

<div class="viewcode-block" id="MasterPlaylistThread.shutdown"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MasterPlaylistThread.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STOP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">media</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">medialist</span><span class="p">:</span>
            <span class="n">media</span><span class="o">.</span><span class="n">purge</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Shutdown master thread exit&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MediaURI"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaURI">[docs]</a><span class="k">class</span> <span class="nc">MediaURI</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contains the real path to the file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uripat</span><span class="p">,</span> <span class="n">seqnum</span><span class="p">,</span> <span class="n">realname</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uripat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seqnum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seqnum</span> <span class="o">=</span> <span class="n">seqnum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">realname</span> <span class="o">=</span> <span class="n">realname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iv</span> <span class="o">=</span> <span class="n">iv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span>
            <span class="n">make_log_name</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">realname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;add </span><span class="si">{}</span><span class="s2"> linked to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">realname</span><span class="p">))</span>

<div class="viewcode-block" id="MediaURI.cleanup"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaURI.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;removed link </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">realname</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="MediaPlaylist"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist">[docs]</a><span class="k">class</span> <span class="nc">MediaPlaylist</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages the media playlist. Inserts segment URI, ages URIs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEFAULT_BANDWIDTH</span> <span class="o">=</span> <span class="mi">64000</span>
    <span class="n">DEFAULT_CODECS</span> <span class="o">=</span> <span class="s2">&quot;mp4a.40.5&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">uripat</span><span class="p">,</span> <span class="n">numsegs</span><span class="p">,</span> <span class="n">seglen</span><span class="p">,</span>
                 <span class="n">filepat</span><span class="p">,</span> <span class="n">numfiles</span><span class="p">,</span> <span class="n">seqnum</span><span class="p">,</span> <span class="n">encrypted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">bandwidth</span><span class="o">=</span><span class="n">DEFAULT_BANDWIDTH</span><span class="p">,</span> <span class="n">codecs</span><span class="o">=</span><span class="n">DEFAULT_CODECS</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span>
            <span class="n">make_log_name</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uripat</span> <span class="o">=</span> <span class="n">uripat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numsegs</span> <span class="o">=</span> <span class="n">numsegs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seglen</span> <span class="o">=</span> <span class="n">seglen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filepat</span> <span class="o">=</span> <span class="n">filepat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numfiles</span> <span class="o">=</span> <span class="n">numfiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileidx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uris</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">olduris</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seqnum</span> <span class="o">=</span> <span class="n">seqnum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seqnum_beg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seqnum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">codecs</span> <span class="o">=</span> <span class="n">codecs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">bandwidth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encrypted</span> <span class="o">=</span> <span class="n">encrypted</span>
        <span class="k">if</span> <span class="n">encrypted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encryptionKeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">Random</span><span class="o">.</span><span class="n">get_random_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numfiles</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encryptionIvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Random</span><span class="o">.</span><span class="n">get_random_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numfiles</span><span class="p">)]</span>
            <span class="c1"># Encrypt the files with the IV and Key.</span>
            <span class="c1"># TBD: do we need to do something different with the IV, like</span>
            <span class="c1"># carry it forward??</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filepat</span> <span class="o">=</span> <span class="n">filepat</span> <span class="o">+</span> <span class="s2">&quot;.enc&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">filepat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepat</span><span class="p">,</span> <span class="n">numfiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encryptionKeys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encryptionIvs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encryptionKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numfiles</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encryptionIvs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numfiles</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numsegs</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="MediaPlaylist.encrypt"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.encrypt">[docs]</a>    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_pat_in</span><span class="p">,</span> <span class="n">file_pat_out</span><span class="p">,</span> <span class="n">num_files</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">ivs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method generates encrypted audio data using the random</span>
<span class="sd">        key and initialization vector (iv).</span>
<span class="sd">        The &quot;MPEG-2 Stream Encryption Format for HTTP Live Streaming&quot;</span>
<span class="sd">        https://developer.apple.com/library/ios/documentation/AudioVideo/Conceptual/HLS_Sample_Encryption/Encryption/Encryption.html#//apple_ref/doc/uid/TP40012862-CH2-SW9</span>
<span class="sd">        :param str file_pat_in: Input file pattern (unencrypted)</span>
<span class="sd">        :param str file_pat_out: Output file pattern (encrypted)</span>
<span class="sd">        :param int num_files: The number of file to encrypt</span>
<span class="sd">        :param list keys: Random key</span>
<span class="sd">        :param list ivs: Random initialization vectors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">num_files</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">iv</span> <span class="o">=</span> <span class="n">ivs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">src_name</span> <span class="o">=</span> <span class="n">file_pat_in</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">dst_name</span> <span class="o">=</span> <span class="n">file_pat_out</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">src</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">src_name</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
            <span class="c1"># try to find packet start</span>
            <span class="n">byte1</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">byte2</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">ctr</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">byte1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte2</span> <span class="o">&amp;</span> <span class="mh">0xf6</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xfff0</span><span class="p">):</span>
                <span class="c1"># Write out the first byte</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">byte1</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">byte2</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">):</span>
                    <span class="n">byte1</span> <span class="o">=</span> <span class="n">byte2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if the second byte is also unused, write it too</span>
                    <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">byte2</span><span class="p">))</span>
                    <span class="n">ch</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">break</span>
                    <span class="n">byte1</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
                    <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">byte2</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
                <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pkt</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">byte1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">byte2</span><span class="p">)</span> <span class="o">+</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="c1"># do the encryption here</span>
                    <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
                    <span class="n">header_bytes</span> <span class="o">=</span> <span class="mi">7</span>
                    <span class="n">has_checksum</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># If we have a checksum, we need to write it and advance</span>
                    <span class="c1"># the file.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">has_checksum</span><span class="p">):</span>
                        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">header_bytes</span> <span class="o">+=</span> <span class="mi">2</span>
                    <span class="c1"># Now calculate packet length (this includes the header</span>
                    <span class="c1"># and the checksum)</span>
                    <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span>
                    <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">pkt_len</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">pkt_len</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span>
                    <span class="n">pkt_len</span> <span class="o">-=</span> <span class="n">header_bytes</span>
                    <span class="n">remaining</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pkt_len</span><span class="p">))</span>
                    <span class="c1"># If there is any encyrpted content at all</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">):</span>
                        <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">pkt_len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xF</span>  <span class="c1"># trim any excess over a 16 byte block</span>
                        <span class="n">remaining</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">remaining</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="n">end</span><span class="p">]))</span>
                    <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span>
                    <span class="n">pkt</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Got unexpected length file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src_name</span><span class="p">))</span>
            <span class="n">src</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="MediaPlaylist.setbandwidth"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.setbandwidth">[docs]</a>    <span class="k">def</span> <span class="nf">setbandwidth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">bandwidth</span></div>

<div class="viewcode-block" id="MediaPlaylist.getbandwidth"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.getbandwidth">[docs]</a>    <span class="k">def</span> <span class="nf">getbandwidth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandwidth</span></div>

<div class="viewcode-block" id="MediaPlaylist.setvisible"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.setvisible">[docs]</a>    <span class="k">def</span> <span class="nf">setvisible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isvisible</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="n">isvisible</span></div>

<div class="viewcode-block" id="MediaPlaylist.isvisible"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.isvisible">[docs]</a>    <span class="k">def</span> <span class="nf">isvisible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible</span><span class="p">)</span></div>

<div class="viewcode-block" id="MediaPlaylist.isvalid"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.isvalid">[docs]</a>    <span class="k">def</span> <span class="nf">isvalid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid</span></div>

<div class="viewcode-block" id="MediaPlaylist.seturipat"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.seturipat">[docs]</a>    <span class="k">def</span> <span class="nf">seturipat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newuripat</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uripat</span> <span class="o">=</span> <span class="n">newuripat</span></div>

<div class="viewcode-block" id="MediaPlaylist.setbitrate"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.setbitrate">[docs]</a>    <span class="k">def</span> <span class="nf">setbitrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">bitrate</span></div>

<div class="viewcode-block" id="MediaPlaylist.getcodecs"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.getcodecs">[docs]</a>    <span class="k">def</span> <span class="nf">getcodecs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">codecs</span></div>

<div class="viewcode-block" id="MediaPlaylist.purge"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.purge">[docs]</a>    <span class="k">def</span> <span class="nf">purge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uris</span><span class="p">):</span>
            <span class="n">uri</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uris</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">olduris</span><span class="p">):</span>
            <span class="n">uri</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">olduris</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="MediaPlaylist.reset"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">purge</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileidx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seqnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seqnum_beg</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numsegs</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="MediaPlaylist.tick"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.tick">[docs]</a>    <span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span></div>

<div class="viewcode-block" id="MediaPlaylist.push"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.push">[docs]</a>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">MediaURI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uripat</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">seqnum</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">filepat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileidx</span><span class="p">),</span>
                     <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encryptionKeys</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fileidx</span><span class="p">],</span>
                     <span class="n">iv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encryptionIvs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fileidx</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seqnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seqnum</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileidx</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileidx</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numfiles</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fileidx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uris</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">numsegs</span><span class="p">):</span>
            <span class="n">expired</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uris</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">olduris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expired</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">olduris</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">junk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">olduris</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                <span class="n">junk</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="MediaPlaylist.write"><a class="viewcode-back" href="../../../../upnp.functional.hls.html#upnp.functional.hls.hls_media_handler.MediaPlaylist.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uris</span><span class="p">)):</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uris</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">seqnum</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#EXTM3U</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#EXT-X-VERSION:2</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#EXT-X-MEDIA-SEQUENCE:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#EXT-X-TARGETDURATION:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seglen</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uris</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypted</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">EXT_KEY_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b16encode</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">key</span><span class="p">),</span> <span class="n">b16encode</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">iv</span><span class="p">)))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#EXTINF:</span><span class="si">{}</span><span class="s2">, no desc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seglen</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>