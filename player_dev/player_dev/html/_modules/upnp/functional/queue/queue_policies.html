
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>upnp.functional.queue.queue_policies &#8212; TestCase Documentation  documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for upnp.functional.queue.queue_policies</h1><div class="highlight"><pre>
<span></span><span class="c1">#-*- coding: utf-8 -*-</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Queue:CreateQueue tests that exercise the queue policies introduced with the Biggie release (24.1-XXXXX)</span>
<span class="sd">Tests cover positive testing only, the player code contains all negative unit tests for the xml parser.</span>

<span class="sd">Queue policies are defined in oc/zone/zoneplayer/tqueue.h and also in sonos/services/diag.py</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">sonos.workflow.suite</span> <span class="k">import</span> <span class="n">WorkflowTestSuite</span>
<span class="kn">from</span> <span class="nn">sonos.services.common</span> <span class="k">import</span> <span class="n">wait_until_true</span>
<span class="kn">import</span> <span class="nn">sonos.exception</span>
<span class="kn">import</span> <span class="nn">upnp.api.queue.helpers</span>
<span class="kn">import</span> <span class="nn">sonos.client.zone_player</span>
<span class="kn">from</span> <span class="nn">upnp.helpers.ignore_invoke_errors</span> <span class="k">import</span> <span class="n">IgnoreInvokeErrors</span>
<span class="kn">from</span> <span class="nn">upnp.functional.queue.queue_test_fixture</span> <span class="k">import</span> <span class="n">BaseQueueTestFixture</span>
<span class="kn">from</span> <span class="nn">upnp.functional.queue.playbackpolicies</span> <span class="k">import</span> <span class="n">PLAYBACK_POLICIES</span>

<span class="n">helpers</span> <span class="o">=</span> <span class="n">upnp</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">QueueServiceHelpers</span><span class="p">()</span>

<span class="n">suite</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="QueuePolicyTests"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests">[docs]</a><span class="k">class</span> <span class="nc">QueuePolicyTests</span><span class="p">(</span><span class="n">BaseQueueTestFixture</span><span class="p">):</span>
    
    <span class="n">TEST_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;QUEUE&quot;</span><span class="p">]</span>
    
<div class="viewcode-block" id="QueuePolicyTests.setUpFixture"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.setUpFixture">[docs]</a>    <span class="k">def</span> <span class="nf">setUpFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QueuePolicyTests: setUpFixture&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QueuePolicyTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpFixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_zones</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">zp</span><span class="p">:</span> <span class="n">zp</span><span class="o">.</span><span class="n">is_playback_device</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">zp</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_group_member</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_devices</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyTrueOrStop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_zones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;this test requires at least 2 playback zones&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zones</span><span class="p">:</span>
            <span class="n">z</span><span class="o">.</span><span class="n">RenderingControl</span><span class="o">.</span><span class="n">SetVolume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="QueuePolicyTests.tearDownFixture"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.tearDownFixture">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownFixture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QueuePolicyTests: tearDownFixture&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QueuePolicyTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownFixture</span><span class="p">()</span></div>

<div class="viewcode-block" id="QueuePolicyTests.setUpTest"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.setUpTest">[docs]</a>    <span class="k">def</span> <span class="nf">setUpTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># STA-1025 override BaseQueueTestFixture method to preserve original test procedure</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="QueuePolicyTests.tearDownTest"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.tearDownTest">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># STA-1025 override BaseQueueTestFixture method to preserve original test procedure</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_queuepolicy_allow_shuffle_false"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_queuepolicy_allow_shuffle_false">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_queuepolicy_allow_shuffle_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_unique_playback_devices</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Test: Verify the allowShuffle policy functions when set to not allow shuffling</span>
<span class="sd">        Devices: All playable</span>
<span class="sd">        Expected: 712 error</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_unique_playback_devices</span>
    
        <span class="n">qid</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                                     <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                     <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;allowShuffle value=&quot;0&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetPlayMode</span><span class="p">(</span><span class="n">play_mode</span><span class="o">=</span><span class="s2">&quot;SHUFFLE&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sonos</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">UPnPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span>
                <span class="n">sonos</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">zone_player</span><span class="o">.</span><span class="n">UPNP_ERROR_712_PLAYMODE_UNSUPPORTED</span><span class="p">,</span>
                <span class="n">e</span><span class="o">.</span><span class="n">upnp_error</span><span class="p">,</span>
                <span class="s2">&quot;Attempts to set shuffle while disabled via queue policy should fail&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Attempts to set shuffle while disabled via queue &quot;</span>
                      <span class="s2">&quot;policy should fail!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_queuepolicy_allow_shuffle_true"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_queuepolicy_allow_shuffle_true">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_queuepolicy_allow_shuffle_true</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_unique_playback_devices</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Test: Verify the allowShuffle policy functions when set to allow shuffling</span>
<span class="sd">        Devices: All playable</span>
<span class="sd">        Expected: Success</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_unique_playback_devices</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                                     <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                     <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;allowShuffle value=&quot;1&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetPlayMode</span><span class="p">(</span><span class="n">play_mode</span><span class="o">=</span><span class="s2">&quot;SHUFFLE&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_allow_repeat_policy_false"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_allow_repeat_policy_false">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_allow_repeat_policy_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_unique_playback_devices</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Test: Verify the allowRepeat policy functions</span>
<span class="sd">        Devices: All Playable</span>
<span class="sd">        Expected: 712 error</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_unique_playback_devices</span>
    
        <span class="n">qid</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                                     <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                     <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;allowRepeat value=&quot;0&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetPlayMode</span><span class="p">(</span><span class="n">play_mode</span><span class="o">=</span><span class="s2">&quot;REPEAT_ALL&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sonos</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">UPnPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span>
                <span class="n">sonos</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">zone_player</span><span class="o">.</span><span class="n">UPNP_ERROR_712_PLAYMODE_UNSUPPORTED</span><span class="p">,</span>
                <span class="n">e</span><span class="o">.</span><span class="n">upnp_error</span><span class="p">,</span>
                <span class="s2">&quot;Attempts to set repeat while disabled via queue policy should fail&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Attempts to set repeat while disabled via queue policy &quot;</span>
                      <span class="s2">&quot;should raise a UPnP error!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_queuepolicy_allow_repeat_true"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_queuepolicy_allow_repeat_true">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_queuepolicy_allow_repeat_true</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_unique_playback_devices</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Test: Verify the allowShuffle policy functions when set to allow shuffling</span>
<span class="sd">        Devices: All playable</span>
<span class="sd">        Expected: Success</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_unique_playback_devices</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                                     <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                     <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;allowRepeat value=&quot;1&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">SetPlayMode</span><span class="p">(</span><span class="n">play_mode</span><span class="o">=</span><span class="s2">&quot;REPEAT_ALL&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_clear_on_end_true"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_clear_on_end_true">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_clear_on_end_true</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_unique_playback_devices</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Test: Verify the clearOnEnd queue policy leaves no tracks in the queue when set to true</span>
<span class="sd">        Devices: All playable</span>
<span class="sd">        Expected: Success</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_unique_playback_devices</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                                     <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                     <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;clearOnEnd value=&quot;1&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                          <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">enqueueduri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">track_source</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">media_url</span><span class="p">,</span>
                          <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                          <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">enqueueasnext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play</span><span class="p">()</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;REL_TIME&#39;</span><span class="p">,</span> 
                              <span class="n">target</span><span class="o">=</span><span class="s1">&#39;00:03:04&#39;</span><span class="p">)</span>

        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">wait_for_state_variables</span><span class="p">((</span><span class="s1">&#39;TransportState&#39;</span><span class="p">,</span> <span class="s1">&#39;NumberOfTracks&#39;</span><span class="p">),</span>
                                             <span class="k">lambda</span> <span class="n">ts</span><span class="p">,</span> <span class="n">nt</span><span class="p">:</span> <span class="n">ts</span> <span class="o">==</span> <span class="s1">&#39;STOPPED&#39;</span> <span class="ow">and</span> <span class="n">nt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                                             <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">tracks_left</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                                        <span class="n">starting_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                        <span class="n">requested_count</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="n">tracks_left</span><span class="p">[</span><span class="s2">&quot;NumberReturned&quot;</span><span class="p">],</span>
            <span class="s2">&quot;clearOnEnd policy should leave the queue empty once the end of queue is reached&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_clear_on_end_false"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_clear_on_end_false">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_clear_on_end_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_unique_playback_devices</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Test: Verify the clearOnEnd queue policy leaves existing tracks in the queue when set to false</span>
<span class="sd">        Devices: All playable</span>
<span class="sd">        Expected: Success</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_unique_playback_devices</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                                     <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                     <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;clearOnEnd value=&quot;0&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                          <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">enqueueduri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">track_source</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">media_url</span><span class="p">,</span>
                          <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                          <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">enqueueasnext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play</span><span class="p">()</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;REL_TIME&#39;</span><span class="p">,</span> 
                              <span class="n">target</span><span class="o">=</span><span class="s1">&#39;00:03:04&#39;</span><span class="p">)</span>
        <span class="c1">#TODO: see if setting the avt uri here is worthwhile - it should still point to the private queue?</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">wait_for_state_variables</span><span class="p">((</span><span class="s1">&#39;TransportState&#39;</span><span class="p">,</span> <span class="s1">&#39;NumberOfTracks&#39;</span><span class="p">),</span>
                                             <span class="k">lambda</span> <span class="n">ts</span><span class="p">,</span> <span class="n">nt</span><span class="p">:</span> <span class="n">ts</span> <span class="o">==</span> <span class="s1">&#39;STOPPED&#39;</span> <span class="ow">and</span> <span class="n">nt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                                             <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">tracks_left</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                                        <span class="n">starting_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                        <span class="n">requested_count</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">tracks_left</span><span class="p">[</span><span class="s2">&quot;TotalMatches&quot;</span><span class="p">],</span>
            <span class="s2">&quot;clearOnEnd policy should leave the tracks in the queue once the end of queue is reached&quot;</span><span class="p">)</span></div>
    
           
<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_stop_on_error_false"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_stop_on_error_false">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_stop_on_error_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_unique_playback_devices</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Test: Verify the stopOnError queue policy does not set the TransportState to STOPPED when an error opening a track is received - </span>
<span class="sd">        playback should continue to the next track in the queue</span>
<span class="sd">        Devices: All playable</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_unique_playback_devices</span>
        <span class="n">track_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">track_source</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="n">http_headers</span> <span class="o">=</span> <span class="s1">&#39;x-custom-action: make it 401&#39;</span>
        <span class="n">track_md_custom_header</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">generate_didl_lite_md_with_headers</span><span class="p">(</span><span class="n">track_list</span><span class="p">,</span> <span class="n">http_headers</span><span class="p">)</span>

        <span class="n">qid</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                                     <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                     <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;stopOnError value=&quot;0&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">)</span>

        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                          <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">enqueueduri</span><span class="o">=</span><span class="n">track_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">custom_http_header_url</span><span class="p">,</span>
                          <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="n">track_md_custom_header</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">enqueueasnext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                          <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">enqueueduri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">track_source</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">media_url</span><span class="p">,</span>
                          <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                          <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">enqueueasnext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">IgnoreInvokeErrors</span><span class="p">(</span><span class="n">zone</span><span class="p">):</span>
            <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">wait_for_state_variables</span><span class="p">((</span><span class="s1">&#39;TransportState&#39;</span><span class="p">,</span> <span class="s1">&#39;TransportErrorHttpCode&#39;</span><span class="p">),</span>
                <span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;STOPPED&#39;</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;401&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sonos</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;Did not get an event with HTTP error or play state information&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">get_state_variable</span><span class="p">(</span><span class="s2">&quot;TransportState&quot;</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;PLAYING&quot;</span><span class="p">,</span> <span class="s2">&quot;TRANSITIONING&quot;</span><span class="p">],</span> 
                                <span class="s2">&quot;Player should move on to the next track and be in the playing state&quot;</span><span class="p">)</span>
        
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_stop_on_error_true"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_stop_on_error_true">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_stop_on_error_true</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_unique_playback_devices</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Test: Verify the stopOnError queue policy sets the TransportState to STOPPED when an error opening a track is received - </span>
<span class="sd">        playback should continue to the next track in the queue</span>
<span class="sd">        Devices: All playable</span>
<span class="sd">        Expected: Success</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_unique_playback_devices</span>
        <span class="n">track_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">track_source</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        
        <span class="n">http_headers</span> <span class="o">=</span> <span class="s1">&#39;x-custom-action: make it 401&#39;</span>
        <span class="n">track_md_custom_header</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">generate_didl_lite_md_with_headers</span><span class="p">(</span><span class="n">track_list</span><span class="p">,</span> <span class="n">http_headers</span><span class="p">)</span>
        
            
        <span class="n">qid</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                                     <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                     <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;stopOnError value=&quot;1&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">)</span>
         
        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                          <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">enqueueduri</span><span class="o">=</span><span class="n">track_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">custom_http_header_url</span><span class="p">,</span>
                          <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="n">track_md_custom_header</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">enqueueasnext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                          <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">enqueueduri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">track_source</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">media_url</span><span class="p">,</span>
                          <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                          <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">enqueueasnext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">IgnoreInvokeErrors</span><span class="p">(</span><span class="n">zone</span><span class="p">):</span>
            <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">wait_for_state_variables</span><span class="p">((</span><span class="s1">&#39;TransportState&#39;</span><span class="p">),</span>
                <span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;STOPPED&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sonos</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;Player did not enter STOPPED state within default timeout limit&#39;</span><span class="p">)</span>
        
        <span class="c1"># PLAYBAR can sometimes event &#39;TRANSITIONING&#39; transport state</span>
        <span class="c1"># after it has already evented &#39;STOPPED&#39; - this is a known issue,</span>
        <span class="c1"># and is caused by the faster PLAYBAR processor firing multiple</span>
        <span class="c1"># events for the same action. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">get_state_variable</span>
                               <span class="p">(</span><span class="s2">&quot;TransportState&quot;</span><span class="p">),</span> 
                               <span class="p">[</span><span class="s2">&quot;STOPPED&quot;</span><span class="p">,</span> <span class="s2">&quot;TRANSITIONING&quot;</span><span class="p">],</span> 
                               <span class="s2">&quot;Player should not move on to the next track&quot;</span>
                               <span class="s2">&quot;and be in the STOPPED or TRANSITIONING state&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_cache_on_pause_true"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_cache_on_pause_true">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_cache_on_pause_true</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_unique_playback_devices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test: Verify the player reflects the correct policy when cacheOnPause is on for the private queue</span>
<span class="sd">        Devices: All playable</span>
<span class="sd">        Expected: Success</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_unique_playback_devices</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                               <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                               <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;cacheOnPause value=&quot;1&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_private_queue_policy</span><span class="p">()</span>
        <span class="c1"># Cache policy == 6 == (2+4) == (allow repeat + allow frame cache)</span>
        <span class="n">expectedPolicyBits</span> <span class="o">=</span> <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE</span> <span class="o">|</span> <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_REPEAT</span>
        <span class="n">expectedPolicyMask</span> <span class="o">=</span> <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE</span> <span class="o">|</span> <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_REPEAT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">expectedPolicyBits</span><span class="p">,</span> <span class="n">policy</span> <span class="o">&amp;</span> <span class="n">expectedPolicyMask</span><span class="p">,</span>
                                   <span class="s2">&quot;Cache on pause should be reflected in the policy value when enabled&quot;</span><span class="p">)</span></div>
          
<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_cache_on_pause_false"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_cache_on_pause_false">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_cache_on_pause_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_unique_playback_devices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test: Verify the player reflects the correct policy when cacheOnPause is on for the private queue</span>
<span class="sd">        Devices: All playable</span>
<span class="sd">        Expected: Success</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_unique_playback_devices</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                               <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                               <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;cacheOnPause value=&quot;0&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_private_queue_policy</span><span class="p">()</span>
        <span class="c1"># Cache policy == 2 == allow repeat</span>
        <span class="n">expectedPolicyBits</span> <span class="o">=</span> <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_REPEAT</span>
        <span class="n">expectedPolicyMask</span> <span class="o">=</span> <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE</span> <span class="o">|</span> <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_REPEAT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">expectedPolicyBits</span><span class="p">,</span> <span class="n">policy</span> <span class="o">&amp;</span> <span class="n">expectedPolicyMask</span><span class="p">,</span>
                                   <span class="s2">&quot;Cache on pause should be reflected in the policy value when enabled&quot;</span><span class="p">)</span></div>
          
<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_401_error_first_track_with_clearOnEnd_and_stopOnError_enabled"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_401_error_first_track_with_clearOnEnd_and_stopOnError_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_401_error_first_track_with_clearOnEnd_and_stopOnError_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_unique_playback_devices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test: Verify that when the first track in a queue returns an HTTP error the queue is not cleared when both the</span>
<span class="sd">            clearOnEnd and stopOnError policies are set</span>
<span class="sd">        Devices: All playable</span>
<span class="sd">        Expected: Success</span>
<span class="sd">        &quot;&quot;&quot;</span>
          
        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_unique_playback_devices</span>
        <span class="n">track_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">track_source</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    
        <span class="n">http_headers</span> <span class="o">=</span> <span class="s1">&#39;x-custom-action: make it 401&#39;</span>
        <span class="n">track_md_custom_header</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">generate_didl_lite_md_with_headers</span><span class="p">(</span><span class="n">track_list</span><span class="p">,</span> <span class="n">http_headers</span><span class="p">)</span>

        <span class="n">qid</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                                     <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                     <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;stopOnError value=&quot;1&quot;/&gt;&lt;clearOnEnd value=&quot;1&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">)</span>
            
        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                          <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">enqueueduri</span><span class="o">=</span><span class="n">track_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">custom_http_header_url</span><span class="p">,</span>
                          <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="n">track_md_custom_header</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">enqueueasnext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                          <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">enqueueduri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">track_source</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">media_url</span><span class="p">,</span>
                          <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                          <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">enqueueasnext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">IgnoreInvokeErrors</span><span class="p">(</span><span class="n">zone</span><span class="p">):</span>
            <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">wait_for_state_variables</span><span class="p">((</span><span class="s1">&#39;TransportState&#39;</span><span class="p">),</span>
                <span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;STOPPED&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sonos</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;Player did not enter STOPPED state within the default timeout limit&#39;</span><span class="p">)</span>
        
        <span class="c1">#PLAYER-6080: Playback devices fail to start in the TRANSITIONING state sometimes.</span>
        <span class="c1"># This causes an issue with waiting for the device to changes states and will</span>
        <span class="c1"># produced a failure when verify it is in the STOPPED. This block of code</span>
        <span class="c1"># can be removed once this is resolved.</span>
        <span class="k">if</span> <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">get_transport_state</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;TRANSITIONING&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">get_transport_state</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;STOPPED&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">sonos</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;Player did not enter back into the STOPPED state from the TRANSITIONING state&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyInOrFailCase</span><span class="p">(</span><span class="n">zone</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">get_state_variable</span>
                                <span class="p">(</span><span class="s2">&quot;TransportState&quot;</span><span class="p">),</span> 
                                <span class="p">[</span><span class="s2">&quot;STOPPED&quot;</span><span class="p">,</span> <span class="s2">&quot;TRANSITIONING&quot;</span><span class="p">],</span> 
                                <span class="s2">&quot;Player should not move on to the next track &quot;</span>
                                <span class="s2">&quot;and be in the STOPPED or TRANSITIONING state&quot;</span><span class="p">)</span>
        <span class="n">tracks_left</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">Browse</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                                        <span class="n">starting_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                        <span class="n">requested_count</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotEqualOrFailCase</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">tracks_left</span><span class="p">[</span><span class="s2">&quot;TotalMatches&quot;</span><span class="p">],</span>
            <span class="s2">&quot;clearOnEnd policy should leave the tracks in the queue once the end of queue is reached&quot;</span><span class="p">)</span></div>
         
<div class="viewcode-block" id="QueuePolicyTests.test_clearOnEnd_ON_with_group_delegation"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_clearOnEnd_ON_with_group_delegation">[docs]</a>    <span class="k">def</span> <span class="nf">test_clearOnEnd_ON_with_group_delegation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test: Verify that the queue policy set on one player is retained when the GC is delegated to another</span>
<span class="sd">        Devices: Playable</span>
<span class="sd">        Expected: Success</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QueuePolicyTests: test_clearOnEnd_ON_with_group_delegation&quot;</span><span class="p">)</span>
        <span class="n">player1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zones</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">player2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zones</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
         
        <span class="c1">#Create a queue on player1 and set its AVT URI to that queue, then add a track and play it.</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">player1</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                                        <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                        <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;stopOnError value=&quot;1&quot;/&gt;&lt;clearOnEnd value=&quot;1&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">player1_policies</span> <span class="o">=</span> <span class="n">player1</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_private_queue_policy</span><span class="p">()</span>
        <span class="n">player1</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">)</span>
         
        <span class="n">player1</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                             <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">enqueueduri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">track_source</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">media_url</span><span class="p">,</span>
                             <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                             <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">enqueueasnext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">IgnoreInvokeErrors</span><span class="p">(</span><span class="n">player1</span><span class="p">):</span>
            <span class="n">player1</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play</span><span class="p">()</span>

        <span class="c1">#Add player2 into the player1 group</span>
        <span class="n">player2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="n">player1</span><span class="p">)</span>

        <span class="c1">#Remove player1 from the group, delegating GC control to player2</span>
        <span class="n">player1</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">player2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_group_member</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#Capture the policies on player2</span>
        <span class="n">player2_policies</span> <span class="o">=</span> <span class="n">player2</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_private_queue_policy</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">player1_policies</span> <span class="ow">and</span> <span class="n">player2_policies</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Queue policies not found on either test device, check private queue creation&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">player1_policies</span><span class="p">,</span> <span class="n">player2_policies</span><span class="p">,</span> 
            <span class="s2">&quot;Private queue policies should be retained after GC delegation&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_createqueue_default_policies_restored_on_new_queue"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_createqueue_default_policies_restored_on_new_queue">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_createqueue_default_policies_restored_on_new_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_playback_devices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test: Verify that all queue policies are restored to default when a new private queue is created</span>
<span class="sd">        default policies == [allowShuffle: false, allowRepeat: true, cacheOnPause: true, stopOnError: false, clearAtEnd: false)</span>
<span class="sd">        Devices: All playable</span>
<span class="sd">        Expected: Success</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_playback_devices</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                               <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                               <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;stopOnError value=&quot;1&quot;/&gt;&lt;clearOnEnd value=&quot;1&quot;/&gt;&lt;allowShuffle value=&quot;0&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">queue_policies1</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_private_queue_policy</span><span class="p">()</span>
        <span class="c1">#Create a second private queue with no explicit policies - use only defaults</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                               <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                               <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">queue_policies2</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_private_queue_policy</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyNotEqualOrFailCase</span><span class="p">(</span><span class="n">queue_policies1</span><span class="p">,</span> <span class="n">queue_policies2</span><span class="p">,</span> 
                                      <span class="s2">&quot;A new private queue should not retain the last queue policies used unless specified upon creation&quot;</span><span class="p">)</span>
        <span class="c1"># Cache policy value == 6 == (2+4) == (allow repeat + allow frame cache)</span>
        <span class="n">expectedPolicyBits</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_REPEAT</span> <span class="o">|</span>
                              <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE</span><span class="p">)</span>
        <span class="n">expectedPolicyMask</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_SHUFFLE</span> <span class="o">|</span>
                              <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_REPEAT</span> <span class="o">|</span>
                              <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE</span> <span class="o">|</span>
                              <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">STOP_ON_ERROR</span> <span class="o">|</span>
                              <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">CLEAR_AT_END</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">expectedPolicyBits</span><span class="p">,</span> <span class="n">queue_policies2</span> <span class="o">&amp;</span> <span class="n">expectedPolicyMask</span><span class="p">,</span> 
                                   <span class="s2">&quot;Second queue should reflect default policy value&quot;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="QueuePolicyTests.test_combinatorial_cache_only_when_full_track_fits_enabled"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_combinatorial_cache_only_when_full_track_fits_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">test_combinatorial_cache_only_when_full_track_fits_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_testbed_unique_playback_devices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test: Verify the cacheOnPause policy while used with the fullTrackOnly value is set correctly on the player</span>
<span class="sd">        Devices: All playable</span>
<span class="sd">        Expected: Success</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="n">generate_testbed_unique_playback_devices</span>
        <span class="n">zone</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                               <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                               <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;cacheOnPause value=&quot;1&quot; fullTrackOnly=&quot;1&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_private_queue_policy</span><span class="p">()</span>
        <span class="c1"># Cache policy value should == 38 == (2+4+32) == (allow repeat + allow frame cache + only full track cache) </span>
        <span class="n">expectedPolicyBits</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE</span> <span class="o">|</span>
                              <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE_FULL_TRACK_ONLY</span><span class="p">)</span>
        <span class="n">expectedPolicyMask</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE</span> <span class="o">|</span>
                              <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE_FULL_TRACK_ONLY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">expectedPolicyBits</span><span class="p">,</span> <span class="n">policy</span> <span class="o">&amp;</span> <span class="n">expectedPolicyMask</span><span class="p">,</span>
                                   <span class="s2">&quot;Cache on pause should be reflected in the policy value when enabled&quot;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="QueuePolicyTests.test_cacheOnPause_fullTrackOnly_with_group_delegation"><a class="viewcode-back" href="../../../../upnp.functional.queue.html#upnp.functional.queue.queue_policies.QueuePolicyTests.test_cacheOnPause_fullTrackOnly_with_group_delegation">[docs]</a>    <span class="k">def</span> <span class="nf">test_cacheOnPause_fullTrackOnly_with_group_delegation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test: Verify that the queue policy set on one player is retained when the GC is delegated to another - specifically the </span>
<span class="sd">            cacheOnPause+fullTrackOnly policy combo since it is a slightly different invocation than the other policies.</span>
<span class="sd">        Devices: Playable</span>
<span class="sd">        Expected: Success</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QueuePolicyTests: test_cacheOnPause_fullTrackOnly_with_group_delegation&quot;</span><span class="p">)</span>
        <span class="n">player1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zones</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">player2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_zones</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
         
        <span class="c1">#Create a queue on player1 and set its AVT URI to that queue, then add a track and play it.</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">player1</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">CreateQueue</span><span class="p">(</span><span class="n">queueownerid</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                                     <span class="n">queueownercontext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                     <span class="n">queuepolicy</span><span class="o">=</span><span class="s1">&#39;&lt;PlaybackPolicy&gt;&lt;cacheOnPause value=&quot;1&quot; fullTrackOnly=&quot;1&quot;/&gt;&lt;/PlaybackPolicy&gt;&#39;</span><span class="p">)</span>
        <span class="n">player1_policies</span> <span class="o">=</span> <span class="n">player1</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_private_queue_policy</span><span class="p">()</span>
        <span class="n">expectedPolicyBits</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE</span> <span class="o">|</span>
                              <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE_FULL_TRACK_ONLY</span><span class="p">)</span>
        <span class="n">expectedPolicyMask</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE</span> <span class="o">|</span>
                              <span class="n">PLAYBACK_POLICIES</span><span class="o">.</span><span class="n">ALLOW_FRAME_CACHE_FULL_TRACK_ONLY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrStop</span><span class="p">(</span><span class="n">expectedPolicyBits</span><span class="p">,</span> <span class="n">player1_policies</span> <span class="o">&amp;</span> <span class="n">expectedPolicyMask</span><span class="p">,</span>
                                   <span class="s2">&quot;Policies not set correctly on Player1. Stopping test.&quot;</span><span class="p">)</span>
        <span class="n">player1</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">use_queue</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">)</span>
         
        <span class="n">player1</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="n">AddURI</span><span class="p">(</span><span class="n">queue_id</span><span class="o">=</span><span class="n">qid</span><span class="p">,</span>
                                <span class="n">update_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">enqueueduri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">track_source</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">media_url</span><span class="p">,</span>
                                <span class="n">enqueuedurimetadata</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="n">desiredfirsttracknumberenqueued</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                <span class="n">enqueueasnext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">IgnoreInvokeErrors</span><span class="p">(</span><span class="n">player1</span><span class="p">):</span>
            <span class="n">player1</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">Play</span><span class="p">()</span>

        <span class="c1">#Add player2 into the player1 group</span>
        <span class="n">player2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">join_group</span><span class="p">(</span><span class="n">player1</span><span class="p">)</span>
         
        <span class="c1">#Remove player1 from the group, delegating GC control to player2</span>
        <span class="n">player1</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">BecomeCoordinatorOfStandaloneGroup</span><span class="p">()</span>
        <span class="n">wait_until_true</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">player2</span><span class="o">.</span><span class="n">AVTransport</span><span class="o">.</span><span class="n">is_group_member</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">iteration_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
         
        <span class="c1">#Capture the policies on player2</span>
        <span class="n">player2_policies</span> <span class="o">=</span> <span class="n">player2</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">get_private_queue_policy</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">player1_policies</span> <span class="ow">and</span> <span class="n">player2_policies</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Queue policies not found on either test device, check private queue creation&quot;</span><span class="p">)</span>
         
        <span class="bp">self</span><span class="o">.</span><span class="n">verifyEqualOrFailCase</span><span class="p">(</span><span class="n">player1_policies</span><span class="p">,</span> <span class="n">player2_policies</span><span class="p">,</span> 
            <span class="s2">&quot;Private queue policies should be retained after GC delegation&quot;</span><span class="p">)</span></div></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">WorkflowTestSuite</span><span class="p">(</span><span class="s2">&quot;QueuePolicyTests&quot;</span><span class="p">)</span>
    <span class="n">suite</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">QueuePolicyTests</span><span class="p">())</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">TestCase Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../audio.html">audio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cloud.html">cloud package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../common.html">common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data_reporting.html">data_reporting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataio.html">dataio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hdmi.html">hdmi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ixchariot.html">ixchariot package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../networking.html">networking package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../other.html">other package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../perf.html">perf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pytest_automation.html">pytest_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../secure_registration.html">secure_registration package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../syssw.html">syssw package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../upnp.html">upnp package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../voice.html">voice package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webserver.html">webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webserver_v0.html">webserver_v0 package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>